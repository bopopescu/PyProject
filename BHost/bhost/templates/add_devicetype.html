{% extends  "index.html" %}
{% block head %}
<!--icheck-->
	<script src="/manage/js/icheck.min.js"></script>
	<script src="/manage/js/select2.full.min.js"></script>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<!--
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	-->
	<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/G-style.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<script src="/manage/js/xSelect.js"></script>
{% endblock  %}

{% block main %}
<!---->
		<!---->
{%if tasktype == 2%}
		<div class="c-top">
			<div class="c-title">
				<!--
				<h3 onclick="parent.reload();">设备类型</h3>
				-->
				<div class="manual-head" style="width:100px;float:left;">
					<div class="manual-title">
						<span id="devicetype_reload" style="cursor: pointer;">设备类型</span>
						<i class="devicetype_icon"></i>
					</div>
				</div>
				<div class="ctr">
					<a href="javascript:;" class="ret" onclick="parent._closePage(this)"><i></i></a>
				</div>
			</div>
		</div>
{%endif%}
		<div class="mainer">
			
			<div class="container" id="step1">
			{%if tasktype != 2%}
				<div class="c-top" id="device_title" style="">
					<div class="c-title">
						<!--
						<h3 class="tit" onclick="back(1);"><span>设备类型</span><i class="icon-device"></i></h3>
						-->
						<div class="manual-head" style="width:100px;float:left;">
							<div class="manual-title">
								<span id="devicetype_back" style="cursor: pointer;">设备类型</span>
								<i class="devicetype_icon"></i>
							</div>
						</div>
					</div>
				</div>
			{%endif%}
				<div class="c-cont">
					<div class="c-wrap" style="padding: 10px 0 0">
						<div class="c-exp" style="margin: -1px auto;">	
							
							<div class="h-explorer">							
								<div class="G-top">
				                	<div class="G-box1"></div>
									<strong>&nbsp;基本信息</strong>
				                	<div class="G-box2">隐藏：
				                		<input type="checkbox" class="form-checkbox" name="" id="Enabled" value="">
				                	</div>				                	
				                </div>
								
								<div class="h-content2" style="max-height:110px;width: 100%;overflow: hidden;padding: 14px 0 0;">
									<div class="form-item for-avatar" style="width: 52px;margin-top:-8px;position: inherit;">
										<div id="tAvatar" class="add_icon_png" style="" onclick="_getAvatarList(this)"><!--<img src="/manage/images/avatar1.jpg">--></div>
									</div>
									<div class="form-item" style="">
										<span class="form-tag" style="width: 120px;"><em class="imp">*</em>名称：</span>
										<div class="form-c" style="">
											<input type="text" class="form-text" onblur="nameCheck(this)" id="DeviceTypeName" maxlength="128" style="" ><i class="v-check"></i>
											<p class="form-tip" style="padding-left: 118px;">特殊字符仅支持下划线、横杠、小数点</p>
										</div>
									</div>
									
									
									<!--
									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em>类型：</span>
										<div class="form-c" style="width:395px;">
											<select class="form-select" name="" id="host_type" style="width: 232px;">
												<option value="-1">请选择</option>
												<option value="Windows">Windows</option>
												<option value="Linux">Linux</option>
												<option value="Unix">Unix</option>
												<option value="Aix">Aix</option>
												<option value="AS400">AS400</option>
												<option value="Cisco">Cisco</option>
												<option value="H3C">H3C</option>
												<option value="Huawei">Huawei</option>
												<option value="Ruijie">Ruijie</option>
												<option value="Network">Network</option>
												<option value="Host">Host</option>
												<option value="Server">Server</option>
												<option value="Cluster">Cluster</option>
												<option value="Switchboard">Switchboard</option>
												<option value="Firewall">Firewall</option>		
											</select>

											<div class="rzj" id="host_icon" style="width:50px;">
												<i style="margin-left: 0;display:none" class="host-type host-type1 on" data= "Windows" title= "Windows" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type2 on" data= "Linux" title= "Linux" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type3 on" data= "Unix" title= "Unix" ></i>
												<i style="margin-left: 0;display:none;background-position: 48px -30px;" class="host-type host-type14 on" data= "Aix" title= "Aix" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type5 on" data= "AS400" title= "AS400" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type6 on" data= "Cisco" title= "Cisco" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type4 on" data= "H3C" title= "H3C" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type7 on" data= "Huawei" title= "Huawei" ></i>
												<i style="margin-left: 0;display:none;background-position: 99px -30px;width:50px;" class="host-type host-type15 on" data= "Ruijie" title= "Ruijie" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type8 on" data= "Network" title= "Network" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type9 on" data= "Host" title= "Host" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type10 on" data= "Server" title= "Server" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type11 on" data= "Cluster" title= "Cluster" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type12 on" data= "Switchboard" title= "Switchboard" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type13 on" data= "Firewall" title= "Firewall" ></i>
											</div>
										</div>
									</div>
									-->
									<div class="form-item" style="">
										<span class="form-tag" style="width: 120px;">账号切换命令：</span>
										<div class="form-c" style="">
											<input type="text" class="form-text" id="AcctSwitchCmd" maxlength="31" style="" ><i class="v-check"></i>
										</div>
									</div>
									
									<div class="form-item" style="">
										<span class="form-tag" style="width: 120px;" >切换密码提示：</span>
										<div class="form-c" style="">
											<input type="text" class="form-text" id="SwitchPasswdPrompt" maxlength="31" style="" ><i class="v-check"></i>
										</div>
									</div>
									
									<div class="form-item" style="">
										<span class="form-tag" style="width: 120px;" >描述：</span>
										<div class="form-c">
											<input class="form-text" name="" id="Description" maxlength="128" />
										</div>
									</div>
									<!--
									<div class="form-item" style="margin-left: 40px">
										<span class="form-tag">隐藏：</span>
										<div class="form-c">
											<label class="form-label" style="margin-top:5px"><input class="form-checkbox" type="checkbox" name="" id="hidden" ></label>
											
										</div>
									</div>
									-->
								</div>
							</div>
						</div>
						<div class="c-exp" style="margin: -1px auto;">
							<div class="h-explorer">
				                <div class="G-top">
				                	<div class="G-box1"></div><strong>&nbsp服务</strong>	
				                </div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
									<div class="c-table">
										
									
										<table cellpadding="0" cellspacing="0" style="margin-bottom:20px;">
											<thead>
												<tr><th>服务名称</th>
													<th>协议(端口)</th>
													<!--
													<th>连接参数</th>
													<th>前置机IP</th>
													-->
													<th width="52"></th>
												</tr>
											</thead>

											<tbody id="service_list" style="height:auto">
											
											</tbody>
											</tbody>
										</table>
										<div class="form" >
											<div class="form-item form-item-100" style="width:100%">
												<div style="text-align: right;"><a href="javascript:;" id="" class="btn btn-normal1" onclick="_getDialog1('add','',this);">添&nbsp;&nbsp;加</a><!--<a href="javascript:;" class="btn btn-normal1" onclick="clear_server();">重&nbsp;&nbsp;置</a>--></div>
											</div>
										</div>
									</div>
				                </div>
				            </div>
						</div>
					</div>
				</div>
			</div>
			{%if 14 in manage_power_id %}
			<div class="btns">
				<a href="javascript:;" class="btn btn-normal " onclick="savedata();" style="font-weight: 400;">保&nbsp;&nbsp;存</a>
				<!--
				<a href="javascript:;" class="btn btn-normal " onclick="back(1);" style="font-weight: 400;">取&nbsp;&nbsp;消</a>
				-->
			</div>
			{%endif%}
			<div id="bBtn" style="position: fixed;z-index:5;">
				<a href="javascript:;" class="btn" style="float: right;" onclick="back(1);"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
			</div>
		</div>
		<!-- 浮层 -->
		<!-- 服务-->
		<div class="dialog-cont" id="scDCTab1" style="display:none;">
			<div class="container">
				<div class="c-cont" style="max-height:280px;overflow:auto; min-height: 310px;overflow:hidden;">
					<div class="c-wrap" style="padding:0 0 90px;margin-top: -10px;overflow: hidden;">
						<div class="c-form c-form-host col3">
							
							<div class="clearfix"></div>
							<div class="c-table" style="padding: 0;">
								<div class="form" style="overflow: hidden;">
									<div class="form-item" style="width:50%;">
										<span class="form-tag">服务名称：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="DeviceServiceName" maxlength="128" style="width:108px">
										</div>
									</div>

									<div class="form-item" style="width:50%;">
										<span class="form-tag"><em class="imp">*</em>协议：</span>
										<div class="form-c" id="ProtocolName"></div>
									</div>
									<div class="form-item" style="width:50%;">
										<span class="form-tag"><em class="imp">*</em>端口：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="Port" maxlength="5" onkeyup="port_check(this);" style="width:108px">
										</div>
									</div>
									
									<!--
									<div class="form-item" style="width:50%;">
										<span class="form-tag">连接参数：</span>
										<div class="form-c" id="ConnParamName"></div>
									</div>
									
									<div class="form-item form-item-100">
										<span class="form-tag" style="line-height:33px;">应用发布：</span>
										<div class="form-item" id="accIP_cont" style="width: 540px;max-height: 104px;overflow: auto;padding: 2px 0;">
											<div class="form-c srsCtl" style="width:265px;padding: 0;float: left;margin-bottom:10px;">
												<div class="accIP_type" style="float:left;">
													<select class="filter-select" name="accIP_type" id="accIP_type" style="width:80px;border-bottom-right-radius: 0px;border-top-right-radius: 0px;float:left;" tabindex="-1" aria-hidden="false" onchange="change_acc_type(this);"> 
														<option value="1">内置</option>
														<option value="2" selected>外置</option>
													</select>
												</div>
												<div class="in_ip" style="float:left;margin-left: -1px;display:none;" >
													<select class="filter-select" name="in_ip" id="in_ip" style="width:136px;border-bottom-right-radius: 0px;border-top-right-radius: 0px;float:left;" tabindex="-1" aria-hidden="false"> 
														<option value="1">1</option>
														<option value="2">2</option>
														<option value="1">3</option>
														<option value="2">4</option>
														<option value="1">5</option>
														<option value="2">6</option>
														<option value="1">7</option>
														<option value="2">8</option>
														<option value="1">9</option>
														<option value="2">10</option>
														<option value="1">11</option>
														<option value="2">12</option>
														<option value="1">13</option>
														<option value="2">14</option>
														<option value="1">15</option>
														<option value="2">16</option>
														<option value="1">17</option>
														<option value="2">18</option>
														<option value="1">19</option>
														<option value="2">20</option>
													</select>
												</div>
												<div class="form-c" id="accIP" style="float:left;padding:0px;"></div>
												<a href="javascript:;" class="ctrl add" style="" onclick="_addaccIP(this);"></a>
											</div>
										</div>
									</div>
									-->
								</div>
							</div>
							
							<div class="btns">
								<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
								<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
							</div>
						</div>
					</div>
				</div>  
			</div>
		</div>
		<div class="dialog-cont" id="ConnIPDialog" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
					<div class="c-form c-form-host" style="padding: 0 0 90px;">
						<div class="clearfix"></div>
						<div class="c-table">
							<div class="form">
								<div class="form-item" style="width: 25%;">
									<span class="form-tag" style=""><em class="imp">*</em>IP：</span>
									<div class="form-c" style="">
										<input type="text" class="form-text" id="accip_input" maxlength="15" style="" tabindex="1">
									</div>
								</div>
							</div>
							<div class="btns" style="padding: 10px 0 10px;">
								<a href="javascript:;" class="btn btn-normal btn-submit" >保&nbsp;&nbsp;存</a>
								<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="dialog-cont" id="protoDialog" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
					<div class="c-form c-form-host" style="padding: 0 0 90px;">
						<div class="clearfix"></div>
						<div class="c-table">
							<div class="form">
								<div class="form-item" style="width: 300px;">
									<span class="form-tag" style="width: 72px;"><em class="imp">*</em>名称：</span>
									<div class="form-c" style="padding-left: 0;">
										<input type="text" class="form-text" id="Protocol_Name0" maxlength="15" style="width: 195px;" tabindex="1">
										<i class="v-check" style=""></i>
										<p class="form-tip" style="width: 185px;margin-left: 66px;">特殊字符仅支持下划线、横杠</p>
									</div>
								</div>
								<div class="form-item" style="width: 185px;">
									<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口：</span>
									<div class="form-c" style="padding-left: 0px;">
										<input type="text" class="form-text" id="Port0" maxlength="5" style="width: 50px;" tabindex="1">
										<i class="v-check" style=""></i>
										<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
									</div>
								</div>
								<div class="form-item" style="width: 185px;">
									<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口1：</span>
									<div class="form-c" style="padding-left: 0px;">
										<input type="text" class="form-text" id="Port1" maxlength="5" style="width: 50px;" tabindex="1">
										<i class="v-check" style=""></i>
										<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
									</div>
								</div>
								<div class="form-item" style="width: 250px;">
									<span class="form-tag" style="width:85px;">描述：</span>
									<div class="form-c" style="padding-left: 0px;">
										<input type="text" class="form-text" id="Description0" maxlength="128" style="width:170px;" tabindex="1">
									</div>
								</div>
							</div>
							<div class="btns" style="padding: 10px 0 10px;">
								{% if 14 in manage_power_id %}
								<a href="javascript:;" class="btn btn-normal btn-submit" >保&nbsp;&nbsp;存</a>
								{%endif%}
								<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="dialog-cont" id="connDialog" style="display:none;">
			<div class="container">
				<div class="c-cont" style="max-height:500px;">
					<div class="c-form" style="">
						<div class="form" style="padding-left:50px;">
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>名称：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="d_n" name="d_n" onblur="regCheck(this,cnameReg);" maxlength="128">
									<i class="v-check"></i>
									<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>协议类型：</span>
								<div class="form-c">
									<select class="form-select form-select2" name="Protocol_con" id="Protocol_con" style="width:150px;">
										<option value="0" selected>请选择</option>
									</select>
								</div>
								<span class="form-tag" id="Protocol_port"></span>
							</div>
							<!-- SSH -->
							<div id="SSH" style="display:none;">
								<div class="form-item">
									<span class="form-tag">版本号：</span>
									<div class="form-c">
										<select class="form-select" name="ServiceName_ssh" id="ServiceName_ssh" style="width:150px;">
											<option value="1" selected>1</option>
											<option value="2" >2</option>
										</select>
									</div>
								</div>
							</div>
							<!--HTTP-->
							<div id="HTTP" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>URL：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="url" name="url" maxlength="128" style="width:252px;padding-right:8px;">
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">账号元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="UserName" name="UserName" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">密码元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="UserPwd" name="UserPwd" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">提交元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="Submit" name="Submit" maxlength="128" style="width:252px;padding-right:8px;">
									</div>
								</div>
							</div>
							<!--HTTPs-->
							<div id="HTTPs" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>URL：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="httpsurl" name="httpsurl" maxlength="128" style="width:252px;padding-right:8px;">
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">账号元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="httpsUserName" name="httpsUserName" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">密码元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="httpsUserPwd" name="httpsUserPwd" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">提交元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="httpsSubmit" name="httpsSubmit" maxlength="128" style="width:252px;padding-right:8px;">
									</div>
								</div>
							</div>
							<!--RDP-->
							<div id="RDP" style="display:none;">
								<div class="form-item">
									<span class="form-tag">访问方式：</span>
									<div class="form-c">
										<select class="form-select" name="rdpType" id="rdpType" style="width:150px;">
											<option value="NORMAL" text="NORMAL">NORMAL</option>
											<option value="CONSOLE" text="CONSOLE">CONSOLE</option>
										</select>
									</div>
								</div>
							</div>
							<!--ORACLE-->
							<div id="ORACLE" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>指定：</span>
									<div class="form-c">
										<select class="form-select" name="appoint" id="appoint" style="width:150px;">
										<option value="0" text="请选择" selected>请选择</option>
										<option value="SID" text="SID">SID</option>
										<option value="SERVICE_NAME" text="SERVICE_NAME">SERVICE_NAME</option>
									</select>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>实例名或服务名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="s_n" name="s_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">连接方式：</span>
									<div class="form-c">
										<select class="form-select" name="conn" id="conn" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="NORMAL" text="NORMAL">NORMAL</option>
										<option value="SYSDBA" text="SYSDBA">SYSDBA</option>
										<option value="SYSOPER" text="SYSOPER">SYSOPER</option>
									</select>
									</div>
								</div>
							</div>
							<!--RADMIN-->
							<div id="RADMIN" style="display:none;">
								<div class="form-item">
									<span class="form-tag">认证方式：</span>
									<div class="form-c">
										<select class="form-select" name="authtype" id="authtype" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="RADMIN" text="RADMIN">RADMIN</option>
										<option value="Windows" text="Windows">Windows</option>
									</select>
									</div>
								</div>
							</div>
							<!--MSSQL-->
							<div id="MSSQL" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>实例名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="o_n" name="o_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">认证方式：</span>
									<div class="form-c">
										<select class="form-select" name="R_authtype" id="R_authtype" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="SQL服务器验证" text="SQL服务器验证" >SQL服务器验证</option>
										<option value="Windows验证" text="Windows验证" >Windows验证</option>
										<option value="Windows单一登录" text="Windows单一登录" >Windows单一登录</option>
									</select>
									</div>
								</div>
							</div>
							<!--MYSQL &&　DB2-->
							<div id="MY_DB2" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>数据库名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="sql_n" name="sql_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<div id="MY_ConnType" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>版本号：</span>
									<div class="form-c">
										<select class="form-select" name="select_my" id="select_my" style="width:150px;">
											<option value="0" text="0" selected>&lt;7.5</option>
											<option value="1" text="1" >≥7.5</option>
										</select>
									</div>
								</div>
							</div>
							<div id="DB2" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>数据库名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="dbsql_n" name="dbsql_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<!--SYBASE-->
							<div id="SYBASE" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>实例名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="sy_o_n" name="sy_o_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<!---->
						</div>
					</div>
					<div class="c-form">
						<div class="btns">
							{%if 14 in manage_power_id %}
							<a href="javascript:;" class="btn btn-normal btn-submit">保&nbsp;&nbsp;存</a>
							{%endif%}
							<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	<form action="/bhost/host_manage" method="POST" name="frm_access">
		<input type="hidden" name="tasktype" value="0" />
		<input type="hidden" name="a0"  value="" />
		<input type="hidden" name="se"  value="" />
		<input type="hidden" name="us"  value="zdp" />
		<input type="hidden" name="z1"  value="" />
		<input type="hidden" name="z2"  value="" />
		<input type="hidden" name="z3"  value="" />
		<input type="hidden" name="z4"  value="" />
		<input type="hidden" name="z5"  value="" />
		<input type="hidden" name="z6"  value="" />
		<input type="hidden" name="i10"  value="" />
	</form>
	<div id="avatars" class="avatars">
		<ul>
			<!--
			<li><a href="javascript:;" class="active add_icon_png" onclick="_setAvatar(this)" style=""></a></li>
			-->
			<!--widows-->
			<li><a href="javascript:;" class="active icon_png" onclick="_setAvatar(this)" style="background-position: -652px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--linux-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -152px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--unix-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -2px;"><!--<img alt="" src="">--></a></li>
			<!--AIX-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -552px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--as400-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -502px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--cisco-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -452px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--h3c-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -352px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--huawei-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -202px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--ruijie-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -102px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--network-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -602px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--switchbod-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -52px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>		
			<!--host-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -252px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--firewall-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -300px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>	
			<!--cluster-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -402px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>	
			<!--server-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -702px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--ZTE-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -752px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
			<!--DP-->
			<li><a href="javascript:;" class="icon_png" onclick="_setAvatar(this)" style="background-position: -802px;"><!--<img alt="" src="/manage/images/devicetype_icon.png">--></a></li>
		</ul>
	</div>
{% endblock  %}


{% block script %}
<style>
.as{
   width:190px;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   float:left;
   margin-top: 7px;
}

.h-content2 .form-item {
    height: auto;
    padding: 20px 0 10px;
    min-height: 38px;
	padding: 5px;
    width: 380px;
    float: left;
}
.h-content2 .form-tag {
    float: left;
    width: 80px;
    text-align: right;
    color: #000;
    line-height: 28px;
}
.h-content2 .form-c {
    padding-left: 0px;
    position: relative;
}
.h-content2 .form-text {
    width: 200px;
}
.h-content2 .rzj {
    float: right;
    margin-right: 29px;
    color: #000;
	margin-top: -2px;
}
.h-content2 .form-tip {
    padding-left: 48px;

}
a.btn-normal1{
    display: inline-block;
    width: 90px;
    height: 32px;
    border: 1px solid #DDD;
    text-align: center;
    line-height: 32px;
    border-radius: 18px;
    margin: 0 10px;
    background-color: #fff;
    transition: background-color 0.4s;
	color: #7c7c7c;
}
a.btn-normal1:hover{
	background-color: #8d808a;
    color: #fff;
}
.ui-dialog-content .c-form-host{
	min-width: 780px;
}
.c-table{
	padding: 20px 10px;
}
.c-form-host.col3 .form-item{
	width: 50%;
}
.c-form-host.col3 .form-item-100{
	width: 100%;
}
.c-form-host.col3 .form-item .form-text{
	width: 100px;
}
.c-form-host.col3 .form-item .h-content3{
	padding: 0;
}
.select2-container--open {
	z-index: 9999999;
}

.icon_png {
	display: inline-block;
	width: 15px;
	height: 15px;
	background: url(/manage/images/devicetype_icon.png) no-repeat 0 0;
	vertical-align: middle;
	cursor: pointer
}

.add_icon_png {
	display: inline-block;
	width: 15px;
	height: 15px;
	background: url(/manage/images/add_dev_icon.png) no-repeat 0 0;
	vertical-align: middle;
	cursor: pointer;
	background-position: 13px 13px;
}

.avatars {
	overflow: auto;
    width: 198px;
}
.srsCtl:hover a.del{
    display: inline-block;
}

.xSelect-show {
	border-bottom-right-radius: 5px;
    border-top-right-radius: 5px;
    border-bottom-left-radius: 0px;
    border-top-left-radius: 0px;
    margin-left: -1px;
}

.accIP_type span.select2-selection {
	border-bottom-right-radius: 0px;
    border-top-right-radius: 0px;
}

.in_ip span.select2-selection {
	border-bottom-left-radius: 0px;
    border-top-left-radius: 0px;
}

#ProtocolName .xSelect-show {
	border-bottom-left-radius: 5px;
    border-top-left-radius: 5px;
    margin-left: 0px;
}

#ConnParamName .xSelect-show {
	border-bottom-left-radius: 5px;
    border-top-left-radius: 5px;
    margin-left: 0px;
}
</style>

<script>
$('.filter-select,.form-select').select2({minimumResultsForSearch: -1});

var DeviceType = {
	"DeviceTypeId": 0,
    "DeviceTypeName": "Windows",
    "Description": "Windows",
    "DeviceTypeIcon": "Windows",
    "Status": 0,
    "AcctSwitchCmd": null,
	"SwitchPasswdPrompt": null,
	"ServiceSet": [],
}

var tasktype = "{{tasktype}}";
var now = "{{now}}";
var keyword = {{keyword|safe}};
var edit = {{edit|safe}};
var filter_flag = {{filter_flag}};
var selectid = {{selectid|safe}}
var se;
var manage_power_id = {{manage_power_id}};
function nameCheck(obj){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check')

	if(nameReg.test(val)){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}

function ipCheck(obj){
	var hostIPReg = /^((?:(?:2[0-4][0-9]\.)|(?:25[0-5]\.)|(?:1[0-9][0-9]\.)|(?:[1-9][0-9]\.)|(?:[0-9]\.)){3}(?:(?:2[0-5][0-5])|(?:25[0-5])|(?:1[0-9][0-9])|(?:[1-9][0-9])|(?:[0-9])))$/;
	var val = $(obj).val().trim();
	var $i = $(obj).next('i.v-check')

	if(hostIPReg.test(val)){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}

var json_icon = {
	"Unix":"-2px",
	"Switchboard":"-52px",
	"Ruijie":"-102px",
	"Linux":"-152px",
	"Huawei":"-202px",
	"Host":"-252px",
	"Firewall":"-300px",
	"H3C":"-352px",
	"Cluster":"-402px",
	"Cisco":"-452px",
	"AS400":"-502px",
	"Aix":"-552px",
	"Network":"-602px",
	"Windows":"-652px",
	"Server":"-702px",
	"ZTE":"-752px",
	"DP":"-802px"
}

var icon_array = ["Windows","Linux","Unix","Aix","AS400","Cisco","H3C","Huawei","Ruijie","Network","Switchboard","Host","Firewall","Cluster","Server","ZTE","DP"];
$(function(){
	se = window.parent.document.frm.se.value;
	
	$("#devicetype_back").on("click",function(){	
		document.frm_access.a0.value = se;
		document.frm_access.z1.value = now;
		if (edit != "None"){
			document.frm_access.z2.value = JSON.stringify(edit);
		}else{
			document.frm_access.z2.value = "None";
		}
		document.frm_access.z3.value = tasktype;
		document.frm_access.z4.value = JSON.stringify(keyword);
		document.frm_access.z5.value = filter_flag;
		document.frm_access.z6.value = JSON.stringify(selectid);
		document.frm_access.action = '/bhost/add_devicetype';
		document.frm_access.submit();
		/*
		document.frm_access.tasktype.value=5;
		document.frm_access.a0.value=se;
        document.frm_access.z1.value=1;
        document.frm_access.z2.value="None";
        document.frm_access.z4.value="[]";
        document.frm_access.z5.value=0;
		document.frm_access.z6.value="[]";
        document.frm_access.action = '/bhost/add_devicetype';
        document.frm_access.submit();
		*/
	});
	$("#devicetype_reload").on("click",function(){
		parent.reload();
	});
	
	if (tasktype == 2){
		parent._switchBtn(0);
	}else{

	}
	/*
	$("#select_accIP select").click(function(){
		oldvaluechek(this);
	})
	*/
	$("#Port").bind('keydown', function(e){
		DigitInput(e);
	});
	$('#Enabled,#hidden').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
	//获取初始信息
	/*
	//获取协议
	$.ajax({
		url:'/bhost/get_protocol_list',
		type: "post",
		async:false,
		cache:false,
		data: {a0:se,a1:1,a2:null,a3:null,a4:',,',a5:null},
		success: function(Result) {
			proto_list = JSON.parse(Result);
			$("#ProtocolName").empty();
			$("#ProtocolName").append("<option value=\"\" data=\"\">请选择</option>");
			$.each(proto_list.data,function(i,item){
				$("#ProtocolName").append("<option value=\""+item.ProtocolId+"\" data=\""+item.Port+"\">"+item.ProtocolName+"</option>");
			})	
		}
	})
	$("#ProtocolName").unbind().bind("change",function(){
		$("#Port").val($("#ProtocolName option:selected").attr("data"));
		//获取 连接参数
		$.ajax({
			url:'/bhost/get_ConnParam_list',
			type: "post",
			async:false,
			cache:false,
			data: {a0:se,a1:$(this).val()},
			success: function(Result) {
				connparm_list = JSON.parse(Result);
				$("#ConnParamName").empty();
				$("#ConnParamName").append("<option value=\"\">请选择</option>");
				$.each(connparm_list.data,function(i,item){		
					$("#ConnParamName").append("<option value=\""+item.ConnParamId+"\" >"+item.ConnParamName+"</option>");
				})	
			}
		})
	})
	*/
	//get_accIP();
	
	bind_accip_select();
	bind_in_ip();
	$('.form-select').select2({minimumResultsForSearch: -1});
	//$("#ProtocolName").select2();
	//$("#ConnParamName").select2();
	
	$("a.btn-submit").unbind().bind("click",function(){
		savedata();
	});
	$("a.btn-cancel").unbind().bind("click",function(){
		document.frm.tasktype.value = 3;
		document.frm.us.value = "xtc";
		document.frm.submit();
	});
	$("#host_type").change(function(){
		host_type = $("#host_type option:selected").text();
		$("#host_icon i").each(function(){
			if(host_type == $(this).attr("data")){ 
				$(this).show();
			}
			else {$(this).hide()};
		})
	})
	$("#host_type").change();
	if (edit != "None"){
		DeviceType.DeviceTypeId = edit.data[0].DeviceTypeId;
		$("#DeviceTypeName").val(edit.data[0].DeviceTypeName);
		$("#DeviceTypeName").attr('disabled',true);
		$("#tAvatar").attr('class','icon_png');
		
		
		$("#tAvatar").css("background-position",json_icon[edit.data[0].DeviceTypeIcon]);
		//$("#host_type").val(edit.data[0].DeviceTypeIcon).trigger('change');
		//$("#host_type").attr('disabled',true);
		var icon_index = icon_array.indexOf(edit.data[0].DeviceTypeIcon);
		
		
		$('#avatars').find('a.icon_png:eq('+icon_index+')').addClass('active').parent().siblings('li').children('a').removeClass('active');
		if (edit.data[0].AcctSwitchCmd != null){
			$("#AcctSwitchCmd").val(edit.data[0].AcctSwitchCmd);
		}	
		if (edit.data[0].SwitchPasswdPrompt != null){
			$("#SwitchPasswdPrompt").val(edit.data[0].SwitchPasswdPrompt);
		}
		if (edit.data[0].Description != null){
			$("#Description").val(edit.data[0].Description);
		}

		if (edit.data[0].Status == 1){
			$("#Enabled").iCheck('check');
		}
		bind_protocol_select();
		//bind_conn_select();
		if (edit.data[0].ServiceSet != null){
			$.each(edit.data[0].ServiceSet,function(i,item){
				$("#DeviceServiceName").val(item.DeviceServiceName);
				$("#ProtocolName").data('value',item.ProtocolId);
				$("#ProtocolName").find('span').text(item.ProtocolName);
				//$("#ProtocolName").val(item.ProtocolId).trigger('change');
				$("#Port").val(item.Port);
				
				/*
				if (item.ConnParamId != null){
					$("#ConnParamName").data('value',item.ConnParamId);
					$("#ConnParamName").find('span').text(item.ConnParamName);
				}else{
					$("#ConnParamName").data('value',-1);
					$("#ConnParamName").find('span').text("请选择");
				}
				
				if (item.AccIPSet != null){
					for (var i1 = item.AccIPSet.length; i1 > 0; i1--){
						if (i1 != 1){
							if (!item.AccIPSet[i1-1].IsBuildin){
								$("#accIP_type").val(2).trigger('change');
								$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
								$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
								$('.add').click();
							}
						}else{
							if (!item.AccIPSet[i1-1].IsBuildin){
								$("#accIP_type").val(2).trigger('change');
								$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
								$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
							}else{
								$("#accIP_type").val(1).trigger('change');
								$("#in_ip").val(item.AccIPSet[i1-1].AccIPId).trigger('change');
							}
						}
					}
				}
				*/
				_addServer("add");
			});
		}
		
		//$("#tAvatar").attr('onclick','').unbind('click');
	}
})

//获取连接参数
var connparm_list = null;
function get_ConnParam_list(id){
	$.ajax({
		url:'/bhost/get_ConnParam_list',
		type: "post",
		async:false,
		cache:false,
		data: {a0:se,a1:id},
		success: function(Result) {
			connparm_list = JSON.parse(Result);			
		}
	});
}
//获取协议
var proto_list;
function get_protocol_list(){
	$.ajax({
		url:'/bhost/get_protocol_list',
		type: "post",
		async:false,
		cache:false,
		data: {a0:se,a1:1,a2:null,a3:null,a4:',,',a5:null},
		success: function(Result) {
			proto_list = JSON.parse(Result);		
		}
	});
}

function clear_protocol(){
	$("#protoDialog").find('input').val('');
	$("#Protocol_Name0").attr('disabled',false);
	
}

var protocol_id;
function _editNode1(obj,type){
	clear_protocol();
	var title;
	if (type == 1) {//
		protocol_id = $(obj).children('span').data('value');
		title = "协议";
	} else if (type == 2) {
		protocol_id = 0;
		title = "协议";
	}
	var $dialogCont = $("#protoDialog").show();
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "protoDialog",
		width: "1000px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	protocol_main(type);
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		clear_protocol();
		protocol_main(type);
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		save_pro(d);
	})
}

function protocol_main(type){
	$("#Port1").parent().parent().hide();
	$("#Port0").on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	$("#Port1").on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	if(type == 1){
		$.ajax({
		   url:'/bhost/select_protocol',
		   type:"post",
		   async:false,
		   data:{a0:se,x1:protocol_id},
		   success:function(result){
				protdata = JSON.parse(result);
				$.each(protdata.data,function(i,item){
					if(item.ProtocolName=="PCANY")
					{
						$("#Port1").parent().parent().show();
						$("#Port1").val(item.Port1);
					}
					$("#Protocol_Name0").val(item.ProtocolName);
					$("#Port0").val(item.Port);
					$("#Description0").val(item.Description);
					$("#Protocol_Name0").attr("disabled",true);
				});
			}
		});
	}
}

function namecheck(name){
	var flag=true;
	$.ajax({
		url:'/bhost/select_name',
		type: "post",
		async:false,
		data: {a0:se,x1:name},
		success:function(result){
			data = parseInt(result);
			if (data !=0){
				flag=false;
			}
		}
	});
	return flag;
}

function save_pro(d){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-]+$/;;
	var ProtocolName = $("#Protocol_Name0").val();
	var des = $("#Description0").val();
	var Port = $("#Port0").val();
	if ($("#Port1").is(":visible")){
		
		var Port1 = $("#Port1").val();
	}else{
		
		var Port1 = "0";
	}
	
	if(ProtocolName == ""){
		_alert(2,"协议","请输入名称",$("#Protocol_Name0"));	
		return false;
	}
	var len = 0;
	if (des != ""){
		for (var i = 0; i < des.length; i++) {
		   if (des.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null){ //全角 
				len += 2; 
			}else{
				len += 1; 
			}
		}
		if(len >= 255){
			_alert(1,"协议","描述内容过长",$("#Description0"));
			return false;                   
		}
	}
	
	
	if(Port == ""){
		
		_alert(1,"协议","请输入端口",$("#Port0"));
		return false;
	}
	if (Port1 == 0){
		
	}
	
	if(Port1 == ""){
		
		_alert(1,"协议","请输入端口",$("#Port1"));
		return false;
	}
	//检查输入框格式
	if(!nameReg.test(ProtocolName)){
		_alert(1,"协议","名称格式不正确",$("#Protocol_Name0"));
		return false;
    }
	if (protocol_id == 0){
		if(namecheck(ProtocolName)==false){
			_alert(1,"协议","相同名称已存在",$("#Protocol_Name0"));
			return false;
		}
	}
	var datalist = [];
	var dataP='{"ProtocolId":'+protocol_id+',"ProtocolName":"'+ProtocolName+'","Port":'+Port+',"Port1":'+Port1+',"Description":"'+des+'"}';
	datalist.push(dataP);
	msstr = aceg(JSON.stringify(datalist),se);
	$.ajax({
		url:'/bhost/set_protocol',
		type: "post",
		async:false,
		data: {a0:se,x1:JSON.stringify(datalist),m1:msstr},
		success:function(result){
			data = JSON.parse(result);
			if (data.Result){
				$('.btn').blur();
				_alert(0,"协议","保存成功");
				var pro_text = $('#ProtocolName').find('span').text();
				$("div[data-id=xSelect-protocol]").remove();
				$('#ProtocolName').empty().data('xSelect','');
				bind_protocol_select();
				if ($("#ProtocolName").data('value') == "-1" || $("#ProtocolName").data('value') == undefined){
					$("#ProtocolName").data('value',data.ProtocolId);
					$("#ProtocolName").find('span').text(ProtocolName);
					$("#Port").val(Port);
				}else{
					$('#ProtocolName').find('span').text(pro_text);
				}
				d.close().remove();
			}else{
				_alert(1,"协议","执行失败：" + data.ErrMsg);
			}
		}
	});
}

function bind_protocol_select(){
	get_protocol_list();
	var protocol_array = [];
	$.each(proto_list.data,function(i,item){
		if (manage_power_id.indexOf(14) != -1){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'edit'
			};
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'check'
			};
		}
		
		select_data_json.value = item.ProtocolId;
		select_data_json.name = item.ProtocolName;
		protocol_array.push(select_data_json);
	});
	$('#ProtocolName').empty().data('xSelect',"");
	
	if (manage_power_id.indexOf(14) != -1){
		$('#ProtocolName').xSelect({
			width: 138,
			defaultText: '请选择',
			items:protocol_array,
			module_type:'protocol',
			edit: function(item,obj){
				
				$(obj).parents('.xSelect-view').hide();
				_editNode1(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						
						_editNode1(obj,2);
					}
				}
			],
			setval:function(item,obj){
				sel_id = $(obj).find('span').data('value');		
				bind_conn_select();
				$.each(proto_list.data,function(i,item){
					if (sel_id == item.ProtocolId){
						$("#Port").val(item.Port);
						return false;
					}
				});
			}
		});
	}else{
		$('#ProtocolName').xSelect({
			width: 138,
			defaultText: '请选择',
			items:protocol_array,
			module_type:'protocol',
			check: function(item,obj){
				
				$(obj).parents('.xSelect-view').hide();
				_editNode1(obj,1);
			},
			setval:function(item,obj){
				sel_id = $(obj).find('span').data('value');		
				bind_conn_select();
				$.each(proto_list.data,function(i,item){
					if (sel_id == item.ProtocolId){
						$("#Port").val(item.Port);
						return false;
					}
				});
			}
		});
	}
	$('#ProtocolName').data('value',-1);
}

var sel_id = -1;

function bind_conn_select(){
	get_ConnParam_list(sel_id);
	var conn_array = [];
	conn_array.push({'value':-1,'name':'请选择','type':null})
	if (connparm_list != null){
		$.each(connparm_list.data,function(i,item){
			if (manage_power_id.indexOf(14) != -1){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'type':'edit'
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'type':'check'
				};
			}
			
			select_data_json.value = item.ConnParamId;
			select_data_json.name = item.ConnParamName;
			conn_array.push(select_data_json);
		});
	}
	$('#ConnParamName').empty().data('xSelect',"");
	if (manage_power_id.indexOf(14) != -1){
		$('#ConnParamName').xSelect({
			width: 138,
			defaultText: '请选择',
			items:conn_array,
			module_type:'conn',
			edit: function(item,obj){
				
				$(obj).parents('.xSelect-view').hide();
				_editNode2(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						
						_editNode2(obj,2);
					}
				}
			]
		});
	}else{
		$('#ConnParamName').xSelect({
			width: 138,
			defaultText: '请选择',
			items:conn_array,
			module_type:'conn',
			check: function(item,obj){
				
				$(obj).parents('.xSelect-view').hide();
				_editNode2(obj,1);
			}
		});
	}
	
}

function clear_conn(){
	$("#d_n").attr('disabled',false).val("");
	$("#d_n").next('i').attr('class','v-check');
	$("#connDialog").find('input').val('');
	$("#connDialog").find('select').val('0').trigger('change');
	$("#ServiceName_ssh").val('1').trigger('change');
	$("#rdpType").val('NORMAL').trigger('change');
}
var conn_id;
function _editNode2(obj,type){
	clear_conn();
	var title;
	if (type == 1) {//
		conn_id = $(obj).children('span').data('value');
		title = "连接参数";
	} else if (type == 2) {
		protocol_id = 0;
		title = "连接参数";
	}
	var $dialogCont = $("#connDialog").show();
	var con_d = dialog({
		title: title,
		content: $dialogCont,
		id: "connDialog",
		width: "800px;"
	});
	
	con_d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	con_d.showModal();
	conn_main(type);
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		clear_conn();
		conn_main(type);
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		connection_add(con_d);
	})
}

function conn_main(type){
	//协议类型下拉框
	$.ajax({
		url: "/bhost/get_protocol_list",
		type: "POST",
		async: false,
		data: { a0: se, a3: 17, a2: 1, a4: ",," },
		success: function (result) {
			var userinfo_result = JSON.parse(result);
			var userinfo_data = userinfo_result.data;
			$("#Protocol_con").empty();
			$("#Protocol_con").append('<option value="0">请选择</option>');
			$.each(userinfo_data, function (i, item) {
				$("#Protocol_con").append('<option value="' + item.ProtocolId + '" text="' + item.ProtocolName + '">' + item.ProtocolName + '</option>');
			});
		}
	});
	if (type == 1) {
		$.ajax({
			url: "/bhost/get_connection_list",
			type: "POST",
			async: false,
			data: { a0:se, a1: conn_id },
			success: function (result) {
				var connection_result = JSON.parse(result);
				if (connection_result.Result == true) {
					var connection_data = connection_result.info.data[0];
					$("#d_n").val(connection_data.ConnParamName);
					$("#d_n").attr("disabled", true);
					$("#Protocol_con").val(connection_data.ProtocolId).trigger('change');
					
					$("#HTTP").hide();
					$("#HTTPs").hide();
					$("#ORACLE").hide();
					$("#RADMIN").hide();
					$("#MSSQL").hide();
					$("#SYBASE").hide();
					$("#MY_DB2").hide();
					$('#RDP').hide();
					$("#SSH").hide();
					$('#MY_ConnType').hide();
					$("#DB2").hide();
					switch (connection_data.ProtocolId) {
						case 1:
							$('#RDP').show();
							$('#rdpType').val(connection_data.ConnType).trigger('change');
							break;
						case 2:
							$('#SSH').show();
							$('#ServiceName_ssh').val(connection_data.ServiceName).trigger('change');
							break;
						//HTTP
						case 6:
							$("#HTTP").show();
							$("#url").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#Submit").val(connection_data.ConnParamValue.substring(index+1));
							/*
							$("#HTTP").show();
							connection_data.ConnParamValue =connection_data.ConnParamValue.split('|');
							$("#url").val(connection_data.ServiceName);
							$("#UserName").val(connection_data.ConnParamValue[0]);
							$("#UserPwd").val(connection_data.ConnParamValue[1]);
							$("#Submit").val(connection_data.ConnParamValue[2]);
							*/
							break;
						//HTTPs
						case 7:
							$("#HTTPs").show();
							$("#httpsurl").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#httpsSubmit").val(connection_data.ConnParamValue.substring(index+1));
							/*
							$("#HTTPs").show();
							connection_data.ConnParamValue = JSON.parse(connection_data.ConnParamValue);
							$("#httpsurl").val(connection_data.ServiceName);
							if (connection_data.ConnParamValue.UserPwd == null) {
								connection_data.ConnParamValue.UserPwd = "";
							}
							if (connection_data.ConnParamValue.UserName == null) {
								connection_data.ConnParamValue.UserName = "";
							}
							if (connection_data.ConnParamValue.Submit == null) {
								connection_data.ConnParamValue.Submit = "";
							}
							$("#httpsUserPwd").val(connection_data.ConnParamValue.UserPwd);
							$("#httpsUserName").val(connection_data.ConnParamValue.UserName);
							$("#httpsSubmit").val(connection_data.ConnParamValue.Submit);
							*/
							//
							break;
						//ORACLE
						case 3:
							//
							
							if (connection_data.ConnParamValue == null) {
								connection_data.ConnParamValue = 0;
							}
							//指定项必填
							$("#appoint").val(connection_data.ConnParamValue).trigger('change');
							$("#s_n").val(connection_data.ServiceName);
							if (connection_data.ConnType == null) {
								connection_data.ConnType = 0;
							}
							$("#conn").val(connection_data.ConnType).trigger('change');
							//
							$("#ORACLE").show();
							break;
						//RADMIN
						case 12:
							//认证方式：
							if (connection_data.ConnType == null) {
								connection_data.ConnType = "0";
							}
							$("#authtype").val(connection_data.ConnType).trigger("change");
							$("#RADMIN").show();
							break;
						//MSSQL
						case 4:
							//
							//实例名：
							$("#o_n").val(connection_data.ServiceName);
							//认证方式：
							if (connection_data.ConnType == null) {
								connection_data.ConnType = "0";
							}
							$("#R_authtype").val(connection_data.ConnType).trigger("change");
							//
							$("#MSSQL").show();
							break;
						//MYSQL 
						case 5:
							//
							//数据库名：
							$('#sql_n').val(connection_data.ServiceName);
							//
							$("#MY_DB2").show();
							$('#MY_ConnType').show();
							break;
						//DB2
						case 14:
							//
							//数据库名：
							$('#dbsql_n').val(connection_data.ServiceName);
							//
							$("#DB2").show();
							break;
						//SYBASE
						case 13:
							//
							//实例名：
							$('#sy_o_n').val(connection_data.ServiceName);
							//
							$("#SYBASE").show();
							break;
					}
				} else {
					_alert(1, '连接参数', connection_result.ErrMsg);
					return false;
				}
			}
		});
	}

	$("#Protocol_con").change(function () {
		var p_id = $(this).val();
		
		$("#HTTP").hide();
		$("#HTTPs").hide();
		$("#ORACLE").hide();
		$("#RADMIN").hide();
		$("#MSSQL").hide();
		$("#SYBASE").hide();
		$("#MY_DB2").hide();
		$('#RDP').hide();
		$("#SSH").hide();
		$("#DB2").hide();
		$('#MY_ConnType').hide();
		switch (p_id) {
			case "1":
				$('#RDP').show();
				break;
			case "2":
				$('#SSH').show();
				break;
			//HTTP
			case "6":
				$("#HTTP").show();	
				break;
			//HTTP
			case "7":
				$("#HTTPs").show();
				break;
			//ORACLE
			case "3":
				$("#ORACLE").show();
				break;
			//RADMIN
			case "12":
				$("#RADMIN").show();
				break;
			//MSSQL
			case "4":
				$("#MSSQL").show();
				break;
			//MYSQL 
			case "5":
				$("#MY_DB2").show();
				$('#MY_ConnType').show();
				break;
			//DB2
			case "14":
				$("#DB2").show();
				break;
			//SYBASE
			case "13":
				$("#SYBASE").show();
				break;
		}
	});
}

var connection = {
	"ConnParamId": 0,
	"ConnParamName": null,
	"ProtocolId": 0,
	"ServiceName": null,
	"ConnType": null,
	"ConnParamValue": null
};

var cnameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
var sp_char = /^[^@\/\'\\\"#$%&\^\*|]+$/;
function connection_add(con_d){
	
	connection = {
		"ConnParamId": 0,
		"ConnParamName": null,
		"ProtocolId": 0,
		"ServiceName": null,
		"ConnType": null,
		"ConnParamValue": null
	};
	var p_id = $("#Protocol_con").val();
	var val = $("#d_n").val();
	var $i = $("#d_n").next('i.v-check');
	if (val == "") {
		_alert(2, "连接参数", '请输入名称', $("#d_n"));
		return false;
	}
	if (!cnameReg.test(val)) {
		_alert(1, "连接参数", '名称格式不正确', $("#d_n"));
		return false;
	}
	if (p_id == "0") {
		_alert(2, "连接参数", '请选择协议类型');
		return false;
	}
	connection.ConnParamName = val;
	if (conn_id == null){
		connection.ConnParamId = 0;
	}else{
		connection.ConnParamId = parseInt(conn_id);
	}
	switch (p_id) {
		case '1':
			connection.ServiceName = null;
			connection.ConnType = $('#rdpType').val();
			connection.ConnParamValue = null;
			break;
		//SSH
		case "2":
			var ServiceName_ssh = $('#ServiceName_ssh').val();
			connection.ServiceName = ServiceName_ssh;
			connection.ConnType = null;
			connection.ConnParamValue = null;
			break;
		//HTTP
		case "6":
			
			var url = $("#url").val();
			if (url == "") {
				_alert(2, "连接参数", "请输入URL", $("#url"));
				return false;
			}
			var UserName = $("#UserName").val();
			
			
			if (!sp_char.test(UserName) && UserName != "") {
				_alert(1, "连接参数", "账号元素格式不正确", $("#UserName"));
				//$("#UserName").val("");
				return false;
			}
			var UserPwd = $("#UserPwd").val();
			if (!sp_char.test(UserPwd) && UserPwd != "") {
				_alert(1, "连接参数", "密码元素格式不正确", $("#UserPwd"));
				//$("#UserPwd").val("");
				return false;
			}
			connection.ServiceName = url;
			connection.ConnType = null;
			var Submit = $("#Submit").val();
			var json_a = UserName + '|' + UserPwd + '|' + Submit;
			connection.ConnParamValue = json_a;
			break;
		//HTTPs
		case "7":
			
			var url = $("#httpsurl").val();
			if (url == "") {
				_alert(2, "连接参数", "请输入URL", $("#url"));
				return false;
			}
			var UserName = $("#httpsUserName").val();
			if (!sp_char.test(UserName) && UserName != "") {
				_alert(1, "连接参数", "账号格式不正确", $("#UserName"));
				//$("#UserName").val("");
				return false;
			}
			var UserPwd = $("#httpsUserPwd").val();
			if (!sp_char.test(UserPwd) && UserPwd != "") {
				_alert(1, "连接参数", "密码格式不正确", $("#UserPwd"));
				//$("#UserPwd").val("");
				return false;
			}
			connection.ServiceName = url;
			connection.ConnType = null;
			var Submit = $("#httpsSubmit").val();
			//Submit = '"' + Submit + '"';
			//UserName = '"' + UserName + '"';
			//UserPwd = '"' + UserPwd + '"';
			//var json_a = '{"UserName":' + UserName + ',"UserPwd":' + UserPwd + ',"Submit":' + Submit + '}';
			var json_a = UserName + '|' + UserPwd + '|' + Submit;
			connection.ConnParamValue = json_a;
			//connection.ConnParamValue = (JSON.parse(json_a));
			break;
		//ORACLE
		case "3":
			
			//指定项必填
			var appoint = $("#appoint").children("option:selected").val();
			if (appoint == "0") {
				_alert(2, "连接参数", "请选择指定项", $("#appoint"));
				return false;
			}
			var s_n = $("#s_n").val();
			if (s_n == "") {
				_alert(2, "连接参数", "请输入实例名或服务名", $("#s_n"));
				//$("#s_n").val("");
				return false;
			} else if (!sp_char.test(s_n)) {
				_alert(1, "连接参数", "实例名或服务名格式不正确", $("#s_n"));
				//$("#s_n").val("");
				return false;
			}
			var conn_text = $("#conn").children("option:selected").text();
			if (conn_text == "未指定") {
				conn_text = null;
			}
			var appoint_text = $("#appoint").children("option:selected").text();
			
			connection.ConnParamValue = appoint_text;
			connection.ServiceName = s_n;
			connection.ConnType = conn_text;
			break;
		//RADMIN
		case "12":
			//认证方式：
			var authtype = $("#authtype").children("option:selected").text();
			if (authtype == "未指定") {
				authtype = null;
			}
			
			connection.ServiceName = null;
			connection.ConnType = authtype;
			connection.ConnParamValue = null;
			break;
		//MSSQL
		case "4":
			//实例名：
			var o_n = $("#o_n").val();
			if (o_n == "") {
				_alert(2, "连接参数", "请输入实例名", $("#o_n"));
				//$("#o_n").val("");
				return false;
			} else if (!sp_char.test(o_n)) {
				_alert(1, "连接参数", "实例名格式不正确", $("#o_n"));
				//$("#o_n").val("");
				return false;
			}
			//认证方式：
			var R_authtype = $("#R_authtype").children("option:selected").text();
			if (R_authtype == "未指定") {
				R_authtype = null;
			}
			connection.ServiceName = o_n;
			connection.ConnType = R_authtype;
			connection.ConnParamValue = null;
			break;
		//MYSQL 
		case "5":
			//数据库名：
			var sql_n = $("#sql_n").val();
			if (sql_n == "") {
				_alert(2, "连接参数", "请输入数据库名", $("#sql_n"));
				//$('#sql_n').val("");
				return false;
			} else if (!sp_char.test(sql_n)) {
				_alert(1, '连接参数', '数据库名格式不正确', $("#sql_n"));
				//$("#sql_n").val("");
				return false;
			}
			var select_my=parseInt($('#select_my').val());
			connection.ServiceName = sql_n;
			connection.ConnType = select_my;
			connection.ConnParamValue = null;
			break;
		//DB2
		case "14":
			//数据库名：
			var sql_n = $("#dbsql_n").val();
			if (sql_n == "") {
				_alert(2, "连接参数", "请输入数据库名", $("#sql_n"));
				//$('#sql_n').val("");
				return false;
			} else if (!sp_char.test(sql_n)) {
				_alert(1, '连接参数', '数据库名格式不正确', $("#sql_n"));
				//$("#sql_n").val("");
				return false;
			}
			connection.ServiceName = sql_n;
			connection.ConnType = null;
			connection.ConnParamValue = null;
			break;
		//SYBASE
		case "13":
			//实例名：
			var sy_o_n = $("#sy_o_n").val();
			if (sy_o_n == "") {
				_alert(2, "连接参数", "请输入实例名", $("#sy_o_n"));
				//$('#sy_o_n').val("");
				return false;
			} else if (!sp_char.test(sy_o_n)) {
				_alert(1, '连接参数', '实例名格式不正确', $("#sy_o_n"));
				//$("#sy_o_n").val("");
				return false;
			}
			connection.ServiceName = sy_o_n;
			connection.ConnType = null;
			connection.ConnParamValue = null;
			break;
		default:
			connection.ServiceName = null;
			connection.ConnType = null;
			connection.ConnParamValue = null;
	}
	connection.ProtocolId = parseInt(p_id);
	var msstr = aceg(JSON.stringify(connection),se);
	$.ajax({
		url: '/bhost/add_connection',
		type: "POST",
		async: false,
		data: { a0: se, a1: JSON.stringify(connection),m1:msstr},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result == true) {
				$('.btn').blur();
				_alert(0,"连接参数","保存成功");
				con_d.close().remove();
				var conn_text = $('#ConnParamName').find('span').text();
				var sel_conid = $('#ConnParamName').data('value');
				$("div[data-id=xSelect-conn]").remove();
				$('#ConnParamName').empty().data('xSelect','');
				bind_conn_select();
				if (sel_conid == "-1" || sel_conid == undefined){
					var isexist = 0;
					$.each(connparm_list.data,function(i,item){
						if (item.ConnParamId == result.ConnParamId){
							$("#ConnParamName").data('value',result.ConnParamId);
							$("#ConnParamName").find('span').text(connection.ConnParamName);
							isexist = 1;
							return false;
						}
					});
					if (isexist == 0){
						$("#ConnParamName").data('value','-1');
						$("#ConnParamName").find('span').text('请选择');
					}
				}else{
					$.each(connparm_list.data,function(i,item){
						if (item.ConnParamId == sel_conid){
							$('#ConnParamName').find('span').text(conn_text);
							return false;
						}
					});
				}
			} else {
				_alert(1, "连接参数", result.ErrMsg, $("#d_n"));
				return false;
			}
		}
	});
}

////服务 浮层
function _getDialog1(type,name,obj){
	$('.btn-normal1').blur();
	clear_server();
	var $dialogCont = $("#scDCTab1").show();
	if(type == 'edit'){
		title = '服务';
	}else{
		title = '服务';
	}
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"scDCTab1",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	bind_protocol_select();
	//bind_conn_select();
	if(type == 'edit'){
		_editServer(name);
	}
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		if(type == 'edit'){
			_editServer(name);
		}else{
			clear_server();
		}
		//d.close().remove();
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if(_addServer(type,obj) == false) return false;
		d.close().remove();
	})
}

var accIP_nomal="";
var accIP_list;
function get_accIP(){
	//获取accIP
	$.ajax({
		url:'/bhost/get_accIP',
		type: "post",
		async:false,
		cache:false,
		data: {a0:se},
		success: function(Result) {
			accIP_list = JSON.parse(Result);
		}
	})
}

var in_ip_list = [];
function bind_in_ip(){
	var option_str = "";
	$.each(accIP_list.data,function(i,item){
		if (item.IsBuildin){
			in_ip_list.push(item);
			option_str = option_str + '<option value="'+item.AccIPId+'">'+item.AccIPId+'</option>';
		}
	});
	$("#in_ip").empty().append(option_str);
}

function bind_accip_select(){
	get_accIP();
	var accip_array = [];
	acc_index_all = [];
	$.each(accIP_list.data,function(i,item){
		acc_index_all.push(item.AccIPId);
		if (manager_arry.indexOf(item.AccIPId) > 0){
			return true;
		}
		if (manage_power_id.indexOf(14) != -1){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'delete'
			};
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':null
			};
		}
		
		if (item.IsBuildin){
			return true;
		}
		select_data_json.value = item.AccIPId;
		select_data_json.name = item.AccIP;
		accip_array.push(select_data_json);	
	});
	$('#accIP').empty().data('xSelect',"");
	if (manage_power_id.indexOf(14) != -1){
		$('#accIP').xSelect({
			width: 138,
			defaultText: '请选择',
			items:accip_array,
			module_type:'accIP',
			delete:function(item,obj){
				del_accip(obj);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						
						_editaccIP(obj);
					}
				}
			]
		});
	}else{
		$('#accIP').xSelect({
			width: 138,
			defaultText: '请选择',
			items:accip_array,
			module_type:'accIP'
		});
	}
	
}

function _editaccIP(){
	$("#accip_input").val('');
	var hostIPReg = /^((?:(?:2[0-4][0-9]\.)|(?:25[0-5]\.)|(?:1[0-9][0-9]\.)|(?:[1-9][0-9]\.)|(?:[0-9]\.)){3}(?:(?:2[0-5][0-5])|(?:25[0-5])|(?:1[0-9][0-9])|(?:[1-9][0-9])|(?:[0-9])))$/;
	var $dialogCont = $("#ConnIPDialog").show();
	var title = '前置机IP';
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"ConnIPDialog",
		width:"780px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){

	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var acc_ip = $("#accip_input").val();
		if(acc_ip == ""){
			_alert(2, title, '请输入前置机IP');
			return false;
		}else{
			if (!hostIPReg.test(acc_ip)) {
				_alert(1, title, "前置机IP格式不正确");
				return false;
			};
		}
		var flag_1 = 0;
		$.each(accIP_list.data,function(i,item){
			if(item.AccIP == acc_ip){
				_alert(1, title, '相同的前置机IP已存在');
				flag_1 = 1;
				return false;
			}
		})
		if(flag_1 == 1){
			return false;
		}
		save_accip(acc_ip,d);
	});
}

//保存前置机IP
function save_accip(ip,obj){
	var jsondata = {
		"AccIPId": 0,
		"AccIP": ""
	}
	jsondata.AccIP = ip;
	msstr = aceg(JSON.stringify(jsondata),se); 
	$.ajax({
		url:'/bhost/save_acc_ip',
		type:"POST",
		async:false,
		data:{a0:se,a1: JSON.stringify(jsondata),a10:"运维管理>设备类型",m1:msstr},
		//contentType: 'application/json',
		success: function(Result) {
			var data = JSON.parse(Result);
			if(data.Result){
				var result_id = data.AccIPId
				_alert(0,"前置机IP","保存成功");
				obj.close().remove();
				var accIP_text = $("#accIP").find('span').text();
				bind_accip_select();
				
				if ($("#accIP").data('value') == "-1" || $("#accIP").data('value') == undefined){
					$("#accIP").data('value',result_id);
					$("#accIP").find('span').text(ip);
				}else{
					$("#accIP").find('span').text(accIP_text);
				}
				return false;
			}
			else{
				_alert(1,"前置机",data.ErrMsg);
				return false;
			}
		}
	})
}

function del_accip(obj){
	var id = $(obj).find('span').data('value');
	var sel_id = $("#accIP").data('value');
	$(document)[0].onclick = null;
	$.ajax({
		url:'/bhost/del_acc_ip',
		type:'post',
		async:false,
		data:{a0:se,a1:id,a10:"运维管理>设备类型"},
		success:function(result){
			var result = JSON.parse(result);
			if (result.Result == true){
				$(obj).remove();
				acc_index_all.splice($.inArray(id, acc_index_all), 1);
				$.each(accIP_list.data,function(i,item){
					if (id == item.AccIPId){
						accIP_list.data.splice(i,1);
						return false;
					}
				})
				
				if (id == sel_id){
					$("#accIP").data('value','-1');
					$("#accIP").find('span').text('请选择');
				}
				return;
			}else{
				_alert(1, "主机",result.ErrMsg);
				return;
			}
		}
	})
}

var ServerIndex = -1;
var device_server = [];

function _addServer(type,obj){
	var ServiceSet={
		"DeviceServiceId": 0,
		"DeviceServiceName": "", 
		"ProtocolId": 0,
		"ProtocolName":"",
		"Port": 0,
		"ConnParamId": null,
		"ConnParamName": "",
		"AccIPSet": []    
	}
	
	DeviceServiceName = $("#DeviceServiceName").val();
	/*
	if(DeviceServiceName ==""){
		_alert(2,title,"请输入服务名称",$("#DeviceServiceName"));
		return false;
	}
	
	var nameReg = /^[a-zA-Z\d_\-]+$/;
	if(nameReg.test(DeviceServiceName)){
		_alert(1,title,'服务名称格式不正确',$("#DeviceServiceName"));
		return false;
	}
	
	var n = 0;
	if (type == 'edit'){
		var edit_index = $(obj).parents('tr:eq(0)').index();
	}
	$(DeviceType.ServiceSet).each(function(i,item){
		if(DeviceServiceName == item.DeviceServiceName && edit_index != i){
			_alert(2,title,'相同的服务名称已存在',$("#DeviceServiceName"));
			n=1;
			return false;
		}
	})
	
	if(n) return false;
	*/
	var ProtocolId = $("#ProtocolName").data('value');
	var pro_name = $("#ProtocolName").find('span').text();
	if(ProtocolId == "-1" || ProtocolId == undefined){
		_alert(2,title,"请选择协议",$("#ProtocolName"));
		return false;
	}
	Port = $("#Port").val();
	if(Port == ""){
		_alert(2,title,"请输入协议端口",$("#Port"));
		return false;
	}
	
	if(parseInt(Port)<=0 || parseInt(Port) >=65535){
		_alert(2,title,"协议端口在0~65535之间",$("#Port"));
		return false;
	}
	
	var n = 0;
	if (type == 'edit'){
		var edit_index = $(obj).parents('tr:eq(0)').index();
	}
	$(DeviceType.ServiceSet).each(function(i,item){
		if(ProtocolId == item.ProtocolId && Port == item.Port && edit_index != i){
			_alert(2,title,'相同的配置已存在');
			n=1;
			return false;
		}
	})
	if(n) return false;
	/*
	var ConnParamId = $("#ConnParamName").data('value');
	var conn_name = $("#ConnParamName").find('span').text();
	if(ConnParamId == "-1" || ConnParamId == undefined){
		ConnParamId = null;
	}
	*/
	
	var ServiceSetString = JSON.stringify(DeviceType.ServiceSet);
	
	
	if (DeviceServiceName == "") {
		DeviceServiceName1 = $("#ProtocolName").find('span').text();
		DeviceServiceName2 = $("#ProtocolName").find('span').text() + Port;
		
		service_tmp1 = "\"DeviceServiceName\":\"" + DeviceServiceName1 + "\"";
		service_tmp2 = "\"DeviceServiceName\":\"" + DeviceServiceName2 + "\"";
		if (ServiceSetString.indexOf(service_tmp1) >= 0) {
			if (ServiceSetString.indexOf(service_tmp2) >= 0) {
				_alert(2, title, '相同的服务已存在');
				return false;
			} else {
				ServiceSet.DeviceServiceName = DeviceServiceName2;
			}
		} else {
			ServiceSet.DeviceServiceName = DeviceServiceName1;
		}
	} else {
		if(ServiceSetString.indexOf("\"DeviceServiceName\":\"" + DeviceServiceName + "\"") >=0 && type == 'add'){
			_alert(2,title, '已存在相同的服务名称',$("#DeviceServiceName"));
			return false;
		}
		ServiceSet.DeviceServiceName = DeviceServiceName;
	}
	if (type == 'add'){
		ServiceSet.DeviceServiceId = 0;
	}else{
		ServiceSet.DeviceServiceId = DeviceType.ServiceSet[edit_index].DeviceServiceId;
	}
	//ServiceSet.DeviceServiceName = $("#DeviceServiceName").val();
	ServiceSet.ProtocolId = parseInt(ProtocolId);
	ServiceSet.ProtocolName = pro_name;
	ServiceSet.Port = parseInt($("#Port").val());
	//ServiceSet.ConnParamId = ConnParamId;
	//ServiceSet.ConnParamName = conn_name;
	//ServiceSet.AccIPSet = [];
	/*
	var accip_list = [];
	var accip_name = [];
	
	if ($("#accIP_cont").children('div:first').find('select:first').val() == 1){
		var id = $("#accIP_cont").children('div:first').children('div:eq(1)').find('select').val();
		accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\"\"}");
		ServiceSet.AccIPSet.push(accIP_json);
		accip_list.push(id);
	}else{
		var id = $("#accIP_cont").children('div:first').children('div:eq(2)').data('value');
		if (id != undefined && id != "-1"){
			var name = $("#accIP_cont").children('div:first').children('div:eq(2)').find('span').text();
			accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\""+name+"\"}");
			ServiceSet.AccIPSet.push(accIP_json);
			accip_list.push(name);
		}
	}
	
	$("#accIP_cont").children('div:not(:first)').each(function(i,item){
		var id = $(item).children('div:eq(2)').data('value');
		var name = $(item).children('div:eq(2)').find('span').text();
		accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\""+name+"\"}");
		ServiceSet.AccIPSet.push(accIP_json);
		accip_list.push(name);
	});
	*/
	
	if(type == "add") {
		
		DeviceType.ServiceSet.push(ServiceSet);
		
		//导入到列表中
		ServerIndex = ServerIndex + 1;
		$("#service_list").append("<tr id=\"ser_"+ServerIndex+"\"><td>"+ServiceSet.DeviceServiceName+"</td><td>"+pro_name+"("+$("#Port").val()+")</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" title=\"编辑\" onclick=\"_getDialog1('edit','"+ServiceSet.DeviceServiceName+"',this)\"></a><a href=\"javascript:;\" class=\"del\" title=\"删除\" onclick=\"_delServer('"+ServiceSet.DeviceServiceName+"',this)\"></a></div></td></td></tr>");
		//$("#service_list").append("<tr id=\"ser_"+ServerIndex+"\"><td>"+ServiceSet.DeviceServiceName+"</td><td>"+pro_name+"("+$("#Port").val()+")</td><td>"+conn_name.replace("请选择","")+"</td><td>"+accip_list.join(',')+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" title=\"编辑\" onclick=\"_getDialog1('edit','"+ServiceSet.DeviceServiceName+"',this)\"></a><a href=\"javascript:;\" class=\"del\" title=\"删除\" onclick=\"_delServer('"+ServiceSet.DeviceServiceName+"',this)\"></a></div></td></td></tr>");
	}
	else {
		
		DeviceType.ServiceSet[edit_index]= ServiceSet;
		$(obj).parents('tr:first').html("<td>"+ServiceSet.DeviceServiceName+"</td><td>"+pro_name+"("+$("#Port").val()+")</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" title=\"编辑\" onclick=\"_getDialog1('edit','"+ServiceSet.DeviceServiceName+"',this)\"></a><a href=\"javascript:;\" class=\"del\" title=\"删除\" onclick=\"_delServer('"+ServiceSet.DeviceServiceName+"',this)\"></a></div></td></td>");
		//$(obj).parents('tr:first').html("<td>"+ServiceSet.DeviceServiceName+"</td><td>"+pro_name+"("+$("#Port").val()+")</td><td>"+conn_name.replace("请选择","")+"</td><td>"+accip_list.join(',')+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" title=\"编辑\" onclick=\"_getDialog1('edit','"+ServiceSet.DeviceServiceName+"',this)\"></a><a href=\"javascript:;\" class=\"del\" title=\"删除\" onclick=\"_delServer('"+ServiceSet.DeviceServiceName+"',this)\"></a></div></td></td>");
	}
	$("#service_list tr").bind("dblclick",function(){
		$(this).children('td:last').find('.edit').click();
	});
	clear_server();
}
//重置数据
function clear_server(){
	manager_arry=['-1'];
	manageradd = 0;
	manager_index = 0;
	manager_value = "";
	$("#DeviceServiceName").val("");
	$("#Port").val("");
	//$("#ProtocolName").select2('destroy').select2({minimumResultsForSearch: -1});
	//$("#ProtocolName option:eq(0)").prop("selected",true);
	//$("#ProtocolName").change();
	bind_protocol_select();
	//bind_conn_select();
	//$("#accIP_type").val(2).trigger('change');
	//bind_accip_select();
	//$("#accIP_cont").children('div:not(:first)').remove();
}

var manager_arry=['-1'];
var manageradd = 0;
var manager_index = 0;
var manager_value = "";
function _addaccIP(obj){
	
	var accip_id = $(obj).prev('div').data('value');
	var v = $(obj).prev('div').find('span').text();
	var $c = $(obj).parent().clone();
	if (accip_id == undefined || accip_id == '-1'){
		_alert(2, "设备类型", "请选择应用发布");
		return false;
	}
	accip_id = parseInt(accip_id);
	if (manager_arry.indexOf(accip_id) === -1) {
		
		manager_arry.push(accip_id);
	}
	
	
	acc_index_all.splice($.inArray(accip_id, acc_index_all), 1);
	$(obj).parent().parent().append($c);
	$c.find('select').attr('disabled',true);
	$c.find('span.select2-selection--single').css("background-color","rgb(235, 235, 228)");
	//$c.find('span.select2-selection__arrow').remove();
	$c.find('a').after('<a class="ctrl del" onclick="_delIP(this,3)"></a>').remove();
	$c.find('.form-c').css("background-color","rgb(235, 235, 228)");
	$c.find('.form-c').data('value',accip_id);
	$c.find('select').attr('id',"");
	$c.find('.form-c').attr('id',"");
	$(obj).prev().find('span').text('请选择');
	$(obj).prev().data('value',-1);
	$("div[data-id=xSelect-accIP]").children('input').val('');
	$("div[data-id=xSelect-accIP]").find('span[data-value='+accip_id+']').parent('li').remove();
}

function change_acc_type(obj){
	if ($(obj).val() == 1){
		$(obj).parent().next().show();
		$(obj).parent().next().next().hide();
		$(obj).parent().next().next().next().hide();
		$(obj).siblings('a').hide();
	}else{
		$(obj).parent().next().hide()
		$(obj).parent().next().next().show();
		$(obj).parent().next().next().next().show();
		$(obj).siblings('a').show();
	}
}

function _delIP(obj){
	var $c = $(obj).prev();
	var id = $c.data('value');
	
	
	var t = $(obj).prev().find('span').text();
	var v, data, max;
	var min = 0;
	max = acc_index_all.length - 1;
	data = acc_index_all;
	//$('.ctrl.add').parent('.form-c.srsCtl').show();
	manager_arry.splice($.inArray(id, manager_arry), 1);
	var $p = $("div[data-id=xSelect-accIP]").children('ul');
	$(obj).parent().remove();
	var index_1 = search_i(min, max, parseInt(id), data);
	index_1 = parseInt(index_1);
	
	
	if (index_1 == -1) {
		index_1 = max;
		if (manage_power_id.indexOf(14) != -1){
			$p.append('<li style=""><i class="delete"></i><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
		}else{
			$p.append('<li style=""><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
		}
	} else if (index_1 == -2) {
		index_1 = 0;
		//$p.children('li').eq(0).before('<li style=""><i class="delete"></i><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
		if (manage_power_id.indexOf(14) != -1){
			$p.prepend('<li style=""><i class="delete"></i><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
		}else{
			$p.prepend('<li style=""><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
		}
	} else {
		if (manage_power_id.indexOf(14) != -1){
			$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="delete"></i><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
		}else{
			$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
		}
	}
	data.splice(index_1, 0, parseInt(id));
}

function search_i(min, max, id, data) {
	var mid, res;
	if (data[max] < id) {
		return -1;
	}
	
	
	if (data[min] > id) {
		return -2;
	}
	while (min <= max) {
		mid = parseInt((min + max) / 2);
		if (data[mid] > id) {
			max = mid - 1;
			res = mid;
		} else {
			min = mid + 1;
		}
	}
	return res;
}

function select_change(obj){
	if ($(obj).children('option').length == 2){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}
}

//编辑 服务列表数据绑定
function _editServer(Name){
	//清空前置机 待定
	clear_server();
	
	
	$(DeviceType.ServiceSet).each(function(i,item){
		if(Name == item.DeviceServiceName){
			//ServerIndex = i;
			ServiceSet = item;
			$("#DeviceServiceName").val(item.DeviceServiceName);
			$("#ProtocolName").data('value',item.ProtocolId);
			$("#ProtocolName").find('span').text(item.ProtocolName);
			sel_id = item.ProtocolId;
			//bind_conn_select();
			//$("#ConnParamName").data('value',item.ConnParamId);
			//$("#ConnParamName").find('span').text(item.ConnParamName);		
			$("#Port").val(item.Port);
			//var $c = $("#accIP_cont");
			//绑定前置机ip
			/*
			if (item.AccIPSet != null){
				for (var i1 = item.AccIPSet.length; i1 > 0; i1--){
					manager_arry.push(item.AccIPSet[i1-1].AccIPId);
					
					if (i1 != 1){
						if (item.AccIPSet[i1-1].AccIP != ""){
							$("#accIP_type").val(2).trigger('change');
							$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
							$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
							$('.add').click();
						}
					}else{
						if (item.AccIPSet[i1-1].AccIP != ""){
							$("#accIP_type").val(2).trigger('change');
							$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
							$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
						}else{
							$("#accIP_type").val(1).trigger('change');
							$("#in_ip").val(item.AccIPSet[i1-1].AccIPId).trigger('change');
						}
					}
				}
			}
			*/			
		}
	})
	
	
}
function _delServer(Name,obj){
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"设备类型",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			
			
			$(DeviceType.ServiceSet).each(function(i,item){
				if(Name == item.DeviceServiceName){
					DeviceType.ServiceSet.splice(i,1);
					
					return false;
				}
			})
			$(obj).parent().parent().parent().remove();
			clear_server();
		},
		btn2:function(i){
			 parent.layer.close(i);
		}
	});
}

var icon_json = {
	"-2px":"Unix",
	"-52px":"Switchboard",
	"-102px":"Ruijie",
	"-152px":"Linux",
	"-202px":"Huawei",
	"-252px":"Host",
	"-300px":"Firewall",
	"-352px":"H3C",
	"-402px":"Cluster",
	"-452px":"Cisco",
	"-502px":"AS400",
	"-552px":"Aix",
	"-602px":"Network",
	"-652px":"Windows",
	"-702px":"Server",
	"-752px":"ZTE",
	"-802px":"DP"
}


var TID = 0;
function savedata(){
	var namecheck = /^[_\-.\n\w\u4e00-\u9fa5]*$/;
	var DeviceTypeName = $("#DeviceTypeName").val();
	if(DeviceTypeName == ""){
		_alert(2,'设备类型',"请输入名称",$("#DeviceTypeName"));
		return false;
	};
	if(!namecheck.test(DeviceTypeName)){
		_alert(1,'设备类型',"名称格式不正确",$("#DeviceTypeName"));
		return false;
	};
	var len = 0;
	for (var i = 0; i < DeviceTypeName.length; i++) {
	   if (DeviceTypeName.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null) //全角 
		   len += 2; 
	   else
		   len += 1; 
	}
	if(len >= 128){
		_alert(1,'设备类型',"输入的名称过长",$("#DeviceTypeName"));
		return false;			
	}
	DeviceType.DeviceTypeName = DeviceTypeName;
	
	if($("#Description").val().length > 255){
		_alert(1,'设备类型','设备类型描述内容过长',$("#Description"));	
		return false;
	}
	DeviceType.Description = $("#Description").val()
	
	if ($("#tAvatar").attr('class') == "add_icon_png"){
		_alert(1,'设备类型',"请选择图标");
		return false;
	}
	
	var b_p = $("#tAvatar").css('background-position');
	/*
	if($("#host_type").val() == "-1"){
		_alert(2,'设备类型',"请选择类型");
		return false;
	}
	*/
	
	//DeviceType.DeviceTypeIcon = $("#host_type").val();
	
	var b_p_x = b_p.split(' ')[0];
	DeviceType.DeviceTypeIcon = icon_json[b_p_x];
	
	
	if($("#Enabled").prop("checked")){
		DeviceType.Status = 1;
	}else{
		DeviceType.Status = 0;
	}

	if ($("#AcctSwitchCmd").val() != ""){
		DeviceType.AcctSwitchCmd = $("#AcctSwitchCmd").val();
	}else{
		DeviceType.AcctSwitchCmd = null;
	}
	if ($("#SwitchPasswdPrompt").val() != ""){
		DeviceType.SwitchPasswdPrompt = $("#SwitchPasswdPrompt").val();
	}else{
		DeviceType.SwitchPasswdPrompt = null;
	}
	//服务信息
	if(DeviceType.ServiceSet.length == 0){
		_alert(2,'设备类型','请添加服务');
		return false;
	}
	var msstr = aceg(JSON.stringify(DeviceType),se);
	$.ajax({
		url:'/bhost/save_devicetype',
		type: "post",
		async:false,
		cache:false,
		data: {a0:se,a1:JSON.stringify(DeviceType),m1:msstr},
		success: function(Result) {
			data = JSON.parse(Result);
			if(data.Result){
				$('.btn').blur();
				parent.layer.open({
					type:1,
					title:"设备类型",
					content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						parent.layer.close(i);
						TID = data.DeviceTypeId;
						back(2);
					}
				});
				
			}else{
				_alert(1,"设备类型","执行失败：" + data.ErrMsg);
			}
		}
	})
}

function back(type){
	if (tasktype == 2){
		if (type == 2){
			keyword = [];
			if (edit != "None"){
				$.ajax({
					url:'/bhost/get_index',
					type:'post',
					async:false,
					data:{a0:se,z1:edit.data[0].DeviceTypeId,z2:13},
					success:function(result){
						now = Math.ceil(parseInt(result)/MAX_PAGE);
						
					}
				});
			}else{
				/*
				$.ajax({
					url:'/bhost/get_devicetype_list',
					type:'post',
					async:false,
					data:{a0:se,z1:"null",z2:"null",z3:JSON.stringify(keyword)},
					success:function(result){
						var result = JSON.parse(result);
						var remain = parseInt(result.totalrow) % MAX_PAGE;
						if (remain > 0){
							now = Math.ceil(parseInt(result.totalrow)/MAX_PAGE);
						}else{
							now = parseInt(result.totalrow)/MAX_PAGE + 1;
						}
					}
				});*/
				$.ajax({
					url:'/bhost/get_index',
					type:'post',
					async:false,
					data:{a0:se,z1:TID,z2:13},
					success:function(result){
						now = Math.ceil(parseInt(result)/MAX_PAGE);
						
					}
				});
			}
		}
		document.frm_access.action = '/bhost/devicetype_manage';
		document.frm_access.a0.value = se;	
		document.frm_access.z1.value = now;	
		document.frm_access.z3.value = tasktype;
		document.frm_access.z4.value = JSON.stringify(keyword);
		document.frm_access.z5.value = filter_flag;
		document.frm_access.z6.value = JSON.stringify(selectid);
		document.frm_access.submit();
	}else{
		
		document.frm_access.tasktype.value=3;
		document.frm_access.i10.value=1;
		document.frm_access.us.value=window.parent.document.frm.us.value;
		document.frm_access.se.value=window.parent.document.frm.se.value;
		document.frm_access.action = '/bhost/index';
		document.frm_access.submit();
	}
}

function port_check(obj){
	obj.value = obj.value.replace(/\D/g,"");
}

//获取头像列表
function _getAvatarList(obj){
	var offset = $(obj).offset();
	$('#avatars').css({
		top:offset.top -5,
		left:offset.left -5
	}).show();

	document.onclick = null;

	$('#avatars').hover(function(){
		document.onclick = null;
	},function(){
		document.onclick = function(){
			$('#avatars').fadeOut();
		}
	})
}

//设置头像
function _setAvatar(obj){
	//var src = $(obj).children('img').attr('src');
	var obj_class = $(obj).attr('class');
	$(obj).addClass('active').parent().siblings('li').children('a').removeClass('active');
	var style_p = $(obj).css('background-position');
	$("#tAvatar").attr('class',obj_class);
	$("#tAvatar").css('background-position',style_p);
	$('#avatars').fadeOut();
	//photo = src.split('/')[3];
}

$(window).resize(function(){
	if($('#avatars').is(':visible')){
		var offset = $('#tAvatar').offset();
		$('#avatars').css({
			top:offset.top -5,
			left:offset.left -5
		});
	}
})

</script>
{% endblock  %}
