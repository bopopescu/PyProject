<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" http-equiv="X-UA-Compatible" content="IE=11;IE=10;IE=9; IE=8; IE=EDGE,chrome=1" />
	<title>manager</title>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
</head>

<body style="overflow:hidden;" class="bg-white">
	<div class="container">
		<div class="c-top">
			<div class="c-title">
				<div class="manual-head" style="">
					<div class="manual-title title-item" id="">
						<span>批量执行</span>
						<i class="batchs_icon" style=""></i>
					</div>

					<div class="secnav1">
						<ul>
							<li class="active" onclick="_goStep(1,this)">协议配置<div class='before'></div></li>
							<li onclick="_goStep(2,this)">范围选定<div class='before'></div></li>
						</ul>
					</div>
				</div>
			</div>

			<!---->
			<div id="contWrap">

				<!--page 1-->
				<div class="c-cont" id="cont1">
					<div class="c-wrap">
						<div class="c-exp">
							<div class="h-explorer">
								<div class="h-top">
									<div class="h-tit">
										<div class="form-item">批处理配置</div>
									</div>
								</div>

								<div class="h-content" style="height: auto;">
									<div class="execItems">
										<div class="exec-item">
											<div class="label"><em class="imp">*</em>任务名称：</div>
											<div class="group">
												<input type="text" id="TaskName" name="" onblur="regCheck(this,nameReg);" style="width: 176px;">
												<i class="v-check"></i>特殊字符仅支持下划线、横杠、小数点

											</div>
										</div>

										<div class="exec-item">
											<div class="label"><em class="imp">*</em>协议：</div>
											<div class="group">
												<select name="" id="PType" class="select2" style="width:185px">
													<option value="1">Windows,*unix批处理</option>
													<option value="2">MYSQL批处理</option>
													<option value="3">ORACLE批处理</option>
												</select>
												<label style="float: none; display: none; margin-left: 22px;" id="SSHobj"><input type="checkbox" name="" id="SSHOpened" >开启SSH通道</label>
											</div>
										</div>

										<div class="exec-item">
											<div class="label">开始时间：</div>
											<div class="group">
												<div class="timeTemp" id="timeTemp" style="float:left;margin-right: 20px">
													<span class="stwrap">
														<input type="text" value="" placeholder="日期" class="datepicker" id="StartDate" readonly>
														<input type="number" value="" placeholder="时" class="timeinput" id="StartHour" onkeyup="dataCheck(this, 0, 23);" min="0" max="23">
														<span class="srTip">:</span>
														<input type="number" value="" placeholder="分" class="timeinput" id="StartMin" onkeyup="dataCheck(this, 0, 59);" min="0" max="59">
														<span class="srTip">:</span>
														<input type="number" value="" placeholder="秒" class="timeinput" id="StartSec" onkeyup="dataCheck(this, 0, 59);" min="0" max="59">
													</span>
												</div>

												<label><input type="checkbox" name="" id="execCheck"> 立即执行</label>
											</div>
										</div>

										<div class="exec-item">
											<div class="label">重复周期：</div>
											<div class="group">
												<input type="number" name="" id="ReContent" value="30" placeholder="" onkeyup="dataCheck(this, 0, 360);" style="width: 60px;float: left;margin: 1px 10px 0 0;text-align: center;">
												<select name="" id="ReType" class="select2" style="width: 72px;">
													<option value="1">天</option>
													<option value="2">分钟</option>
												</select>
											</div>
										</div>

										<div class="exec-item">
											<div class="label">备注：</div>
											<div class="group">
												<input type="text" id="Remark" name="" style="width: 350px">
											</div>
										</div>
									</div>
								</div>

								<!---->
								<div class="h-top h-top2">
									<div class="h-tit">
										<div class="form-item">指令文件</div>
									</div>
								</div>

								<div class="h-content" id="execCont">
									<!---->
									<div class="execList">
										<div class="execSH" id="execList">
											<ul>
											</ul>
										</div>
										
										<div class="exec-bot">
											<form id="uploadForm">
												<input id="file_v" name="file_v" class="form-text" type="text" style="display: none;">
												<input type="file" class="fileInput" name="file_change" id="file_change" onchange="_getFile(this)">
												<div class="fileFix">
													<input type="text" placeholder="点击浏览文件…">
													<button>上传</button>
												</div>
											</form>
										</div>
										
									</div>

									<!---->
									<div class="execView">
										<div class="execSH">
											<!--<textarea name="" id="viewCont" cols="30" rows="10">-->
<pre id="viewCont">
</pre>
											<!--</textarea>-->
										</div>

										<div class="exec-bot">
											<div class="fileFix">
												<input type="text" placeholder="输入文件名" id="execFilename">
												<button onclick="_saveFilename(this)">保存</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!--page 2-->
				<div class="c-cont" style="display: none;">
					<div class="c-wrap" style="padding: 10px 0 0;" id="step2">
						<div class="c-exp">

							<div class="h-explorer">
								<div class="h-top">

									<div class="h-tit">
										<div class="form-item form-nm">
											<div style="margin-top:-1px">
												<select name="" id="typeSet" class="filter-select" style="width: 120px; margin-top: -2px; display: none;" onchange="_typeSet(this)">
													<option value="1" selected>对象指定</option>
													<option value="2">范围指定</option>
												</select>
											</div>
										</div>
									</div>
								</div>
								<div id="pointSet1" style="display:none;">
									<div class="h-content3 sel-type1" id="server_frame" style="border-bottom: 1px solid #CCC;color: #9a9a9a;overflow-x: hidden;width:100%;">
										<div class="form-tag" style="width:105px;line-height:43px;padding:0px;">
											<em class="imp">*</em>服务器范围：
										</div>
										<!-- <div class="form-c c-form-host" style="min-width: 1173px;margin-left: 85px;" id="server_frame_list">
											<div class="item" style="width:229px;margin-left: -14px;">
												<div class="" id="ips" style="float:left;width: 162px;margin-left: 17px;"></div>
												<i class="ctrl add" style="margin-top: 6px" onclick="add_server_scope(this)"></i>
											</div>
										</div> -->
										<div id="ip_n" name="ip_n" class="form-c c-form-host" style="float:left;padding-left:10px;padding-bottom:0px;width:auto;min-width: 380px;" value="0">
											<span class="ss ss-add" id="ip_span" value="0" style="float:left;width: 312px;position:static;padding: 0 7px 10px 0;">
												<input type="text" class="form-text form-text2" id="input1" onblur="_addIp($('#btn1'),1);" placeholder="起始IP地址" style="width:122px;">
												<span style="vertical-align:middle;">-</span>
												<input type="text" class="form-text form-text2" id="input2" onblur="_addIp($('#btn1'),1);" placeholder="结束IP地址" style="width:122px;">
												<i class="ctr ctr-add" id="btn1" onclick="_addIp(this);" style="margin-left: 5px;"></i>
											</span>
										</div>
									</div>
									<div class="dialog-cont" id="server_suspend" style="display:none;max-height:500px">
										<div class="container" style="margin-top: -10px;">
											<div class="c-cont2" style="padding: 0px;">
												<div class="c-wrap" style="padding: 0px 0 0">
													<div class="c-exp" style="">

														<div class="h-explorer1" style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);border-image: initial;margin: 0px auto;">
															<div class="h-top">
																<div class="form-item" style="padding: 0 0 0 21px;float:left;width:auto;margin:3px;">
																	<span class="form-tag" style="float:left;width:auto;">
																		<em class="imp">*</em>名称：</span>
																	<div class="form-c" style="float:left;padding-left:0px;">
																		<input type="text" class="form-text" id="d_n" name="d_n" style="width:160px;" maxlength="128" onblur="regCheck(this,nameReg);">
																		<i class="v-check" style="    margin: 7px 0 0 -26px;"></i>
																		<span>特殊字符仅支持下划线、横杠、小数点</span>
																	</div>
																</div>
															</div>

															<div class="h-catelog h-catelog2 h-catelog2_tmp" style="width:353px;max-height:400px;background: none;overflow-x: hidden;">
																<h2 style="font-size: 14px;padding: 19px 0 0 0;font-weight: 400;">IP地址：</h2>
																<div id="ip_n1" name="ip_n1" class="form-c c-form-host" style="padding-left:10px;width:360px;min-width:300px;float: left;"
																 value="0">
																	<span class="ss ss-add" id="ip_span1" value="0" style="position:static;padding-bottom: 10px;width:170px">
																		<input type="text" class="form-text" style="width:110px;">
																		<i class="ctr ctr-add" onclick="_addIp1(this)" style="margin-left: 5px;"></i>
																	</span>
																</div>
																<h2 style="font-size: 14px;padding:0px;float:left;font-weight: 400;">IP区间：</h2>
																<div id="ip_n" name="ip_n" class="form-c c-form-host" style="padding-left:10px;width:320px;min-width:300px;float: left;"
																 value="0">
																	<span class="ss ss-add" id="ip_span" value="0" style="position:static;padding-bottom: 10px;">
																		<input type="text" class="form-text" placeholder="起始IP地址" style="width:110px;">
																		<span style="vertical-align:middle;">-</span>
																		<input type="text" class="form-text" placeholder="结束IP地址" style="width:110px;">
																		<i class="ctr ctr-add" onclick="_addIp2(this);" style="margin-left: 5px;"></i>
																	</span>
																</div>
															</div>

															<div class="h-content2 h-catelog2_tmp" style="max-height:400px;overflow:hidden">
																<div class="h-top" style="background-color: #fff; margin-top: -22px;">
																	<div class="filter" style="float:right;  min-width: auto;">
																		<div id="waitTip" class="waitTip1" style="float: right;margin-top: 7px;margin-left: -26px;"></div>
																		<div class="search">
																			<select name="server_select" id="server_select" class="filter-select">
																				<option value="0" selected>所有</option>
																				<option value="hgname">组名</option>
																				<option value="hostname">主机名</option>
																				<option value="ip">IP</option>
																			</select>

																			<input type="text" class="filter-text server_text" placeholder="输入关键字" name="server_text" id="server_text" maxlength="128"
																			 onkeydown="if (event.keyCode == 13){_addFilter1(this,false);return false;} else return;">

																			<button class="btn filter-btn" onclick="_addFilter1(this,false)">
																				<i class="add-filter"></i>
																			</button>
																			<button class="btn filter-btn" onclick="_addFilter1(this,true)">
																				<i class="append-filter"></i>
																			</button>
																		</div>
																		<div class="search" id="clearFilter1" style="margin: 0px 15px 0px -16px;display:none;">
																			<button class="filter-btn" onclick="_clearFilter1(this)">
																				<i class="clear-filter"></i>
																			</button>
																		</div>
																		<div class="selector selector-multiple" id="filterWW" style="display: none;width: 146px;">
																			<span class="ww" style="width:9.5em">搜索条件</span>
																			<ul style="padding-left: 0px;    width: 146px;"></ul>
																		</div>
																	</div>
																</div>

																<div style="overflow: auto;width:100%;height:96%;margin-top: 2px;" id="hosttree_div">
																	<h2 style="font-size: 14px;margin-top:3px;">
																		<em class="imp">*</em>主机：</h2>
																	<ul id="userTree1" class="hosttree" style="padding: 0 0 0 0; float: left;    margin-top: 0px;"></ul>
																</div>
															</div>
														</div>
													</div>

													<div class="clearfix"></div>
													<div class="btns" style="margin-bottom: -25px;">
														<a href="javascript:;" class="btn btn-submit btn-normal">保&nbsp;&nbsp;存</a>
														<a href="javascript:;" class="btn btn-cancel btn-normal">重&nbsp;&nbsp;置</a>
													</div>
												</div>
											</div>
										</div>
									</div>
									<div class="h-top">

										<div class="h-tit">
											<div class="form-item form-nm" style="width:200px;">
												<div style="margin-top:-1px">
													<select name="" id="define_select" class="filter-select" style="width: 80px;margin-top:-2px" onchange="define_change(this);">
														<option value="1">已定义</option>
														<option value="2">自定义</option>
													</select>
												</div>
												<div id="mix_module" style="margin-top: -34px;margin-left: 85px;">
													<select name="" id="mix_select" class="filter-select" style="width: 80px;display:none;" onchange="mix_change(this);">
														<option value="1">所有</option>
														<option value="2">共有</option>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div id="custom_info" style="display:none">
										<div class="h-catelog h-catelog2 h-content2_temp" style="height: 350px; width: 28.3%;background-color: #ffffff; padding: 0px;max-height:400px;overflow-x: hidden;">
											<div class="c-col2 ss" style="width: 320px;padding: 0;margin-left: 22px;margin-top: 10px;">

												<div>
													<span class="form-tag" style="float: none;">
														<em class="imp">*</em>账号：</span>	
												</div>

												<div class="ss-cont h-content3" id="account_module" style="padding: 0;min-width:100%">
													<li class="item">
														<select class="filter-select" name="" id="account_select" style="width:120px" onchange="change_account(this);">
														</select>
														<i class="ctrl add" onclick="_addaccount(this)"></i>
													</li>
												</div>
											</div>
										</div>
										<div class="h-catelog h-catelog2 h-content2_temp" style="height: 350px; width: 71.6%;background-color: #ffffff;padding: 0px;border-right:0px;max-height:400px">
											<div class="c-col2 ss">
												<div>
													<span class="form-tag" style="float: none;">
														<em class="imp">*</em>服务：</span>
												</div>
												<div class="h-content22" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
													<div class="c-table">
														<table cellpadding="0" cellspacing="0" style="margin-bottom:20px;">
															<thead>
																<tr>
																	<th>协议</th>
																	<th>端口</th>
																	<th>连接参数</th>
																	<th width="55"></th>
																</tr>
															</thead>

															<tbody id="service_list1" style="height:auto">

															</tbody>
															</tbody>
														</table>
														<div class="form">
															<div class="form-item form-item-100" style="width:100%">
																<div style="text-align: right;">
																	<a href="javascript:;" id="" class="btn btn-normal1" onclick="_getDialog1('add','');">添&nbsp;&nbsp;加</a>
																</div>
															</div>
														</div>
													</div>
												</div>


												<div class="dialog-cont" id="scDCTab1" style="display:none;">
													<div class="container">
														<div class="c-cont1" style="max-height:280px;overflow:auto; min-height: 220px;">
															<div class="c-wrap" style="padding:0 0 90px;margin-top: -10px;overflow: hidden;">
																<div class="c-form c-form-host col3" style="min-width:760px;">

																	<div class="clearfix"></div>
																	<div class="c-table" style="padding: 0;margin-left: 10px;">
																		<div class="form" style="overflow: hidden;">
																			<div class="form-item" style="width:284px;margin-left: -5px;" id="device_module">
																				<span class="form-tag">设备类型：</span>
																				<div class="form-c">
																					<select class="form-select" name="" id="device_type" onchange="change_device_type(this);" style="width: 140px;">
																						<option value="-1">请选择</option>
																					</select>
																				</div>
																			</div>
																			<div class="form-item" style="width:284px;margin-left: -10px;" id="module_server">
																				<span class="form-tag">模板载入：</span>
																				<div class="form-c">
																					<select class="form-select2" name="" id="def_server" onchange="show_def_server(this);" style="width: 140px;">
																						<option value="-1">请选择</option>
																					</select>
																				</div>
																			</div>
																			<div class="form-item" style="width: 284px;margin-left: -5px;">
																				<span class="form-tag">
																					<em class="imp">*</em>协议：</span>
																				<div class="form-c" id="ProtocolName"></div>
																				<!--
																				<div class="form-c">
																					<select class="form-select" name="" id="ProtocolName" style="width: 140px;">
																						<option value="">请选择</option>
																					</select>
																				</div>
																				-->
																			</div>
																			<div class="form-item" style="width: 284px;margin-left: -5px;">
																				<span class="form-tag">
																					<em class="imp">*</em>端口：</span>
																				<div class="form-c">
																					<input type="text" class="form-text" id="Port" maxlength="5" onkeyup="port_check(this);" style="width:108px">
																				</div>
																			</div>

																			<div class="form-item" style="width: 284px;margin-left: -5px;">
																				<span class="form-tag">连接参数：</span>
																				<div class="form-c" id="ConnParamName"></div>
																				<!--
																				<div class="form-c">
																					<select class="form-select" name="" id="ConnParamName" style="width: 140px;">
																						<option value="">请选择</option>
																					</select>
																				</div>
																				-->
																			</div>
																		</div>
																	</div>

																	<div class="btns" style="margin-bottom:-20px;">
																		<a href="javascript:;" class="btn btn-normal btn-submit">确&nbsp;&nbsp;定</a>
																		<a href="javascript:;" class="btn btn-normal" onclick="clear_serverdata();">重&nbsp;&nbsp;置</a>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
												
												<div class="dialog-cont" id="protoDialog" style="display:none;">
													<div class="container">
														<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
															<div class="c-form c-form-host" style="padding: 0 0 90px;min-width:0px;">
																<div class="clearfix"></div>
																<div class="c-table">
																	<div class="form">
																		<div class="form-item" style="width: 300px;">
																			<span class="form-tag" style="width: 72px;"><em class="imp">*</em>名称：</span>
																			<div class="form-c" style="padding-left: 0;">
																				<input type="text" class="form-text" id="Protocol_Name0" maxlength="15" style="width: 195px;" tabindex="1">
																				<i class="v-check" style=""></i>
																				<p class="form-tip" style="width: 185px;margin-left: 66px;">特殊字符仅支持下划线、横杠</p>
																			</div>
																		</div>
																		<div class="form-item" style="width: 185px;">
																			<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口：</span>
																			<div class="form-c" style="padding-left: 0px;">
																				<input type="text" class="form-text" id="Port0" maxlength="5" style="width: 50px;" tabindex="1">
																				<i class="v-check" style=""></i>
																				<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
																			</div>
																		</div>
																		<div class="form-item" style="width: 185px;">
																			<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口1：</span>
																			<div class="form-c" style="padding-left: 0px;">
																				<input type="text" class="form-text" id="Port1" maxlength="5" style="width: 50px;" tabindex="1">
																				<i class="v-check" style=""></i>
																				<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
																			</div>
																		</div>
																		<div class="form-item" style="width: 250px;">
																			<span class="form-tag" style="width:85px;">描述：</span>
																			<div class="form-c" style="padding-left: 0px;">
																				<input type="text" class="form-text" id="Description0" maxlength="128" style="width:170px;" tabindex="1">
																			</div>
																		</div>
																	</div>
																	<!-- <div class="btns" style="padding: 10px 0 10px;">
																		<a href="javascript:;" class="btn btn-normal btn-submit" >保&nbsp;&nbsp;存</a>
																		<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
																	</div> -->
																</div>
															</div>
														</div>
													</div>
												</div>
												
												<div class="dialog-cont" id="connDialog" style="display:none;">
													<div class="container">
														<div class="c-cont" style="max-height:500px;">
															<div class="c-form" style="">
																<div class="form" style="padding-left:50px;">
																	<div class="form-item">
																		<span class="form-tag"><em class="imp">*</em>名称：</span>
																		<div class="form-c">
																			<input type="text" class="form-text" id="d_n_con" name="d_n_con" onblur="regCheck(this,nameReg);" maxlength="128">
																			<i class="v-check"></i>
																			<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
																		</div>
																	</div>
																	<div class="form-item">
																		<span class="form-tag"><em class="imp">*</em>协议类型：</span>
																		<div class="form-c">
																			<select class="form-select form-select2" name="Protocol_con" id="Protocol_con" style="width:150px;">
																				<option value="0" selected>请选择</option>
																			</select>
																		</div>
																		<span class="form-tag" id="Protocol_port"></span>
																	</div>
																	<!-- SSH -->
																	<div id="SSH" style="display:none;">
																		<div class="form-item">
																			<span class="form-tag">版本号：</span>
																			<div class="form-c">
																				<select class="form-select" name="ServiceName_ssh" id="ServiceName_ssh" style="width:150px;">
																					<option value="1" selected>1</option>
																					<option value="2" >2</option>
																				</select>
																			</div>
																		</div>
																	</div>
																	<!--HTTP-->
																	<div id="HTTP" style="display:none;">
																		<div class="form-item">
																			<span class="form-tag"><em class="imp">*</em>URL：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="url" name="url" maxlength="128" style="width:252px;padding-right:8px;">
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">账号：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="UserName" name="UserName" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">密码：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="UserPwd" name="UserPwd" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">提交元素：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="Submit" name="Submit" maxlength="128" style="width:252px;padding-right:8px;">
																			</div>
																		</div>
																	</div>
																	<!--HTTPs-->
																	<div id="HTTPs" style="display:none;">
																		<div class="form-item">
																			<span class="form-tag"><em class="imp">*</em>URL：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="httpsurl" name="httpsurl" maxlength="128" style="width:252px;padding-right:8px;">
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">账号：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="httpsUserName" name="httpsUserName" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">密码：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="httpsUserPwd" name="httpsUserPwd" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">提交元素：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="httpsSubmit" name="httpsSubmit" maxlength="128" style="width:252px;padding-right:8px;">
																			</div>
																		</div>
																	</div>
																	<!--ORACLE-->
																	<div id="ORACLE" style="display:none;">
																		<div class="form-item">
																			<span class="form-tag"><em class="imp">*</em>指定：</span>
																			<div class="form-c">
																				<select class="form-select" name="appoint" id="appoint" style="width:150px;">
																				<option value="0" text="请选择" selected>请选择</option>
																				<option value="SID" text="SID">SID</option>
																				<option value="SERVICE_NAME" text="SERVICE_NAME">SERVICE_NAME</option>
																			</select>
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag"><em class="imp">*</em>实例名或服务名：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="s_n" name="s_n" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">连接方式：</span>
																			<div class="form-c">
																				<select class="form-select" name="conn" id="conn" style="width:150px;">
																				<option value="0" text="未指定" selected>未指定</option>
																				<option value="NORMAL" text="NORMAL">NORMAL</option>
																				<option value="SYSDBA" text="SYSDBA">SYSDBA</option>
																				<option value="SYSOPER" text="SYSOPER">SYSOPER</option>
																			</select>
																			</div>
																		</div>
																	</div>
																	<!--RADMIN-->
																	<div id="RADMIN" style="display:none;">
																		<div class="form-item">
																			<span class="form-tag">认证方式：</span>
																			<div class="form-c">
																				<select class="form-select" name="authtype" id="authtype" style="width:150px;">
																				<option value="0" text="未指定" selected>未指定</option>
																				<option value="RADMIN" text="RADMIN">RADMIN</option>
																				<option value="Windows" text="Windows">Windows</option>
																			</select>
																			</div>
																		</div>
																	</div>
																	<!--MSSQL-->
																	<div id="MSSQL" style="display:none;">
																		<div class="form-item">
																			<span class="form-tag"><em class="imp">*</em>实例名：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="o_n" name="o_n" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																		<div class="form-item">
																			<span class="form-tag">认证方式：</span>
																			<div class="form-c">
																				<select class="form-select" name="R_authtype" id="R_authtype" style="width:150px;">
																				<option value="0" text="未指定" selected>未指定</option>
																				<option value="SQL服务器验证" text="SQL服务器验证" >SQL服务器验证</option>
																				<option value="Windows验证" text="Windows验证" >Windows验证</option>
																				<option value="Windows单一登录" text="Windows单一登录" >Windows单一登录</option>
																			</select>
																			</div>
																		</div>
																	</div>
																	<!--MYSQL &&　DB2-->
																	<div id="MY_DB2" style="display:none;">
																		<div class="form-item" style="min-height:40px;">
																			<span class="form-tag"><em class="imp">*</em>数据库名：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="sql_n" name="sql_n" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																	</div>
																	<div id="MY_ConnType" style="display:none;">
																		<div class="form-item" style="min-height:40px;">
																			<span class="form-tag"><em class="imp">*</em>版本号：</span>
																			<div class="form-c">
																				<select class="form-select" name="select_my" id="select_my" style="width:150px;">
																					<option value="0" text="0" selected>&lt;7.5</option>
																					<option value="1" text="1" >≥7.5</option>
																				</select>
																			</div>
																		</div>
																	</div>
																	<div id="DB2" style="display:none;">
																		<div class="form-item" style="min-height:40px;">
																			<span class="form-tag"><em class="imp">*</em>数据库名：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="dbsql_n" name="dbsql_n" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																	</div>
																	<!--SYBASE-->
																	<div id="SYBASE" style="display:none;">
																		<div class="form-item" style="min-height:40px;">
																			<span class="form-tag"><em class="imp">*</em>实例名：</span>
																			<div class="form-c">
																				<input type="text" class="form-text" id="sy_o_n" name="sy_o_n" maxlength="128" style="width:252px;padding-right:8px;">
																				<p class="form-tip">不能含有特殊字符</p>
																			</div>
																		</div>
																	</div>
																	<!---->
																</div>
															</div>
															<!-- <div class="c-form">
																<div class="btns">
																	<a href="javascript:;" class="btn btn-normal btn-submit">保&nbsp;&nbsp;存</a>
																	<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
																</div>
															</div> -->
														</div>
													</div>
												</div>
												
											</div>
										</div>
									</div>
									<div id="defined_info" style="">
										<div class="h-catelog h-catelog2 h-content2_temp" style="height: 350px; width:30%;background-color: #ffffff; padding: 0px;border-right: 1px solid #CCC;/*overflow:hidden;*/">
											<div class="c-col2 ss">

												<div>
													<span class="form-tag" style="float: none;">
														<em class="imp">*</em>账号：</span>
													
													<select name="" id="a_mix_select" class="filter-select" style="width: 80px;display:none;margin-left: 16px;" onchange="a_mix_change(this);">
														<option value="1">指定</option>
														<option value="2">所有</option>
													</select>
													
												</div>

												<div class="ss-cont" id="account" style="padding: 0;">
													<div class="h-content222" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
														<div class="c-table tab-type2" style="padding: 0;margin-top: 10px;">
															<table cellpadding="0" cellspacing="0" style="">
																<thead>
																	<tr>
																		<th width="50">
																			<input type="checkbox" class="form-checkbox" id="check_all_a" />
																		</th>
																		<th>账号</th>

																	</tr>
																</thead>
															</table>
														</div>
														<div class="c-table tab-type2" style="padding: 0;overflow:auto;">
															<table cellpadding="0" cellspacing="0" style="">
																<!--
																<thead>
																	<tr>
																		<th width="50">
																			<input type="checkbox" class="form-checkbox" id="check_all_a" />
																		</th>
																		<th>账号</th>

																	</tr>
																</thead>
																-->
																<tbody id="service_list_a" style="height:auto;">
																</tbody>
															</table>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="h-catelog h-catelog2 h-content2_temp" style="height: 350px; width:69.9%;background-color: #ffffff;padding: 0px; border-right: 0px;/*overflow:hidden;*/">
											<div class="c-col2 ss">
												<div>
													<span class="form-tag" style="float: none;">
														<em class="imp">*</em>服务：</span>
													<select name="" id="s_mix_select" class="filter-select" style="width: 80px;display:none;margin-left: 16px;" onchange="s_mix_change(this);">
														<option value="1">指定</option>
														<option value="2">所有</option>
													</select>
												</div>
												<div class="h-content222" style="height: auto;width: 100%;overflow: hidden;padding: 0px;" id="service_module">
													<div class="c-table tab-type2" style="padding: 0;margin-top: 10px;">
														<table cellpadding="0" cellspacing="0" style="">
															<thead>
																<tr>
																	<th width="50">
																		<input type="checkbox" class="form-checkbox" id="check_all" />
																	</th>
																	<th>协议</th>
																	<th>端口</th>
																	<th>连接参数</th>

																</tr>
															</thead>
														</table>
													</div>
													
													<div class="c-table tab-type2" style="padding: 0;overflow:auto;">
														<table cellpadding="0" cellspacing="0" style="">
															<!--
															<thead>
																<tr>
																	<th width="50">
																		<input type="checkbox" class="form-checkbox" id="check_all" />
																	</th>
																	<th>协议</th>
																	<th>端口</th>
																	<th>连接参数</th>

																</tr>
															</thead>
															-->
															<tbody id="service_list2" style="height:auto">
															</tbody>
														</table>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div id="pointSet2">
									<div class="h-content2 p-h-2" style="overflow:hidden;">
										<div class="h-top" style="background-color: #fff;    margin-top: -22px;">
											<div class="filter" style="float:right;min-width:auto;">
												<div id="waitTip" class="waitTip" style="float: right;margin-top: 7px;margin-left: -26px;"></div>
												<div class="search">
													<select name="server_select1" id="server_select1" class="filter-select">
														<option value="0" selected>所有</option>
														<option value="hgname">组名</option>
														<option value="hostname">主机名</option>
														<option value="ip">IP</option>
														<option value="hostservicename">服务名</option>
														<option value="accountname">账号</option>
													</select>
													<input type="text" class="filter-text" placeholder="输入关键字" 
													name="server_text" id="server_text1" maxlength="128" 
													style="border-left:0px;padding-right: 22px;"
													onchange="if($('#server_text1').val()==''){$('#server_text_check1').hide();}else{$('#server_text_check1').show();}"
													onkeyup="if($('#server_text1').val()==''){$('#server_text_check1').hide();}else{$('#server_text_check1').show();}"
													onkeydown="if($('#server_text1').val()==''){$('#server_text_check1').hide();}else{$('#server_text_check1').show();}if (event.keyCode == 13){_addFilter2(this,false);return false;} else return;" onblur="change_input(this);">
													<i class="v-check v-wrong" id="server_text_check1" 
													 onclick="_clear_keyword2(this)" 
													 style="display:none;cursor: pointer;float: left;position: static;"></i>
													<button class="btn filter-btn" onclick="_addFilter2(this,false)">
														<i class="add-filter"></i>
													</button>
													<button class="btn filter-btn" onclick="_addFilter2(this,true)">
														<i class="append-filter"></i>
													</button>
												</div>
												<div class="search" id="clearFilter2" style="margin: 0px 15px 0px -16px;display:none;">
													<button class="filter-btn" onclick="_clearFilter2(this)">
														<i class="clear-filter"></i>
													</button>
												</div>
												<div class="selector selector-multiple" id="filterWW2" style="display: none;width: 146px;">
													<span class="ww" style="width: 132px;">搜索条件</span>
													<ul style="padding-left: 0px;    width: 146px;"></ul>
												</div>
											</div>
										</div>
										<div style="overflow: auto;width:100%;height:94%;margin-top:10px;" id="hosttree_div1">
											<h2 style="margin-left: 30px;">
												<em class="imp">*</em>主机：</h2>
											<ul id="hostTree" class="hosttree"></ul>
										</div>
									</div>
								</div>

							</div>
						</div>

						<div class="clearfix"></div>
						<div class="btns">
							<a href="javascript:;" class="btn btn-normal" onclick="next(1);">上一步</a>
							<a href="javascript:;" class="btn btn-normal" onclick="next(3);">下一步</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="btns" id="pageBtns">
			<a href="javascript:;" class="btn btn-normal" onclick="_goStep(2,this)">下一步</a>
			<a href="javascript:;" class="btn btn-normal" onclick="_goStep(1,this)" style="display: none;">上一步</a>
			<a href="javascript:;" class="btn btn-normal" onclick="_submit();" style="display: none;">保&nbsp;&nbsp;存</a>
		</div>
		<div class="clearfix"></div>
		<div id="bBtn" style="position: fixed;z-index:5;">
			<a href="javascript:;" class="btn" style="float: right;" onclick="exit();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
		</div>
	</div>
	<form action="/bhost/batch_index" method="POST" name="frm_batchStart" id="frm_batchStart">
		<input type="hidden" name="tasktype" id = "tasktype" value="{{tasktype}}" />
		<input type="hidden" name="taskid" id = "taskid" value="{{TaskId}}" />
		<input type="hidden" name="paging" id = "paging" value="{{paging}}" />
		<input type="hidden" name="search_typeall" id = "search_typeall" value="{{search_typeall}}" />
		<input type="hidden" name="e" id = "e" value="{{e}}" />
		<input type="hidden" name="se" id = "se" value="{{se}}" />
		<input type="hidden" name="newid" id = "newid" value="{{NewId}}" />
	</form>
	<script>
		var userAgent = navigator.userAgent;
		var ie8 = userAgent.indexOf('Trident/4.0');

		if(ie8 != -1){
			document.write('<script src="/manage/js/jquery-IE8.js"></' + 'script>');
		}else{
			document.write('<script src="/manage/js/jquery.min.js"></' + 'script>');
		}
	</script>
	<script src="/manage/js/base64.js"></script>
	<!--ace editor-->
	<script src="/manage/js/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="/manage/js/my_scrollbar.js"></script>
	<script src="/manage/js/upload.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/common_e.js"></script>	
	<script src="/manage/js/layer.js"></script>
	<!--icheck-->
	<script src="/manage/js/icheck.min.js"></script>
	<!--select2-->
	<script src="/manage/js/select2.full.min.js"></script>
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<!-- xSelect -->
	<script src="/manage/js/xSelect.js"></script>
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<!-- dialog -->
	<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/G-style.css" type="text/css" />
	<style>
		.ui-dialog-body {
			padding: 20px 0;
			text-align: center;
		}
			.c-form-host span.ss {
			padding-left: 
		}	
		.h-content3 .item {
			width: auto;
			padding: 0 0 10px 0;
		}
		.h-content3.sel-type1{
			padding:0px;
		}
		.select2-container .select2-selection--single {
			height: 28px;
			line-height: 26px;
		}
		.select2-container--default .select2-selection--single .select2-selection__rendered {
			line-height: 26px;
		}
		.filter .selector.selector-multiple:after {
			content: '';
			display: block;
			border-color: #888 transparent transparent transparent;
			border-style: solid;
			border-width: 5px 4px 0 4px;
			height: 0;
			width: 0px;
			overflow: hidden;
			position: absolute;
			margin: 11px 0 0 9.3em;
		}
		.h-content22 .form-item-100 .btn {
			display: inline-block;
			width: 90px;
			height: 32px;
			border: 1px solid #DDD;
			text-align: center;
			line-height: 32px;
			border-radius: 18px;
			margin: 0 10px;
			background-color: #fff;
			transition: background-color 0.4s;
			color: #7c7c7c;
		}

		.h-content22 .form-item-100 .btn:hover {
			background-color: #8d808a;
			color: #fff;
		}
		.select2-container--open {
			z-index: 9999999;
		}

		.labels2 label {
			width: 170px;
		}

		.filter .search .filter-text {
			border-left: 0px;
		}

		.filter .search .server_text {
			border-left: 1px solid #ccc;
		}

		.set-type .input-group {
			float: left;
			width: 90px;
			height: 26px;
			overflow: hidden;
			border: 1px solid #acacac;
			border-radius: 3px;
			text-align: center;
			/*border-radius: 5px;*/
		}

		.form-text2 {
			padding: 0 8px;
		}

		.btns {
			background-color: rgba(255, 255, 255, 1);
		}
		#ReContent {
			height: 26px;
			border: 1px solid #b2b2b2;
			border-radius: 5px;
			padding: 0 4px;
			color: black;
			font-size: 12px;
		}
		.v-check {
			margin: 7px 0px 0px -25px;
		}
	</style>	
	<script>
		var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
		var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
		if (userAgent.indexOf("Firefox") > -1) {
			$("#ReContent").css("margin","2px 10px 0 0")
		} //判断是否Firefox浏览器
		if (userAgent.indexOf("Chrome") > -1){
			;
		}	
		if (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera) {
			$("#ReContent").css("margin","2px 10px 0 0")
		}; //判断是否IE浏览器
		
		ie11 = (function() { return ("ActiveXObject" in window) })(); 
		if (!!window.ActiveXObject || "ActiveXObject" in window) {//判断是否IE浏览器
			$("#ReContent").css("margin","2px 10px 0 0")
		}; 
		$('.execItems input[type=checkbox],.execItems input[type=radio]').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
		$('.proItems input[type=checkbox],.proItems input[type=radio]').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
		$('#typeSet').select2({ minimumResultsForSearch: -1 });
		$('.proItems .select2').select2({minimumResultsForSearch: -1,tags: true});
		$('.filter-select,.select2,.type-select').select2({ minimumResultsForSearch: -1 });
		$('.form-select').select2({ minimumResultsForSearch: -1 });		
		$('.execItems .select2').select2({minimumResultsForSearch: -1,tags: true});
	</script>

	<!--jedate-->
	<script src="/manage/js/jquery.jedate.min.js"></script>
	<link rel="stylesheet" href="/manage/css/jedate.css">
	<script>
	var editor;
	var TID;
	var SUP_PROTOCOL;
	var IP_ADDR;
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var loginusercode = window.parent.document.frm.us.value;
	var HideIP;
	var editid;
	$(function(){
		if(IEVersion() == 8){
			loadStyle('/manage/css/ie-css.css');
		}
		//get_AccessScope();
		if({{NewId}} == 0){
			editid = {{TaskId}};
		}else{
			editid = 0;
		}
		//用于数据库保存权限
		$.ajax({
			url:'/bhost/Get_AuthObjectByLevel',
			type:'post',
			async:true,
			cache:false,
			data:{a0:se,z1:-1},
			success:function(result){
			}
		})
		get_ip();
		Get_GlobalStrategy();
		get_account();
		get_server();
		if(ie8 == -1){
			editor = ace.edit("viewCont");
			editor.setTheme("ace/theme/clouds");
			editor.session.setMode("ace/mode/sh");
		}else{
			$('#viewCont').html('<textarea id="editor" style="padding:10px;line-height:1.2;"></textarea>');
			editor = {
				item: $('#editor'),
				getValue: function(){
					return this.item.val();
				},
				setValue: function(v,i){
					this.item.val(v);
				}
			}
		}
		_initSize();
		_listEvent();
		$('#execCheck').on('ifChecked',function(){
			var $t = $(this).parents('label').prev();
			$('input',$t).prop('disabled',true);
			$('#ReContent').prop('disabled',true);
			$('#ReType').prop('disabled',true);
			$("#timeTemp").children().css('background','#ebebe4');
		}).on('ifUnchecked',function(){
			var $t = $(this).parents('label').prev();
			$('input',$t).prop('disabled',false);	
			$('#ReContent').prop('disabled',false);
			$('#ReType').prop('disabled',false);
			$("#timeTemp").children().css('background','#ffffff');
		})		
		if({{NewId}} == 0){
			TID = {{TaskId}};
			
			getBStartTaskMsg();
			getBStartFile();
		}else{
			TID = {{NewId}};
		}
		// $("#PType").on('change',function(){
		// 	if($("#PType").val() == 2){
		// 		$("#SSHobj").show();
		// 	}else{
		// 		$("#SSHobj").hide();
		// 	}
		// })
		var date = new Date();
		var setDate = {
			year: date.getFullYear(),
			month: date.getMonth() + 1,
			day: date.getDate()
		}

		setDate = setDate.year + '-' + setDate.month + '-' + setDate.day;		
		$('input.datepicker').each(function(){
			$(this).jeDate({
				format:"YYYY-MM-DD",
				isTime:false,
				minDate:setDate
			});
		});
		if({{NewId}} != 0){
			var year = date.getFullYear();
			var month = ("0" + (date.getMonth() + 1)).slice(-2);
			var day = ("0" + date.getDate()).slice(-2);
			var hour = ("0" + (date.getHours())).slice(-2);
			var second = ("0" + (date.getSeconds())).slice(-2);
			var minute = ("0" + (date.getMinutes())).slice(-2);
			$("#StartDate").val(year + '-' + month + '-' + day);
			$("#StartHour").val(hour);
			$("#StartMin").val(minute);
			$("#StartSec").val(second);
		}
		$("#ReType").on('change',function(){
			if($("#ReType").val() == 1){
				$("#ReType").siblings('input').attr('onkeyup','dataCheck(this, 0, 360);');
			}else{
				$("#ReType").siblings('input').attr('onkeyup','dataCheck(this, 0, 1440);')
			}
			$("#ReContent").val('0');
		})
		$.each(window.parent._power,function(i,item){
				manage_auth_array.push(item.SubMenuId);
		});
	});

	$(window).resize(function(){
		_initSize();
	});

	function get_ip() {
		$.ajax({
			url:'/bhost/GetIPAddr',
			type:'post',
			async:false,
			cache:false,
			data:{a0:se},
			success:function(result){
				var results = JSON.parse(result);
				IP_ADDR = results.info;
			}
		})
	}

	function Get_GlobalStrategy(){
		$.ajax({
			url:'/bhost/get_globalstrategy',
			type:"POST",
			async:true,
			data:{a0:se},
			success: function(Result){
				GStrategy = JSON.parse(Result);
				HideIP = GStrategy.IfHiddenHostIP
			} 
		})
	}

	function exit(){
		document.frm_batchStart.tasktype.value = 3;
		document.frm_batchStart.submit();
	}

	function getBStartFile(){
		$.ajax({
			url:'/bhost/GetBstartFileList',
			type:'post',
			async:false,
			cache:false,
			data:{a0:se,a1:TID},
			success:function(result){
				var results = JSON.parse(result);
				if(results.Result == true){
					var file_array = results.Files.split(',');
					if(file_array.length == 0){
						return false;
					}
					/*
					$.each(file_array,function(i,item){
						if(item != ""){
							//console.log(TaskFiles);
						}
					})
					*/
				}else{
					_alert(1, '批量执行', '获取文件失败：'+results.ErrMsg);
				}
			}
		})
	}

	function _initSize(){
		var h = $('body').height();
		var h1 = $("#server_frame").width() - 145;
		$('#execCont').height(h - 332);
		$('div.execSH').height(h - 332 - 46);
		$("#ip_n").width(h1);
		var j = $('#cont1').height();
		$('#cont1').height(j + 20);
	}

	function _goStep(i,obj){
		if($(obj).hasClass('active')){
			return;
		}

		var $snav = $('div.secnav1>ul>li');
		var $c = $('#contWrap>div.c-cont');
		var $b = $('#pageBtns>a.btn');

		if(i == 1){//第一页
			$snav.eq(0).addClass('active').siblings('li').removeClass('active');
			$c.eq(0).show().siblings('div.c-cont').hide();
			$b.eq(0).show().siblings('a.btn').hide();
		}else{//第二页
			if (!nameReg.test($("#TaskName").val())) {
				_alert(1,'批量执行','名称格式不正确');
				return false;
			}

			if($("#execCheck").prop('checked') == false){
				var Date_s = $("#StartDate").val();
				var Hour_s = $("#StartHour").val();
				var Min_s = $("#StartMin").val();
				var Sec_s = $("#StartSec").val();
				if(Date_s == "" && Hour_s == "" && Min_s == "" && Sec_s == ""){
					_alert(1, '批量执行', '任务开始时间不能为空');
					return false;
				}
				if(Date_s == "" || Hour_s == "" || Min_s == "" || Sec_s == ""){
					_alert(1, '批量执行', '任务开始时间格式不正确');
					return false;
				}
				var StartTime = $("#StartDate").val() + " " + $("#StartHour").val() + ":" + $("#StartMin").val() + ":" + $("#StartSec").val();
				//用当前时间给年、月、日文本框赋值
				var date = new Date();		//获取当前时间
				var year = date.getFullYear();
				var month = ("0" + (date.getMonth() + 1)).slice(-2);
				var day = ("0" + date.getDate()).slice(-2);
				var hour = ("0" + (date.getHours())).slice(-2);
				var second = ("0" + (date.getSeconds())).slice(-2);
				var minute = ("0" + (date.getMinutes())).slice(-2);

				// if(StartTime<(year+'-'+month+'-'+day+' '+hour+':'+minute+':'+second)){
				// 	_alert(2,'批量执行','开始时间不能小于当前时间');
				// 	return false;
				// }
			}		
			//$("#PType").val(): 1-->文件  2、3->命令
			if($("#PType").val() == 1){
				if($('#execList').find('li.active').length == 0){
					_alert(1, '批量执行', '请选择指令文件');
					return false;
				}
				SUP_PROTOCOL = ['RDP','TELNET','RLOGIN','SSH'];
			}else if($("#PType").val() != 1){
				if($.trim( editor.getValue())== ""){
					_alert(1, '批量执行', '请输入指令');
					return false;
				}
				if($("#PType").val() == 2){
					SUP_PROTOCOL = ['MYSQL'];
				}else if($("#PType").val() == 3){
					SUP_PROTOCOL = ['ORACLE'];
				}
			}
			_initSize();
			$snav.eq(1).addClass('active').siblings('li').removeClass('active');
			$c.eq(1).show().siblings('div.c-cont').hide();
			$b.eq(1).show();
			$b.eq(2).show();
			$b.eq(0).hide();
			if(TYPE != $("#PType").val() || TYPE == null){
				TYPE = $("#PType").val();
				//范围选定
				_initList();
				$("#hostTree").empty();
				get_hostdirectory(0, TID, TYPE);
				_viewHTML(h_data, '#hostTree', 0);
				$('#hostTree').on('change', 'span.authtype input', function () {
					var checked = $(this).prop('checked');
					_authTypeTheme($(this));
					if (checked) {
						var $input1 = $(this).parent().parent().siblings('ul').find('span.authtype input');
						var $input2 = $(this).parent().parent().siblings('ul').find('input.zcheck');
						var $input3 = $(this).parent().parent().siblings('input.zcheck');
						$input2.attr("data-loadlast", 2);
						$input3.attr("data-loadlast", 2);
						$(this).attr('data-ifselect', true);
						$input1.prop('disabled', true);
						_authTypeTheme($input1);
						$input2.prop('checked', true).prop('disabled', true);
						$(this).parent().parent().siblings('input.zcheck').prop('checked', true).next('span.checkbox').attr('class', 'checkbox checked');
						$.each($input2, function () {
							$(this).next('span.checkbox').attr('class', 'checkbox checked disabled');
						});
						_checkEvent($(this).parent().parent().siblings('input.zcheck'));
					} else {
						var $input1 = $(this).parent().parent().siblings('ul').children('li').find('span.authtype').find('input');
						var $input2 = $(this).parent().parent().siblings('ul').children('li').find('input.zcheck');
						$(this).attr('data-ifselect', false);
						$input1.prop('disabled', false);

						_checkEvent1($(this));
						authtype_click = 1;
					}
				});
				if({{NewId}} == 0){
					//1-按目标，指定账号；2-范围，共有账号；3-范围，所有账号；4-范围，自定义
					if (TaskResult.AuthMode == 2 || TaskResult.AuthMode == 3) {
						$("#typeSet").val(2).trigger('change');
						if (TaskResult.AuthMode == 3) {
							all_flag = 1;
						} else {
							$("#mix_select").val(2).trigger('change');
							all_flag = 0;
						}
						// $.each(TaskResult.AuthScope, function (i, item) {
							// $("#ips").data('value',item.ServerScopeId);
							// $("#ips").find('span').text(item.ServerScopeName);
							// server_id = item.ServerScopeId;
							// if (i != TaskResult.AuthScope.length-1){
							// var $c = $('<div style="width:214px;margin-top: -10px;" class="item" id="' + item.ServerScopeId + '"/>');
							// if (serverid_list.indexOf(item.ServerScopeId) === -1) {
							// 	serverid_list.push(item.ServerScopeId);
							// }
							// $c.html('<input style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;width: 144px;padding: 0 8px;" typr="text" class="form-text" disabled="true" value="' + item.ServerScopeName + '"><i class="ctrl del" onclick="_del_scope(this,3)"></i>');
							// 	$("#ips").parent().after($c);
							// 	$("#ips").find('span').text('请选择');
							// }
						// });
						for (var i = 0; i < TaskResult.AuthScope[0].IPList.Set.length - 1; i++) {
							var $c = $('<span class="ss" value="' + TaskResult.AuthScope[0].IPList.Set[i].IPSetMemberId + '" style="float: left;width: 312px;position: static;padding: 0 7px 10px 0;"/>');
							$c.html('<input type="text" class="form-text form-text2" value="' + TaskResult.AuthScope[0].IPList.Set[i].StartIP + '"  style="width:122px;" disabled>'
								+ '<span style="vertical-align:middle;padding-left: 4px;padding-right: 4px;">-</span>'
								+ '<input type="text" class="form-text form-text2" value="' + TaskResult.AuthScope[0].IPList.Set[i].EndIP + '"  style="width:122px;" disabled>'
								+ '<i class="ctr ctr-del" style="margin-top: 5px;margin-left: -3px;" onclick="_delIp(this)"></i>');
							$("#ip_n").find("span[class='ss ss-add']").after($c);
						}
						if (TaskResult.AuthScope[0].IPList.Set.length != 0) {
							$('#ip_n').find("span[class='ss ss-add']").attr('value', TaskResult.AuthScope[0].IPList.Set[i].IPSetMemberId);
							var $ip_input = $('#ip_n').find("span[class='ss ss-add']").find('input');
							$ip_input.first().val(TaskResult.AuthScope[0].IPList.Set[i].StartIP);
							$ip_input.last().val(TaskResult.AuthScope[0].IPList.Set[i].EndIP);
						}
						if (TaskResult.AuthAccountId == '*'){
							$("#a_mix_select").val('2').trigger('change');
						}else{
							if (TaskResult.AuthAccountId != "" && TaskResult.AuthAccountId != null) {
								accountid = TaskResult.AuthAccountId.split(',');
							}
						}
						
						if (TaskResult.AuthService == '*'){
							$("#s_mix_select").val('2').trigger('change');
						}else{
							if (TaskResult.AuthService == null) {
								$.each(TaskResult.AuthServiceSet, function (i, item) {
									var id = item.ProtocolId + '-' + item.ConnParamId + '-' + item.Port;
									AuthServiceSet.push(id);
								})
							} else {
								$("#-1").iCheck('check');
								AuthServiceSet.push('-1');
							}
						}
						add_server();
					} else if (TaskResult.AuthMode == 4) { //范围自定义
						//bind_server_xSelect();
						$("#typeSet").val(2).trigger('change');
						$("#define_select").val(2).trigger('change');
						bind_protocol_select();
						bind_conn_select();
						// $.each(TaskResult.AuthScope, function (i, item) {
						// 	//$("#ips").val(item.ServerScopeName);
						// 	$("#ips").find('span').text(item.ServerScopeName);
						// 	$("#ips").data('value',item.ServerScopeId);
						// 	server_id = item.ServerScopeId;
						// 	if (i != TaskResult.AuthScope.length-1){
						// 		var $c = $('<div style="width:214px;margin-top: -10px;" class="item" id="' + item.ServerScopeId + '"/>');
						// 		if (serverid_list.indexOf(item.ServerScopeId) === -1) {
						// 			serverid_list.push(item.ServerScopeId);
						// 		}
						// 		$c.html('<input style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;width: 144px;padding: 0 8px;" typr="text" class="form-text" disabled="true" value="' + item.ServerScopeName + '"><i class="ctrl del" onclick="_del_scope(this,3);"></i>');
						// 		$("#ips").parent().after($c);
						// 		$("#ips").find('span').val('请选择');
						// 	}
						// });
						for (var i = 0; i < TaskResult.AuthScope[0].IPList.Set.length - 1; i++) {
							var $c = $('<span class="ss" value="' + TaskResult.AuthScope[0].IPList.Set[i].IPSetMemberId + '" style="float: left;width: 312px;position: static;padding: 0 7px 10px 0;"/>');
							$c.html('<input type="text" class="form-text form-text2" value="' + TaskResult.AuthScope[0].IPList.Set[i].StartIP + '"  style="width:122px;" disabled>'
								+ '<span style="vertical-align:middle;padding-left: 4px;padding-right: 4px;">-</span>'
								+ '<input type="text" class="form-text form-text2" value="' + TaskResult.AuthScope[0].IPList.Set[i].EndIP + '"  style="width:122px;" disabled>'
								+ '<i class="ctr ctr-del" style="margin-top: 5px;margin-left: -3px;" onclick="_delIp(this)"></i>');
							$("#ip_n").find("span[class='ss ss-add']").after($c);
						}
						if (TaskResult.AuthScope[0].IPList.Set.length != 0) {
							$('#ip_n').find("span[class='ss ss-add']").attr('value', TaskResult.AuthScope[0].IPList.Set[i].IPSetMemberId);
							var $ip_input = $('#ip_n').find("span[class='ss ss-add']").find('input');
							$ip_input.first().val(TaskResult.AuthScope[0].IPList.Set[i].StartIP);
							$ip_input.last().val(TaskResult.AuthScope[0].IPList.Set[i].EndIP);
						}
						var account_arry_temp = TaskResult.AuthAccountId.split(',');
						$.each(account_arry_temp, function (i, item) {
							$("#account_select").val(item).trigger('change');
							if (i != account_arry_temp.length - 1) {
								$("#account_select").parent().find('i.add').click();
							}	
						})
						bind_protocol_select();
						bind_conn_select();
						$.each(TaskResult.AuthServiceSet, function (i, item) {
							$("#ProtocolName").data('value',item.ProtocolId);
							$("#ProtocolName").find('span').text(item.ProtocolName);
							$("#Port").val(item.Port);
							if (item.ConnParamId != null) {
								$("#ConnParamName").data('value',item.ConnParamId);
								$("#ConnParamName").find('span').text(item.ConnParamName);
							}
							_addServer('add');
						})
					} else {//对象指定
						TaskResult.AuthAccountName = null;
						TaskResult.AuthAccountId = '';
						$("#typeSet").val(1).trigger('change');
					}
				}
			}
		}
	}

	function _listEvent(){
		$('#execList').on('change','input',function(){
			var $li = $(this).parent().parent();
			var v = $(this).prop('checked');
			if(v){
				$li.addClass('active').siblings().removeClass('active');
				var filename = $.trim( $li.find('span.name').text());
				$('#execFilename').val(filename);
			}			
			$.ajax({
				url:'/bhost/ReadBstartFile',
				type:'post',
				async:false,
				cache:false,
				data:{a0:se,a1:TID,a2:filename},
				success:function(result){
					var results = JSON.parse(result.replace(/\n/g,"\\\\n").replace(/\r/g,"\\\\r").replace(/\t/g,"\\\\t"));
					if(results.Result == true){
						var fileContent = results.Content.replace(/\\n/g,"\r\n").replace(/\\r/g,"").replace(/\\t/g,"	").replace(/\\"/g,'"');
						editor.setValue(fileContent,-1);
						var content = editor.getValue();
					}else{
						_alert(1, '批量执行', '读取文件失败：'+results.ErrMsg);
						$('#execFilename').val("");
						$li.removeClass('active');
						v = $(this).prop('check');
					}
				}
			})
		});
	}

	function _delItem(obj){
		layer.open({
			type: 1,
			title: '删除确认',
			content: '<div class="layer-alert"><i class="alert warning"></i>是否删除？</div>',
			btn: ['确定', '取消'],
			btnAlign: 'c',
			area: ['380px','310px'],
			yes: function(i) {
				var filename = $(obj).parent().find('span.name').text();
				$.ajax({
					url:'/bhost/DeleteBstartFile',
					type:'post',
					async:false,
					cache:false,
					data:{a0:se,a1:TID,a2:filename},
					success:function(result){
						var results = JSON.parse(result);
						if(results.Result == true){
							var $_p = $(obj).parent();
							if($_p.prop('class') == 'active'){
								editor.setValue("",-1);
								$("#execFilename").val("");
							}
							$_p.fadeOut(function(){
								$_p.remove();
							});
						}else{
							_alert(1, '批量执行', '删除失败：'+results.ErrMsg);
						}
					}
				})
				layer.close(i);
			},
			skin:'layer-custom'
		});
	}

	function _getFile(obj){
		var path=$(obj).val();
		path = path.split("\\");
		var b = path[path.length-1];
		$('#file_v').val(b);

		if(path == ""){
			return;
		}
		var data={};
		data.a0=window.parent.document.frm.se.value;
		if ({{NewId}} == 0){
			data.a1={{TaskId}};
		}else{
			data.a1={{NewId}};
		}

		$(obj).upload({
			url: '/bhost/ImportBstartFile',  // 后台需提供相应上传文件的接口
			// 其他表单数据
			type:'POST',
			dataType:'json',
			params: data,  // 后台需要接收的参数
			async: false,
			cache: false,
			contentType: false,
			processData: false,
			// 上传完成后, 返回json, text
			dataType: 'json',
			onSend: function (obj, str) {
				return true;
			},
			// 上传之后回调
			onComplate: function (data) {
				// 这里可以看到上传成功之后相应的信息，也可以在这里进行操作
				$('#execList>ul').append('<li><label><input type="radio" name="elist" id=""><span class="check"></span><span class="name">'+b+'</span></label><a href="javascript:;" class="del" onclick="_delItem(this)"><i></i></a></li>');
				$('#file_v').val("");
				$('#file_change').val("");
			},
			onProgress: function (e) {
				var per = Math.round(e.loaded * 100 / e.total);
			} 
		});
		$(obj).upload("ajaxSubmit");
	}

	function _saveFilename(obj){
		var v =  $.trim( $('#execFilename').val());//文件名称 

		if(!v || v == ''){
			_alert(1, '批量执行', '文件名不能为空');
			return;
		}

		var filename = $.trim( $("#execList").find('li.active').find('span.name').text());	
		var FileContent,NewFileName;
		FileContent = editor.getValue();//文件内容
		NewFileName = $("#execFilename").val();
		if(filename == ""){
			$.ajax({
				url:'/bhost/CreateBstartFile',
				type:'post',
				async:false,
				cache:false,
				data:{a0:se,a1:TID,a2:NewFileName,a3:FileContent,a4:NewFileName},
				success:function(result){
					var results = JSON.parse(result);
					if(results.Result == true){
						$('#execList>ul').append('<li class="active"><label><input type="radio" name="elist" id=""><span class="check"></span><span class="name">'+NewFileName+'</span></label><a href="javascript:;" class="del" onclick="_delItem(this)"><i></i></a></li>');
						$("#execList").find('li.active').find('input').iCheck('check');
					}else{
						_alert(1, '批量执行', '保存指令文件失败：'+results.ErrMsg);
					}
				}
			})
		}else{
			$.ajax({
				url:'/bhost/SaveBstartFile',
				type:'post',
				async:false,
				cache:false,
				data:{a0:se,a1:TID,a2:filename,a3:FileContent,a4:NewFileName},
				success:function(result){
					var results = JSON.parse(result);
					if(results.Result == true){
						var $li = $('#execList').find('li.active');
						$li.find('span.name').text(v);
						_alert(0, '批量执行', '保存成功');
					}else{
						_alert(1, '批量执行', '保存指令文件失败：'+results.ErrMsg);
					}
				}
			})
		}
	}

	var TaskResult;
	var TaskFiles = [];
	function getBStartTaskMsg(){
		var json_TaskMsg = {
			"LoginUserCode": window.parent.document.frm.us.value,
			"BatchPlanId": editid
		}
		_showLoading();
		$.ajax({
			url:'/bhost/GetBatchStart_list',
			type:'post',
			async:true,
			cache:false,
			data:{a0:se,a1:JSON.stringify(json_TaskMsg)},
			success:function(result){
				_closeLoading();
				TaskResult = JSON.parse(result);
				TaskResult = TaskResult.info.data[0];
				$("#TaskName").val(TaskResult.BatchPlanName);
				$("#PType").val(TaskResult.BatchType).trigger('change');
				// if($("#PType").val() == 2){
				// 	$("#SSHobj").show();
				// }else{
				// 	$("#SSHobj").hide();
				// }
				$("#PType").attr('disabled','true');
				if(TaskResult.BatchType != 1){
					editor.setValue(TaskResult.BatchWork,-1);
				}else{
					var FileName_tmp = TaskResult.BatchWork.split(';')[0];
					TaskFiles = TaskResult.BatchWork.split(';');
					$.each(TaskFiles,function(i,item){
						//item_temp = autoAddEllipsis(item,20);
						item_temp = item;
						$h = "<li><label><input type=\"radio\" name=\"elist\"><span class=\"check\"></span><span class=\"name\" title="+item+">"+item_temp+"</span></label><a href=\"javascript:;\" class=\"del\" onclick=\"_delItem(this)\"><i></i></a></li>";
						$("#execList").children('ul').append($h);
						if(i == 1){
							$("#execList").children().children(':first').find('input').click();
						}
					})					
					$.each($("#execList").find('.name'),function(i,item){
						if($(item).text() == FileName_tmp){
							$(item).prev().prev().click();
						}
					})
				}
				last_object = TaskResult.AuthObject == null ? [] : TaskResult.AuthObject;
				if(TaskResult.SSHOpened == true){
					$("#SSHOpened").iCheck('check');
				}else{
					$("#SSHOpened").iCheck('uncheck');
				}
				$("#Remark").val(TaskResult.Memo);
				if(TaskResult.Execution == true){
					$("#execCheck").iCheck('check');
					$('#timeTemp input').prop('disabled',true);
					$('#ReContent').prop('disabled',true);
					$('#ReType').prop('disabled',true);
				}else{
					var d, h, m, s;
					d = TaskResult.StartTime.split(" ")[0];
					h = TaskResult.StartTime.split(" ")[1].split(":")[0];
					m = TaskResult.StartTime.split(" ")[1].split(":")[1];
					s = TaskResult.StartTime.split(" ")[1].split(":")[2];
					$("#StartDate").val(d);
					$("#StartHour").val(h);
					$("#StartMin").val(m);
					$("#StartSec").val(s);
					$("#execCheck").iCheck('uncheck');
					$("#ReContent").val(TaskResult.PeriodValue);
					$("#ReType").val(TaskResult.PeriodType).trigger('change');
				}
			}
		})
	}
</script>
<script>
//范围选定
//
//
var se = window.parent.document.frm.se.value;
var usercode = window.parent.document.frm.us.value;
var accountid = [];
var h_data = "";
var TYPE = null;
function _typeSet(obj) {
	var i = $(obj).val();//2:范围指定，1:个别指定

	if (i == 1) {
		$('#pointSet2').show();
		$('#pointSet1').hide();
	} else if (i == 2) {
		$('#check_all_a,#check_all').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
		$('#pointSet2').hide();
		$('#pointSet1').show();
		bind_server_xSelect();
		_initSize();
	}
}

var push_hgid = [];
var push_hid = [];
var push_hid_len = 0;
var TID = 0;
var type_json = {
	"Type":3,
}
//获取host
function get_hostdirectory(id,TID,type){
	$.ajax({
		url:'/bhost/GetAuthObject_B',
		type:'post',
		async:false,
		cache:false,
		data:{a0:se,a1:id,a3:false,a4:type,a6:JSON.stringify(type_json)},
		success:function(result){
			h_data = JSON.parse(result);
			if(h_data.Result == false){
				_alert(1,"批量执行",h_data.ErrMsg);
			}
			if(editid > 0 ){
				$(h_data.data.HGroup).each(function(i,item){
					if(push_hgid.indexOf(item.HGId) <0){
						push_hgid.push(item.HGId + ":false");
					}
				})
			}
		}
	})	
}

//获取服务器范围内容
var ajax_flag1 = false;
function add_server() {
	if ($("#a_mix_select").val() == 2 && $("#s_mix_select").val() == 2){//所有
		return false;
	}
	//--1.系统批处理，2.MYSQL，3.ORACLE
	var auth_json = {
		"BatchType": "",
		"IPAddr": []
	};
	var add = 0;
	$("#service_list_a,#protocol,#param,#service_list2").empty();
	$("#check_all_a").iCheck('uncheck');
	$("#check_all").iCheck('uncheck');
	auth_json.BatchType = $("#PType").val();
	$.each($("#ip_n").find(".ss"),function(i,item){
		if($(item).attr("id") == "ip_span"){
			if($("#input1").val() == "" || $("#input2").val() == ""){
				return true;
			}
		}
		var tmp_a = {"StartIP": "192.168.1.1","EndIP": "192.168.1.255"};
		tmp_a.StartIP = $(item).find("input").eq(0).val();
		tmp_a.EndIP = $(item).find("input").eq(1).val();
		auth_json.IPAddr.push(tmp_a)
		add = 1;
	})
	// if ($("#ips").data('value') != undefined && $("#ips").data('value') != '-1'){
		// var serverset = '{"ServerScopeId":' + $("#ips").data('value') + '}';
		// serverset = JSON.parse(serverset);
		// auth_json.ServerScopeSet.push(serverset);
		// add = 1;
	// }
	// $("#server_frame_list").children('div:not(:first)').each(function (i, item) {
		// var id = $(item).attr('id');
		// var serverset = '{"ServerScopeId":' + id + '}';
		// serverset = JSON.parse(serverset);
		// auth_json.ServerScopeSet.push(serverset);
		// add = 1;
	// });
	if (add == 1) {
		var accountid_temp = [];
		var ConnParamName = "";
		var set;
		var AuthServiceSet_temp = [];
		var apdata;

		//获取所有的账号和服务
		if (all_flag == 1) {
			ajax_flag1 = false;
			$.ajax({
				url: '/bhost/get_AccountProtocolForAuth_B',
				type: 'post',
				async: false,
				data: { a0: se, z1: JSON.stringify(auth_json) },
				success: function (result) {
					apdata = JSON.parse(result);
					ajax_flag1 = true;
				}
			});
		} else {
			ajax_flag1 = false;
			$.ajax({
				url: '/bhost/Get_SameAccountProtocolForAuth_B',
				type: 'post',
				async: false,
				data: { a0: se, z1: JSON.stringify(auth_json) },
				success: function (result) {
					if (result == "None") {
						add = 0;
					} else {
						apdata = JSON.parse(result);
					}
					ajax_flag1 = true;
				}
			})
		}
		if (add == 0) {
			return false;
		}
		if ($("#a_mix_select").val() != 2){
			var account_table = "";
			$.each(apdata.AccountSet, function (i, item) {
				if (accountid_temp.indexOf(item.AccountId) === -1) {
					accountid_temp.push(item.AccountId);
					/*
					if (item.AccountId == 5){
						return true;
					}
					*/
					account_table = account_table + '<tr><td width="50"><input type="checkbox" class="form-checkbox" id="ai' + item.AccountId + '"/></td><td>' + item.AccountName + '</td></tr>';
				}
			});
			$("#service_list_a").append(account_table);
		}
		if ($("#s_mix_select").val() != 2){
			var service_table = "";
			$.each(apdata.ServiceSet, function (i, item) {
				if (item.ConnParamName == null) {
					ConnParamName = "";
				} else {
					ConnParamName = item.ConnParamName;
				}
				set = item.ProtocolId + '-' + item.ConnParamId + '-' + item.Port;
				AuthServiceSet_temp.push(set);
				service_table = service_table + "<tr><td width=\"50\"><input type=\"checkbox\" class=\"form-checkbox\" id=\"" + item.ProtocolId + "-" + item.ConnParamId + "-" + item.Port + "\"/></td><td>" + item.ProtocolName + "</td><td>" + item.Port + "</td><td>" + ConnParamName + "</td></tr>";
			});
			$("#service_list2").append(service_table);
		}
		_change_app();
		
		var isexist = 0;
		var A_C_TEMP = accountid.slice(0);
		$.each(A_C_TEMP, function (i, item) {
			$.each(accountid_temp, function (i1, item1) {
				if (item1 == item) {
					isexist = 1;
					return false;
				} else {
					isexist = 0;
				}
			});
			if (isexist == 1) {
				return true;
			} else {
				accountid.splice($.inArray(item, accountid), 1);
			}
		});
		var A_S_TEMP = AuthServiceSet.slice(0);
		$.each(A_S_TEMP, function (i, item) {
			$.each(AuthServiceSet_temp, function (i1, item1) {
				if (item1 == item) {
					isexist = 1;
					return false;
				} else {
					isexist = 0;
				}
			});
			if (isexist == 1) {
				return true;
			} else {
				//if (item != '-1') {
					AuthServiceSet.splice($.inArray(item, AuthServiceSet), 1);
				//}
			}
		});
	} else {
		accountid = [];
		AuthServiceSet = [];
	}
	if ($("#defined_info").is(':visible') && $("#a_mix_select").val() == 1){
		var de_h = $("#defined_info").children(".h-catelog.h-catelog2.h-content2_temp:eq(0)").height();
		$("#service_list_a").parents('.c-table.tab-type2').css('max-height',de_h-109);
	}
	if ($("#defined_info").is(':visible') && $("#s_mix_select").val() == 1){
		var de_h = $("#defined_info").children(".h-catelog.h-catelog2.h-content2_temp:eq(1)").height();
		$("#service_list2").parents('.c-table.tab-type2').css('max-height',de_h-109);
	}
}
var s_index_all = [];
var serverid_list = ['-1'];
function change_ser_scope(obj){
	var t = $(obj).find('span').data('value');
	if (serverid_list.indexOf(t) === -1 && t != undefined) {
		serverid_list.splice(0, 1, t);
	}
}
////服务器范围 浮层
var d = null;
var last_object_s = [];
function _editNode(obj, name) {
	clear_server();
	var title;
	if (name == 1) {//编辑服务器
		init_tree = 0;
		//serverId = $(obj).parent().children('a').attr('id');
		serverId = $(obj).children('span').data('value');
		$.ajax({
			url: "/bhost/get_server_list",
			type: "POST",
			async: false,
			data: { a0: se, a1: serverId },
			success: function (result) {
				var server_result = JSON.parse(result);
				if (server_result.Result == true) {
					var server_data = server_result.info.data[0];
					//title = server_data.ServerScopeName;
					title = "编辑服务器范围";
					last_object_s = server_data.HostList;
					server_edit = server_data;
				}
			}
		});
	} else if (name == 2) {
		server_edit = null;
		serverId = 0;
		title = "添加服务器范围";
		init_tree = 1;
	}
	var $dialogCont = $("#server_suspend").show();

	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "server_suspend",
		width: "1000px"
	});
	function addEventListener(ele,event,fn){
		if(ele.addEventListener){
			ele.addEventListener(event,fn,false);
		}else{
			ele.attachEvent('on'+event,fn.bind(ele));
		}
	}
	addEventListener(d,'close',function () {
	   $dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$(".ui-dialog-title").css("width", "140px");
	server_main(name);

	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		clear_server();
		$('#clearFilter1').next().children('ul').empty();
		$('#server_text').val('');
		$('#clearFilter1').hide();
		search_typeall_new = '';
		search_typeall_r = '';
		if (name == 1){
			init_tree = 0;
		}else{
			init_tree = 1;
		}
		server_main(name);
		//d.close().remove();
	});

	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		server_add(d);
	})
}

//加入ip
function _addIp2(obj) {
	var v1 =$.trim(  $(obj).prev().val());
	var v = $.trim( $(obj).prev().prev().prev().val());
	var pass = 1;
	if (v == '') {
		_alert(2, '服务器集合', '请输入起始IP', $(obj).prev().prev().prev());
		return false;
	} else if (!ipReg.test(v)) {
		_alert(1, '服务器集合', '起始IP格式不正确', $(obj).prev().prev().prev());
		return false;
	}
	if (v1 == '') {
		_alert(2, '服务器集合', '请输入结束IP', $(obj).prev());
		return false;
	} else if (!ipReg.test(v1)) {
		_alert(1, '服务器集合', '结束IP格式不正确', $(obj).prev());
		return false;
	}
	if (v == v1) {
		_alert(2, '服务器集合', '起始IP不能大于等于结束IP', $(obj).prev().prev().prev());
		return false;
	}
	var v_str = v.split(".");
	var v1_str = v1.split(".");
	for (var i = 0; i < 4; i++) {
		if (parseInt(v_str[i]) > parseInt(v1_str[i])) {
			pass = 0;
			_alert(2, '服务器集合', '起始IP不能大于等于结束IP', $(obj).prev().prev().prev());
			return false;
		} else if (parseInt(v_str[i]) < parseInt(v1_str[i])) {
			break;
		}
	}
	if (pass == 0) {
		return false;
	}
	$("#ip_n").children('span:not(:first)').each(function (i1, item1) {
		var ip1_input1 = $(item1).find('input:eq(0)').val();
		var ip1_input2 = $(item1).find('input:eq(1)').val();
		if (v == ip1_input1 && v1 == ip1_input2) {
			pass = 0;
			_alert(2, "服务器集合", "相同的IP区间已存在", $(obj).prev('input:first'));
			return false;
		}
	});
	if (pass == 0) {
		return false;
	}
	var ip_id = $("#ip_span").attr("value");
	var $c = $('<span class="ss" value="' + ip_id + '" style="float: left;width: 312px;position: static;padding: 0 0 10px 0;"/>');
	$c.html('<input type="text" class="form-text" value="' + v + '" style="width:110px;">'
		+ '<span style="vertical-align:middle;padding-left: 4px;padding-right: 4px;">-</span>'
		+ '<input type="text" class="form-text" value="' + v1 + '" style="width:110px;">'
		+ '<i class="ctr ctr-del" style="    margin-top: 5px;margin-left: -3px;" onclick="_delIp(this)"></i>');
	$(obj).parent().after($c);
	$(obj).prev().val("");
	$(obj).prev().prev().prev().val("");
	$("#ip_span").attr("value", "0");
	//}
}

//加入ip
function _addIp1(obj) {
	var pass = 1;
	var v = $.trim(  $(obj).prev('input').val());

	if (v == '') {
		_alert(2, '服务器集合', '请输入IP', $(obj).prev('input'));
		return false;
	} else if (!ipReg.test(v)) {
		_alert(1, '服务器集合', 'IP格式不正确', $(obj).prev('input'));
		return false;
	} else {
		$(">span[class='ss']", "#ip_n1").each(function () {
			ip_str = $(this).find("input").val();
			if (ip_str == v) {
				_alert(2, '服务器集合', '相同的IP已存在', $(obj).prev('input'));
				pass = 0;
				return false;
			}
		});
	}
	var ip_id = $("#ip_span1").attr("value");
	if (pass == 1) {
		var $c = $('<span class="ss" value="' + ip_id + '" style="width: 170px;float: left;position: static;padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text" style="width:110px;" value="' + v + '" >'
			+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 4px;margin-left: -3px;"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$("#ip_span1").attr("value", "0");
	}
}

function save_server_hg_host(obj, id) {
	$(">li", obj).children('input').each(function () {
		var input_id = $(this).attr('id');
		var input_str = input_id.split('-');
		var input_state = $(this).next('span.checkbox').attr('class');
		var radio_value = $(this).siblings('span.authtype').find('input');
		var $u = $(this).parent().children('ul');
		if (input_state.indexOf('checked') > 0) {
			if (radio_value.is(':checked') && input_str[1] != '1' && input_str[0] == "HGId") {
				var json_a = '{"HGId":' + input_str[1] + ',"HostId":null,"IsGroupAuth": true}';
				server.HostList.push(JSON.parse(json_a));
			} else {
				if (input_str[0] == "HGId") {
					var json_a = '{"HGId":' + input_str[1] + ',"HostId":null,"IsGroupAuth": false}';
					server.HostList.push(JSON.parse(json_a));
					if ($u.text() != "Loading..." && $u.text() != "") {
						save_server_hg_host($u, input_str[1]);
					}
				} else {
					var json_a = '{"HGId":' + id + ',"HostId":' + input_str[2] + '}';
					server.HostList.push(JSON.parse(json_a));
				}
			}
		} else if (input_state.indexOf('half') > 0) {
			if ($u.text() != "Loading..." && $u.text() != "") {
				save_server_hg_host($u, input_str[1]);
			} else {
				$.each(server_edit.HostList, function (i, item) {
					if (item.HGId == parseInt(input_str[1]) && item.HostId != null) {
						var json_a = '{"HGId":' + item.HGId + ',"HostId":' + item.HostId + '}';
						server.HostList.push(JSON.parse(json_a));
					}
				});
			}
		}
	});
}

//创建
function server_add(d) {
	var ip_section = 1;
	var ip_num = 1;
	var host_group = 1;
	var pass = 1;
	var d_n = $('#d_n').val();
	if (d_n == "") {
		_alert(2, '服务器集合', '请输入名称', $('#d_n'));
		return false;
	} else if (!nameReg.test(d_n)) {
		_alert(1, '服务器集合', '名称格式不正确', $('#d_n'));
		$("#d_n").val("");
		return false;
	}
	var v2 = $.trim($("#ip_n1").find("span[class='ss ss-add']").children("input").val());
	if (v2 == "" && !$('#ip_n1').find("span[class=ss]").length) {
		ip_num = 0;
	}
	var ip_n1_len = $("#ip_n1").find('input').length;
	$("#ip_n1").find('input').each(function (i, item) {
		var input1 = $(item).val();
		if (ip_num == 0) {
			return true;
		}

		if (i == 0 && ip_n1_len != 1 && input1 == "") {
			return true;
		}

		if (input1 == "") {
			pass = 0;
			_alert(2, "服务器集合", "请输入IP地址", $(item));
			return false;
		}
		if (!ipReg.test(input1)) {
			pass = 0;
			_alert(1, "服务器集合", "IP格式不正确", $(item));
			return false;
		}
		$("#ip_n1").find('input').not($(item)).each(function (i1, item1) {
			if (i1 < i) {
				return true;
			}
			var input2 = $(item1).val();
			if (input2 == "") {
				pass = 0;
				_alert(2, "服务器集合", "请输入IP地址", $(item1));
				return false;
			}
			if (!ipReg.test(input2)) {
				pass = 0;
				_alert(1, "服务器集合", "IP格式不正确", $(item1));
				return false;
			}
			if (input1 == input2) {
				pass = 0;
				_alert(2, "服务器集合", "相同的IP已存在", $(item));
				return false;
			}
		});
		if (pass == 0) {
			return false;
		}
	});
	if (pass == 0) {
		return false;
	}


	var v = $.trim(  $("#ip_n").find("span[class='ss ss-add']").children("input").val());
	var v1 = $.trim(  $("#ip_n").find("span[class='ss ss-add']").children().next("input").val());

	if (v == "" && v1 == "" && !$(">span[class='ss']", "#ip_n").length) {
		ip_section = 0;
	}
	var ip_n_len = $("#ip_n").children('span').length;
	$("#ip_n").children('span').each(function (i, item) {
		if (ip_section == 0) {
			return true;
		}
		var ip_input1 = $(item).find('input:eq(0)').val();
		var ip_input2 = $(item).find('input:eq(1)').val();
		if (i == 0 && ip_n_len != 1 && ip_input1 == "" && ip_input2 == "") {
			return true;
		}
		if (ip_input1 == '') {
			pass = 0;
			_alert(2, '服务器集合', '起始IP请输入', $(item).find('input:eq(0)'));
			return false;
		} else if (!ipReg.test(ip_input1)) {
			pass = 0;
			_alert(1, '服务器集合', '起始IP格式不正确', $(item).find('input:eq(0)'));
			return false;
		}
		if (ip_input2 == '') {
			pass = 0;
			_alert(2, '服务器集合', '请输入结束IP', $(item).find('input:eq(1)'));
			return false;
		} else if (!ipReg.test(ip_input2)) {
			pass = 0;
			_alert(1, '服务器集合', '结束IP格式不正确', $(item).find('input:eq(1)'));
			return false;
		}
		var r_v = _compare_ip(ip_input1, ip_input2);
		if (r_v != 3) {
			pass = 0;
			_alert(2, '服务器集合', '起始IP不能大于等于结束IP', $(item).find('input:eq(0)'));
			return false;
		}
		$("#ip_n").children('span').not($(item)).each(function (i1, item1) {
			if (i1 < i) {
				return true;
			}
			var ip1_input1 = $(item1).find('input:eq(0)').val();
			var ip1_input2 = $(item1).find('input:eq(1)').val();
			if (ip1_input1 == '') {
				pass = 0;
				_alert(2, '服务器集合', '请输入起始IP', $(item1).find('input:eq(0)'));
				return false;
			} else if (!ipReg.test(ip1_input1)) {
				pass = 0;
				_alert(1, '服务器集合', '起始IP格式不正确', $(item1).find('input:eq(0)'));
				return false;
			}
			if (ip1_input2 == '') {
				pass = 0;
				_alert(2, '服务器集合', '请输入结束IP', $(item1).find('input:eq(1)'));
				return false;
			} else if (!ipReg.test(ip1_input2)) {
				pass = 0;
				_alert(1, '服务器集合', '结束IP格式不正确', $(item1).find('input:eq(1)'));
				return false;
			}
			var r_v = _compare_ip(ip1_input1, ip1_input2);
			if (r_v != 3) {
				pass = 0;
				_alert(2, '服务器集合', '起始IP不能大于等于结束IP', $(item1).find('input:eq(0)'));
				return false;
			}
			if (ip_input1 == ip1_input1 && ip_input2 == ip1_input2) {
				pass = 0;
				_alert(2, "服务器集合", "相同的IP区间已存在", $(item).find('input:eq(1)'));
				return false;
			}
		});
		if (pass == 0) {
			return false;
		}
	});
	if (pass == 0) {
		return false;
	}

	server.HostList = new Array();
	save_server_hg_host($("#userTree1"), 0);
	
	if (server.HostList.length == 0) {
		host_group = 0;
	}

	if (host_group == 0 && ip_section == 0 && ip_num == 0) {
		_alert(2, '服务器集合', '请输入IP或选择主机', $("#ip_n1").find("span[class='ss ss-add']").children("input"));
		return false;
	}
	if (pass == 1) {
		server.ServerScopeId = parseInt(serverId);
		server.ServerScopeName = d_n;
		server.IPList.Set = new Array();
		var i = 1;
		var $all = $('#ip_n').find('span[class=ss]');
		var len = $all.length;
		for (var j = len - 1; j >= 0; j--) {
			var ip_id = $all.eq(j).attr("value");
			var $v = $all.eq(j).find('input');
			var input_0 = $v.eq(0).val();
			var input_1 = $v.eq(1).val();
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + input_0 + '","EndIP":"' + input_1 + '"}';
			server.IPList.Set.push(JSON.parse(json_a));
			i++;
		}
		if (v != "" && v1 != "") {
			ip_id = $("#ip_span").attr("value");
			var b1 = $.trim(  $("#ip_n").find("span[class='ss ss-add']").children("input").val());
			var b2 = $.trim(  $("#ip_n").find("span[class='ss ss-add']").children().next("input").val());
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + b1 + '","EndIP":"' + b2 + '"}';
			server.IPList.Set.push(JSON.parse(json_a));
			i++;
		}
		var $all = $('#ip_n1').find('span[class=ss]');
		var len = $all.length;
		for (var j = len - 1; j >= 0; j--) {
			var ip_id = $all.eq(j).attr("value");
			var ip_str = $all.eq(j).find("input").val();
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + ip_str + '","EndIP":"' + ip_str + '"}';
			server.IPList.Set.push(JSON.parse(json_a));
			i++;
		}
		if (v2 != "") {
			ip_id = $("#ip_span1").attr("value");
			var b1 = $.trim(  $("#ip_n1").find("span[class='ss ss-add']").children("input").val());
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + b1 + '","EndIP":"' + b1 + '"}';
			server.IPList.Set.push(JSON.parse(json_a));
			i++
		}
		server.IsApplyToClientScope = false;
		save_server(server, d);
	}
}

function save_server(server, d) {
	$.ajax({
		url: '/bhost/add_server',
		type: "POST",
		async: false,
		data: { a0: se, a1: JSON.stringify(server) },
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result == true) {
				parent.layer.open({
					type: 1,
					title: '服务器集合',
					content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
					btn: ['确&nbsp;&nbsp;定'],
					btnAlign: 'c',
					closeBtn: false,
					skin: 'layer-custom',
					area: ['380px', '310px'],
					move: false,
					resize: false,
					yes: function (i) {
						parent.layer.close(i);
						d.close().remove();
						var ips_text = $('#ips').find('span').text();
						$("div[data-id=xSelect-server]").remove();
						$('#ips').empty().data('xSelect','');
						bind_server_xSelect();
						if ($("#ips").data('value') == "-1" || $("#ips").data('value') == undefined){
							$("#ips").data('value',result.ServerScopeId);
							$("#ips").find('span').text(server.ServerScopeName);
							serverid_list.splice(0, 1, result.ServerScopeId);
						}else{
							$('#ips').find('span').text(ips_text);
						}
						return false;
					}
				});
			} else {
				_alert(2, '服务器集合', result.ErrMsg);
				//d.close().remove();
				return false;
			}
		}
	});
}

var protocol_id;
function _editNode5(obj,type){
	clear_protocol();
	var title;
	if (type == 1) {//
		protocol_id = $(obj).children('span').data('value');
		title = "协议";
	} else if (type == 2) {
		protocol_id = 0;
		title = "协议";
	}
	var $dialogCont = $("#protoDialog").show();
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "protoDialog",
		width: "1000px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	if (manage_auth_array.indexOf(14) === -1){
		$("#protoDialog").find('.btn-submit').remove();
	}
	protocol_main(type);
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		clear_protocol();
		protocol_main(type);
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		save_pro(d);
	})
}

function protocol_main(type){
	$("#Port1").parent().parent().hide();
	$("#Port0").on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	$("#Port1").on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	if(type == 1){
		$.ajax({
			 url:'/bhost/select_protocol',
			 type:"post",
			 async:false,
			 data:{a0:se,x1:protocol_id},
			 success:function(result){
				protdata = JSON.parse(result);
				$.each(protdata.data,function(i,item){
					if(item.ProtocolName=="PCANY")
					{
						$("#Port1").parent().parent().show();
						$("#Port1").val(item.Port1);
					}
					$("#Protocol_Name0").val(item.ProtocolName);
					$("#Port0").val(item.Port);
					$("#Description0").val(item.Description);
					$("#Protocol_Name0").attr("disabled",true);
				});
			}
		});
	}
}

function namecheck(name){
	var flag=true;
	$.ajax({
		url:'/bhost/select_name',
		type: "post",
		async:false,
		data: {a0:se,x1:name},
		success:function(result){
			data = parseInt(result);
			if (data !=0){
				flag=false;
			}
		}
	});
	return flag;
}

var proto_list;
function get_protocol_list(){
	$.ajax({
		url:'/bhost/get_protocol_list',
		type: "post",
		async:false,
		cache:false,
		data: {a0:se,a1:1,a2:null,a3:null,a4:',,',a5:null},
		success: function(Result) {
			proto_list = JSON.parse(Result);
		}
	});
}

function clear_protocol(){
	$("#protoDialog").find('input').val('');
	$("#Protocol_Name0").attr('disabled',false);
}

function bind_protocol_select(){
	get_protocol_list();
	var protocol_array = [];
	/*$.each(proto_list.data,function(i,item){
		if (manage_auth_array.indexOf(14) != -1){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'check'
			};
		}else if (access_auth_array.indexOf(14) != -1){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'check'
			};
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':null
			};
		}
		select_data_json.value = item.ProtocolId;
		select_data_json.name = item.ProtocolName;
		protocol_array.push(select_data_json);
	});*/
	if($("#PType").val() == 1){
		protocol_array = [
		{
			'value':1,
			'name':'RDP',
			'type':'check'
		},
		{
			'value':2,
			'name':'SSH',
			'type':'check'
		},
		{
			'value':9,
			'name':'TELNET',
			'type':'check'
		},
		{
			'value':16,
			'name':'RLOGIN',
			'type':'check'
		}];
	}else if($("#PType").val() == 2){
		protocol_array = [{
			'value':6,
			'name':'MYSQL',
			'type':'check'
		}];
	}else{
		protocol_array = [{
			'value':4,
			'name':'ORACLE',
			'type':'check'
		}];
	}
	$('#ProtocolName').empty().data('xSelect',"");
	if (manage_auth_array.indexOf(14) != -1){
		$('#ProtocolName').xSelect({
			width: 140,
			defaultText: '请选择',
			items:protocol_array,
			module_type:'protocol',
			check: function(item,obj){
				$(obj).parents('.xSelect-view').hide();
				_editNode5(obj,1);
			},
			btn:[
			],
			setval:function(item,obj){
				sel_id = $(obj).find('span').data('value');		
				bind_conn_select();
				$.each(proto_list.data,function(i,item){
					if (sel_id == item.ProtocolId){
						$("#Port").val(item.Port);
						return false;
					}
				});
				var ProtocolId_arr=[9,10,11,12,16,17,18];
				if($.inArray(sel_id,ProtocolId_arr)>=0){
					// $('#ConnParamName').parent('div.form-item').hide();
				}else{
					$('#ConnParamName').parent('div.form-item').show();
				}
					
			}
		});
	}else{
		$('#ProtocolName').xSelect({
			width: 140,
			defaultText: '请选择',
			items:protocol_array,
			module_type:'protocol',
			check: function(item,obj){
				$(obj).parents('.xSelect-view').hide();
				_editNode5(obj,1);
			},
			setval:function(item,obj){
				sel_id = $(obj).find('span').data('value');		
				bind_conn_select();
				$.each(proto_list.data,function(i,item){
					if (sel_id == item.ProtocolId){
						$("#Port").val(item.Port);
						return false;
					}
				});
				var ProtocolId_arr=[9,10,11,12,16,17,18];
				if($.inArray(sel_id,ProtocolId_arr)>=0){
					// $('#ConnParamName').parent('div.form-item').hide();
				}else{
					$('#ConnParamName').parent('div.form-item').show();
				}
			}
		});
	}
}

//绑定服务器范围
function binding_ServerScope() {
	$.ajax({
		url: '/bhost/get_ServerScope',
		type: 'post',
		async: false,
		data: { a0: se },
		success: function (result) {
			serdata = JSON.parse(result);
		}
	});
}

function bind_server_xSelect(){
	binding_ServerScope();
	var server_array = [];
	s_index_all = [];
	$.each(serdata.data,function(i,item){
		if ($("#ips").data('value') == item.ServerScopeId){
			
		}else{
			if (serverid_list.indexOf(item.ServerScopeId) > -1){
				return true;
			}
		}
		/*
		if (serverid_list[0] == '-1' && serverid_list.indexOf(item.ServerScopeId) > -1){
			return true;
		}
		*/
		var select_data_json = {
			'value':1,
			'name':'admin2',
			'type':'edit'
		};
		select_data_json.value = item.ServerScopeId;
		select_data_json.name = item.ServerScopeName;
		server_array.push(select_data_json);
		s_index_all.push(item.ServerScopeId);
	});
	$('#ips').xSelect({
		width: 162,
		defaultText: '请选择',
		items:server_array,
		module_type:'server',
		edit: function(item,obj){
			$(obj).parents('.xSelect-view').hide();
			_editNode(obj,1);
		},
		btn:[
			{
				'name':'新增',
				'event': function(items,obj){
					$(obj).parents('.xSelect-view').hide();
					_editNode(obj,2);
				}
			}
		],
		setval:function(item,obj){
			change_ser_scope(obj);
			if ($("#define_select").val() == 1 && ($("#a_mix_select").val() == 1 || $("#s_mix_select").val() ==1)){
				//change_server(obj);
			}
		}
	});
}

function add_server_scope(obj){
	var server_id = $(obj).prev('div').data('value');
	var v = $(obj).prev('div').find('span').text();
	if (server_id == undefined || server_id == '-1'){
		_alert(2, "批量执行", "请选择服务器范围");
		return false;
	}
	var $c = $('<div style="width:214px;" class="item" id="' + server_id + '"/>');
	if (serverid_list.indexOf(server_id) === -1) {
		serverid_list.push(server_id);
	}
	serverid_list.splice(0, 0, '-1');
	s_index_all.splice($.inArray(parseInt(server_id), s_index_all), 1);
	$c.html('<input style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;width: 144px;padding: 0 8px;" typr="text" class="form-text" disabled="true" value="' + v + '"><i class="ctrl del" onclick="_del_scope(this,3)"></i>');
	$(obj).parent().after($c);
	//$(obj).parent().find('input:first').val("");
	$("#ips").find('span').text('请选择');
	$("#ips").data('value',-1);
	$("div[data-id=xSelect-server]").children('input').val('');
	$("div[data-id=xSelect-server]").find('span[data-value='+server_id+']').parent('li').remove();
	//$(obj).prev('div').data('value','');
	//change_server();
}
var server_find_json = {
	"loginusercode": null,
	"hgid": 0,
	"istree": true,
	"hgname": "",
	"hostname": "",
	"hostip": "",
	"limitrow": null,
	"offsetrow": null
}
function check_ServerScopeName(name) {
	var server_name = 0;
	$.ajax({
		url: '/bhost/check_ServerScopeName',
		type: 'post',
		async: false,
		data: { a0: se, z1: name },
		success: function (result) {
			server_name = result;
		}
	})
	return server_name;
}

function clear_server() {
	server = {
		"ServerScopeId": 0,
		"ServerScopeName": "",
		"IsApplyToClientScope": false,
		"HostList": [],
		"IPList": {
			"IPSetId": 0,
			"Set": []
		}
	}
	
	data_array_Path = null;
	search_typeall_r = '';
	$("#ip_n1").children('span').not('span:first').remove();
	$("#ip_n").children('span').not('span:first').remove();
	$("#ip_n1").find('input:eq(0)').val('');
	$("#ip_n").find('input:eq(0)').val('');
	$("#ip_n").find('input:eq(1)').val('');
	$("#d_n").val('');
	$("#d_n").attr("disabled", false);
	$("#userTree1").empty();
	$("#server_select").val(0).trigger('change');
	$("#filterWW").children('ul').children('li').remove();
	$("#filterWW").hide();
	$("#clearFilter1").hide();
	$("#server_text").val('');
	$("#d_n").next('i').attr('class', 'v-check');
}

//已定义自定义
function define_change(obj) {
	var v = $(obj).val();
	if (v == 1) { //已定义	
		$("#mix_module").show();
		$("#custom_info").hide();
		$("#server_frame").show();
		$("#defined_info").show();
		add_server();
	} else if (v == 2) { //自定义
		$("#mix_module").hide();
		$("#defined_info").hide();
		//$("#server_frame").hide();
		$("#custom_info").show();
	}
}
//绑定账号协议连接参数事件
var AuthServiceSet = [];
function _change_app() {
	$('#account,#protocol,#param,#service_list2').find('input').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
	
	$.each(accountid, function (i, item) {
		$("#ai" + item).iCheck('check');
	});
	var list_len_a = $("#service_list_a").find('input').length;
	if ($("#service_list_a").find('input:checked').length == list_len_a && list_len_a != 0) {
		$("#check_all_a").iCheck('check');
	} else {
		$("#check_all_a").iCheck('uncheck');
	}
	$.each(AuthServiceSet, function (i, item) {
		$("#" + item).iCheck('check');
	});
	var list_len = $("#service_list2").find('input').length;
	if ($("#service_list2").find('input:checked').length == list_len && list_len != 0) {
		$("#check_all").iCheck('check');
	} else {
		$("#check_all").iCheck('uncheck');
	}
	
	$('#service_list_a').find('input').on('ifChanged', function () {
		var id = $(this).attr('id').substring(2);
		if ($(this).prop('checked')) {
			if (accountid.indexOf(id) === -1) {
				accountid.push(id);
			}
		} else {
			accountid.splice($.inArray(id, accountid), 1);
		}
	});
	//var list_len = $("#service_list2").find('input').length;
	$('#service_list2').find('input').on('ifChanged', function () {
		var id = $(this).attr('id');
		if ($(this).prop("checked")) {
			if (AuthServiceSet.indexOf(id) === -1) {
				AuthServiceSet.push(id);
			}
		} else {
			AuthServiceSet.splice($.inArray(id, AuthServiceSet), 1);
		}
		if ($("#service_list2").find('input:checked').length == list_len && list_len != 0) {
			$("#check_all").iCheck('check');
		} else {
			$("#check_all").iCheck('uncheck');
		}
	});
	//var list_len_a = $("#service_list_a").find('input').length;
	$('#service_list_a').find('input').on('ifChanged', function () {
		var id = $(this).attr('id').substring(2);
		if ($(this).prop("checked")) {
			if (accountid.indexOf(id) === -1) {
				accountid.push(id);
			}
		} else {
			accountid.splice($.inArray(id, accountid), 1);
		}
		if ($("#service_list_a").find('input:checked').length == list_len_a && list_len_a != 0) {
			$("#check_all_a").iCheck('check');
		} else {
			$("#check_all_a").iCheck('uncheck');
		}
	});
	$("#check_all_a").on("ifClicked", function () {
		if (!$(this).prop("checked")) {
			$("#service_list_a").find('input').iCheck('check');
		} else {
			$("#service_list_a").find('input').iCheck('uncheck');
		}
	});
	$("#check_all").on("ifClicked", function () {
		if (!$(this).prop("checked")) {
			$("#service_list2").find('input').iCheck('check');
		} else {
			$("#service_list2").find('input').iCheck('uncheck');
		}
	});
	$("#service_list_a").children('tr').bind('click', function (e) {
		x = e.target;
		if (x.nodeName != 'A') {
			var input = $(this).find("input[type='checkbox']");
			if ($(input).prop('checked') == false) {
				$(input).iCheck('check');
			} else {
				$(input).iCheck('uncheck');
			}
		}
	});
	$("#service_list2").children('tr').bind('click', function (e) {
		x = e.target;
		if (x.nodeName != 'A') {
			var input = $(this).find("input[type='checkbox']");
			if ($(input).prop('checked') == false) {
				$(input).iCheck('check');
			} else {
				$(input).iCheck('uncheck');
			}
		}
	});
}
var server = {
	"ServerScopeId": 0,
	"ServerScopeName": "",
	"IsApplyToClientScope": false,
	"HostList": [],
	"IPList": {
		"IPSetId": 0,
		"Set": []
	}
};
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
var ipReg = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])(\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])){3}$/;
var server_edit = null;
var type = 1;
var serverId = 0;
function server_main(name) {
	if (name == 1) {
		$("#d_n").val(server_edit.ServerScopeName);
		$("#d_n").attr("disabled", true);
		server.ServerScopeId = server_edit.ServerScopeId;
		server.ServerScopeName = server_edit.ServerScopeName;
		if (server.IPList != null) {
			server.IPList.IPSetId = server_edit.IPList.IPSetId;
			if (server_edit.IPList.Set != null) {
				var IPset_group = server_edit.IPList.Set.filter(function (params) {
					return params.StartIP != params.EndIP
				});
				var IP_group = server_edit.IPList.Set.filter(function (params) {
					return params.StartIP == params.EndIP
				});
				for (var i = 0; i < IPset_group.length - 1; i++) {
					var $c = $('<span class="ss" value="' + IPset_group[i].IPSetMemberId + '" style="float: left;width: 312px;position: static;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" value="' + IPset_group[i].StartIP + '"  style="width:110px;">'
						+ '<span style="vertical-align:middle;padding-left: 4px;padding-right: 4px;">-</span>'
						+ '<input type="text" class="form-text" value="' + IPset_group[i].EndIP + '"  style="width:110px;">'
						+ '<i class="ctr ctr-del" style="margin-top: 5px;margin-left: -3px;" onclick="_delIp(this)"></i>');
					$("#ip_n").find("span[class='ss ss-add']").after($c);
				}
				if (IPset_group.length != 0) {
					$('#ip_n').find("span[class='ss ss-add']").attr('value', IPset_group[i].IPSetMemberId);
					var $ip_input = $('#ip_n').find("span[class='ss ss-add']").find('input');
					$ip_input.first().val(IPset_group[i].StartIP);
					$ip_input.last().val(IPset_group[i].EndIP);
				}
				for (var i = 0; i < IP_group.length - 1; i++) {
					var $c = $('<span class="ss" value="' + IP_group[i].IPSetMemberId + '" style="float: left;position: static;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" style="width:110px;" value="' + IP_group[i].StartIP + '" >'
						+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 4px; margin-left: -3px;"></i>');
					$('#ip_n1').find("span[class='ss ss-add']").after($c);
				}
				if (IP_group.length != 0) {
					$('#ip_n1').find("span[class='ss ss-add']").attr('value', IP_group[i].IPSetMemberId);
					$('#ip_n1').find("span[class='ss ss-add']").find('input').val(IP_group[i].StartIP);
				}
			}
		}
	}
	_initList1();
	server_find_json.id = serverId;
	server_find_json.loginusercode = usercode;
	$('#userTree1').on('change', 'span.authtype input', function () {
		var checked = $(this).prop('checked');
		_authTypeTheme($(this));
		if (checked) {
			var $input1 = $(this).parent().parent().siblings('ul').find('span.authtype input');
			var $input2 = $(this).parent().parent().siblings('ul').find('input.zcheck');
			var $input3 = $(this).parent().parent().siblings('input.zcheck');
			//
			$input3.attr("data-loadlast", 2);
			$input1.prop('disabled', true);
			_authTypeTheme($input1);
			$input2.prop('checked', true).prop('disabled', true);
			$(this).parent().parent().siblings('input.zcheck').prop('checked', true).next('span.checkbox').attr('class', 'checkbox checked');;
			$.each($input2, function () {
				$(this).next('span.checkbox').attr('class', 'checkbox checked disabled');
			});

			_checkEvent($(this).parent().parent().siblings('input.zcheck'));
		} else {
			var $input1 = $(this).parent().parent().siblings('ul').children('li').find('span.authtype').find('input');
			var $input2 = $(this).parent().parent().siblings('ul').children('li').find('input.zcheck');

			$input1.prop('disabled', false);
			_authTypeTheme($input1);
			_checkEvent1($(this));
		}
	}).on('dblclick', 'i.h-eicon,span.h-name', function () {
		var i_class_arr = $(this).siblings('i.h-aicon');
		if (i_class_arr.length == 0) {
			return false;
		}
		var $item = i_class_arr;
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if ($u.is(':hidden')) {
			$item.addClass('h-aicon-d');
			$u.show();
			if ($u.children('li').length == 0) {
				var v = 2, d;
				var $input = $(this).siblings('span.checkbox');
				if ($(this).siblings('span.authtype').find('input').is(':checked')) {
					d = 0;
				} else {
					d = 1;
				}

				if ($input.attr('class').indexOf('disabled') > 0) {
					d = 0;
				}
				var c = $input.attr('class');
				if (c.indexOf('checked') > 0)  {
					v = 1;
				} else if (c == 'checkbox') {
					v = 0;
				}
				_initHTML1($u, id, v, d);
			}
		} else {
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	});
}
var account_arry = ['-1'];
//选择账号
function change_account(obj) {
	var t = $(obj).children('option:selected').val();
	if (account_arry.indexOf(t) === -1 && t != undefined) {
		account_arry.splice(0, 1, t);
	}
	if ($(obj).children('option').length == 2 && t != '-1') {
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}
}
var a_data;
var a_index_all = [];
//获取账号
function get_account() {
	$.ajax({
		url: '/bhost/select_account_all',
		type: 'post',
		async: false,
		data: { a0: se, z11: -1 },
		success: function (result) {
			a_data = JSON.parse(result);
			$("#account_select").append('<option value="-1">请选择</option>');
			var AName;
			$.each(a_data.data, function (i, item) {
				/*
				if (item.AccountName == '*') {
					AName = '任意账号';
				} else if (item.AccountName == '-') {
					AName = '空账号';
				} else {
					AName = item.AccountName;
				}
				*/
				AName = item.AccountName;
				$("#account_select").append('<option value="' + item.AccountId + '">' + AName + '</option>');
				a_index_all.push(item.AccountId);
			});
		}
	});
	$('#account_select').select2();
}

function _addaccount(obj) {
	var add = 0;
	var name2 = $(obj).parent().children('select').children('option:selected').val();
	var t = $(obj).parent().children('select').children('option[value=' + name2 + ']').text();
	if (name2 == undefined) {
		$(obj).parent().children('select').val('-1').trigger('change');
		return false;
	}
	if (name2 == -1) {
		_alert(2, "批量执行", "请选择账号");
		return;
	}
	account_arry.splice(0, 0, '-1');
	a_index_all.splice($.inArray(parseInt(name2), a_index_all), 1);
	var $c = $(obj).parent();
	var d = $('select>option:first', $c).val();
	$c.children('select').val(d);
	var $s = $('<li class="item" id="' + name2 + '"><input type="text" class="form-text" value="' + t + '" style="width:86px;" disabled="true"><i class="ctrl del" style="margin-left: 10px;" onclick="_del_mora(this,2)"></i></li>');
	$c.children('select').find('option[value=' + name2 + ']').remove();
	$c.after($s);
}
//删除账号
var m_index_all = [];
function _del_mora(obj, type) {
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var t = $(obj).siblings('input').val();
	var v, data, max;
	var min = 0;
	if (type == 1) {
		max = m_index_all.length - 1;
		data = m_index_all;
		$("#manager_select").parent().show();
		manager_arry.splice($.inArray(id, manager_arry), 1);
		$p = $("#manager_select");
	} else {
		max = a_index_all.length - 1;
		$("#account_select").parent().show();
		account_arry.splice($.inArray(id, account_arry), 1);
		data = a_index_all;
		$p = $("#account_select");
	}
	$c.remove();
	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, id, data);
	}
	//var index_1 = search_i(min, max,id, data);
	index_1 = parseInt(index_1);

	if (index_1 == -1) {
		index_1 = max + 1;
		$p.append('<option value="' + id + '">' + t + '</option>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('option').eq(0).after('<option value="' + id + '">' + t + '</option>');
	} else {
		$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '">' + t + '</option>');
	}
	if (type == 1) {
		m_index_all.splice(index_1, 0, parseInt(id));
	} else {
		a_index_all.splice(index_1, 0, parseInt(id));
	}
}
function search_i(min, max, id, data) {
	var mid, res;
	if (data[max] < id) {
		return -1;
	}
	
	if (data[min] > id) {
		return -2;
	}
	while (min <= max) {
		mid = parseInt((min + max) / 2);
		if (data[mid] > id) {
			max = mid - 1;
			res = mid;
		} else {
			min = mid + 1;
		}
	}
	return res;
}

function _authTypeTheme(obj) {
	$.each(obj, function (i, item) {
		var $_item = $(item);

		if ($_item.parent().children('span').length == 0) {
			$_item.after('<span class="checkbox"></span>');
		}

		var $s = $_item.next('span');
		var checked = $_item.prop('checked');
		var disabled = $_item.prop('disabled');

		if (checked) {
			$s.addClass('checked');
		} else {
			$s.removeClass('checked');
		}

		if (disabled) {
			$s.addClass('disabled');
		} else {
			$s.removeClass('disabled');
		}
	})
}

function clear_conn(){
	$("#d_n_con").attr('disabled',false).val("");
	$("#d_n_con").next('i').attr('class','v-check');
	$("#connDialog").find('input').val('');
	$("#connDialog").find('select').val('0').trigger('change');
	$("#ServiceName_ssh").val('1').trigger('change');
	$("#rdpType").val('NORMAL').trigger('change');
}

var conn_id;
var manage_auth_array = [];
function _editNode6(obj,type){
	clear_conn();
	var title;
	if (type == 1) {//
		conn_id = $(obj).children('span').data('value');
		title = "连接参数";
	} else if (type == 2) {
		protocol_id = 0;
		title = "连接参数";
	}
	var $dialogCont = $("#connDialog").show();
	var con_d = dialog({
		title: title,
		content: $dialogCont,
		id: "connDialog",
		width: "800px;"
	});
	con_d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	con_d.showModal();
	if (manage_auth_array.indexOf(14) === -1){
		$("#connDialog").find('.btn-submit').remove();
	}
	conn_main(type);
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		clear_conn();
		conn_main(type);
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		//connection_add(con_d);
	})
}

function conn_main(type){
	var ProtocolId_arr=[9,10,11,12,16,17,18];
	//协议类型下拉框
	$.ajax({
		url: "/bhost/get_protocol_list",
		type: "POST",
		async: false,
		data: { a0: se, a3: 17, a2: 1, a4: ",," },
		success: function (result) {
			var userinfo_result = JSON.parse(result);
			var userinfo_data = userinfo_result.data;
			$("#Protocol_con").empty();
			$("#Protocol_con").append('<option value="0">请选择</option>');
			$.each(userinfo_data, function (i, item) {
				if($.inArray(item.ProtocolId,ProtocolId_arr)>=0){
					return true;
				}
				$("#Protocol_con").append('<option value="' + item.ProtocolId + '" text="' + item.ProtocolName + '">' + item.ProtocolName + '</option>');
			});
		}
	});
	if (type == 1) {
		$.ajax({
			url: "/bhost/get_connection_list",
			type: "POST",
			async: false,
			data: { a0:se, a1: conn_id },
			success: function (result) {
				var connection_result = JSON.parse(result);
				if (connection_result.Result == true) {
					var connection_data = connection_result.info.data[0];
					$("#d_n_con").val(connection_data.ConnParamName);
					$("#d_n_con").attr("disabled", true);
					$("#Protocol_con").val(connection_data.ProtocolId).trigger('change');
					$("#HTTP").hide();
					$("#HTTPs").hide();
					$("#ORACLE").hide();
					$("#RADMIN").hide();
					$("#MSSQL").hide();
					$("#SYBASE").hide();
					$("#MY_DB2").hide();
					$('#RDP').hide();
					$("#SSH").hide();
					//$('#MY_ConnType').hide();
					$("#DB2").hide();
					switch (connection_data.ProtocolName) {
						case 'RDP':
							$('#RDP').show();
							$('#rdpType').val(connection_data.ConnType).trigger('change');
							break;
						case 'SSH':
							$('#SSH').show();
							$('#ServiceName_ssh').val(connection_data.ServiceName).trigger('change');
							break;
						case 'SFTP':
							$('#SFTP').show();
							$('#ServiceName_sftp').val(connection_data.ServiceName).trigger('change');
							break;
						//HTTP(S)
						case 'HTTP(S)':
							$("#HTTP").show();
							$("#url").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#Submit").val(connection_data.ConnParamValue.substring(index+1));
							break;
						//HTTPs
						case 'HTTPS':
							$("#HTTPs").show();
							$("#httpsurl").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#httpsSubmit").val(connection_data.ConnParamValue.substring(index+1));
							break;
						//ORACLE
						case 'ORACLE':
							//
							if (connection_data.ConnParamValue == null) {
								connection_data.ConnParamValue = 0;
							}
							//指定项必填
							$("#appoint").val(connection_data.ConnParamValue).trigger('change');
							$("#s_n").val(connection_data.ServiceName);
							if (connection_data.ConnType == null) {
								connection_data.ConnType = 0;
							}
							$("#conn").val(connection_data.ConnType).trigger('change');
							//
							$("#ORACLE").show();
							break;
						//RADMIN
						case 'RADMIN':
							//认证方式：
							if (connection_data.ConnType == null) {
								connection_data.ConnType = "0";
							}
							$("#authtype").val(connection_data.ConnType).trigger("change");
															$("#RADMIN").show();
							break;
						//MSSQL
						case 'MSSQL':
							//
							//实例名：
							$("#o_n").val(connection_data.ServiceName);
							//认证方式：
							if (connection_data.ConnType == null) {
								connection_data.ConnType = "0";
							}
							$("#R_authtype").val(connection_data.ConnType).trigger("change");
							//
							$("#MSSQL").show();
							break;
						//MYSQL 
						case 'MYSQL':
							//
							//数据库名：
							$('#sql_n').val(connection_data.ServiceName);
							//
							$("#MY_DB2").show();
							//$('#MY_ConnType').show();
							break;
						//DB2
						case 'DB2':
							//
							//数据库名：
							$('#dbsql_n').val(connection_data.ServiceName);
							//
							$("#DB2").show();
							break;
						//SYBASE
						case 'SYBASE':
							//
							//实例名：
							$('#sy_o_n').val(connection_data.ServiceName);
							//
							$("#SYBASE").show();
							break;
					}
				} else {
					_alert(1, '连接参数', connection_result.ErrMsg);
					return false;
				}
			}
		});
	}

	$("#Protocol_con").change(function () {
		var p_id = $(this).val();
		$("#HTTP").hide();
		$("#HTTPs").hide();
		$("#ORACLE").hide();
		$("#RADMIN").hide();
		$("#MSSQL").hide();
		$("#SYBASE").hide();
		$("#MY_DB2").hide();
		$('#RDP').hide();
		$("#SFTP").hide();
		$('#MY_ConnType').hide()
		$("#SSH").hide();
		//$('#MY_ConnType').hide();
		$("#DB2").hide();
		switch ($('#Protocol_con option[value='+p_id+']').text()) {
			case "RDP":
				$('#RDP').show();
				break;
			case "SSH":
				$('#SSH').show();
				break;
			case "SFTP":
				$('#SFTP').show();
				$("#ServiceName_sftp").val('1').trigger('change');
				break;
			//HTTP(S)
			case "HTTP(S)":
				$("#HTTP").show();
				break;
			//HTTP
			case "HTTPS":
				$("#HTTPs").show();
				break;
			//ORACLE
			case "ORACLE":
				$("#ORACLE").show();
				break;
			//RADMIN
			case "RADMIN":
				$("#RADMIN").show();
				break;
			//MSSQL
			case "MSSQL":
				$("#MSSQL").show();
				break;
			//MYSQL 
			case "MYSQL":
				$("#MY_DB2").show();
				//$('#MY_ConnType').show();
				break;
			//DB2
			case "DB2":
				$("#DB2").show();
				break;
			//SYBASE
			case "SYBASE":
				$("#SYBASE").show();
				break;
		}
	});
}
var server_set;
//设备类型选择
function change_device_type(obj) {
	$("#def_server").children('option').not('option:first').remove();
	$("#def_server").val('-1').trigger('change');
	//$("#ProtocolName").select2('destroy').select2();
	//$("#ProtocolName option:eq(0)").prop("selected", true);
	//$("#ProtocolName").change();
	sel_id = -1;
	bind_conn_select();
	server_set = [];
	if ($(obj).val() != '-1') {
		$.each(device_data.data, function (i, item) {
			if (item.DeviceTypeId == $(obj).val()) {
				server_set = item.ServiceSet;
				return false;
			}
		});
		$.each(server_set, function (i, item) {
			$("#def_server").append('<option value="' + item.DeviceServiceId + '">' + item.DeviceServiceName + '</option>');
		});
		$("#def_server").select2();
	}
}

//模板载入
function show_def_server(obj) {
	if ($(obj).val() != '-1') {
		$.each(server_set, function (i, item) {
			if ($(obj).val() == item.DeviceServiceId) {
				$("#Port").val(item.Port);
				$("#ProtocolName").data('value',item.ProtocolId);
				$("#ProtocolName").find('span').text(item.ProtocolName);
				sel_id = item.ProtocolId;
				bind_conn_select();
				if (item.ConnParamId != null){
					$("#ConnParamName").data('value',item.ConnParamId);
					$("#ConnParamName").find('span').text(item.ConnParamName);
				}
			}
		})
	} else {
		$("#Port").val('');
		$("#ProtocolName").data('value','-1');
		$("#ProtocolName").find('span').text('请选择');
		$("#ConnParamName").data('value','-1');
		$("#ConnParamName").find('span').text('请选择');
	}
}

var device_data;
//获取设备类型
function get_server() {
	$.ajax({
		url: '/bhost/get_server',
		type: 'post',
		async: false,
		data: { a0: se },
		success: function (result) {
			device_data = JSON.parse(result);
			$.each(device_data.data, function (i, item) {
				$("#device_type").append('<option value="' + item.DeviceTypeId + '">' + item.DeviceTypeName + '</option>');
			})
		}
	});
	$('#device_type').select2();
	$('#def_server').select2();
}
//获取连接参数
var connparm_list = null;
function get_ConnParam_list(id){
	$.ajax({
		url:'/bhost/get_ConnParam_list',
		type: "post",
		async:false,
		cache:false,
		data: {a0:se,a1:id},
		success: function(Result) {
			connparm_list = JSON.parse(Result);			
		}
	});
}

var sel_id = -1;
function bind_conn_select(){
	get_ConnParam_list(sel_id);
	var conn_array = [];
	if (connparm_list != null){
		$.each(connparm_list.data,function(i,item){
			if (manage_auth_array.indexOf(14) != -1){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'type':'check'
				};
			}else if (access_auth_array.indexOf(14) != -1){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'type':'check'
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'type':null
				};
			}
			select_data_json.value = item.ConnParamId;
			select_data_json.name = item.ConnParamName;
			conn_array.push(select_data_json);
		});
	}
	$('#ConnParamName').empty().data('xSelect',"");
	if (manage_auth_array.indexOf(14) != -1){
		$('#ConnParamName').xSelect({
			width: 140,
			defaultText: '请选择',
			items:conn_array,
			module_type:'conn',
			check: function(item,obj){
				$(obj).parents('.xSelect-view').hide();
				_editNode6(obj,1);
			},
			btn:[
			]
		});
	}else{
		$('#ConnParamName').xSelect({
			width: 140,
			defaultText: '请选择',
			items:conn_array,
			module_type:'conn',
			check: function(item,obj){
				$(obj).parents('.xSelect-view').hide();
				_editNode6(obj,1);
			}
		});
	}
}

//端口校正
function port_check(obj) {
	obj.value = obj.value.replace(/\D/g, "");
}

var ServerIndex = -1;
//添加服务
function _addServer(type,obj) {
	var ServiceSet = {
		"ProtocolId": 0,
		"ProtocolName":"",
		"Port": 0,
		"ConnParamId": 0,
		"ConnParamName":""
	}
	//ProtocolId = $("#ProtocolName").val();
	var ProtocolId = $("#ProtocolName").data('value');
	var pro_name = $("#ProtocolName").find('span').text();
	if (ProtocolId == undefined || ProtocolId == '-1') {
		_alert(2, '访问授权', "请选择协议");
		return false;
	}
	Port = $("#Port").val();
	if (Port == "") {
		_alert(2, '访问授权', "请输入端口", $("#Port"));
		return false;
	}

	if (parseInt(Port) <= 0 || parseInt(Port) >= 65535) {
		_alert(2, '访问授权', "协议端口在0~65535之间", $("#Port"));
		return false;
	}
	//ConnParamId = $("#ConnParamName").val();
	var ConnParamId = $("#ConnParamName").data('value');
	var conn_name = $("#ConnParamName").find('span').text();
	if (ConnParamId == undefined || ConnParamId == '-1') {
		ConnParamId = null;
	}
	var n = 0;
	if (type == 'edit'){
		var edit_index = $(obj).parents('tr:eq(0)').index();
	}
	$.each(DeviceType.ServiceSet, function (i, item) {
		if (item.ProtocolId == ProtocolId && item.Port == Port && item.ConnParamId == ConnParamId && edit_index != i) {
			n = 1;
			_alert(2, "访问授权", "已存在相同的服务");
			return false;
		}
	})
	if (n) return false;
	ServiceSet.ProtocolId = parseInt(ProtocolId);
	ServiceSet.ProtocolName = pro_name;
	ServiceSet.Port = parseInt($("#Port").val());
	ServiceSet.ConnParamId = ConnParamId;
	ServiceSet.ConnParamName = conn_name;
	
	if (type == "add") {
		DeviceType.ServiceSet.push(ServiceSet);
		ServerIndex = ServerIndex + 1;
		$("#service_list1").append("<tr id=\"ser_" + ServerIndex + "\"><td>" + pro_name + "</td><td>" + Port + "</td><td>" + conn_name.replace("请选择", "") + "</td><td><div class=\"tab-ctr\"><a style=\"width:8px;\" href=\"javascript:;\" class=\"edit\" onclick=\"_getDialog1('edit',this)\"></a><a style=\"width:8px;\" href=\"javascript:;\" class=\"del\" onclick=\"_delServer(this)\"></a></div></td></tr>");
	}
	else {
		DeviceType.ServiceSet[edit_index] = ServiceSet;
		$(obj).parents('tr:first').html("<td>" + pro_name + "</td><td>" + Port + "</td><td>" + conn_name.replace("请选择", "") + "</td><td><div class=\"tab-ctr\"><a style=\"width:8px;\" href=\"javascript:;\" class=\"edit\" onclick=\"_getDialog1('edit',this)\"></a><a style=\"width:8px;\" href=\"javascript:;\" class=\"del\" onclick=\"_delServer(this)\"></a></div></td></td>");

	}
	$("#service_list1 tr").bind("dblclick", function () {
		$(this).children('td:last').find('.edit').click();
	});
	clear_serverdata();
}
//删除服务
function _delServer(obj) {
	$('.btn').blur();
	parent.layer.open({
		type: 1,
		title: "访问授权",
		content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
		btnAlign: 'c',
		closeBtn: false,
		skin: 'layer-custom',
		area: ['380px', '310px'],
		move: false,
		resize: false,
		btn1: function (i) {
			parent.layer.close(i);
			//var index = parseInt(num) - 1;
			var index = $(obj).parents('tr:eq(0)').index();
			DeviceType.ServiceSet.splice(index, 1);
			$(obj).parent().parent().parent().remove();
			clear_serverdata();
		},
		btn2: function (i) {
			parent.layer.close(i);
		}
	});
}

//重置数据
function clear_serverdata() {
	$("#def_server").children('option').not('option:first').remove();
	$("#device_type").val('-1').trigger('change');
	$("#device_type").select2();
	$('#ConnParamName').parent('div.form-item').show();
	bind_protocol_select();
	sel_id = -1;
	bind_conn_select();
	//ServerIndex = -1;
}

//编辑 服务列表数据绑定
function _editServer(obj) {
	//var index = parseInt(num) - 1;
	//ServerIndex = index;
	var index = $(obj).parents('tr:eq(0)').index();
	$("#ProtocolName").data('value',DeviceType.ServiceSet[index].ProtocolId);
	$("#ProtocolName").find('span').text(DeviceType.ServiceSet[index].ProtocolName);
	sel_id = DeviceType.ServiceSet[index].ProtocolId;
	bind_conn_select();
	if (DeviceType.ServiceSet[index].ConnParamId != null){
		$("#ConnParamName").data('value',DeviceType.ServiceSet[index].ConnParamId);
		$("#ConnParamName").find('span').text(DeviceType.ServiceSet[index].ConnParamName);
	}
	//$("#ProtocolName").val(DeviceType.ServiceSet[index].ProtocolId).trigger("change");
	//$("#ConnParamName").val(DeviceType.ServiceSet[index].ConnParamId).trigger("change");
	$("#Port").val(DeviceType.ServiceSet[index].Port);
}

////服务 浮层
function _getDialog1(type, obj) {
	$('.btn-normal1').blur();
	clear_serverdata();
	var $dialogCont = $("#scDCTab1").show();
	if (type == 'edit') {
		title = '服务';
	} else {
		title = '服务';
	}
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "scDCTab1",
		width: "600px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	if (type == 'edit') {
		$("#device_module").hide();
		$("#module_server").hide();
	}else{
		$("#device_module").show();
		//$("#module_server").show();
		$("#module_server").hide();
	}
	d.showModal();
	
	bind_protocol_select();
	bind_conn_select();
	if (type == 'edit') {
		_editServer(obj);
	}
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		d.close().remove();
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		if (_addServer(type,obj) == false) return false;
		d.close().remove();
	})
}
var host_path_all_s;
var index_f_s = 0;
var push_hgid_s = [];
var push_hid_s = [];
var hdata_s = null;
var filter_flag_append_s = false;
var flag_loading_s = false;
var loading_hgid_s = 0;
var find_host_arry_s = [];
var find_host_flag_s = 0;
var old_path_all_s = [];
var push_filter_wait_s = [];

//加载树
function _initList1() {
	//get_hostdirectory_s();
	_viewHTML1('#userTree1');
	//下拉按钮触发
	$('#userTree1').unbind();
	$('#userTree1').on('click', 'i.h-aicon', function () {
		var $item = $(this);
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if ($u.is(':hidden')) {
			$item.addClass('h-aicon-d');
			$u.show();
			if ($u.children('li').length == 0) {
				var v = 2, d;
				var $input = $(this).siblings('span.checkbox');
				if ($(this).siblings('span.authtype').find('input').is(':checked')) {
					d = 0;
				} else {
					d = 1;
				}
				if ($input.attr('class').indexOf('disabled') > 0) {
					d = 0;
				}
				var c = $input.attr('class');
				if (c.indexOf('checked') > 0) {
					v = 1;
				} else if (c == 'checkbox') {
					v = 0;
				}
				_initHTML1($u, id, v, d);
			}
		} else {
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	})
}

//加载下拉树
function _initHTML1(obj, id, v, d) {
	$(obj).empty();
	//过滤中 不需要 showloading
	if (filter_flag_append_s == true)
		filter_flag_append_s = false;
	else
		_showLoading();
	flag_loading_s = true;
	var loading_hgid_s;
	$.ajax({
		url: '/bhost/get_hostdirectory',
		type: 'post',
		async: true,
		data: { a0: se, a2: id, a5: serverId, a6: '1' ,a7: ajax_find_host_doing_s ? 'true' : 'false'},
		success: function (result) {
			var hdata_s = JSON.parse(result).info.data;
			loading_hgid_s = id;
			if (serverId > 0 && ajax_find_host_doing_s == false) disabled_flag_s = "disabled";
			else disabled_flag_s = "";
			var loadfirst = 0;
			var loadlast = 0;
			var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
			var _p_loadfirst = $(obj).siblings('input').attr('data-loadfirst');
			var _p_loadlast = $(obj).siblings('input').attr('data-loadlast');
			var auth_type_checked = false;
			if ($(obj).siblings('span.authtype').find('input').length != 0) {
				auth_type_checked = $(obj).siblings('span.authtype').find('input').prop('checked');
			}
			if ((_p_loadfirst == 0) && (_p_loadlast == 0)) {
			}
			if (auth_type_checked) {
				disabled_flag_s = "";
			}
			if (_p_loadfirst == _p_loadlast) {
				if (_p_loadlast == 2) {
					loadfirst = 2
					loadlast = 2;
				}
			} else {
				if (_p_loadlast == 2) {
					loadlast = 2;
				}
				if (_p_loadfirst == 2) {
					loadfirst = 2;
				}
			}

			if (hdata_s.HGroup == null) hdata_s.HGroup = [];
			$.each(hdata_s.HGroup, function (i, item) {
				if (item.Mode == 2) var $auth = '<label><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag_s + ' data-mode="' + item.Mode + '" >组执行</label>';
				else var $auth = '<label style="display:none"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag_s + ' data-mode="' + item.Mode + '" >组执行</label>';
				if (ajax_find_host_doing_s == true && $(obj).siblings('span.h-name-red').length == 0) {
					var $H = $('<li style="display: none;"></li>');
				} else {
					var $H = $('<li></li>');
				}

				//if ((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
				//else 
				i_class = "h-aicon";

				//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
				//data-loadlast(最后保存的状态)
				if (v == 1 && d == 0) {
					disabled_flag_s = "disabled";
					if (item.Mode == 2) $auth = '<label><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag_s + ' data-mode="' + item.Mode + '" >组执行</label>';
					else $auth = '<label style="display:none;"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag_s + ' data-mode="' + item.Mode + '" >组执行</label>';
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g" ' + disabled_flag_s + ' data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="2" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				} else if (v == 1) { //v == 1 d ==1
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="2" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				} else if (v == 0) {
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="2" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				} else {
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" ' + disabled_flag_s + ' data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false data-mode="2" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');

				}
				if (serverId > 0) {
					if (!auth_type_checked) {
						if (push_hgid_s.indexOf(item.HGId+":false") < 0) {
							push_hgid_s.push(item.HGId + ":false");
						}
					}
				}
				$(obj).append($H);
			})
			_checkView_host(obj);
			if (serverId > 0) {
				select_checkbox_s("HGroup", parent_id);	 //只有编辑情况下 才需要判断 select 
			}
			if (hdata_s.Host == null) {
				hdata_s.Host = [];
				flag_loading_s = false;
				_closeLoading();
				return false;
			}
			var i = 0;
			var index_s = 0;
			
			$.each(hdata_s.Host,function (i,item) {
				if((item.Selected==0 && item.Mode==0 && ajax_find_host_doing_s==true) || (serverId<=0 && item.Mode==0)){
					return true;
				}
				if(ajax_find_host_doing_s==true && $(obj).siblings('span.h-name-red').length==0){
					var $H = $('<li style="display: none;"></li>');
				}else{
					var $H = $('<li></li>');
				}
				// if(hdata.Host[i].AccountNum == 0) i_class = "h-blank";
				// else i_class = "h-aicon";
				i_class = "h-blank";
				//var HostName_h = autoAddEllipsis(item.HostName,'12');
				var HostName_h = item.HostName;
				if (v == 1 && d == 0) {
					$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" /><input type="checkbox" checked="checked" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="1" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false disabled data-mode="' + item.Mode + '" data-name="' + item.HostIP + '\t' + item.HostName + '"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;">' + item.HostIP + '(' + HostName_h + ')' + '</span><ul style="display:none">Loading...</ul>');

				} else if (v == 1) {
					$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" /><input type="checkbox" checked="checked" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="1" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false data-mode="'+item.Mode+'" data-name="' + item.HostIP  + '\t' + item.HostName + '"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;">' + item.HostIP + '(' + HostName_h + ')' + '</span><ul style="display:none">Loading...</ul>');
				} else if (v == 0) {
					$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" /><input type="checkbox" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="0" class="zcheck zcheck-g" data-ifselect=false data-mode="'+item.Mode+'" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-name="' + item.HostIP + '\t' + item.HostName + '"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;">' + hdata_s.Host[i].HostIP  + '(' + HostName_h + ')' + '</span><ul style="display:none">Loading...</ul>');
				} else {
					$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" /><input type="checkbox" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="0" class="zcheck zcheck-g" data-loadfirst=0 data-loadlast=' + loadlast + ' ' + disabled_flag_s + ' data-ifselect=false data-mode="'+item.Mode+'" data-name="' + item.HostIP + '\t' + item.HostName + '"><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;">' +  hdata_s.Host[i].HostIP + '(' + HostName_h + ')' + '</span><ul style="display:none">Loading...</ul>');
				}
				if (serverId > 0) {
					if (!auth_type_checked) {
						if (push_hid_s.indexOf(parent_id + ':' + item.HostId) < 0) {
							if (ajax_find_host_doing_s == false) {
								push_hid_s.push(parent_id + ':' + item.HostId + ":false");
							}
						}
					}
				}
				$(obj).append($H);
				_checkView1($('#HostId-' + parent_id + '-' + item.HostId));
			});
			_closeLoading();
			if(ajax_find_host_doing_s==false){
				select_checkbox_s("Host",parent_id);
			}
			flag_loading_s = false;
		}
	});
}

//根目录
var init_tree = 0;
function _viewHTML1(obj) {
	if (init_tree == 0){
		_showLoading();
	}
	$.ajax({
		url: '/bhost/get_hostdirectory',
		type: 'POST',
		async: false,
		data: { a0: se, a2: "0", a5: serverId, a6: '1' },
		success: function (result) {
			hdata_s = JSON.parse(result).info.data;
			$(obj).empty();
			disabled_flag_s = "";
			if (serverId > 0) disabled_flag_s = "disabled";
			$.each(hdata_s.HGroup, function (i, item) {
				
				if (item.Mode == 2){
					var $auth = '<label style="display:none;"><input type="checkbox" name="check'+item.HGId+'" data-ifselect=false '+disabled_flag_s+' data-mode="'+item.Mode+' " >组执行</label>';
				}else{
					var $auth = '';
				}
				if (item.HGId==1){
					var $auth = '';
				}
				var $H = $('<li></li>');
				//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
				//data-loadlast(最后保存的状态) 
				//data-ifselect(组或者主机 是否是按组执行或者 按主机执行)
				//if ((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
				//else 
				i_class = "h-aicon";
				$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" ' + disabled_flag_s + ' data-loadfirst=0 data-loadlast=0 data-ifselect=false data-mode="2" data-name="' + item.HGName + '" ><i class="h-eicon h-eicon-g" ></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				$(obj).append($H);
				if (serverId > 0) {
					if (push_hgid_s.indexOf(item.HGId + ":false") < 0) {
						push_hgid_s.push(item.HGId + ":false");
					}
				}
			});
			_checkView_host(obj);
			if (serverId > 0) {
				select_checkbox_s("HGroup", 0);	 //只有编辑情况下 才需要判断 select 
			}
			
		}
	});
}

//绑定 主机组状态
function select_checkbox_s(select_flag, pid) {
	if (select_flag == "HGroup") { //主机组 
		var i = 0;
		var index_w = 0;
		var indx = 0;
		var t_doselect;
		function _doselect() {
			clearTimeout(t_doselect);
			for (i = index_w; i < index_w + 5; i+=5) { //每次只加载一个 根据情况定
				if (push_hgid_s.length == 0 && init_tree == 0){
					init_tree = 1;
					_closeLoading();
				}
				if (i >= push_hgid_s.length) {
					if (push_hgid_s.length == 0) {
						return false;
					} else {
						index_w = 0;
						t_doselect=setTimeout(function(){_doselect();},1);
						return false;
					}
				}
				var PGetHNodeSelected_json = {
					"type": 11,
					"id": serverId,
					"ishost": false,
					"hnodeset": new Array(),
					"srcinfo":{"usercode":loginusercode,"srcip":IP_ADDR}
				}
				for (var m = i; m < i + 5; m++) {
					if (m >= push_hgid_s.length) {
						break;
					}
					var hg_id = push_hgid_s[m].split(":")[0];
					var flag_sec = push_hgid_s[m].split(":")[1];
					var $hg_pinput = $("#HGId-" + hg_id).parent().parent().siblings('input');
					var hg_pid = 0;
					if ($hg_pinput.length != 0) {
						hg_pid = $hg_pinput.attr('id').split('-')[1];
						if (push_hgid_s.indexOf(hg_id + ':true') >= 0) {
							continue;
						}
						if (push_hgid_s.indexOf(hg_pid + ':false') >= 0) {
							continue;
						}
						if (push_hgid_s.indexOf(hg_pid + ':true') >= 0) {
							continue;
						}
					}
					if (flag_sec == 'false') {
						PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": null,"hid": ' + hg_id + '}'));
						push_hgid_s[m] = hg_id + ":" + "true";
					}
				}	

				if (PGetHNodeSelected_json.hnodeset.length > 0) {
					$.ajax({
						url: '/bhost/PGetHNodeSelected',
						type: 'post',
						async: true,
						cache:false,
						data: { a0: se, z1: JSON.stringify(PGetHNodeSelected_json) },//hg_id
						//data: { a0: se, z1: 1, z2: serverId, z3: hg_id, z4: false, z5: 'NULL', z6: pid },//hg_id
						success: function (result) {
							var result = JSON.parse(result);
							var data = result.info;
							$.each(data, function (i, item) {
								var _currentId = $("#HGId-" + item.hid);
								var _span_authtype = _currentId.siblings('span.authtype');
								var mode = parseInt(_currentId.attr("data-mode"));
								var p_id;
								//
								//pid = data.pid;//当前组所在的父组id
								if (_currentId.parent().parent().siblings("input").length > 0)
									p_id = _currentId.parent().parent().siblings("input").attr('id').split('-')[1];
								else p_id = 0;
								var if_change_parent = false; //主机组是否改变
								var loadlast = 0;
								var _p_loadfirst = $('#HGId-' + p_id).attr("data-loadfirst");
								var _p_loadlast = $('#HGId-' + p_id).attr("data-loadlast");

								if (_p_loadfirst == _p_loadlast) { //没改变		
								} else {
									if_change_parent = true;
									loadlast = _p_loadlast;
								}
								var gl_selected = false;
								if (item.selected == 0) {
									_currentId.next('span').attr("class", "checkbox");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);
									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);

								} else if (item.selected == 1) {
									_currentId.next('span').attr("class", "checkbox half");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);
									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);
								} else {
									_currentId.next('span').attr("class", "checkbox checked");
									_currentId.prop('checked', true);
									_currentId.attr('data-loadfirst', item.selected);
									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);

									//判断该主机组是否是 按组执行
									$.each(last_object_s, function (i1, item1) {
										if (item1.HGId == item.hid) {
											if (item1.HostId == null ) {
												gl_selected = true;
												return false;
											}
										}
									})
									//
								}
								if (gl_selected) {
									_span_authtype.find('input').attr('data-ifselect', true);
									_currentId.attr('data-ifselect', true);
								} else {
									_span_authtype.find('input').attr('data-ifselect', false);
									_currentId.attr('data-ifselect', false);
								}
								//判断是否隐藏按组执行

								if (mode == 0 && item.selected == 0) { //隐藏按组执行
									_span_authtype.children('label').hide();
								} else if (mode == 0 && item.selected == 1) { //隐藏按组执行
									_span_authtype.children('label').hide();
								} else if (mode == 0 && item.selected == 2) {
									if (gl_selected) _span_authtype.children('label').show();
									else _span_authtype.children('label').hide();
								} else if (mode == 2) {
									_span_authtype.children('label').show();
								}
								//如果父节点的状态改变了
								if (if_change_parent == true) {
									if (_p_loadlast == 0) { //1-0 2-0
										_currentId.next('span').attr("class", "checkbox");
										_currentId.prop('checked', false);
										_span_authtype.find('span').attr("class", "checkbox");
										_span_authtype.find('input').prop("checked", false);
										if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false ){
											_span_authtype.find('input').prop("disabled",false);
											_currentId.prop('disabled',false);
										}
										_currentId.attr('data-loadfirst', item.selected);
										if (_p_loadfirst == 2) _currentId.attr('data-loadfirst', 2);
									} else if (_p_loadlast == 2) {	 // 0-2	 1-2							
										_currentId.prop('checked', true);

										//父节点 按组执行
										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
											_currentId.prop('disabled', true);//input
											_currentId.next('span').attr("class", "checkbox checked disabled");
											//<<<< 
											_currentId.attr("data-loadlast","2");
											_span_authtype.find('span').attr('class', "checkbox disabled");
											_span_authtype.find('input').prop('checked', true).prop('disabled', true);

										} else { // 1-0 1-2
											_currentId.prop('disabled', false);//input
											_currentId.next('span').attr("class", "checkbox checked");
											_currentId.attr("data-loadlast","2");
											
											if (gl_selected) {
												_span_authtype.find('span').attr('class', "checkbox checked");
												_span_authtype.find('input').prop('checked', true).prop('disabled', false);
											} else {
												_span_authtype.find('input').prop('disabled', false);
												_span_authtype.find('span').attr('class', 'checkbox');
											}
										}
									}
								} else {
									//父节点 按组执行
									if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
										_currentId.prop('disabled', true);//input
										_currentId.prop('checked', true);
										_currentId.next('span').attr("class", "checkbox checked disabled");
										
										if (_p_loadlast == 2) {
											_currentId.attr("data-loadlast", "2");
										}
										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked disabled");
											_currentId.siblings('span.authtype').find('input').prop('checked', true).prop('disabled', true);
										} else {
											_span_authtype.find('input').prop('disabled', true);
											_span_authtype.find('span').attr('class', 'checkbox disabled');
										}
									} else {
										_currentId.prop('disabled', false);//input
										_currentId.next('span').removeClass("disabled");
										if(_p_loadlast == 2){
											_currentId.prop('checked',true);
											_currentId.attr("data-loadlast","2");
											_currentId.next('span').attr("class","checkbox checked");
										}
									
										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked");
											_span_authtype.find('input').prop('checked', true).prop('disabled', false);
										} else {
											_span_authtype.find('input').prop('disabled', false);
											_span_authtype.find('span').attr('class', 'checkbox');
										}
									}
								}
								if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')) {
									_currentId.prop('checked', true);
									_currentId.prop('disabled', true);//input
									_currentId.next('span').attr("class", "checkbox checked disabled");
									//<<<< 
									_span_authtype.find('span').addClass("disabled");
									_span_authtype.find('input').prop('disabled', true);
								}
								//
								var ind = push_hgid_s.indexOf(item.hid + ":" + "true");
								if (ind != -1){
									push_hgid_s.splice(ind, 1);
									i = 0;
								}
							});
							index_w = i;
							t_doselect = setTimeout(function () { _doselect(); }, 1);
						},
						error: function (XmlHttpRequest, textStatus, errorThrown) {
							ind = push_hgid_s.indexOf(hg_id + ":" + "true");
							if (ind >= 0) {
								push_hgid_s.splice(ind, 1);
								push_hgid_s.push(hg_id + ":" + "false");
							}
							return false;
						}
					})
				}
			}
		}
		_doselect();
	}else if (select_flag == "Host") { //主机
		var i = 0;
		var index_w = 0;
		var indx = 0;
		var t_doselect1;
		function _doselect1() {
			clearTimeout(t_doselect1);
			for (i = index_w; i < index_w + 5; i+=5) { //每次只加载一个 根据情况定
				if (i >= push_hid_s.length) {
					if (push_hid_s.length == 0) {
						return false;
					} else {
						index_w = 0;
						i = 0;
						t_doselect1=setTimeout(function(){_doselect1();},1);
						return false;
					}
				}
				var PGetHNodeSelected_json = {
					"type": 11,
					"id": serverId,
					"ishost": true,
					"hnodeset": new Array(),
					"srcinfo":{"usercode":loginusercode,"srcip":IP_ADDR}
				}
				for (var m = i; m < i + 5; m++) {
					if (m >= push_hid_s.length) {
						break;
					}
					var pid_h = push_hid_s[m].split(":")[0];
					var h_id = push_hid_s[m].split(":")[1];
					var flag_sec = push_hid_s[m].split(":")[2];
					if (push_hid_s.indexOf(pid_h + ':' + h_id + ":" + "true") >= 0) {
						continue;
					}
					if (push_hgid_s.indexOf(pid_h + ':false') >= 0) {
						continue;
					}
					if (push_hgid_s.indexOf(pid_h + ':true') >= 0) {
						continue;
					}
					if (flag_sec == 'false') {
						PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": ' + pid_h + ',"hid": ' + h_id + '}'));
						push_hid_s[m] = pid_h + ':' + h_id + ":" + "true";
					}
				}

				if (PGetHNodeSelected_json.hnodeset.length > 0) {
					atr = $.ajax({
						url: '/bhost/PGetHNodeSelected',
						type: 'post',
						async: true,
						/*"IsHNodeSelected"(type, id, NULL, hg."HGId", FALSE) */
						/* 	z1: type type:0-主机管理，1-服务器范围，2-管理授权，3-批量执行，4-工单，5-指令授权，6-改密计划，7-主机信息，8-连通性测试计划*/
						/* 	z2;	id 当前工单授权id*/
						/*	z3:	主机组不填，主机的话，填父组的ID*/
						/*	z4:	主机组 false，主机的话 true  */
						/*	z5:	 当前主机组的id */
						/*	z6:	 当前主机组的id*/
						//data: { a0: se, z1: 1, z2: serverId, z3: h_id, z4: true, z5: pid, z6: pid },//hg_id
						data: { a0: se, z1: JSON.stringify(PGetHNodeSelected_json) },//hg_id
						success: function (result) {
							var result = JSON.parse(result);
							var data = result.info;
							$.each(data,function(i,item){
								var p_id = item.parentid;//当前组所在的父组id
								_currentId = $("#HostId-" + p_id + '-' + item.hid);//当前id
								atr_flag = 1;
								if (_currentId.length == 0) {
									return false;
								}
								var _span_authtype = _currentId.siblings('span.authtype');//当前按组执行
								var li_currentId = _currentId.parent();
								var mode = parseInt(_span_authtype.find('input').attr("data-mode"));
								//
								//p_id = data.pid;//当前组所在的父组id
								var if_change_parent = false; //主机组是否改变
								var loadlast = 0;
								var _p_loadfirst = $('#HGId-' + p_id).attr("data-loadfirst");
								var _p_loadlast = $('#HGId-' + p_id).attr("data-loadlast");
								if (_p_loadfirst == _p_loadlast) { //没改变		
								} else {
									if_change_parent = true;
									loadlast = _p_loadlast;
								}

								//绑定 data-loadfirst状态 和 data-loadlast
								var gl_selected = false;
								if (item.selected == 0) {
									_currentId.next('span').attr("class", "checkbox");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);

									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);
								} else if (item.selected == 1) {
									_currentId.next('span').attr("class", "checkbox half");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);

									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);

								} else {
									_currentId.next('span').attr("class", "checkbox checked");
									_currentId.prop('checked', true);
									_currentId.attr('data-loadfirst', item.selected);

									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);
									//
									$.each(last_object_s, function (i1, item1) {
										if (item1.HostId == item.hid && item1.HGId == p_id) {
											gl_selected = true;
											return false;
										}
									})
								}
								//绑定是否按组执行状态
								if (gl_selected) {
									_span_authtype.find('input').attr('data-ifselect', true);
									_currentId.attr('data-ifselect', true);
								} else {
									_span_authtype.find('input').attr('data-ifselect', false);
									_currentId.attr('data-ifselect', false);
								}
								//判断是否隐藏主机 因为存在 当前用户的管理权限 加了这个
								if (tmp_list_s == null) {
									if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
										//li_currentId.show();
										if (mode != 0 || item.selected != 0) {
											_currentId.attr('data-mode', '2');
											li_currentId.show();
										} else {
											li_currentId.parent('li').remove();
										}
									} else {
										if (mode == 0 && item.selected == 0) { //隐藏主机
											li_currentId.hide();
										} else if (mode == 0 && item.selected == 1) { //隐藏主机
											_currentId.attr('data-mode', '2');
											li_currentId.show();
										} else if (mode == 0 && item.selected == 2) {
											_currentId.attr('data-mode', '2');
											li_currentId.show();
										} else if (mode == 2) {
											li_currentId.show();
										}
									}
								}else{
									li_currentId.hide();
									if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
										if (mode != 0 || item.selected != 0) {
											_currentId.attr('data-mode', '2');
											li_currentId.show();
										} else {
											li_currentId.parent('li').remove();
										}

									} else {
										if (mode == 0 && item.selected == 0) { //隐藏主机
											li_currentId.parent('li').remove();
										} else if (mode == 0 && item.selected == 1) { //隐藏主机
											_currentId.attr('data-mode', '2');
											li_currentId.show();
										} else if (mode == 0 && item.selected == 2) {
											_currentId.attr('data-mode', '2');
											li_currentId.show();
										} else if (mode == 2) {
											li_currentId.show();
										}
									}
								}
								
								//查看 父节点 是否是 1、全选还是空 2、是否按组执行 勾选 / disabled
								if (if_change_parent) {
									if (_p_loadlast == 0) {
										_currentId.next('span').attr("class", "checkbox");
										_currentId.prop('checked', false);
										_span_authtype.find('span').attr("class", "checkbox");
										_span_authtype.find('input').prop("checked", false);

										if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false ){
											_span_authtype.find('input').prop("disabled",false);
											_currentId.prop('disabled',false);
										}
										if (_p_loadfirst == 2) _currentId.attr('data-loadfirst', 2);
									} else if (_p_loadlast == 2) {
										_currentId.prop('checked', true);
										//父节点 按组执行
										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
											_currentId.prop('disabled', true);//input
											_currentId.next('span').attr("class", "checkbox checked disabled");
											_currentId.attr("data-loadlast","2");
											_span_authtype.find('input').prop('disabled', true);
											_span_authtype.find('span').attr('class', 'checkbox disabled');

										} else {
											_currentId.prop('disabled', false);//input
											_currentId.next('span').attr("class", "checkbox checked");
											_currentId.attr("data-loadlast","2");
											if (gl_selected) {
												_span_authtype.find('span').attr('class', "checkbox checked");
												_span_authtype.find('input').prop('checked', true).prop('disabled', false);
											} else {
												_span_authtype.find('input').prop('disabled', false);
												_span_authtype.find('span').attr('class', 'checkbox');
											}
										}
									}
								} else {
									//父节点 按组执行
									if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
										_currentId.prop('disabled', true);//input
										_currentId.prop('checked',true);
										_currentId.next('span').attr("class", "checkbox checked disabled");
										if (_p_loadlast == 2) {
											_currentId.prop('checked', true);
											_currentId.attr("data-loadlast", "2");
										}
										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked disabled");
											_span_authtype.find('input').prop('checked', true).prop('disabled', true);
										} else {
											_span_authtype.find('input').prop('disabled', true);
											_span_authtype.find('span').attr('class', 'checkbox disabled');
										}

									} else {
										_currentId.prop('disabled', false);//input
										_currentId.next('span').removeClass("disabled");
										if(_p_loadlast == 2){
											_currentId.prop('checked',true);
											_currentId.next('span').attr("class","checkbox checked");
											_currentId.attr("data-loadlast","2");
										}
										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked");
											_span_authtype.find('input').prop('checked', true).prop('disabled', false);
										} else {
											_span_authtype.find('input').prop('disabled', false);
											_span_authtype.find('span').attr('class', 'checkbox');
										}

									}
								}
								if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')) {
									_currentId.prop('checked', true);
									_currentId.prop('disabled', true);//input
									_currentId.next('span').attr("class", "checkbox checked disabled");
									//<<<< 
									_span_authtype.find('span').addClass("disabled");
									_span_authtype.find('input').prop('disabled', true);
								}
								var ind = push_hid_s.indexOf(p_id + ':' + item.hid + ":" + "true");
								if (ind != -1){
									push_hid_s.splice(ind, 1);
									i = 0;
								}
							});
							index_w = i;
							t_doselect1 = setTimeout(function () { _doselect1(); }, 1);
						},
						error: function (XmlHttpRequest, textStatus, errorThrown) {
							return false;
						}
					});
				}
			}
		}
		_doselect1();
	}
}
function _checkView_host(obj) {
	_authTypeTheme($('span.authtype input', obj));
	$('input.zcheck', obj).each(function () {
		//$(obj).find('input.zcheck').each(function(){
		var $s = $('<span class="checkbox"></span>');
		$(this).after($s);
		var v = $(this).prop('checked');
		if (v) {
			$s.addClass('checked');
		} else {
			var c = $(this).data('check');
			if (c && c == 2) {
				$s.addClass('half');
			}
		}

		var d = $(this).prop('disabled');
		if (d) {
			$s.addClass('disabled');
		}
	}).on('change', function () {
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul').find('li');

		var $authInput = $(this).siblings('span.authtype').find('input');
		if (v) {
			$s.attr('class', 'checkbox checked');
			$('input.zcheck', $u).prop('checked', true);
			$('span.checkbox:first', $u).attr('class', 'checkbox checked');
			//$u.find('span.authtype').show();
			$(this).attr("data-loadlast", 2);
			$('input.zcheck', $u).attr("data-loadlast", 2);
			$u.each(function () {
				if ($(this).children('span.authtype').find('input').prop('checked')) {
					var $u_li = $(this).children('ul').find('li');
					$('input.zcheck', $u_li).prop('disabled', true);
					$('span.checkbox:first', $u_li).addClass('disabled');
				};
			});

		} else {
			$s.attr('class', 'checkbox');
			//$('input.zcheck',$u).prop('checked',false).prop('disabled',false);
			//$('span.checkbox:first',$u).attr('class','checkbox');
			$('input', $u).prop('checked', false).prop('disabled', false);
			$('span.checkbox', $u).attr('class', 'checkbox');
			$(this).attr("data-loadlast", 0);
			$('input.zcheck', $u).attr("data-loadlast", 0);

			$authInput.prop('checked', false).trigger('change');
			$(this).siblings('span.authtype').find('span').attr('class', 'checkbox');
		}
		_checkEvent(this);
	});
}
function _checkEvent(obj) {
	var _run = function () {
		var $li = $(obj).parent().parent().parent();
		var tagname = $li[0].tagName.toLowerCase();
		var v = $(obj).prop('checked');

		if (tagname == 'li') {
			var c1 = 0, c2 = 0;
			var len = $(obj).parent().parent().children('li').length;

			$(obj).parent().parent().children('li').each(function () {
				var c = $(this).children('span.checkbox').attr('class');
				if (c.indexOf('checked') > 0) {
					c1++;
				} else if (c.indexOf('half') > 0) {
					c2++;
				}
				if (c1 == len) {
					var span_class = $li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class');
					var d_class = "";
					if (span_class.indexOf('disabled') != -1) {
						d_class = 'disabled';
					}
					var attr_class = 'checkbox checked ' + d_class;
					$li.children('input.zcheck').prop('checked', true).siblings('span.checkbox').attr('class', attr_class);
					$li.children('input.zcheck').attr("data-loadlast", 2);
				} else if (c1 == 0 && c2 == 0) {
					$li.children('input.zcheck').prop('checked', false).prop('disabled', false).siblings('span.checkbox').attr('class', 'checkbox').removeClass('disabled');
					$li.children('input.zcheck').attr("data-loadlast", 0);
					$li.children('input.zcheck').siblings('span.authtype').children('input').prop('checked', false).siblings('span.checkbox').attr('class', 'checkbox');
				} else {
					var span_class = $li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class');
					var d_class = "";
					if (span_class.indexOf('disabled') != -1) {
						d_class = 'disabled';
					}
					var attr_class = 'checkbox half ' + d_class;
					$li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class', attr_class);
					$li.children('input.zcheck').attr("data-loadlast", 1);
				}
			});
			_checkEvent($li.children('input.zcheck'));
		} else {
			return;
		}
	}

	_run();
}
function _checkEvent1(obj) {
	if ($(obj).length == 0) return false;
	var _run1 = function () {
		_input = $(obj).parent().parent().siblings('input.zcheck');
		_ul = _input.siblings('ul');
		if (_input.length > 0 && (_ul.children('li').length > 0)) {
			$inp = _ul.children('li').children('input.zcheck');
			$($inp).each(function (i, item) {
				$parent = $(item).parent().parent().siblings('span.authtype').find('input');
				v = $($parent).prop("checked");
				$spanp = $(item).siblings('span.authtype');
				//如果发现父节点还是disabled
				if ($($parent).prop("disabled") == true) v = true;
				if (v == false) {
					$(item).prop("disabled", false);
					$(item).siblings('span.checkbox').removeClass("disabled");
					$spanp.find('input').prop("disabled", false);
					$spanp.find('span').removeClass("disabled");
					if ($spanp.length == 0) {
						_checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
					}
					else {
						if ($(item).prop('checked') == false) $spanp.find('input').prop('checked', false).next('span').removeClass('checked');
						_checkEvent1($spanp.find('input'));
					}
				} else {
					$(item).prop("checked", true).prop("disabled", true);
					$(item).siblings('span.checkbox').addClass("disabled");
					$spanp.find('input').prop("disabled", true);
					$spanp.find('span').addClass("disabled");
					if ($spanp.length == 0) _checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
					else _checkEvent1($spanp.find('input'));

				}
			})
		} else {
			return;
		}
	}

	_run1();
}
function _checkEvent2(obj) {
	if (obj.length == 0) return false;
	var _run2 = function () {
		_input = $(obj).parent().parent().siblings('input.zcheck');;
		if ($(_input).prop('disabled') == true) {
		$(obj).prop("checked",true).prop("disabled",true);
			$(obj).siblings('span.checkbox').addClass("disabled");
		} else {
			$(obj).prop("disabled", false);
			$(obj).siblings('span.checkbox').removeClass("disabled");
		}
		_checkEvent2($(obj).siblings('ul').children('li').children('input.zcheck'));
	}
	_run2();
}

function get_hostdirectory1(obj, id, v, d, t, pid, sername) {
	flag_loading = true;
	var loading_hgid;
	$.ajax({
		url: '/bhost/GetAuthObject_B',
		type: 'post',
		async: true,
		data: { a0: se, a1: id, a3:ajax_find_host_doing?'true':'false', a4: t,a6:JSON.stringify(type_json)},
		success: function (result) {
			var hdata = JSON.parse(result);
			if(hdata.Result == false){
				_alert(1,"批量执行",hdata.ErrMsg);
			}
			loading_hgid = id;
			if (editid > 0) disabled_flag = "";
			else disabled_flag = "";
			var loadfirst = 0;
			var loadlast = 0;
			var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
			var _p_loadfirst = $(obj).siblings('input').attr('data-loadfirst');
			var _p_loadlast = $(obj).siblings('input').attr('data-loadlast');
			var auth_type_checked = $(obj).siblings('span.authtype').find('input').prop('checked');
			if (_p_loadfirst == _p_loadlast) {
				if (_p_loadlast == 2) {
					loadfirst = 2
					loadlast = 2;
				}
			} else {
				loadlast = _p_loadlast;
			}

			if (hdata.data.HGroup == null) hdata.data.HGroup = [];
			$.each(hdata.data.HGroup, function (i, item) {
				if (item.Mode == 2) var $auth = '<label style="display:none;"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" >组执行</label>';
				else var $auth = '<label style="display:none;"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" >组执行</label>';
				var $H = $('<li></li>');
				i_class = "h-aicon";
				//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
				//data-loadlast(最后保存的状态)
				
				var str_list =  item.HGName.split('');
				var stp = '';
				for(var i1=0;i1<str_list.length;i1++){
					stp += '<font>'+str_list[i1]+'</font>';
				}
				
				if (v == 1 && d == 0) {
					if (item.Mode == 2) $auth = '<label><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false disabled data-mode="' + item.Mode + '" >组执行</label>';
					else $auth = '<label style="display:none;"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" disabled >组执行</label>';
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" checked="checked" id="nodehg-' + item.HGId + '" data-check="1" class="zcheck zcheck-g" data-name="'+item.HGName+'" disabled data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + '<span class="h-name-son" style="">' + 
							stp + 
							'</span>' + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				} else if (v == 1) { //v == 1 d ==1
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" checked="checked" id="nodehg-' + item.HGId + '" data-check="1" class="zcheck zcheck-g" data-name="'+item.HGName+'" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + '<span class="h-name-son" style="">' + 
							stp + 
							'</span>' + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				} else if (v == 0) {
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" id="nodehg-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + '<span class="h-name-son" style="">' + 
							stp + 
							'</span>' + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				} else {
					$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" data-name="'+item.HGName+'" id="nodehg-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" ' + disabled_flag + ' data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + '<span class="h-name-son" style="">' + 
							stp + 
							'</span>' + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
				}
				if (editid > 0) {
					if (auth_type_checked) {

					} else {
						if (push_hgid.indexOf(item.HGId + ":false") < 0) {
							push_hgid.push(item.HGId + ":false");
						}
					}
				}
				$(obj).append($H);
			})

			if (editid > 0) {
				var _ajax_find_host_doing = ajax_find_host_doing;
				select_checkbox("HGroup", parent_id,_ajax_find_host_doing,obj);	 //只有编辑情况下 才需要判断 select 
			}
			_checkView_host(obj);
			if (hdata.data.Host == null) {
				hdata.data.Host = [];
				flag_loading = false;
				_closeLoading();
				return false;
			}

			var i = 0;
			var index = 0;
			html_str = "";
			$.each(hdata.data.Host,function (i,item) {
				if(item.HostId > 0){
					if((hdata.data.Host[i].Selected==0 && hdata.data.Host[i].Mode==0 && ajax_find_host_doing==true) || (TID<=0 && hdata.data.Host[i].Mode==0)){
						return true;
					}
					var $auth = '<label style="display:none;"><input type="checkbox" name="check'+hdata.data.Host[i].HostId+'"  '+disabled_flag+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'"    >主机执行</label>';
					//$auth = '';
					if(ajax_find_host_doing==true && $(obj).siblings('span.h-name-red').length==0){
						var $H = $('<li style="display: none;"></li>');
					}else{
						var $H = $('<li></li>');
					}
					var HostName_h;
					if(HideIP){
						//HostName_h = autoAddEllipsis(hdata.data.Host[i].HostName,'22');
						HostName_h = hdata.data.Host[i].HostName;
					}else{
						//HostName_h = autoAddEllipsis(hdata.data.Host[i].HostName,'12');
						HostName_h = hdata.data.Host[i].HostName;
					}
					var input_disabled = "";
					if	(hdata.data.Host[i].AccountNum == 0){
						i_class = "h-blank";
						//input_disabled = "disabled";
					}else{
						i_class = "h-aicon";
					}
					var ShowMsg = "";
					if(HideIP){
						ShowMsg = HostName_h;
					}else{
						ShowMsg = hdata.data.Host[i].HostIP+'('+HostName_h+')';
					}
					str_list =  ShowMsg.split('');
					var stp = '';
					for(var i1=0;i1<str_list.length;i1++){
						stp += '<font>'+str_list[i1]+'</font>';
					}
					if(v==1 && d == 0){
						$auth = '<label><input type="checkbox" name="check'+hdata.data.Host[i].HostId+'" disabled data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" >主机执行</label>';
						$auth ='';
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+'  disabled  data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
								stp +
								'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');						
					}else if(v==1){
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" '+input_disabled+' data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
								stp +
								'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}else if(v==0){
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" '+ input_disabled +' data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
								stp +
								'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}else{
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" '+input_disabled+' data-ifselect=false data-loadfirst=0 data-loadlast='+loadlast+' '+disabled_flag+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
								stp +
								'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						if(ajax_find_host_doing==false){
							$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" '+input_disabled+' class="zcheck zcheck-g" data-ifselect=false data-loadfirst=0 data-loadlast='+loadlast+' '+disabled_flag+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
									stp +
									'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						}
						else{
							switch(hdata.data.Host[i].Selected){
								case 0:
									$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=0 '+input_disabled+' data-loadlast='+hdata.data.Host[i].Selected+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
											stp +
											'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
									break;
								case 1:
									$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="2" '+input_disabled+' class="zcheck zcheck-g" data-ifselect=false data-loadfirst=1 data-loadlast='+hdata.data.Host[i].Selected+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
											stp +
											'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
									break;
								case 2:
									$.each(last_object,function(i1,item1){
										if((item1.HostId == hdata.data.Host[i].HostId) && (item1.HGId == parseInt(parent_id)) && (item1.AccountId == null) && (item1.HostServiceId == null)){
											$auth = '<label><input type="checkbox" name="check'+hdata.data.Host[i].HostId+'" checked="checked" data-ifselect=true data-mode="'+hdata.data.Host[i].Mode+'" >主机执行</label>';
											return false;
										}
									})
									$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=2 data-loadlast='+hdata.data.Host[i].Selected+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
											stp +
											'</span>'+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
									break;
							}
						}
					}
					if(editid > 0){
						if (auth_type_checked){
						}else{
							if(push_hid.indexOf(parent_id + ':' + hdata.data.Host[i].HostId + ":false") <0){
								if(ajax_find_host_doing==false){
									push_hid.push(parent_id + ':' + hdata.data.Host[i].HostId + ":false");
								}
							}
						}
					}
					$(obj).append($H);
					_checkView1($('#nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId));
				}
			});
			_closeLoading();
			var _ajax_find_host_doing=ajax_find_host_doing;
			select_checkbox("Host",parent_id,_ajax_find_host_doing,obj);
			flag_loading = false;
		}
	});
}
var s_h_array = [];
var s_s_array = [];
function _checkView1(obj) {
	_authTypeTheme($(obj).parent().find('span.authtype input'));
	$(obj).each(function () {
		var $s = $('<span class="checkbox"></span>');
		$(this).after($s);
		var v = $(this).prop('checked');
		if (v) {
			$s.addClass('checked');
		} else {
			var c = $(this).data('check');
			if (c && c == 2) {
				$s.addClass('half');
			}
		}

		var d = $(this).prop('disabled');
		if (d) {
			$s.addClass('disabled');
		}
	}).on('change', function () {
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul');
		var d;
		if ($(this).siblings('span.authtype').find('input').is(':checked')) {
			d = 0;
		} else {
			d = 1;
		}

		if (v) {
			$s.attr('class', 'checkbox checked');
			$('input.zcheck', $u).prop('checked', true);
			$('span.checkbox', $u).attr('class', 'checkbox checked');
			$(this).attr("data-loadlast", "2");
			$(this).find('input.zcheck').attr('data-loadlast', 2);

		} else {
			$s.attr('class', 'checkbox');
			$('input.zcheck', $u).prop('checked', false).prop('disabled', false);
			$('span.checkbox', $u).attr('class', 'checkbox');
			$(this).siblings('span.authtype').find('input').prop('checked', false);
			$(this).siblings('span.authtype').find('span').attr('class', 'checkbox');
			$(this).siblings('span.authtype').find('span').trigger('change');
			$(this).attr("data-loadlast", "0");
			$(this).siblings('ul').find('input.zcheck').attr('data-loadlast', 0);
		}

		_checkEvent(this);
	});
}

//所有共有
var all_flag = 1;
function mix_change(obj) {
	var v = $(obj).val();
	if (v == 1) {
		all_flag = 1;
		add_server();
	} else {
		all_flag = 0;
		add_server();
	}
}

function a_mix_change(obj){
	var v = $(obj).val();
	if (v == 2){
		//$("#service_list_a").empty();
		$("#account").hide();
	}else{
		$("#account").show();
		if ($("#mix_select").val() == 1){
			all_flag = 1;
			add_server();
		}else{
			all_flag = 0;
			add_server();
		}
	}
}

function s_mix_change(obj){
	var v = $(obj).val();
	if (v == 2){
		$("#service_module").hide();
	}else{
		$("#service_module").show();
		if ($("#mix_select").val() == 1){
			all_flag = 1;
			add_server();
		}else{
			all_flag = 0;
			add_server();
		}
	}
}
//根目录
function _viewHTML(data, obj, type) {
	$(obj).empty();
	if (type == 0) {
		disabled_flag = "";
		if (editid > 0) disabled_flag = "disabled";
		var $auth = '';
		$.each(data.data.HGroup, function (i, item) {

			if (item.HGId == 1) {
				$auth = '';
			} else if (item.Mode == 2) {
				$auth = '<label style="display:none;"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + ' " >组执行</label>';
			} else {
				$auth = '<label style="display:none;"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" >组执行</label>';
			}
			$auth = '';
			var $H = $('<li></li>');
			//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
			//data-loadlast(最后保存的状态) 
			//data-ifselect(组或者主机 是否是按组执行或者 按主机执行)
			//if ((item.HGroupNum + item.HostNum) == 0) i_class = "h-blank";
			//else 
			i_class = "h-aicon";
			str_list =  item.HGName.split('');
			var stp = '';
			for(var i1=0;i1<str_list.length;i1++){
				stp += '<font>'+str_list[i1]+'</font>';
			}
			$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" /><input type="checkbox" id="nodehg-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" ' + disabled_flag + ' data-loadfirst=0 data-loadlast=0 data-ifselect=false data-mode="2" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-g" ></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;"><span class="h-name-son" style="">' + stp + 
					'</span>' + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
			$(obj).append($H);
		});
		_checkView_host(obj);
		if (editid > 0) {
			var _ajax_find_host_doing=ajax_find_host_doing;
			select_checkbox("HGroup", 0,_ajax_find_host_doing);	 //只有编辑情况下 才需要判断 select 
		}
	}
}
var initlistFlag = 0;
function _initList() {
	if(initlistFlag == 1){
		return false;
	}
	//获取user
	$('#hostTree').on('click','i.h-aicon',function(){
		var id = $(this).data('id').split('-')[1];
		var uorh = $(this).data('id').split('-')[0]; 
		var $u = $(this).parent().children('ul');
		if($u.is(':hidden')){
			$(this).addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2,d;
				var $input = $(this).siblings('span.checkbox');
				if($(this).siblings('span.authtype').find('input').is(':checked')){
					d = 0;
				}else{
					d = 1;
				}
				if ($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}
				var pid,sername;
				if(uorh == 'arrHG'){
					pid = null;
					sername = null;
				}else if(uorh == 'arrH'){
					pid = $(this).siblings('input').attr('id').split('-')[1];
					id = $(this).siblings('input').data('name').split('\t')[0];
					sername = null;
				}else if(uorh == 'arrS'){
					pid = $(this).siblings('input').attr('id').split('-')[1];
					id = $(this).siblings('input').data('name').split('\t')[1];
					sername = $(this).siblings('input').data('name');
				}
				_initHTML($u,id,v,d,uorh,pid,sername);
			}
		}else{
			$(this).removeClass('h-aicon-d');
			$u.hide();
		}
	}).on('dblclick', 'i.h-eicon,span.h-name', function () {
		var i_class_arr = $(this).siblings('i.h-aicon');
		if (i_class_arr.length == 0) {
			return false;
		}
		var $item = i_class_arr;
		var id = $item.data('id').split('-')[1];
		var uorh = $item.data('id').split('-')[0];
		var $u = $item.parent().children('ul');
		if ($u.is(':hidden')) {
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2,d = 1;
				var $input = $(this).siblings('span.checkbox');
				if($(this).siblings('span.authtype').find('input').is(':checked')){
					d = 0;
				}else{
					d = 1;
				}
				if ($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}
				var pid,sername;
				if(uorh == 'arrHG'){
					pid = null;
					sername = null;
				}else if(uorh == 'arrH'){
					pid = $(this).siblings('input').attr('id').split('-')[1];
					id = $(this).siblings('input').data('name').split('\t')[0];
					sername = null;
				}else if(uorh == 'arrS'){
					pid = $(this).siblings('input').attr('id').split('-')[1];
					id = $(this).siblings('input').data('name').split('\t')[0];
					sername = $(this).siblings('input').data('name');
				}				
				_initHTML($u,id,v,d,t,pid,sername);
			}
		} else {
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	});
	initlistFlag = 1;
}
var ajax_data = [];
var MAX_AJAX = 50;
//子节点
function _initHTML(obj, id, v, d, uorh, pid, sername) {
	$(obj).empty();
	if (uorh == "arrHG" || uorh == "arrH") {
		if (uorh == "arrHG") {
			
			//过滤中 不需要 showloading
			if (filter_flag_append == true) filter_flag_append = false;
			else _showLoading();
			get_hostdirectory1(obj, id, v, d, TYPE, pid, sername);
			return true;
		} else if(uorh == "arrH") {
			if (filter_flag_append == true) filter_flag_append = false;
			else _showLoading();
			_showLoading();
			$.ajax({
				url: '/bhost/GetAuthObject_B',
				type: 'post',
				cache:false,
				async: true,
				data: {a0:se,a1:pid,a2:id,a3:false,a4:TYPE,a6:JSON.stringify(type_json)},
				beforeSend :function(xmlHttp){
					xmlHttp.setRequestHeader("If-Modified-Since","0"); 
					xmlHttp.setRequestHeader("Cache-Control","no-cache");
				},
				success: function (result) {
					var adata = JSON.parse(result);
					if(adata.Result == false){
						_alert(1,"批量执行",adata.ErrMsg);
					}
					adata = adata.data;
					////data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
					//data-loadlast(最后保存的状态) 
					//data-ifselect(组或者主机 是否是按组执行或者 按主机执行
					var flag_change = false;
					var _loadfirst = $(obj).siblings('input.zcheck').attr("data-loadfirst");
					var _loadlast = $(obj).siblings('input.zcheck').attr("data-loadlast");
					var parents_aid = $(obj).siblings('input.zcheck').attr('id').split('-');
					var parents_id = parents_aid[2];
					var parentss_id = parents_aid[1];
					//判断 父节点是否状态改变

					var loadfirst = 0;
					var loadlast = 0;

					if (_loadfirst == _loadlast) {
						if (_loadlast == 2) {
							loadfirst = 2;
							loadlast = 2;
						} else if (_loadlast == 1) {
							flag_change = true;
						}
					} else {
						if (_loadlast == 2) {
							loadlast = 2;
						}
					if (_loadfirst == 2){
						loadfirst = 2;
					}
				}
				$.each(adata, function (i, item) {
					$.each(SUP_PROTOCOL,function(i_p,item_p){
						if(item.ProtocolName == item_p){
								var $a = '';
								var class_flag = 0;
								$.ajax({
									url: '/bhost/GetAuthObject_B',
									type: 'post',
									cache:false,
									async: false,
									data: {a0:se,a1:pid,a2:id,a3:false,a4:TYPE,a5:item.HostServiceName,a6:JSON.stringify(type_json)},
									success: function (result) {
										var accdata = JSON.parse(result);	
										if(accdata.Result == false){
											_alert(1,"批量执行",accdata.ErrMsg);
										}
										adata.AccountSet = accdata.data;
									}
								})
								$.each(adata.AccountSet, function (i2, item2) {
									str_list =  item2.AccountName.split('');
									var stp = '';
									for(var i1=0;i1<str_list.length;i1++){
										stp += '<font>'+str_list[i1]+'</font>';
									}
									class_flag = 1;
									if (loadlast == 2) {
										$a = $a + '<li><i class="h-blank" /><input type="checkbox" id="nodea-' + parentss_id + '-' + parents_id + '-' + item2.AccountId + '-' + item.HostServiceId + '" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' checked="checked" data-name="'+item2.AccountName+'"><i class="h-eicon h-eicon-a2"></i><span class="h-name h-name2" id="nodea-' + parentss_id + '-' + parents_id + '-' + item2.AccountId + '-' + item.HostServiceId + '" style="margin-top:-6px;width: 12em;">' + '<span class="h-name-son" style="">' + 
												stp+ 
												'</span>' + '</span></li>'
									} else {
										$a = $a + '<li><i class="h-blank" /><input type="checkbox" id="nodea-' + parentss_id + '-' + parents_id + '-' + item2.AccountId + '-' + item.HostServiceId + '" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-name="'+item2.AccountName+'"><i class="h-eicon h-eicon-a2"></i><span class="h-name h-name2" id="nodea-' + parentss_id + '-' + parents_id + '-' + item2.AccountId + '-' + item.HostServiceId + '" style="margin-top:-6px;width: 12em;">' + '<span class="h-name-son" style="">' + 
												stp + 
												'</span>' + '</span></li>'
									}
								});
								if (class_flag == 0) {
									A_class = "h-blank";
								} else {
									A_class = "h-aicon";
								}
								str_list =  item.HostServiceName.split('');
								var stp = '';
								for(var i1=0;i1<str_list.length;i1++){
									stp += '<font>'+str_list[i1]+'</font>';
								}
								if (loadlast == 2) {
									$(obj).append('<li><i class="' + A_class + '" data-id="arrS-' + item.HostServiceId + '"/><input type="checkbox" id="nodes-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' checked="checked" data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'"><i class="h-eicon h-eicon-s2"></i><span class="h-name h-name2" id="spans-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" style="width: 12em;">' + '<span class="h-name-son" style="">' + 
											stp + 
											'</span>' + '</span><ul style="display:none">' + $a + '</ul></li>');
								} else {
									$(obj).append('<li><i class="' + A_class + '" data-id="arrS-' + item.HostServiceId + '"/><input type="checkbox" id="nodes-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'"><i class="h-eicon h-eicon-s2"></i><span class="h-name h-name2" id="spans-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" style="width: 12em;">' + '<span class="h-name-son" style="">' + 
											stp + 
											'</span>' + '</span><ul style="display:none">' + $a + '</ul></li>');
								}
						}
					})
				});
				if (flag_change) {
					if (TaskResult.AccountSet != null && editid != 0) {
						var ser_flag = 0;
						var serid_flag = 0;
						var first_serid = 1;
						if (v != 0) {
							$.each(TaskResult.AccountSet, function (i1, item1) {
								if (item1.HGId == parentss_id && item1.HostId == parents_id) {
									$("#nodea-" + parentss_id + '-' + parents_id + '-' + item1.AccountId + '-' + item1.HostServiceId).attr('checked', true);
									$("#nodea-" + parentss_id + '-' + parents_id + '-' + item1.AccountId + '-' + item1.HostServiceId).next('span').attr("class", "checkbox checked");
									$("#nodea-" + parentss_id + '-' + parents_id + '-' + item1.AccountId + '-' + item1.HostServiceId).attr('data-loadfirst', 2);
									$("#nodea-" + parentss_id + '-' + parents_id + '-' + item1.AccountId + '-' + item1.HostServiceId).attr('data-loadlast', 2);

								
									if ($("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).siblings('ul').find('input:checked').length == $("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).siblings('ul').find('input').length) {
										$("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).attr('checked', true);
										$("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).next('span').attr("class", "checkbox checked");
										$("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).attr('data-loadfirst', 2);
										$("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).attr('data-loadlast', 2);
									} else {
										$("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).attr("data-check", "2");
										$("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).attr('data-loadfirst', 1);
										$("#nodes-" + parentss_id + '-' + parents_id + '-' + item1.HostServiceId).attr('data-loadlast', 1);
									}
								}
							})
						}
					}
				}
				if (d == 0) {
					$(obj).find('input').prop('disabled', true);
					if ($(obj).siblings('span.authtype').find('input').length > 0) {
						if ($(obj).siblings('span.authtype').find('input').next('span').attr('class').indexOf('checked') != -1 || $(obj).siblings('input').prop('disabled')) {
						} else {
							$(obj).find('input').each(function () {
								$(this).attr('disabled', false);
								$(this).next('span.checkbox').removeClass('disabled');
							});
						}
					}
				}
				_checkView_host(obj);
				_closeLoading();
			},
			error:function(XmlHttpRequest,textStatus, errorThrown){
				}
			});
		}
	}
}
function recheck(obj) {//展开后有可能父组状态不对，此函数用于展开后判断父组们的节点状态（12.20）
	// obj --> ul
	if($(obj).length == 0) return false;
	var status = "checkbox half";//父组正确状态
	var status_old = $(obj).siblings('.checkbox').attr('class');//父组原来状态
	$(obj).find(".checkbox").not(":visible").remove();
	var s_all = $(obj).find(".checkbox").length;
	if(s_all == 0) return false;
	var s2 = $(obj).find(".checkbox.checked").length;
	var s1 = $(obj).find(".checkbox.half").length;
	var s0 = $(obj).find(".checkbox").length - $(obj).find(".checkbox.checked").length - $(obj).find(".checkbox.half").length;
	if(s_all == s2){
		status = "checkbox checked";
	}
	if(s_all == s0){
		status = "checkbox";
	}
	if(status_old == status){
		return false;
	}else{
		$(obj).siblings(".checkbox").attr("class",status);
		if($(obj).parent().parent()[0].tagName.toLowerCase() == "ul"){
			recheck($(obj).parent().parent());
		}
	}
}


// 绑定 主机组状态
function select_checkbox(select_flag, pid,_ajax_find_host_doing,obj) {
	if (select_flag == "HGroup") { //主机组 
		//var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
		var i = 0;
		var index_w = 0;
		var indx = 0;
		function _doselect() {
			for (i = index_w; i < index_w + 15; i+=5) { //每次只加载一个 根据情况定
				if (i >= push_hgid.length) {
					if (push_hgid.length == 0) {
						clearInterval(if_select);
						return false;
					} else {
						index_w = 0;
						return false;
					}
				}
				var PGetHNodeSelected_json={
					"type":11,
					"id":TID,
					"ishost": false,
					"hnodeset": new Array(),
					"srcinfo":{"usercode":loginusercode,"srcip":IP_ADDR}
				}
				for(var m=i;m<i+5;m++){
					if(m>=push_hgid.length){
						break;
					}
					var hg_id = push_hgid[m].split(":")[0];
					var flag_sec = push_hgid[m].split(":")[1];
					var $hg_pinput = $("#nodehg-"+hg_id).parent().parent().siblings('input');
					var hg_pid = 0;
					if ($hg_pinput.length != 0){
						hg_pid = $hg_pinput.attr('id').split('-')[1];
						if(push_hgid.indexOf(hg_id + ':true')>=0){
							continue;
						}
						if(push_hgid.indexOf(hg_pid + ':false')>=0){
							continue;
						}
						if(push_hgid.indexOf(hg_pid + ':true')>=0){
							continue;
						}
					}
					if(flag_sec == 'false'){
						PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": null,"hid": '+hg_id+'}'));
						push_hgid[m] = hg_id + ":" + "true";
					}
				}

				if(PGetHNodeSelected_json.hnodeset.length>0){
					//push_hgid[i] = hg_id + ":" + "true";
					$.ajax({
						url: '/bhost/PGetHNodeSelected',
						type: 'post',
						async: true,
						/*"IsHNodeSelected"(type, id, NULL, hg."HGId", FALSE) */
						/* 	z1: type type:0-主机管理，1-服务器范围，2-管理授权，3-批量执行，4-工单，5-指令授权，6-改密计划，7-主机信息，8-连通性测试计划*/
						/* 	z2;	id 当前工单授权id*/
						/*	z3:	主机组不填，主机的话，填父组的ID*/
						/*	z4:	主机组 false，主机的话 true  */
						/*	z5:	 当前主机组的id */
						/*
						对于组来说 
						1、Mode = 0，selected = 0   隐藏按组执行
						2、Mode = 0，selected = 1 	隐藏按组执行
						3、Mode = 0，selected = 2	如果是按组执行 	不隐藏按组执行
													如果是不是按组执行 	隐藏按组执行
						4、Mode = 2,				不隐藏按组执行

						对于主机来说
						1、Mode = 0，selected = 0   隐藏主机
						2、Mode = 0，selected = 1 	不隐藏
						3、Mode = 0，selected = 2 	不隐藏
						4、Mode = 2,不隐藏
						*/

						//data: { a0: se, z1: 3, z2: TID, z3: hg_id, z4: false, z5: 'NULL', z6: pid },//hg_id
						data:{a0:se,z1:JSON.stringify(PGetHNodeSelected_json)},//hg_id
						success: function (result) {
							var result = JSON.parse(result);
							var data = result.info;
							$.each(data,function (i,item) {
								var _currentId = $("#nodehg-" + item.hid);
								var _span_authtype = _currentId.siblings('span.authtype');
								var mode = parseInt(_span_authtype.find('input').attr("data-mode"));
								//
								var p_id;
								if (_currentId.parent().parent().siblings("input").length > 0)
									p_id = _currentId.parent().parent().siblings("input").attr('id').split('-')[1];
								else p_id = 0;
								var if_change_parent = false; //主机组是否改变
								var loadlast = 0;
								var _p_loadfirst = $('#nodehg-' + p_id).attr("data-loadfirst");
								var _p_loadlast = $('#nodehg-' + p_id).attr("data-loadlast");

								if (_p_loadfirst == _p_loadlast) { //没改变

								} else {
									if_change_parent = true;
									loadlast = _p_loadlast;
								}
								//_currentId.attr('data-loadlast',true);
								var gl_selected = false;
								if (item.selected == 0) {
									_currentId.next('span').attr("class", "checkbox");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);
									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);

								} else if (item.selected == 1) {
									_currentId.next('span').attr("class", "checkbox half");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);
									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);
								} else {
									_currentId.next('span').attr("class", "checkbox checked");
									_currentId.prop('checked', true);
									_currentId.attr('data-loadfirst', item.selected);
									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);

									//判断该主机组是否是 按组执行
									$.each(last_object, function (i1, item1) {
										if (item1.HGId == item.hid) {
											if (item1.AccountId == null && item1.HostId == null && item1.HostServiceId == null) {
												gl_selected = true;
												return false;
											}
										}
									})
									//
								}

								if (gl_selected) {
									_span_authtype.find('input').attr('data-ifselect', true);
									_currentId.attr('data-ifselect', true);
								} else {
									_span_authtype.find('input').attr('data-ifselect', false);
									_currentId.attr('data-ifselect', false);
								}
								//判断是否隐藏按组执行

								if (mode == 0 && item.selected == 0) { //隐藏按组执行
									_span_authtype.children('label').hide();
								} else if (mode == 0 && data.status == 1) { //隐藏按组执行
									_span_authtype.children('label').hide();
								} else if (mode == 0 && data.status == 2) {
									if (gl_selected) _span_authtype.children('label').show();
									else _span_authtype.children('label').hide();
								} else if (mode == 2) {
									_span_authtype.children('label').show();
								}

								//如果父节点的状态改变了
								//alert(if_change_parent);
								if (if_change_parent == true) {
									if (_p_loadlast == 0) { //1-0 2-0
										_currentId.next('span').attr("class", "checkbox");
										_currentId.prop('checked', false);

										_span_authtype.find('span').attr("class", "checkbox");
										_span_authtype.find('input').prop("checked", false);

										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false) {
											_span_authtype.find('input').prop("disabled", false);
											_currentId.prop('disabled', false);
										}
										_currentId.attr('data-loadfirst',item.selected);
										//
										if(_p_loadfirst == 2) _currentId.attr('data-loadfirst',2);
									} else if (_p_loadlast == 2) {	 // 0-2	 1-2							
										_currentId.prop('checked', true);

										//父节点 按组执行
										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
											_currentId.prop('disabled', true);//input
											_currentId.next('span').attr("class", "checkbox checked disabled");
											//<<<< 
											_currentId.attr("data-loadlast", "2");
											_span_authtype.find('span').attr('class', "checkbox disabled");
											_span_authtype.find('input').prop('disabled', true);

										} else { // 1-0 1-2
											//alert(111);
											_currentId.prop('disabled', false);//input
											_currentId.next('span').attr("class", "checkbox checked");
											_currentId.attr("data-loadlast", "2");

											if (gl_selected) {
												_span_authtype.find('span').attr('class', "checkbox checked");
												_span_authtype.find('input').prop('checked', true).prop('disabled', false);
											} else {
												_span_authtype.find('input').prop('disabled', false);
												_span_authtype.find('span').attr('class', 'checkbox');
											}
										}
									}
								} else {
									//父节点 按组执行
									if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
										_currentId.prop('disabled', true);//input
										_currentId.prop('checked', true);
										_currentId.next('span').attr("class", "checkbox checked disabled");

										if (_p_loadlast == 2) {
											_currentId.attr("data-loadlast", "2");
										}

										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked disabled");
											_currentId.siblings('span.authtype').find('input').prop('checked', true).prop('disabled', true);
										} else {
											_span_authtype.find('input').prop('disabled', true);
											_span_authtype.find('span').attr('class', 'checkbox disabled');
										}
									} else {
										_currentId.attr('disabled', false);//input
										_currentId.next('span').removeClass("disabled");

										if (_p_loadlast == 2) {
											_currentId.prop('checked', true);
											_currentId.attr("data-loadlast", "2");
											_currentId.next('span').attr("class", "checkbox checked");
										}
										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked");
											_span_authtype.find('input').prop('checked', true).prop('disabled', false);
										} else {
											_span_authtype.find('input').prop('disabled', false);
											_span_authtype.find('span').attr('class', 'checkbox');
										}
									}
								}
								if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')) {
									_currentId.prop('checked', true);
									_currentId.prop('disabled', true);//input
									_currentId.next('span').attr("class", "checkbox checked disabled");
									//<<<< 
									_span_authtype.find('span').addClass("disabled");
									_span_authtype.find('input').prop('disabled', true);
								}
								//触发change

								var ind = push_hgid.indexOf(item.hid + ":" + "true");
								if (ind != -1) {
									push_hgid.splice(ind, 1);
									i = 0;
								}
							});
						},
						error: function (XmlHttpRequest, textStatus, errorThrown) {
							var ind = push_hgid.indexOf(hg_id + ":" + "true");
							if (ind >= 0) {
								push_hgid.splice(ind, 1);
								push_hgid.push(hg_id + ":" + "false");
							}
							return false;
						}
					});
				}
			}
			index_w = i;
		}
		var if_select = setInterval(function(){
			if (push_hgid.length == 0){  //
				clearInterval(if_select);
				recheck(obj);
				return false;
			}
			_doselect();	
		},1);
	}else if (select_flag == "Host") { //主机
		var i = 0;
		var index_w = 0;
		var indx = 0;

		function _doselect1() {
			for (i = index_w; i < index_w + 15; i+=5) { //每次只加载一个 根据情况定
				if (i >= push_hid.length) {
					if (push_hid.length == 0) {
						clearInterval(if_select1);
						return false;
					} else {
						index_w = 0;
						i = 0;
						return false;
					}
				}
				var PGetHNodeSelected_json={
					"type":11,
					"id":TID,
					"ishost": true,
					"hnodeset": new Array(),
					"srcinfo":{"usercode":loginusercode,"srcip":IP_ADDR}
				}
				for(var m=i;m<i+5;m++){
					if(m>=push_hid.length){
						break;
					}
					var pid_h = push_hid[m].split(":")[0];
					var h_id = push_hid[m].split(":")[1];
					var flag_sec = push_hid[m].split(":")[2];
					if(push_hid.indexOf(pid_h + ':' + h_id + ":" + "true")>=0){
						continue;
					}
					if(push_hgid.indexOf(pid_h + ':false')>=0){
						continue;
					}
					if(push_hgid.indexOf(pid_h + ':true')>=0){
						continue;
					}
					if(flag_sec == 'false'){
						PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": '+pid_h+',"hid": '+h_id+'}'));
						push_hid[m] = pid_h  + ':' + h_id + ":" + "true";
					}
				}

				if(PGetHNodeSelected_json.hnodeset.length>0){
					atr = $.ajax({
						url: '/bhost/PGetHNodeSelected',
						type: 'post',
						async: true,
						/*"IsHNodeSelected"(type, id, NULL, hg."HGId", FALSE) */
						/* 	z1: type type:0-主机管理，1-服务器范围，2-管理授权，3-批量执行，4-工单，5-指令授权，6-改密计划，7-主机信息，8-连通性测试计划*/
						/* 	z2;	id 当前工单授权id*/
						/*	z3:	主机组不填，主机的话，填父组的ID*/
						/*	z4:	主机组 false，主机的话 true  */
						/*	z5:	当前主机组的id */
						/*	z6:	当前主机组的id*/
						//data: { a0: se, z1: 3, z2: TID, z3: h_id, z4: true, z5: pid_h, z6: pid_h },//hg_id
						data:{a0:se,z1:JSON.stringify(PGetHNodeSelected_json)},//hg_id
						success: function (result) {
							var result = JSON.parse(result);
							data = result.info;
							$.each(data,function (i,item) {
								var p_id = item.parentid;//当前组所在的父组id
								_currentId = $("#nodeh-" + p_id + '-' + item.hid);//当前id
								atr_flag = 1;
								if (_currentId.length == 0) {
									return false;
								}
								var _span_authtype = _currentId.siblings('span.authtype');//当前按组执行
								var li_currentId = _currentId.parent();
								var mode = parseInt(_span_authtype.find('input').attr("data-mode"));
								//
								//var p_id = data.pid;//当前组所在的父组id
								var if_change_parent = false; //主机组是否改变
								var loadlast = 0;
								var _p_loadfirst = $('#nodehg-' + p_id).attr("data-loadfirst");
								var _p_loadlast = $('#nodehg-' + p_id).attr("data-loadlast");
								if (_p_loadfirst == _p_loadlast) { //没改变

								} else {
									if_change_parent = true;
									loadlast = _p_loadlast;
								}

								//绑定 data-loadfirst状态 和 data-loadlast
								var gl_selected = false;
								if (item.selected == 0) {
									_currentId.next('span').attr("class", "checkbox");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);

									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);
								} else if (item.selected == 1) {
									_currentId.next('span').attr("class", "checkbox half");
									_currentId.prop('checked', false);
									_currentId.attr('data-loadfirst', item.selected);

									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);

								} else {
									_currentId.next('span').attr("class", "checkbox checked");
									_currentId.prop('checked', true);
									_currentId.attr('data-loadfirst', item.selected);

									if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
									else _currentId.attr('data-loadlast', loadlast);
									//
									$.each(last_object, function (i1, item1) {
										if (item1.HostId == item.hid && item1.HGId == p_id && item1.AccountId == null && item1.HostServiceId == null) {
											gl_selected = true;
											return false;
										}
									})
								}
								//绑定是否按组执行状态
								if (gl_selected) {
									_span_authtype.find('input').attr('data-ifselect', true);
									_currentId.attr('data-ifselect', true);
								} else {
									_span_authtype.find('input').attr('data-ifselect', false);
									_currentId.attr('data-ifselect', false);
								}
								//判断是否隐藏主机 因为存在 当前用户的管理权限 加了这个
								if(_ajax_find_host_doing==false && tmp_list==null){
									if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
										_currentId.attr('data-mode','2');
										li_currentId.show();
									} else {
										if (mode == 0 && data.status == 0) { //隐藏主机
											li_currentId.hide();
										} else if (mode == 0 && data.status == 1) { //隐藏主机
											_currentId.attr('data-mode','2');
											li_currentId.show();
										} else if (mode == 0 && data.status == 2) {

											_currentId.attr('data-mode','2');
											li_currentId.show();
										} else if (mode == 2) {
											li_currentId.show();
										}
									}
								}else if(_ajax_find_host_doing==true){
									li_currentId.hide();
									if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
										if(mode != 0 || item.selected != 0){
											_currentId.attr('data-mode','2');
											if(_currentId.hasClass("show_input")){
												li_currentId.show();
												_currentId.removeClass('show_input');
											}
										}else{
											_currentId.attr('data-mode','0');
											_currentId.removeClass('show_input');
										}
									}
									else{
										if(mode == 0 && item.selected == 0 ){ //隐藏主机
											_currentId.removeClass('show_input');
										}else if(mode == 0 && item.selected == 1){ //隐藏主机
											_currentId.attr('data-mode','2');
											if(_currentId.hasClass("show_input")){
												li_currentId.show();
												_currentId.removeClass('show_input');
											}
										}else if(mode == 0 && item.selected == 2){
											_currentId.attr('data-mode','2');
											if(_currentId.hasClass("show_input")){
												li_currentId.show();
												_currentId.removeClass('show_input');
											}
										}else if(mode == 2){
											_currentId.attr('data-mode','2');
											if(_currentId.hasClass("show_input")){
												li_currentId.show();
												_currentId.removeClass('show_input');
											}
										}
									}
								}else{
									li_currentId.hide();
									if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
										
										if(mode!=0 || item.selected!=0){
											_currentId.attr('data-mode','2');
											li_currentId.show();
											_currentId.removeClass('show_input');
										}else{
											_currentId.removeClass('show_input');
											li_currentId.hide();
											_currentId.attr('data-mode','0');
										}
										
									}else{
										if(mode == 0 && item.selected == 0 ){ //隐藏主机
											_currentId.removeClass('show_input');
											li_currentId.hide();
										}else if(mode == 0 && item.selected == 1){ //隐藏主机
											_currentId.attr('data-mode','2');
												li_currentId.show();
												_currentId.removeClass('show_input');
											//}
										}else if(mode == 0 && item.selected == 2){
											_currentId.attr('data-mode','2');
												li_currentId.show();
												_currentId.removeClass('show_input');
											//}
										}else if(mode == 2){
												li_currentId.show();
												_currentId.removeClass('show_input');
											//}
										}
									}
								}
								
								//查看 父节点 是否是 1、全选还是空 2、是否按组执行 勾选 / disabled
								/*if (if_change_parent) {
									if (_p_loadlast == 0) {
										_currentId.next('span').attr("class", "checkbox");
										_currentId.prop('checked', false);
										_span_authtype.find('span').attr("class", "checkbox");
										_span_authtype.find('input').prop("checked", false);
										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false) {
											_span_authtype.find('input').prop("disabled", false);
											_currentId.prop('disabled', false);
										}
										if(_p_loadfirst == 2) _currentId.attr('data-loadfirst',2);
									} else if (_p_loadlast == 2) {
										//_currentId.prop('checked', true);

										//父节点 按组执行
										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
											_currentId.prop('disabled', true);//input
											_currentId.next('span').attr("class", "checkbox checked disabled");
											_currentId.attr("data-loadlast", "2");
											_span_authtype.find('input').prop('disabled', true);
											_span_authtype.find('span').attr('class', 'checkbox disabled');

										} else {
											_currentId.prop('disabled', false);//input
											_currentId.next('span').attr("class", "checkbox checked");
											_currentId.attr("data-loadlast", "2");
											if (gl_selected) {
												_span_authtype.find('span').attr('class', "checkbox checked");
												_span_authtype.find('input').prop('checked', true).prop('disabled', false);
											} else {
												_span_authtype.find('input').prop('disabled', false);
												_span_authtype.find('span').attr('class', 'checkbox');
											}
										}
									}
								} else {
									//父节点 按组执行
									if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
										_currentId.prop('disabled', true);//input
										_currentId.next('span').attr("class", "checkbox checked disabled");
										if (_p_loadlast == 2) {
											_currentId.prop('checked', true);
											_currentId.attr("data-loadlast", "2");
										}
										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked disabled");
											_span_authtype.find('input').prop('checked', true).prop('disabled', true);
										} else {
											_span_authtype.find('input').prop('disabled', true);
											_span_authtype.find('span').attr('class', 'checkbox disabled');
										}

									} else {
										_currentId.prop('disabled', false);//input
										_currentId.next('span').removeClass("disabled");
										if (_p_loadlast == 2) {
											_currentId.prop('checked', true);
											_currentId.next('span').attr("class", "checkbox checked");
											_currentId.attr("data-loadlast", "2");
										}
										if (gl_selected) {
											_span_authtype.find('span').attr('class', "checkbox checked");
											_span_authtype.find('input').prop('checked', true).prop('disabled', false);
										} else {
											_span_authtype.find('input').prop('disabled', false);
											_span_authtype.find('span').attr('class', 'checkbox');
										}

									}
								}*/
								//发现父主机组是disabled
								if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')) {
									_currentId.prop('checked', true);
									_currentId.prop('disabled', true);//input
									_currentId.next('span').attr("class", "checkbox checked disabled");
									//<<<< 
									_span_authtype.find('span').addClass("disabled");
									_span_authtype.find('input').prop('disabled', true);
								}

								var ind = push_hid.indexOf(pid + ':' + item.hid + ":" + "true");
								if (ind != -1) {
									push_hid.splice(ind, 1);
									i = 0;
								}
							});
						},
						error: function (XmlHttpRequest, textStatus, errorThrown) {
							return false;
						}
					});
				}
			}
			index_w = i;
		}
		var if_select1 = setInterval(function () {

			if (push_hid.length == 0) {  //
				clearInterval(if_select1);
				recheck(obj);
				return false;
			}
			_doselect1();
		}, 1);
	}
}

var old_path_all = [];
var filter_flag_append = false;
var timeout = [];
var ajax_flag = false;
var host_path_all = [];
var flag_loading = false;
var index_f = 0;
var tmp_list=null;
var tmp_list_path_strarray=[];
var ajax_find_host_doing=false;
var first_find_index=null;
function find_append(){
	ajax_data = [];
	ajax_flag = false;
	var i = 0;
	var t_do1;
	index_f =0;
	function _do1(){
		clearTimeout(t_do1);
		for(i=index_f;i< index_f+50;i++){
			if(ajax_flag == true) {
				t_do1=setTimeout(function () {_do1();},1);
				return false;
			}
				if (flag_loading == true) {
				t_do1=setTimeout(function () {_do1();},1);
				return false;
			}
				if(flag_ajax_true == true)  {
					return false;
				}
			if (i >= host_path_all.length) {
				if (host_path_all.length == 0){
					scrollTop_check_server1();
					return false;
				}else{
					if(ajax_data.length > 0) ajax_host(); //300个检索叫条件里面的主机 都没达到50 也去执行ajax——host
					index_f = 0;
					t_do1=setTimeout(function () {_do1();},1);
					return false;
				}
			}
				if (i %50==0 && i!=0){
					get_msg();
				}
			var Path_array=host_path_all[i].Path.split('/');
			var len=Path_array.length;
			if (len == 2){//主机层
				if($('#nodehg-'+host_path_all[i].Id).length == 0) {
					continue;
					}//
				//show
				$('#nodehg-'+host_path_all[i].Id).parent('li').show();
				$('#nodehg-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
					red_to_font($('#nodehg-'+host_path_all[i].Id),0);
					//$('#nodehg-' + host_path_all[i].Id).siblings('ul').find('li').show();
			}else{
				if (host_path_all[i].Type == 3 || host_path_all[i].Type == 4){ //服务/账号
					for (var j = 1; j < len; j++){
						var id=Path_array[j].split(',')[1];
						s = 0;
						if (j == len-1){ //主机层
							//数据正在展开 留在 host_path_all，下次继续执行
							
							if(flag_loading == true){
								s = 1;
								break;
							}
							//数据未完全展开 留在 host_path_all，下次继续执行
							if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).length == 0){
								continue;
							}
							//show
							$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).parent('li').show();
							red_to_font($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id),0);
							//$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).addClass('show_input');
							$i_item=$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).prev('i');
							if($i_item.attr('class') == "h-blank"){ //
								host_path_all.splice(i,1);	
								//i--;
								s = 1;
								break;
							}
							if (push_hid.indexOf((Path_array[j-1].split(',')[1]+':'+id+':true')) != -1){
								s = 1;
								break;
							}
							if (push_hid.indexOf((Path_array[j-1].split(',')[1]+':'+id+':false')) != -1){
								s = 1;
								break;
							}
							if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).siblings('ul').children('li').length == 0){
								filter_flag_append = true;
								if(ajax_data.length >= MAX_AJAX){
									ajax_host();
									t_do1=setTimeout(function () {_do1();},1);
									return false;
								}else{
									hg_id = Path_array[j-1].split(',')[1];
									inv = ajax_data.indexOf(hg_id + ":" + id);
									if(inv < 0 ) ajax_data.push(hg_id + ":" + id); //没展开的主机 放入ajax_data			
									// if (ajax_data.length >= MAX_AJAX) {
									// 	//去调用 展开的主机
									// 	ajax_host();
									// 	t_do1 = setTimeout(function () { _do1(); }, 1);
									// 	return false;
									// } else {
									// }
								}
							}else{
								if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
									$i_item.trigger('click');
								}
							}	
														
							
						}else{ //主机组层	
							if($('#nodehg-'+id).length == 0) {
								s = 1
								break;//
							}
							if(flag_loading == true){
								s =1;
								break;
							}

							$('#nodehg-'+id).parent('li').show();
								red_to_font($('#nodehg-'+id),0);
							$i_item=$('#nodehg-'+id).prev('i');
							//发现主机或者组 其实下面没数据，跳过该条数据
							if($i_item.attr('class') == "h-blank"){ //
								host_path_all.splice(i,1);	
								//i--;
								s = 1;
								break;
							}
							if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
								filter_flag_append = true;
								$i_item.trigger('click');
							}
						}
					}
					if(s) continue;
					var s = 0;
					if (host_path_all[i].Type == 4){
						if(flag_loading == true) {continue;}
						var hg_id=Path_array[j-2].split(',')[1];
						var h_id=Path_array[j-1].split(',')[1];
						if ($("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent).length == 0){
							continue;
						}
						//show
						$("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent).parent('li').show();
							red_to_font($("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent),0);
						var $i_item = $("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent).prev('i');
						
						if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
							filter_flag_append = true;
							$i_item.trigger('click');
						}
						//show
						$("#nodea-"+hg_id+'-'+h_id+'-'+host_path_all[i].Id+'-'+host_path_all[i].Parent).parent('li').show();
						$("#nodea-"+hg_id+'-'+h_id+'-'+host_path_all[i].Id+'-'+host_path_all[i].Parent).siblings('span.h-name').addClass('h-name-red');
							red_to_font($("#nodea-"+hg_id+'-'+h_id+'-'+host_path_all[i].Id+'-'+host_path_all[i].Parent),0);
					}
					else{
						var all_id = $i_item.siblings('input').attr('id').split('-');
						if ($("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id).length == 0){
							continue;
						}
						//show
						$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id).parent('li').show();
							red_to_font($("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id),0);
						$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
					}
				}else{
					s = 0;
					for (var j = 1; j < len - 1; j++) {
						var id = Path_array[j].split(',')[1];
						if ($('#nodehg-' + id).length == 0) {
							s = 1;
							break;//
						}
						if (flag_loading == true) {
							s = 1;
							break;
						}
						//show
						$('#nodehg-' + id).parent('li').show();
						$i_item = $('#nodehg-' + id).prev('i');

						if ($i_item.attr('class') == "h-blank") { //
							host_path_all.splice(i, 1);
							s = 1;
							break;//
						}
						if (push_hgid.indexOf(Path_array[j - 1].split(',')[1] + ':true') != -1) {
							continue;
						}
						if (push_hgid.indexOf(Path_array[j - 1].split(',')[1] + ':false') != -1) {
							continue;
						}
						if ($('#nodehg-' + id).length > 0) {
							red_to_font($('#nodehg-'+id),0);
							if (($i_item.attr('class').indexOf('h-aicon-d')) == -1) {
								filter_flag_append = true;
								$i_item.click();
							}
						}
					}
					if (s) continue;
					if (host_path_all[i].Type == 1) {
						if ($('#nodehg-' + host_path_all[i].Id).length == 0) continue;//
						//show
						$('#nodehg-' + host_path_all[i].Id).parent('li').show();
						red_to_font($('#nodehg-'+host_path_all[i].Id),0);
						$('#nodehg-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
					}else{
						if ($('#nodeh-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).length == 0) {
							continue;
						}//
						//show
						$('#nodeh-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).parent('li').show();
						red_to_font($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id),0);
						$('#nodeh-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
					}
				}
			}
			//数据展开后 从host_path_all删除掉，并且放在old_path_all，为标红和定位准备
			push_filter_wait.push(host_path_all[i]);
			old_path_all.push(host_path_all[i]);
			host_path_all.splice(i,1);
		}
		index_f = i;
		get_msg();	
		t_do1=setTimeout(function () {_do1();},1);
	}
	_do1();
}

function red_to_font(obj,type){
	var find_array; 
	if (type == 2){
		find_array = find_use_arry;
	}else if (type == 1){
		find_array = (search_typeall_r + search_typeall_new).split('\t');
	}else if (type == 0){
		find_array = find_host_arry;
	}
	$(obj).each(function(i,item){
		var span_obj=$(item).siblings('span.h-name');
		var item_name=span_obj.siblings('input').attr('data-name');
		var Type = span_obj.siblings('input').attr('id');
		var $span_son_font=$('.h-name-son',span_obj).find('font');

		if (type == 0){
			if(Type.indexOf('nodeh')<0){
				var span_son_name=item_name.toLowerCase();
			}else{
				var host_span_arr=item_name.split('\t');
				var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
			}
		}else if (type == 1){
			if(Type.indexOf('HostId')<0){
				var span_son_name=item_name.toLowerCase();
			}else{
				var host_span_arr=item_name.split('\t');
				var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
			}
		}else if (type == 2){
			var span_son_name=item_name.toLowerCase();
		}
		for(var jm=0;jm<find_array.length;jm++){
			var jm_index_ = find_array[jm].indexOf('-');
			if (type == 1){
				if (find_array[jm] == '' || find_array[jm] == undefined || find_array[jm] == null) {
					continue;
				}
				var search_arr = find_array[jm].substr(jm_index_ + 1, find_array[jm].length).split(' ');
			}else if (type == 2){
				var search_arr = find_array[jm].substr(jm_index_ + 1, find_array[jm].length).split(' ');
			}else{
				var search_arr = find_array[jm].substr(jm_index_ + 1, find_array[jm].length).split(' ');
			}
			$.each(search_arr,function(i1,item1){
				if(item1==''){
					return true;
				}
				if (type == 1){
					if (find_array[jm].substr(0, jm_index_) == 'hostname') {
						Name = item_name.split('\t')[1];
						if(Type.indexOf('HostId')<0){
							return true;
						}
					} else if (find_array[jm].substr(0, jm_index_) == 'ip') {
						Name = item_name.split('\t')[0];
						if(Type.indexOf('HostId')<0){
							return true;
						}
					} else if (find_array[jm].substr(0, jm_index_) == 'hgname'){
						Name = item_name;
						if(Type.indexOf('HGId')<0){
							return true;
						}
					}else{
						Name = item_name;
					}
				}
				if (type == 0){
					if (find_array[jm].substr(0, jm_index_) == '组名'){
						Name = item_name;
						if(Type.indexOf('nodehg')<0){
							return true;
						}
					}else if (find_array[jm].substr(0, jm_index_) == '主机名') {
						Name = item_name.split('\t')[1];
						if(Type.indexOf('nodeh')<0 || Type.indexOf('nodehg')>=0){
							return true;
						}
						/*
						if(Type.indexOf('nodeh')<0){
							return true;
						}
						*/
					} else if (find_array[jm].substr(0, jm_index_) == 'IP'){
						Name = item_name.split('\t')[0];
						if(Type.indexOf('nodeh')<0 || Type.indexOf('nodehg')>=0){
							return true;
						}
						/*
						if(Type.indexOf('nodeh')<0){
							return true;
						}
						*/
					}else if (find_array[jm].substr(0, jm_index_) == '服务'){
						Name = item_name;
						if(Type.indexOf('nodes')<0){
							return true;
						}
					}else if (find_array[jm].substr(0, jm_index_) == '账号'){
						Name = item_name;
						if(Type.indexOf('nodea')<0){
							return true;
						}
					}else{
						Name = item_name;
					}
				}
				
				if (type == 2){
					Name = item_name;
					if (find_array[jm].substr(0, jm_index_) == '组名') {
						if(Type.indexOf('nodeug')<0){
							return true;
						}
					} else if (find_array[jm].substr(0, jm_index_) == '账号') {
						if(Type.indexOf('nodeug')>=0){
							return true;
						}
						/*
						if(Type.indexOf('nodeu')<0){
							return true;
						}
						*/
					}
				}
				if(coverString(item1,Name)){
					if (type == 0 || type == 1){
						item1=item1.toLowerCase();
						if(find_array[jm].substr(0, jm_index_).toLowerCase() == '主机名'){
							var index_start=span_son_name.indexOf('(');
							var index_true=span_son_name.indexOf(item1,index_start);
							if(index_true>=0){
								for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
									$span_son_font.eq(i_red_span).addClass('font-red');
								}
							}
						}else{
							var index_true=span_son_name.indexOf(item1);
							if(index_true>=0){
								for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
									$span_son_font.eq(i_red_span).addClass('font-red');
								}
							}
						}
					}else if (type == 2){
						item1=item1.toLowerCase();
						var index_true=span_son_name.indexOf(item1);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}
				}
			});
		}
	});
}

function get_msg(){
	var n=0;
	$.ajax({
		url: '/bhost/get_msg',
		type: "post",
		async:false,
		data: {a0:se},
		success: function(result) {
			var result=JSON.parse(result);
			if(result.Result == false){
				if(result.info.indexOf('系统异常')>=0 || result.info.indexOf('非法访问')>=0 || result.info.indexOf('系统超时') >=0 ){
					_alert(2,'系统',result.info);
				}else{
					_alert(2,'系统',result.info);
				}
			}
			else{
			}
		}
	})
	if(n) return false;	
}
String.prototype.ResetBlank=function(){
	var regEx = /\s+/g; 
	return this.replace(regEx, ' '); 
};
var find_host_arry = [];
var find_host_flag = 0;
var search_typeall_host_r=[];
var search_typeall_host_new='';
var server_text1_v = "";
function _addFilter2(obj, type) {
	if(find_host_loading){
		_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
		return false;
	}
	top1 = 9007199254740992;
	var v2 = $(obj).parent().children('input[type=text]').val().trim();
	var filtername = $("#server_select1").val();
	var filter_flag = 0;
	if (v2 == ""){
		_alert(2, "搜索", "请输入关键字", $("#server_text1"));
		return false;
	}
	v2 = v2.ResetBlank();
	var addfilter = "";
	var addfilter_v = "";
	var addfilter_name = "";
	if (filtername == '0'){
		addfilter_v = v2;
		addfilter = "0-" + v2;
		addfilter_name = "所有";
	}else if (filtername == "1"){
		addfilter = "hgname-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "组名";
	}else if (filtername == "2"){
		addfilter = "hostname-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "主机名";
	}else if (filtername == "3"){
		addfilter = "ip-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "IP";
	}else if (filtername == "4"){
		addfilter = "hostservicename-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "服务";
	}else if (filtername == "5"){
		addfilter = "accountname-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "账号";
	}
	var type_value = true;
	if (type) {
		$("#filterWW2").children('ul').children('li').each(function (i, item) {
			if ($(this).children('span').text() == addfilter_v) {
				filter_flag = 1;
				_alert(1, "访问授权", "相同的关键字已存在", $("#server_text1"));
				return false;
			}
		});
		/*
		if (addfilter_name != "所有"){
			$("#filtername").empty().append('<option value="0">所有</option><option value="'+filtername+'">'+addfilter_name+'</option>');
			$("#filtername").val(filtername).trigger('change');
		}
		*/
		if (filter_flag == 0) {
			$("#server_text1").val("");
			$("#text_check2").hide();
			if (server_text1_v == addfilter){
				type_value = false;
			}
			if (find_host_flag == 1) {
				find_host_arry.splice(-1, 1);
				find_host_flag = 0;
			}
			server_text1_v = "";
			find_host_arry.push(addfilter);
			$('#filterWW2>ul').append('<li style="height: 18px;"><span class="ww" data-value="'+addfilter+'" style="width:9em">' + addfilter_v + '</span><i class="del" style="margin-top: -17px;" onclick="_delFilter2(this)"></i></li>');
			selView2(type_value);
		}
	} else {
		if (server_text1_v == addfilter){
			type_value = false;
		}
		if (find_host_flag != 0) {
			find_host_arry.splice(-1, 1);
		}
		find_host_flag = 1;
		server_text1_v = addfilter;
		//_clearFilter2();
		//find_host_arry=[];
		find_host_arry.push(addfilter);
		selView2(type_value);
	}
}


function _clearFilter2(obj,num) {
	if(num==1){
		top1 = 9007199254740991;
	$("#server_text1").val('');
	$('#server_text_check1').hide();
	find_host_arry = [];
	search_typeall_host_new='';
	selView2(true);
		return;
	}
	top1 = 9007199254740991;
	$("#filterWW2").children('ul').empty();
	$("#filterWW2").hide();
	$("#clearFilter2").hide();
	$("#server_text1").val('');
	$('#server_text_check1').hide();
	find_host_arry = [];
	search_typeall_host_r=[];
	search_typeall_host_new='';
	$("#server_select1").empty().append('<option value="0">所有</option><option value="hgname">组名</option><option value="hostname">主机名</option><option value="ip">IP</option><option value="hostservicename">服务名</option><option value="accountname">账号</option>');
	selView2(true);
}

function _delFilter2(obj) {
	top1 = 9007199254740991;
	var v = $(obj).parent().children('span').eq(0).text();
	// var v = $(obj).parent().children('span').text();
	$(obj).parent().remove();
	search_typeall_host_r.splice($.inArray(v, search_typeall_host_r), 1);
	var filter_name = $("#server_select1").val();
	$.each(search_typeall_host_r,function(i,item){
		var filter_array = item.split('-');
		var filter_v = filter_array.splice(0,1).join('-');
		if (filter_array[0] != "0"){
			$("#server_select1").empty().append('<option value="0">所有</option><option value="'+filter_array[0]+'">'+filter_v+'</option>');
			$("#server_select1").val(filter_name).trigger('change');
			return false;
		}
	});
	if (search_typeall_host_r.length == 0){
		$("#server_select1").empty().append('<option value="0">所有</option><option value="hgname">组名</option><option value="hostname">主机名</option><option value="ip">IP</option><option value="hostservicename">服务名</option><option value="accountname">账号</option>');
		$("#server_select1").val(filter_name).trigger('change');
	}
	// find_host_arry.splice($.inArray(v, find_host_arry), 1);
	selView2(true);
}

function _clear_keyword2(){
	$("#server_text1").val('');
	$("#text_check2").hide();
	if (server_text1_v != ""){
		if(find_host_loading){
			_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
			return false;
		}
		server_text1_v = "";
		find_host_flag = 0;
		find_host_arry.splice(-1,1);
		selView2(true);
	}
}

function change_input(obj){
	if ($(obj).val() == ""){
		if (type == 0){
			if (text_check1 != ""){
				text_check1 = "";
				find_flag = 0;
				find_use_arry.splice(-1,1);
				find_usergroup();
			}
		}else if (type == 1){
			if (search_typeall_new != ""){
				search_typeall_new = "";
				selView1();
			}
		}else if (type == 2){
			if (server_text1_v != ""){
				server_text1_v = "";
				find_host_flag = 0;
				find_host_arry.splice(-1,1);
				selView2();
			}
		}
	}
}

function selView2(type_value) {
	var $sel = $('#filterWW2');
	var len = $('li', $sel).length;

	if (len == 0) {
		$sel.hide();
		$("#clearFilter2").hide();
	} else if (len == 1) {
		$("#filterWW2").show();
		$("#clearFilter2").show();
		$('>span.ww', $sel).show();
		$sel.addClass('selector-multiple');
	} else {
		$("#filterWW2").show();
		$("#clearFilter2").show();
		$('>span.ww', $sel).show();
		$sel.addClass('selector-multiple');
	}
	if (type_value){
		find_host_group();
	}
}
var find_host_loading = false;
function find_host_group() {
	find_host_loading = true;
	_getWait($(".waitTip"));
	/*
	if (find_host_arry.length != 0 && $.inArray(first_find_index, find_host_arry) >= 0) {
		if (ajax_find_host_doing == false) {
			if (mtr == null) {
				_getWait($(".waitTip"));
				//消红+展开标红
				$('#hostTree').find('span.h-name-red').find('.font-red').removeClass('font-red');
				$('#hostTree').find('span.h-name-red').removeClass('h-name-red');
				setTimeout(function () {
					red_to_no_red_and_open_to_red($('#hostTree'),0,0);
				}, 1);
			} else {

			}
		} else {

		}
		return false;
	}
	*/
	//先清空之前的过滤信息
	click_h1();
}
function click_h1() {
	//清空数据
	var i = 0;
	index = 0;
	flag_ajax_true = true;
	$("#hostTree").find('i.h-aicon-d').removeClass('h-aicon-d');
	$("#hostTree").find('ul').hide();
	$("#hostTree").find('li').hide();
	$('#hostTree').find('.font-red').removeClass('font-red');
	$("#hostTree").find('span.h-name-red').removeClass('h-name-red');
	host_path_all = [];
	old_path_all = [];
	push_filter_wait = [];
	click_h0();
}
var mtr = null;
var flag_ajax_true = false;
function click_h0(){
	if(mtr!=null){
		mtr.abort();
		mtr=null;
	}
	flag_ajax_true = true;
	//条件没有的情况 直接返回
	if (JSON.stringify(find_host_arry) == "[]"){
		_waitDone($(".waitTip"));
		$('#hosttree_div1').scrollTop(0);
		tmp_list = null;
		$('#hostTree').find('li').show();
		$("#hostTree").find('i.h-aicon-d').removeClass('h-aicon-d');
		$('#hostTree').find('ul').hide();
		$('#hostTree').find('.font-red').removeClass('font-red');
		$("#hostTree").find('span.h-name-red').removeClass('h-name-red');
		find_host_loading = false;
		return false;
	}
	first_find_index=find_host_arry[0];
	var a=new Array();
	a[0]=find_host_arry[0];	
	mtr = $.ajax({
		url: '/bhost/FindAuthObject_B',
		type: "POST",
		async: true,
		data: {a0:se,a1:JSON.stringify(a),a2:TYPE,a3:3},
		success: function(result){
			mtr=null;
			tmp_list=null;
			flag_ajax_true = false;
			$('#hostTree').find('li').show();
			$('#hostTree').children('li').hide();
			if (result == "None"){
				tmp_list = [];
				$("#server_text1").blur();
				_alert(0,'搜索','无搜索结果',$("#server_text1"));
				_waitDone($(".waitTip"));
				flag_ajax_true = true;
				find_host_loading = false;
				return false;
			}
			tmp_list = JSON.parse(result);
			ajax_find_host_doing=true;

			//把 过滤信息放入 host_path_all 全局变量
			if (tmp_list.length != 0){
				host_path_all = JSON.parse(JSON.stringify(tmp_list));
				flag_ajax_true = false;
				//开始过滤
				find_append();
			}else{
				ajax_find_host_doing=false;
				flag_ajax_true = true;
				$("#server_text1").blur();
				_alert(0,'搜索','无搜索结果',$("#server_text1"));
				_waitDone($(".waitTip"));
				find_host_loading = false;
			}
		}
	});
}

function red_to_no_red_and_open_to_red(obj,num,type){
	var array1; 
	var array2;
	if (type == 2){
		array1 = tmp_list_u;
		array2 = find_use_arry;
	}else if (type == 1){
		find_host_arry_s = (search_typeall_r + search_typeall_new).split('\t');
		array1 = tmp_list_s;
		array2 = (search_typeall_r + search_typeall_new).split('\t');
	}else if (type == 0){
		array1 = tmp_list;
		array2 = find_host_arry;
	}
	for(var i=0;i<array1.length;i++){
		var item=array1[i];
		var pass=true;
		for(var jm=0;jm<array2.length;jm++){
			if (type == 1){
				if (array2[jm] == '' || array2[jm] == undefined || array2[jm] == null) {
					continue;
				}
				var search_arr = array2[jm].substr(array2[jm].indexOf('-') + 1, array2[jm].length).split(' ');
			}else{
				if (array2[jm] == '' || array2[jm] == undefined || array2[jm] == null) {
					continue;
				}
				var jm_index_=array2[jm].indexOf('-');
				var search_arr = array2[jm].substr(jm_index_ + 1, array2[jm].length).split(' ');
			}
			var pass_one=false;
			$.each(search_arr,function(i1,item1){
				if(item1!=''){
					if(array2[jm].substr(0,jm_index_)=='hostname'){
						var Name=item.Name.split('\t')[0];
						if (item.Type!=2){
							return false;
						}
					}else if(array2[jm].substr(0,jm_index_)=='ip'){
						var Name=item.Name.split('\t')[1];
						if (item.Type!=2){
							return false;
						}
					}else if(array2[jm].substr(0,jm_index_)=='hgname'){
						var Name=item.Name;
						if (item.Type!=1){
							return false;
						}
					}else if(array2[jm].substr(0,jm_index_)=='hostservicename'){
						var Name=item.Name.split('\t')[0];
						if (item.Type!=3){
							return false;
						}
					}else if(array2[jm].substr(0,jm_index_)=='accountname'){
						var Name=item.Name;
						if (item.Type!=4){
							return false;
						}
					}else{
						var Name=item.Name;
					}
					if(coverString(item1,Name)){
						pass_one=true;
						return false;
					}
				}
			});
			if(pass_one==false){
				pass=false;
				break;
			}
		}
		if(pass==true){
			if (type == 2){
				open_and_make_red_u(item);
			}else if (type == 1){
				open_and_make_red_s(item);
			}else if (type == 0){
				open_and_make_red(item);
			}
		}else{
		}
	}
	li_red_to_no_red(obj,type);
	//非红隐藏
	//li_hide_while_no_red($('#hostTree'),0);
	_jScrollBar_array = [];
	li_hide_while_no_red(obj,0);
	//定位
	//top_to_move($('#hostTree'));
	top_to_move(obj,type);
}
var filter_flag_append_u = false;
function open_and_make_red_u(item){
	var Path_array=item.Path.split('/');
	var len=Path_array.length;
	for (var j = 1; j < len - 1; j++) {
		var id = Path_array[j].split(',')[1];
		$i_item = $('#nodeug-' + id).siblings('i.h-aicon');
		if (($i_item.attr('class').indexOf('h-aicon-d')) === -1) {
			filter_flag_append_u = true;
			$i_item.trigger('click');
		}
	}
	if (item.Type == 1) {
		$('#nodeug-' + item.Id).siblings('span.h-name').addClass('h-name-red');
	} else {
		$('input[id=nodeu-' + item.Id + ']').siblings('span.h-name').addClass('h-name-red');
	}
}

function open_and_make_red_s(item) {
	var Path_array = item.Path.split('/');
	var len = Path_array.length;
	if (len == 2) {//主机层
		//show
		$('#HGId-' + item.Id).parent('li').show();
		$('#HGId-' + item.Id).siblings('span.h-name').addClass('h-name-red');
	} else {
		if (item.Type == 3 || item.Type == 4) { //服务/账号

		} else {
			for (var j = 1; j < len - 1; j++) {
				var id = Path_array[j].split(',')[1];
				//show
				$('#HGId-' + id).parent('li').show();
				$i_item = $('#HGId-' + id).prev('i');
				if (($i_item.attr('class').indexOf('h-aicon-d')) == -1) {
					filter_flag_append = true;
					$i_item.trigger('click');
				}
			}
			if (item.Type == 1) {
				//show
				$('#HGId-' + item.Id).parent('li').show();
				$('#HGId-' + item.Id).siblings('span.h-name').addClass('h-name-red');
			} else {
				//show

				$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + item.Id).parent('li').show();

				$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + item.Id).siblings('span.h-name').addClass('h-name-red');
			}
		}
	}
}

function open_and_make_red(item){
	var Path_array=item.Path.split('/');
	var len=Path_array.length;
	if (len == 2){//主机层
		//show
		$('#nodehg-'+item.Id).parent('li').show();
		$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
	}else{
		if (item.Type == 3 || item.Type == 4){ //服务/账号
			var s=0;
			for (var j = 1; j < len; j++){
				var id=Path_array[j].split(',')[1];
				if (j == len-1){ //主机层
					//show
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).parent('li').show();
					$i_item=$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).prev('i');
					if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
						$i_item.trigger('click');
					}
				}
				else{ //主机组层
					//show
					$('#nodehg-'+id).parent('li').show();
					$i_item=$('#nodehg-'+id).prev('i');
					if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
						filter_flag_append = true;
						$i_item.trigger('click');
					}
				}
			}
			if(s){
				return false;
			}
			if (item.Type == 4){
				$i_item.siblings('ul').find('input').each(function(i1,item1){
					var checkbox_id = $(item1).attr('id');
					if(checkbox_id==undefined){
						return true;
					}
					if (checkbox_id.indexOf('-') != -1){
						var all_id = checkbox_id.split('-');
						if (all_id.length == 5){
							var hg_id = all_id[1];
							var h_id = all_id[2];
							var a_id = all_id[3];
							var s_id = all_id[4];
							if (a_id == item.Id){
								//show
								$("#nodes-"+hg_id+'-'+h_id+'-'+s_id).parent('li').show();
								var $i_item = $("#nodes-"+hg_id+'-'+h_id+'-'+s_id).prev('i');
								if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
									filter_flag_append = true;
									$i_item.trigger('click');
								}
								//show
								$(item1).parent('li').show();
								$(item1).siblings('span.h-name').addClass('h-name-red');
							}
						}
					}
				})
			}
			else{
				var all_id = $i_item.siblings('input').attr('id').split('-');
				//show
				$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+item.Id).parent('li').show();
				$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+item.Id).siblings('span.h-name').addClass('h-name-red');
			}
				
		}else{
			for(var j=1;j<len-1;j++){
				var id=Path_array[j].split(',')[1];
				//show
				$('#nodehg-'+id).parent('li').show();
				$i_item=$('#nodehg-'+id).prev('i');
				if(($i_item.attr('class').indexOf('h-aicon-d')) == -1){
					filter_flag_append = true;
					$i_item.trigger('click');
				}		
			}
			if(item.Type==1){
				//show
				$('#nodehg-'+item.Id).parent('li').show();
				$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
			}else{
				//show
				$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).parent('li').show();
				$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).siblings('span.h-name').addClass('h-name-red');
			}
		}
	}
}
function top_to_move(obj,type){
	var top_arr=$(obj).find('span.h-name-red');
	if(top_arr.length!=0){
		//$('#hosttree_div1').scrollTop(top_arr.eq(0).offset().top-200);
		$(obj).parent().scrollTop(top_arr.eq(0).offset().top-200);
		if (type == 0){
			_waitDone($(".waitTip"));
		}else{
			_waitDone($(".waitTip"+type));
		}
	}else{
		if (type == 0){
			var $input = $("#keyword");
		}else if (type == 1){
			var $input = $("#server_text");
		}else if (type == 2){
			var $input = $("#server_text1");
		}
		$input.blur();
		_alert(0,'搜索','无搜索结果',$input);
		_waitDone($(".waitTip"+type));
	}
}
var push_filter_wait = [];
var top1 = 9007199254740992;
function scrollTop_check_server1(){
	var i = 0;
	var index_i = 0;
	li_red_to_no_red($('#hostTree'),0);
}
function li_red_to_no_red(obj,type) {
	var red_input = $(obj).find('span.h-name-red');
	var red_input_len=red_input.length;
	var im=0;
	var index_red=0;
	var red_do;
	var find_array; 
	if (type == 2){
		find_array = find_use_arry;
	}else if (type == 1){
		find_array = (search_typeall_r + search_typeall_new).split('\t');
	}else if (type == 0){
		find_array = find_host_arry;
	}
	//_jScrollBar_array = [];
	function red_do_func(){
		clearTimeout(red_do);
		for(im=index_red;im<index_red+100;im++){
			if(im>=red_input_len){
				li_hide_while_no_red(obj, 0);
				if (type == 0){
					if ($('#hostTree').find('span.h-name-red').length == 0) {
						$("#server_text1").blur();
						_alert(0, '搜索', '无搜索结果', $("#server_text1"));
						_waitDone($(".waitTip"));
						flag_ajax_true = true;
						ajax_find_host_doing = false;
						find_host_loading = false;
						return false;
					}
					find_host_loading = false;
					$('#hosttree_div1').scrollTop($('#hostTree').find('span.h-name-red').eq(0).offset().top - 200);
					ajax_find_host_doing = false;
					flag_ajax_true = true;
					_waitDone($(".waitTip"));
					old_path_all = new Array();
					return false;
				}else if (type == 1){
					if ($('#userTree1').find('span.h-name-red').length == 0) {
						$("#server_text").blur();
						_alert(0, '搜索', '无搜索结果', $("#server_text"));
						_waitDone('.waitTip1', 0);
						flag_ajax_true_s = true;
						ajax_find_host_doing_s = false;
						find_server_loading = false;
						return false;
					} else {
						ajax_find_host_doing_s = false;
						find_server_loading = false;
						flag_ajax_true_s = true;
						old_path_all_s = new Array();
						$('#hosttree_div').scrollTop($('#userTree1').find('span.h-name-red').eq(0).offset().top - 200);
						_waitDone('.waitTip1', 3000);
						return false;
					}
				}else if (type == 2){
					if (path_all.length != 0) {
						var top = 9007199254740992;
						$.each(path_all, function (i, item) {
							if (item.Type == 1) {
								var top_item = $('#nodeug-' + item.Id).offset().top;
								if (top_item < top) {
									top = top_item;
								}
							} else {
								var Path_array = item.Path.split('/');
								var len = Path_array.length;
								var top_item = $('#nodeu-' + Path_array[len - 2].split(',')[1]+'-'+item.Id).eq(0).offset().top;
								//$i_item = $('#nodeug-' + Path_array[len - 2].split(',')[1]);
								//var top_item = $i_item.parent().find('input[id=nodeu-' + item.Id + ']').eq(0).offset().top;
								if (top_item < top) {
									top = top_item;
								}
							}
						});
						find_user_loading = false;
						$('#user_module').scrollTop(top - 200);
						_waitDone($(".waitTip2"));
						return false;
					}else{
						find_user_loading = false;
						$("#keyword").blur();
						_alert(0, '搜索', '无搜索结果', $("#keyword"));
						_waitDone($(".waitTip2"));
						return false;
					}
				}
			}
			var item = red_input.eq(im);
			
			var pass = true;
			var item_name = item.siblings('input').attr('data-name');
              var Type = item.siblings('input').attr('id');
              var $span_son_font=$('.h-name-son',item).find('font');
			if (type == 0){
				if(Type.indexOf('nodeh')<0){
					var span_son_name=item_name.toLowerCase();
				}else{
					var host_span_arr=item_name.split('\t');
					var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
				}
			}else if (type == 1){
				if(Type.indexOf('HostId')<0){
					var span_son_name=item_name.toLowerCase();
				}else{
					var host_span_arr=item_name.split('\t');
					var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
				}
			}else if (type == 2){
				var span_son_name=item_name.toLowerCase();
			}
			for (var jm = 0; jm < find_array.length; jm++) {
				var jm_index_ = find_array[jm].indexOf('-');
				if (type == 1){
					if (find_array[jm] == '' || find_array[jm] == undefined || find_array[jm] == null) {
						continue;
					}
					var search_arr = find_array[jm].substr(jm_index_ + 1, find_array[jm].length).split(' ');
				}else if (type == 2){
					var search_arr = find_array[jm].substr(jm_index_ + 1, find_array[jm].length).split(' ');
				}else{
					var search_arr = find_array[jm].substr(jm_index_ + 1, find_array[jm].length).split(' ');
				}
				$.each(search_arr, function (i1, item1) {
					if (type == 0){
						if (find_array[jm].substr(0, jm_index_) == '组名'){
							var Name = item_name;
							if(Type.indexOf('nodehg')<0){
								return false;
							}
						}else if (find_array[jm].substr(0, jm_index_) == '主机名') {
							var Name = item_name.split('\t')[1];
							if(Type.indexOf('nodeh')<0){
								return false;
							}
						} else if (find_array[jm].substr(0, jm_index_) == 'IP'){
							var Name = item_name.split('\t')[0];
							if(Type.indexOf('nodeh')<0){
								return false;
							}
						}else if (find_array[jm].substr(0, jm_index_) == '服务'){
							var Name = item_name;
							if(Type.indexOf('nodes')<0){
								return false;
							}
						}else if (find_array[jm].substr(0, jm_index_) == '账号'){
							var Name = item_name;
							if(Type.indexOf('nodea')<0){
								return false;
							}
						}else{
							var Name = item_name;
						}
					}else if (type == 1){
						if (find_array[jm].substr(0, jm_index_) == 'hostname') {
							Name = item_name.split('\t')[1];
							if(Type.indexOf('HostId')<0){
								return false;
							}
						} else if (find_array[jm].substr(0, jm_index_) == 'ip') {
							Name = item_name.split('\t')[0];
							if(Type.indexOf('HostId')<0){
								return false;
							}
						} else if (find_array[jm].substr(0, jm_index_) == 'hgname'){
							Name = item_name;
							if(Type.indexOf('HGId')<0){
								return false;
							}
						}else{
							Name = item_name;
						}
					}else if (type == 2){
						Name = item_name;
						if (find_array[jm].substr(0, jm_index_) == '组名') {
							if(Type.indexOf('nodeug')<0){
								return false;
							}
						} else if (find_array[jm].substr(0, jm_index_) == '账号') {
							if(Type.indexOf('nodeug')>0 || Type.indexOf('nodeug')==0){
								return true;
							}
							/*
							if(Type.indexOf('nodeu')<0){
								return false;
							}
							*/
						}
					}
					if (coverString(item1, Name)) {
						if (type == 0 || type == 1){
							item1=item1.toLowerCase();
							if(find_array[jm].substr(0, jm_index_) == '主机名'){
								var index_start=span_son_name.indexOf('(');
								var index_true=span_son_name.indexOf(item1,index_start);
								if(index_true>=0){
									for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
										$span_son_font.eq(i_red_span).addClass('font-red');
									}
								}
							}else{
								var index_true=span_son_name.indexOf(item1);
								if(index_true>=0){
									for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
										$span_son_font.eq(i_red_span).addClass('font-red');
									}
								}
							}
						}else if (type == 2){
							item1=item1.toLowerCase();
							var index_true=span_son_name.indexOf(item1);
							if(index_true>=0){
								for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
									$span_son_font.eq(i_red_span).addClass('font-red');
								}
							}
						}
					}
				});
			}
		}
		index_red=im;
		red_do=setTimeout(function(){red_do_func();},1);
	}
	red_do_func();
}

var _jScrollBar_array = [];
function _jScrollBar(scid) {
	var myBar = new MyScrollBar({
		selId:scid,
		hasX:true,
		hasY:false,
		width:6,
		// enterShow:false,
	})
}

function li_hide_while_no_red(obj,num){
	var li_visible=$(obj).children('li');
	for(var i=num;i<num+100;i++){
		if(i>=li_visible.length){
			break;
		}
		var item=li_visible.eq(i);
		var span_id = $(item).children('span.h-name').attr('id');
		if (_jScrollBar_array.indexOf(span_id) === -1){
			_jScrollBar_array.push(span_id);
			_jScrollBar(span_id);
		}
		var span_red_time=$(item).find('span.h-name-red').length;
		if(span_red_time==0){
			$(item).hide();
		}else if(span_red_time>0){
			$(item).show();
			var children_red_time=$(item).children('span.h-name-red').length;
			if(children_red_time>0 && span_red_time==1){
				$(item).children('i.h-aicon-d').removeClass('h-aicon-d');
				$(item).children('ul').hide();
				$(item).find('li').show();
			}
			else if(children_red_time>0 && span_red_time>1){
				$(item).find('li').show();
			}
			else if (children_red_time==0) {
				var $children_ul=$(item).children('ul');
				// setTimeout(function () {li_hide_while_no_red($children_ul,0);},1);
				li_hide_while_no_red($children_ul,0);
			}
		}
	}
	if(i<li_visible.length){
		setTimeout(function () {li_hide_while_no_red(obj,i);},1);
	}
}

//比较IP大小
function _compare_ip(x, y) {
	var ip1 = x.split('.');
	var ip2 = y.split('.');
	for (var i1 = 0; i1 < 4; i1++) {
		if (parseInt(ip1[i1]) < parseInt(ip2[i1])) {
			return 3;
		} else if (parseInt(ip1[i1]) > parseInt(ip2[i1])) {
			return 2
		} else {

		}
	}
	return 1
}

/* 
* 处理过长的字符串，截取并添加省略号 
* 注：半角长度为1，全角长度为2 
*  
* pStr:字符串 
* pLen:截取长度 
*  
* return: 截取后的字符串 
*/
function autoAddEllipsis(pStr, pLen) {
	var _ret = cutString(pStr, pLen);
	var _cutFlag = _ret.cutflag;
	var _cutStringn = _ret.cutstring;

	if ("1" == _cutFlag) {
		return _cutStringn + "...";
	} else {
		return _cutStringn;
	}
}
/* 
* 取得指定长度的字符串 
* 注：半角长度为1，全角长度为2 
*  
* pStr:字符串 
* pLen:截取长度 
*  
* return: 截取后的字符串 
*/
function cutString(pStr, pLen) {
	// 原字符串长度  
	var _strLen = pStr.length;

	var _tmpCode;

	var _cutString;

	// 默认情况下，返回的字符串是原字符串的一部分  
	var _cutFlag = "1";

	var _lenCount = 0;

	var _ret = false;

	if (_strLen <= pLen / 2) {
		_cutString = pStr;
		_ret = true;
	}

	if (!_ret) {
		for (var i = 0; i < _strLen; i++) {
			if (isFull(pStr.charAt(i))) {
				_lenCount += 2;
			} else {
				_lenCount += 1;
			}

			if (_lenCount > pLen) {
				_cutString = pStr.substring(0, i);
				_ret = true;
				break;
			} else if (_lenCount == pLen) {
				_cutString = pStr.substring(0, i + 1);
				_ret = true;
				break;
			}
		}
	}

	if (!_ret) {
		_cutString = pStr;
		_ret = true;
	}

	if (_cutString.length == _strLen) {
		_cutFlag = "0";
	}

	return { "cutstring": _cutString, "cutflag": _cutFlag };
}

/* 
* 判断是否为全角 
*  
* pChar:长度为1的字符串 
* return: true:全角 
*          false:半角 
*/
function isFull(pChar) {
	if ((pChar.charCodeAt(0) > 128)) {
		return true;
	} else {
		return false;
	}
}

function _getWait(obj) {
	if (typeof waitDonelayer != 'undefined') {
		layer.close(waitDonelayer);
	}

	$(obj).removeClass('done').show().unbind().on('mouseover', function () {
		waitlayer = layer.tips('搜索中', this, {
			tips: 1,
			time: 0,
			skin: 'waitlayer'
		});
	}).on('mouseout', function () {
		if (typeof waitlayer != 'undefined') {
			layer.close(waitlayer);
		}
	});

	// //完成
	// setTimeout(function(){
	// 	_waitDone();
	// },3000)
}
function  coverString(subStr,str){
	subStr=subStr.replace(/\?/g, "\\?").replace(/\|/g, "\\|").replace(/\\/g, "\\\\").replace(/\$/g, "\\$").replace(/\(/g, "\\(").replace(/\)/g, "\\)").replace(/\*/g, "\\*").replace(/\./g, "\\.").replace(/\[/g, "\\[").replace(/\^/g, "\\^").replace(/\{/g, "\\{");
	var reg = eval("/"+subStr+"/ig");
	return reg.test(str);
}
function AscSort(a,b){
	a = parseInt(a.split(':')[1]);
	b = parseInt(b.split(':')[1]);
	return a - b;
}
function ajax_host(){
	ajax_flag = true;
	if(ajax_data.length == 0) return ;
	$.ajax({
		url:'/bhost/get_hosts',
		type:'post',
		cache:false,
		async:true,
		data:{a0:se,z1:ajax_data.join(",")},
		beforeSend :function(xmlHttp){ 
			xmlHttp.setRequestHeader("If-Modified-Since","0"); 
			xmlHttp.setRequestHeader("Cache-Control","no-cache");
		},
		success:function(result){
			if(ajax_data.length == 0) return;
			
			results = JSON.parse(result);
			//ajax_data 排序
			ajax_data.sort(AscSort);

			$(results.info).each(function(i,item){
				var adata = item;
				var hgid = ajax_data[i].split(':')[0];
				//
				//改变样式
				
				$('#nodeh-'+hgid+'-'+adata.HostId).prev('i').addClass('h-aicon-d');
				obj = $('#nodeh-'+hgid+'-'+adata.HostId).siblings('ul');
				
				$(obj).empty().show();
				var v = 2,d;
					var $input = $('#nodeh-'+hgid+'-'+adata.HostId).siblings('span.checkbox');
				if($input.length  ==0) return true;
					//d = $(this).siblings('span.authtype').find('input[type=radio]:checked').val();
					if($('#nodeh-'+hgid+'-'+adata.HostId).siblings('span.authtype').find('input').is(':checked')){
						d = 0;
					}else{
					d = 1;
				}
				if ($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
					var c = $input.attr('class');
					if(c.indexOf('checked')>0){
						v=1;
					}else if(c == 'checkbox'){
						v=0;
					}
				
				var flag_change = false;
				var _loadfirst = $(obj).siblings('input.zcheck').attr("data-loadfirst");
				var _loadlast = $(obj).siblings('input.zcheck').attr("data-loadlast");
				var parents_aid = $(obj).siblings('input.zcheck').attr('id').split('-');
				var parents_id = parents_aid[2];
				var parentss_id = parents_aid[1];
				//判断 父节点是否状态改变
				
				var loadfirst = 0;
				var loadlast = 0;
				
				if(_loadfirst == _loadlast){
					if (_loadlast == 2){
						loadfirst = 2;
						loadlast = 2;
					}else if (_loadlast == 1){
						flag_change = true;
					}
				}else{
					if (_loadlast == 2){
						loadlast = 2;
					}
					if (_loadfirst == 2){
						loadfirst = 2;
					}
					//flag_change = true;
				}
				
				$.each(adata.ServiceSet,function(i,item){
					var $a='';
					var class_flag = 0;
					var flag_ser = 0;
					Ser_str = 'G' + hgid+'@H'+adata.HostId+'@S'+item.HostServiceId;
					$.each(Avalible_Account,function(i_a,item_a){
						if(item_a.indexOf(Ser_str) != -1){
							flag_ser = 1;
							return false;
						}
					})
					if(flag_ser == 0){
						return true;
					}
						
					if (ajax_find_host_doing == true && $(obj).siblings('span.h-name-red').length == 0) {
						var li_class_item = 'style="display: none;"';
					} else {
						var li_class_item = '';
					}
					var _jScrollBar_arr=[];
					$.each(adata.AccountSet,function(i2,item2){
						$.each(item2.HostServiceSet,function(i1,item1){
							if (item.HostServiceId == item1.HostServiceId){
								var flag_acc = 0;
								Acc_str = 'G' + hgid+'@H'+adata.HostId+'@S'+item1.HostServiceId+'@A'+item2.HostAccount.AccountId;
								flag_account = $.inArray(Acc_str,Avalible_Account)
								if(flag_account != -1){
									flag_acc = 1;
								}
								if(flag_acc == 0){
									return true;
								}
								class_flag = 1;
								
								str_list = item2.HostAccount.AccountName.split('');
								var stp = '';
								for(var i3=0;i3<str_list.length;i3++){
									stp += '<font>'+str_list[i3]+'</font>';
								}
								
								if (loadlast == 2) {
									$a = $a + '<li ' + li_class_item + '><i class="h-blank" /><input type="checkbox" id="nodea-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' checked="checked" data-name="' + item2.HostAccount.AccountName + '"><i class="h-eicon h-eicon-a2"></i><span class="h-name h-name2" style="margin-top:-6px;width:12em;" id="spana-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '">' + '<span class="h-name-son" style="">' + 
                                                stp+ 
                                                '</span>' + '</span></li>'
								} else {
									$a = $a + '<li ' + li_class_item + '><i class="h-blank" /><input type="checkbox" id="nodea-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-name="' + item2.HostAccount.AccountName + '"><i class="h-eicon h-eicon-a2"></i><span class="h-name h-name2" style="margin-top:-6px;width:12em;" id="spana-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '">' + '<span class="h-name-son" style="">' + 
                                                stp + 
                                                '</span>' + '</span></li>'
								}
								return false;
							}
						})
					});
					if (class_flag == 0){
						A_class = "h-blank";
					}else{
						A_class = "h-aicon";
					}
					str_list = item.HostServiceName.split('');
					var stp = '';
					for(var i3=0;i3<str_list.length;i3++){
						stp += '<font>'+str_list[i3]+'</font>';
					}
					if (loadlast == 2){
						$(obj).append('<li ' + li_class_item + '><i class="'+A_class+'" data-id="arrS-'+item.HostServiceId+'"/><input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' checked="checked" data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'"><i class="h-eicon h-eicon-s2"></i><span class="h-name h-name2" id="spans-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
                                    stp+ 
                                    '</span>'+'</span><ul style="display:none">'+$a+'</ul></li>');
					}else{
						$(obj).append('<li ' + li_class_item + '><i class="'+A_class+'" data-id="arrS-'+item.HostServiceId+'"/><input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'"><i class="h-eicon h-eicon-s2"></i><span class="h-name h-name2" id="spans-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
                                    stp + 
                                    '</span>'+'</span><ul style="display:none">'+$a+'</ul></li>');
					}
				});
				if (flag_change){
					if (TaskResult.AccountSet != null && editid != 0){
						var ser_flag = 0;
						var serid_flag = 0;
						var first_serid = 1;
						if (v != 0){
							$.each(TaskResult.AccountSet,function(i1,item1){
								if (item1.HGId == parentss_id && item1.HostId == parents_id){
									$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('checked',true);				
									$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).next('span').attr("class","checkbox checked");
									$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('data-loadfirst',2);
									$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('data-loadlast',2);
									
									if ($("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).siblings('ul').find('input:checked').length == $("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).siblings('ul').find('input').length){
										$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('checked',true);
										$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).next('span').attr("class","checkbox checked");
										$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadfirst',2);
										$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadlast',2);
									}else{
										$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr("data-check","2");
										$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadfirst',1);
										$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadlast',1);
									}
									return false;
								}
							})
						}
					}
				}
				
				
				if(d==0){
					$(obj).find('input').prop('disabled',true);
					if ($(obj).siblings('span.authtype').find('input').length > 0){
						if ($(obj).siblings('span.authtype').find('input').next('span').attr('class').indexOf('checked') != -1 || $(obj).siblings('input').prop('disabled')){
							
						}else{
							$(obj).find('input').each(function(){
								$(this).attr('disabled',false);
								$(this).next('span.checkbox').removeClass('disabled');
							});
						}
					}
				}
				
				_checkView_host(obj);
			})
			get_msg();
			//50个结束 继续调用 过滤信息
			if(host_path_all.length == 0 && flag_ajax_true == false){
				scrollTop_check_server1();
			}else{
			//	//find_append();
			}
			ajax_flag = false;
			ajax_data = [];		
			return true;
		}
	})	
}

function _waitDone(obj) {
	if (typeof waitlayer != 'undefined') {
		layer.close(waitlayer);
	}
	$(obj).fadeOut(3000);
	if (typeof waitDonelayer != 'undefined') {
		layer.close(waitDonelayer);
	}
}
function save_host(obj){
	$(obj).find('span.checkbox').each(function(i,item){
		if ($(item).parent()[0].tagName == "LABEL") return true;
		var state = $(item).attr('class');
		var $u = $(item).next().next().next().next();
		var $i = $(item).parent().find('ul:first').children('li');
		var $_authtype = $(item).siblings('span.authtype');
		
		var $_input = $(item).prev('input');
		var _id = $_input.attr("id").split('-');
		var loadfirst = $_input.attr('data-loadfirst');
		var loadlast = $_input.attr('data-loadlast');
		
		if($_input.prop("disabled")) return true;
		if(loadfirst != loadlast){
			if ((loadfirst == 0 && loadlast == 2) || (loadfirst == 1 && loadlast == 2)){ //add
				if ($_authtype.length != 0){
					/*if ($_authtype.find('input').length != 0){*/
						if ($_authtype.find('input').prop('checked')){ //按组授权
							if (_id[0] == "nodehg"){
								if (loadfirst == 1 && loadlast == 2){
									var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":true,"IsDelOld":true}';
								}else{
									var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":true}';
								}
								var object_str = JSON.stringify(jsondata.HostSet);
								if (object_str.indexOf(set) === -1){
									jsondata.HostSet.push(JSON.parse(set));
								}
							}else{
								var HGroupId = _id[1]
								var HostId = _id[2];
								if (loadfirst == 1 && loadlast == 2){
									var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth":true,"IsDelOld":true}';
								}else{
									var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth":true}';
								}
								var object_str = JSON.stringify(jsondata.HostSet);
								if (object_str.indexOf(set) === -1){
									jsondata.HostSet.push(JSON.parse(set));
								}
							}
						}else{
							if ($(item).parent().parent().siblings('span.checkbox').length != 0){
								if ($(item).parent().parent().siblings('span.checkbox').attr('class').indexOf('checked') != -1){
									return true;
								}
							}
							if (_id[0] == "nodehg"){
								if (loadfirst == 1 && loadlast == 2){
									var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":false,"IsDelOld":true}';
								}else{
									var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":false}';
								}
								var object_str = JSON.stringify(jsondata.HostSet);
								if (object_str.indexOf(set) === -1){
									jsondata.HostSet.push(JSON.parse(set));
								}
							}else{
								var HGroupId = _id[1]
								var HostId = _id[2];
								if (loadfirst == 1 && loadlast == 2){
									var set = '{"HGId":'+_id[1]+',"HostId":'+HostId+',"IsGroupAuth":false,"IsDelOld":true}';
								}else{
									var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth":false}';
								}
								var object_str = JSON.stringify(jsondata.HostSet);
								if (object_str.indexOf(set) === -1){
									jsondata.HostSet.push(JSON.parse(set));
								}
							}
						}
					/*}else{//未分组
						if (_id[0] == "nodehg"){
							var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":false}';
							var object_str = JSON.stringify(jsondata.HostSet);
							if (object_str.indexOf(set) === -1){
								jsondata.HostSet.push(JSON.parse(set));
							}
						}
					}*/
				}else{ //服务账号
					if ($(item).parent().parent().siblings('span.checkbox').length != 0){
						if ($(item).parent().parent().siblings('span.checkbox').attr('class').indexOf('checked') != -1){
							return true;
						}
					}
					if (_id[0] == "nodes"){
						var HGroupId = _id[1];
						var HostId = _id[2];
						var HostServiceId = _id[3];
						$(item).siblings('ul').children('li').each(function(i1,item1){
							var AccountId = $(item1).children('input').attr('id').split('-')[3];
							var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+'}';
							var object_str = JSON.stringify(jsondata.HostSet);
							if (object_str.indexOf(set) === -1){
								jsondata.HostSet.push(JSON.parse(set));
							}
						})
					}else{
						var HGroupId = _id[1];
						var HostId = _id[2];
						var AccountId = _id[3];
						var HostServiceId = _id[4];
						var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+'}';
						var object_str = JSON.stringify(jsondata.HostSet);
						if (object_str.indexOf(set) === -1){
							jsondata.HostSet.push(JSON.parse(set));
						}
					}
				}
			}else if ((loadfirst == 2 && loadlast == 0) || (loadfirst == 1 && loadlast == 0)){
				var $p_input = $(item).parent().parent().siblings('input');
				if ($p_input.length != 0){
					var p_loadfirst = $p_input.attr('data-loadfirst');
					var p_loadlast = $p_input.attr('data-loadlast');
					if (p_loadfirst == 2 && p_loadlast == 0){
						return true;
					} 
				}
				if (_id[0] == "nodehg"){
					var set = '{"HGId":'+_id[1]+',"HostId":null}';
					var object_str = JSON.stringify(jsondata.DeleteAuthObject);
					if (object_str.indexOf(set) === -1){
						jsondata.DeleteAuthObject.push(JSON.parse(set));
					}
				}else if (_id[0] == "nodeh"){
					var HGroupId = _id[1];
					var HostId = _id[2];
					var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+'}';
					var object_str = JSON.stringify(jsondata.DeleteAuthObject);
					if (object_str.indexOf(set) === -1){
						jsondata.DeleteAuthObject.push(JSON.parse(set));
					}
				}else if (_id[0] == "nodes"){
					var HGroupId = _id[1];
					var HostId = _id[2];
					var HostServiceId = _id[3];
					$(item).siblings('ul').children('li').each(function(i1,item1){
						var AccountId = $(item1).children('input').attr('id').split('-')[3];
						var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+'}';
						var object_str = JSON.stringify(jsondata.DeleteAuthObject);
						if (object_str.indexOf(set) === -1){
							jsondata.DeleteAuthObject.push(JSON.parse(set));
						}
					});
				}else if (_id[0] == "nodea"){
					var HGroupId = _id[1];
					var HostId = _id[2];
					var AccountId = _id[3];
					var HostServiceId = _id[4];
					var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+'}';
					var object_str = JSON.stringify(jsondata.DeleteAuthObject);
					if (object_str.indexOf(set) === -1){
						jsondata.DeleteAuthObject.push(JSON.parse(set));
					}
				}
			}else if (loadfirst == 2 && loadlast == 1){
				if ($_input.attr('data-ifselect') == "true"){
					if (_id[0] == "nodehg"){
						var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":false,"IsDelOld":true}';
						var object_str = JSON.stringify(jsondata.HostSet);
						if (object_str.indexOf(set) === -1){
							jsondata.HostSet.push(JSON.parse(set));
						}
					}else if (_id[0] == "nodeh"){
						var HGroupId = _id[1];
						var HostId = _id[2];
						var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth": false,"IsDelOld":true}';
						var object_str = JSON.stringify(jsondata.HostSet);
						if (object_str.indexOf(set) === -1){
							jsondata.HostSet.push(JSON.parse(set));
						}
					}
				}
			}
		}else{
			if ($_authtype.length != 0){
				if ($_authtype.find('input').length != 0){
					if (($_authtype.find('input').prop('checked')) && ($_input.attr('data-ifselect') == 'false')){ //未按组——>按组授权
						if(_id[0] == 'nodehg') jsondata.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": null,"IsGroupAuth": true,"IsDelOld":true}'));
						else jsondata.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": '+_id[2]+',"IsGroupAuth": true,"IsDelOld":true}'));
					}else if (($_authtype.find('input').prop('checked') == false) && ($_input.attr('data-ifselect') == 'true')){
						if(_id[0] == 'nodehg') {
							jsondata.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": null,"IsGroupAuth": false,"IsDelOld":true}'));
						}else{
							jsondata.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": '+_id[2]+',"IsGroupAuth": false,"IsDelOld":true}'));
						}
					}
				}
			}
		}
	});
}
var jsondata = {
	"BatchPlanName":'test',
	"BatchPlanId": 2,
	"BatchType": 0,							//0.无，1.系统批处理，2.MYSQL，3.ORACLE
	"BatchWork": "echo 'hello'",
	"SSHOpened": false,					//Mysql是否启用ssh通道
	"ClientIp":"192.168.0.1",		//在 PYTHON 中传值
	"Execution": true,					//是否立即执行
	"StartTime": null,					//开始时间
	"PeriodType": 1,						//周期类型 1-天 2-分钟
	"PeriodValue": 0,						//周期数值
	"Enabled": true,						//是否启用
	"Status": 0,								//状态，0-未执行，1-正在执行，2-执行完成      
	"Memo": null,								//备注
	"LoginUserCode": "Super",
	"AuthMode": 1,							//1-按目标，指定账号；2-范围，共有账号；3-范围，所有账号；4-范围，自定义
	"AuthService": null,				//AuthMode=2或3或4时使用，授权服务,如果勾选了所有服务，则为*，否则为null   
	"AuthAccountId": null,			//AuthMode=2或3或4时使用，授权账号  
	"HostSet": [								//AuthMode=1
		{
			"HGId": 0,
			"HostId": null,					//null时，表示勾选的是组
			"IsGroupAuth": true,		//true按主机授权 
			"IsDelOld":true 				//true删除原来对这个组的授权，1.原来是部分选中，现在改成全部选中，2.改变了是否按组授权
		},
		{
			"HGId": 3,
			"HostId": 12,   
			"IsGroupAuth": true 		//true按主机授权  false只取主机下所有账号
		},
	],
	"DeleteAuthObject": [				//AuthMode=1，删除的改密对象
		{
			"HGId": 4,
			"HostId": null 					//null时，表示勾选的是组
		},
		{
			"HGId": 3,
			"HostId": 12
		},
		{
			"HGId": 2,
			"HostId": 11,
			"HostServiceId": 229,
			"AccountId": 1065
		}
	],
	"AuthScope": [							//AuthMode=2或3或4
		{
			"ServerScopeId": 74
		}
	],
	"AuthServiceSet": [					//AuthMode=2或3或4
		{
			"ProtocolId": 3,
			"Port": 1521,  
			"ConnParamId": 50
		}
	]
}
var DeviceType = {
	"ServiceSet": [],
}
function _submit(){

	if ($("#typeSet").val() == 2) { //范围指定
		if ($("#ip_n").find(".ss").length < 2){
			if($("#input1").val() == "" || $("#input2").val() == ""){
				_alert(2, "批量启动", "请添加服务器范围");
				return -1;
			}
		}
		if ($("#define_select").val() == 1) {//已定义
			if ($("#a_mix_select").val() == 1){
				if (accountid.length == 0) {
					_alert(2, "批量执行", "请选择账号");
					return false;
				}
			}
			if ($("#s_mix_select").val() == 1){
				if ($("#service_list2").find('input:checked').length == 0) {
					_alert(2, "批量执行", "请选择服务");
					return false;
				}
			}
			
		} else {//自定义
			if (account_arry.length == 1 && account_arry[0] == '-1') {
				_alert(2, "批量执行", "请选择账号");
				return false;
			}
			if ($("#service_list1").children('tr').length == 0) {
				_alert(2, "批量执行", "请选择服务");
				return false;
			}
		}
	} else {//对象指定

		if ($("#hostTree").find('span.checkbox.half,span.checkbox.checked').length == 0) {
			_alert(2, "批量执行", "请选择对象");
			return false;
		}

	}

	jsondata.BatchPlanId = TID;
	jsondata.BatchType = parseInt($("#PType").val());
	jsondata.BatchPlanName = $("#TaskName").val();

	if($("#PType").val() == 1){
		var BatchWork_tmp = $('#execList').find('li.active').find('.name').text();
		$.each($('#execList').find('li'),function(i,item){
			if($(item).attr('class') != 'active'){
				BatchWork_tmp += ';'+$(item).find('.name').text();
			}
		})
		jsondata.BatchWork = BatchWork_tmp;
	}else if($("#PType").val() == 2){
		jsondata.BatchWork = editor.getValue();
		if($("#SSHOpened").prop('checked') == true){
			jsondata.SSHOpened = true;
		}
	}else{
		jsondata.BatchWork = editor.getValue();
	}

	if($("#execCheck").prop('checked') == false){
		var Date_s = $("#StartDate").val();
		var Hour_s = $("#StartHour").val();
		var Min_s = $("#StartMin").val();
		var Sec_s = $("#StartSec").val();
		var StrTime = Date_s+"T"+Hour_s+":"+Min_s+":"+Sec_s;
		jsondata.Execution = false;
		jsondata.StartTime = StrTime;
		jsondata.PeriodType = parseInt($("#ReType").val());
		jsondata.PeriodValue = parseInt($("#ReContent").val());
		jsondata.Enabled = true;
	}else{
		jsondata.Execution = true;
		jsondata.StartTime = null;
		jsondata.PeriodType = 1;
		jsondata.PeriodValue = 0;
		jsondata.Enabled = true;
	}

	jsondata.Memo = $("#Remark").val();
	jsondata.LoginUserCode = window.parent.document.frm.us.value;
	//保存范围
	//↓↓↓↓↓↓↓↓
	//↓↓↓↓↓↓↓↓
	jsondata.DeleteAuthObject = [];
	jsondata.HostSet = [];
	jsondata.AuthScope = [];
	jsondata.AuthServiceSet = [];
	if ($("#typeSet").val() == 2) { //范围已定义
		if ($("#define_select").val() == 1) {
			if ($("#mix_select").val() == 1) {
				jsondata.AuthMode = 3; //范围所有
			} else if ($("#mix_select").val() == 2) {
				jsondata.AuthMode = 2; //范围共有
			}
		} else { //范围自定义
			jsondata.AuthMode = 4;
		}
	} else { //对象指定
		jsondata.AuthMode = 1;
	}
	if (jsondata.AuthMode == 3 || jsondata.AuthMode == 2) {
		var account_flag = 0;
		if ($("#a_mix_select").val() == 2){
			jsondata.AuthAccountId = "*";
		}else{
			jsondata.AuthAccountId = accountid.join(',');
		}
		if ($("#s_mix_select").val() == 2){
			jsondata.AuthService = '*';
		}else{
			jsondata.AuthService = null; //勾选部分服务
			$.each(AuthServiceSet, function (i, item) {
				var serverset = item.split('-');
				var set = {
					"ProtocolId": 1,
					"Port": 23,
					"ConnParamId": null
				}
				set.ProtocolId = serverset[0];
				set.Port = serverset[2];
				if (serverset[1] != "null") {
					set.ConnParamId = serverset[1];
				} else {
					set.ConnParamId = null;
				}
				jsondata.AuthServiceSet.push(set);
			})
		}
		var tmp2 = {
				"ServerScopeId": 0,
				"Type": 2,
				"IPList": {
					"IPSetId": 0,
					"Set": []
				}
			}
		$.each($("#ip_n").find(".ss"),function(i,item){
			if($(item).attr("id") == "ip_span"){
				if($("#input1").val() == "" || $("#input2").val() == ""){
					return true;
				}
			}
			tmp3 = {
				"IPSetMemberId": 0,
				"Order": 1,
				"StartIP": "192.168.0.18",
				"EndIP": "192.168.0.200"
			}
			tmp3.StartIP = $(item).find("input").eq(0).val();
			tmp3.EndIP = $(item).find("input").eq(1).val();
			tmp2.IPList.Set.push(tmp3);
			add = 1;
		})
		jsondata.AuthScope.push(tmp2);
		// if ($("#ips").data('value') != undefined && $("#ips").data('value') != '-1'){
		// 	var serverid = '{"ServerScopeId":' + $("#ips").data('value') + '}';
		// 	serverid = JSON.parse(serverid);
		// 	jsondata.AuthScope.push(serverid);
		// }
		
		// $('#server_frame_list').children('div:not(:first)').each(function (i, item) {
		// 	var v = $(item).attr('id');
		// 	var serverid = '{"ServerScopeId":' + v + '}';
		// 	serverid = JSON.parse(serverid);
		// 	jsondata.AuthScope.push(serverid);
		// });
		if (editid > 0 && TaskResult.AccountSet != null){
			$.each(TaskResult.AccountSet,function(i,item){
				if (item.AccountName != null){
					var set = '{"HGId":'+item.HGId+',"HostId":'+item.HostId+',"HostServiceId":'+item.HostServiceId+',"AccountId":'+item.AccountId+'}';
					jsondata.DeleteAuthObject.push(JSON.parse(set));
				}else if (item.HostId != null){
					var set = '{"HGId":'+item.HGId+',"HostId":'+item.HostId+'}';
					jsondata.DeleteAuthObject.push(JSON.parse(set));
				}else{
					var set = '{"HGId":'+item.HGId+'}';
					jsondata.DeleteAuthObject.push(JSON.parse(set));
				}
			});
		}
	} else if (jsondata.AuthMode == 4) {
		var tmp2 = {
				"ServerScopeId": 0,
				"Type": 2,
				"IPList": {
					"IPSetId": 0,
					"Set": []
				}
			}
		$.each($("#ip_n").find(".ss"),function(i,item){
			if($(item).attr("id") == "ip_span"){
				if($("#input1").val() == "" || $("#input2").val() == ""){
					return true;
				}
			}
			tmp3 = {
				"IPSetMemberId": 0,
				"Order": 1,
				"StartIP": "192.168.0.18",
				"EndIP": "192.168.0.200"
			}
			tmp3.StartIP = $(item).find("input").eq(0).val();
			tmp3.EndIP = $(item).find("input").eq(1).val();
			tmp2.IPList.Set.push(tmp3);
			add = 1;
		})
		jsondata.AuthScope.push(tmp2);
		// if ($("#ips").data('value') != undefined && $("#ips").data('value') != '-1') {
		// 	var serverid = '{"ServerScopeId":' + $("#ips").data('value') + '}';
		// 	serverid = JSON.parse(serverid);
		// 	jsondata.AuthScope.push(serverid);
		// }
	
		// $('#server_frame_list').children('div:not(:first)').each(function (i, item) {
		// 	var v = $(item).attr('id');
		// 	var serverid = '{"ServerScopeId":' + v + '}';
		// 	serverid = JSON.parse(serverid);
		// 	jsondata.AuthScope.push(serverid);
		// });
		if (editid > 0 && TaskResult.AccountSet != null){
			$.each(TaskResult.AccountSet,function(i,item){
				if (item.AccountName != null){
					var set = '{"HGId":'+item.HGId+',"HostId":'+item.HostId+',"HostServiceId":'+item.HostServiceId+',"AccountId":'+item.AccountId+'}';
					jsondata.DeleteAuthObject.push(JSON.parse(set));
				}else if (item.HostId != null){
					var set = '{"HGId":'+item.HGId+',"HostId":'+item.HostId+'}';
					jsondata.DeleteAuthObject.push(JSON.parse(set));
				}else{
					var set = '{"HGId":'+item.HGId+'}';
					jsondata.DeleteAuthObject.push(JSON.parse(set));
				}
			});
		}
		var arry_f = account_arry.indexOf('-1');
		if (arry_f != -1) {
			account_arry.splice(arry_f, 1);
		}
		jsondata.AuthAccountId = account_arry.join(',');
		jsondata.AuthServiceSet = DeviceType.ServiceSet;
	} else {
		save_host($("#hostTree"));
	}
	var msstr = aceg(JSON.stringify(jsondata),se);
	_showLoading();
	$.ajax({
		url: '/bhost/SaveBatchSTask',
		type: "post",
		async:false,
		data: {a0:se,a1:JSON.stringify(jsondata),a2:editid,a3:jsondata.BatchPlanName,m1:msstr},
		success: function(result) {
			var result=JSON.parse(result);
			_closeLoading();
			if(result.Result == false){
				_alert(1, '批量执行', '保存失败:'+result.ErrMsg);
			}
			else{
				parent.layer.open({
					type: 1,
					title: '批量执行',
					content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
					btn: ['确&nbsp;&nbsp;定'],
					btnAlign: 'c',
					closeBtn: false,
					skin: 'layer-custom',
					area: ['380px', '310px'],
					move: false,
					resize: false,
					yes: function (i) {
						parent.layer.close(i);
						back();
					}
				});
			}
		}
	})	
}
function dataCheck(obj, min, max) {//min can not bigger than 1
	obj.value = obj.value.replace(/\D/g, "");
	if (min) {
		if (parseInt(obj.value, 10) < parseInt(min, 10)) obj.value = min;
	}
	if (max) {
		if (parseInt(obj.value, 10) > parseInt(max, 10)) obj.value = max;
	}
}
function back(){
	$.ajax({
		url: '/bhost/get_current_page',
		type: 'post',
		async: false,
		data: { a0: se, a1: TID, a2: 35 },
		success: function (result) {
			document.frm_batchStart.paging.value = Math.ceil(parseInt(result) / MAX_PAGE);
			document.frm_batchStart.tasktype.value = 3;
			document.frm_batchStart.submit();
		}
	});
}
var Avalible_Account = [];
function get_AccessScope(){
	_showLoading();
	$.ajax({
		url:'/bhost/_get_Access',
		type:"POST",
		async:true,
		data:{a0:se, a1:TYPE},//4是好的     SYSBATCH 'SSH','TELNET','RLOGIN','RDP'
		success: function(Result) {
			_closeLoading();
			Avalible_Account = JSON.parse(Result);
		}
	})
}

//删除ip
function _delIp(obj) {
	var $c = $(obj).parent();
	$c.fadeOut(function () {
		$c.remove();
		add_server();
	});
}
//加入ip
function _addIp(obj) {
	if(type == 1){
		if($("#input1").val() == "" || $("#input2").val() == ""){
			return true;
		}
	}	
	var pass = 1;
	var v1 = $(obj).prev().val().trim();
	var v = $(obj).prev().prev().prev().val().trim();

	if (v == '') {
		_alert(2, '批量执行', '请输入起始IP地址');
		return false;
	} else if (!ipReg.test(v)) {
		_alert(1, '批量执行', '起始IP地址格式不正确');
		return false;
	}
	if (v1 == '') {
		_alert(2, '批量执行', '请输入结束IP地址');
		return false;
	} else if (!ipReg.test(v1)) {
		_alert(1, '批量执行', '结束IP地址格式不正确');
		return false;
	}
	// if (v == v1) {
	// 	_alert(1, '批量执行', '起始IP地址不能大于等于结束IP地址');
	// 	return false;
	// }
	$('>span[class=ss]', '#ip_n').each(function () {
		var input1 = $(this).find('input').eq(0).val();
		var input2 = $(this).find('input').eq(1).val();
		if (input1 == v && input2 == v1) {
			_alert(2, '批量执行', '相同的IP区间已存在');
			pass = 0;
			return false;
		}
	});
	//add zero
	var v_str = v.split(".");
	var v1_str = v1.split(".");
	for (var i = 0; i < 4; i++) {
		if (parseInt(v_str[i]) > parseInt(v1_str[i])) {
			_alert(1, '批量执行', '起始IP地址不能大于等于结束IP地址');
			return false;
		} else if (parseInt(v_str[i]) < parseInt(v1_str[i])) {
			break;
		}
	}
	if (pass == 1 && type != 1) {
		var ip_id = $("#ip_span").attr("value");
		var $c = $('<span class="ss" value="' + ip_id + '" style="float: left;width: 312px;position: static;padding: 0 7px 10px 0;"/>');
		$c.html('<input type="text" class="form-text form-text2" value="' + v + '"  style="width:122px;" disabled>'
			+ '<span style="vertical-align:middle;padding-left: 4px;padding-right: 4px;">-</span>'
			+ '<input type="text" class="form-text form-text2" value="' + v1 + '" style="width:122px;" disabled>'
			+ '<i class="ctr ctr-del" style="margin-top: 5px;margin-left: -3px;" onclick="_delIp(this)"></i>');
		$(obj).parent().after($c);
		$(obj).prev().val("");
		$(obj).prev().prev().prev().val("");
		$(obj).prev().prev().prev().focus();
		$("#ip_span").attr("value", "0");
	}
	add_server();
}
</script>
</body>

</html>
