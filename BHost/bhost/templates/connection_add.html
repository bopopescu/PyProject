<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>manager</title>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<link rel="stylesheet" href="/manage/css/jquery.datepick.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<!--script-->
	<script src="/manage/js/jquery.min.js"></script>
	<script src="/manage/js/jquery.easing.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/layer.js"></script>
	<script src="/manage/js/select2.full.min.js"></script>
	<script src="/manage/js/jquery.plugin.js"></script>
	<script src="/manage/js/jquery.datepick.js"></script>
	<script src="/manage/js/icheck.min.js"></script>
	<script src="/manage/js/common_e.js"></script>

</head>

<body style="overflow:hidden;display:none;" class="bg-white">
	<div class="rwrap">
		<!--连接参数添加或编辑-->
		<div class="c-top">
			<div class="c-title">
				<div class="manual-head" style="float:left;width:100px"> 
    					<div class="manual-title" >
       						<span id="connection_data" style="cursor: pointer;">连接参数</span>
        					<i class="connection_data_icon"></i>
   						</div>
				</div>
				<div class="ctr">
					<a href="javascript:;" class="ret" onclick="parent._closePage(this)"><i></i></a>
				</div>
			</div>
		</div>
		<div class="mainer">
			<div class="container">
				<div class="c-cont">
					<div class="c-form" style="width:870px;">
						<div class="form" style="padding-left:100px;">
							<div class="form-item">
								<span class="form-tag">名称：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="d_n" name="d_n" onblur="if($(this).val()==''){$(this).next().hide();return false;}regCheck(this,nameReg);" maxlength="128">
									<i class="v-check"></i>
									<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>协议：</span>
								<div class="form-c">
									<select class="form-select form-select2" name="Protocol" id="Protocol" style="width:150px;">
										<option value="0" selected>请选择</option>
									</select>
								</div>
								<span class="form-tag" id="Protocol_port"></span>
							</div>
							<!-- SSH -->
							<div id="SSH" style="display:none;">
								<div class="form-item">
									<span class="form-tag">版本号：</span>
									<div class="form-c">
										<select class="form-select" name="ServiceName_ssh" id="ServiceName_ssh" style="width:150px;">
											<option value="1" selected>1</option>
											<option value="2" >2</option>
										</select>
									</div>
								</div>
							</div>
							 <!-- SFTP -->
							<div id="SFTP" style="display:none;">
							  <div class="form-item">
							  	<span class="form-tag">版本号：</span>
							  	<div class="form-c">
							  		<select class="form-select" name="ServiceName_sftp" id="ServiceName_sftp" style="width:150px;">
							  			<option value="1" selected>1</option>
							  			<option value="2" >2</option>
							  		</select>
							  	</div>
							  </div>
							</div>
							<!--HTTP-->
							<div id="HTTP" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>URL：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="url" name="url" maxlength="128" style="width:252px;padding-right:8px;">
										<!-- <p class="form-tip">不能含有特殊字符</p> -->
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">账号元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="UserName" name="UserName" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">密码元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="UserPwd" name="UserPwd" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">提交元素：</span>
									<div class="form-c" style="padding-bottom: 20px;">
										<input type="text" class="form-text" id="Submit" name="Submit" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<!--HTTPs-->
							<div id="HTTPs" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>URL：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="httpsurl" name="httpsurl" maxlength="128" style="width:252px;padding-right:8px;">
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">账号元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="httpsUserName" name="httpsUserName" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">密码元素：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="httpsUserPwd" name="httpsUserPwd" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">提交元素：</span>
									<div class="form-c" style="padding-bottom: 20px;">
										<input type="text" class="form-text" id="httpsSubmit" name="httpsSubmit" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<div id="RDP" style="display:none;">
								<div class="form-item">
									<span class="form-tag">访问方式：</span>
									<div class="form-c">
										<select class="form-select" name="rdpType" id="rdpType" style="width:150px;">
											<option value="NORMAL" text="NORMAL">NORMAL</option>
											<option value="CONSOLE" text="CONSOLE">CONSOLE</option>
										</select>
									</div>
								</div>
							</div>
							<!--ORACLE-->
							<div id="ORACLE" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>指定：</span>
									<div class="form-c">
										<select class="form-select" name="appoint" id="appoint" style="width:150px;">
											<option value="0" text="请选择" selected>请选择</option>
											<option value="SID" text="SID">SID</option>
											<option value="SERVICE_NAME" text="SERVICE_NAME">SERVICE_NAME</option>
										</select>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>实例名或服务名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="s_n" name="s_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">连接方式：</span>
									<div class="form-c">
										<select class="form-select" name="conn" id="conn" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="NORMAL" text="NORMAL">NORMAL</option>
										<option value="SYSDBA" text="SYSDBA">SYSDBA</option>
										<option value="SYSOPER" text="SYSOPER">SYSOPER</option>
									</select>
									</div>
								</div>
							</div>
							<!--RADMIN-->
							<div id="RADMIN" style="display:none;">
								<div class="form-item">
									<span class="form-tag">认证方式：</span>
									<div class="form-c">
										<select class="form-select" name="authtype" id="authtype" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="RADMIN" text="RADMIN">RADMIN</option>
										<option value="Windows" text="Windows">Windows</option>
									</select>
									</div>
								</div>
							</div>
							<!--MSSQL-->
							<div id="MSSQL" style="display:none;">
								<div class="form-item">
									<span class="form-tag"><em class="imp">*</em>实例名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="o_n" name="o_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
								<div class="form-item">
									<span class="form-tag">认证方式：</span>
									<div class="form-c">
										<select class="form-select" name="R_authtype" id="R_authtype" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="SQL服务器验证" text="SQL服务器验证" >SQL服务器验证</option>
										<option value="Windows验证" text="Windows验证" >Windows验证</option>
										<option value="Windows单一登录" text="Windows单一登录" >Windows单一登录</option>
									</select>
									</div>
								</div>
							</div>
							<!--MYSQL &&　DB2-->
							<div id="MY_DB2" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>数据库名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="sql_n" name="sql_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<!-- <div id="MY_ConnType" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>版本号：</span>
									<div class="form-c">
										<select class="form-select" name="select_my" id="select_my" style="width:150px;">
											<option value="0" text="0" selected>&lt;7.5</option>
											<option value="1" text="1" >≥7.5</option>
										</select>
									</div>
								</div>
							</div> -->
							<div id="DB2" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>数据库名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="dbsql_n" name="dbsql_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<!--SYBASE-->
							<div id="SYBASE" style="display:none;">
								<div class="form-item" style="min-height:40px;">
									<span class="form-tag"><em class="imp">*</em>实例名：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="sy_o_n" name="sy_o_n" maxlength="128" style="width:252px;padding-right:8px;">
										<p class="form-tip">不能含有特殊字符</p>
									</div>
								</div>
							</div>
							<!---->
						</div>
					</div>
					<div class="c-form perm_disabled">
						<div class="btns">
							<a href="javascript:;" class="btn btn-normal" onclick="connection_add();">保&nbsp;&nbsp;存</a>
							<!-- <a href="javascript:;" class="btn btn-normal" onclick="connection_list(0);">取&nbsp;&nbsp;消</a> -->
						</div>
					</div>
					<div id="bBtn" style="position: fixed;z-index:5;">
						<a href="javascript:;" class="btn" style="float: right;" onclick="connection_list(0);"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>
	<form action="/bhost/connection_handle" method="POST" name="frm_connection_add" id="frm_connection_add">
		<input type="hidden" name="tasktype" id="tasktype" value="{{ tasktype }}" />
		<!--创建 编辑 列表-->
		<input type="hidden" name="conn_d" id="conn_d" value="{{ conn_d }}" />
		<!--conn_d-->
		<input type="hidden" name="paging" id="paging" value="{{paging}}" />
		<!--页码-->
		<input type="hidden" name="search_typeall" id="search_typeall" value="{{search_typeall}}" />
		<!--search_typeall-->
		<input type="hidden" name="e" id="e" value="{{e}}" />
		<!--e-->
		<input type="hidden" name="se" id="se" value="{{se}}" />
		<!--e-->
	</form>

	<script>

	</script>



	<script>
		var perm={{perm}};
		if (perm==0) parent.parent.$('#nav-s1 a.active').click();
		else{
			$('.bg-white').show();
			if(perm==1){
				$('.perm_disabled').remove();
			}
		}
		$('.form-select:not(.form-select2)').select2({ minimumResultsForSearch: -1 });
		$('.form-select2').select2();
	</script>
	<script>
		var connection = {
			"ConnParamId": 0,
			"ConnParamName": null,
			"ProtocolId": 0,
			"ServiceName": null,
			"ConnType": null,
			"ConnParamValue": null
		};
		var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		var sp_char = /^[^@\/\'\\\"#$%&\^\*|]+$/;
		var ip_all_str = "";
		$(function () {
			// document.frm_connection_add.se.value = window.parent.document.frm.se.value;
			parent._switchBtn(0);//隐藏按钮
			//协议类型下拉框
			var ProtocolId_arr=[9,10,11,12,16,17,18];
			$.ajax({
				url: "/bhost/get_protocol_list",
				type: "POST",
				async: false,
				data: { a0: $("input[name=se]").val(), a3: 30, a2: 1, a4: ",," },
				success: function (result) {
					var userinfo_result = JSON.parse(result);
					var userinfo_data = userinfo_result.data;
					$.each(userinfo_data, function (i, item) {
						if(item.ProtocolId<1000 && $.inArray(item.ProtocolId,ProtocolId_arr)<0){
							$("#Protocol").append('<option value="' + item.ProtocolId + '" text="' + item.ProtocolName + '">' + item.ProtocolName + '</option>');
						}
					});
				}
			});
			//编辑页面
			var tasktype = document.frm_connection_add.tasktype.value;
			if (tasktype == "2") {
				var conn_d = document.frm_connection_add.conn_d.value;
				$.ajax({
					url: "/bhost/get_connection_list",
					type: "POST",
					async: false,
					data: { a0: $("input[name=se]").val(), a1: conn_d },
					success: function (result) {
						var connection_result = JSON.parse(result);
						if (connection_result.Result == true) {
							var connection_data = connection_result.info.data[0];
							$("#d_n").val(connection_data.ConnParamName);
							$("#d_n").attr("disabled", true);
							$("#Protocol").val(connection_data.ProtocolId).trigger('change');
							////console.log(connection_data.ProtocolId);
							$("#HTTP").hide();
							$("#HTTPs").hide();
							$("#ORACLE").hide();
							$("#RADMIN").hide();
							$("#MSSQL").hide();
							$("#SYBASE").hide();
							$("#MY_DB2").hide();
							$('#RDP').hide();
							$("#SSH").hide();
							$('#SFTP').hide();
							$('#MY_ConnType').hide();
							$("#DB2").hide();
							switch (connection_data.ProtocolName) {
								case 'RDP':
									$('#RDP').show();
									$('#rdpType').val(connection_data.ConnType).trigger('change');
									break;
								case 'SSH':
									$('#SSH').show();
									$('#ServiceName_ssh').val(connection_data.ServiceName).trigger('change');
									break;
								case 'SFTP':
									$('#SFTP').show();
									$('#ServiceName_sftp').val(connection_data.ServiceName).trigger('change');
									break;
								//HTTP(S)
								case 'HTTP(S)':
									$("#HTTP").show();
									//
									////console.log("switch 111 HTTP");
									$("#url").val(connection_data.ServiceName);
									var index=connection_data.ConnParamValue.indexOf('|');
									$("#UserName").val(connection_data.ConnParamValue.substring(0,index));
									connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
									var index=connection_data.ConnParamValue.indexOf('|');
									$("#UserPwd").val(connection_data.ConnParamValue.substring(0,index));
									$("#Submit").val(connection_data.ConnParamValue.substring(index+1));
									//
									break;
								//HTTPs
								case 'HTTPS':
									$("#HTTPs").show();
									$("#httpsurl").val(connection_data.ServiceName);
									var index=connection_data.ConnParamValue.indexOf('|');
									$("#httpsUserName").val(connection_data.ConnParamValue.substring(0,index));
									connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
									var index=connection_data.ConnParamValue.indexOf('|');
									$("#httpsUserPwd").val(connection_data.ConnParamValue.substring(0,index));
									$("#httpsSubmit").val(connection_data.ConnParamValue.substring(index+1));
									//
									// connection_data.ConnParamValue = JSON.parse(connection_data.ConnParamValue);
									// ////console.log("switch 111 HTTP");
									// $("#httpsurl").val(connection_data.ServiceName);
									// if (connection_data.ConnParamValue.UserPwd == null) {
									// 	connection_data.ConnParamValue.UserPwd = "";
									// }
									// if (connection_data.ConnParamValue.UserName == null) {
									// 	connection_data.ConnParamValue.UserName = "";
									// }
									// if (connection_data.ConnParamValue.Submit == null) {
									// 	connection_data.ConnParamValue.Submit = "";
									// }
									// $("#httpsUserPwd").val(connection_data.ConnParamValue.UserPwd);
									// $("#httpsUserName").val(connection_data.ConnParamValue.UserName);
									// $("#httpsSubmit").val(connection_data.ConnParamValue.Submit);
									//
									break;
								//ORACLE
								case 'ORACLE':
									//
									////console.log("switch 111 ORACLE");
									if (connection_data.ConnParamValue == null) {
										connection_data.ConnParamValue = 0;
									}
									//指定项必填
									$("#appoint").val(connection_data.ConnParamValue).trigger('change');
									$("#s_n").val(connection_data.ServiceName);
									if (connection_data.ConnType == null) {
										connection_data.ConnType = 0;
									}
									$("#conn").val(connection_data.ConnType).trigger('change');
									//
									$("#ORACLE").show();
									break;
								//RADMIN
								case 'RADMIN':
									//认证方式：
									if (connection_data.ConnType == null) {
										connection_data.ConnType = "0";
									}
									$("#authtype").val(connection_data.ConnType).trigger("change");
									////console.log("switch 111 RADMIN");
									$("#RADMIN").show();
									break;
								//MSSQL
								case 'MSSQL':
									//
									//实例名：
									$("#o_n").val(connection_data.ServiceName);
									//认证方式：
									if (connection_data.ConnType == null) {
										connection_data.ConnType = "0";
									}
									$("#R_authtype").val(connection_data.ConnType).trigger("change");
									//
									$("#MSSQL").show();
									break;
								//MYSQL 
								case 'MYSQL':
									//
									//数据库名：
									$('#sql_n').val(connection_data.ServiceName);
									//
									$('#MY_ConnType').show();
									$("#MY_DB2").show();
									break;
								//DB2
								case 'DB2':
									//
									//数据库名：
									$('#dbsql_n').val(connection_data.ServiceName);
									//
									$("#DB2").show();
									break;
								//SYBASE
								case 'SYBASE':
									//
									//实例名：
									$('#sy_o_n').val(connection_data.ServiceName);
									//
									$("#SYBASE").show();
									break;
							}
						} else {
							_alert(1, '连接参数', connection_result.ErrMsg);
							return false;
						}
					}
				});
			}

			$("#Protocol").change(function () {
				var p_id = $(this).val();
				//console.log(p_id);
				$("#HTTP").hide();
				$("#HTTPs").hide();
				$("#ORACLE").hide();
				$("#RADMIN").hide();
				$("#MSSQL").hide();
				$("#SYBASE").hide();
				$("#MY_DB2").hide();
				$('#RDP').hide();
				$("#SSH").hide();
				$("#SFTP").hide();
				$('#MY_ConnType').hide();
				$("#DB2").hide();
				switch ($('#Protocol option[value='+p_id+']').text()) {
					case "RDP":
						$('#RDP').show();
						break;
					case "SSH":
						$('#SSH').show();
						break;
					case "SFTP":
						$('#SFTP').show();
						break;
					//HTTP(S)
					case "HTTP(S)":
						$("#HTTP").show();
						break;
					//HTTP
					case "HTTPS":
						$("#HTTPs").show();
						break;
					//ORACLE
					case "ORACLE":
						$("#ORACLE").show();
						break;
					//RADMIN
					case "RADMIN":
						$("#RADMIN").show();
						break;
					//MSSQL
					case "MSSQL":
						$("#MSSQL").show();
						break;
					//MYSQL 
					case "MYSQL":
						$("#MY_DB2").show();
						$('#MY_ConnType').show();
						break;
					//DB2
					case "DB2":
						$("#DB2").show();
						break;
					//SYBASE
					case "SYBASE":
						$("#SYBASE").show();
						break;
				}
			});
		});

		function NameRepeatCheck(NameStr){
			$.ajax({
				url: '/bhost/CheckConnName',
				type: "POST",
				async: false,
				data: { a0: $("input[name=se]").val(), a1: NameStr},
				success: function (result) {
					result1 = JSON.parse(result);
				}
			})
			if (result1.Id == 0) {
				return 1;
			}else{
				return -1;
			}
		}
		var match = /^((ht|f)tps?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?$/;
		//创建
		function connection_add() {
			var p_id = $("#Protocol").val();
			var p_name = $("#Protocol").children("option:selected").text();
			////console.log(p_id);
			var val = $("#d_n").val();
			if(val == ""){
				switch (p_name){
					case "RDP":
						ServiceName = p_name+$("#rdpType").val();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
					case "SSH":
						ServiceName = p_name+$("#ServiceName_ssh").val();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
					case "SFTP":
						ServiceName = p_name+$("#ServiceName_sftp").val();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
					case "ORACLE":
						var appoint = $("#appoint").children("option:selected").val();
						if (appoint == "0") {
							_alert(2, "连接参数", "请选择指定项", $("#appoint"));
							return false;
						}
						var s_n = $("#s_n").val();
						if (s_n == "") {
							_alert(2, "连接参数", "请输入实例名或服务名", $("#s_n"));
							//$("#s_n").val("");
							return false;
						} else if (!sp_char.test(s_n)) {
							_alert(1, "连接参数", "实例名或服务名格式不正确", $("#s_n"));
							//$("#s_n").val("");
							return false;
						}
						ServiceName = p_name+$("#s_n").val();
						if(NameRepeatCheck(ServiceName) == -1){
							ServiceName += $("#appoint").children("option:selected").text();
							if(NameRepeatCheck(ServiceName) == -1){
								ServiceName += $("#conn").children("option:selected").text();
								if(NameRepeatCheck(ServiceName) == -1){
									_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
									return false;
								}
							}
						}
						break;
					case "MSSQL":
						var o_n = $("#o_n").val();
						if (o_n == "") {
							_alert(2, "连接参数", "请输入实例名", $("#o_n"));
							//$("#o_n").val("");
							return false;
						} else if (!sp_char.test(o_n)) {
							_alert(1, "连接参数", "实例名格式不正确", $("#o_n"));
							//$("#o_n").val("");
							return false;
						}
						ServiceName = p_name+$("#o_n").val();
						if(NameRepeatCheck(ServiceName) == -1){
							ServiceName += $("#R_authtype").children("option:selected").text();
							if(NameRepeatCheck(ServiceName) == -1){
								_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
								return false;
							}
						}
						break;
					case "MYSQL":
						var sql_n = $("#sql_n").val();
						if (sql_n == "") {
							_alert(2, "连接参数", "请输入数据库名", $("#sql_n"));
							//$('#sql_n').val("");
							return false;
						} else if (!sp_char.test(sql_n)) {
							_alert(1, '连接参数', '数据库名格式不正确', $("#sql_n"));
							//$("#sql_n").val("");
							return false;
						}
						ServiceName = p_name+$("#sql_n").val();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
					case "HTTP(S)":
						var url = $("#url").val();
						if (url == "") {
							_alert(2, "连接参数", "请输入URL", $("#url"));
							return false;
						}
						if (!match.test(url) && url != "") {
							_alert(1, "连接参数", "URL格式不正确", $("#url"));
							//$("#UserPwd").val("");
							return false;
						}
						var UserName = $("#UserName").val();
						//console.log(UserName);
						//console.log(sp_char.test(UserName));
						if (!sp_char.test(UserName) && UserName != "") {
							_alert(1, "连接参数", "账号元素格式不正确", $("#UserName"));
							//$("#UserName").val("");
							return false;
						}
						var UserPwd = $("#UserPwd").val();
						if (!sp_char.test(UserPwd) && UserPwd != "") {
							_alert(1, "连接参数", "密码元素格式不正确", $("#UserPwd"));
							//$("#UserPwd").val("");
							return false;
						}
						var Submit = $("#Submit").val();
						if (!sp_char.test(Submit) && Submit != "") {
							_alert(1, "连接参数", "提交元素格式不正确", $("#Submit"));
							//$("#UserPwd").val("");
							return false;
						}
						ServiceName = "HTTPS"+$("#url").val().split('://')[1].split('/')[0];
						if(ServiceName.indexOf(':') != -1){
							ServiceName = ServiceName.split(':')[0];
						}
						if(NameRepeatCheck(ServiceName) == -1){
							ServiceName += $("#UserName").val();
							if(NameRepeatCheck(ServiceName) == -1){
								ServiceName += $("#UserPwd").val();
								if(NameRepeatCheck(ServiceName) == -1){
									ServiceName += $("#Submit").val();
									if(NameRepeatCheck(ServiceName) == -1){
										_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
										return false;
									}
								}
							}
						}
						break;
					case "RADMIN":
						ServiceName = p_name+$("#authtype").children("option:selected").text();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
					case "SYBASE":
						var sy_o_n = $("#sy_o_n").val();
						if (sy_o_n == "") {
							_alert(2, "连接参数", "请输入实例名", $("#sy_o_n"));
							//$('#sy_o_n').val("");
							return false;
						} else if (!sp_char.test(sy_o_n)) {
							_alert(1, '连接参数', '实例名格式不正确', $("#sy_o_n"));
							//$("#sy_o_n").val("");
							return false;
						}
						ServiceName = p_name+$("#sy_o_n").val();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
					case "DB2":
						var sql_n = $("#dbsql_n").val();
						if (sql_n == "") {
							_alert(2, "连接参数", "请输入数据库名", $("#sql_n"));
							//$('#sql_n').val("");
							return false;
						} else if (!sp_char.test(sql_n)) {
							_alert(1, '连接参数', '数据库名格式不正确', $("#sql_n"));
							//$("#sql_n").val("");
							return false;
						}
						ServiceName = p_name+$("#dbsql_n").val();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
					case "TELNET":
					case "FTP":
					case "VNC":
					case "X11":
					case "RLOGIN":
					case "PCANY":
					case "TN5250":
						ServiceName = p_name;
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
						break;
				}
				val = ServiceName;
			}
			var $i = $("#d_n").next('i.v-check');
			//事件告警信息名
			if (val == "") {
				_alert(2, "连接参数", '请输入名称', $("#d_n"));
				return false;
			}
			if (!nameReg.test(val)) {
				_alert(1, "连接参数", '名称格式不正确', $("#d_n"));
				//$("#d_n").val("");
				return false;
			}
			if (p_id == "0") {
				_alert(2, "连接参数", '请选择协议类型');
				return false;
			}
			connection.ConnParamName = val;
			var conn_d = document.frm_connection_add.conn_d.value;
			connection.ConnParamId = parseInt(conn_d);
			switch ($('#Protocol option[value='+p_id+']').text()) {
				case 'RDP':
					connection.ServiceName = null;
					connection.ConnType = $('#rdpType').val();
					connection.ConnParamValue = null;
					break;
				//SSH
				case "SSH":
					var ServiceName_ssh = $('#ServiceName_ssh').val();
					connection.ServiceName = ServiceName_ssh;
					connection.ConnType = null;
					connection.ConnParamValue = null;
					break;
				case "SFTP":
					var ServiceName_ssh = $('#ServiceName_sftp').val();
					connection.ServiceName = ServiceName_ssh;
					connection.ConnType = null;
					connection.ConnParamValue = null;
					break;
				//HTTP(S)
				case "HTTP(S)":
					//console.log("switchHTTP");
					var url = $("#url").val();
					if (url == "") {
						_alert(2, "连接参数", "请输入URL", $("#url"));
						return false;
					}
					if (!match.test(url) && url != "") {
						_alert(1, "连接参数", "URL格式不正确", $("#url"));
						//$("#UserPwd").val("");
						return false;
					}
					var UserName = $("#UserName").val();
					//console.log(UserName);
					//console.log(sp_char.test(UserName));
					if (!sp_char.test(UserName) && UserName != "") {
						_alert(1, "连接参数", "账号元素格式不正确", $("#UserName"));
						//$("#UserName").val("");
						return false;
					}
					var UserPwd = $("#UserPwd").val();
					if (!sp_char.test(UserPwd) && UserPwd != "") {
						_alert(1, "连接参数", "密码元素格式不正确", $("#UserPwd"));
						//$("#UserPwd").val("");
						return false;
					}
					var Submit = $("#Submit").val();
					if (!sp_char.test(Submit) && Submit != "") {
						_alert(1, "连接参数", "提交元素格式不正确", $("#Submit"));
						//$("#UserPwd").val("");
						return false;
					}
					connection.ServiceName = url;
					connection.ConnType = null;
					var json_a = UserName + '|' + UserPwd + '|' + Submit;
					connection.ConnParamValue = json_a;
					break;
				//HTTPs
				case "HTTPS":
					////console.log("switchHTTP");
					var url = $("#httpsurl").val();
					if (url == "") {
						_alert(2, "连接参数", "请输入URL", $("#httpsurl"));
						return false;
					}
					if (!match.test(url) && url != "") {
						_alert(1, "连接参数", "URL格式不正确", $("#httpsurl"));
						return false;
					}
					var UserName = $("#httpsUserName").val();
					if (!sp_char.test(UserName) && UserName != "") {
						_alert(1, "连接参数", "账号格式不正确", $("#httpsUserName"));
						return false;
					}
					var UserPwd = $("#httpsUserPwd").val();
					if (!sp_char.test(UserPwd) && UserPwd != "") {
						_alert(1, "连接参数", "密码格式不正确", $("#httpsUserPwd"));
						//$("#UserPwd").val("");
						return false;
					}
					connection.ServiceName = url;
					connection.ConnType = null;
					var Submit = $("#httpsSubmit").val();
					if (!sp_char.test(Submit) && Submit != "") {
							_alert(1, "连接参数", "提交元素格式不正确", $("#httpsSubmit"));
							return false;
					}
					// Submit = '"' + Submit + '"';
					// UserName = '"' + UserName + '"';
					// UserPwd = '"' + UserPwd + '"';
					// var json_a = '{"UserName":' + UserName + ',"UserPwd":' + UserPwd + ',"Submit":' + Submit + '}';
					var json_a = UserName + '|' + UserPwd + '|' + Submit;
					connection.ConnParamValue = json_a;
					// connection.ConnParamValue = (JSON.parse(json_a));
					break;
				//ORACLE
				case "ORACLE":
					////console.log("switchORACLE");
					//指定项必填
					var appoint = $("#appoint").children("option:selected").val();
					if (appoint == "0") {
						_alert(2, "连接参数", "请选择指定项", $("#appoint"));
						return false;
					}
					var s_n = $("#s_n").val();
					if (s_n == "") {
						_alert(2, "连接参数", "请输入实例名或服务名", $("#s_n"));
						//$("#s_n").val("");
						return false;
					} else if (!sp_char.test(s_n)) {
						_alert(1, "连接参数", "实例名或服务名格式不正确", $("#s_n"));
						//$("#s_n").val("");
						return false;
					}
					var conn_text = $("#conn").children("option:selected").text();
					if (conn_text == "未指定") {
						conn_text = null;
					}
					var appoint_text = $("#appoint").children("option:selected").text();
					////console.log(appoint+appoint_text);
					connection.ConnParamValue = appoint_text;
					connection.ServiceName = s_n;
					connection.ConnType = conn_text;
					break;
				//RADMIN
				case "RADMIN":
					//认证方式：
					var authtype = $("#authtype").children("option:selected").text();
					if (authtype == "未指定") {
						authtype = null;
					}
					////console.log("switchRADMIN");
					connection.ServiceName = null;
					connection.ConnType = authtype;
					connection.ConnParamValue = null;
					break;
				//MSSQL
				case "MSSQL":
					//实例名：
					var o_n = $("#o_n").val();
					if (o_n == "") {
						_alert(2, "连接参数", "请输入实例名", $("#o_n"));
						//$("#o_n").val("");
						return false;
					} else if (!sp_char.test(o_n)) {
						_alert(1, "连接参数", "实例名格式不正确", $("#o_n"));
						//$("#o_n").val("");
						return false;
					}
					//认证方式：
					var R_authtype = $("#R_authtype").children("option:selected").text();
					if (R_authtype == "未指定") {
						R_authtype = null;
					}
					connection.ServiceName = o_n;
					connection.ConnType = R_authtype;
					connection.ConnParamValue = null;
					break;
				//MYSQL 
				case "MYSQL":
					//数据库名：
					var sql_n = $("#sql_n").val();
					if (sql_n == "") {
						_alert(2, "连接参数", "请输入数据库名", $("#sql_n"));
						//$('#sql_n').val("");
						return false;
					} else if (!sp_char.test(sql_n)) {
						_alert(1, '连接参数', '数据库名格式不正确', $("#sql_n"));
						//$("#sql_n").val("");
						return false;
					}
					// var select_my=parseInt($('#select_my').val());
					connection.ServiceName = sql_n;
					// connection.ConnType = select_my;
					connection.ConnParamValue = null;
					break;
				//DB2
				case "DB2":
					//数据库名：
					var sql_n = $("#dbsql_n").val();
					if (sql_n == "") {
						_alert(2, "连接参数", "请输入数据库名", $("#sql_n"));
						//$('#sql_n').val("");
						return false;
					} else if (!sp_char.test(sql_n)) {
						_alert(1, '连接参数', '数据库名格式不正确', $("#sql_n"));
						//$("#sql_n").val("");
						return false;
					}
					connection.ServiceName = sql_n;
					connection.ConnType = null;
					connection.ConnParamValue = null;
					break;
				//SYBASE
				case "SYBASE":
					//实例名：
					var sy_o_n = $("#sy_o_n").val();
					if (sy_o_n == "") {
						_alert(2, "连接参数", "请输入实例名", $("#sy_o_n"));
						//$('#sy_o_n').val("");
						return false;
					} else if (!sp_char.test(sy_o_n)) {
						_alert(1, '连接参数', '实例名格式不正确', $("#sy_o_n"));
						//$("#sy_o_n").val("");
						return false;
					}
					connection.ServiceName = sy_o_n;
					connection.ConnType = null;
					connection.ConnParamValue = null;
					break;
				default:
					connection.ServiceName = null;
					connection.ConnType = null;
					connection.ConnParamValue = null;
			}
			connection.ProtocolId = parseInt(p_id);
			////console.log(connection);
			var msstr = aceg(JSON.stringify(connection),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_connection',
				type: "POST",
				async: false,
				data: { a0: $("input[name=se]").val(), a1: JSON.stringify(connection) ,m1:msstr},
				success: function (result) {
					var result = JSON.parse(result);
					if (result.Result == true) {
						$('.btn').blur(); parent.layer.open({
							type: 1,
							title: '连接参数',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn: ['确&nbsp;&nbsp;定'],
							btnAlign: 'c',
							closeBtn: false,
							skin: 'layer-custom',
							area: ['380px', '310px'],
							move: false,
							resize: false,
							yes: function (i) {
								parent.layer.close(i);
								connection_list(1,result.ConnParamId);
							}
						});
					} else {
						_alert(1, "连接参数", result.ErrMsg, $("#d_n"));
						return false;
					}
				}
			});
		}
		//显示列表页面
		function connection_list(num,id) {
			if(num==1){
				$.ajax({
					url: '/bhost/PGetRecordRownum',
					type: "POST",
					async: false,
					data: { a0: $("input[name=se]").val(), a1: id,a2:12 },
					success: function (result) {
						var result = JSON.parse(result);
						if (result.Result == true) {
							if(result.info%MAX_PAGE==0){
								document.frm_connection_add.paging.value=parseInt(result.info/MAX_PAGE);
							}else{
								document.frm_connection_add.paging.value=parseInt(result.info/MAX_PAGE)+1;
							}
						}
					}
				});
				document.frm_connection_add.search_typeall.value = '';
				document.frm_connection_add.e.value = ':';
			}
			document.frm_connection_add.tasktype.value = 3;
			document.frm_connection_add.action = '/bhost/connection_handle'
			document.frm_connection_add.submit();
		}


$(function(){
	
	$("#connection_data").on("click",function(){
		connection_update();
	});
});
function connection_update() {
	document.frm_connection_add.action = '/bhost/connection_handle';
	document.frm_connection_add.submit()
}

	</script>
</body>

</html>
