<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>manager</title>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<link rel="stylesheet" href="/manage/css/jquery.datepick.css">
	<!--script-->
	<script src="/manage/js/jquery.min.js"></script>
	<script src="/manage/js/jquery.easing.js"></script>
	<script src="/manage/js/layer.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/common_e.js"></script>
	<script src="/manage/js/jquery.plugin.js"></script>
	<script src="/manage/js/jquery.datepick.js"></script>
	<!--icheck-->
	<script src="/manage/js/icheck.min.js"></script>
	<!--select2-->
	<script src="/manage/js/select2.full.min.js"></script>
	<link rel="stylesheet" href="/manage/css/new-head.css">

</head>
<body style="overflow:hidden;" class="bg-white">
		<div class="c-top">
			<!-- <div class="c-title">
				<div class="manual-head" style="float:left;width:100px;">
					<div class="manual-title title-item" id="">
						<span id="route_set" style="cursor: pointer;">路由设置</span>
						<i class="route_icon"></i>
					</div>	
				</div>
				<div class="ctr">
					<a href="javascript:;" class="ret" onclick="parent._closePage(this)"><i></i></a>
				</div>
			</div> -->
		</div>
		<div class="mainer">
			<div class="container">
				<div class="c-cont">
					<div class="form-item" style="width: 20%; position: absolute; padding-top: 50px; z-index: 9;">
						<div class="form-c" style="position: absolute; padding-left: 50px;">
							<select class="form-select" name="edit_type" id="edit_type" style="width:152px;" onchange="change_type();">
								<option value="0">网络</option>
								<option value="1" selected>路由</option>
							</select>
						</div>
					</div>				
					<div class="c-form" style="padding-bottom:10px;width: 66%;min-width: 900px;">
						<div class="form">
							<div class="form-item">
								 <span class="form-tag"><em class="imp">*</em>服务器：</span>
									<div class="form-c">
										<select class="form-select" name="server_select" id="server_select" style="width:172px;" maxlength = "64">
										<option value="-1">选择</option>
										</select>
									</div>	
							</div>
							<div class="form-item">
								 <span class="form-tag"><em class="imp">*</em>网口：</span>
								<div class="form-c">
									<select class="form-select" name="ipv4_select" id="ipv4_select" style="width:172px;" maxlength = "64">
									<option value="-1">选择</option>
								</select>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>网关地址：</span>
								<div class="form-c">
									<input class="form-text" type="text" id="gw_addr" style="width:140px;" maxlength = "64" onblur="IpCheck(this);" /><i class="v-check"></i>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag">下一跳地址：</span>		
								<div class="form-c">
									<input class="form-text" type="text" id="next_addr" style="width:140px;" maxlength = "64" onblur="IpCheck(this);" /><i class="v-check"></i>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag">子网掩码：</span>
								<div class="form-c">
									<input class="form-text" type="text" id="netmask" style="width:140px;" maxlength = "64" onblur="IpCheck(this);" /><i class="v-check"></i>
								</div>
							</div>
						</div>
						<div class="btns s-hide">
							<a href="javascript:;" class="btn btn-submit btn-normal" onclick="SaveSet();">保&nbsp;&nbsp;存</a>
							<!--
							<a href="javascript:;" class="btn btn-cancel btn-normal" onclick="routelist_back(1);">取&nbsp;&nbsp;消</a>
							-->
						</div>
						<div id="bBtn" style="position: fixed;z-index:5;">
							<!-- <a href="javascript:;" class="btn" style="float: right;" onclick="routelist_back(1);"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a> -->
						</div>
					</div>
				</div>
			</div>
		</div>	


    <div class="form-btns">
        <a class="btn btn-submit" href="javascript:;">确&nbsp;&nbsp;定</a>
        <a class="btn btn-cancel" href="javascript:;">取&nbsp;&nbsp;消</a>
    </div>
</div>
	<form action="/bhost/route_show" method="POST" name="frm_routelist" id="frm_routelist">
		<input type="hidden" name="z1" id = "z1" value="" />
		<input type="hidden" name="z2" id = "z2" value="" />
		<input type="hidden" name="z3" id = "z3" value="" />
		<input type="hidden" name="z4" id = "z4" value="" />
		<input type="hidden" name="z5" id = "z5" value="" />
		<input type="hidden" name="a0" value="{{se}}"/>
		<input type="hidden" name="se" value="{{se}}"/>
	</form>
<script>
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
	
</script>
<style>
.c-form{
	margin-left: 150px;
}
.form-item{
	width: 50%;
	float: left;
	height: 30px;
}
</style>
<script>
$('.form-select').select2({minimumResultsForSearch: -1});
//$(".form-tag").css("width","290px");
</script>
<!---->
<script>
var ipage="{{ipage}}";
var route_id="{{route_id}}"
var keyword_re = "{{keyword|safe}}";
var filter_flag = "{{filter_flag}}";
var selectid = "{{selectid|safe}}";
var se;

$(function(){
	if(parent.is_guide == 1){
		$('a.ret').parent().hide();
	}
	_if_disable = $('#nav-s1 li[data-modeid=7]',parent.parent.document).attr('_if_disable');
	if(_if_disable == '1'){
		$('.s-hide').remove();
	}
	$("#int_set").on("click",function(){
		parent.reload();
	});
	$("#route_set").on("click",function(){
		//routelist_back();
		document.frm_routelist.action='/bhost/create_route';
		document.frm_routelist.z1.value = ipage;
		document.frm_routelist.z2.value = route_id;
		document.frm_routelist.z3.value = JSON.stringify(keyword_re);
		document.frm_routelist.z4.value = filter_flag;
		document.frm_routelist.z5.value = JSON.stringify(selectid);
		document.frm_routelist.submit();
	});
	se = {{se}};
	binding_server();

	if (route_id != "0"){
		$.ajax({
			url:'/bhost/select_route_all',
			type:'post',
			async:false,
			data:{a0:se,z1:route_id,z2:0},
			success:function(result){
				route_data = JSON.parse(result);
				$("#server_select").val(route_data.data[0].server_id);
				binding_ipv4();
				$("#ipv4_select").val(route_data.data[0].ipv4_id);
				$("#gw_addr").val(route_data.data[0].gw_addr);
				$("#next_addr").val(route_data.data[0].next_addr);
				$("#netmask").val(route_data.data[0].netmask);
			}
		})
	}
})

function change_type(){
	if($("#edit_type").val() == 0){
		///export_handle?tasktype=1&export_d=0&search_typeall=&e=:undefined-undefined&se=1542856781136&a0=1542856781136&title_flag=1&paging=1
		$("#mframe1", parent.document).attr('src','/bhost/export_handle?tasktype=1&export_d=0&search_typeall=&e=&se='+se+'&a0='+se+'&title_flag=1&paging=1')
	}else if($("#edit_type").val() == 1){
		// /console.log("29");
		
	}
}

function binding_server(){
	$.ajax({
		url:'/bhost/get_serverglobal',
		type:'post',
		async:false,
		data:{a0:se},
		success:function(result){
			data = JSON.parse(result);
			$.each(data.data,function(i,item){
				$("#server_select").append("<option value=\""+item.server_id+"\">"+item.server_id+"</option>");
			})
		}
	})
	$("#server_select").change(function(){
		if ($("#server_select").val() != '-1'){
			binding_ipv4();
		}else{
			$("#ipv4_select").empty();
			$("#ipv4_select").append("<option value=\"-1\">选择</option>");
		}
	})
}

function binding_ipv4(){
	var id = $("#server_select").val();
	$.ajax({
		url:'/bhost/get_server_ipv4',
		type:'post',
		async:false,
		data:{a0:se,z1:id,z2:0},
		success:function(result){
			data = JSON.parse(result);
			$("#ipv4_select").empty().append("<option value=\"-1\">选择</option>");;
			$.each(data.data,function(i,item){
				if(item.status == 2) return true;
				$("#ipv4_select").append("<option value=\""+item.ipv4_id+"\">"+item.netdev_name+"</option>");
			});
		}
	});
}


var ipcheck_route=/(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

function IpCheck(obj){
	var name = $(obj).val();
	var $i = $(obj).next('i.v-check');
	
	if (!ipcheck_route.test(name)){
		$i.show().attr('class','v-check v-wrong');
	}else{
		$i.show().attr('class','v-check v-right');
	}
}


function routelist_back(type){
	
	if (type == 2){
		keyword_re = [];
		if (parseInt(route_id) != 0){
			$.ajax({
				url:'/bhost/get_index',
				type:'post',
				async:false,
				data:{a0:se,z1:route_id,z2:28},
				success:function(result){
					ipage = Math.ceil(parseInt(result)/MAX_PAGE);
				}
			});
		}else{
			$.ajax({  
				url:'/bhost/get_route_list',
				type:"post",
				async:false,
				data:{a0:se,z4:"null",z5:"null",z6:JSON.stringify(keyword_re)},
				success:function(result){
					var result = JSON.parse(result);
					var remain = parseInt(result.totalrow) % MAX_PAGE;
					if (remain > 0){
						ipage = Math.ceil(parseInt(result.totalrow)/MAX_PAGE);
					}else{
						ipage = parseInt(result.totalrow)/MAX_PAGE + 1;
					}
				}
			});
		}
	}
	var deliver = JSON.stringify(keyword_re);
	document.frm_routelist.z1.value = ipage;
	document.frm_routelist.z2.value = deliver;
	document.frm_routelist.z3.value = filter_flag;
	document.frm_routelist.z4.value = JSON.stringify(selectid);
	document.frm_routelist.action='/bhost/route_show';
	document.frm_routelist.submit();
}

function SaveSet(){
	var server_id = $("#server_select").val();
	var ipv4_id = $("#ipv4_select").val();
	var gw_addr = $("#gw_addr").val();
	var next_addr = $("#next_addr").val();
	var netmask = $("#netmask").val();
	var route_type = "default";
	
	if(route_id == '0'){
		oper = "创建路由：（"
	}else{
		oper = "编辑路由：（"
	}
	
	if (server_id == "-1"){
		_alert(2,"路由设置","请选择服务器");
		return;
	}
	oper +="服务器："+server_id+"，";
	if (ipv4_id == "-1"){
		_alert(2,"路由设置","请选择网口");
		return;
	}
	oper +="网口："+$("#ipv4_select option:selected").text()+"，";
	if (gw_addr == ""){
		_alert(2,"路由设置","请输入网关地址",$("#gw_addr"));
		return;
	}
	if (!ipcheck_route.test(gw_addr)){
		_alert(1,"路由设置","网关地址格式不正确",$("#gw_addr"));
		return;
	}
	oper +="网关地址："+gw_addr+"，";
	if (!ipcheck_route.test(next_addr) && next_addr != ""){
		_alert(2,"路由设置","请输入正确的下一跳转地址",$("#next_addr"));
		return;
	}
	oper +="下一跳转地址："+next_addr+"，";
	if (!ipcheck_route.test(netmask) && netmask != "" && mask_addr !='255.255.255.255'){
		_alert(2,"路由设置","请输入正确的子网掩码",$("#netmask"));
		return;
	}
	oper +="子网掩码："+netmask+"）";
	
	if (next_addr != ""){
		route_type = "net";
	}
	$.ajax({
		url:'/bhost/save_route',
		type:'post',
		async:false,
		data:{a0:se,z1:route_id,z2:ipv4_id,z3:gw_addr,z4:next_addr,z5:netmask,z6:route_type,z7:server_id,o1:oper},
		success:function(Result){
			data = JSON.parse(Result);
			//console.log(data.Result);	
			if (data.Result == false){
				_alert(1,"路由设置","保存路由：" + data.ErrMsg);
			}else{
				$('.btn').blur();
				parent.layer.open({
					type:1,
					title:"路由设置",
					content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
					btn:['确定'],
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						parent.layer.close(i);
						//routelist_back(2);
						window.parent.refresh();
						parent.d_authtype.close().remove();

					},
					btn2:function(i){
						parent.layer.close(i);
					}
				});	
			}
		}
	});
}
</script>
</body>
</html>
