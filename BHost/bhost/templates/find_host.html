{% extends  "index.html" %}
{% block head %}
	<!--icheck-->
	<script src="/manage/js/icheck.min.js"></script>
	<script src="/manage/js/select2.full.min.js"></script>
	<script src="/manage/js/common_e.js"></script>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
{% endblock  %}
{% block main %}
<!---->
	<div class="mainer">
		<!-- 创建 -->
		<div class="container" style="display:none">
			<div class="manual-head">
				<div class="manual-title">
					<span onclick="reload(1);">发现主机</span>
					<i class="findhost_icon"></i>
				</div>						
			</div>
			<div class="c-cont">
				<div class="c-form" style="padding-bottom:10px;">
					<div class="form">	
						<div class="form-item" >
							<span class="form-tag"><em class="imp">*</em>任务名称：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="t_n" name="t_n" style="width: 298.5px; "maxlength="128" onblur="regCheck(this,nameReg);">
								<i class="v-check"></i>
								<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
							</div>
						</div>
					</div>
				</div>
				<div class="c-form c-form-host"style="width:780px;min-width:780px;padding-top:0px;">
					<div class="form">
						<div class="form-item form-item-100 " style="width:900px;font-size:16px;">
							<span class="form-tag"style="width:192px;" ><em class="imp">*</em>检测网段：</span>
							<div id="nw_s" name="nw_s" class="form-c"style="padding-left:10px; float: left;width:560px;">
								<span class="ss ss-add" style = "width: 350px; margin-top: 0;">
									<input type="text" style="" class="form-text form-text2"> -
									<input type="text" style="" class="form-text form-text2">
									<i class="ctr ctr-add" onclick="_addIp(this)" id = "add2" style="margin-top: 9px;    margin-left: 3px;"></i>
								</span>
							</div>
						</div>
					</div>
				</div>
				<div class="c-form c-form-host"style="width:780px;min-width:780px;padding-top:0px;">
					<div class="form">
						<div class="form-item form-item-100 " style="width:900px;font-size:16px;">
							<span class="form-tag"style="width:192px;" >检测服务：</span>
							<div id="d_s" name="d_s" class="form-c"style="padding-left:10px; float: left;width:560px;">
									<div class="h-content3" id="select_s" style="margin-top: -19px; width:100%;padding: 10px 20px 0px 19px;"></div>
								</span>
							</div>
						</div>
					</div>
				</div>
				{% if  _power_mode == 2%}
			<div class="btns">
			
				<a href="javascript:;" class="btn btn-submit btn-normal">保&nbsp;&nbsp;存</a>
				<!--
				<a href="javascript:;" class="btn btn-cancle btn-normal">取&nbsp;&nbsp;消</a>
				-->
			</div>
			{% endif %}
			<div id="bBtn" style="z-index: 5;position:fixed">
				<a href="javascript:;" class="btn btn-cancle btn-normal" ><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
			</div>
			</div>
		</div>
		<!-- 查看结果 -->
		<div class="container2" style="display:none">
			<div class="manual-head">
				<div class="manual-title">
					<span onclick="reload(2);">发现主机</span>
					<i class="findhost_icon"></i>
				</div>							
			</div>			
			<div class="c-cont2">
				<div class="c-wrap" style="padding: 10px 0 0">
					<div class="c-exp">
						<div class="h-explorer">
							<div class="h-content2">
								<h2><em class="imp" style="color: #F00; font-style: normal;">*</em>主机：</h2>
								<ul id="userTree" class="hosttree">
								</ul>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					{% if  _power_mode == 2%}
					<div class="btns ">
						<a href="javascript:;" class="btn btn-normal" id="btn_save" onclick="result_save();">保&nbsp;&nbsp;存</a>
						<!--
						<a href="javascript:;" class="btn btn-normal" onclick="back();">返&nbsp;&nbsp;回</a>
						-->
					</div>
					{% endif %}
					<div id="bBtn" style="z-index: 5;">
						<a href="javascript:;" class="btn" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>

		<div class="container1">
			<div class="c-top">
				<div class="manual-head">
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="host_manage();">主机管理</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="host_test();"> 连接测试</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" id="frist">
						<span onclick="refresh();"> 发现主机</span>
						<i class="findhost_icon"></i>
					</div>						
				</div>
			</div>
			<div class="c-cont">
				<div class="c-wrap">
					<div class="c-table">
						<div class="tab-t">
							<div class="ctr">
							{% if  _power_mode == 2%}
								<a href="javascript:;" class="btn btn-default btn-normal" onclick="create()">创建</a>
								<a href="javascript:;" class="btn btn-default btn-normal" onclick="delete_backup()">删除</a>								
								<a href="javascript:;" class="btn btn-default btn-normal" onclick="select_all()">全选</a>
							{% endif %}
								<a href="javascript:;" class="btn btn-default btn-normal" onclick="refresh()">刷新</a>
							</div>
							<div class="filter">
								<div class="search">
									<select name="" id="filter_select" class="filter-select">
										<option value="0">所有</option>
										<option value="1">任务名称</option>
										<option value="2">网段</option>
									</select>

									<input type="text" class="filter-text" name="nm" id="nm" 
									placeholder="输入关键字" style="padding-right: 22px;" 
									onchange="if($('#nm').val()==''){$('#nm_check').hide();}else{$('#nm_check').show();}"
									onkeyup="if($('#nm').val()==''){$('#nm_check').hide();}else{$('#nm_check').show();}"
									onkeydown="if($('#nm').val()==''){$('#nm_check').hide();}else{$('#nm_check').show();}; if (event.keyCode == 13){_addFilter(this,false);return false;} else return; "
									onblur="change_input(this);return false;"
									>
									<i class="v-check v-wrong" id="nm_check" 
									onclick="_clearFilter(this,1)" 
									style="display:none;cursor: pointer;float: left;position: static;"></i>
									<button class="btn filter-btn" onclick="_addFilter(this,false);user_page(0.1)"><i class="add-filter"></i></button>
									<button class="btn filter-btn" onclick="_addFilter(this,true);user_page(0.1)"><i class="append-filter"></i></button>
								</div>
								
								<div class="search" id="clearFilter" style="margin: 0px 15px 0px -16px;display:none;">
									<button class="filter-btn" onclick="_clearFilter(this)"><i class="clear-filter"></i></button>
								</div>
								<div class="selector selector-multiple" id="filterWW" style="display: none;">							
									<span class="ww">搜索条件</span>
									<ul>
									</ul>
								</div>
							</div>
						</div>
						<div class="box-table">
							<table cellpadding="0" cellspacing="0" id="r_list">
								<thead>
									<tr>
										{%if  _power_mode == 2 %}
										<th width="50"><input type="checkbox" class="form-checkbox" id="check_page"/></th></th>
										{% endif%}
										<th>任务名称</th>
										<th style = "width:220px;">网&nbsp;&nbsp;段</th>
										<th style = "width:100px;">服&nbsp;&nbsp;务</th>
										<th>开始时间</th>
										<th>结束时间</th>
										<th style = "width:85px;">状&nbsp;&nbsp;态</th>
										{%if  _power_mode == 2 %}
											<th width="60"></th>
										{% else %}
											<th width="30"></th>
										{% endif %}
									<tr>
								</thead>

								<tbody name="fh_list" id="fh_list">
								</tbody>
							</table>
						</div>
						<div class="tab-i">
							<div class="il">
								每页显示10条 总数：<span id = "user_total">25</span>  选中：<span id="select_total">0</span>
							</div>

							<div class="ipage">
								<a href="javascript:;" class="nav2 begin" id="begin" onclick="user_page(0.1)"><i></i></a>
								<a href="javascript:;" class="nav prev" id="prev" onclick="user_page(-1)" ><i></i></a>
								<input type="text" value="1" id="user_page" onchange="showMsg()">/  <span id="totalpage">25</span>
								<a href="javascript:;" class="nav next" id="next" onclick="user_page(1)" ><i></i></a>
								<a href="javascript:;" class="nav2 end" id="end" onclick="user_page(0.9)" ><i></i></a>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					<!-- <div class="btns">
						<a href="javascript:;" class="btn btn-cancle1 btn-normal">返&nbsp;&nbsp;回</a>
					</div> -->
					<div id="bBtn" style="position: fixed;z-index:5;">
						<a href="javascript:;" class="btn btn-cancle1 btn-normal" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>

		<!-- <div id="TDialog1" style="display: none;">
			<div class="c-table tab-type2">
					<table cellpadding="0" cellspacing="0">
					<div class="c-cont2">
						<div class="c-wrap" style="padding: 10px 0 0">
							<div class="c-exp">
								<div class="h-explorer">
													<div class="h-content2">
														<h2>*主机：</h2>
														<ul id="userTree" class="hosttree"></ul>
													</div>
											</div>
										</div>
							<div class="clearfix"></div>
							<div class="btns">
								<a href="javascript:;" class="btn btn-normal" onclick="result_save();">保&nbsp;&nbsp;存</a>
								<a href="javascript:;" class="btn btn-normal" onclick="back();">返&nbsp;&nbsp;回</a>
							</div>
						</div>
					</div>
				</table>
			</div>
		</div> -->

	</div>

	<form action="/bhost/get_fh_list" method="POST" name="frm_fh" id="frm_fh">
			<input type="hidden" name="tasktype" id = "tasktype" value="" />
			<!--创建 编辑 列表-->
			<input type="hidden" name="page_num" id = "page_num" value="10" />
			<!--每页显示数-->
			<input type="hidden" name="total_all" id = "total_all" value="" />
			<!--总数-->
			<input type="hidden" name="paging" id = "paging" value="1" />
			<!--页码-->
			<input type="hidden" name="search_typeall" id = "search_typeall" value="" />
			<input type="hidden" name="search_typeall_n" id = "search_typeall_n" value="" />
			<!--查询要求，查询内容，查询类型-->
			<input type="hidden" name="userid" id = "userid" value="" />
			<!--需要查询的id-->
			<input type="hidden" name="fenye" id = "fenye" value="" />
			<!--总页数-->
			<input type="hidden" name="user" id = "user" value="lh" />
			<input type="hidden" name="se" id = "se" value="" />
			<input type="hidden" name="a0"  value="" />
	</form>

{%  endblock  %}
{%  block script %}
<style>
	.c-form-host .form-item .form-text {
			width: 124px;
	}
	.c-form-host span.ss {
			margin-top: 20px;
			float: left;
			width: 180px;
			line-height: 28px;
			position: relative;
	}
	.h-content2 ul li {
		line-height: 20px;
		position: relative;
		padding: 4px 0px;
	}
	.c-table {
		min-width:1177px;
	}
</style>


<script type="text/javascript">
var select_str = "";
var check_num = 0;
var ds_array=null;
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
var st_id = 0;
var loadBarLayer;
var _power_mode = '{{_power_mode}}';
var first_style ='';
$(function(){
	if(_power_mode == '1'){
		first_style="style=\"border-left: 1px solid #FFF;\"";
	}
	document.frm_fh.se.value=window.parent.document.frm.se.value;
	document.frm_fh.a0.value=window.parent.document.frm.se.value;
	$("#user_page").bind('keydown', function(e){
		DigitInput(e);
	});
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass:'icheckbox_minimal-blue',
		radioClass:'iradio_minimal-blue',
		increaseArea:'0'
	});
	$("a.btn-submit").unbind().bind("click",function(){
	savedata();
	});
	$('.form-select,.select2,.filter-select').select2({minimumResultsForSearch: -1});

	$('div.cbi-t input[type=checkbox]').on('ifChecked',function(){
		var $d = $(this).parents('div.cbi-t').next('div.cbi-cont');
		$('input[type=checkbox]',$d).iCheck('check');
	}).on('ifUnchecked',function(){
		var $d = $(this).parents('div.cbi-t').next('div.cbi-cont');
		$('input[type=checkbox]',$d).iCheck('uncheck');
	});

	_checkStatus();

	$("a.btn-cancle").unbind().bind("click",function(){
		$(".container1").show();
		$(".container").hide();
	});
	$("a.btn-cancle1").unbind().bind("click",function(){
		document.frm.tasktype.value = 3;
		document.frm.se.value = document.frm_fh.se.value;
		document.frm.action = '/bhost/index';
		document.frm.i10.value = 0;
		document.frm.submit();
	});

	$("#fh_list").on('dblclick','tr',function(e){
		x=e.target;
		if (x.nodeName != "INS"){
			$(this).children('td:last').find('.edit').click();
			$(this).children('td:last').find('.search_result').click();
		}
	}
	).on("click", "tr", function (e){  
		x=e.target;
	});
	$('#check_page').on('ifClicked',function(e){
		if(!$('#check_page').prop('checked')){
			$("#r_list").children('tbody').find('input[type=checkbox]').iCheck('check');
		}else{
			$("#r_list").children('tbody').find('input[type=checkbox]').iCheck('uncheck');
		}
	});
	$("#fh_list").on("ifChecked",function(e){
		check_num++;
		$("#select_total").text(check_num);	
		if($("table tbody tr").children("td.in").children("div").children("input:checked").length==$("#fh_list tr").length){
			$('#check_page').iCheck('check');
		}
	}).on("ifUnchecked",function(e){
		check_num--;
		$("#select_total").text(check_num);	
		$('#check_page').iCheck('uncheck');	
	});
	$("#userTree").change(function(e){
		if($("#userTree > li").find('input:checked').not("#select_a").length == $("#userTree > li").find('input:checkbox').not("#select_a").length){
			$('#select_a').next().attr('class','checkbox checked');
		}else{
			$('#select_a').next().attr('class','checkbox');
		}	
	})
	parent._switchBtn(1);//显示按钮
})

function reload(type){
	if(type == 1){
		if(editID == 0){
			create();
		}else{
			edit_user(editID);
		}
	}else if(type == 2){
		result_show(editID);
	}
}

function host_manage(){
	document.frm_fh.tasktype.value=1;
	document.frm_fh.action = '/bhost/host_manage';
	document.frm_fh.submit();
}
function host_test(){
	document.frm_fh.tasktype.value=3;	
	document.frm_fh.action = '/bhost/host_test_trust';
	document.frm_fh.submit();
}

function Backdsmanage(){
	$(".container1").show();
	$(".container").hide();
	refresh();
}

var ds_data = [];
var ipstr = "";
var port_array1 = [];
var port_array = [];
// 获取设备服务列表
function _get_ds(){
	$("#select_s").empty().html('<div class="item" style="width: 50%;margin-left: -19px;"><select class="filter-select" name="ds" id="ds" style="width:232px;" tabindex="-1" aria-hidden="false" onchange="ds_select(this)"></select><i class="ctrl add" id="add1" onclick="_addds(this)"></i></div>');
	var f = [];
	port_array1 = [];
	port_array = [];
	$.ajax({
		url:"/bhost/get_devicetype_list",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),z1:"null",z2:"null",z3:JSON.stringify(f)},
		success:function(result){
			ds_result = JSON.parse(result);
			if(ds_result.data){
				ds_data = ds_result.data;
				var check = [];
				$("#ds").empty().append('<option value=\"-2\">所有服务</option>');
				$.each(ds_data,function(i,item){
					// if(item.DeviceTypeId < 1000){
						$.each(item.ServiceSet,function(i1,item1){
							var str = item1.DeviceServiceName + "(" + item1.Port + ")";
							if((index = check.indexOf(str)) >= 0){
								return true;
							}
							check.push(str);
							var val = item1.DeviceServiceId + '-' + item1.Port;
							$("#ds").append('<option value="'+val+'" _port="'+item1.Port+'" title="'+item1.DeviceServiceName+'">'+str+'</option>');
							port_array1.push(item1.Port);
						})
					// }
				})

			for(var i = 0; i < port_array1.length; i++){		//去掉重复元素
				if(port_array.indexOf(port_array1[i]) == -1){
					port_array.push(port_array1[i]);
				}
			}
			}else{
				_alert(1,"发现主机",'获取设备服务列表失败：'+ds_result.info);
			}
		}
	});
	$('#select_s .filter-select').select2();
}

var ipcheck_route=/(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
function _addIp(obj){
	var add = 0;
	var start_ip = $(obj).parent().find('input').eq(0).val();
	var end_ip = $(obj).parent().find('input').eq(1).val();
	if (start_ip == ""){
		_alert(2,"发现主机","请输入起始IP地址",$(obj).parent().find('input').eq(0));
		return false;
	}
	if (end_ip == ""){
		_alert(2,"发现主机","请输入终止IP地址",$(obj).parent().find('input').eq(1));
		return false;
	}
	if (!ipcheck_route.test(start_ip)){
		_alert(1,"发现主机","起始IP地址格式不正确",$(obj).parent().find('input').eq(0));
		return false;
	}
	if (!ipcheck_route.test(end_ip)){
		_alert(1,"发现主机","终止IP地址格式不正确",$(obj).parent().find('input').eq(1));
		return false;
	}
	var a = _compare_ip(start_ip,end_ip);
	if (a != 3){
		_alert(1,"发现主机","起始IP地址不能大于或等于终止IP地址",$(obj).parent().find('input').eq(1));
		return false;
	}
	$(obj).parent().parent().find('.ss').not('.ss:first').each(function(i,item){
		if ($(item).find('input').eq(0).val() == start_ip && $(item).find('input').eq(1).val() == end_ip){
			add = 1;
			_alert(1,"发现主机","已存在相同网段",$(obj).parent().find('input').eq(0));
			return false;
		}
	});
	if (add == 1){
		return false;
	}
	var $c = $('<span class="ss ss-add" style = "width: 350px;"><input type="text" style="" class="form-text form-text2" value="'+start_ip+'"> - <input type="text" style="" class="form-text form-text2" value="'+end_ip+'" ><i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px; margin-left: -5px;"></i></span>');
	$(obj).parent().after($c);
	var ip_s = start_ip + '-' + end_ip; 
	ipstr += ip_s + ',';
	flag_ip = 1;
	$(obj).parent().find('input').eq(0).val('');
	$(obj).parent().find('input').eq(1).val('');
}

function _delIp(obj){
	var $c = $(obj).parent();
	var d_s = $c.find('input').eq(0).val();
	var e_s = $c.find('input').eq(1).val();
	var ip_s = d_s + '-' + e_s; 
	var ip_t = [];
	ip_t = ipstr.split(',');
	$.each(ip_t,function(i,item){
		if(item == ip_s){
			ip_t.splice(i,1);
		}
	})
	ipstr = ip_t.join(',');
	$c.remove();
}

var ds_tmp = [];
var ds_arry=['-1'];
function ds_select(obj){
	var t = $(obj).children('option:selected').val();
	if (ds_arry.indexOf(t) === -1 && t != undefined){
		ds_arry.splice(0,1,t);
	}
	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	} 
}

function _addds(obj){
	if($("#ds").val() != -2 && $("#ds").val() != -1){
		$("#ds").children(':first').remove();
		$("#ds").children(':first').before('<option value=\"-1\">请选择</option>'); //去掉默认 加上请选择
		var add = 0;
		var name2 = $(obj).parent().children('select').children('option:selected').val();
		if (name2 == undefined){
			$(obj).parent().children('select').val('-1').trigger('change');
			return false;
		}	
		var t = $(obj).parent().children('select').children('option[value='+name2+']').text();
		var n = $(obj).parent().children('select').children('option:selected').attr('title');
		if (name2 == -1){
			_alert(2,"发现主机","请选择设备服务");
			return;
		}
		ds_arry.splice(0,0,'-1');
		var $c = $(obj).parent();
		// var d = $('select>option:first',$c).val();
		var $s = $('<li class="item" style="width: 50%;margin-left: -19px;"><input type="text" class="form-text" name="'+n+'" id="'+name2+'" value="'+t+'" style="width:200px;" tabindex="-1" aria-hidden="false" disabled="true"></select><i class="ctrl del" onclick="_delds(this)"></i></div>');
		$c.children('select').val(n);
		$c.children('select').find('option[value='+name2+']').remove();

		$c.after($s);

		// ds_tmp="";
		// $("#select_s>li").each(function(i,item){
		// 	v_tmp=$(item).children().attr("port");
		// 	ds_tmp += ',' + v_tmp;
		// });
	}
}

function _delds(obj){
	var $c = $(obj).parent();
	var id = $c.children().attr('id');
	var $p = $(obj).parent().parent().find('div');

	var v = $c.find('select:first').children('option:selected').text();
	$c.remove();
	$("#ds").parent().show();
	ds_arry.splice($.inArray(id,ds_arry),1);
	_del_frame($p,ds_data,ds_arry);
	// ds_tmp="";
	// $("#select_s>li").each(function(i,item){
	// 	v_tmp=$(item).children().attr("port");
	// 	ds_tmp += ',' + v_tmp;
	// });
}

function _del_frame(obj,data,arry){
	$(obj).children('select').children('option').remove();
	if($("#select_s").children().length == 1){
		$(obj).children('select').append('<option value=\"-2\">默认</option>');
	}else{
		$(obj).children('select').append('<option value=\"-1\">请选择</option>');
	}

	if (data[0].ServiceSet[0].Port != undefined){
		var check = [];
		$.each(data,function(i,item){
				$.each(item.ServiceSet,function(i1,item1){
					var str = item1.DeviceServiceName + "(" + item1.Port + ")";
					if((index = check.indexOf(str)) >= 0){
						return true;
					}
					check.push(str);
						var val = item1.DeviceServiceId + '-' + item1.Port;
						$("#ds").append('<option value="'+val+'" _port="'+item1.Port+'" title="'+item1.DeviceServiceName+'">'+str+'</option>'); 
				})
		})
	}
	$.each(arry,function(i2,item2){
		if (item2 != '-1' && i2 != 0){
			$(obj).children('select').children('option[value='+item2+']').remove();
		}
	});
	if($("#select_s").children().length == 1){
		$(obj).children('select').val(-2).trigger('change');
	}else{
		$(obj).children('select').val(arry[0]).trigger('change');
	}	
}

var flag_ip = 1;
var ip_num = 0;
var taskid = ""; //创建后返回任务ID
function savedata(){
	var taskname = $("#t_n").val();
	if(taskname == ""){
		_alert(2,"发现主机","请输入任务名称",$("#t_n"));
		return false;
	}
	// if($('.ss:first').find('input').eq(0).val() != "" || $('.ss:first').find('input').eq(1).val() != ""){
	// 	flag_ip = 0;
	// 	var $add = $('.ss:first').children('i');
	// 	_addIp($add);
	// 	if(flag_ip == 0){
	// 		return false;
	// 	}
	// }
	if($("#ds").val() != -1 && $("#ds").val() != -2){
		var $add = $("#ds").next().next();
		_addds($add);
	}
	// if(ipstr == ""){
	// 	_alert(1,"发现主机","请加入网段",$(".ss").children().find('input').eq(0));
	// 	return false;
	// }
	// var b = ipstr.split("");
	// var c = b[b.length-1];
	// if(c == ','){
	// 	ipstr = ipstr.substr(0,ipstr.length-1);
	// }	
	if($("#nw_s").children().length == 1 && $("#nw_s").children().children().eq(0).val() == "" && $("#nw_s").children().children().eq(1).val() == ""){
		_alert(2,"发现主机","请加入网段",$(".ss").children().find('input').eq(0));
		return false;
	}
	var _ipstr = "";
	var flag_ip = 0;
	$.each($("#nw_s").children(),function(i,item){
		var start_ip = $(item).find('input').eq(0).val();
		var end_ip = $(item).find('input').eq(1).val();
		var add = 0;
		if(i == 0){
			if (start_ip == "" && end_ip != ""){
				_alert(2,"发现主机","请输入起始IP地址",$(item).find('input').eq(0));
				flag_ip = 1;
				return false;
			}
			if(end_ip == "" && start_ip != ""){
				_alert(2,"发现主机","请输入终止IP地址",$(item).find('input').eq(1));
				flag_ip = 1;
				return false;
			}
			if(start_ip != "" || end_ip != ""){
				if (!ipcheck_route.test(start_ip)){
					_alert(1,"发现主机","起始IP地址格式不正确",$(item).find('input').eq(0));
					flag_ip = 1;
					return false;
				}
				if (!ipcheck_route.test(end_ip)){
					_alert(1,"发现主机","终止IP地址格式不正确",$(item).find('input').eq(1));
					flag_ip = 1;
					return false;
				}
				var a = _compare_ip(start_ip,end_ip);
				if (a != 3){
					_alert(1,"发现主机","起始IP地址不能大于或等于终止IP地址",$(item).find('input').eq(1));
					flag_ip = 1;
					return false;
				}
			}
		}else{
			if (start_ip == ""){
				_alert(2,"发现主机","请输入起始IP地址",$(item).find('input').eq(0));
				flag_ip = 1;
				return false;
			}
			if (end_ip == ""){
				_alert(2,"发现主机","请输入终止IP地址",$(item).find('input').eq(1));
				flag_ip = 1;
				return false;
			}
			if (!ipcheck_route.test(start_ip)){
				_alert(1,"发现主机","起始IP地址格式不正确",$(item).find('input').eq(0));
				flag_ip = 1;
				return false;
			}
			if (!ipcheck_route.test(end_ip)){
				_alert(1,"发现主机","终止IP地址格式不正确",$(item).find('input').eq(1));
				flag_ip = 1;
				return false;
			}
			var a = _compare_ip(start_ip,end_ip);
			if (a != 3){
				_alert(1,"发现主机","起始IP地址不能大于或等于终止IP地址",$(item).find('input').eq(1));
				flag_ip = 1;
				return false;
			}
		}
		$(item).siblings().each(function(i,item){
			if ($(item).find('input').eq(0).val() == start_ip && $(item).find('input').eq(1).val() == end_ip){
				add = 1;
				_alert(1,"发现主机","已存在相同网段",$(item).find('input').eq(0));
				flag_ip = 1;
				return false;
			}
		});
		if (add == 1){
			return false;
		}
		if(start_ip != "" && end_ip != ""){
			_ipstr += start_ip + '-' + end_ip + ',';
		}
	})
	if (flag_ip == 1){
		return false;
	}
	var b = _ipstr.split("");
	var c = b[b.length-1];
	if(c == ','){
		_ipstr = _ipstr.substr(0,_ipstr.length-1);
	}	

	// _get_ipnum(ipstr);    //计算扫描数量
	if(!nameReg.test(taskname)){
		_alert(1,"发现主机","任务名称格式不正确",$("#t_n"));
			return false;
	}
	var _port = [];
	var port = null;
	var _deviceserviceid = [];
	var deviceserviceid = "";
	if($("#ds").val() == -2){
		_port = port_array;
	}else{
		$.each(ds_arry,function(i,item){
			if(item != -1 && item != 0){
				_deviceserviceid.push(item.split('-')[0]);
				_port.push(item.split('-')[1]);
			}
		})
	}
	var port_num = _port.length;
	port = _port.join(',');
	deviceserviceid = _deviceserviceid.join(',');
	var jsondata = {
		"HostScanTaskId": "",
		"TaskName": "",
		"NetWorkSeg": "",
		"DeviceServiceId": "",
		"Status":1,            //1-执行中；2-成功；3-失败
		"Result": [],
		"UserCode":parent.window.document.frm.us.value
	}
	jsondata.TaskName = taskname;
	jsondata.NetWorkSeg = _ipstr;
	jsondata.DeviceServiceId = deviceserviceid;
	jsondata.HostScanTaskId = st_id;
	msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
	$.ajax({
		url:'/bhost/save_hostscan_task',
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),a2:_ipstr,a3:port,m1:msstr},
		//contentType: 'application/json',
		success: function(Result) {
			data = JSON.parse(Result);
			if (data.Result){
				taskid = data.info;
				_getLoadBar(this,0,taskid);
				flag_bar = 0;
			}
			else{
				_alert(1,"发现主机",'保存失败，失败原因：'+data.ErrMsg);
			}
		}
	})
}
//获取保存后当前页
function get_current_page(id){
	$.ajax({
		url:'/bhost/get_current_page',
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:id,a2:29},
		success:function(Result){
			cur_page = Math.ceil(Result/10);
			$('#user_page').val(cur_page);
		}
	})
}
var ip_section = [];
// function _get_ipnum(ipstr){
	// 	var ip_a = ipstr.split(',');
	// 	var p = $("#select_s").find('li').length;
	// 	if(p == 0) p = 18;
	// 	$.each(ip_a,function(i,item){
	// 		var sec = {
	// 			start_s: 0,
	// 			end_s: 0,
	// 			total_s: 0
	// 		};
	// 		var s = item.split('-')[0];
	// 		var e = item.split('-')[1];

	// 		var s1 = parseInt(s.split('.')[0]);
	// 		var s2 = parseInt(s.split('.')[1]);
	// 		var s3 = parseInt(s.split('.')[2]);
	// 		var s4 = parseInt(s.split('.')[3]);
	// 		var start_s = (s1 * (256*256*256*256) + s2 * (256*256*256) + s3 * 256*256 + s4*256) *p;
	// 		sec.start_s = start_s;

	// 		var e1 = parseInt(e.split('.')[0]);
	// 		var e2 = parseInt(e.split('.')[1]);
	// 		var e3 = parseInt(e.split('.')[2]);
	// 		var e4 = parseInt(e.split('.')[3]);
	// 		var end_s = (e1 * (256*256*256*256) + e2 * (256*256*256) + e3 * 256*256 + e4*256) *p;
	// 		total_s = end_s - start_s;
	// 		sec.end_s = end_s;
	// 		sec.total_s = total_s;
	// 		ip_section.push(sec);

	// 		ip_num += ((e1-s1) * (256*256*256*256) + (e2-s2) * (256*256*256) + (e3-s3) * 256*256 + (e4-s4)*256)*p;
	// 	})
// }

function _compare_ip(x,y){
	var ip1 = x.split('.');
	var ip2 = y.split('.');
	var i1 = 0;
	var ip1_str = "";
	var ip2_str = "";
	for (var i1 = 0; i1 < 4; i1++){
		if (ip1[i1] < 10){
			ip1[i1] = "00"+ip1[i1];
		}else if (ip1[i1] < 100){
			ip1[i1] = "0"+ip1[i1];
		}else{
			
		}
		ip1_str = ip1_str + ip1[i1];
		if (ip2[i1] < 10){
			ip2[i1] = "00"+ip2[i1];
		}else if (ip2[i1] < 100){
			ip2[i1] = "0"+ip2[i1];
		}else{
			
		}
		ip2_str = ip2_str + ip2[i1];
	}
	if (ip1_str == ip2_str){
		return 3;
	}else if (ip1_str > ip2_str){
		return 2
	}else{
		return 3;
	}
}

var editID;
//编辑
function edit_user(id,obj){
	editID = id;
	$("body").find(".tab-moreinfo.tab-moreinfo-on").attr("style","top: 170px; left: 45px; width: 1265px; opacity: 1; display: none;");
	filter = ""
	$(".container1").hide();
	$(".container").show();
	clear_page();
	_get_ds();
	st_id = id;
	var paging = "1";
	var page_num = "1";
	var search_typeall= "";
	var userid= id;
	var jsondata ={
			"hostscantaskid":null,
			"taskname":null,
			"networkseg":null,
			"starttime":null, 
			"endtime":null,
			"limitrow":"",
			"offsetrow":"",
			"UserCode":parent.window.document.frm.us.value
		}
	taskid = id;
	jsondata.hostscantaskid = id;
	jsondata.limitrow = parseInt(page_num);
	jsondata.offsetrow = (parseInt(paging)-1) * parseInt(page_num);

	$.ajax({
		url: "/bhost/get_hostscan_task",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata)},
		success:function(Result){
			result = JSON.parse(Result);
			if(result.Result == false)
			{
				_alert(1,"发现主机","获取信息失败，失败原因："+result.ErrMsg);
				return false;
			}
			else
			{
				data = result.info.data[0];
				$('#t_n').val(data.TaskName);
				$("#t_n").attr("disabled",true);
				var net_s = data.NetWorkSeg.split(',');
				var s_ip = "";
				var e_ip = "";
				$.each(net_s,function(i,item){
					s_ip = item.split('-')[0];
					e_ip = item.split('-')[1];
					$(".ss").find('input').eq(0).val(s_ip);
					$(".ss").find('input').eq(1).val(e_ip);
					$("#add2").click();
				})
				var hs_id = [];
				var hst_id = "";
				$.each(data.DeviceServiceSet,function(i,item){
					hst_id = item.DeviceServiceId + '-' + item.Port;
					$("#ds").val(hst_id).trigger('change');
					$("#add1").click();
				})
			}
		}
	})
	if(obj != undefined){
		if($(obj).parent().parent().prev().text().indexOf('执行中') != -1){
			var prog = $(obj).parent().parent().prev().text().split('中')[1];
			_getLoadBar(this,prog,id);
			flag_bar = 0;
		}
	}
}
function _checkStatus(){
	$('div.cbi-tag input[type=checkbox]').each(function(){
		var c = $(this).prop('checked');
		var $s = $(this).parents('div.cbi-tag').next('div.cbi-sel');
		if(c){
			$s.show();
		}else{
			$s.hide();
		}
	});
}

//创建
function create(){
	editID = 0;
	_get_ds();
	$(".container").show();
	$(".container1").hide();
	clear_page();
}
function clear_page(){
	$("#t_n").val("");
	$("#t_n").next('i').attr('class','v-check');
	$("#t_n").attr("disabled",false);
	$('.ss:not(:first)').remove();
	$(".ss").find('input').eq(0).val('');
	$(".ss").find('input').eq(1).val('');
	$("#select_s").find('li').remove();
	ds_arry=['-1'];
	ipstr = "";
	ip_section = [];
	st_id = 0;
}

//选中字段存储
function select_save(){
	$(">tr","#fh_list").each(function(){
		var input  = $(this).find("input[type='checkbox']");
		var select_item_pass =1;
		var select_str_s=select_str.split(",");
		if($(input).is(':checked')){
			var select_item=$(">td",this).eq(1).text();
			$.each(select_str_s,function(i,item){
				if(item==select_item){
					select_item_pass=0;
					return false;
				}
			});
			if(select_item_pass==1){
				select_str=select_str+select_item+",";
			}
		}else{
			var select_item=$(">td",this).eq(1).text();
			select_str="";
			$.each(select_str_s,function(i,item){
				if(item!=select_item && item!=""){
					select_str=select_str+item+",";
				}
			});
		}
	});
}
//check显示
function check_show(){
	$(">tr","#fh_list").each(function(){
		var input=$(this).find("input[type='checkbox']");
		var select_str_s=select_str.split(",");
		var check_id=$(">td",this).eq(1).text();
		$.each(select_str_s,function(i,item){
			if(item==check_id){
				$(input).iCheck('check');
				return false;
			}
		});
	});
}
//input回车触发事件
function showMsg(){
	select_save();
	var cur = $("#user_page").val();
	var totalpage = $("#totalpage")[0].textContent;
	if (parseInt(cur) < 1){
		$("#user_page").val(1);
		document.frm_fh.paging.value=1;
	}else if(parseInt(cur) > parseInt(totalpage)){
		document.frm_fh.paging.value=totalpage;
	}else{
		document.frm_fh.paging.value=cur;
	}
	show_fh_list();
}

function update_array(){
	var search_typeall=document.frm_fh.search_typeall.value + document.frm_fh.search_typeall_n.value;
	var userid=document.frm_fh.userid.value;
	var jsondata ={
		"hostscantaskid":null,
		"taskname":null,
		"networkseg":null,
		"searchstring":null,    
		"starttime":null, 
		"endtime":null,
		"limitrow":"",
		"offsetrow":"",
		"UserCode":parent.window.document.frm.us.value
		}
	var paging = document.frm_fh.paging.value;
	var page_num = MAX_PAGE;
	var search_typeall=document.frm_fh.search_typeall.value + document.frm_fh.search_typeall_n.value;
	var a =  search_typeall.split('\t');
	var taskname = "";
	var networkseg = "";
	var searchstring='';
	if (a!=""){
		$.each(a,function (i,item) {
			if(item==''){
				return true;
			}
			var index=item.indexOf('-');
			if(item.substring(0,index)==1){
				taskname += item.substring(index+1) + '\n';
			}else if(item.substring(0,index) == 2){
				networkseg += item.substring(index+1) + '\n';
			}else if(item.substring(0,index) == 0){
				searchstring += item.substring(index+1) + '\n';
			}
		})
	}
	if(taskname != ""){
		taskname = taskname;
	}else{
		taskname = null;
	}
	if(networkseg != ""){
		networkseg = networkseg;
	}else{
		networkseg = null;
	}
	if(searchstring != ""){
		searchstring = searchstring;
	}else{
		searchstring = null;
	}
	jsondata.taskname = taskname;
	jsondata.networkseg = networkseg;
	jsondata.searchstring = searchstring;
	jsondata.limitrow = parseInt(page_num);
	jsondata.offsetrow = (parseInt(paging)-1) * parseInt(page_num);
	$.ajax({
		url:'/bhost/get_hostscan_task',
		type:'post',
		async:false,
		data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata)},
		success:function(result){
			var user_result = JSON.parse(result);
			if (user_result.Result){
				var user_data = user_result.info;
				ds_array=user_data.data;
				if(select_str!=''){
					var select_str_s=select_str.split(',');
					select_str='';
					$.each(select_str_s,function(i,item){
						item=parseInt(item);
						$.each(ds_array,function(i1,item1){
							if(item1.HostScanTaskId==item){
								select_str=select_str+item+',';
								return false;
							}
						});
					});
				}
			}
		}
	})
}
//关键字查询
function change_input(obj){
	if ($(obj).val() == ""){
		document.frm_fh.search_typeall_n.value = '';
		show_fh_list();
	}
}
function _addFilter(obj,type){
	var nameReg = /^[A-Za-z0-9_\-]+$/;
	var id = $(obj).parent().children('select').children('option:selected').val();
	var v1 = $(obj).parent().children('select').children('option:selected').text();
	var v2 = $(obj).parent().children('input[type=text]').val().trim();
	if (id=="0"){
		// $('#filterWW>ul').empty();
		// document.frm_fh.search_typeall.value = "";
		// document.frm_fh.search_typeall_n.value = "";
		// $("#filterWW").attr("style","display:none;");
		// $("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
		// $("#nm").val("");
		// select_str = "";
		// user_page(0.1);
		// var select_str_s=select_str.split(",");	
		// check_num=select_str_s.length-1;
		// $("#select_total")[0].textContent = check_num;
		// return false;
		v1='';
	}else{
		v1=v1+'-';
	}

	if(v2 == ''){
		$("#nm").focus();
		_alert(2,"搜索",'请输入关键字',$("#nm"));
		return false;
	}else{
		if(document.frm_fh.search_typeall.value.indexOf(id+'-'+v2+'\t')>=0){
			$("#nm").focus();
			_alert(2,"搜索",'关键字重复',$("#nm"));
			return false;
		}
		if(type){
			document.frm_fh.search_typeall_n.value = "";
			var search_typeall=document.frm_fh.search_typeall.value;
			search_typeall=search_typeall+id+'-'+v2+'\t';
			document.frm_fh.search_typeall.value = search_typeall;
			$('#filterWW>ul').append('<li><span style = "display:none">'+id+'-'+v2+'</span><span class="ww">'+v1+v2+'</span><i class="del" onclick="_delFilter(this);user_page(0.1);"></i></li>')
			$("#nm").val("");
			$('#nm_check').hide();
		}else{
			document.frm_fh.search_typeall_n.value = id+'-'+v2+'\t';
		}

	}
	$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
	select_str='';
	$("#nm").focus();
	selView();
	user_page(0.1);
	var select_str_s=select_str.split(",");
	check_num=select_str_s.length-1;
	$("#select_total")[0].textContent = check_num;
}
//删除关键字
function _delFilter(obj){
	var id = $(obj).parent().find("span");
	var ids = $(id).eq(0).text();
	var v2_text = $(id).eq(1).text();
	var v2_str = v2_text.split("：");
	var search_typeall = document.frm_fh.search_typeall.value;
	v2_str[0] = "";
	var str_v2 = v2_str.join('：');
	var str = ids+'：'+str_v2.substr(1,str_v2.length);
	var search_str = "";
	var search_typeall_str = search_typeall.split("\t");
	var i2 = 0;
	$.each(search_typeall_str,function(i,item){
		if (i2 == 0 && item == ids){
			i2 = 1;
		}else if(item != ""){
			search_str=search_str+item+'\t';
		}
	})
	document.frm_fh.search_typeall.value = search_str;
	$(obj).parent().remove();
	selView();
	$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
	select_str='';
	user_page(0.1);
	var select_str_s = select_str.split(",");
	check_num = select_str_s.length-1;
	$("#select_total")[0].textContent = check_num;
}
//清空关键字
function _clearFilter(obj,num){
	if(num==1){
	$('#nm').val('');
	$('#nm_check').hide();
	document.frm_fh.search_typeall_n.value = "";
	$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
	select_str='';
	user_page(0.1);
	var select_str_s=select_str.split(",");
	check_num=select_str_s.length-1;
	$("#select_total")[0].textContent = check_num;
		return;
	}
	$('#clearFilter').next().children('ul').empty();
	$('#nm').val('');
	$('#nm_check').hide();
	document.frm_fh.search_typeall.value = "";
	document.frm_fh.search_typeall_n.value = "";
	selView();
	$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
	select_str='';
	user_page(0.1);
	var select_str_s=select_str.split(",");
	check_num=select_str_s.length-1;
	$("#select_total")[0].textContent = check_num;
}
function selView(){
	var $sel = $('#filterWW');
	var len = $('li',$sel).length;

	if(len == 0){
		$sel.hide();
		$('#clearFilter').hide();
	}else if(len == 1){
		$("#filterWW").show();
		$('>span.ww',$sel).show();
		$('#clearFilter').show();
		$sel.addClass('selector-multiple');
	}else{
		$("#filterWW").show();
		$('>span.ww',$sel).show();
		$('#clearFilter').show();
		$sel.addClass('selector-multiple');
	}
	
}
//每页显示数
function show_page_num(){
	var page_nums = document.getElementById("page_nums");
	var num = page_nums.options[page_nums.selectedIndex].value;
	document.frm_fh.page_num.value=num;
	document.frm_fh.paging.value=1;
	show_fh_list();
}

var user_data;
//以每页显示数显示列表函数
function show_fh_list(){
	// $("#nm").val("");
	// $("#filter_select option:eq(0)").prop("selected",true);
	// $("#filter_select").select2();
	// if($("#filter_select").val()==0)
	// 	$("#nm").hide();
	// else
	// 	$("#nm").show();
	// $("#filter_select").change(function(){
	// 	var type = $(this).val();
	// 	if(type == 0){
	// 		$("#nm").hide();
	// 	}else{
	// 		$("#nm").show();
	// 	}
	// });
	var jsondata ={
		"hostscantaskid":null,
		"taskname":null,
		"networkseg":null,
		"searchstring":null,    
		"starttime":null, 
		"endtime":null,
		"limitrow":"",
		"offsetrow":"",
		"UserCode":parent.window.document.frm.us.value
		}
	var paging = document.frm_fh.paging.value;
	var page_num = MAX_PAGE;
	var search_typeall=document.frm_fh.search_typeall.value + document.frm_fh.search_typeall_n.value;
	var a =  search_typeall.split('\t');
	var taskname = "";
	var networkseg = "";
	var searchstring='';
	if (a!=""){
		$.each(a,function (i,item) {
			if(item==''){
				return true;
			}
			var index=item.indexOf('-');
			if(item.substring(0,index)==1){
				taskname += item.substring(index+1) + '\n';
			}else if(item.substring(0,index) == 2){
				networkseg += item.substring(index+1) + '\n';
			}else if(item.substring(0,index) == 0){
				searchstring += item.substring(index+1) + '\n';
			}
		})
	}
	if(taskname != ""){
		taskname = taskname;
	}else{
		taskname = null;
	}
	if(networkseg != ""){
		networkseg = networkseg;
	}else{
		networkseg = null;
	}
	if(searchstring != ""){
		searchstring = searchstring;
	}else{
		searchstring = null;
	}
	jsondata.taskname = taskname;
	jsondata.networkseg = networkseg;
	jsondata.searchstring = searchstring;
	jsondata.limitrow = parseInt(page_num);
	jsondata.offsetrow = (parseInt(paging)-1) * parseInt(page_num);

	$.ajax({
		url: "/bhost/get_hostscan_task",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata)},
		success:function(result){
			var user_result = JSON.parse(result);
			if (user_result.Result==true){
				user_data = user_result.info;
				var total_all = user_data.totalrow;
				if(user_data.data=="" && paging!="1"){
					user_page(-1);
				}else{
					total = 0;
					document.frm_fh.total_all.value = total_all;
					if(total_all){
						$("#fh_list").empty();
							$.each(user_data.data,function(i,item){
								if (total<page_num){
									total++;
									var str_tmp = "";
									var progress = item.Progress;
									if(item.Status == 1){
										str_tmp = "执行中&nbsp;&nbsp;"+progress+"%";
									}else if(item.Status == 2){
										str_tmp = "成功";
									}else if(item.Status == 3){
										str_tmp = "失败";
									}else if(item.Status == 4){
										str_tmp = "停止";
									}
									if(item.EndTime == null){
										item.EndTime = "";
									}
									var DeviceServiceName = "";
									$.each(item.DeviceServiceSet,function(i1,item1){
										DeviceServiceName += item1.DeviceServiceName + '(' + item1.Port +')' + '&nbsp;&nbsp;&nbsp;&nbsp;';
									})
									if(DeviceServiceName == ""){
										DeviceServiceName = "所有服务";
									}
									
									if(_power_mode == '1'){
										edit_class = 'search_result';
										title_str="查看";
									}else{
										edit_class = 'edit';
										title_str ="编辑";
									}
									
									var float_str = "<p>检测网段："+item.NetWorkSeg+"</p><p>检测服务："+DeviceServiceName+"</p>";
									$("#fh_list").append("<tr>"+
										"<td class=\"in s-hide\"><input type=\"checkbox\" class=\"input_checkbox\" /></td>"+
										"<td style = \"display:none\">"+item.HostScanTaskId+"</td>"+
										"<td title="+item.TaskName+" "+first_style+"><title=\""+item.TaskName+"\" style=\"width:200px;\">"+item.TaskName+"</div></td>"+
										"<td title="+item.NetWorkSeg+"><title=\""+item.NetWorkSeg+"\" style=\"width:200px;\">"+item.NetWorkSeg+"</div></td>"+
										"<td style = \"display:none\">"+item.DeviceServiceId+"</td>"+
										"<td title="+DeviceServiceName+"><title=\""+DeviceServiceName+"\" style=\"width:200px;\">"+DeviceServiceName+"</div></td>"+
										"<td title="+item.StartTime+"><title=\""+item.StartTime+"\" style=\"width:200px;\">"+item.StartTime+"</div></td>"+
										"<td title="+item.EndTime+"><title=\""+item.EndTime+"\" style=\"width:200px;\">"+item.EndTime+"</div></td>"+
										"<td title="+str_tmp+"><title=\""+str_tmp+"\" style=\"width:200px;\">"+str_tmp+"</div></td>"+
										"<td id=\"on\"><div class=\"tab-ctr\" id=\"tab\" style=\"margin-left: -7px;width: 75px;\"><a href=\"javascript:;\" class=\""+edit_class+"\" title = \""+title_str+"\" id=\"edit\" onclick=\"edit_user("+item.HostScanTaskId+",this)\"></a><a href=\"javascript:;\" title = \"查看结果\" class=\"icon5\" id=\"result\" onclick=\"result_show("+item.HostScanTaskId+")\"></a><a href=\"javascript:;\" title = \"删除\" class=\"del s-hide\" id=\"del\" onclick=\"delete_fun("+item.HostScanTaskId+",this)\"></a></div></div></td></tr>");
								}
							})
						if(_power_mode == '1'){
							$('.s-hide').remove();
						}
						tabArr();							
						$(".input_checkbox","#fh_list").iCheck({
							checkboxClass: 'icheckbox_minimal-blue',
							radioClass: 'iradio_minimal-blue',
							increaseArea: '0' // optional
						});
						$("#user_total").text(total_all);
						if(total_all % page_num == 0){
							fenye = parseInt(total_all/page_num)
						}else{
							fenye = parseInt(total_all/page_num+1)
						}
						if(paging>=fenye){
							paging=fenye;
						}
						document.frm_fh.paging.value=paging;
						document.getElementById("user_page").value=paging;
						$("#totalpage").text(fenye);
						document.frm_fh.fenye.value=fenye;
						$('#check_page').iCheck('uncheck');
						$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
						check_show();
						var select_str_s=select_str.split(",");
						check_num=select_str_s.length-1;
						$("#select_total")[0].textContent = check_num;
					}
					else{
						$('#check_page').iCheck('uncheck');	
						$("table").next("div.tab-i").children("div.il").find("span.select_total").text(0);
						$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
						$("#fh_list").empty();
						$("#user_total").text(total_all);
						$("#totalpage").text(1);
						document.frm_fh.paging.value=1;
						fenye = 1;
						document.getElementById("user_page").value=1;
					}
				}
				//  flag_progress = 0; //判断列表中是否有未完成任务 1---》有
				// $.each(user_data.data,function(i,item){
				// 	if(item.Progress != 100){
				// 		refresh_progress(1);
				// 		flag_progress = 1;
				// 		return false;
				// 	}
				// })
				// if(flag_progress == 0){
				// 	refresh_progress(0);
				// }
			}else{
				_alert(1,"发现主机","任务信息查询失败："+user_result.ErrMsg);
				clearInterval(if_ok);
				$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
				$("table").next("div.tab-i").children("div.il").find("span.select_total").text(0);
				$("#user_total").text(0);
				$("#totalpage").text(1);
				document.getElementById("user_page").value=1;
				return false;
			}
		}
	});
	update_array();
}
var re_5;
//显示列表
$(document).ready(function(){
	$("#page_nums option:eq(10)").prop("selected",true);
	show_fh_list();
	//每5秒刷新列表 ->刷新未完成任务进度
	re_5 = function(){
		if_ok = setInterval(function(){
			showMsg();
		},5000)}
	// 停止刷新列表
	// startget.end = function(){
	// 	clearInterval(if_ok);
	// 	}
	re_5();
})
//分页刷新
function user_page(num){
	var paging=parseInt(document.frm_fh.paging.value)+num;
	if(paging==0 || paging==document.frm_fh.fenye.value+1){
		return false;
	}
	select_save();
	var fh_list_s = [];
	if (num == 0.1){
		paging = 1;
	}else if(num == 0.9){
		paging = document.frm_fh.fenye.value;
	}
	document.getElementById("user_page").value=paging;
	document.frm_fh.paging.value=paging;
	show_fh_list();
}

//全选按钮
function select_all(){
	var select_array = select_str.split(',');
	if(select_array[select_array.length-1] == ""){
		select_array.splice(select_array.length-1,1);
	}
	if(select_array.length == ds_array.length){
		select_str = '';
	}else{
		$.each(ds_array,function(i,item){
			select_str=select_str+item.HostScanTaskId+',';
		});
	}
	show_fh_list();
}

//刷新
function refresh(){
	user_page(0);
	$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
	$("#check_page").iCheck('uncheck');
	select_str="";
	check_num=0;
	$("#select_total")[0].textContent = 0;
}

//停止任务
function stop_fun(ids){
	var ids_s = ids.split(',');
	$.each(ids_s,function(i,item){
		$.each(user_data.data,function(i1,item1){
			if(item1.HostScanTaskId == item){
				var deviceserviceid = [];
				$.each(item1.DeviceServiceSet,function(i2,item2){
					deviceserviceid.push(item2.DeviceServiceId);
				})
				var jsondata_s = {
					"HostScanTaskId": "",
					"TaskName": "",
					"NetWorkSeg": "",
					"DeviceServiceId": "",
					"Status":4,
					"Result": [],
					"UserCode":parent.window.document.frm.us.value
				}
				jsondata_s.HostScanTaskId = item1.HostScanTaskId;
				jsondata_s.TaskName = item1.TaskName;
				jsondata_s.NetWorkSeg = item1.NetWorkSeg;
				$.each(deviceserviceid,function(i2,item2){
					jsondata_s.DeviceServiceId += item2;
				})
				msstr = aceg(JSON.stringify(jsondata_s),$("input[name=se]").val());
				$.ajax({
					url:'/bhost/save_hostscan_task_s',
					type:"POST",
					async:false,
					data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata_s),m1:msstr},
					success: function(Result) {
						return true;
					}
				})
			}
		})
	})
	$.ajax({
		url: '/bhost/stop_hostscan_task',
		type: "POST",
		async:false,
		data: {a0:$("input[name=se]").val(),a1:ids},
		success: function(result) {
			return true;
		}
	})
	showMsg();
}

//删除函数
function delete_fun(select_str_r,obj){
	var stop_str = "";
	var delete_str = "";
	if(obj != null){	//单独删除
		//停止执行中任务
		if($(obj).parent().parent().prev().text().indexOf('执行中') != -1){
			layer.open({
				type:1,
				title: '发现主机',
				content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
				btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				yes:function(i){
					layer.close(i);
					layer.open({
						type:1,
						title: '发现主机',
						content: '<div class="layer-alert"><i class="alert warning"></i>选中任务处于执行状态 是否停止</div>',
						btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
						btnAlign:'c',
						closeBtn: false,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						yes:function(i){
							layer.close(i);
							select_str_r = select_str_r.toString();
							stop_fun(select_str_r); 
							select_str="";
							check_num=0;
							$("#select_total")[0].textContent = 0;
						},
						no:function(i){
							layer.close(i);
						}
					});
				},
				no:function(i){
					layer.close(i);
				}
			});
		}else{
			layer.open({
				type:1,
				title: '发现主机',
				content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
				btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				yes:function(i){
					layer.close(i);
					$.ajax({
						url: '/bhost/del_hostscan_task',
						type: "POST",
						async:false,
						data: {a0:$("input[name=se]").val(),a1:select_str_r},
						success: function(result) {
							var result = JSON.parse(result);
							if(result.Result == true){
								refresh();
								_alert(0,"发现主机","删除成功");
							}else{
								_alert(1,"发现主机",result.ErrMsg);	
								return false;
							}	
						}
					})
				}
			});
		}
	}else{				//批量删除
		$.each(select_str_r,function(i,item){
			if(item.S_status == "1"){
				stop_str +=  item.S_taskid + ',';
			}else{
				delete_str +=  item.S_taskid + ',';
			}
		})
		stop_str = stop_str.substr(0,stop_str.length-1);
		delete_str = delete_str.substr(0,delete_str.length-1);
		if(delete_str != ""){
			$.ajax({
				url: '/bhost/del_hostscan_task',
				type: "POST",
				async:false,
				data: {a0:$("input[name=se]").val(),a1:delete_str},
				success: function(result) {
					var result = JSON.parse(result);
					if(result.Result == true){
						refresh();
						_alert(0,"发现主机","删除成功");
					}else{
						_alert(1,"发现主机",result.ErrMsg);	
						return false;
					}	
				}
			})
		}
		if(stop_str != ""){
			stop_fun(stop_str);
		}
	}
}
var select_status = [];
//删除按钮
function delete_backup(){
	select_save();
	if(select_str == ""){
		_alert(2,"发现主机","请选择要删除的数据");
		return false;
	}
	select_status = [];
	var select_st = {
		S_taskid: "",
		S_status: ""
	}
	select_str = select_str.substr(0,select_str.length-1);
	var select_str_r = select_str.split(',');
	$.each(select_str_r,function(i,item){
		$.each(user_data.data,function(i1,item1){
			if(item == item1.HostScanTaskId){
				select_st = {
					S_taskid: "",
					S_status: ""
				};
				select_st.S_taskid = item;
				select_st.S_status = item1.Status;
				select_status.push(select_st);
			}
		})
	})
	var flag_delete = 0; //判断是否有执行中任务；0---->没有   1---->有
	layer.open({
		type:1,
		title: '发现主机',
		content: '<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
		btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		yes:function(i){
			layer.close(i);
			$.each(select_status,function(i,item){
				if(item.S_status == 1){
					flag_delete = 1;
				}
			})
			if(flag_delete == 1){
				layer.open({
					type:1,
					title: '发现主机',
					content: '<div class="layer-alert"><i class="alert warning"></i>有选中任务处于执行状态 是否停止</div>',
					btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					yes:function(i){
						layer.close(i);
						delete_fun(select_status); 
						select_str="";
						check_num=0;
						$("#select_total")[0].textContent = 0;
					},
					no:function(i){
						layer.close(i);
					}
				});
			}else{
				delete_fun(select_status);
			}
		},
		no:function(i){
			layer.close(i);
		}
	});
}

function back() {
	$(".container2").hide();
	$(".container").hide();
	$(".container1").show();
	refresh();
}
var flag_bar = 0;		//	1----->退出
var done = 0;		//扫描完成个数
var rest = 0;		//未扫描个数
var total_num = 0;		//扫描总数
var l_result = "";		//最后扫描结果
function _getLoadBar(obj,prog,id){ //prog 为当前任务进度
	var prog = prog;
	var _loadBar = function(){
		$('#loadBarWrap').html('<div class="loadperw"><span id="loadPer"></span></div><span id="loadPerText">0%</span><div class="loadberBtn"><a id="loadberBtn0" style="display:block" href="javascript:;" onclick="_hide(this,'+id+')">隐藏</a><a id="loadberBtn" href="javascript:;" onclick="_showResult(this)">查看结果</a></div>');

		var j=0,imax=100;
		var progress_d = 0;
		var _runOut;
		if(prog != 0){
			j = $.trim(prog.split('%')[0]);
			$('#loadPer').width(j+'%');
			$('#loadPerText').text(j+"%");
		}
		var _run = function(){
			_runOut = setTimeout(function(){
				var jsondata = {
					"hostscantaskid":"",
					"limitrow":null,
					"offsetrow":null
				}
				jsondata.hostscantaskid = id;
				var progress = 0;
				$.ajax({
					url: '/bhost/get_hostscan_result',
					type: "POST",
					async: false,
					data: {a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata)},
					success: function(result) {
						var result = JSON.parse(result);
						if(result.Result == true){
							result = result.info;
							progress = result.progress;
							if(progress < progress_d){
								progress = progress_d;
							}else{
								progress_d = progress;
							}
						}else{
							_alert(1,"发现主机",result.ErrMsg);	
							return false;
						}	
					}
				})
				if(flag_bar == 1){
					j = 100;
				}else{
					j = progress;
				}
				if(j<imax){
					$('#loadPer').width(j+'%');
					$('#loadPerText').text(j+"%");
					_run();
				}else{
					$('#loadPer').width('100%');
					$('#loadPerText').text("100%");
					clearTimeout(_runOut);
					$('#loadberBtn0').hide();
					$('#loadberBtn').css('display','block');
				}
			},1000);
		}
		_run();
	}
	loadBarLayer = layer.open({
		title:false,
		closeBtn:false,
		content:'<div class="lodabar-w" id="loadBarWrap">加载中...</div>',
		btn:false,
		skin:'loadbar',
		area:['430px','400px'],
		move:false,
		success:function(i){
			_loadBar();
		}
	})
}

function _hide(obj,task_id){
	layer.close(loadBarLayer);
	flag_bar = 1;
	$(".container2").hide();
	$(".container1").show();
	$(".container").hide();
	document.frm_fh.search_typeall.value = "";
	document.frm_fh.search_typeall_n.value = "";
	show_fh_list();
	get_current_page(task_id);
	showMsg();
}

function _showResult(obj){
	layer.close(loadBarLayer);
	// result1(taskid);
	// layer.open({
	// 	title:'查看结果',
	// 	content:$('#TDialog1').html(),
	// 	btn:['确定'],
	// 	area:'890px',
	// 	move:false,
	// 	skin:'layer-dialog2',
	// 	btnAlign:'c',
	// 	btn1:function(i){
	// 		layer.close(i);
	// 		result_save();
	// 		back();
	// 	},
	// })
	result_show(taskid);
}

</script>
<!--  result树  -->
<script>
//节点
var Data = [];
//子节点
var nodeData = [];

$('#userTree').on('click','i.h-aicon',function(){
	var $item = $(this);
	if($item.next().attr('id').split('-')[0] == 'node'){		//点击第一层
		var hasel = $item.parent().children('select').length;
		var id = $item.data('id').split('-')[1];
		if(hasel>0){
				id = $item.parent().children('select').val();
		}
		//alert(id);
		var $u = $item.parent().children('ul');
		if($u.is(':hidden')){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2,d;
				var $input = $(this).siblings('span.checkbox');
				if($(this).siblings('span.authtype').find('input').is(':checked')){
					d = 0;
				}else{
					d = 1;
				}
				
				if($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}

				_initHTML($u,id,v,d,$item.next().data('ableport'));
			}
		}else{
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	}else{								//点击第二层
		var hasel = $item.parent().children('select').length;
		var id = $item.parent().children('select').next().text();
		//alert(id);
		var $u = $item.parent().children('ul');
		if($item.attr('class') == 'h-aicon'){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2,d;
				var $input = $(this).siblings('span.checkbox');
				if($(this).siblings('span.authtype').find('input').is(':checked')){
					d = 0;
				}else{
					d = 1;
				}
				
				if($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}
				_initHTML1($u,id,v,d);
			}
		}else{
			$item.removeClass('h-aicon-d');
			$u.empty();
			$u.hide();
		}
	}
})

function result_tree(){
		_initSize();
		_initList();

		$('#userTree').on('ifChecked','span.authtype input',function(){
			var $input1 = $(this).parent().parent().parent().siblings('ul').find('span.authtype input');
			var $input2 = $(this).parent().parent().parent().siblings('ul').find('input.zcheck');

				$input1.prop('disabled',true).prop('checked',true);
				$input1.iCheck('update');
				$input2.prop('disabled',true).prop('checked',true);
				$(this).parent().parent().parent().siblings('input.zcheck').prop('checked',true).next('span.checkbox').attr('class','checkbox checked');;
				$.each($input2,function(){
					$(this).next('span.checkbox').attr('class','checkbox checked disabled');
				});

				_checkEvent($(this).parent().parent().parent().siblings('input.zcheck'));
		}).on('ifUnchecked','span.authtype input',function(){
			var $input1 = $(this).parent().parent().parent().siblings('ul').children('li').children('span.authtype').find('input');
			var $input2 = $(this).parent().parent().parent().siblings('ul').children('li').children('input.zcheck');

				$input1.prop('disabled',false);
				$input1.iCheck('update');
				$input2.prop('disabled',false);
				$input2.next('span.checkbox').removeClass('disabled');
		})
}

$(window).resize(function(){
		_initSize();
});

//-------------查看结果
var device_array = [];		//port ->设备类型表
var services_dic;
var service_array = [];		//设备类型:设备服务:端口表
var devices_dic;
var dvid_array = [];		//设备类型:id表
var dvid_dic;
var total_re;				//扫描结果
var task_service = [];		//任务选中的服务
var task_data;				//选中任务的信息
function result_show(id){
	editID = id;
	$(".container2").show();
	$(".container1").hide();
	$(".container").hide();
	document.getElementsByClassName('c-cont')[0].scrollTop = 0;//滚动条移动到最上方
	//节点
	Data = [];
	var d_array = [];
	var s_array = [];
	device_array = [];
	service_array = [];
	dvid_array = [];
	task_service = [];
	var str1 = "";
	$.ajax({
		url:'/bhost/get_devicetype_list',
		type:'post',
		async:false,
		data:{a0:$("input[name=se]").val(),z1:'null',z2:'null',z3:JSON.stringify([])},
		success:function(result){
			devicetype_list = JSON.parse(result);
			$.each(devicetype_list.data,function(i,item){
				$.each(item.ServiceSet,function(i1,item1){
					var str = item1.Port;
					if(d_array.indexOf(str) == -1){
						d_array.push(str);
					}
					sevices_dic = {
						devicetype_name: "",
						devicetypename : "",
						servicename: "",
						protocolid: 0,
						port: 0,
						serviceid:""
					}
					sevices_dic.devicetype_name = item.DeviceTypeName;
					sevices_dic.devicetypename = item.DeviceTypeIcon;
					sevices_dic.servicename = item1.DeviceServiceName;
					sevices_dic.protocolid = item1.ProtocolId;
					sevices_dic.port = item1.Port;
					sevices_dic.serviceid = item1.DeviceServiceId;
					service_array.push(sevices_dic);
				})
				dvid_dic = {
					devicetype_id:0,
					devicetype_name:""
				}
				dvid_dic.devicetype_id = item.DeviceTypeId;
				dvid_dic.devicetype_name = item.DeviceTypeName;
				dvid_array.push(dvid_dic);
			})

			$.each(d_array,function(i2,item2){
				str1 = "";
				devices_dic = {
					port : 0,
					servicetype : ""
				};
				devices_dic.port = item2;
				$.each(devicetype_list.data,function(i,item){
					if(item.DeviceTypeId <= 1000){
						$.each(item.ServiceSet,function(i3,item3){
							var str = item3.Port;
							if(item2 == str){
								str1 += item.DeviceTypeName + ',';
								return false;
							}
						})
					}
				})
				str1 = str1.substr(0,str1.length-1);
				devices_dic.servicetype = str1;
				device_array.push(devices_dic);
			})
		}
	})
	//console.log(dvid_array);
	//console.log(device_array);
	//console.log(service_array);

	var jsondata = {
		"hostscantaskid":"",
			"limitrow":null,
			"offsetrow":null
	}
	jsondata.hostscantaskid = id;
	$.ajax({
		url: '/bhost/get_hostscan_result',
		type: "POST",
		async:false,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata)},
		success: function(result) {
			var result = JSON.parse(result);
			if(result.Result == true){
				result = result.info;
				if(result.data.length == 0){
					layer.open({
						type:1,
						title: '发现主机',
						content: '<div class="layer-alert"><i class="alert warning"></i>该任务结果为空</div>',
						btn:['确&nbsp;&nbsp;认'],
						btnAlign:'c',
						closeBtn: false,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						yes:function(i){
							layer.close(i);
							back();
						}
					});

				}
				total_re = result;
				var t_port = [];
				var t_ip = [];
				$.each(result.data,function(i,item){
					if(t_ip.indexOf(item.HostIP) == -1){
						var data = {
							id: 1,//id
							name: '主机组1',//名称
							type: 0,//0：主机组，1：用户
							check: 0,//是否选中 0:未选中，1：选中，2：部分选中
							hostid: 0,
							disablePort:[]//已保存的端口
						}
						data.id = item.HostIP+':'+item.Port;
						data.name = item.HostIP;
						data.type = 0;
						data.hostid = item.HostId;
						data.check = item.IsExist;
						if(item.IsExist == 1){
							data.disablePort.push(item.Port);
						}
						t_ip.push(item.HostIP);
						Data.push(data);
					}else{
						$.each(Data,function(i1,item1){
							if(item1.id.split(':')[0] == item.HostIP){
								item1.id = item1.id + ',' + item.Port;
								if(item.IsExist == 1){
									item1.disablePort.push(item.Port);
								}else if(item1.check == 1){
									item1.check = 0;
								}
							}
						})
					}
				})
			}else{
				_alert(1,"发现主机",result.ErrMsg);	
				return false;
			}	
		}
	})
	var jsondata1 ={
		"hostscantaskid":null,
		"taskname":null,
		"networkseg":null,
		"starttime":null, 
		"endtime":null,
		"limitrow":1,
		"offsetrow":0,
		"UserCode":parent.window.document.frm.us.value
	}
	jsondata1.hostscantaskid = id;
	$.ajax({
		url: "/bhost/get_hostscan_task",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata1)},
		success:function(result){
			var user_result = JSON.parse(result);
			task_data = user_result.info.data[0];
			if (user_result.Result==true){
				var r = user_result.info.data[0];
				var str_s = "";
				$.each(r.DeviceServiceSet,function(i,item){
					str_s = item.DeviceServiceName + '(' + item.Port + ')';
					task_service.push(str_s);
				})
			}
		}
	})
	//console.log(task_service);
	result_tree();
	
	//var h = $('.c-wrap').height();
	//$('.c-wrap').css("height",h+70);
}

function _initSize(){
		var h = $(window).height();
		$('.h-catelog').height(h-260);
		$('.h-content2').height(h-200);
		$(".c-cont2").height(h-106);
}

function _initList(){
	var data = Data;
	_viewHTML(data,'#userTree');
}
var flag = 0;
usercode = window.document.frm.us.value;
function _initHTML(obj,id,v,d,disport){				//第二层
	//console.log(id);//id
	//子节点
	nodeData = [];
	var list1 = {
		id:0,
		name:""
	}
	var nodedata ={
		id: 0,
		type: 0,
		check: 0,
		list:[]
	}
	if(id.split(':')[2] == 0){			//创建
		var idn = id.split(':')[1];
		idn = idn.split(',');
		$.each(disport.split(','),function(i,item){
			$.each(idn,function(i1,item1){
				if(item == item1){
					idn.splice(i1,1);
				}
			})
		})
		//console.log(idn);
		var d_type = "";
		$.each(idn,function(i,item){
			$.each(device_array,function(i1,item1){
				if(item == item1.port){
					var device_str = item1.servicetype.split(',');
					$.each(device_str,function(i2,item2){
						if(d_type.indexOf(item2) == -1){ //过滤同名服务类型
							d_type += item2 + ',';
						}
					}) 
				}
			})
		})
		//console.log(d_type);
		d_type = d_type.substr(0,d_type.length-1);  //去掉最后一个逗号
		d_type = d_type.split(',');
		$.each(d_type,function(i1,item1){
			list1 = {
				id:0,
				name:0
			}
			list1.id = 'o' + id;
			list1.name = item1;
			nodedata.list.push(list1);
		})
		nodedata.id = 'n' + id;
		nodeData.push(nodedata);
	}else{								//编辑
		var idn = id.split(':')[2];
		$.ajax({
			url:'/bhost/getHost_info',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:idn,a2:usercode},
			success: function(Result) {
				host = JSON.parse(Result);
				list1.id = 'o' + id;
				list1.name = host.DeviceTypeName;
				nodedata.list.push(list1);
			}
		})
		nodedata.id = 'n' + id;
		nodeData.push(nodedata);
	}
	//console.log(nodeData);
	able_tmp = $(obj).siblings('input').data('able');
	disport_tmp = $(obj).siblings('input').data('ableport');
	//console.log($(obj));
	//console.log("able_tmp: "+able_tmp);
	//console.log("disport_tmp: "+disport_tmp);
	$(obj).empty();
	$.each(nodeData,function(i,item){
		if(item.list){
			var $H = $('<li />');
			var $sel = $('<select id="select-'+item.id+'" onchange="change_sertype(this)" style="width:8em" />');
			$.each(item.list,function(){
				$sel.append('<option value="'+this.id+'">'+this.name+'</option>');
			});

			if(item.type == 0){
				$H.html('<i class="h-aicon" data-id="arr-'+item.id+'" /><input type="checkbox"  onclick="click_this(this)" id="node1-'+item.id+'" data-check="1" data-able="'+able_tmp+'" data-ablePort="'+disport_tmp+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-d1" style="top:-3px;"></i>').append($sel).append('<ul style="display:none">Loading...</ul>');
			}
			$(obj).append($H);
			$(obj).find('select').select2({minimumResultsForSearch: -1});
			return;
		}
	});

	_checkView(obj);  
}

function change_sertype(obj){
	//console.log("change le!");
	$item = $(obj).parent().find("i.h-aicon")
	var id = $item.parent().children('select').next().text();
	var $u = $item.parent().children('ul');
	if($item.attr('class') == 'h-aicon h-aicon-d'){
		$item.removeClass('h-aicon-d');
		$u.empty();
		$u.hide();
		if($item.attr('class') == 'h-aicon'){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2,d;
				var $input = $($item).siblings('span.checkbox');
				if($($item).siblings('span.authtype').find('input').is(':checked')){
					d = 0;
				}else{
					d = 1;
				}
				if($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}
				//console.log($u,id,v,d);
				_initHTML1($u,id,v,d);
			}
		}
	}
}

function _initHTML1(obj,id,v,d){			//第三层
	//console.log(obj +"="+ id +"="+ v +"="+ d);						//id
	//子节点
	nodeData = [];	
	nodeData_o = [];
	var hostip = $(obj).parent().find('input').attr('id');
	hostip = hostip.split(':')[0];
	hostip = hostip.split('-n')[1];			//IP名称
	var devicetype = id;					//下拉框选中的设备类型
	//console.log(total_re.data)	//所有结果 {Port: 23, HostIP: "192.168.0.1", HostId: 27, IsExist: 1}
	//console.log(service_array);	//设备类型配置{devicetype_name: "Windows", devicetypename: "Windows", servicename: "PCANY", protocolid: 16, port: 5631, serviceid:6}
	//console.log(task_data);			//任务信息{Status: 2, EndTime: "2018-10-17 15:30:04", Progress: 100, TaskName: "test1", StartTime: "2018-10-17 15:27:29", …}
	$.each(total_re.data,function(i,item){
		if(item.HostIP == hostip){
			var flag_port = 1;				// 0--> 找得到    1-->编辑状态下主机设备类型下找不到该端口服务
			$.each(service_array,function(i1,item1){
				if(task_data.DeviceServiceSet == null){ // 所有服务
					if(item1.devicetype_name == devicetype){
						if(item1.port == item.Port){
							flag_port = 0;
							var nodedata ={
								id: 0,
								type: 0,
								check: 0,
								list:""
							}
							nodedata.list = item1.servicename + '(' + item1.port + ')';
							nodedata.id = id + '-' + item1.protocolid;
							nodedata.check = item.IsExist;
							flag_node = 0;
							$.each(nodeData,function(i2,item2){
								if(item2.list == nodedata.list){
									if(item2.id == nodedata.id){ // 已存在
											flag_node = 1;
									}
								}
							})
							if(flag_node == 0){
								nodeData.push(nodedata);
							}
						}
					}
				}else{//指定部分服务
					flag_node = 0;
					$.each(task_data.DeviceServiceSet,function(i2,item2){
						if(item1.port == item.Port && item.Port == item2.Port && item1.servicename == item2.DeviceServiceName){
							flag_port = 0;
							var nodedata ={
								id: 0,
								type: 0,
								check: 0,
								list:""
							}
							nodedata.list = item1.servicename + '(' + item1.port + ')';
							nodedata.id = id + '-' + item1.protocolid;
							nodedata.check = item.IsExist;
							$.each(nodeData,function(i3,item3){
								if(item3.list == nodedata.list){
									if(item3.id == nodedata.id){
											flag_node = 1;
									}
								}
							})
							if(flag_node == 0){
								nodeData.push(nodedata);
							}
						}
					})
				}
			})
			if(flag_port == 1){
				var nodedata_o = {
					id: 0,
					type: 0,
					check: 0,
					list:[]
				}
				var protocolid_s = "";
				$.each(service_array,function(i2,item2){
					if(item2.port == item.Port ){
						var list1 = {
							id:0,
							name:""
						}
						list1.id = id + '-' + item2.protocolid;
						list1.name = item2.servicename + '(' + item2.port + ')';

						var flag_list = 0;		//判断是否存在  0-->不存在  ;1-->存在
						var n_list = nodedata_o.list;
						for(j=0;j<n_list.length;j++){
							if(list1.name == n_list[j].name){
								flag_list = 1;
							}
						}
						if(flag_list == 0){
							n_list.push(list1);
						}
						protocolid_s = n_list[0].id;
						return false;
					}
				})
				nodedata_o.id = protocolid_s;
				nodedata_o.check = item.IsExist;
				nodeData_o.push(nodedata_o);
			}
		}
	})
	$(obj).empty();
	//console.log("reload the third !");
	//console.log(nodeData);
	//console.log(nodeData_o);
	$.each(nodeData,function(i,item){
		if(item.type == 0){
			var $H = $('<li></li>');

			/*if(v==1 && d == 0){
				$H.html('<input type="checkbox" id="node2-'+item.id+'" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span><ul style="display:none">Loading...</ul>');
			}else if(v==1){
				$H.html('<input type="checkbox" id="node2-'+item.id+'" checked="checked" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span><ul style="display:none">Loading...</ul>');
			}else if(v==0){*/
				$H.html('<input type="checkbox" id="node2-'+item.id+'" data-check="0" class="zcheck zcheck-g" data-able="'+item.check+'" ><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span><ul style="display:none">Loading...</ul>');
			/*}else{
				if(item.check==1){
					$H.html('<input type="checkbox" id="node2-'+item.id+'" data-check="'+item.check+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span><ul style="display:none">Loading...</ul>');
					}else if(item.check==0){
						$H.html('<input type="checkbox" id="node2-'+item.id+'" data-check="'+item.check+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span><ul style="display:none">Loading...</ul>');
					}else{
						$H.html('<input type="checkbox" id="node2-'+item.id+'" data-check="'+item.check+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2" class="zcheck"></i><span class="h-name">'+item.list+'</span><ul style="display:none">Loading...</ul>');
					}
			}*/
			$(obj).append($H);
		}/*else if(item.type == 1){
			if(v==1 && d == 0){

				$(obj).append('<li><i class="h-blank" /><input type="checkbox" check=""id="node2-'+item.id+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span></li>');
			}else if(v==1){

				$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="node2-'+item.id+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span></li>');
			}else if(v==0){

				$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="node2-'+item.id+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span></li>');
			}else{

				$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="node2-'+item.id+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item.list+'</span></li>');
			}
		}*/

		if(d==0){
			$(obj).find('input').prop('disabled',true);
		}
	});
	$.each(nodeData_o,function(i,item){
		$.each(item.list,function(i1,item1){
			if(item.type == 0){
				var $H = $('<li></li>');
				/*if(v==1 && d == 0){
					$H.html('<input type="checkbox" id="node2-'+item.id+'" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item1.name+'</span><ul style="display:none">Loading...</ul>');
				}else if(v==1){
					$H.html('<input type="checkbox" id="node2-'+item.id+'" checked="checked" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item1.name+'</span><ul style="display:none">Loading...</ul>');
				}else if(v==0){*/
					$H.html('<input type="checkbox" id="node2-'+item.id+'" data-check="0" class="zcheck zcheck-g" data-able="'+item.check+'" ><i class="h-eicon h-eicon-s2"></i><span class="h-name">'+item1.name+'</span><ul style="display:none">Loading...</ul>');
				//}
			}
			$(obj).append($H);
		})
	});

	_checkView(obj);
}

function change_trigger(obj){
	var node_id = $(obj).val();
	node_id = "node2-"+node_id;
	$(obj).parent().find('input').attr('id',node_id);
}

function _viewHTML(data,obj){				//第一层
	$(obj).empty();
	if(data.length != 0){	
		$(obj).append('<li><input type="checkbox" id="select_a" style = "margin-left:22px" onclick="select_host(this)" data-check="0" class="zcheck zcheck-g"><span class="h-name">全选</span></li>');
	}
	//console.log("_viewHTML");
	//console.log(data);
	$.each(data,function(i,item){
		if(item.type == 0){
			var $H = $('<li></li>');
			/*if(item.check==1){
				$H.html('<i class="h-aicon" data-id="arr-'+item.id+':'+item.hostid+'" /><input type="checkbox" checked="checked" id="node-'+item.id+':'+item.hostid+'" data-check="'+item.check+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name">'+item.name+'</span><ul style="display:none">Loading...</ul>');
			}else if(item.check==0){*/
				$H.html('<i class="h-aicon" data-id="arr-'+item.id+':'+item.hostid+'" /><input type="checkbox" id="node-'+item.id+':'+item.hostid+'" onchange="click_this(this)" data-check="0" data-able="'+item.check+'" data-ablePort="'+item.disablePort.join(',')+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name">'+item.name+'</span><ul style="display:none">Loading...</ul>');
			/*}else{
				$H.html('<i class="h-aicon" data-id="arr-'+item.id+':'+item.hostid+'" /><input type="checkbox" id="node-'+item.id+':'+item.hostid+'" data-check="'+item.check+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name">'+item.name+'</span><ul style="display:none">Loading...</ul>');
			}*/

				$(obj).append($H);

		}else if(item.type == 1){
			if(item.check){
				$(obj).append('<li><i class="h-blank" /><input type="checkbox" checked="checked" id="node-'+item.id+':'+item.hostid+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name">'+item.name+'</span></li>');
			}else{
				$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="node-'+item.id+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name">'+item.name+'</span></li>');
			}
		}
	});

	_checkView(obj);
}

function click_this(obj){
	if($(obj).parent().find('i:first').attr('class') == 'h-aicon' && $(obj).is(':checked')){
		$(obj).parent().find('i:first').click();
	}
	if($(obj).parent().find('ul').children().length != 0 && $(obj).parent().find('ul').children().find('i:first').attr('class') == 'h-aicon'){		//点开第三层
		$(obj).parent().find('ul').children().find('i:first').click();
	}
}

function _checkView(obj){
	$('span.authtype input',obj).iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});

	$('input.zcheck',obj).each(function(){
		var $s = $('<span class="checkbox"></span>');
		$(this).after($s);
		var v = $(this).prop('checked');
		if(v){
			$s.addClass('checked');
		}else{
			var c = $(this).data('check');
			if(c && c==2){
				$s.addClass('half');
			}
		}
		var f = $(this).data('able');
		if(f == 1){
			$s.attr("style", "background-position: -60px 0; cursor: default;");
		}
		var d = $(this).prop('disabled');
		if(d){
			$s.addClass('disabled');
		}
	}).on('change',function(){
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul');
		var d;
		if($(this).siblings('span.authtype').find('input').is(':checked')){
			d = 0;
		}else{
			d = 1;
		}

		if(v){
			$s.attr('class','checkbox checked');
			$('input.zcheck',$u).prop('checked',true);
			$('span.checkbox',$u).attr('class','checkbox checked');
			//$u.find('span.authtype').show();
		}else{
			$s.attr('class','checkbox');
			$('input.zcheck',$u).prop('checked',false);
			$('span.checkbox',$u).attr('class','checkbox');
			//$u.find('span.authtype').hide();
		}

		if(d==0){
			$('span.checkbox',$u).addClass('disabled');
		}

		_checkEvent(this);
	});
}

function _checkEvent(obj){
	var _run = function(){
		var $li = $(obj).parent().parent().parent();
		var tagname = $li[0].tagName.toLowerCase();
		var v = $(obj).prop('checked');
		/*
		if(v){
			$(obj).siblings('span.authtype').show();
		}else{
			$(obj).siblings('span.authtype').hide();
		}
		*/

		if(tagname == 'li'){
			var c1=0,c2=0;
			var len = $(obj).parent().parent().children('li').length;
			$(obj).parent().parent().children('li').each(function(){
				var c = $(this).children('span.checkbox').attr('class');
				if(c.indexOf('checked')>0){
					c1++;
				}else if(c.indexOf('half')>0){
					c2++;
				}

				if(c1 == len){
					$li.children('input.zcheck').prop('checked',true).siblings('span.checkbox').attr('class','checkbox checked');//.siblings('span.authtype').show();
				}else if(c1==0 && c2==0){
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox');//.siblings('span.authtype').hide();
				}else{
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox half');
					/*
					setTimeout(function(){
						$li.children('span.authtype').show();
					},1);
					*/
				}
			});
			_checkEvent($li.children('input.zcheck'));
		}else{
			return;
		}
	}

	_run();
}
var jsondata_list = [];
function result_save(){
	jsondata_list = [];
	var flag_ser = 0;
	var flag_dev = 0;
	$.each($("#userTree").find('span.checkbox'),function(i,item){
		if($(item).attr('class') == "checkbox checked" || $(item).attr('class') == "checkbox half"){
			//console.log($(item).prev().data('able'));
			if($(item).prev().data('able') == "0"){
				var jsondata = {
					"HostId": 0,
					"HostName": "主机1",
					"HostIP": "192.168.0.153",
					"Description": "",
					"AccessRate": 1,   
					"EnableLoginLimit": false,  
					"Status": 0,
					"DeviceTypeId": 14,
					// "DeviceTypeName":"Windows",
					"HGroupSet": [
					],
					"ServiceSet": [
					],
					"AccountSet": [
					]
				}
				var accountset ={
					"PasswordAuthId": 0,
					"Password": null,
					"PasswordType": 0,
					"HostServiceSet": [
					],
					"HostAccount": {
						"AccountId": 5,
						"IsSuperAcct": false,
						"IsSameUser":true,
						"FromAccountId": null,
						"AcctSwitchCmd": null, 
						"SwitchPasswdPrompt": null
					}
				}	
				if($(item).prev().attr('id').split('-')[0] == 'node'){		//找到要保存主机
					if($(item).prev().attr('id').split(':')[2] == 0){				//创建
						var d_ip = $(item).prev().attr('id').split('-')[1].split(':')[0];
								//IP
						if($(item).parent().find('ul:first').is(':hidden') == true){
							flag_dev = 1;
							_alert(2,"发现主机",d_ip+'请选择设备类型');
							return false;
						}
						var d_type_n = $(item).parent().find('ul:first').children().find('select:first').next().text();	//设备类型
						var de_type_id = 0;
						$.each(dvid_array,function(i1,item1){
							if(item1.devicetype_name == d_type_n){
								de_type_id = item1.devicetype_id;
							}
						})
						flag_ser = 0;
						$.each($(item).parent().find('ul').not(':hidden').last().find('span.checkbox'),function(i1,item1){
							if($(item1).next().attr('class') != 'h-eicon h-eicon-s2'){
								_alert(2,"发现主机",d_ip+'请选择服务');
								flag_ser = 1;
								return false;
							}
							if($(item1).prev().is(':checked') && $(item1).prev().data('able') == 0){
								var serviceset = {
									"HostServiceId": 0,
									"HostServiceName": "test",
									"ProtocolId": 6,
									"Port": 1521,
									"ConnParamId": null,
									"DomainId": null,
									"FromHostServiceId": null,
									"FromAccountId": null,
									"FromLoginCmd": null,
									"NormalPrompt": null,
									"SuperPrompt": null,
									"AcctSwitchCmd": null,
									"SwitchPasswdPrompt": null,
									"LoginUserPrompt": null,
									"LoginPasswdPrompt": null,
									"LoginSuccPrompt": null,
									"ExtraPrompt": null, 
									"ExtraReply": null,
									"LineBreak": null,
									"AccIPSet": [
									],
									"IsAcc":0
								}						
								serviceset.ProtocolId = $(item1).prev().attr('id').split('-')[2];
								if($(item1).next().next().prop('tagName') == "SPAN"){
									str_port = $(item1).next().next().text().split('(')[1];
									serviceset.HostServiceName = $(item1).next().next().text().split('(')[0];
									
								}else{
									str_port = $(item1).next().next().find("option:selected").text().split('(')[1];
									serviceset.HostServiceName = $(item1).next().next().find("option:selected").text().split('(')[0];
								}
								str_port = str_port.substr(0,str_port.length-1);
								serviceset.Port = str_port;
								jsondata.ServiceSet.push(serviceset);
								var hostserviceset = {
									"HostId": 0,
									"HostServiceId": 0,
									"HostServiceName": "test"
								}
								hostserviceset.HostServiceName = $(item1).next().next().text().split('(')[0];
								accountset.HostServiceSet.push(hostserviceset);
							}
						});
						if(flag_ser == 1){
							return false;
						}
						jsondata.HostName = d_ip;
						jsondata.HostIP = d_ip;
						jsondata.DeviceTypeId = de_type_id;
						// jsondata.DeviceTypeName = d_type_n;

						jsondata.AccountSet.push(accountset);
						jsondata_list.push(jsondata);
						// var AccessAuth = {"HGId":1,"HostId":0,"AccessAuthSet":[]};
						// $.ajax({
						// 	url: '/bhost/add_host',
						// 	type: "POST",
						// 	async: false,
						// 	data: {a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata)},
						// 	success: function (result) {
						// 		var result = JSON.parse(result);
						// 		if (result.Result) {
						// 			_alert(0,"发现主机",'操作成功!');
						// 		}
						// 		else{
						// 			_alert(1,'发现主机','保存'+d_ip+'失败，失败原因：'+result.ErrMsg);
						// 		}
						// 	}
						// });
					}else{								//编辑
						var d_id = $(item).prev().attr('id').split(':')[2];
						var d_ip = $(item).prev().attr('id').split('-')[1].split(':')[0];
						if($(item).parent().find('ul:first').is(':hidden') == true){
							flag_dev = 1;
							_alert(2,"发现主机",d_ip+'请选择设备类型');
							return false;
						}
						var host;
						$.ajax({
							url:'/bhost/getHost_info',
							type: "post",
							async:false,
							cache:false,
							data: {a0:$("input[name=se]").val(),a1:d_id,a2:usercode},
							success: function(Result) {
								host = JSON.parse(Result);
							}
						})
						$.each(host.AccountSet,function(i1,item1){		//保存原有账户信息
							var json = item1.HostAccount;
							delete json["AccountName"];
							delete json["FromAccountName"];
							var json1 = item1.HostServiceSet 
							$.each(json1,function(i2,item2){
								delete item2["Port"];
								delete item2["ProtocolId"];
								delete item2["ConnParamId"];
								delete item2["ServiceName"];
								delete item2["ProtocolName"];
								delete item2["ConnParamName"];
								item2["HostId"] = d_id; 
							})
							jsondata.AccountSet.push(item1);
						})
						$.each(host.ServiceSet,function(i1,item1){		//保存原有服务信息
							var json = item1;
							delete json["DomainName"];
							delete json["FromHostId"];
							delete json["FromHostName"];
							delete json["ProtocolName"];
							delete json["ConnParamName"];
							delete json["FromAccountName"];
							delete json["FromHostServiceName"];
							jsondata.ServiceSet.push(item1);
						})
						flag_ser = 0;
						$.each($(item).parent().find('ul').not(':hidden').last().find('span.checkbox'),function(i1,item1){
							if($(item1).next().attr('class') != 'h-eicon h-eicon-s2'){
								_alert(1,"发现主机",d_ip+'未选择服务');
								flag_ser = 1;
								return false;
							}
							if($(item1).prev().is(':checked') && $(item1).prev().data('able') == 0){
								var serviceset = {
									"HostServiceId": 0,
									"HostServiceName": "test",
									"ProtocolId": 6,
									"Port": 1521,
									"ConnParamId": null,
									"DomainId": null,
									"FromHostServiceId": null,
									"FromAccountId": null,
									"FromLoginCmd": null,
									"NormalPrompt": null,
									"SuperPrompt": null,
									"AcctSwitchCmd": null,
									"SwitchPasswdPrompt": null,
									"LoginUserPrompt": null,
									"LoginPasswdPrompt": null,
									"LoginSuccPrompt": null,
									"ExtraPrompt": null, 
									"ExtraReply": null,
									"LineBreak": null,
									"AccIPSet": [
									],
									"IsAcc":0
								}
							
								serviceset.ProtocolId = $(item1).prev().attr('id').split('-')[2];
								if($(item1).next().next().prop('tagName') == "SPAN"){
									str_port = $(item1).next().next().text().split('(')[1];
									serviceset.HostServiceName = $(item1).next().next().text().split('(')[0];
									
								}else{
									str_port = $(item1).next().next().find("option:selected").text().split('(')[1];
									serviceset.HostServiceName = $(item1).next().next().find("option:selected").text().split('(')[0];
								}
								str_port = str_port.substr(0,str_port.length-1);
								serviceset.Port = str_port;
								jsondata.ServiceSet.push(serviceset);
								var hostserviceset = {
									"HostId": 0,
									"HostServiceId": 0,
									"HostServiceName": "test"
								}
								hostserviceset.HostId = d_id;
								hostserviceset.HostServiceName = $(item1).next().next().text().split('(')[0];
								accountset.HostServiceSet.push(hostserviceset);
							}
						});
						if(flag_ser == 1){
							return false;
						}
						jsondata.HostName = host.HostName;
						jsondata.HostIP = host.HostIP;
						jsondata.DeviceTypeId = host.DeviceTypeId;
						jsondata.HGroupSet = host.HGroupSet;
						jsondata.HostId = d_id;
						// accountset.PasswordAuthId = host.ServiceSet
						jsondata.AccountSet.push(accountset);
						jsondata_list.push(jsondata);

						// var AccessAuth = {
						// 	"HGId":1,
						// 	"HostId":0,
						// 	"AccessAuthSet":[]
						// };
						// AccessAuth.HGId = host.HGroupSet[0].HGId;
					}
				}
			}
		}
	})
	if(flag_ser == 1 || flag_dev == 1){
		return false;
	}
	//console.log(jsondata_list);
	//return false;
	flag_s = _save(jsondata_list);		// ---->成功               0 ---->失败
	if(flag_s == 1){
		layer.open({
			type:1,
			title:"发现主机",
			content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
			btn:'确&nbsp;&nbsp;定',
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
				layer.close(i);
				back();
			}
		});
	}
}

function _save(data){
	var flag_g = false;
	$.each(data,function(i,item){
		msstr = aceg(JSON.stringify(item),$("input[name=se]").val()); 
		$.ajax({
			url: '/bhost/add_host',
			type: "POST",
			async: false,
			data: {a0:$("input[name=se]").val(),a1:JSON.stringify(item),m1:msstr},
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					return true;
				}
				else{
					_alert(1,"发现主机",'保存'+item.HostIP+'失败，失败原因：'+result.ErrMsg);
					flag_g = true;
					return false;
				}
			}
		});
	})
	if(flag_g == true){
		return 0;
	}else{
		return 1;
	}
}

function select_host(obj){
	if(!$('#select_a').prop('checked')){
		$.each($("#userTree").find('span.checkbox').not(":first"),function(i,item){
			if($(item).attr('class') == 'checkbox checked'){
				$(item).prev().click();
			}
		})
	}else{
		$.each($("#userTree").find('span.checkbox').not(":first"),function(i,item){
			if($(item).attr('class') == 'checkbox'){
				$(item).prev().click();
			}
		})
	}
}

</script>

{% endblock  %}
			
