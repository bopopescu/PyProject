{% extends "index.html" %} {% block head %}
<!--icheck-->
<script src="/manage/js/icheck.min.js"></script>
<script src="/manage/js/select2.full.min.js"></script>
<script src="/manage/js/xSelect.js"></script>
<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
<link rel="stylesheet" href="/manage/css/select2.min.css">
<link rel="stylesheet" href="/manage/css/new-head.css">
<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
<link rel="stylesheet" href="/manage/css/G-style.css" type="text/css" /> 
{% endblock %} {% block main %}
<!---->
<!---->
<div class="mainer">

	<div class="container" id="step1">
		<div class="c-top">
			<div class="c-title">
			<!--	<h3 class="tit" onclick="back();"><span>主机</span><i class="icon-host"></i></h3>-->
			<div class="manual-head" style="float:left;width:100px">
				<div class="manual-title" >
						<span id="host_add" onclick="reload(1)" style="cursor: pointer;">主机</span>
					<i class="host_add_icon"></i>
				</div>
			</div>
			<!--div class="ctr">
				<a href="javascript:;" class="ret" onclick="_closePage(this)"><i></i></a>
			</div-->
			</div>
		</div>

		<div class="c-cont">
			<div class="c-wrap" style="padding: 10px 0 0">
				<div class="c-exp" style="margin: -1px auto;">

					<div class="h-explorer">
						<div class="G-top">
							<div class="G-box1"></div>
							<strong>&nbsp;基本信息</strong>
							<div class="G-box2">启用：
								<input type="checkbox" class="form-checkbox" name="" id="Enabled" value="" checked="checked">
							</div>
						</div>

						<div class="h-content2" style="height:auto;width: 100%;overflow: hidden;padding: 14px 0 0;">
							<div class="form-item" style="">
								<span class="form-tag" style=""><em class="imp">*</em>主机IP：</span>
								<div class="form-c" style="">
									<input type="text" class="form-text" onblur="ipCheck(this)" id="HostIP" maxlength="31" style="width: 120px;"><i class="v-check"></i>
									<button class="form-button" onclick="_getDialog_pingTest();">Ping测试</button>
								</div>
							</div>

							<div class="form-item" style="">
								<span class="form-tag" style=""><em class="imp">*</em>主机名：</span>
								<div class="form-c" style="">
									<input type="text" class="form-text" onblur="NameCheck(this)" id="HostName" maxlength="31" style=""><i class="v-check"></i>
									<p class="form-tip" style="padding-left: 80px;">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>设备类型：</span>
								<div class="form-c">
									<select class="form-select" name="" id="host_type" style="width:215px">
										<option value="" selected >请选择</option>
									</select>

									<div class="rzj" id="host_icon">
										<i style="margin-left: 0;display:none" class="host-type host-type1 on" data="Windows" title="Windows"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type2 on" data="Linux" title="Linux"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type3 on" data="Unix" title="Unix"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type5 on" data="AS400" title="AS400"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type6 on" data="Cisco" title="Cisco"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type4 on" data="H3C" title="H3C"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type7 on" data="Huawei" title="Huawei"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type8 on" data="Network" title="Network"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type9 on" data="Host" title="Host"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type10 on" data="Server" title="Server"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type11 on" data="Cluster" title="Cluster"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type12 on" data="Switchboard" title="Switchboard"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type13 on" data="Firewall" title="Firewall"></i>
										<i style="margin-left: 0;display:none;" class="host-type host-type14 on" data="Aix" title="Aix"></i>
										<i style="margin-left: 0;display:none" class="host-type host-type15 on" data="Ruijie" title="Ruijie"></i>
									</div>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">描述：</span>
								<div class="form-c">
									<input class="form-text" name="" id="Description" maxlength="128" />
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">访问速度：</span>
								<div class="form-c">
									<div class="form-label-group" id="AccessRate">
										<label class="form-label"><input class="form-radio" type="radio" name="speed" id="speed1" value="0" checked>正常</label>
										<label class="form-label"><input class="form-radio" type="radio" name="speed" id="speed2" value="1">较慢</label>
										<label class="form-label"><input class="form-radio" type="radio" name="speed" id="speed3" value="2">很慢</label>
									</div>
								</div>
							</div>
							<!-- <div class="form-item">
								<span class="form-tag">多点登录：</span>
								<div class="form-c">
									<div class="form-label-group" id="">
										<label class="form-label"><input class="form-radio" type="radio" name="EnableLoginLimit" id="EnableLoginLimit1" value="false" checked>允许</label>
										<label class="form-label"><input class="form-radio" type="radio" name="EnableLoginLimit" id="EnableLoginLimit2" value="true">限制</label>
									</div>
								</div>
							</div> -->
							<div class="form-item" style="width: 150px; margin-left: -33px">
								<span class="form-tag" style="width: 113px;" >唯一登录：</span>
								<div class="form-c" style="" >
									<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="" id="EnableLoginLimit"></label>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="c-exp" style="margin: -1px auto;">
					<div class="h-explorer">
						<div class="G-top">
							<div class="G-box1"></div><strong>&nbsp服务</strong>
						</div>
						<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
							<div class="c-table">

								<div class="box-table">
									<table cellpadding="0" cellspacing="0" style="margin-bottom:20px;">
										<thead>
											<tr>
												<th style="display: none;">服务名称</th>
												<th>协议(端口)</th>
												<th>连接参数</th>
												<!-- <th>AD域</th> -->
												<th>应用发布</th>
												<th width="54"></th>
											</tr>
										</thead>

										<tbody id="service_list" style="height:auto">

										</tbody>
									</table>
								</div>
								<div class="form">
									<div class="form-item form-item-100" style="width:100%">
										<div style="text-align: right;"><a href="javascript:;" id="" class="btn btn-normal1" onclick="_getDialog1('add','');">添&nbsp;&nbsp;加</a>
											<!--<a href="javascript:;" class="btn btn-normal1" onclick="clear_server();">重&nbsp;&nbsp;置</a>--></div>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
				<div class="c-exp" style="margin: -1px auto;">
					<div class="h-explorer">
						<div class="G-top">
							<div class="G-box1"></div><strong>&nbsp账号 </strong>
						</div>
						<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
							<div class="c-table">

								<div class="box-table">
									<table cellpadding="0" cellspacing="0" style="margin-bottom:20px;font-weight: 400;">
										<thead>
											<tr>
												<th>账号</th>
												<th>密码</th>
												<th>服务</th>
												<th>认证方式</th>	
												<th style="width: 78px"></th>
											</tr>
										</thead>

										<tbody id="service_account_list">

										</tbody>
									</table>
								</div>
								<div class="form">
									<div class="form-item form-item-100" style="width:100%">
										<div style="text-align: right;"><a href="javascript:;" id="" class="btn btn-normal1" onclick="_getDialog2('add',0);" style="font-weight: normal;">添&nbsp;&nbsp;加</a>
											<!--<a href="javascript:;" class="btn btn-normal1" onclick="clear_server();">重&nbsp;&nbsp;置</a>--></div>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
				<!-- <div class="c-exp" style="margin: -1px auto;" id="exp_auth" >
					<div class="h-explorer">
						<div class="G-top">
							<div class="G-box1"></div><strong>&nbsp访问授权</strong>	
						</div>
						<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
							<div class="form-item" style="width: 100%;">
								<span class="form-tag" style="width: 180px">访问授权：</span>
								<div class="h-content3" id="select_a" style="margin-top: -19px; width:80%">
								</div>
							</div>
						</div>
					</div>
				</div> -->
				<!-- <div class="c-exp" style="margin: -1px auto;" id="" >
					<div class="h-explorer">
						<div class="G-top">
							<div class="G-box1"></div><strong>&nbsp批量加主机</strong>	
						</div>
						<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
							<div class="form-item" style="width: 100%;">
								<span class="form-tag" style="width: 180px">数量区间：</span>
								<input type="text" class="form-text" id="batch_start" maxlength="31" style="width: 120px;"> -
								<input type="text" class="form-text" id="batch_end" maxlength="31" style="width: 120px;">

							</div>
							<div class="form">
								<div class="form-item form-item-100" style="width:100%">
									<div style="text-align: right;"><a href="javascript:;" id="" class="btn btn-normal1" onclick="batch();">添&nbsp;&nbsp;加</a>
								</div>
							</div>
						</div>
					</div>
				</div> -->

				<div class="c-exp" style="margin: -1px auto; margin-bottom: 10px;">
					<div class="h-explorer" style="min-height: 300px">
						<div class="G-top">
							<div class="G-box1"></div><strong>&nbsp主机组</strong>
						</div>
						<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 14px 0 0 0;">
							<div class="h-top" style="background-color: #fff;border-bottom:none;    float: right;width: 50%;margin-top: -16px;">
								<div class="filter" style="float:right;min-width:652px;">
									<div id="waitTip" class="waitTip1" style="float: right;margin-top: 7px; margin-left: -26px;"></div>	
									<div class="search">
										<select name="server_select" id="server_select" class="filter-select">
											<option value="0" selected>所有</option>
											<option value="hgname">组名</option>
										</select>

										<input type="text" class="filter-text" 
										placeholder="输入关键字" name="server_text" id="server_text" 
										maxlength="128" style="padding-right: 22px;"
										onchange="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
										onkeyup="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
										onkeydown="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();};if (event.keyCode == 13){_addFilterFuzzy_s(this,false);$(this).blur();return false;} else return; " 
										onblur="change_input(this);return false;"
										>
										<i class="v-check v-wrong" id="server_text_check" 
										onclick="_clearFilter_s(this,1)" 
										style="display:none;cursor: pointer;float: left;position: static;"></i>
										<button class="filter-btn" onclick="_addFilterFuzzy_s(this,false)"><i class="add-filter"></i></button>
										<button class="filter-btn" onclick="_addFilterFuzzy_s(this,true)"><i class="append-filter"></i></button>

									</div>
									<div class="search" id="clearFilter_s" style="margin: 0px 15px 0px -16px;display:none;">
										<button class="filter-btn" onclick="_clearFilter_s(this)"><i class="clear-filter"></i></button>
									</div>
									<div class="selector selector-multiple" id="filterWW1" style="display: none;width: 210px;">
										<span class="ww">搜索条件</span>
										<ul style="padding-left: 0px;"></ul>
									</div>
								</div>
							</div>
							<div style="overflow: auto;width:56%;height:90%;" id="hosttree_div">
								<span class="form-tag">主机组：</span>
								<ul id="hostTree" class="hosttree" style="padding-left: 110px;margin-top: 2px;"></ul>
							</div>
							<!--<h2 style="width:180px;text-align: right;color: #333">主机组：</h2>-->

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="btns">
		<a href="javascript:;" class="btn btn-normal " onclick="savedata();" style="font-weight: 400;">保&nbsp;&nbsp;存</a>
		<!--
		<a href="javascript:;" class="btn btn-normal " onclick="back();" style="font-weight: 400;">取&nbsp;&nbsp;消</a>
		-->
	</div>
	<div id="bBtn" style="z-index: 5;">
		<a href="javascript:;" class="btn" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
	</div>
</div>
<!-- 浮层 -->
<!-- 服务-->
<div class="dialog-cont" id="scDCTab1" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:425px;max-height:430px;overflow:hidden;">
			<div class="c-wrap" style="padding:0;/*margin-top: -10px;*/overflow-y: auto;overflow-x: hidden;max-height: 368px;">
			<!-- <div class="c-wrap" style="padding:0 0 90px;margin-top: -10px;overflow: hidden;"> -->
				<div class="c-form c-form-host col3">

					<div class="clearfix"></div>
					<div class="c-table" style="padding: 0;">
						<div class="form" style="overflow: hidden;">
							<div class="form-item" style="width:100%" id="item_server">
								<span class="form-tag">服务载入：</span>
								<div class="form-c">
									<select class="form-select" name="" id="def_server" style="width: 132px;">
									</select>
								</div>
							</div>
							<div class="form-item" style="display: none;">
								<span class="form-tag">服务名称：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="HostServiceName" maxlength="128">
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>协议：</span>
								<div class="form-c" id="ProtocolName"></div>
								<!-- <div class="form-c">
									<select class="form-select" name="" id="ProtocolName" style="width: 132px;" onchange="pName_change();">
											<option value="">请选择</option>
										</select>
								</div> -->
							</div>
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>端口：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="Port" maxlength="5">
								</div>
							</div>
							<div class="form-item" style="/*width:20%;*/display: none;" id="same_sftp" >
								<span class="form-tag" style="margin-left: -4px;">同步创建SFTP：</span>
								<div class="form-c" style="margin-top: 3px;padding-left: 7em;">
									<label>
										<input type="checkbox" class="form-checkbox" id="same_sftp_check">
									</label>
								</div>
							</div>
							<!--
							<div class="form-item" id="connparam">
								<span class="form-tag">连接参数：</span>
								<div class="form-c">
									<div class="xSelect xSelect_connList" id="ConnParamName"></div>
								</div>
							</div>
							-->
								<!-- <div class="form-item">
									<span class="form-tag">AD域：</span>
									<div class="form-c">
										<span class="g-tsel" style="">
											<input id="DomainName" type="text" style="width: 100px" class="form-text " _id="" placeholder="输入AD域" onkeyup="_autoView(this,1,1)" onfocus="_autoView(this,1,1)" onblur="_hideView(1);">
										</span>
									</div>
								</div> -->

							<div class="form-item">
								<span class="form-tag">跳转来源主机：</span>
								<div class="form-c">
									<select class="form-select" name="" id="FromHostName" style="width: 132px;">
											<option value="">请选择</option>
										</select>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">跳转来源服务：</span>
								<div class="form-c">
									<select class="form-select" name="" id="FromHostServiceName" style="width: 132px;">
											<option value="">请选择</option>
										</select>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">跳转来源账号：</span>
								<div class="form-c">
									<select class="form-select" name="" id="FromAccountName" style="width: 132px;">
											<option value="">请选择</option>
										</select>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">跳转命令：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="FromLoginCmd" maxlength="128">
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">命令提示符：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="NormalPrompt" maxlength="128">
								</div>
							</div>
							<div class="form-item" style="display:none;">
								<span class="form-tag">特权提示符：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="SuperPrompt" maxlength="128"><i class="v-check"></i>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">账号切换命令：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="AcctSwitchCmd" maxlength="128">
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">切换密码提示：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="SwitchPasswdPrompt" maxlength="128">
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">登录名提示：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="LoginUserPrompt" maxlength="128">
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">登录密码提示：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="LoginPasswdPrompt" maxlength="128">
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">登录成功提示：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="LoginSuccPrompt" maxlength="128">
								</div>
							</div>

							<div class="form-item" style="display:none;">
								<span class="form-tag">额外提示：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="ExtraPrompt"><i class="v-check"></i>
								</div>
							</div>

							<div class="form-item" style="display:none;">
								<span class="form-tag">额外应答：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="ExtraReply"><i class="v-check"></i>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">换行符：</span>
								<div class="form-c">
									<select class="form-select" name="" id="LineBreak" style="width: 132px;">
											<option value="1" selected >LF</option>
											<option value="2">CR</option>
											<option value="3">CRLF</option>
										</select>
								</div>
							</div>
							<div class="form-item" id="_div_isacc" style="display:none;" >
								<span class="form-tag">应用通道：</span>
								<div class="form-c">
									<select class="form-select" name="" id="IsAcc" style="width: 132px;" onchange="change_isacc(this);">
										<option value="0" selected >禁用</option>
										<option value="1">启用</option>
										<option value="2">可选</option>
									</select>
								</div>
							</div>
							<div class="form-item form-item-100" id="div_conn" style="padding-bottom: 0px;">
								<span class="form-tag" style="line-height:33px;">连接参数：</span>
								<div class="form-item" id="conn_cont" style="width: 620px;/*max-height: 104px;*/overflow: hidden;padding: 2px 0;height: auto;">
									<div class="form-c srsCtl1" style="width:175px;padding: 0;float: left;margin-bottom:10px;">
										<div class="form-c" style="padding:0;width: 133px;float: left;">
											<div class="xSelect xSelect_connList" id="ConnParamName" style="border-bottom-left-radius: 5px;border-top-left-radius: 5px;border-top-right-radius: 5px;border-bottom-right-radius: 5px;"></div>
										</div>
										<a href="javascript:;" class="ctrl add" id="add5" style="display: inline;float: left;width: 15px;height: 15px;overflow: hidden;background: url(/manage/images/icon-ctr.png) no-repeat 0 0;background-position: 0 -15px;margin: 6px 0 0 10px;" onclick="_addconn(this);"></a>
									</div>
								</div>
							</div>
							<div class="form-item form-item-100" id="div_inip" style="">
								<span class="form-tag" style="line-height:33px;">应用发布：</span>
								<div class="form-item" id="accIP_cont" style="width: 620px;max-height: 104px;overflow: auto;padding: 2px 0;">
									<div class="form-c srsCtl" style="width:265px;padding: 0;float: left;margin-bottom:10px;">
										<div class="accIP_type" style="float:left;">
											<select class="filter-select" name="accIP_type" id="accIP_type" style="width:80px;border-bottom-right-radius: 0px;border-top-right-radius: 0px;float:left;" tabindex="-1" aria-hidden="false" onchange="change_acc_type(this);"> 
												<option value="1">内置</option>
												<option value="2" selected>外置</option>
											</select>
										</div>
										<div class="in_ip" style="float:left;margin-left: -1px;display:none;" >
											<select class="filter-select" name="in_ip" id="in_ip" style="width:138px;border-bottom-right-radius: 0px;border-top-right-radius: 0px;float:left;" tabindex="-1" aria-hidden="false"> 
												<option value="1">1</option>
												<option value="2">2</option>
												<option value="1">3</option>
												<option value="2">4</option>
												<option value="1">5</option>
												<option value="2">6</option>
												<option value="1">7</option>
												<option value="2">8</option>
												<option value="1">9</option>
												<option value="2">10</option>
												<option value="1">11</option>
												<option value="2">12</option>
												<option value="1">13</option>
												<option value="2">14</option>
												<option value="1">15</option>
												<option value="2">16</option>
												<option value="1">17</option>
												<option value="2">18</option>
												<option value="1">19</option>
												<option value="2">20</option>
											</select>
										</div>
										<div class="form-c" id="accIP" style="float:left;padding:0px;"></div>
										<a href="javascript:;" class="ctrl add" id="add4" style="display: inline;" onclick="_addaccIP(this);"></a>
									</div>
								</div>
								<div class="form-item" id="accIP_cont1" style="width: 620px;max-height: 104px;overflow: auto;padding: 2px 0;display: none;">
									<input type="text" class="form-text" id="" maxlength="128" value="全局指定" disabled="disabled">
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>
		<div class="btns" style="padding: 10px 0 10px;">
			<a href="javascript:;" class="btn btn-normal btn-submit">确&nbsp;&nbsp;定</a>
			<a href="javascript:;" class="btn btn-normal" onclick="reload(2);">重&nbsp;&nbsp;置</a>
		</div>
	</div>
</div>
<!-- 账号 -->
<div class="dialog-cont" id="scDCTab2" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:300px;max-height:300px">
			<div class="c-form c-form-host" style="padding: 0 0 90px;margin-top: -30px">
				<div class="clearfix"></div>
				<div class="c-table">
					<div class="form">
						<div class="form-item" style="width:100%">
							<span class="form-tag" style="width: 7em;"><em class="imp">*</em>服务：</span>
							<div class="form-c" name="" id="server_list" style="max-height: 77px;overflow: auto;padding-left: 0px;">
							</div>
						</div>
						<div class="form-item" style="width: 33%; margin-left: 1px;">
							<span class="form-tag" style="width: 7em;"><em class="imp">*</em>账号：</span>
							<div class="form-c">
								<div class="xSelect xSelect_AccList" id="AccountName"></div>
							</div>
						</div>
						<div class="form-item" style="width: 33%;">
							<span class="form-tag" style="width: 7em; margin-left: 31px;">认证方式：</span>
							<div class="form-c">
								<select class="form-select" name="" id="authType" style="width:142px" onchange="auth_change();" disabled>
									<option value="0">密码</option>
									<option value="1">密钥</option>
								</select>
							</div>
						</div>								
						<div class="form-item" style="width: 33%;">
							<span class="form-tag" style="width: 7em; margin-left: 10px;">特权帐号：</span>
							<div class="form-c" style="margin-top: 3px;">
								<label><input type="checkbox" name=""  class="form-checkbox" id="IsSuperAcct"></label>
							</div>
						</div>								
						<div class="form-item" style="width: 37%;padding-bottom: 9px;" id="item_pwd">
							<span class="form-tag" style="width: 7em;">密码：</span>
							<div class="form-c" style="/*margin-top: 1px;*/float: left;width: 170px;">
								<input type="password" class="form-text" id="password1" style="width: 110px;/*margin-top: -1px;*/">
								<label style="	/*line-height: 28px;*/" id="if_emptypwd_label">
									<input type="checkbox" name=""  class="form-checkbox" id="if_emptypwd" style="/*margin-top: -2px;*/">
								</label>
							</div>
							<span class="form-tag" style="width: auto;float: none;">空密码</span>
							
						</div>
						<div class="form-item" style="width: 29%;" id="item_pwd_con">
							<span class="form-tag" style="width: 7em;">确认密码：</span>
							<div class="form-c">
								<input type="password" class="form-text" id="password2" style="width: 110px">	
							</div>
						</div>
						<div class="form-item" style="width: 33%;display: none;" id="item_SSHKey">
							<span class="form-tag" style="width: 7em; margin-left: 2px;">密钥：</span>
							<div class="form-c">
								<div class="xSelect xSelect_SSHkey" id="SSHkey_s"></div>
							</div>
						</div>
						<div class="form-item" style="width: 33%;">
							<span class="form-tag" style="width: 7em; margin-left: 10px;">同一帐号：</span>
							<div class="form-c" style="margin-top: 3px;">
									<label><input type="checkbox" name=""  class="form-checkbox" id="IsSameUser"></label>
							</div>
						</div>
						<div class="form-item" style="width: 33%;">
							<span class="form-tag" style="width: 7em;">切换账号：</span>
							<div class="form-c">
								<select class="form-select" name="" id="FromAccount_acc" style="width:142px">
									<option value="0">请选择</option>
								</select>
							</div>
						</div>
						<div class="form-item" style="width: 30%;">
							<span class="form-tag" style="width: 7em; margin-left: 32px;">切换命令：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="AcctSwitchCmd_account" style="width: 110px">
							</div>
						</div>
						<div class="form-item" style="width: 30%; margin-left: 34px;">
							<span class="form-tag" style="width: 7em;">切换密码提示：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="SwitchPasswdPrompt_account" style="width: 110px">
							</div>
						</div>
					</div>
				</div>

				<div class="btns" style="padding: 10px 0 10px;">
					<a href="javascript:;" class="btn btn-normal btn-submit">确&nbsp;&nbsp;定</a>
					<a href="javascript:;" class="btn btn-normal" onclick="reload(3);">重&nbsp;&nbsp;置</a>
				</div>
			</div>
		</div>

	</div>
</div>

<!--ping test-->
<div class="dialog-cont" id="scDCTab3" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:300px;max-height:300px">
			<div class="c-form" style="width: 450px;padding: 0px;">
				<div class="clearfix"></div>
				<div class="form">
					<div class="form-item" style="width:100%">
						<div class="form-c" style="padding-left: 0px;">
							<textarea class="form-textarea" name="" id="ping" cols="30" rows="10" disabled="disabled" style="width: 430px;height: 150px; font-size: 13px;" value=""></textarea>
						</div>
					</div>					
				</div>
				<div class="btns" style="padding: 10px 0 10px;">
					
					<a href="javascript:;" class="btn btn-normal btn-submit">返&nbsp;&nbsp;回</a>
				</div>
			</div>
		</div>

	</div>
</div>

<!--连接测试-->
<div class="dialog-cont" id="scDCTab4" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:20px;max-height:200px">
			<div class="c-form c-form-host" style="padding: 0 0 90px;">
				<div class="clearfix"></div>
				<div class="c-table" style="padding:0px;">
					<div class="form">
						<div class="form-item" style="width: 100%;">
							<span class="form-tag" style="width: 7em; margin-left: 2px;">&nbsp;&nbsp;&nbsp;支持的协议：mssql、sybase、oracle、ssh、Telnet、mysql、rlogin、db2、vnc、ftp</span>
						</div>
					
					</div>
					<div class="form">
						<!--
						<div class="form-item" style="width: 33%;">
							<span class="form-tag" style="width: 7em;">账号：</span>
							<div class="form-c">
								<select class="form-select" name="" id="connectAccountSelect" style="width: 160px;">
								</select>
							</div>

						</div>-->
						<div class="form-item" style="width: 33%;">
							<span class="form-tag" style="width: 7em;">协议：</span>
							<div class="form-c">
								<select class="form-select" name="" id="connectProtoSelect" style="width: 160px;">
								</select>
							</div>

						</div>
						<div class="form-item" style="width: 33%;" id = "acc_test_conn">
							<span class="form-tag" style="width: 7em;">连接参数：</span>
							<div class="form-c">
								<select class="form-select" name="" id="connectParamSelect" style="width: 160px;">
								</select>
							</div>
						</div>
						
					</div>
				</div>

				<div class="btns" style="padding: 10px 0 10px;">
					<a href="javascript:;" class="btn btn-normal btn-submit">确&nbsp;&nbsp;定</a>
					<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
				</div>
			</div>
		</div>

	</div>
</div>
<div class="dialog-cont" id="scDCTab4_1" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:300px;max-height:300px">
			<div class="c-form" style="width: 450px;padding: 0px;">
				<div class="clearfix"></div>
				<div class="form">
					<div class="form-item" style="width:100%">
						<div class="form-c" style="padding-left: 0px;">
							<textarea class="form-textarea" name="" id="conn_test" cols="30" rows="10" disabled="disabled" style="width: 430px;height: 150px; font-size: 13px;" value=""></textarea>
						</div>
					</div>					
				</div>
				<div class="btns" style="padding: 10px 0 10px;">
					
					<a href="javascript:;" class="btn btn-normal btn-cancle">返&nbsp;&nbsp;回</a>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="dialog-cont" id="ADDialog" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:320px;max-height:320px">
			<div class="c-form" style="padding-bottom:10px;padding-top:0px">
					<div class="form">	
						<div class="form-item" >
							<span class="form-tag"><em class="imp">*</em>名称：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="ad_n" name="ad_n" maxlength="128" onblur="regCheck(this,nameReg);">
								<i class="v-check"></i>
								<p class="form-tip" style="margin-left: 109px;">特殊字符仅支持下划线、横杠、小数点</p>
							</div>
						</div>
					</div>
				</div>
			<div class="c-form c-form-host"style="min-width:650px;padding-top:0px;    margin-left: -9px;">
				<div class="form">
					<div class="form-item form-item-100 " style="width:900px;">
						<span class="form-tag"style="" ><em class="imp">*</em>服务器IP：</span>
						<div id="ip_n" name="ip_n" class="form-c"style="float: left;width:560px;    max-height: 154px;overflow: auto;">
							<span class="ss ss-add">
								<input type="text" style="" class="form-text form-text2" onkeyup="/*showMsg(this);*/" onkeyup="this.value=this.value.replace(/[^0-9.]/g,'')" onafterpaste="this.value=this.value.replace(/[^0-9.]/g,'')">
								<i class="ctr ctr-add" onclick="_addIp(this)" style="margin-top: 9px;    margin-left: 3px;"></i>
							</span>
						</div>
					</div>
				</div>
			</div>

			<div class="btns" style="padding: 10px 0 10px;">
				<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
				<a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a>
			</div>
		</div>
	</div>
</div>

<!-- 连接参数 -->
<div class="dialog-cont" id="ConnParamDialog" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:320px;max-height:320px">
			<div class="c-form"  style="padding: 0px;">
				<div class="form" style="">	
					<div class="form-item">
						<span class="form-tag">名称：</span>
						<div class="form-c" style="">
							<input type="text" class="form-text" id="d_n" name="d_n" onblur="if($(this).val()==''){$(this).next().hide();return false;}regCheck(this,nameReg);" maxlength="128">
							<i class="v-check"></i>
							<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
						</div>
						<span class="form-tag" style=""><em class="imp">*</em>协议类型：</span>
						<div class="form-c" style="">
							<select class="form-select" name="Protocol" id="Protocol" style="width:150px;">
								
							</select>
						</div>
						<span class="form-tag" id="Protocol_port"></span>
					</div>
					<!-- SSH -->
					<div id="SSH" style="display:none;">
						<div class="form-item">
							<span class="form-tag">版本号：</span>
							<div class="form-c">
								<select class="form-select" name="ServiceName_ssh" id="ServiceName_ssh" style="width:150px;">
									<option value="1" selected>1</option>
									<option value="2" >2</option>
								</select>
							</div>
						</div>
					</div>
					 <!-- SFTP -->
					<div id="SFTP" style="display:none;">
						<div class="form-item">
							<span class="form-tag">版本号：</span>
							<div class="form-c">
								<select class="form-select" name="ServiceName_sftp" id="ServiceName_sftp" style="width:150px;">
									<option value="1" selected>1</option>
									<option value="2" >2</option>
								</select>
							</div>
						</div>
					</div>
					<!--HTTP-->
					<div id="HTTP" style="display:none;" >
						<div class="form-item">
							<span class="form-tag"><em class="imp">*</em>URL：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="url" name="url" maxlength="128" style="width:252px;padding-right:8px;">
							</div>
							<span class="form-tag">账号元素：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="UserName" name="UserName" maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
						</div>
						<div class="form-item">
							<span class="form-tag">密码元素：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="UserPwd" name="UserPwd"  maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
							<span class="form-tag">提交元素：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="Submit" name="Submit" maxlength="128" style="width:252px;padding-right:8px;">
							</div>
						</div>
					</div>
					<!--HTTPS-->
					<div id="HTTPs" style="display:none;">
						<div class="form-item">
							<span class="form-tag"><em class="imp">*</em>URL：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="httpsurl" name="httpsurl" maxlength="128" style="width:252px;padding-right:8px;">
							</div>
							<span class="form-tag">账号：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="httpsUserName" name="httpsUserName" maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
						</div>
						<div class="form-item">
							<span class="form-tag">密码：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="httpsUserPwd" name="httpsUserPwd" maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
							<span class="form-tag">提交元素：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="httpsSubmit" name="httpsSubmit" maxlength="128" style="width:252px;padding-right:8px;">
							</div>
						</div>
					</div>
					<!--RDP-->
					<div id="RDP" style="display:none;">
						<div class="form-item">
							<span class="form-tag">访问方式：</span>
							<div class="form-c">
								<select class="form-select" name="rdpType" id="rdpType" style="width:150px;">
									<option value="NORMAL" text="NORMAL">NORMAL</option>
									<option value="CONSOLE" text="CONSOLE">CONSOLE</option>
								</select>
							</div>
						</div>
					</div>
					<!--ORACLE-->
					<div id="ORACLE" style="display:none;">
						<div class="form-item">							
							<span class="form-tag"><em class="imp">*</em>实例名或服务名：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="s_n" name="s_n"  maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
							<span class="form-tag" ><em class="imp">*</em>指定：</span>
							<div class="form-c">
								<select class="form-select" name="appoint" id="appoint" style="width:150px;">
									<option value="0" text="请选择" selected>请选择</option>
									<option value="1" text="SID">SID</option>
									<option value="2" text="SERVICE_NAME">SERVICE_NAME</option>
								</select>
							</div>
						</div>
						<div class="form-item">
							<span class="form-tag">连接方式：</span>
							<div class="form-c">
								<select class="form-select" name="conn" id="conn" style="width:150px;">
									<option value="0" text="未指定" selected>未指定</option>
									<option value="1" text="NORMAL">NORMAL</option>
									<option value="2" text="SYSDBA">SYSDBA</option>
									<option value="3" text="SYSOPER">SYSOPER</option>
								</select>
							</div>
						</div>
					</div>
					<!--RADMIN-->
					<div id="RADMIN" style="display:none;">
						<div class="form-item">
							<span class="form-tag">认证方式：</span>
							<div class="form-c">
								<select class="form-select" name="authtype" id="authtype" style="width:150px;">
									<option value="0" text="未指定" selected>未指定</option>
									<option value="1" text="RADMIN">RADMIN</option>
									<option value="2" text="Windows">Windows</option>
								</select>
							</div>
						</div>
					</div>
					<!--MSSQL-->
					<div id="MSSQL" style="display:none;">
						<div class="form-item">
							<span class="form-tag"><em class="imp">*</em>实例名：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="o_n" name="o_n" maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
							<span class="form-tag">认证方式：</span>
							<div class="form-c">
								<select class="form-select" name="R_authtype" id="R_authtype" style="width:150px;">
									<option value="0" text="未指定" selected>未指定</option>
									<option value="1" text="SQL服务器验证" >SQL服务器验证</option>
									<option value="2" text="Windows验证" >Windows验证</option>
									<option value="3" text="Windows单一登录" >Windows单一登录</option>
								</select>
							</div>
						</div>
					</div>
					<!--MYSQL &&　DB2-->
					<div id="MY_DB2" style="display:none;">
						<div class="form-item" style="min-height:40px;">
							<span class="form-tag"><em class="imp">*</em>数据库名：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="sql_n" name="sql_n" maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
						</div>
					</div>
					<div id="MY_ConnType" style="display:none;">
						<div class="form-item" style="min-height:40px;">
							<span class="form-tag"><em class="imp">*</em>版本号：</span>
							<div class="form-c">
								<select class="form-select" name="select_my" id="select_my" style="width:150px;">
									<option value="0" text="0" selected>&lt;7.5</option>
									<option value="1" text="1" >≥7.5</option>
								</select>
							</div>
						</div>
					</div>					
					<!--SYBASE-->
					<div id="SYBASE" style="display:none;">
						<div class="form-item"  style="min-height:40px;">
							<span class="form-tag"><em class="imp">*</em>实例名：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="sy_o_n" name="sy_o_n" maxlength="128" style="width:252px;padding-right:8px;">
								<p class="form-tip">不能含有特殊字符</p>
							</div>
						</div>
					</div>
					<!---->
				</div>
			</div>

			<div class="btns" style="padding: 10px 0 10px;">
				<a href="javascript:;" class="btn btn-normal btn-submit">保&nbsp;&nbsp;存</a>
				<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
			</div>
		</div>
	</div>
</div>

<div class="dialog-cont" id="ConnIPDialog" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
			<div class="c-form c-form-host" style="padding: 0 0 90px;">
				<div class="clearfix"></div>
				<div class="c-table">
					<div class="form">
						<div class="form-item" style="width: 25%;">
							<span class="form-tag" style=""><em class="imp">*</em>IP：</span>
							<div class="form-c" style="">
								<input type="text" class="form-text" id="accip_input" maxlength="15" tabindex="1">
							</div>
						</div>
					</div>
					<div class="btns" style="padding: 10px 0 10px;">
						<a href="javascript:;" class="btn btn-normal btn-submit" >保&nbsp;&nbsp;存</a>
						<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="dialog-cont" id="protoDialog" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
			<div class="c-form c-form-host" style="padding: 0 0 90px;">
				<div class="clearfix"></div>
				<div class="c-table">
					<div class="form">
						<div class="form-item" style="width: 300px;">
							<span class="form-tag" style="width: 72px;"><em class="imp">*</em>名称：</span>
							<div class="form-c" style="padding-left: 0;">
								<input type="text" class="form-text" id="Protocol_Name0" maxlength="15" style="width: 195px;" tabindex="1">
								<i class="v-check" style=""></i>
								<p class="form-tip" style="width: 185px;margin-left: 66px;">特殊字符仅支持下划线、横杠</p>
							</div>
						</div>
						<div class="form-item" style="width: 185px;">
							<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口：</span>
							<div class="form-c" style="padding-left: 0px;">
								<input type="text" class="form-text" id="Port0" maxlength="5" style="width: 50px;" tabindex="1">
								<i class="v-check" style=""></i>
								<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
							</div>
						</div>
						<div class="form-item" style="width: 185px;">
							<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口1：</span>
							<div class="form-c" style="padding-left: 0px;">
								<input type="text" class="form-text" id="Port1" maxlength="5" style="width: 50px;" tabindex="1">
								<i class="v-check" style=""></i>
								<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
							</div>
						</div>
						<div class="form-item" style="width: 250px;">
							<span class="form-tag" style="width:85px;">描述：</span>
							<div class="form-c" style="padding-left: 0px;">
								<input type="text" class="form-text" id="Description0" maxlength="128" style="width:170px;" tabindex="1">
							</div>
						</div>
					</div>
					<div class="btns" style="padding: 10px 0 10px;">
						<a href="javascript:;" class="btn btn-normal btn-submit" >保&nbsp;&nbsp;存</a>
						<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 添加账号内账号编辑浮层 -->
<div class="dialog-cont" id="AccEditDialog" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:320px;max-height:320px">
			<div class="c-form"  style="padding: 0px; max-height: 240px; overflow: auto;">
				<div id="first_div"></div>
					<div id="luo0" style="float:left;width:97%;position: static;">
						<div class="form-item" style="width:50%;float:left;">
							<span class="form-tag" style="width:60px"><em class="imp">*</em>账号：</span>
							<div class="form-c sel-type1" id = "account_name" style="margin-bottom: 15px;width: 270px;float: left;padding: 1px 10px 10px 10px;">
									<input type="text" class="form-text" id="Name0" onblur="NameCheck1(this)" maxlength="127"><i class="v-check" id="check0"></i>
								<p class="form-tip" id="prompt0" style="padding-left: 0px;">特殊字符仅支持@(仅可用1次)、下划线、横杠、小数点</p>
							</div>
						</div>
						<div class="form-item" style="width:50%;float:left;margin-top: 1px;">
							<span class="form-tag" style="width:70px">AD域：</span>
									
							<div class="form-c sel-type1" style="float:left;width: 280px;padding-left:15px;">
								<li id="add_AD0">
									<select name="" id="ADregion0" onchange="AD_change(0,this);" class="type-select" style="width:250px">
									</select>
									<i class="ctrl add" id="edit_hide" onclick="addinput(this)"></i>
								</li>
							</div>
						</div>
					</div>
				</div>
				<div class="btns" style="padding: 10px 0 10px;">
					<a href="javascript:;" class="btn btn-normal btn-submit">保&nbsp;&nbsp;存</a>
					<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 添加（编辑）秘钥浮层 -->
<div class="dialog-cont" id="SSHKeyDialog" style="display:none;">
	<div class="container">
		<div class="c-cont" style="max-height: 450px; min-height: 450px;">
			<div class="c-form" style="width:auto; padding: 0px 0 0;">
				<div class="form">
					<div class="form-item">
						<span class="form-tag"><em class="imp">*</em>名称：</span>
						<div class="form-c">
							<input type="text" class="form-text" id="d_n1" name="d_n1" onblur="regCheck(this,nameReg);" maxlength="128">
							<i class="v-check"></i>
							<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
						</div>
					</div>
					<div class="form-item">
						<span class="form-tag">类型：</span>
						<div class="form-c">
							<select class="form-select form-select2" name="Protocol1" id="Protocol1" style="width:150px;">
								<option value="1" selected>私钥</option>
								<option value="0" >公钥</option>
							</select>
						</div>
					</div>
					
					<!-- <div class="form-item">
						<span class="form-tag">状态：</span>
						<div class="form-c" style="margin-top: 3px;">
								<input type="checkbox" class="form-checkbox" id="Enable"/>
								<span style="vertical-align:middle;font-size:16px; color: #000;">启用</span>
						</div>
					</div> -->
					<div class="form-item" style="width: 380px;">
						<span class="form-tag"><!--<em class="imp">*</em>-->设置密码：</span>
						<div class="form-c">
							<input type="password" class="form-text" id="Password" name="Password" onblur="" maxlength="128" style="width: 160px;padding-right: 8px;">
																<!-- <p class="form-tip">长度为16位</p> -->
						</div>
					</div>
					<div class="form-item" style="width: 280px;">
						<span class="form-tag" style="width: 92px;"><!--<em class="imp">*</em>-->确认密码：</span>
						<div class="form-c" style="padding-left: 100px;">
							<input type="password" class="form-text" id="Password_two" name="Password_two" onblur="" maxlength="128" style="width: 160px;padding-right: 8px;">
							<!-- <p class="form-tip">长度为16位</p> -->
						</div>
					</div>
					<div class="form-item">
						<span class="form-tag"><em class="imp">*</em>内容：</span>
						<div class="form-c">
							<textarea type="textarea" class="form-text" id="content" style="width: 430px; height: 150px; resize: none"></textarea>
						</div>
					</div>
					
				</div>
			</div>

		</div>
		<div class="btns" style="padding: 10px 0 10px;">
			<a href="javascript:;" class="btn btn-normal btn-submit s-hide">保&nbsp;&nbsp;存</a>
			<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
		</div>
	</div>
</div>
{% endblock %} {% block script %}
<style>
	#SSHKeyDialog .form-item{
		float:left;
	}
	a.btn-normal1{
		outline: none;
	}
	.btns a.btn-normal {
	  outline: none;
	}

	.srsCtl:hover a.del{
		display: inline-block;
	}
	.srsCtl1:hover a.del.ctrl{
		display: inline-block !important;
	}
	#accIP .xSelect-show {
		/*border-bottom-right-radius: 5px;
		border-top-right-radius: 5px;*/
		border-bottom-left-radius: 0px;
		border-top-left-radius: 0px;
		margin-left: -1px;
	}
	.form-c.srsCtl .xSelect-show {
		/*border-bottom-right-radius: 5px;
		border-top-right-radius: 5px;*/
		border-bottom-left-radius: 0px;
		border-top-left-radius: 0px;
		margin-left: -1px;
	}
	#AccountName .xSelect-show {
		/*border-bottom-right-radius: 5px;
		border-top-right-radius: 5px;
		border-bottom-left-radius: 5px;
		border-top-left-radius: 5px;*/
		margin-left: -1px;
	}
	#AccountName .xSelect-show.on.on-above {
		border-bottom-left-radius: 0;
		border-bottom-right-radius: 0;
	}	
	.accIP_type span.select2-selection {
		border-bottom-right-radius: 0px;
		border-top-right-radius: 0px;
	}

	.in_ip span.select2-selection {
		border-bottom-left-radius: 0px;
		border-top-left-radius: 0px;
	}
	/*
	#if_emptypwd_label .icheckbox_minimal-blue {
                margin-top: -2px;
        }
	*/
	#ProtocolName .xSelect-show {
		/*border-bottom-left-radius: 5px;
		border-top-left-radius: 5px;*/
		margin-left: 0px;
	}

	#ConnParamName .xSelect-show {
		/*border-bottom-left-radius: 5px;
	    border-top-left-radius: 5px;*/
	    margin-left: 0px;
	}
	.ui-dialog-body{
		padding: 20px 0 0 0;
	}
	#ConnParamDialog span.form-tag {
		width:115px;
	}
	#ConnParamDialog div.form-c {
		float: left;padding-left: 0px;
	}
	#ConnParamDialog div.form-item {
		min-height: 33px;
	}

	#ADDialog span.form-tag {
		width:115px;
	}
	#ADDialog div.form-c {
		padding-left: 0px;
	}

	.as {
		width: 190px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		float: left;
		margin-top: 4px;
	}

	.h-content2 .form-item {
		height: auto;
		padding: 20px 0 10px;
		min-height: 46px;
		padding: 5px;
		width: 380px;
		float: left;
	}

	.h-content2 .form-tag {
		float: left;
		width: 80px;
		text-align: right;
		color: #000;
		line-height: 28px;
	}

	.h-content2 .form-c {
		padding-left: 0px;
		position: relative;
	}

	.h-content2 .form-text {
		width: 200px;
	}

	.h-content2 .rzj {
		float: right;
		margin-right: 20px;
		color: #000;
		margin-top: -12px;
	}

	.h-content2 .form-tip {
		padding-left: 48px;
	}

	a.btn-normal1 {
		display: inline-block;
		width: 90px;
		height: 32px;
		border: 1px solid #DDD;
		text-align: center;
		line-height: 32px;
		border-radius: 18px;
		margin: 0 10px;
		background-color: #fff;
		transition: background-color 0.4s;
		color: #7c7c7c;
	}

	a.btn-normal1:hover {
		background-color: #8d808a;
		color: #fff;
	}

	.ui-dialog-content .c-form-host {
		min-width: 780px;
	}

	.c-table {
		padding: 20px 10px;
	}

	.c-form-host.col3 .form-item {
		width: 33.3%;
	}

	.c-form-host.col3 .form-item-100 {
		width: 100%;
	}

	.c-form-host.col3 .form-item .form-text {
		width: 100px;
	}

	.c-form-host.col3 .form-item .h-content3 {
		padding: 0;
	}

	.select2-container--open {
		z-index: 9999999;
	}
	#autoView{z-index: 99999990;}
	#autoViewa{z-index: 99999990;}
	.blank_in {
		width: 12px;
	}
	.c-form-host .form-item .form-c {
		padding-left: 0em;
	}
</style>

<script>
	var SUP_PROTOCOL = ['SSH','ORACLE','MSSQL','MYSQL','TELNET','FTP','VNC','SYBASE','DB2','RLOGIN','RDP','INFORMIX'];		//连接测试支持协议；
	var TEST_TIME = 1000;				//取连接测试结果间隔时间；
	var TEST_TIMEOUT = 300000;		//连接测试超时时间；
	var acc_namereg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.@]+$/;
	$('.filter-select,.form-select').select2({minimumResultsForSearch: -1});
	var host = {
		"HostId": 0,
		"HostName": "",
		"HostIP": "",
		"Description": null,
		"AccessRate": 0,
		"EnableLoginLimit": false,
		"Status": 0,
		"DeviceTypeId": 0,
		"HGroupSet": [
		],
		"ServiceSet": [
		],
		"AccountSet": [
		]
	}
	function nameCheck(obj) {
		var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		var val = $(obj).val();
		var $i = $(obj).next('i.v-check')

		if (nameReg.test(val)) {
			$i.show().attr('class', 'v-check v-right');
		} else {
			$i.show().attr('class', 'v-check v-wrong');
		}
	}

	function ipCheck(obj) {
		var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
	
		var val = $(obj).val().trim();
		var $i = $(obj).next('i.v-check')

		if (hostIPReg.test(val)) {
			$i.show().attr('class', 'v-check v-right');
		} else {
			$i.show().attr('class', 'v-check v-wrong');
		}
	}
	var search_typeall_r = ''; //所有的条件
	var search_all_tmp = '';//添加的条件
	//加入搜索
	function _addFilter(obj) {
		var id = $(obj).parent().children('select').children('option:selected').val();
		if (id == "0") {
			$('#filterWW1>ul').empty();
			search_typeall_r = "";
			$("#filterWW1").attr("style", "display:none;");
			selView_s();
			return false;
		}
		var v1 = $(obj).parent().children('select').children('option:selected').text();
		var v2 = $(obj).parent().children('input[type=text]').val().trim();
		if (v2 == '') {
			_alert(2, '搜索', '请输入关键字', $(obj).parent().children('input[type=text]'));
			return false;
		} else {
			if (id == 'ip') {
				var ip_reg = /^[0-9\.]*$/;
				if (!ip_reg.test(v2)) {
					_alert(1, "主机", 'IP格式不正确', $(obj).parent().children('input[type=text]'));
					return false;
				}
			}
			var search_typeall = search_typeall_r;
			search_typeall = search_typeall + id + '-' + v2 + '\t';
			search_typeall_r = search_typeall;
			$('#filterWW1>ul').append('<li style="height: 18px;"><span style = "display:none;">' + id + '</span><span class="ww">' + v1 + '-' + v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter(this);"></i></li>')
			$("#server_text").val("");
			$('#server_text_check').hide();
			selView_s();
		}
	}
	function change_input(obj){
		if ($(obj).val() == ""){
			search_typeall_r = search_all_tmp
			find_hostgroup();
		}
	}
	function _addFilterFuzzy_s(obj,type){
		var id = $(obj).parent().children('select').children('option:selected').val();
		var v1 = $(obj).parent().children('select').children('option:selected').text();
		var v2 = $(obj).parent().children('input[type=text]').val().trim();
		if (id == "0") {
			// $('#filterWW1>ul').empty();
			// search_typeall_r = "";
			// $("#filterWW1").attr("style", "display:none;");
			// selView_s();
			// return false;
			v1='';
		}else{
			v1=v1+'-';
		}
		if (v2 == '') {
			_alert(2, "搜索", '请输入关键字');
			return false;
		} else {
			if (id == 'ip') {
				var ip_reg = /^[0-9\.]*$/;
				if (!ip_reg.test(v2)) {
					_alert(1, "搜索", 'IP格式不正确');
					return false;
				}
			}
			if (search_all_tmp.indexOf(id+'-'+v2+'\t')>=0){
				_alert(1, "搜索", '关键字重复');
				return false;
			}
			if(type == false){ //直接搜索 不累加条件
				search_typeall_r = search_all_tmp + id + '-' + v2 + '\t';
			}else{
				search_all_tmp = search_all_tmp + id + '-' + v2 + '\t';
				search_typeall_r = search_all_tmp;
				$('#filterWW1>ul').append('<li style="height: 18px;"><span style = "display:none;">' + id+'-'+v2 + '</span><span class="ww">' + v1 + v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter_s(this);"></i></li>');
				$("#server_text").val("");
				$('#server_text_check').hide();
			}			
			selView_s();
		}
	}
	//清除
	function _clearFilter_s(obj,num){
		if(num==1){
			search_typeall_r = search_all_tmp;
			$("#server_text").val("");
			$('#server_text_check').hide();
			selView_s();	
			return;	
		}
		//$(obj).next().children('ul').empty();
		$('#clearFilter_s').next().children('ul').empty();
		search_typeall_r = "";
		search_all_tmp='';
		$("#server_text").val("");
		$('#server_text_check').hide();
		selView_s()		
	}
	//删除搜索
	function _delFilter_s(obj) {
		var id = $(obj).parent().find("span");
		var ids = $(id).eq(0).text();
		var v2_text = $(id).eq(1).text();
		var v2_str = v2_text.split("-");
		var search_typeall = search_typeall_r;
		v2_str[0] = "";
		var str_v2 = v2_str.join('-');
		var str = ids + '-' + str_v2.substr(1, str_v2.length);
		var search_str = "";
		var search_typeall_str = search_typeall.split("\t");
		var i2 = 0;
		$.each(search_typeall_str, function (i, item) {
			if (i2 == 0 && item == ids) {
				i2 = 1;
			} else if (item != "") {
				search_str = search_str + item + '\t';
			}
		})
		search_typeall_r = search_str;
		$(obj).parent().remove();
		selView_s();
	}
	//显示搜索条件
	function selView_s() {
		var $sel = $('#filterWW1');
		var len = $('li', $sel).length;

		if (len == 0) {
			$sel.hide();
			$('#clearFilter_s').hide();
		} else if (len == 1) {
			$("#filterWW1").show();
			$('>span.ww', $sel).show();
			$sel.addClass('selector-multiple');
			$('#clearFilter_s').show();
		} else {
			$("#filterWW1").show();
			$('>span.ww', $sel).show();
			$sel.addClass('selector-multiple');
			$('#clearFilter_s').show();
		}
		find_hostgroup();
	}

	//返回第一个标红处
	function scrollTop_check() {
		if (data_array_Path.length != 0) {
			var top = 9999;
			$.each(data_array_Path, function (i, item) {
				if (item.Type == 1) {
					var top_item = $('#node-' + item.Id).offset().top;
					if (top_item < top) {
						top = top_item;
					}
				} else {
					var Path_array = item.Path.split('/');
					var len = Path_array.length;
					$i_item = $('#node-' + Path_array[len - 2].split(',')[1]).siblings('i.h-aicon');
					var top_item = $i_item.siblings('ul').find('li').find('input[id=HostId-' + item.Id + ']').eq(0).offset().top;
					if (top_item < top) {
						top = top_item;
					}
				}
			});
			$('.c-cont').scrollTop(top - 100);
		}
	}
	
	var usercode = "";
	$(function () {
		check_hostLimit();
		$("#select_accIP select").click(function () {
			oldvaluechek(this);
		})
		$("#Port").bind('keydown', function (e) {
			DigitInput(e);
		});
		//获取初始信息
		usercode = window.parent.document.frm.us.value;
		//初始化搜索
		// $('#server_text').hide();
		// $('#server_select').on('change', function () {
		// 	var server_select = $('#server_select').val();
		// 	if (server_select == 0) {
		// 		if (!$('#server_text').is(':hidden')) {
		// 			$('#server_text').hide();
		// 		}
		// 	} else {
		// 		if ($('#server_text').is(':hidden')) {
		// 			$('#server_text').show();
		// 		}
		// 	}
		// });
		//获取协议
		// $.ajax({
		// 	url: '/bhost/get_protocol_list',
		// 	type: "post",
		// 	async: false,
		// 	cache: false,
		// 	data: { a0: $("input[name=se]").val(), a1: 1, a2: null, a3: null, a4: ',,', a5: null },
		// 	success: function (Result) {
		// 		proto_list = JSON.parse(Result);
		// 		$("#ProtocolName").empty();
		// 		$("#ProtocolName").append("<option value=\"\" data=\"\">请选择</option>");
		// 		$.each(proto_list.data, function (i, item) {
		// 			$("#ProtocolName").append("<option value=\"" + item.ProtocolId + "\" data=\"" + item.Port + "\">" + item.ProtocolName + "</option>");
		// 		})
		// 	}
		// })
		// $("#ProtocolName").unbind().bind("change",function(){
		// 	$("#Port").val($("#ProtocolName option:selected").attr("data"));
		// 	if($("#ProtocolName").val() == ""){
		// 		$("#connparam").hide();
		// 	}else{
		// 		$("#connparam").show();
		// 			//获取 连接参数
		// 			bind_Conn_xSelect(this);
		// 			$("#ConnParamName").data('value','');
		// 			//$("#")
		// 	}
		// })
	
		//$("#ProtocolName").change();
		
		//获取 全局策略
		$.ajax({
			url: '/bhost/get_globalstrategy',
			type: "post",
			async: false,
			cache: false,
			data: { a0: $("input[name=se]").val() },
			success: function (Result) {
				GlobalStartegy = JSON.parse(Result);
			}
		})		
		//获取 AD域
		$.ajax({
			url: '/bhost/get_DomainName_list',
			type: "post",
			async: false,
			cache: false,
			data: { a0: $("input[name=se]").val() },
			success: function (Result) {
				DomainName_list = (JSON.parse(Result)).data;
				//$("#DomainName").val('');
				/*
				$("#DomainName").empty();
				$("#DomainName").append("<option value=\"\">请选择</option>");
				$.each(DomainName_list,function(i,item){		
					$("#DomainName").append("<option value=\""+item.DomainId+"\">"+item.DomainName+"</option>");
				})	*/
			}
		})

		//获取 来源主机 、来源服务、来源账号
		$.ajax({
			url: '/bhost/get_fromhost',
			type: "post",
			async: true,
			cache: false,
			data: { a0: $("input[name=se]").val(),a1: usercode },
			success: function (Result) {
				fromhost_list = JSON.parse(Result);
				$("#FromHostName").empty();
				$("#FromHostName").append("<option value=\"\">请选择</option>");
				$.each(fromhost_list, function (i, item) {
					$("#FromHostName").append("<option value=\"" + item.HostId + "\" title=\"" + item.HostName + "("+item.HostIP+") \">" + item.HostName + "(" + (item.HostIP) + ")</option>");
				})
			}
		})
		$("#AccIpType").unbind().bind("change",function(){
			if($("#AccIpType").val() == 1){
				$("#acc_ip").hide();
			}else if($("#AccIpType").val() == 2){
				$("#acc_ip").show();
			}
		})		
		$("#FromHostName").unbind().bind("change", function () {
			var FromHostServiceName_list = []
			var FromAccountName_list = [];
			var host_id = $(this).val();
			$.ajax({
				url: '/bhost/get_FromHostServiceName',
				type: "post",
				async: false,
				cache: false,
				data: { a0: $("input[name=se]").val(), a1: host_id ,a2: usercode},
				success: function(Result) {
					result = JSON.parse(Result)
					FromHostServiceName_list = result.ServiceSet;
					FromAccountName_list = result.AccountSet;
					$("#FromHostServiceName").empty();
					$("#FromHostServiceName").append("<option value=\"\">请选择</option>");
					var pro_id = $("#ProtocolName").data('value');
					$.each(FromHostServiceName_list,function(i,item){
						if(item.ProtocolId == pro_id){
							$("#FromHostServiceName").append("<option value=\""+item.HostServiceId+"\">"+item.HostServiceName+"</option>");
						}
					})	
					//$("#FromHostServiceName").select2();
				}
			})

			$("#FromHostServiceName").change(function(){
				var FromHostService_name = $("#select2-FromHostServiceName-container").text();
				$("#FromAccountName").empty();
				$("#FromAccountName").append("<option value=\"\">请选择</option>");
				$.each(FromAccountName_list,function(i,item){
					AccountName = item.HostAccount.AccountName;
					if(AccountName == "*"){
						AccountName = "*";
					}else if(AccountName == "-"){
						AccountName = "-";
					}					
					AccountId = item.HostAccount.AccountId;
					HostServiceSet = item.HostServiceSet;
					$.each(HostServiceSet,function(i1,item1){
						if(FromHostService_name == item1.HostServiceName){
							$("#FromAccountName").append("<option value=\""+AccountId+"\">"+AccountName+"</option>");
						}
					
					})
				})
				$("#FromAccountName").select2();
			})
			$("#FromHostServiceName").change();
		})
		//$("#FromHostName").change();
		//bind_IP_xSelect();
		bind_accip_select();
		bind_in_ip();
		bind_Acc_xSelect(this);
		bind_SSHkey_xSelect();
		$('.form-checkbox,.form-radio').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});

		$("#if_emptypwd").on('ifChanged', function (event) {
			var t = $(this).prop("checked");
			var a = $("#AccountName").children().find('span').text();
			if (a == "*") {
				$("#password1").prop("disabled", true);
				$("#password2").prop("disabled", true);
				$("#password1").val("");
				$("#password2").val("");
				$("#if_emptypwd").iCheck('uncheck');
				$("#if_emptypwd").iCheck('disable');
			} else {
				if (t == true) {
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled", true);
					$("#password2").prop("disabled", true);
				} else {
					$("#password1").prop("disabled", false);
					$("#password2").prop("disabled", false);
				}
			}
		})
		$('.form-select').select2();
		get_DeviceType();
		//_get_an();
		$("a.btn-submit").unbind().bind("click", function () {
			savedata();
		});
		$("a.btn-cancel").unbind().bind("click", function () {
			document.frm.tasktype.value = 3;
			document.frm.se.value = window.parent.document.frm.se.value;
			document.frm.us.value = usercode;
			document.frm.action = '/bhost/index';
			document.frm.i10.value = 1;
			document.frm.submit();
		});
		$("#host_type").change(function () {
			host_type = $("#host_type option:selected").attr('_icon');
			_SwitchCmd = $("#host_type option:selected").attr('_SwitchCmd');
			_SwitchPasswdPrompt = $("#host_type option:selected").attr('_SwitchPasswdPrompt');
			DeviceTypeId = $(this).val();
			$("#host_icon i").each(function () {
				if (host_type == $(this).attr("data")) $(this).show();
				else $(this).hide();
			})
			//服务模板
			$(device_list).each(function (i, item) {
				if (item.DeviceTypeId == DeviceTypeId) {
					def_server_list = item.ServiceSet;
					return false;
				}
			})
			$('#service_list').empty();
			$('#service_account_list').empty();
			host.ServiceSet = [];
			host.AccountSet = [];

		})
		$("#host_type").change();
		/*$('#timeSet').on('ifChecked', function(event){
		  $('#timeSetSpan').show();
		}).on('ifUnchecked', function(event){
		  $('#timeSetSpan').hide();
		});*/
	})
	//绑定客户端集合
	var ConnParamData;
	var conn_index_all;
	function binding_Conn(obj) {
		if($(obj).data('value') == "" || $(obj).data('value') == '-1'){
			ConnParamData = []
		}else{
			$.ajax({
				url: '/bhost/get_ConnParam_list',
				type: "post",
				async: false,
				cache: false,
				data: { a0: $("input[name=se]").val(), a1: $(obj).data('value') },
				success: function (Result) {
					ConnParamData = (JSON.parse(Result)).data;
				}
			});
		}
	}
	function bind_Conn_xSelect(obj){
		binding_Conn(obj);
		var conn_array = [{
				'value':-1,
				'name':'请选择'
			}];
		// conn_index_all = [];
		var btn_tmp = [];
		var protocol_set = ['RDP','SSH','SFTP','ORACLE','MSSQL','MYSQL','HTTP(S)','TELNET','VNC','FTP','X11','RADMIN','SYBASE','DB2','RLOGIN','PCANY','TN5250'];
		if($.inArray($(obj).find('span').text(), protocol_set) != -1){
			btn_tmp = [
				{
					'name':'新增',
					'event': function(items,obj){
						$('.'+$('.xSelect_connList .xSelect-show').data('id')).hide();
						_addNew(obj,0);
					}
				}
			];
		}
		conn_index_all = [-1];
		$.each(ConnParamData,function(i,item){
			conn_index_all.push(item.ConnParamId);
			if($.inArray(item.ConnParamId,conn_arr)>=0){
				return true;
			}
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'edit'
			};
			select_data_json.value = item.ConnParamId;
			select_data_json.name = item.ConnParamName;
			conn_array.push(select_data_json);
			conn_index_all.push(item.ConnParamId);
		});
		$("#ConnParamName").empty().data('xSelect','');
		$("div[data-id=xSelect-connparam]").remove();
		$('#ConnParamName').xSelect({
			width: 132,
			defaultText: '请选择',
			items:conn_array,
			module_type:'connparam',
			edit: function(item,obj){
				$('.'+$('.xSelect_connList .xSelect-show').data('id')).hide();
				_addNew(obj,1);
			},
			btn:btn_tmp,
			setval:function(item,obj){
			}
		});
		$("#ConnParamName").data('value','-1');
	}
				//<input id="ConnParamName" type="text" style="width: 100px" class="form-text"  _id="" placeholder="输入连接参数" onkeyup="_autoView(this,0,0)" onfocus="_autoView(this,0,0)" onblur="_hideView(0,this);">
				//		get_accIP();
	//协议
	var proto_list;
	function get_protocol_list(){
		$.ajax({
			url:'/bhost/get_protocol_list',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:1,a2:null,a3:null,a4:',,',a5:null},
			success: function(Result) {
				proto_list = JSON.parse(Result);		
			}
		});
	}	
	function clear_protocol(){
		$("#protoDialog").find('input').val('');
		$("#Protocol_Name0").attr('disabled',false);	
	}
	var protocol_id;
	function _editNode1(obj,type){
		clear_protocol();
		var title;
		if (type == 1) {//
			protocol_id = $(obj).children('span').data('value');
			title = "协议";
		} else if (type == 2) {
			protocol_id = 0;
			title = "协议";
		}
		var $dialogCont = $("#protoDialog").show();
		var d = dialog({
			title: title,
			content: $dialogCont,
			id: "protoDialog",
			width: "1000px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		protocol_main(type);
		$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
			clear_protocol();
			protocol_main(type);
		});
		$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
			save_pro(d);
		})
	}
	function protocol_main(type){
		$("#Port1").parent().parent().hide();
		$("#Port0").on("input propertychange",function(){
			this.value = this.value.replace(/\D/g, "");
		}).on("paste",function(){return false});
		$("#Port1").on("input propertychange",function(){
			this.value = this.value.replace(/\D/g, "");
		}).on("paste",function(){return false});
		if(type == 1){
			$.ajax({
				url:'/bhost/select_protocol',
				type:"post",
				async:false,
				data:{a0:$("input[name=se]").val(),x1:protocol_id},
				success:function(result){
					protdata = JSON.parse(result);
					$.each(protdata.data,function(i,item){
						if(item.ProtocolName=="PCANY")
						{
							$("#Port1").parent().parent().show();
							$("#Port1").val(item.Port1);
						}
						$("#Protocol_Name0").val(item.ProtocolName);
						$("#Port0").val(item.Port);
						$("#Description0").val(item.Description);
						$("#Protocol_Name0").attr("disabled",true);
					});
				}
			});
		}
	}
	function nameCheck(name){
		var flag=true;
		$.ajax({
			url:'/bhost/select_name',
			type: "post",
			async:false,
			data: {a0:$("input[name=se]").val(),x1:name},
			success:function(result){
				data = parseInt(result);
				if (data !=0){
					flag=false;
				}
			}
		});
		return flag;
	}
	function save_pro(d){
		var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-]+$/;
		var ProtocolName = $("#Protocol_Name0").val();
		var des = $("#Description0").val();
		var Port = $("#Port0").val();
		if ($("#Port1").is(":visible")){
			var Port1 = $("#Port1").val();
		}else{
			var Port1 = "0";
		}
		
		if(ProtocolName == ""){
			_alert(2,"协议","请输入名称",$("#Protocol_Name0"));	
			return false;
		}
		var len = 0;
		if (des != ""){
			for (var i = 0; i < des.length; i++) {
			   if (des.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null){ //全角 
					len += 2; 
				}else{
					len += 1; 
				}
			}
			if(len >= 255){
				_alert(1,"协议","描述内容过长",$("#Description0"));
				return false;                   
			}
		}
		if(Port == ""){
			_alert(1,"协议","请输入端口",$("#Port0"));
			return false;
		}
		if (Port1 == 0){
		}
		
		if(Port1 == ""){
			_alert(1,"协议","请输入端口",$("#Port1"));
			return false;
		}
		//检查输入框格式
		if(!nameReg.test(ProtocolName) && ProtocolName != 'HTTP(S)'){
			_alert(1,"协议","名称格式不正确",$("#Protocol_Name0"));
			return false;
	    }
		if (protocol_id == 0){
			if(nameCheck(ProtocolName)==false){
				_alert(1,"协议","相同名称已存在",$("#Protocol_Name0"));
				return false;
			}
		}
		var datalist = [];
		var dataP='{"ProtocolId":'+protocol_id+',"ProtocolName":"'+ProtocolName+'","Port":'+Port+',"Port1":'+Port1+',"Description":"'+des+'"}';
		datalist.push(dataP);
		msstr = aceg(JSON.stringify(datalist),$("input[name=se]").val());
		$.ajax({
			url:'/bhost/set_protocol',
			type: "post",
			async:false,
			data: {a0:$("input[name=se]").val(),x1:JSON.stringify(datalist),a10:"运维管理>主机管理",m1:msstr},
			success:function(result){
				data = JSON.parse(result);
				if (data.Result){
					$('.btn').blur();
					_alert(0,"协议","保存成功");
					var pro_text = $('#ProtocolName').find('span').text();
					var pro_value = $("#ProtocolName").data('value');				
					$("div[data-id=xSelect-protocol]").remove();
					$('#ProtocolName').empty().data('xSelect','');
					bind_protocol_select();
					if (pro_value == "-1" || pro_value == undefined){
						$("#ProtocolName").data('value',data.ProtocolId);
						$("#ProtocolName").find('span').text(ProtocolName);
						$("#Port").val(Port);
					}else{
						$("#ProtocolName").data('value',pro_value);
						$('#ProtocolName').find('span').text(pro_text);
						if(protocol_id == pro_value){
							$("#Port").val(Port);
						}
					}
					d.close().remove();
				}else{
					_alert(1,"协议","执行失败：" + data.ErrMsg);
				}
			}
		});
	}
	function change_isacc(obj){
		//
		if($(obj).val() == 0){
			if($("#ProtocolName").find('span').text() == "RDP"){
				$("#div_inip").hide();
			}else{
				$("#div_inip").show();
			}
		}else{	
			$("#div_inip").show();
		}
	}
	var ProtocolName_old=-1;
	function bind_protocol_select(){
		get_protocol_list();
		var protocol_array = [{
				'value':-1,
				'name':'请选择'
			}];
		$.each(proto_list.data,function(i,item){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'edit'
			};
			select_data_json.value = item.ProtocolId;
			select_data_json.name = item.ProtocolName;
			protocol_array.push(select_data_json);
		});
		$('#ProtocolName').empty().data('xSelect',"");
		$('div[data-id=xSelect-protocol]').remove();
		$('#ProtocolName').xSelect({
			width: 132,
			defaultText: '请选择',
			items:protocol_array,
			module_type:'protocol',
			edit: function(item,obj){
				$(obj).parents('.xSelect-view').hide();
				_editNode1(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_editNode1(obj,2);
					}
				}
			],
			setval:function(item,obj){
				sel_id = $(obj).find('span').data('value');	
				// console.log(sel_id);	
				// console.log(ProtocolName_old);	
				if(sel_id!=ProtocolName_old){
					$('#conn_cont a.ctrl.del').click();
				}
				ProtocolName_old=sel_id;
				bind_Conn_xSelect($("#ProtocolName"));
				pName_change();
				$.each(proto_list.data,function(i,item){
					if (sel_id == item.ProtocolId){
						$("#Port").val(item.Port);
						if(item.ProtocolName == "SSH"){
							$('#same_sftp').show();
							$('#same_sftp_check').iCheck('check');

						}else{
							$('#same_sftp').hide();
						}
						if(item.ProtocolName == "RDP"){
							$('#_div_isacc').show();
						}else{
							$('#_div_isacc').hide();
							//$("#div_inip").hide();
						}
						
						if($("#IsAcc").val() == 0){
							if($("#ProtocolName").find('span').text() == "RDP"){
								$("#div_inip").hide();
							}else{
								$("#div_inip").show();
							}
						}else{	
							$("#div_inip").show();
						}
						
						return false;
					}
				});
				var ProtocolId_arr=[9,10,11,12,16,17,18];
				if($.inArray(sel_id,ProtocolId_arr)>=0){
					$('#div_conn').hide();
				}else{
					$('#div_conn').show();
				}
			}
		});
		$("#ProtocolName").data('value','-1');
	}	
	//绑定前置机IP
	var accIP_nomal="";
	var accIP_list;
	function get_accIP(){
		//获取accIP
		$.ajax({
			url:'/bhost/get_accIP',
			type: "post",
			async:false,
			cache:false,
			data: {a0: $("input[name=se]").val()},
			success: function(Result) {
				accIP_list = JSON.parse(Result);
			}
		})
	}

	var in_ip_list = [];
	function bind_in_ip(){
		var option_str = "";
		$.each(accIP_list.data,function(i,item){
			if (item.IsBuildin){
				in_ip_list.push(item);
				option_str = option_str + '<option value="'+item.AccIPId+'">'+item.AccIPId+'</option>';
			}
		});
		$("#in_ip").empty().append(option_str);
	}
	function bind_accip_select(){
		get_accIP();
		var accip_array = [{
				'value':-1,
				'name':'请选择'
			}];
		acc_index_all = [];
		$.each(accIP_list.data,function(i,item){
			acc_index_all.push(item.AccIPId);
			if (manager_arry.indexOf(item.AccIPId) > 0){
				return true;
			}
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'delete'
			};
			if (item.IsBuildin){
				return true;
			}
			select_data_json.value = item.AccIPId;
			select_data_json.name = item.AccIP;
			accip_array.push(select_data_json);	
		});
		$('#accIP').empty().data('xSelect',"");
		$('div[data-id=xSelect-accIP]').remove();
		$('#accIP').xSelect({
			width: 138,
			defaultText: '请选择',
			items:accip_array,
			module_type:'accIP',
			delete:function(item,obj){
				del_accip(obj);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_editaccIP(obj);
					}
				}
			]
		});
		$("#accIP").data('value','-1');
	}
	function _editaccIP(){
		$("#accip_input").val('');
		var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

		var $dialogCont = $("#ConnIPDialog").show();
		var title = '前置机IP';
		var d = dialog({
			title:title,
			content:$dialogCont,
			id:"ConnIPDialog",
			width:"780px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
			reload(7);
		});
		$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
			var acc_ip = $("#accip_input").val();
			if(acc_ip == ""){
				_alert(2, title, '请输入前置机IP');
				return false;
			}else{
				if (!hostIPReg.test(acc_ip)) {
					_alert(1, title, "前置机IP格式不正确");
					return false;
				};
			}
			var flag_1 = 0;
			$.each(accIP_list.data,function(i,item){
				if(item.AccIP == acc_ip){
					_alert(1, title, '相同的前置机IP已存在');
					flag_1 = 1;
					return false;
				}
			})
			if(flag_1 == 1){
				return false;
			}
			save_accip(acc_ip,d);
		});
	}

	//保存前置机IP
	function save_accip(ip,obj){
		var jsondata = {
			"AccIPId": 0,
			"AccIP": ""
		}
		jsondata.AccIP = ip;
		var msstr = aceg(JSON.stringify(jsondata),se);
		$.ajax({
			url:'/bhost/save_acc_ip',
			type:"POST",
			async:false,
			data:{a0: $("input[name=se]").val(),a1: JSON.stringify(jsondata),a10:"运维管理>主机",m1:msstr},
			//contentType: 'application/json',
			success: function(Result) {
				var data = JSON.parse(Result);
				if(data.Result){
					var result_id = data.AccIPId
					_alert(0,"前置机IP","保存成功");
					obj.close().remove();
					
					var accIP_text = $("#accIP").find('span').text();
					var accIP_Id = $("#accIP").find('span').data('value');
					bind_accip_select();
					if (accIP_Id == "-1" || accIP_Id == undefined){
						$("#accIP").data('value',result_id);
						$("#accIP").find('span').text(ip);
					}else{
						$("#accIP").find('span').text(accIP_text);
						$("#accIP").data('value',accIP_Id);
					}
					return false;
				}
				else{
					_alert(1,"前置机",data.ErrMsg);
					return false;
				}
			}
		})
	}
function del_accip(obj){
	var id = $(obj).find('span').data('value');
	var sel_id = $("#accIP").data('value');
	var accip_str = $(obj).find('span').text();
	$(document)[0].onclick = null;
	$.ajax({
		url:'/bhost/del_acc_ip',
		type:'post',
		async:false,
		data:{a0: $("input[name=se]").val(),a1:id,a10:"运维管理>主机管理"},
		success:function(result){
			var result = JSON.parse(result);
			if (result.Result == true){
				$(obj).remove();
				acc_index_all.splice($.inArray(id, acc_index_all), 1);
				$.each(accIP_list.data,function(i,item){
					if (id == item.AccIPId){
						accIP_list.data.splice(i,1);
						return false;
					}
				})
				if (id == sel_id){
					$("#accIP").data('value','-1');
					$("#accIP").find('span').text('请选择');
				}
				//删除目前主机中配置的被删除前置机
				$.each(host.ServiceSet,function(i,item){
					$.each(item.AccIPSet,function(i1,item1){
						if(item1.AccIP == accip_str){
							item.AccIPSet.splice(i1,1);
							return false;
						}
					})
				})
				$.each($("#service_list").find('tr'),function(i,item){
					accip_tmp_array = $(item).children('td').eq(3).text().split(',');
					$.each(accip_tmp_array,function(i1,item1){
						if(item1 == accip_str){
							accip_tmp_array.splice(i1,1);
						}
					})
					$(item).children('td').eq(3).text(accip_tmp_array.join(','));
				})
				//
				return;
			}else{
				_alert(1, "主机",result.ErrMsg);
				return;
			}
		}
	})
}
	//绑定账号
	var AccountData;
	var acc_index_all;
	function binding_Acc() {
		$.ajax({
			url: '/bhost/get_account',
			type: "post",
			async: false,
			cache: false,
			data: { a0: $("input[name=se]").val() },
			success: function (Result) {
				result = JSON.parse(Result)
				AccountData = result.data;
				$.each(AccountData, function (i, item) {
					if (item.AccountType == 0) {
						item.AccountName = "*";
					} else if (item.AccountType == 2) {
						item.AccountName = "-";
					}
				})
			}
		});
	}
	function bind_Acc_xSelect(){
		binding_Acc();
		var acc_array = [{
				'value':5,
				'name':'*'

			},{
				'value':6,
				'name':'-'

			}];
		acc_index_all = [{
				'value':5,
				'name':'*'

			},{
				'value':6,
				'name':'-'

			}];
		$.each(AccountData,function(i,item){
			if(item.AccountId != 5 && item.AccountId != 6){
				if(item.AccountId < 8){
					var select_data_json = {
						'value':1,
						'name':'admin2',
					};
					select_data_json.value = item.AccountId;
					select_data_json.name = item.AccountName;
					acc_array.push(select_data_json);
					acc_index_all.push(item.AccountId);					
				}else{
					var select_data_json = {
						'value':1,
						'name':'admin2',
						'type':'edit'
					};
					select_data_json.value = item.AccountId;
					select_data_json.name = item.AccountName;
					acc_array.push(select_data_json);
					acc_index_all.push(item.AccountId);
				}
			}
		});
		$("#AccountName").empty().data('xSelect','');
		$("div[data-id=xSelect-account]").remove();
		$('#AccountName').xSelect({
			width: 142,
			defaultText: '请选择',
			items:acc_array,
			module_type:'account',
			edit: function(item,obj){
				$('.'+$('.xSelect_AccList .xSelect-show').data('id')).hide();
				_addNew1(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_addNew1(obj,0);
					}
				}
			],
			setval:function(item,obj){
				var t = $("#AccountName").children().find('span').text();
				if( t == "#"){
					$("#authType").prop("disabled",true);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('disable');
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",true);
					$("#password2").prop("disabled",true);
				}else{
					$("#authType").prop("disabled",false);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('enable');					
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",false);
					$("#password2").prop("disabled",false);
				}
			}
		});
	}


	//绑定密钥
	var SSHkeyData;
	var SSHkey_index_all;
	function binding_SSHkey() {
		$.ajax({
			url: '/bhost/get_sshkey_host',
			type: "post",
			async: false,
			cache: false,
			data: { a0: $("input[name=se]").val() },
			success: function (Result) {
				result = JSON.parse(Result)
				SSHkeyData = result.info.data;
			}
		});
	}

	function bind_SSHkey_xSelect(){
		binding_SSHkey();
		var ssh_array = [{
						'value':-1,
						'name':'请选择'
					}];
		SSHkey_index_all = [];
		$.each(SSHkeyData,function(i,item){
			if(item.IfValid == true){
				var select_data_json = {
					'value':1,
					'name':'admin2'
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'type':'edit'
				};
			}
			select_data_json.value = item.SshKeyId;
			select_data_json.name = item.KeyName;
			ssh_array.push(select_data_json);
			SSHkey_index_all.push(item.SshKeyId);
		});
		$("#SSHkey_s").empty().data('xSelect','');

			$('#SSHkey_s').xSelect({
				width: 142,
				defaultText: '请选择',
				items:ssh_array,
				module_type:'SSHkey_s',
				edit: function(item,obj){
					$('.'+$('.xSelect_SSHkey .xSelect-show').data('id')).hide();
					_addNew3(obj,1);
				},
				btn:[
					{
						'name':'新增',
						'event': function(items,obj){
							_addNew3(obj,0);
						}
					}
				],
				setval:function(item,obj){
				}
			});
	}

	var old_pro_name='';
	var old_prot=0;
	//服务 浮层
	function _getDialog1(type, name) {
		old_prot=0;
		old_pro_name='';
		HostServiceName_id_arr=new Array();
		$('a.btn').blur();
		if(type == 'add'){
			serverID = 0;
			ServerIndex=-1;
		}else{
			serverID = name;
		}
		if ($('#host_type').val() == "") {
			_alert(2, "主机", '请先选择设备类型');
			return false;
		}
		bind_protocol_select();
		clear_server();

		$('#item_server').show();
		$('#def_server').unbind();
		$('#def_server').empty();
		$('#def_server').append('<option value="" >请选择</option>');
		$(def_server_list).each(function (i, item) {
			$('#def_server').append('<option value="' + item.DeviceServiceId + '" >' + item.DeviceServiceName + '</option>');
		})
		$('#def_server').select2('destroy').select2();
		$('#LineBreak').select2('destroy').select2({minimumResultsForSearch: -1});
		$('#def_server').change(function () {
			show_def_server($(this).val());
		})
		$('#def_server').change();

		if (type == 'edit') {
			_editServer(name);
		} else {
		}
		if(GlobalStartegy.AccIPSet != null){
			$("#accIP_cont").hide();
			$("#accIP_cont1").show();
		}else{
			$("#accIP_cont").show();
			$("#accIP_cont1").hide();
		}
		pName_change();
		var $dialogCont = $("#scDCTab1").show();
		if (type == 'edit') {
			title = '服务';
		} else {
			title = '服务';
		}
		var d = dialog({
			title: title,
			content: $dialogCont,
			id: "scDCTab1",
			width: "800px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		var old_n = $("#HostServiceName").val();
		$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
			d.close().remove();
		});
		$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
			if (_addServer(type,old_n) == false) return false;
			d.close().remove();
		})
	}

	function show_def_server(DeviceServiceId) {
		var def_server = [];
		$(def_server_list).each(function (i, item) {
			if (DeviceServiceId == item.DeviceServiceId) {
				def_server = item;
				return false;
			}
		})
		if (def_server.length == 0) {
			clear_server();
			return false;
		}
		$("#HostServiceName").val(def_server.DeviceServiceName);
		$("#ProtocolName").data('value',def_server.ProtocolId);
		$("#ProtocolName").find('span').text(def_server.ProtocolName);
		bind_Conn_xSelect($("#ProtocolName"));
		if(def_server.ConnParamId != null){
			$("#ConnParamName").data('value',def_server.ConnParamId);
			$("#ConnParamName").find('span').text(def_server.ConnParamName);		
		}
		$("#Port").val(def_server.Port);
		$("#FromHostName").val(def_server.FromHostId).trigger("change");
		$("#FromHostServiceName").val(def_server.FromHostServiceId).trigger("change");
		$("#FromAccountName").val(def_server.FromAccountId).trigger("change");

		$("#FromLoginCmd").val(def_server.FromLoginCmd);
		$("#NormalPrompt").val(def_server.NormalPrompt);
		$("#AcctSwitchCmd").val(_SwitchCmd);
		$("#SwitchPasswdPrompt").val(_SwitchPasswdPrompt);
		$("#LoginUserPrompt").val(def_server.LoginUserPrompt);
		$("#LoginPasswdPrompt").val(def_server.LoginPasswdPrompt);
		$("#LoginSuccPrompt").val(def_server.LoginSuccPrompt);
		$("#ExtraPrompt").val(def_server.ExtraPrompt);
		$("#ExtraReply").val(def_server.ExtraReply);
		$("#LineBreak").val(def_server.LineBreak == null ? "1" : def_server.LineBreak).trigger('change');
		if(def_server.ProtocolName == "RDP"){
			$("#_div_isacc").show();
		}else{
			$("#_div_isacc").hide();
			//$("#div_inip").hide();
		}
		
		
		if(def_server.IsAcc == null) def_server.IsAcc = 0;
		$("#IsAcc").val(def_server.IsAcc).trigger("change");
		//get_accIP();
		if($("#IsAcc").val() == 0){
			if($("#ProtocolName").find('span').text() == "RDP"){
				$("#div_inip").hide();
			}else{
				$("#div_inip").show();
			}
		}else{	
			$("#div_inip").show();
		}
		//绑定前置机ip
		accIP_select_tmp = [];
		//$(def_server.AccIPSet).each(function (i1, item1) {
		if (def_server.AccIPSet != null && def_server.AccIPSet != []){
			for (var i1 = def_server.AccIPSet.length; i1 > 0; i1--){
				var v = def_server.AccIPSet[i1-1].AccIPId;
				var t = def_server.AccIPSet[i1-1].AccIP;
				var type = def_server.AccIPSet[i1-1].IsBuildin;

				manager_arry.push(v);
				if (i1 != 1){
					$("#accIP_type").val(2).trigger('change');
					$("#accIP").data('value',v);
					$("#accIP").find('span').text(t);
					$('#add4').click();
				}else{
					if (!type){
						$("#accIP_type").val(2).trigger('change');
						$("#accIP").data('value',v);
						$("#accIP").find('span').text(t);
					}else{
						$("#accIP_type").val(1).trigger('change');
						$("#in_ip").val(v).trigger('change');
					}
				}			
			}
		}else{
			$("#accIP").data('value','-1');
			$("#accIP").find('span').text('请选择');
		}
	}

	var _SwitchCmd = "";
	var _SwitchPasswdPrompt = "";
	var accIP_nomal = "";

	//回显设备类型的 服务模板

	var ServiceSet =
		{
			"HostServiceId": 0,
			"HostServiceName": "",
			"ProtocolId": 0,
			"Port": 0,
			"ConnParamId": 0,
			//"DomainId": null,
			"FromHostServiceId": 0,
			"FromAccountId": 0,
			"FromLoginCmd": null,
			"NormalPrompt": null,
			"SuperPrompt": null,
			"AcctSwitchCmd": null,
			"SwitchPasswdPrompt": null,
			"LoginUserPrompt": null,
			"LoginPasswdPrompt": null,
			"LoginSuccPrompt": null,
			"ExtraPrompt": null,
			"ExtraReply": null,
			"LineBreak": null,
			"AccIPSet": [
			],
			"IsAcc":0
		}
	var ServerIndex = -1;
	function init_server() {
		ServiceSet =
			{
				"HostServiceId": 0,
				"HostServiceName": "",
				"ProtocolId": 0,
				"Port": 0,
				"ConnParamId": 0,
				//"DomainId": null,
				"FromHostServiceId": 0,
				"FromAccountId": 0,
				"FromLoginCmd": null,
				"NormalPrompt": null,
				"SuperPrompt": null,
				"AcctSwitchCmd": null,
				"SwitchPasswdPrompt": null,
				"LoginUserPrompt": null,
				"LoginPasswdPrompt": null,
				"LoginSuccPrompt": null,
				"ExtraPrompt": null,
				"ExtraReply": null,
				"LineBreak": null,
				"AccIPSet": [
				]
			}
	}
	//绑定 服务
function service_list_refresh(){
	//绑定 服务
	$("#service_list").empty();
	if(host.ServiceSet ==null) host.ServiceSet=[];
	var Service_arr=[];
	$(host.ServiceSet).each(function(i,item){
		if ($.inArray(item.ProtocolName+'('+item.Port+')',Service_arr)>=0){
			return true;
		}else{
			Service_arr.push(item.ProtocolName+'('+item.Port+')');
		}
		var from_accountname;
		if(item.FromAccountName == "-"){
			from_accountname = "-";
		}else if(item.FromAccountName == "*"){
			from_accountname = "*";
		}else{
			from_accountname = item.FromAccountName;
		}
		$("#LineBreak").val(item.LineBreak).trigger('change');
		$("#FromHostName").val(item.FromHostId).trigger('change');
		$("#FromAccountName").val(item.FromAccountId).trigger('change');
		$("#FromHostServiceName").val(item.FromHostServiceId).trigger('change');
		var float_str = ((item.FromHostId == null)?"":"<p>跳转来源主机："+$("#FromHostName option:selected").text()+"</p>")+ 
			((item.FromHostServiceId == null)?"":"<p>跳转来源服务："+$("#FromHostServiceName option:selected").text()+"</p>")+ 
			((item.FromAccountId == null)?"":"<p>跳转来源账号："+$("#FromAccountName option:selected").text()+"</p>")+ 
			((item.NormalPrompt == null || item.NormalPrompt == '')?"":"<p>跳转命令："+item.NormalPrompt+"</p>")+ 
			((item.FromLoginCmd == null || item.FromLoginCmd == '')?"":"<p>命令提示符："+item.FromLoginCmd+"</p>")+ 
			((item.AcctSwitchCmd == null || item.AcctSwitchCmd == '')?"":"<p>账号切换命令："+item.AcctSwitchCmd+"</p>")+ 
			((item.SwitchPasswdPrompt == null || item.SwitchPasswdPrompt == '')?"":"<p>切换密码提示："+item.SwitchPasswdPrompt+"</p>")+ 
			((item.LoginUserPrompt == null || item.LoginUserPrompt == '')?"":"<p>登录名提示："+item.LoginUserPrompt+"</p>")+ 
			((item.LoginPasswdPrompt == null || item.LoginPasswdPrompt == '')?"":"<p>登录密码提示："+item.LoginPasswdPrompt+"</p>")+ 
			((item.LoginSuccPrompt == null || item.LoginSuccPrompt == '')?"":"<p>登录成功提示："+item.LoginSuccPrompt+"</p>")+ 
			"<p>换行符："+$("#LineBreak option:selected").text()+"</p>";
		var accip_list = [];
		if(GlobalStartegy.AccIPSet == null){
			var accIP_select_tmp = [];
			if(item.AccIPSet == null) accip_list=[];
			$(item.AccIPSet).each(function(i1,item1){
				if(item1.IsBuildin == false){
					accip_list.push(item1.AccIP);
				}else if(item1.IsBuildin == true){
					accip_list.push(item1.AccIPId);
				}else if(item1.AccIP==''){
					accip_list.push(item1.AccIPId);
				}else{
					accip_list.push(item1.AccIP);
				}
			});
		}else{
			accip_list = ['全局指定'];
		}
		var ConnParamName_arr=[];
		var HostServiceName_arr=[];
		$(host.ServiceSet).each(function(i1,item1){
			if(item1.ProtocolId==item.ProtocolId && item1.Port==item.Port /*&& item1.ConnParamId!=null*/){
				if(item1.ConnParamId!=null){
					ConnParamName_arr.push(item1.ConnParamName);
				}
				HostServiceName_arr.push(item1.HostServiceId);
			}
		});
		$("#service_list").append("<tr id=\"ser_"+(HostServiceName_arr.join('_'))+"\">"+
		"<td style=\"display: none;\">"+item.HostServiceName+"</td>"+
		"<td style=\"border-left: 1px solid #FFF;\" value=\""+item.ProtocolName+"("+item.Port+")\">"+item.ProtocolName+"("+item.Port+")</td>"+
		"<td>"+ConnParamName_arr.join(',')+"</td>"+
		"<td>"+accip_list.join(',')+"</td>"+
		"<td><div class=\"tab-ctr\">"+
		"<a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog1('edit','"+item.HostServiceName+"')\"></a>"+
		"<a href=\"javascript:;\" class=\"del\" id=\"del\"onclick=\"_delServer('"+item.HostServiceName+"',this)\"></a>"+
		"</div><div class=\"tab-moreinfo\">"+float_str+"</div></td>"+
		"</tr>");
	});
}

//绑定账号
function service_account_list_refresh(){
	//绑定账号
	$("#service_account_list").empty();
	if(host.AccountSet == null) host.AccountSet=[];
	$(host.AccountSet).each(function(i,item){
		AccountSet = item;
		//获取 主机、服务
		var server_str = [];
		$(AccountSet.HostServiceSet).each(function(i1,item1){
			if($.inArray(item1.ProtocolName+'-'+item1.Port,server_str)<0){
				server_str.push(item1.ProtocolName+'-'+item1.Port);
			}
		});
		// server_str = server_str.substr(0,server_str.length-1);
		/*
		if(AccountSet.HostAccount.IsSuperAcct == true)
			$("#IsSuperAcct").iCheck("check");
		else{
			$("#IsSuperAcct").iCheck("uncheck");
		}*/
		if(AccountSet.HostAccount.FromAccountName == null){
			a1 = "";
		}else{
			a1 = AccountSet.HostAccount.FromAccountName;
		}
		if(AccountSet.HostAccount.AcctSwitchCmd == null){
			a2 = "";
		}else{
			a2 = AccountSet.HostAccount.AcctSwitchCmd;
		}
		if(AccountSet.HostAccount.SwitchPasswdPrompt == null){
			a3 = "";
		}else{
			a3 = AccountSet.HostAccount.SwitchPasswdPrompt;
		}
		var float_str =  "<p>切换账号：" +a1+ "</p>" +
		"<p>切换命令："+a2+"</p>"+
		"<p>切换密码提示："+a3+"</p>";
		if(AccountSet.HostAccount.AccountName == '*'){
			var AccountName = "*";
		}else if(AccountSet.HostAccount.AccountName == '-'){
			var AccountName = "-";
		}else{
			var AccountName = AccountSet.HostAccount.AccountName;
		}
		var server_array = [];
		$.each(AccountSet.HostServiceSet,function(i1,item1){
			server_array.push(item1.ProtocolName);
		})
		var flag_ser = 0;
		var ser_str = server_array.join(',');
		$.each(server_array,function(i,item){
			$.each(SUP_PROTOCOL,function(i2,item2){
				if(item == item2){
					flag_ser = 1;
					return false;
				}
			})
		})
		var psdType;
		if(item.Password == null && item.PasswordType != 2 || item.PasswordType == 0 || item.PasswordType == 3){
			psdType = "未保存";
			flag_ser = 0;
		}else{
			psdType = "已保存";
			flag_ser = 1;
		}
		if(item.PasswordType == 3){
			AuthType = "密钥";
		}else{
			AuthType = "密码";
		}
		if(flag_ser == 1){
			if(AccountSet.HostAccount.IsSuperAcct == true){
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td style=\"color:red;\" id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog2('edit',this,'"+item.Password+"')\"></a><a href=\"javascript:;\" class=\"icon2\" onclick=\"_getDialog_connectTest('"+AccountSet.HostAccount.AccountId+"','"+ser_str+"');\" ></a><a href=\"javascript:;\" class=\"del\" id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}	else{
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\"  id=\"edit\"onclick=\"_getDialog2('edit',this,'"+item.Password+"')\"></a><a href=\"javascript:;\" class=\"icon2\" onclick=\"_getDialog_connectTest('"+AccountSet.HostAccount.AccountId+"','"+ser_str+"');\" ></a><a href=\"javascript:;\" class=\"del\"  id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}
		}else if(flag_ser == 0){
			if(AccountSet.HostAccount.IsSuperAcct == true){
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td style=\"color:red;\" id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog2('edit',this,'"+item.Password+"')\"></a><a href=\"javascript:;\" class=\"icon2 disabled\"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}	else{
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\"  id=\"edit\"onclick=\"_getDialog2('edit',this,'"+item.Password+"')\"></a><a href=\"javascript:;\" class=\"icon2 disabled\"></a><a href=\"javascript:;\" class=\"del\"  id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}				
		}
	});
}

	function _addServer(type,o_name) {
		//		
		$('.'+$('.xSelect_connList .xSelect-show').data('id')).hide();
		$('.'+$('.xSelect-accIP .xSelect-show').data('id')).hide();
		// HostServiceName = $("#HostServiceName").val();
		/*
		if(HostServiceName ==""){
			_alert(2,"主机","请填写服务名称");
			return false;
		}
		var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-]+$/;
		if(!nameReg.test(HostServiceName)){
			_alert(2,"主机",'服务名称格式不正确');
			return false;
		}*/
		ProtocolId = $("#ProtocolName").data('value');
		if (ProtocolId == "" || ProtocolId == "-1") {
			$('#autoView').hide();
			$('.g-tsel').removeClass('on');
			_alert(2, title, "请选择协议");
			return false;
		}
		Port = $("#Port").val();
		if (Port == "") {
			$('#autoView').hide();
			$('.g-tsel').removeClass('on');			
			_alert(2, title, "请输入端口", $("#Port"));
			return false;
		}

		if (parseInt(Port) <= 0 || parseInt(Port) >= 65535) {
			$('#autoView').hide();
			$('.g-tsel').removeClass('on');			
			_alert(1, title, "协议端口在0~65535之间", $("#Port"));
			return false;
		}
		/*
		ConnParamId = $("#ConnParamName").data('value');

		if (ConnParamId == "" || ConnParamId == "-1" || ConnParamId == undefined) {
			ConnParamId = null;
			ConnParamName = '';
		}else{
			ConnParamName = $("#ConnParamName").find('span').text();
		}
		*/
		var n = 0;
		$(host.ServiceSet).each(function (i, item) {
			// if (ProtocolId == item.ProtocolId && Port == item.Port && ConnParamId == item.ConnParamId && ServerIndex != i) {
			if((ProtocolId == item.ProtocolId && Port == item.Port) && (item.ProtocolName!=old_pro_name || item.Port!=old_prot)){
				$('#autoView').hide();
				$('.g-tsel').removeClass('on');				
				_alert(1, title, '相同的配置已存在');
				n = 1;
				return false;
			}
			if(item.ProtocolName==old_pro_name && item.Port==old_prot){
				return false;
			}
		})
		if(n) return false;

		/*
		ServiceSetString = JSON.stringify(host.ServiceSet);
		if (HostServiceName == "") {
			HostServiceName1 = $("#ProtocolName").find('span').text();
			HostServiceName2 = $("#ProtocolName").find('span').text() + Port;
			HostServiceName3 = $("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
			
			service_tmp1 = "\"HostServiceName\":\"" + HostServiceName1 + "\"";
			service_tmp2 = "\"HostServiceName\":\"" + HostServiceName2 + "\"";
			service_tmp3 = "\"HostServiceName\":\"" + HostServiceName3 + "\"";
			if (ServiceSetString.indexOf(service_tmp1) >= 0) {
				if (ServiceSetString.indexOf(service_tmp2) >= 0) {
					if (ServiceSetString.indexOf(service_tmp3) >= 0) {
						$('#autoView').hide();
						$('.g-tsel').removeClass('on');
						_alert(1, title, '相同的服务名称已存在');
						return false;
					} else {
						ServiceSet.HostServiceName = HostServiceName3;
					}
				} else {
					ServiceSet.HostServiceName = HostServiceName2;
				}
			} else {
				ServiceSet.HostServiceName = HostServiceName1;
			}
		} else {
			if(ServiceSetString.indexOf("\"HostServiceName\":\"" + HostServiceName + "\"") >=0 && type != 'edit'){
				$('#autoView').hide();
				$('.g-tsel').removeClass('on');
				_alert(1, title, '相同的服务名称已存在',$("#HostServiceName"));
				return false;
			}
			ServiceSet.HostServiceName = HostServiceName;
			
		}
		*/

		ServiceSet.HostServiceId = 0;
		//ServiceSet.HostServiceName = $("#HostServiceName").val();
		ServiceSet.ProtocolId = parseInt($("#ProtocolName").data('value'));
		ServiceSet.ProtocolName = $("#ProtocolName").find('span').text();
		ServiceSet.Port = parseInt($("#Port").val());
		if($("#FromHostName").val() == ""){
			ServiceSet.FromHostId = null;
		}else{
			ServiceSet.FromHostId = parseInt($("#FromHostName").val());		
		}
		if($("#FromHostServiceName").val() == ""){
			ServiceSet.FromHostServiceId = null;
		}else{
			ServiceSet.FromHostServiceId = parseInt($("#FromHostServiceName").val());
		}
		if($("#FromAccountName").val() == ""){
			ServiceSet.FromAccountId = null;
		}else{
			ServiceSet.FromAccountId = parseInt($("#FromAccountName").val());		
		}
		ServiceSet.FromLoginCmd = $("#FromLoginCmd").val();
		ServiceSet.NormalPrompt = $("#NormalPrompt").val();
		ServiceSet.AcctSwitchCmd = $("#AcctSwitchCmd").val();
		ServiceSet.SwitchPasswdPrompt = $("#SwitchPasswdPrompt").val();
		ServiceSet.LoginUserPrompt = $("#LoginUserPrompt").val();
		ServiceSet.LoginPasswdPrompt = $("#LoginPasswdPrompt").val();
		ServiceSet.LoginSuccPrompt = $("#LoginSuccPrompt").val();
		ServiceSet.ExtraPrompt = $("#ExtraPrompt").val();
		ServiceSet.ExtraReply = $("#ExtraReply").val();
		ServiceSet.LineBreak = parseInt($("#LineBreak").val());
		ServiceSet.AccIPSet = [];
		var accip_list = [];
		var accip_name = [];
		if($("#ProtocolName").find('span').text() == "RDP" ){
			ServiceSet.IsAcc = parseInt($("#IsAcc").val());
		}else{
			ServiceSet.IsAcc = 0;
		}
		if( ($("#ProtocolName").find('span').text() == "RDP"  && ServiceSet.IsAcc !=0) || ($("#ProtocolName").find('span').text() != "RDP") ){
			if ($("#accIP_cont").children('div:first').find('select:first').val() == 1){
				var id = $("#accIP_cont").children('div:first').children('div:eq(1)').find('select').val();
				accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\"\"}");
				ServiceSet.AccIPSet.push(accIP_json);
				accip_list.push(id);
			}else{
				var id = $("#accIP_cont").children('div:first').children('div:eq(2)').data('value');
				if (id != undefined && id != "-1"){
					var name = $("#accIP_cont").children('div:first').children('div:eq(2)').find('span').text();
					accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\""+name+"\"}");
					ServiceSet.AccIPSet.push(accIP_json);
					accip_list.push(name);
				}
			}
			
			$("#accIP_cont").children('div:not(:first)').each(function(i,item){
				var id = $(item).children('div:eq(2)').data('value');
				var name = $(item).children('div:eq(2)').find('span').text();
				accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\""+name+"\"}");
				ServiceSet.AccIPSet.push(accIP_json);
				accip_list.push(name);
			});
			if(ServiceSet.IsAcc != 0 && ($("#ProtocolName").find('span').text() == "RDP") && !$("#accIP_cont1").is(":visible")){
				if(accip_list.length == 0){
					_alert(1, title, '请选择应用发布');
					return false;
				}
			}
		}
		// var float_str = "<p>跳转来源主机：" + $("#FromHostName option:selected").text().replace("请选择", "") + "</p>" +
		// 	"<p>跳转来源服务：" + $("#FromHostServiceName option:selected").text().replace("请选择", "") + "</p>" +
		// 	"<p>跳转来源账号：" + $("#FromAccountName option:selected").text().replace("请选择", "") + "</p>" +
		// 	"<p>跳转命令：" + $("#NormalPrompt").val() + "</p>" +
		// 	"<p>命令提示符：" + $("#FromLoginCmd").val() + "</p>" +
		// 	"<p>账号切换命令：" + $("#AcctSwitchCmd").val() + "</p>" +
		// 	"<p>切换密码提示：" + $("#SwitchPasswdPrompt").val() + "</p>" +
		// 	"<p>登录名提示：" + $("#LoginUserPrompt").val() + "</p>" +
		// 	"<p>登录密码提示：" + $("#LoginPasswdPrompt").val() + "</p>" +
		// 	"<p>登录成功提示：" + $("#LoginSuccPrompt").val() + "</p>" +
		// 	"<p>换行符：" + $("#LineBreak option:selected").text() + "</p>";
		var float_str = (($("#FromHostName option:selected").text().replace("请选择","")=='')?"":("<p>跳转来源主机："+$("#FromHostName option:selected").text().replace("请选择","")+"</p>"))+ 
		(($("#FromHostServiceName option:selected").text().replace("请选择","")=='')?"":("<p>跳转来源服务："+$("#FromHostServiceName option:selected").text().replace("请选择","")+"</p>"))+ 
		($("#FromAccountName option:selected").text().replace("请选择","")==''?"":("<p>跳转来源账号："+$("#FromAccountName option:selected").text().replace("请选择","")+"</p>"))+ 
		(($("#NormalPrompt").val()=='')?"":("<p>跳转命令："+$("#NormalPrompt").val()+"</p>"))+ 
		(($("#FromLoginCmd").val()=='')?"":("<p>命令提示符："+$("#FromLoginCmd").val()+"</p>"))+ 
		(($("#AcctSwitchCmd").val()=='')?"":("<p>账号切换命令："+$("#AcctSwitchCmd").val()+"</p>"))+ 
		(($("#SwitchPasswdPrompt").val()=='')?"":("<p>切换密码提示："+$("#SwitchPasswdPrompt").val()+"</p>"))+ 
		(($("#LoginUserPrompt").val()=='')?"":("<p>登录名提示："+$("#LoginUserPrompt").val()+"</p>"))+ 
		(($("#LoginPasswdPrompt").val()=='')?"":("<p>登录密码提示："+$("#LoginPasswdPrompt").val()+"</p>"))+ 
		(($("#LoginSuccPrompt").val()=='')?"":("<p>登录成功提示："+$("#LoginSuccPrompt").val()+"</p>"))+ 
		(($("#LineBreak option:selected").text()=='')?"":("<p>换行符："+$("#LineBreak option:selected").text()+"</p>"));
		if (type == "add") {
			var ConnParamName_arr=new Array();
			var no_pass=true;
			$.each(host.ServiceSet,function(i,item){
				if(item.ProtocolId==3 && item.Port==ServiceSet.Port){
					no_pass=false;
					return false;
				}
			});

			$('#div_conn div.srsCtl1').each(function(i,item){
				ConnParamId =$(item).find('.xSelect_connList').data('value');
				if(ConnParamId == "" || ConnParamId == "-1" || ConnParamId == undefined){
					ConnParamId = null;
					ConnParamName = '';
					if($('#div_conn div.srsCtl1').length>1){
						return true;
					}
					//return true;
				}else{
					ConnParamName = $(item).find('.xSelect_connList').find('span').text();
				}
				ServiceSet.ConnParamId = ConnParamId;
				ServiceSet.ConnParamName = ConnParamName;
				if(ConnParamName!=''){
					ConnParamName_arr.push(ConnParamName);
					ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
				}else{
					ConnParamName_arr.push(null);
					ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
				}
				ServiceSet.HostServiceId = 0;
				host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
				if(ServiceSet.ProtocolName=='SSH' && $('#same_sftp_check').is(':checked')){
					if(no_pass){
						ServiceSet.ProtocolName='SFTP';
						ServiceSet.ProtocolId=3;
						ServiceSet.FromHostId = null;
						ServiceSet.FromHostServiceId=null;
						ServiceSet.FromAccountId=null;
						ServiceSet.NormalPrompt=null;
						if(ServiceSet.ConnParamName!=''){
							ServiceSet.HostServiceName=ServiceSet.ProtocolName+ServiceSet.Port+'('+ServiceSet.ConnParamName+')';
						}else{
							ServiceSet.HostServiceName=ServiceSet.ProtocolName+ServiceSet.Port;
						}
						host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
					}
				}
			});
			service_list_refresh();
		}
		else {
			var ConnParamId_arr=[];
			var ConnParam_arr=[];
			var ConnParamName_arr=[];
			var no_pass=false;
			if(ServiceSet.ProtocolName=='SSH' && $('#same_sftp_check').is(':checked')){
				no_pass=true;
				$.each(host.ServiceSet,function(i,item){
					if(item.ProtocolId==3 && item.Port==ServiceSet.Port){
						no_pass=false;
						return false;
					}
				});
			}
			var ConnParamId_arr=[];
			$('#div_conn div.srsCtl1').each(function(i,item){
				var ConnParamId =$(item).find('.xSelect_connList').data('value');
				var ConnParamName = '';
				if(ConnParamId == "" || ConnParamId == "-1" || ConnParamId == undefined){
					ConnParamId = null;
					ConnParamName = '';
					if($('#div_conn div.srsCtl1').length>1){
						return true;
					}
					//return true;
				}else{
					ConnParamName = $(item).find('.xSelect_connList').find('span').text();
				}
				ServiceSet.ConnParamId = ConnParamId;
				ServiceSet.ConnParamName = ConnParamName;
				if(ConnParamName!=''){
					ConnParamId_arr.push(ConnParamId);
					ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
				}else{
					ConnParamId_arr.push(null);
					ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
				}
				var refresh=false;
				$(host.ServiceSet).each(function(i,item){
					if(old_pro_name == item.ProtocolName && old_prot == item.Port && ConnParamId==item.ConnParamId){
						ServiceSet.HostServiceId = item.HostServiceId;
						if(item.ConnParamId==null || item.ConnParamId==''){
							ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
						}else{
							ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
						}
						host.ServiceSet[i]=JSON.parse(JSON.stringify(ServiceSet));
						$(host.AccountSet).each(function(i2,item2){
							// var num=0;
							HostServiceSet_tmp = item2.HostServiceSet;
							$(HostServiceSet_tmp).each(function(i1,item1){
								if(item1.ProtocolName == old_pro_name && item1.Port==old_prot && ConnParamId==item1.ConnParamId){
									item1.HostServiceName = ServiceSet.HostServiceName;
									item1.ProtocolId = ServiceSet.ProtocolId;
									item1.Port = ServiceSet.Port;
									item1.ConnParamId = ServiceSet.ConnParamId;
									item1.ProtocolName = ServiceSet.ProtocolName;
									item1.ConnParamName = ServiceSet.ConnParamName;
									// num++;
								}
							})
						})
						refresh=true;
						return true;
					}
				});
				if (!refresh){
					ServiceSet.HostServiceId=0;
					if(ConnParamName==''){
						ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
					}else{
						ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
					}
					host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
				}
				if(no_pass){
					ServiceSet.HostServiceId=0;
					ServiceSet.ProtocolName='SFTP';
					ServiceSet.ProtocolId=3;
					ServiceSet.FromHostId = null;
					ServiceSet.FromHostServiceId=null;
					ServiceSet.FromAccountId=null;
					ServiceSet.HostServiceName=ServiceSet.ProtocolName+ServiceSet.Port+'('+ServiceSet.ConnParamName+')';
					host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
				}
			});
			var num=0;
			$(host.ServiceSet).each(function(i,item){
				if(old_pro_name == item.ProtocolName && old_prot == item.Port && $.inArray(item.ConnParamId,ConnParamId_arr)<0){
					var ConnParamId=item.ConnParamId;
					host.ServiceSet.splice(i-num,1);
					num++;
				}else if(old_pro_name == item.ProtocolName && old_prot == item.Port && $.inArray(item.ConnParamId,ConnParamId_arr)>=0){
					$(host.AccountSet).each(function(i2,item2){
						var num1=0;
						var ConnParamId_AccountSet_arr=null;
						HostServiceSet_tmp=item2.HostServiceSet;
						$(HostServiceSet_tmp).each(function(i1,item1){
							if(item1.ProtocolName == old_pro_name && item1.Port==old_prot){
								if (ConnParamId_AccountSet_arr==null){
									ConnParamId_AccountSet_arr=[]
								}
								ConnParamId_AccountSet_arr.push(item1.ConnParamId);
							}
						})
						if(ConnParamId_AccountSet_arr!=null && $.inArray(item.ConnParamId,ConnParamId_AccountSet_arr)<0){
							var tmp={"HostId": host_id,"HostServiceId": item.HostServiceId,"HostServiceName": item.HostServiceName,"ProtocolName": item.ProtocolName,"ProtocolId": item.ProtocolId,"Port": item.Port,"ConnParamId": item.ConnParamId,"ConnParamName": item.ConnParamName};
							item2.HostServiceSet.push(tmp);
						}
					})
				}
			});
			$(host.AccountSet).each(function(i2,item2){
				var num1=0;
				HostServiceSet_tmp=item2.HostServiceSet;
				$(HostServiceSet_tmp).each(function(i1,item1){
					if(item1.ProtocolName == old_pro_name && item1.Port==old_prot && $.inArray(item1.ConnParamId,ConnParamId_arr)<0){
						item2.HostServiceSet.splice(i1-num1,1);
						num1++;
					}
				})
			})
			service_list_refresh();
			service_account_list_refresh();
		}
		tabArr2();
		clear_server();
	}
	function tabArr1(){
		$('table').unbind();
		var tout,tin;
		var $cloneItem;
		var z = false;

		$('table').on('mouseover','tbody>tr',function(){
			document.onclick = null;
		}).on('mouseout','tbody>tr',function(){
			document.onclick = function(){
				$('div.tab-moreinfo-on').hide();
				$('tr.on').removeClass('on');
			}
		}).on('click','tbody>tr',function(e){
			x=e.target;
			if(x.id=='del'){
				return false;
			}
			if(x.id=='edit'){
				return false;
			}
			document.onclick = null;

			var $this = $(this);
			var $tr = $this;
			var oset = $tr.offset();

			var trc = $tr.attr('class');
			if(trc && trc.indexOf('on') >=0 ){
				$('div.tab-moreinfo-on').hide();
				$('tr.on').removeClass('on');
				return;
			}

			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
			$tr.addClass('on');
			
			var $box = $this.parents('div.box-table').parents('.c-cont');
			var boxh = $box.height() - 40, boxo = $box.offset();

			var $item = $this.children('td:last').children('div.tab-moreinfo');
			var ih = $item.outerHeight(),th = $tr.outerHeight();

			$cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');

			if(boxh < oset.top-boxo.top + ih + th - 40 ){
				$cloneItem.css({
					top:oset.top - ih,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}else{
				$cloneItem.css({
					top:oset.top + $tr.outerHeight() + 1,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}
		})
		
		$('.box-table,body,.c-cont2,.c-cont').on('scroll',function(){
			$('div.tab-moreinfo-on').remove();
			$('tr.on').removeClass('on');
		})
		
		var len = $("#service_account_list").find('.tab-ctr:first').children('a').length;
		$('table>thead>tr>th:last').width(len*26);
	}
	function tabArr2(){
		$('table').unbind();
		var tout,tin;
		var $cloneItem;
		var z = false;

		$('table').on('mouseover','tbody>tr',function(){
			document.onclick = null;
		}).on('mouseout','tbody>tr',function(){
			document.onclick = function(){
				$('div.tab-moreinfo-on').hide();
				$('tr.on').removeClass('on');
			}
		}).on('click','tbody>tr',function(e){
			x=e.target;
			if(x.id=='del'){
				return false;
			}
			if(x.id=='edit'){
				return false;
			}
			document.onclick = null;

			var $this = $(this);
			var $tr = $this;
			var oset = $tr.offset();

			var trc = $tr.attr('class');
			if(trc && trc.indexOf('on') >=0 ){
				$('div.tab-moreinfo-on').hide();
				$('tr.on').removeClass('on');
				return;
			}

			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
			$tr.addClass('on');
			
			var $box = $this.parents('div.box-table').parents('.c-cont');
			var boxh = $box.height() - 40, boxo = $box.offset();

			var $item = $this.children('td:last').children('div.tab-moreinfo');
			var ih = $item.outerHeight(),th = $tr.outerHeight();

			$cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');

			if(boxh < oset.top-boxo.top + ih + th - 40 ){
				$cloneItem.css({
					top:oset.top - ih,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}else{
				$cloneItem.css({
					top:oset.top + $tr.outerHeight() + 1,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}
		})
		
		$('.box-table,body,.c-cont2,.c-cont').on('scroll',function(){
			$('div.tab-moreinfo-on').remove();
			$('tr.on').removeClass('on');
		})
		
		var len = $("#service_list").find('.tab-ctr:first').children('a').length;
		$("table:first").find('thead>tr>th:last').width(len*26);
	}
	//保存前置机IP
	var result_id;

	var manager_arry=['-1'];
	var manageradd = 0;
	var manager_index = 0;
	var manager_value = "";
	var conn_arr=['-1'];
	function _addconn(obj){
		var connid = $('#ConnParamName').data('value');
		var v = $('#ConnParamName').find('span').text();
		var $c = $(obj).parent().clone();
		if (connid == undefined || connid == '-1'){
			_alert(2, "设备类型", "请选择连接参数");
			return false;
		}
		connid = parseInt(connid);
		if (conn_arr.indexOf(connid) === -1) {
			conn_arr.push(connid);
		}
		
		conn_index_all.splice($.inArray(connid, conn_index_all), 1);
		$(obj).parent().parent().append($c);
		$c.find('select').attr('disabled',true);
		$c.find('span.select2-selection--single').css("background-color","rgb(235, 235, 228)");
		$c.find('.xSelect-show').attr('disabled',true);
		$c.find('a').after('<a class="ctrl del" style="float: left;width: 15px;height: 15px;overflow: hidden;background: url(/manage/images/icon-ctr.png) no-repeat 0 0;margin: 6px 0 0 10px;display: none;background-position: 0 0;cursor: pointer;" onclick="_delconn(this)"></a>').remove();
		$c.find('.xSelect_connList').css("background-color","rgb(235, 235, 228)");
		$c.find('.xSelect_connList').data('value',connid);
		$c.find('select').attr('id',"");
		$c.find('.xSelect_connList').attr('id',"");
		$c.find('.xSelect-show').attr('data-id',"");
		$('#ConnParamName').find('span').text('请选择');
		$('#ConnParamName').data('value',-1);
		$("div[data-id=xSelect-connparam]").children('input').val('');
		$("div[data-id=xSelect-connparam]").find('span[data-value='+connid+']').parent('li').remove();
	}
	var _if_disable = '2';
	function _delconn(obj){
		var $c = $(obj).prev().children('.xSelect_connList');
		var id = $c.data('value');
		var t = $c.find('span').text();
		var v, data, max;
		var min = 0;
		max = conn_index_all.length - 1;
		data = conn_index_all;
		conn_arr.splice($.inArray(id, conn_arr), 1);
		var $p = $("div[data-id=xSelect-connparam]").children('ul');
		$(obj).parent().remove();
		var index_1 = search_i(min, max, parseInt(id), data);
		index_1 = parseInt(index_1);
		if(_if_disable == '1'){
			i_class = '';
		}else{
			i_class = 'edit';
		}
		
		if (index_1 == -1) {
			index_1 = max;
			$p.append('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'"  style="">'+t+'</span></li>');
		} else if (index_1 == -2) {
			index_1 = 0;
			$p.prepend('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'" style="">'+t+'</span></li>');
		} else {
			$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'" style="">'+t+'</span></li>');
		}
		data.splice(index_1, 0, parseInt(id));
	}
	function _addaccIP(obj){
		var accip_id = $(obj).prev('div').data('value');
		var v = $(obj).prev('div').find('span').text();
		var $c = $(obj).parent().clone();
		if (accip_id == undefined || accip_id == '-1'){
			_alert(2, "设备类型", "请选择应用发布");
			return false;
		}
		accip_id = parseInt(accip_id);
		if (manager_arry.indexOf(accip_id) === -1) {
			manager_arry.push(accip_id);
		}
		
		acc_index_all.splice($.inArray(accip_id, acc_index_all), 1);
		$(obj).parent().parent().append($c);
		$c.find('select').attr('disabled',true);
		$c.find('span.select2-selection--single').css("background-color","rgb(235, 235, 228)");
		//$c.find('span.select2-selection__arrow').remove();
		$c.find('a').after('<a class="ctrl del" style="cursor: pointer;" onclick="_delIP(this,3)"></a>').remove();
		$c.find('.form-c').css("background-color","rgb(235, 235, 228)");
		$c.find('.form-c').data('value',accip_id);
		$c.find('select').attr('id',"");
		$c.find('.form-c').attr('id',"");
		$(obj).prev().find('span').text('请选择');
		$(obj).prev().data('value',-1);
		$("div[data-id=xSelect-accIP]").children('input').val('');
		$("div[data-id=xSelect-accIP]").find('span[data-value='+accip_id+']').parent('li').remove();
	}

	function change_acc_type(obj){
		if ($(obj).val() == 1){
			$(obj).parent().next().show();
			$(obj).parent().next().next().hide();
			$(obj).parent().next().next().next().hide();
			$(obj).siblings('a').hide();
		}else{
			$(obj).parent().next().hide()
			$(obj).parent().next().next().show();
			$(obj).parent().next().next().next().show();
			$(obj).siblings('a').show();
		}
	}

	function _delIP(obj){
		var $c = $(obj).prev();
		var id = $c.data('value');
		var t = $(obj).prev().find('span').text();
		var v, data, max;
		var min = 0;
		max = acc_index_all.length - 1;
		data = acc_index_all;
		manager_arry.splice($.inArray(id, manager_arry), 1);
		var $p = $("div[data-id=xSelect-accIP]").children('ul');
		$(obj).parent().remove();
		var index_1 = search_i(min, max, parseInt(id), data);
		index_1 = parseInt(index_1);
		if (index_1 == -1) {
			index_1 = max;
			$p.append('<li style=""><i class="delete"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
		} else if (index_1 == -2) {
			index_1 = 0;
			//$p.children('li').eq(0).before('<li style=""><i class="delete"></i><span data-value="'+id+'" style="width:132px">'+t+'</span></li>');
			$p.prepend('<li style=""><i class="delete"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
		} else {
			$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="delete"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
		}
		data.splice(index_1, 0, parseInt(id));
	}
	//重置数据
	function clear_server() {
		accIP_select_tmp = [];
		//ServerIndex = -1;
		$("#HostServiceName").val("");
		$("#Port").val("");
		// $("#ProtocolName").select2('destroy').select2();
		// $("#ProtocolName option:eq(0)").prop("selected", true);
		// $("#ProtocolName").change();
		//$("#DomainName").val('').trigger('change');
		//$("#DomainName option:eq(0)").prop("selected",true);
		$("#FromHostName").select2('destroy').select2();
		$("#FromHostName option:eq(0)").prop("selected", true);
		$("#FromHostName").change();
		$("#FromLoginCmd").val("");
		$("#NormalPrompt").val("");
		$("#AcctSwitchCmd").val(_SwitchCmd);
		$("#SwitchPasswdPrompt").val(_SwitchPasswdPrompt);
		$("#LoginUserPrompt").val("");
		$("#LoginPasswdPrompt").val("");
		$("#LoginSuccPrompt").val("");
		$("#ExtraPrompt").val("");
		$("#ExtraReply").val("");
		$("#LineBreak").val("1").trigger('change');
		$('#same_sftp').hide();
		//清空前置机 待定
		bind_protocol_select();
		bind_Conn_xSelect($("#ProtocolName"));
		$('#div_conn').show();
		init_server();
		$("#AccIpType").val('1').trigger('change');
		accipid_list = [];
		$('#mod_btn_server').hide();
		$('#add_btn_server').show();

		manager_arry=['-1'];
		conn_arr=['-1'];
		manageradd = 0;
		manager_index = 0;
		manager_value = "";
		$("#accIP_type").val(2).trigger('change');
		bind_accip_select();
		$("#accIP_cont").children('div:not(:first)').remove();	
		$("#conn_cont").children('div:not(:first)').remove();	
		$("#_div_isacc select").val(0).trigger('change');
		$("#_div_isacc").hide();
		$("#div_inip").show();
	}

	function search_i(min, max, id, data) {
		var mid, res;
		if (data[max] < id) {
			return -1;
		}
		if (data[min] > id) {
			return -2;
		}
		while (min <= max) {
			mid = parseInt((min + max) / 2);
			if (data[mid] > id) {
				max = mid - 1;
				res = mid;
			} else {
				min = mid + 1;
			}
		}
		return res;
	}
	function set_select(obj) {
		if ($(obj).children('option').length == 2) {
			$(obj).parent().children('i.add').click();
			$(obj).parent().hide();
		}
	}
	var HostServiceName_id_arr=[];
	//编辑 服务列表数据绑定
	function _editServer(Name) {
		$("#add_btn_server").hide();
		$("#mod_btn_server").show();
		
		$(host.ServiceSet).each(function (i, item) {
			if (Name == item.HostServiceName) {
				ServerIndex = i;
				ServiceSet = JSON.parse(JSON.stringify(item));
				old_prot=item.Port;
				old_pro_name=item.ProtocolName;
				if(item.ProtocolId==2){
					$('#same_sftp').show();
					$('#same_sftp_check').iCheck('check');
				}
				$("#HostServiceName").val(item.HostServiceName);
				$("#ProtocolName").data('value',item.ProtocolId);
				$("#ProtocolName").find('span').text(item.ProtocolName);
				var ProtocolId_arr=[9,10,11,12,16,17,18];
				if($.inArray(item.ProtocolId,ProtocolId_arr)>=0){
					$('#div_conn').hide();
				}else{
					$('#div_conn').show();
				}
				bind_Conn_xSelect($("#ProtocolName"));
				HostServiceName_id_arr=new Array();
				for(var i1=0;i1<=host.ServiceSet.length-1;i1++){
					var item1=host.ServiceSet[i1];
					if (item1.ProtocolId==item.ProtocolId && item1.Port==item.Port){
						HostServiceName_id_arr.push(item1.HostServiceId);
						if(item1.ConnParamName != null && item1.ConnParamName != ""){
							$("#ConnParamName").find('span').text(item1.ConnParamName);
							$("#ConnParamName").data('value',item1.ConnParamId);			
							$('#add5').click();
						}
					}
				}
				$("#Port").val(item.Port);
				if(item.FromHostId == ""){
					$("#FromHostName").val("").trigger("change");
				}else{
					$("#FromHostName").val(item.FromHostId).trigger("change");
				}
				
				if(item.FromHostServiceId == ""){
					$("#FromHostServiceName").val("").trigger("change");
				}else{
					$("#FromHostServiceName").val(item.FromHostServiceId).trigger("change");
				}
				
				if(item.FromAccountId == ""){
					$("#FromAccountName").val("").trigger("change");
				}else{
					$("#FromAccountName").val(item.FromAccountId).trigger("change");
				}
				//
				$("#FromLoginCmd").val(item.FromLoginCmd);
				$("#NormalPrompt").val(item.NormalPrompt);
				$("#AcctSwitchCmd").val(item.AcctSwitchCmd);
				$("#SwitchPasswdPrompt").val(item.SwitchPasswdPrompt);
				$("#LoginUserPrompt").val(item.LoginUserPrompt);
				$("#LoginPasswdPrompt").val(item.LoginPasswdPrompt);
				$("#LoginSuccPrompt").val(item.LoginSuccPrompt);
				$("#ExtraPrompt").val(item.ExtraPrompt);
				$("#ExtraReply").val(item.ExtraReply);
				$("#LineBreak").val(item.LineBreak).trigger('change');
				//get_accIP()
				if(item.ProtocolName == "RDP") $("#_div_isacc").show();
				else $("#_div_isacc").hide();
				if(item.IsAcc == null) item.IsAcc = 0;			
				$("#IsAcc").val(item.IsAcc).trigger("change");

				//绑定前置机ip
				if (item.AccIPSet != null){
					for (var i1 = item.AccIPSet.length; i1 > 0; i1--){
						manager_arry.push(item.AccIPSet[i1-1].AccIPId);
						if (i1 != 1){
							if (item.AccIPSet[i1-1].AccIP != "" && item.AccIPSet[i1-1].AccIP != "2.2.2.2"){
								$("#accIP_type").val(2).trigger('change');
								$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
								$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
								$('#add4').click();
							}
						}else{
							if (item.AccIPSet[i1-1].AccIP != "" && item.AccIPSet[i1-1].AccIP != "2.2.2.2"){
								$("#accIP_type").val(2).trigger('change');
								$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
								$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
							}else{
								$("#accIP_type").val(1).trigger('change');
								$("#in_ip").val(item.AccIPSet[i1-1].AccIPId).trigger('change');
							}
						}
					}
				}
			}
		})

	}
	function _delServer(Name,obj){
		var pro_value=$(obj).parents('tr').children('td').eq(1).text();
		var pro_value_arr=[pro_value]
		layer.open({
			type:1,
			title:"删除服务",
			content:'<div class="layer-alert"><i class="alert warning"></i>确定删除</div>',
			btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
				layer.close(i);
				if(pro_value.split('(')[0]=='SSH' ){
					var pro_value_other=pro_value.replace('SSH','SFTP');
					var has_sftp=false;
					$(host.ServiceSet).each(function (i, item) {
						if (pro_value_other == (item.ProtocolName+'('+item.Port+')')) {
							has_sftp=true;
							return false;
						}
					})
					if (has_sftp){
						layer.open({
							type:1,
							title:"删除服务",
							content:'<div class="layer-alert"><i class="alert warning"></i>是否同步删除SFTP</div>',
							btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							btn1:function(i){
								layer.close(i);
								pro_value_arr.push(pro_value_other);
								var flag_n = 0;//防止多个确认窗口重复弹出
								$(host.AccountSet).each(function (i, item) {
									if(flag_n == 1){
										return false;
									}
									$(item.HostServiceSet).each(function (i1, item1) {
										if(flag_n == 1){
											return false;
										}
										// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
										if ($.inArray((item1.ProtocolName+'('+item1.Port+')'),pro_value_arr)>=0) {
											flag_n = 1;
											layer.open({
												type: 1,
												title: "主机管理",
												content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
												btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
												btnAlign: 'c',
												closeBtn: false,
												skin: 'layer-custom',
												area: ['380px', '310px'],
												move: false,
												resize: false,
												btn1: function (i) {
													layer.close(i);
													//删除AccountSet 中的相关数据，并将下方相关账号删除。
													var num=0;
													$(host.AccountSet).each(function (i2, item2) {
														$(item2.HostServiceSet).each(function (i3, item3) {
															if ($.inArray((item3.ProtocolName+'('+item3.Port+')'),pro_value_arr)>=0) {
															// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
																host.AccountSet.splice(i2-num,1);
																num++
																return true;
															}
														})
													})
													//ServiceSet 中的相关数据
													var num=0;
													$(host.ServiceSet).each(function (i2, item2) {
														// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
															if ($.inArray((item2.ProtocolName+'('+item2.Port+')'),pro_value_arr)>=0) {
															host.ServiceSet.splice(i2-num, 1);
															num++;
															// return false;
														}
													})
													flag_n = 1;
													$(obj).parent().parent().parent().remove();
													clear_server();
													service_list_refresh();
													service_account_list_refresh();
												},
												btn2: function (i) {
													layer.close(i);
													flag_n = 1;
													return false;
												}
											});
										}
									})
									
								})
								if(flag_n == 0){
									//ServiceSet 中的相关数据
									var num=0;
									$(host.ServiceSet).each(function (i, item) {
										if ($.inArray((item.ProtocolName+'('+item.Port+')'),pro_value_arr)>=0) {
										// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
											host.ServiceSet.splice(i-num, 1);
											num++;
											// return false;
										}
									})
									flag_n = 1;
									$(obj).parent().parent().parent().remove();
									clear_server();
									service_list_refresh();
									service_account_list_refresh();
								}
							},
							btn2:function(i){
								layer.close(i);
								var flag_n = 0;//防止多个确认窗口重复弹出
								$(host.AccountSet).each(function (i, item) {
									if(flag_n == 1){
										return false;
									}
									$(item.HostServiceSet).each(function (i1, item1) {
										if(flag_n == 1){
											return false;
										}
										// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
										if ($.inArray((item1.ProtocolName+'('+item1.Port+')'),pro_value_arr)>=0) {
											flag_n = 1;
											layer.open({
												type: 1,
												title: "主机管理",
												content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
												btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
												btnAlign: 'c',
												closeBtn: false,
												skin: 'layer-custom',
												area: ['380px', '310px'],
												move: false,
												resize: false,
												btn1: function (i) {
													layer.close(i);
													//删除AccountSet 中的相关数据，并将下方相关账号删除。
													var num=0;
													$(host.AccountSet).each(function (i2, item2) {
														$(item2.HostServiceSet).each(function (i3, item3) {
															if ($.inArray((item3.ProtocolName+'('+item3.Port+')'),pro_value_arr)>=0) {
															// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
																host.AccountSet.splice(i2-num,1);
																num++
																return true;
															}
														})
													})
													//ServiceSet 中的相关数据
													var num=0;
													$(host.ServiceSet).each(function (i2, item2) {
														// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
															if ($.inArray((item2.ProtocolName+'('+item2.Port+')'),pro_value_arr)>=0) {
															host.ServiceSet.splice(i2-num, 1);
															num++;
															// return false;
														}
													})
													flag_n = 1;
													$(obj).parent().parent().parent().remove();
													clear_server();
													service_list_refresh();
													service_account_list_refresh();
												},
												btn2: function (i) {
													layer.close(i);
													flag_n = 1;
													return false;
												}
											});
										}
									})
									
								})
								if(flag_n == 0){
									//ServiceSet 中的相关数据
									var num=0;
									$(host.ServiceSet).each(function (i, item) {
										if ($.inArray((item.ProtocolName+'('+item.Port+')'),pro_value_arr)>=0) {
										// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
											host.ServiceSet.splice(i-num, 1);
											num++;
											// return false;
										}
									})
									flag_n = 1;
									$(obj).parent().parent().parent().remove();
									clear_server();
									service_list_refresh();
									service_account_list_refresh();
								}
							}
						})
					}
					else{
						var flag_n = 0;//防止多个确认窗口重复弹出
						$(host.AccountSet).each(function (i, item) {
							if(flag_n == 1){
								return false;
							}
							$(item.HostServiceSet).each(function (i1, item1) {
								if(flag_n == 1){
									return false;
								}
								// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
								if ($.inArray((item1.ProtocolName+'('+item1.Port+')'),pro_value_arr)>=0) {
									flag_n = 1;
									layer.open({
										type: 1,
										title: "主机管理",
										content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
										btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
										btnAlign: 'c',
										closeBtn: false,
										skin: 'layer-custom',
										area: ['380px', '310px'],
										move: false,
										resize: false,
										btn1: function (i) {
											layer.close(i);
											//删除AccountSet 中的相关数据，并将下方相关账号删除。
											var num=0;
											$(host.AccountSet).each(function (i2, item2) {
												$(item2.HostServiceSet).each(function (i3, item3) {
													if ($.inArray((item3.ProtocolName+'('+item3.Port+')'),pro_value_arr)>=0) {
													// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
														host.AccountSet.splice(i2-num,1);
														num++
														return true;
													}
												})
											})
											//ServiceSet 中的相关数据
											var num=0;
											$(host.ServiceSet).each(function (i2, item2) {
												// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
													if ($.inArray((item2.ProtocolName+'('+item2.Port+')'),pro_value_arr)>=0) {
													host.ServiceSet.splice(i2-num, 1);
													num++;
													// return false;
												}
											})
											flag_n = 1;
											$(obj).parent().parent().parent().remove();
											clear_server();
											service_list_refresh();
											service_account_list_refresh();
										},
										btn2: function (i) {
											layer.close(i);
											flag_n = 1;
											return false;
										}
									});
								}
							})
							
						})
						if(flag_n == 0){
							//ServiceSet 中的相关数据
							var num=0;
							$(host.ServiceSet).each(function (i, item) {
								if ($.inArray((item.ProtocolName+'('+item.Port+')'),pro_value_arr)>=0) {
								// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
									host.ServiceSet.splice(i-num, 1);
									num++;
									// return false;
								}
							})
							flag_n = 1;
							$(obj).parent().parent().parent().remove();
							clear_server();
							service_list_refresh();
							service_account_list_refresh();
						}
					}
				}
				else{
					var flag_n = 0;//防止多个确认窗口重复弹出
					$(host.AccountSet).each(function (i, item) {
						if(flag_n == 1){
							return false;
						}
						$(item.HostServiceSet).each(function (i1, item1) {
							if(flag_n == 1){
								return false;
							}
							// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
							if ($.inArray((item1.ProtocolName+'('+item1.Port+')'),pro_value_arr)>=0) {
								flag_n = 1;
								layer.open({
									type: 1,
									title: "主机管理",
									content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
									btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
									btnAlign: 'c',
									closeBtn: false,
									skin: 'layer-custom',
									area: ['380px', '310px'],
									move: false,
									resize: false,
									btn1: function (i) {
										layer.close(i);
										//删除AccountSet 中的相关数据，并将下方相关账号删除。
										var num=0;
										$(host.AccountSet).each(function (i2, item2) {
											$(item2.HostServiceSet).each(function (i3, item3) {
												if ($.inArray((item3.ProtocolName+'('+item3.Port+')'),pro_value_arr)>=0) {
												// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
													host.AccountSet.splice(i2-num,1);
													num++
													return true;
												}
											})
										})
										//ServiceSet 中的相关数据
										var num=0;
										$(host.ServiceSet).each(function (i2, item2) {
											// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
												if ($.inArray((item2.ProtocolName+'('+item2.Port+')'),pro_value_arr)>=0) {
												host.ServiceSet.splice(i2-num, 1);
												num++;
												// return false;
											}
										})
										flag_n = 1;
										$(obj).parent().parent().parent().remove();
										clear_server();
										service_list_refresh();
										service_account_list_refresh();
									},
									btn2: function (i) {
										layer.close(i);
										flag_n = 1;
										return false;
									}
								});
							}
						})
						
					})
					if(flag_n == 0){
						//ServiceSet 中的相关数据
						var num=0;
						$(host.ServiceSet).each(function (i, item) {
							if ($.inArray((item.ProtocolName+'('+item.Port+')'),pro_value_arr)>=0) {
							// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
								host.ServiceSet.splice(i-num, 1);
								num++;
								// return false;
							}
						})
						flag_n = 1;
						$(obj).parent().parent().parent().remove();
						clear_server();
						service_list_refresh();
						service_account_list_refresh();
					}
				}
			},
			btn2:function(i){
				layer.close(i);
			}
		})
	}
/*
	function _delServer(Name, obj) {
		var pro_value=$(obj).parents('tr').children('td').eq(1).text();
		layer.open({
			type: 1,
			title: "主机",
			content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
			btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
			btnAlign: 'c',
			closeBtn: false,
			skin: 'layer-custom',
			area: ['380px', '310px'],
			move: false,
			resize: false,
			btn1: function (i) {
				layer.close(i);
				var flag_n = 0;//防止多个确认窗口重复弹出
				$(host.AccountSet).each(function (i, item) {
					$(item.HostServiceSet).each(function (i1, item1) {
						if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
						// if (Name == item1.HostServiceName) {
							flag_n = 1;
							layer.open({
								type: 1,
								title: "主机",
								content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
								btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
								btnAlign: 'c',
								closeBtn: false,
								skin: 'layer-custom',
								area: ['380px', '310px'],
								move: false,
								resize: false,
								btn1: function (i) {
									layer.close(i);
									//删除AccountSet 中的相关数据，并将下方相关账号删除。
									$(host.AccountSet).each(function (i, item) {
										$(item.HostServiceSet).each(function (i1, item1) {
											// if (Name == item1.HostServiceName) {
												if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
												$("#service_account_list").find('tr').each(function(i2,item2){
													var name_account = "";
													$.each(AccountData,function(i3,item3){
														if(item3.AccountId == item.HostAccount.AccountId){
															name_account = item3.AccountName;
															return false;
														}
													})
													if(name_account == '*'){
														name_account = "*";
													}else if(name_account == '-'){
														name_account = "-";
													}
													if($(item2).find('td').eq(0).text() == name_account){
														$(item2).remove();
														var AuthId = $(item2).find('.del').attr("onclick").split("'")[1];
														var type_acc = $(item2).find('.del').attr("onclick").split(",")[2].split(')')[0];
														var acc_id = $(item2).find('td').eq(0).attr('id');
														var acc_server = $(item2).find('td').eq(2).text().split(',');
														var acc_server_1 = [];
														if (type_acc == 0) { //创建账号的删除
															$(host.AccountSet).each(function (i, item) {
																var acc_server_1 = [];
																if (acc_id == item.HostAccount.AccountId) {
																	$(item.HostServiceSet).each(function(i1,item1){
																		if($.inArray(item1.ProtocolName+item1.Port,acc_server_1)<0){
																			acc_server_1.push(item1.ProtocolName+item1.Port);
																		}
																	})
																	if(acc_server_1.sort().toString() == acc_server.sort().toString()){
																		host.AccountSet.splice(i, 1);
																		return false;
																	}
																}
															})
														} else { ///编辑账号的删除
															$(host.AccountSet).each(function (i, item) {
																if (AuthId == item.PasswordAuthId) {
																	host.AccountSet.splice(i, 1);
																	return false;
																}
															})
														}
														clear_account();
													}
												})
											}
										})
									})
									//ServiceSet 中的相关数据
									var num=0;
									$(host.ServiceSet).each(function (i, item) {
										// if (Name == item.HostServiceName) {
										if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
											host.ServiceSet.splice(i-num, 1);
											num++;
											// return false;
										}
									})
									flag_n = 1;
									$(obj).parent().parent().parent().remove();
									clear_server();
								},
								btn2: function (i) {
									layer.close(i);
									flag_n = 1;
									return false;
								}
							});
						}
						if(flag_n == 1){
							return false;
						}
					})
					if(flag_n == 1){
						return false;
					}
				})
				if(flag_n == 0){
					//ServiceSet 中的相关数据
					var num=0;
					$(host.ServiceSet).each(function (i, item) {
						if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
							host.ServiceSet.splice(i-num, 1);
							num++;
							// return false;
						}
					})
					flag_n = 1;
					$(obj).parent().parent().parent().remove();
					clear_server();
				}
			},
			btn2: function (i) {
				layer.close(i);
			}
		});
	}

	*/


	//添加账号
	//账号 浮层
	// function _getDialog2(type, index) {
	function _getDialog2(type,obj) {
		$('a.btn').blur();
		if(type == "edit"){
			accountID = $(obj).parents('tr').index();
		}else{
			accountID = -1;
		}
		var acc_id = $(obj).parent().parent().siblings().eq(0).attr('id');//账号ID
		var acc_server = $(obj).parent().parent().siblings().eq(2).text().split(',');//服务名字
		var index;
		$(host.AccountSet).each(function (i, item) {
			var acc_server_1 = [];
			if (acc_id == item.HostAccount.AccountId) {
				$(item.HostServiceSet).each(function(i1,item1){
					// acc_server_1.push(item1.HostServiceName);
					if($.inArray(item1.ProtocolName+item1.Port,acc_server_1)<0){
                                        	acc_server_1.push(item1.ProtocolName+item1.Port);
                                	}
					//acc_server_1.push(item1.ProtocolName+item1.Port);
				})
				if(acc_server_1.sort().toString() == acc_server.sort().toString()){
					index = i;
					return false;
				}else{
					index = 0;
				}
			}
		})
		if ($('#service_list>tr').length == 0) {
			_alert(2, "主机", '请先添加服务');
			return false;
		}

		clear_account();
		$("#server_list").empty();
		var server_list_pro_port=new Array();
		var server_conn=new Array();
		$(host.ServiceSet).each(function(i,item){
			if($.inArray(item.ProtocolName+'-'+item.Port,server_list_pro_port)<0){
				server_list_pro_port.push(item.ProtocolName+'-'+item.Port);
				server_conn.push([]);
				if(item.ConnParamName!='' && item!=null){
					server_conn[$.inArray(item.ProtocolName+'-'+item.Port,server_list_pro_port)].push(item.ConnParamName);
				}
				$("#server_list").append("<div class=\"as\"><label><input type=\"checkbox\" id=\"" + item.HostServiceId + "\" proid=\""+item.ProtocolId+"\" proto=\""+item.ProtocolName+"\" port=\""+item.Port+"\" paramid=\""+item.ConnParamId+"\" param=\""+item.ConnParamName+"\" value=\"" + item.HostServiceName + "\" name=\"" + item.HostServiceName + "\" class=\"form-checkbox\" >" + item.HostServiceName +"("+ item.ProtocolName +")"+ "</label></div>");
			}else{
				if(item.ConnParamName!='' && item!=null){
                                        server_conn[$.inArray(item.ProtocolName+'-'+item.Port,server_list_pro_port)].push(item.ConnParamName);
                                }
			}
		})
		var $server_list_as=$('#server_list').children('.as');
        	$(server_conn).each(function(i,item){
                	$server_list_as.eq(i).children('label').attr('title',item);
        	});
		$('#server_list').children().find('input[type=checkbox]').on('ifChecked', function(event){
			get_fromacc();
		}).on('ifUnchecked', function(event){
			get_fromacc();
		});

		$('#server_list .form-checkbox').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
		var $dialogCont = $("#scDCTab2").show();
		if (type == 'edit') {
			title = '账号';
		} else {
			title = '账号';
		}
		var d = dialog({
			title: title,
			content: $dialogCont,
			id: "scDCTab2",
			width: "850px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		//绑定服务事件
		$('#server_list input[type=checkbox]').on('ifChecked',function(){
			_checkServerStatus();
		}).on('ifUnchecked',function(){
			_checkServerStatus();
		});
		if (type == 'edit') {
			_editAccount(index);
		}		
		$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
			d.close().remove();
		});
		$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
			if (_addAcount(type) == false) return false;
			d.close().remove();
		})
	}

	var SSHKey_flag = false;
	function _checkServerStatus(){
		SSHKey_flag = false;
		var other_flag = false;
		$.each($("#server_list").find('input[type=checkbox]'),function(i,item){
			if($(item).prop('checked') == true){
				if($(item).attr('proto') == "SSH" || $(item).attr('proto') == "SFTP"){
					SSHKey_flag = true;
				}else{
					other_flag = true;
				}
			}
		})
		if(other_flag == true){
			SSHKey_flag = false;
		}
		if(SSHKey_flag == true){
			$("#authType").removeAttr('disabled');
			$("#authType").val($("#authType").val()).trigger('change');
			// $("#item_SSHKey").show();
			// $("#item_pwd").hide();
			// $("#item_pwd_con").hide();
			// $("#item_pwd_con").css("width","30%");
			// $("#item_SSHKey").css("width","80%");
		}else{
			$("#authType").val(0).trigger('change');
			$("#authType").attr('disabled','true');
			// $("#item_pwd").show();
			// $("#item_pwd_con").show();
			// $("#item_SSHKey").hide();
			// $("#item_pwd_con").css("width","40%");
			// $("#item_SSHKey").css("width","85%");
		}
	}

	function auth_change(){
		if($("#authType").val() == 0){
			$("#item_pwd").show();
			$("#item_pwd_con").show();
			$("#item_SSHKey").hide();
			$("#item_pwd_con").css("width","29%");
			$("#item_SSHKey").css("width","66%");
		}else{
			$("#item_SSHKey").show();
			$("#item_pwd").hide();
			$("#item_pwd_con").hide();
			$("#item_pwd_con").css("width","29%");
			$("#item_SSHKey").css("width","66%");
		}
	}

	function init_account() {
		AccountSet ={
				"PasswordAuthId": 0,
				"Password": null,
				"PasswordType": 0,
				"IsClearText": true,
				"HostServiceSet": [
				],
				"HostAccount": {
					"AccountId": 3,
					"IsSuperAcct": false,
					"IsSameUser": false,
					"FromAccountId": null,
					"AcctSwitchCmd": null,
					"SwitchPasswdPrompt": null
				}
			}
	}
	var AccountIndex = -1;
	function _addAcount(type) {
		$('.'+$('.xSelect_AccList .xSelect-show').data('id')).hide();
		if (type == 'add') init_account();
		//AccountSet.PasswordAuthId = 0;
		host_id = host.HostId;
		//获取 主机、服务
		AccountSet.HostServiceSet = [];
		var server_str = "";
		$("#server_list input:checked").each(function () {
			var ProtocolName=$(this).attr("proto");
			var Protocolid=$(this).attr("proid");
			var Port=$(this).attr("port");
			$(host.ServiceSet).each(function(i,item){
				if(item.ProtocolName==ProtocolName && item.ProtocolId==Protocolid && item.Port==Port){
					tmp = {"HostId": host_id,"HostServiceId": item.HostServiceId,"HostServiceName": item.HostServiceName,"ProtocolName": item.ProtocolName,"ProtocolId": item.ProtocolId,"Port": item.Port,"ConnParamId": item.ConnParamId,"ConnParamName": item.ConnParamName};
					AccountSet.HostServiceSet.push(JSON.parse(JSON.stringify(tmp)));		
				}
			});
			// tmp = "{\"HostId\": " + host_id + ",\"HostServiceId\": " + $(this).attr("id") + ",\"HostServiceName\": \"" + $(this).val() + "\",\"ProtocolId\":\""+$(this).attr("proid")+"\",\"Port\":\""+$(this).attr("Port")+"\",\"ConnParamId\":\""+$(this).attr("paramid")+"\",\"ProtocolName\":\""+$(this).attr("proto")+"\",\"ConnParamName\":\""+$(this).attr("param")+"\"}";
			// tmp = {"HostId": host_id,"HostServiceId": item.HostServiceId,"HostServiceName": item.HostServiceName,"ProtocolName": item.ProtocolName,"ProtocolId": item.ProtocolId,"Port": item.Port,"ConnParamId": item.ConnParamId,"ConnParamName": item.ConnParamName};
			server_str = server_str +$(this).attr('proto')+'-'+$(this).attr('port')+",";
			// AccountSet.HostServiceSet.push(JSON.parse(tmp));
		})
		server_str = server_str.substr(0, server_str.length - 1);
		if (server_str == "") {
			$('#autoView').hide();
			$('.g-tsel').removeClass('on');			
			_alert(2, title, '请选择服务');
			return false;
		}
		//账号
		AccountId = $("#AccountName").data('value');
		AccountName= $("#AccountName").find('span').text();
		if (AccountId == "0" || AccountId == undefined) {			
			_alert(2, title, "请选择账号");
			return false;
		}
		FromAccountId = $("#FromAccount_acc").val();

		//密码(密钥)
		if($("#SSHkey_s").is(":visible")){
			AccountSet.Password = "";
			AccountSet.PasswordType = 3;
			AccountSet.SshKeyId = $("#SSHkey_s").data('value');
			if(AccountSet.SshKeyId == -1 || AccountSet.SshKeyId == undefined){
				AccountSet.SshKeyId = null;
			}
			AccountSet.KeyName = $("#SSHkey_s").find('span').text();
			if(AccountSet.KeyName == '请选择'){
				AccountSet.KeyName = "";
			}			
			AccountSet.IsClearText = false;
		}else if ($("#if_emptypwd").prop("checked") == true) {
			AccountSet.Password = "";
			AccountSet.PasswordType = 2;
			AccountSet.IsClearText = false;
			AccountSet.SshKeyId = null;
			AccountSet.KeyName = "";
		} else {
			if ($("#password1").val() != $("#password2").val()) {
				$('#autoView').hide();
				$('.g-tsel').removeClass('on');
				_alert(1, title, "两次密码不一致", $("#password1"));
				return false;
			}
			if ($("#password1").val() == '') {
				AccountSet.Password = $("#password1").val();
				AccountSet.PasswordType = 0;
				AccountSet.IsClearText = false;
			} else {
				if (AccountSet.Password == $("#password1").val() && AccountSet.PasswordAuthId != 0) {
					AccountSet.IsClearText = false;
				} else {
					AccountSet.IsClearText = true;
					if($("#password1").val().length > 64){
						_alert(1, title, "密码不能超过系统限定64位", $("#password1"));
						return false;
					}
				}
				AccountSet.Password = $("#password1").val();
				AccountSet.PasswordType = 1;
			}
			AccountSet.SshKeyId = null;
			AccountSet.KeyName = "";
		}
		//判断 是否存在相同的服务 相同的账号
		var check_same_account = [];
		$(host.AccountSet).each(function(i,item){
			account_tmp = item.HostAccount.AccountId;
			server_tmp = item.HostServiceSet;
			var ProtocolName_Port=[];
			$(server_tmp).each(function(i1,item1){
				if($.inArray(item1.ProtocolName+item1.Port,ProtocolName_Port)<0){
					check_same_account.push(account_tmp + ":" + item1.ProtocolName+item1.Port);
					ProtocolName_Port.push(item1.ProtocolName+item1.Port);
				}
			})
		})
		
		var server_listtmp = server_str.split(',');
		if(type == 'edit'){
			$(server_listtmp).each(function(i,item){
				item=item.replace('-','');
				index = check_same_account.indexOf(AccountId + ":" + item);
				if(index >=0 )
					check_same_account.splice(index,1);
			})
		}
		var k = false;
		$(server_listtmp).each(function(i,item){
			item=item.replace('-','');
			if(check_same_account.indexOf(AccountId + ":" + item) >=0){
				k = true;
				return false;
			}
		})
		if(k){
			$('#autoView').hide();
			$('.g-tsel').removeClass('on');
			_alert(1,title,'相同的服务和账号已存在');
			return false;
		}
		AccountSet.HostAccount.AccountId = parseInt(AccountId);
		AccountSet.HostAccount.AccountName = AccountName;
		AccountSet.HostAccount.IsSuperAcct = $("#IsSuperAcct").prop("checked");
		AccountSet.HostAccount.IsSameUser = $("#IsSameUser").prop("checked");
		if($('#FromAccount_acc').val() == "" || $('#FromAccount_acc').val() == 0){
			FromAccount_acc = null;
		}else{
			FromAccount_acc = $('#FromAccount_acc').val();
		}
		AccountSet.HostAccount.FromAccountId = FromAccount_acc;
		AccountSet.HostAccount.AcctSwitchCmd = $("#AcctSwitchCmd_account").val();
		AccountSet.HostAccount.SwitchPasswdPrompt = $("#SwitchPasswdPrompt_account").val();
		sty = "";
		if(AccountSet.HostAccount.IsSuperAcct == true){
			sty = 'color:red';
		}

		var float_str = "<p>切换账号：" + $("#FromAccount_acc").children('option:selected').text() + "</p>" +
			"<p>切换命令：" + $("#AcctSwitchCmd_account").val() + "</p>" +
			"<p>切换密码提示：" + $("#SwitchPasswdPrompt_account").val() + "</p>";
		var flag_ser = 0;
		var ser_array = [];
		$("#server_list input:checked").each(function () {
			ser_array.push($(this).attr('proto'));
		})
		$.each(ser_array,function(i,item){
			$.each(SUP_PROTOCOL,function(i2,item2){
				if(item == item2){
					flag_ser = 1;
					return false;
				}
			})
		})
		var psdType;
		if(AccountSet.Password == "" && AccountSet.PasswordType != 2){
			psdType = "未保存";
			flag_ser = 0;
		}else{
			psdType = "已保存";
			flag_ser = 1;
		}
		var IsSameUser_value=$('#IsSameUser').prop('checked');
		if(flag_ser == 1){
			if (type == 'add') {
				//导入到列表中
				if(IsSameUser_value){
					host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
					// $("#service_account_list").append("<tr id=\"acc_" + host.AccountSet.length + "\"><td style=\""+sty+"\" id = \""+AccountId+"\">" + $("#AccountName").find('span').text() + "</td><td>" + psdType + "</td><td>" + server_str + "</td><td>" + $("#authType option:selected").text() + "</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog2('edit',this)\"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" onclick=\"_delAccount('" + (host.AccountSet.length - 1) + "',this,0)\"></a><a href=\"javascript:;\" class=\"icon2\" onclick=\"_getDialog_connectTest('"+AccountId+"','"+ser_array+"');\" ></a></div><div class=\"tab-moreinfo\">" + float_str + "</div></td></td></tr>");
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;
							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
			}
			else {
				if(IsSameUser_value){
					host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					pro_value=HostServiceSet_arr[0].ProtocolName+'-'+HostServiceSet_arr[0].Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
						used_pro.unshift(pro_value);
					}
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;
							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
				
			}
		}else if(flag_ser == 0){
			if (type == 'add') {
				if(IsSameUser_value){
					host.AccountSet.unshift(AccountSet);
					//导入到列表中
					// $("#service_account_list").append("<tr id=\"acc_" + host.AccountSet.length + "\"><td style=\""+sty+"\" id = \""+AccountId+"\">" + $("#AccountName").find('span').text() + "</td><td>" + psdType + "</td><td>" + server_str + "</td><td>" + $("#authType option:selected").text() + "</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog2('edit',this)\"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" onclick=\"_delAccount('" + (host.AccountSet.length - 1) + "',this,0)\"></a><a href=\"javascript:;\" class=\"icon2 disabled\"></a></div><div class=\"tab-moreinfo\">" + float_str + "</div></td></td></tr>");
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;

							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
			}
			else {
				if(IsSameUser_value){
					host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
					// tr_lenght = AccountIndex + 1;
					// $("#acc_" + tr_lenght).html("<td style=\""+sty+"\" id = \""+AccountId+"\">" + $("#AccountName").find('span').text() + "</td><td>" + psdType + "</td><td>" + server_str + "</td><td>" + $("#authType option:selected").text() + "</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog2('edit',this)\"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" onclick=\"_delAccount('" + AccountIndex + "',this,1)\"></a><a href=\"javascript:;\" class=\"icon2 disabled\"></a></div><div class=\"tab-moreinfo\">" + float_str + "</div></td></td>");
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					pro_value=HostServiceSet_arr[0].ProtocolName+'-'+HostServiceSet_arr[0].Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
						used_pro.unshift(pro_value);
					}
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;
							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
				
			}
		}
		service_account_list_refresh();
		//
		tabArr1();
		//$("#add_btn_account").show();
		//$("#mod_btn_account").hide();
		clear_account();
	}
	function clear_account() {
		//AccountIndex = -1;
		$("#server_list input[type=checkbox]").each(function () {
			$(this).iCheck("uncheck");
		})

		bind_Acc_xSelect();
		$("#FromAccount_acc").val("0").trigger('change');
		$("#password1").val("");
		$("#password2").val("");
		$("#password1").prop("disabled", false);
		$("#password2").prop("disabled", false);
		$("#if_emptypwd").iCheck('uncheck');
		$("#if_emptypwd").iCheck('enable');
		$("#IsSuperAcct").iCheck("uncheck");
		$("#IsSameUser").iCheck("uncheck");
		//$("#AcctSwitchCmd_account").val("");
		//$("#SwitchPasswdPrompt_account").val("");
		init_account();
		$("#add_btn_account").show();
		$("#mod_btn_account").hide();
		$("#AcctSwitchCmd_account").val(_SwitchCmd);
		$("#SwitchPasswdPrompt_account").val(_SwitchPasswdPrompt);
		$('#AccountName').find('span').text('请选择');
		$('#AccountName').data('value',"0");
	}
	function get_fromacc(){
		var ser_array = [];
		$("#server_list input:checked").each(function () {
			ser_array.push($(this).attr('proto'));
		})
		$("#FromAccount_acc").empty().append("<option value=\"0\">请选择</option>");
		$.each(host.AccountSet,function(i,item){
			var ser_arr = [];
			$.each(item.HostServiceSet,function(i1,item1){
				ser_arr.push(item1.ProtocolName);
			})
			if(ser_array.sort().toString().indexOf(ser_arr.sort().toString()) != -1){
				var accountName;
				$.each(AccountData,function(i3,item3){
					if(item3.AccountId == item.HostAccount.AccountId){
						accountName = item3.Name;
						if(accountName == "*"){
							accountName = "*";
						}else if(accountName == "-"){
							accountName = "-";
						}
						return false;
					}
				})

				if($("#AccountName").find('span').text() != accountName){
					$("#FromAccount_acc").append('<option value="'+item.HostAccount.AccountId+'" title="'+accountName+'">'+accountName+'</option>');
				}
			}
		});
		$("#FromAccount_acc").val('0').trigger('change');
	}
	//回显账号信息
	function _editAccount(index) {
		//$("#add_btn_account").hide();
		//$("#mod_btn_account").show();
		clear_account();

		$(host.AccountSet).each(function (i, item) {
			if (index == i) {
				AccountIndex = i;
				// AccountSet = JSON.parse(JSON.stringify(item));
				//绑定服务
				HostServiceSet = item.HostServiceSet;
				$(HostServiceSet).each(function (i1, item1) {
					$("#server_list input").each(function () {
						// if ($(this).attr("name") == item1.HostServiceName) {
							if($(this).attr("proid") == item1.ProtocolId && $(this).attr("port") == item1.Port){
							$(this).iCheck("check");
						}
					})
				})
				//绑定账号 密码
				HostAccount = item.HostAccount;
				$.each(AccountData,function(i,item){
					if(item.AccountId == HostAccount.AccountId){
						AccountName = item.AccountName;
					}
				})
				AccountId = HostAccount.AccountId;
				if(AccountName == "*"){
					AccountName = "*";
				}
				if(AccountName == "-"){
					AccountName = "-";
				}
				$("#AccountName").find('span').text(AccountName);
				$("#AccountName").data('value',AccountId);

				if ($("#AccountName").children().find('span').text() == "*") {
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",true);
					$("#password2").prop("disabled",true);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('disable');
					$("#authType").prop("disabled",false);
				}else if( $("#AccountName").children().find('span').text() == "#"){
					$("#authType").prop("disabled",true);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('disable');
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",true);
					$("#password2").prop("disabled",true);
				}else{
					$("#authType").prop("disabled",false);
					PasswordType = item.PasswordType;
					if(PasswordType == 2 ){
						$("#password1").val("");
						$("#password2").val("");
						$("#password1").prop("disabled",true);
						$("#password2").prop("disabled",true);
						$('#if_emptypwd').iCheck('check');
					}else{
						$("#password1").prop("disabled",false);
						$("#password2").prop("disabled",false)
						$("#password1").val(item.Password);
						$("#password2").val(item.Password);
					}
				}
				//绑定其他
				if(item.PasswordType == 3){//密钥
					$("#authType").val(1).trigger('change');
					if(item.KeyName == "" || item.KeyName == null){
						$("#SSHkey_s").find('span').text('请选择');
					}else{
						$("#SSHkey_s").find('span').text(item.KeyName);						
					}
					if(item.SshKeyId == -1 || item.SshKeyId == undefined || item.SshKeyId == null){
						$("#SSHkey_s").data('value',-1);						
					}else{
						$("#SSHkey_s").data('value',item.SshKeyId);	
					}

				}
				if (HostAccount.IsSuperAcct == true) $("#IsSuperAcct").iCheck('check');
				else $("#IsSuperAcct").iCheck('uncheck');
				if (HostAccount.IsSameUser == true) $("#IsSameUser").iCheck('check');
				else $("#IsSameUser").iCheck('uncheck');
				if(HostAccount.FromAccountId == null)
					$("#FromAccount_acc").val('0').trigger('change');
				else $("#FromAccount_acc").val(HostAccount.FromAccountId).trigger('change');
				// HostAccount = item.HostAccount;

				$("#AcctSwitchCmd_account").val(HostAccount.AcctSwitchCmd);
				$("#SwitchPasswdPrompt_account").val(HostAccount.SwitchPasswdPrompt);
				get_fromacc();
			}
		})	
	}
	function _delAccount(AuthId, obj, flag) {
		var acc_id = $(obj).parent().parent().siblings().eq(0).attr('id');
		var acc_server = $(obj).parent().parent().siblings().eq(2).text().split(',');
		var acc_server_1 = [];
		layer.open({
			type: 1,
			title: "主机",
			content: '<div class="layer-alert"><i class="alert warning"></i>确定删除</div>',
			btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
			btnAlign: 'c',
			closeBtn: false,
			skin: 'layer-custom',
			area: ['380px', '310px'],
			move: false,
			resize: false,
			btn1: function (i) {
				layer.close(i);
				if (flag == 0) { //创建账号的删除
					$(host.AccountSet).each(function (i, item) {
						var acc_server_1 = [];
						if (acc_id == item.HostAccount.AccountId) {
							$(item.HostServiceSet).each(function(i1,item1){
								// acc_server_1.push(item1.HostServiceName)
								if($.inArray(item1.ProtocolName+item1.Port,acc_server_1)<0){
									acc_server_1.push(item1.ProtocolName+item1.Port);
								}
								//acc_server_1.push(item1.ProtocolName+item1.Port);
							})
							if(acc_server_1.sort().toString() == acc_server.sort().toString()){
								host.AccountSet.splice(i, 1);
								return false;
							}
						}
					})
				} else { ///编辑账号的删除
					$(host.AccountSet).each(function (i, item) {
						if (AuthId == item.PasswordAuthId) {
							host.AccountSet.splice(i, 1);
							return false;
						}
					})
				}
				$(obj).parent().parent().parent().remove();
				clear_account();
			}, btn2: function (i) {
				layer.close(i);
			}
		})
	}

	function next(type) {
		/*
		"HostId": 0,
		"HostName": "",
		"HostIP": "",
		"Description": null,
		"AccessRate": 1,   
		"EnableLoginLimit": false,  
		"Status": 0,
		"DeviceTypeId": 0,
		*/
		if (type == 2) {
			var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

			var namecheck = /^[_\-.\n\w\u4e00-\u9fa5]*$/;
			var HostIP = $("#HostIP").val();
			if (HostIP == "") {
				_alert(2, "主机", "请输入主机IP", $('#HostIP'));
				return false;
			};
			if (!hostIPReg.test(HostIP)) {
				_alert(1, "主机", "主机IP格式不正确", $('#HostIP'));
				return false;
			};

			if (HostIP == "0.0.0.0") {
				_alert(1, "主机", "请不要输入0.0.0.0的IP", $('#HostIP'));
				return false;
			};
			if (HostIP == "255.255.255.255") {
				_alert(1, "主机", "请不要输入255.255.255.255的IP", $('#HostIP'));
				return false;
			};
			var HostName = $("#HostName").val().replace(/(^\s*)|(\s*$)/g, "");
			if (HostName == "") {
				_alert(2, "主机", "请输入主机名", $('#HostName'));
				return false;
			}
			var len = 0;
			for (var i = 0; i < HostName.length; i++) {
				if (HostName.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null) //全角 
					len += 2;
				else
					len += 1;
			}
			if (len >= 128) {
				_alert(1, "主机", "输入的主机名过长", $('#HostName'));
				return false;
			}
			if (!namecheck.test(HostName)) {
				_alert(1, "主机", '主机名格式不正确', $('#HostName'));
				return false;
			}
			if ($("#Description").val().length > 255) {
				_alert(1, "主机", '描述内容过长', $('#Description'));
				return false;
			}
			var DeviceTypeId = $("#host_type").val();
			if (DeviceTypeId == "") {
				_alert(2, "主机", "请选择设备类型");
				return false;
			}

			var AccessRate = parseInt($('input:radio[name="speed"]:checked').val());
			Description = $("#Description").val();
			//AccessRate = $("#AccessRate").children("option:selected").text();
			EnableLoginLimit = $("#EnableLoginLimit").is(":checked");
			//if($("#EnableLoginLimit").prop("checked") == true)EnableLoginLimit = true;
			//else EnableLoginLimit = false;

			if ($("#Enabled").prop("checked") == true) Status = 0;
			else Status = 1;


			host.HostName = HostName;
			host.HostIP = HostIP;
			host.Description = Description;
			host.AccessRate = AccessRate;
			host.EnableLoginLimit = EnableLoginLimit;
			host.Status = Status;
			host.DeviceTypeId = parseInt(DeviceTypeId);
			//清空 账号信息
			clear_account();
			AccountIndex = -1;

		}
		else if (type == 3) {//绑定获取当前所有的服务
			if (host.ServiceSet.length == 0) {
				_alert(2, "主机", '请添加服务');
				return false;
			}
			// 清除 服务信息
			clear_server();
			ServerIndex = -1;
			$("#server_list").empty();
			$(host.ServiceSet).each(function (i, item) {
				$("#server_list").append("<div class=\"as\"><label><input type=\"checkbox\" id=\"" + item.HostServiceId + "\" value=\"" + item.HostServiceName + "\" name=\"" + item.HostServiceName + "\" class=\"form-checkbox\" >" + item.HostServiceName + "</label></div>");
			})
		}
		$("#step" + type).show();
		$("#step" + (type + 1)).hide();
		$("#step" + (type - 1)).hide();
		$('#server_list .form-checkbox').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
	}
	function savedata() {
		//基本信息
		//var hostIPReg = /^((?:(?:2[0-4][0-9]\.)|(?:25[0-5]\.)|(?:1[0-9][0-9]\.)|(?:[1-9][0-9]\.)|(?:[0-9]\.)){3}(?:(?:2[0-5][0-5])|(?:25[0-5])|(?:1[0-9][0-9])|(?:[1-9][0-9])|(?:[0-9]))) |([a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?)$/;
		//
		var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

		var namecheck = /^[_\-.\n\w\u4e00-\u9fa5]*$/;
		var HostIP = $("#HostIP").val();
		if (HostIP == "") {
			_alert(2, "主机", "请输入主机IP", $('#HostIP'));
			return false;
		};
		if (!hostIPReg.test(HostIP)) {
			_alert(1, "主机", "主机IP格式不正确", $('#HostIP'));
			return false;
		};

		if (HostIP == "0.0.0.0") {
			_alert(1, "主机", "请不要输入0.0.0.0的IP", $('#HostIP'));
			return false;
		};
		if (HostIP == "255.255.255.255") {
			_alert(1, "主机", "请不要输入255.255.255.255的IP", $('#HostIP'));
			return false;
		};
		var HostName = $("#HostName").val().replace(/(^\s*)|(\s*$)/g, "");
		if (HostName == "") {
			_alert(2, "主机", "请输入主机名", $('#HostName'));
			return false;
		}
		var len = 0;
		for (var i = 0; i < HostName.length; i++) {
			if (HostName.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null) //全角 
				len += 2;
			else
				len += 1;
		}
		if (len >= 128) {
			_alert(1, "主机", "输入的主机名过长", $('#HostName'));
			return false;
		}
		if (!namecheck.test(HostName)) {
			_alert(1, "主机", '主机名格式不正确', $('#HostName'));
			return false;
		}

		var DeviceTypeId = $("#host_type").val();
		if (DeviceTypeId == "") {
			_alert(2, "主机", "请选择设备类型");
			return false;
		}

		if ($("#Description").val().length > 255) {
			_alert(1, "主机", '主机描述内容过长', $('#Description'));
			return false;
		}


		var AccessRate = parseInt($('input:radio[name="speed"]:checked').val());
		Description = $("#Description").val();
		//AccessRate = $("#AccessRate").children("option:selected").text();
		//if($("#EnableLoginLimit").prop("checked") == true)EnableLoginLimit = true;
		//else EnableLoginLimit = false;
		EnableLoginLimit = $("#EnableLoginLimit").is(":checked");

		if ($("#Enabled").prop("checked") == true) Status = 0;
		else Status = 1;


		host.HostName = HostName;
		host.HostIP = HostIP;
		host.Description = Description;
		host.AccessRate = AccessRate;
		host.EnableLoginLimit = EnableLoginLimit;
		host.Status = Status;
		host.DeviceTypeId = parseInt(DeviceTypeId);

		// //服务信息
		// if (host.ServiceSet.length == 0) {
		// 	_alert(2, "主机", '请添加服务');
		// 	return false;
		// }
		// //账号
		// if (host.AccountSet.length == 0) {
		// 	_alert(2, "主机", '请添加账号');
		// 	return false;
		// }

		var HGroupSet = [];

		$('#hostTree li').each(function () {
			if ($(this).children('input').prop('checked') == true) {
				HGId = $(this).children('input').attr('id').split('-')[1];
				HGroupSet.push(JSON.parse('{"HGId":' + HGId + '}'));
			}
		})
		if(HGroupSet.length == 0){
			host.HGroupSet = [{"HGId":1}];
		}else{
			host.HGroupSet = HGroupSet;
		}
		//新建的主机加入访问授权
		var AccessAuth = {
			"HGId": 1,
			"HostId": 0, 
			"AccessAuthSet": [
			]
		}
		if(host.HostId >0) title="修改主机";
		else {
			title="创建主机";
			$.each(auth_arry,function(i,item){
				if (item != '-1'){
					var auth = '{"AccessAuthId":'+item+'}';
					auth = JSON.parse(auth);
					AccessAuth.AccessAuthSet.push(auth);
				}
			});
		}
		
		
		//host.HGroupSet = HGroupSet;
		var msstr = aceg(JSON.stringify(host),$("input[name=se]").val());
		$.ajax({
			url: '/bhost/save_data_host',
			type: "post",
			async: false,
			cache: false,
			data: { a0: $("input[name=se]").val(), a1: JSON.stringify(host),a2:JSON.stringify(AccessAuth),a10:"运维管理>主机",m1:msstr},
			success: function (Result) {
				data = JSON.parse(Result);
				if (data.Result) {
					layer.open({
						type: 1,
						title: "主机",
						content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
						btn: '确&nbsp;&nbsp;定',
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						btn1: function (i) {
							layer.close(i);
							document.frm.tasktype.value = 3;
							document.frm.se.value = window.parent.document.frm.se.value;
							document.frm.us.value = usercode;
							document.frm.action = '/bhost/index';
							document.frm.i10.value = 1;
							document.frm.submit();
						}
					});

				}
				else {
					_alert(1, "主机",  data.ErrMsg);
				}
			}
		})
	}
	//获取设备类型
	var device_list = []
	var def_server_list = [];
	function get_DeviceType() {
		$.ajax({
			url: '/bhost/get_DeviceType',
			type: "post",
			async: false,
			cache: false,
			data: { a0: $("input[name=se]").val() },
			success: function (Result) {
				data = JSON.parse(Result);
				device_list = data.data;
				$("#host_type").empty();
				$("#host_type").append("<option value='' _icon=\"\" _SwitchCmd=\"\" _SwitchPasswdPrompt=\"\" >请选择</option>");
				$.each(device_list, function (i, item) {
					if (item.Status == 1) return true;
					$("#host_type").append("<option _icon='" + item.DeviceTypeIcon + "' value=\"" + item.DeviceTypeId + "\"  _SwitchCmd='" + HTMLEncode(item.AcctSwitchCmd) + "' _SwitchPasswdPrompt='" + HTMLEncode(item.SwitchPasswdPrompt) + "'>" + item.DeviceTypeName + "</option>");
				})
			}
		})
	}
	function back() {
		document.frm.tasktype.value = 3;
		document.frm.se.value = window.parent.document.frm.se.value;
		document.frm.us.value = usercode;
		document.frm.action = '/bhost/index';
		document.frm.i10.value = 1;
		document.frm.submit();
	}

	//访问授权
	var auth_data; 
	var auth_tmp = [];
	var auth_data_all = [];
	var auth_arry=['-1'];
	function auth_select(obj){
		var t = $(obj).children('option:selected').val();
		if (auth_arry.indexOf(t) === -1 && t != undefined){
			auth_arry.splice(0,1,t);
		}
		if ($(obj).children('option').length == 2 && t != '-1'){
			$(obj).parent().children('i.add').click();

			$(obj).parent().hide();

		}
	}
	function _addAuth(obj){
		var add = 0;
		var name2 = $(obj).parent().children('select').children('option:selected').val();
		if (name2 == undefined){
			$(obj).parent().children('select').val('-1').trigger('change');
			return false;
		}
		var t = $(obj).parent().children('select').children('option[value='+name2+']').text();
		if (name2 == -1){
			_alert(2, "主机","请选择访问授权");
			return;
		}
		auth_arry.splice(0,0,'-1');
		auth_data_all.splice($.inArray(parseInt(name2), auth_data_all), 1);
		var $c = $(obj).parent();
		// $c.children('select').select2('destroy');
		var d = $('select>option:first',$c).val();
		var $s = $('<li class="item" id="'+name2+'"style="width: 32%;float: left;margin-left: -19px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:200px;" disabled="true"><i class="ctrl del" onclick="_delAuth(this)"></i></li>');
		$c.children('select').val(d);
		$c.children('select').find('option[value='+name2+']').remove();

		$c.after($s);
		// $c.children('select').select2({minimumResultsForSearch: -1});
		auth_tmp=[];
		$("#select_a>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp.push(v_tmp);
		});
	}
	function _delAuth(obj){
		var $c = $(obj).parent();
		var id = $c.attr('id');
		var $p = $("#an");
		var data, max;
		var min = 0;
		max = auth_data_all.length - 1;
		data = auth_data_all;

		var t = $(obj).siblings('input').val();
		$c.remove();
		$("#an").parent().show();
		auth_arry.splice($.inArray(id,auth_arry),1);

		if (max < 0){
			var index_1 = -1;
		}else{
			var index_1 = search_i(min, max, parseInt(id), data);
		}
		index_1 = parseInt(index_1);
		if (index_1 == -1) {
			index_1 = max;
			$p.append('<option value="' + id + '">' + t + '</option>');
		} else if (index_1 == -2) {
			index_1 = 0;
			$p.children('option').eq(0).after('<option value="' + id + '">' + t + '</option>');
		} else {
			$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '">' + t + '</option>');
		}
		auth_data_all.splice(index_1, 0, parseInt(id));

		auth_tmp=[];
		$("#select_a>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp.push(v_tmp);
		});
	}
	function _del_frame(obj,data,arry){

		$(obj).children('select').children('option').remove();
		$(obj).children('select').append('<option value=\"-1\">请选择</option>');
		if (data[0].AccessAuthId != undefined){
			$.each(data,function(i1,item1){
				if(item1.AuthMode == 1) //只有 访问授权是对象指定的 才可以加
					$(obj).children('select').append("<option value="+item1.AccessAuthId+">"+item1.AccessAuthName+"</option>");
			});
		}
		$(obj).children('select').val(arry[0]).trigger('change');
	}
	function _get_an(){
		$('#select_a').empty().html('<div class="item" style="width: 32%;float: left;margin-left: -19px;"><select class="filter-select" name="an" id="an" style="width:232px;" tabindex="-1" aria-hidden="false" onchange="auth_select(this)"></select><i class="ctrl add" onclick="_addAuth(this)"></i></div>');
		$.ajax({
			url:"/bhost/get_access_way_x",
			type:"POST",
			async: true,
			data:{a0:$("input[name=se]").val()},
			success:function(result){
				var result = JSON.parse(result);
				auth_data = result;
				if(result){
					data = result.data;
					$("#an").empty().append('<option value=\"-1\" selected>请选择</option>');
					
					$.each(auth_data.data,function(i,item){
						if(item.AuthMode == 1){ //只有 访问授权是对象指定的 才可以加
							$("#an").append('<option value="'+item.AccessAuthId+'" title="'+item.UserCode+'">'+item.AccessAuthName+'</option>');
							auth_data_all.push(item.AccessAuthId);
						}
					})
				}else{
					_alert(1, "主机",data.ErrMsg);
				}
			}
			
		})
		$('#select_a .filter-select').select2();
	}

	
</script>

<script>
	var Data = [];
	$.ajax({
		url: "/bhost/get_h_Dir",
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(), a1: 0, a2: 0,t0:12 },
		success: function (result) {
			var result = JSON.parse(result);
			Data = result.data.HGroup;
		}
	})
	$(function () {
		_initList_hg();
	});

	function g_tsel(obj){
		var this_id=$(obj).attr('id');
		var this_class=$(obj).attr('class');
		if(this_id=='g-tsel_connparamname' && this_class=='g-tsel'){
			$('#ConnParamName').focus().select();
			_autoView(obj,0,0);
		}else if (this_id=='g-tsel_account' && this_class=='g-tsel') {
			$('#AccountName').focus().select();
			_autoView(obj,2,2);
		}else if (this_id=='g-tsel_fromaccount' && this_class=='g-tsel') {
			$('#FromAccount_acc').focus().select();
			_autoView(obj,2,4);
		}
	}

	function _initList_hg() {
		$('#hostTree').unbind();
		$('#hostTree').on('click', 'i.h-aicon', function () {
			var $item = $(this);
			var id = $item.data('id').split('-')[1];
			var $u = $item.parent().children('ul');
			if ($u.is(':hidden')) {
				$item.addClass('h-aicon-d');
				$u.show();
				if ($u.children('li').length == 0) {
					var v = 2;
					var $input = $(this).siblings('span.checkbox');

					var c = $input.attr('class');
					if (c.indexOf('checked') > 0) {
						v = 1;
					} else if (c == 'checkbox') {
						v = 0;
					}

					_initHTML($u, id, v);
				}
			} else {
				$item.removeClass('h-aicon-d');
				$u.hide();
			}
		}).on('dblclick', 'i.h-eicon,span.h-name', function () {
			var $item = $(this).siblings('i:first');
			var id = $item.data('id').split('-')[1];
			var $u = $item.parent().children('ul');
			if ($u.is(':hidden')) {
				$item.addClass('h-aicon-d');
				$u.show();
				if ($u.children('li').length == 0) {
					var v = 2;
					var $input = $(this).siblings('span.checkbox');

					var c = $input.attr('class');
					if (c.indexOf('checked') > 0) {
						v = 1;
					} else if (c == 'checkbox') {
						v = 0;
					}

					_initHTML($u, id, v);
				}
			} else {
				$item.removeClass('h-aicon-d');
				$u.hide();
			}
		})
		var data = Data;
		_viewHTML(data, '#hostTree');

	}

	function _initHTML(obj, id, v) {
		//data
		$.ajax({
			url: "/bhost/get_h_Dir",
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val(), a1: id, a2: 0,t0:12 },
			success: function (result) {
				var result = JSON.parse(result);
				nodeData = result.data.HGroup;
			}
		})

		var cdata = nodeData;
		$(obj).empty();
		$.each(nodeData, function (i, item) {
			var $H = $('<li></li>');
			if (item.MemberNum <= 0) {
				class_name = 'h-blank blank_in';
			} else {
				class_name = 'h-aicon';
			}
			var flag_disabled = '';
			if(item.Mode == 0){
				flag_disabled = 'disabled';
			}
			if (item.Selected == 2) { //全选
				$H.html('<i class="' + class_name + '" data-id="arr-' + item.HGId + '" /><input type="checkbox" checked="checked" id="node-' + item.HGId + '" '+flag_disabled+' data-check="1" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >' + 
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			} else if (item.Selected == 0) { //不选
				if (item.Mode == 0) {
					return true;
				}
				$H.html('<i class="' + class_name + '" data-id="arr-' + item.HGId + '" /><input type="checkbox" id="node-' + item.HGId + '" '+flag_disabled+' data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >' + 
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			} else { //部分选
				$H.html('<i class="' + class_name + '" data-id="arr-' + item.HGId + '" /><input type="checkbox" id="node-' + item.HGId + '" '+flag_disabled+' data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >' + 
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');

			}

			$(obj).append($H);
			_checkView(obj);
			/*
			if (item.Selected != 0) {
				$("#node-" + item.HGId + "").parent().children('i').eq(0).click();
			}
			*/
		});
		_checkView(obj);


	}

	/*
	{
				"HGId": 1,
				"Mode": 0,
				"HGName": "未分组",
				"HostNum": 38,
				"Selected": 0,
				"MemberNum": 0
			}
	
	*/

	function _viewHTML(data, obj) {
		$(obj).empty();
		$.each(data, function (i, item) {
			if (item.HGId == 1) return true;
			var $H = $('<li></li>');
			if (item.MemberNum <= 0) {
				class_name = 'h-blank blank_in';
			} else {
				class_name = 'h-aicon';
			}
			var flag_disabled = '';
			if(item.Mode == 0){
				flag_disabled = 'disabled';
			}
			if (item.Selected == 2) { //全选
				$H.html('<i class="' + class_name + '" data-id="arr-' + item.HGId + '" /><input type="checkbox" checked="checked" id="node-' + item.HGId + '" '+flag_disabled+' data-check="1" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'  + 
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			} else if (item.Selected == 0) { //不选
				if(item.Mode == 0) return true;
				$H.html('<i class="' + class_name + '" data-id="arr-' + item.HGId + '" /><input type="checkbox" id="node-' + item.HGId + '" '+flag_disabled+' data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'  + 
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			} else { //部分选
				$H.html('<i class="' + class_name + '" data-id="arr-' + item.HGId + '" /><input type="checkbox" id="node-' + item.HGId + '" '+flag_disabled+' data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'  + 
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			}
			$(obj).append($H);
			_checkView(obj);
			/*
			if (item.Selected != 0) {
				$("#node-" + item.UGId + "").parent().children('i').eq(0).click();
			}
			*/
		});
		_checkView(obj);

	}

	function _checkView(obj) {
		$('input.zcheck', obj).each(function () {
			var $s = $('<span class="checkbox"></span>');
			if ($(this).parent().find('span.checkbox').length == 0)
				$(this).after($s);
			var v = $(this).prop('checked');
			if (v) {
				$s.addClass('checked');
			} else {
				var c = $(this).data('check');
				if (c && c == 2) {
					$s.addClass('half');
				}
			}

			var d = $(this).prop('disabled');
			if (d) {
				$s.addClass('disabled');
			}
		}).on('change', function () {
			var v = $(this).prop('checked');
			var $s = $(this).next('span.checkbox');
			var $u = $(this).parent().children('ul');
			if (v) {
				$s.attr('class', 'checkbox checked');
				//$('input.zcheck',$u).prop('checked',true);
				//$('span.checkbox',$u).attr('class','checkbox checked');
			} else {
				$s.attr('class', 'checkbox');
				//$('input.zcheck',$u).prop('checked',false);
				//$('span.checkbox',$u).attr('class','checkbox');
			}

			//_checkEvent(this);
		});
	}

	function _checkEvent(obj) {
		var _run = function () {
			var $li = $(obj).parent().parent().parent();
			var tagname = $li[0].tagName.toLowerCase();
			var v = $(obj).prop('checked');

			if (tagname == 'li') {
				var c1 = 0, c2 = 0;
				var len = $(obj).parent().parent().children('li').length;
				$(obj).parent().parent().children('li').each(function () {
					var c = $(this).children('span.checkbox').attr('class');
					if (c.indexOf('checked') > 0) {
						c1++;
					} else if (c.indexOf('half') > 0) {
						c2++;
					}

					if (c1 == len) {
						$li.children('input.zcheck').prop('checked', true).siblings('span.checkbox').attr('class', 'checkbox checked');//.siblings('span.authtype').show();
					} else if (c1 == 0 && c2 == 0) {
						$li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class', 'checkbox');//.siblings('span.authtype').hide();
					} else {
						$li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class', 'checkbox half');
					}
				});
				_checkEvent($li.children('input.zcheck'));
			} else {
				return;
			}
		}
		_run();
	}

	////ping test 浮层
	function _getDialog_pingTest() {

		if ($('#HostIP').val() == '') {
			_alert(2, "PING测试", '请先输入主机IP',$('#HostIP'));
			return false;
		}
		var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

		if (!hostIPReg.test($('#HostIP').val())) {
			_alert(1, "PING测试", "主机IP格式不正确",$('#HostIP'));
			return false;
		};
		$("#ping").val($('#HostIP').val()+" PING测试中...");
		var $dialogCont = $("#scDCTab3").show();
		title = 'PING测试';
		var d = dialog({
			title: title,
			content: $dialogCont,
			id: "scDCTab3",
			width: "500px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
			d.close().remove();
		});
		$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
			d.close().remove();
		})
		$.ajax({
			url: '/bhost/ping_test',
			type: "post",
			async: true,
			cache: false,
			data: { a0: $("input[name=se]").val(), a1:$('#HostIP').val()},
			success: function (result) {
				res = JSON.parse(result.replace(/\n/g,"\\\\n").replace(/\r/g,"\\\\r"));
				if(res.ip == $('#HostIP').val()){
					str_o = res.result;
					str_n = str_o.replace(/\\n/g,"\r\n");
					$("#ping").val(str_n);
				}
			}
		})
	}
	////连接测试 浮层
	var D;
	function _getDialog_connectTest(accid,ser_arr) {
		connTest1 = accid;
		connTest2 = ser_arr;
		var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

		var HostIP = $("#HostIP").val();
		if (HostIP == "") {
			_alert(2, "主机", "请输入主机IP", $('#HostIP'));
			return false;
		};
		if (!hostIPReg.test(HostIP)) {
			_alert(1, "主机", "主机IP格式不正确", $('#HostIP'));
			return false;
		};

		var n = false;
		$('#connectProtoSelect').empty();
		var proto_json=[];
		var arr1;
		var arr2;
		var ser_str = "";
		$(host.AccountSet).each(function(i,item){
			ser_str = "";
			$.each(item.HostServiceSet,function(i1,item1){
				ser_str += item1.ProtocolName + ',';	
			})
			ser_str = ser_str.substring(0,ser_str.length-1);		//去掉"，"
			arr1 = ser_str.split(',');
			arr2 = ser_arr.split(',');
			if(parseInt(accid) == item.HostAccount.AccountId && arr1.sort().toString() == arr2.sort().toString()){
				HostServiceSet_tmp = item.HostServiceSet;
				$(HostServiceSet_tmp).each(function(i1,item1){
					$(SUP_PROTOCOL).each(function(i2,item2){
						if(item2 == item1.ProtocolName){
							n = true;
							if($("#connectProtoSelect option[value="+item1.ProtocolId+"][port="+item1.Port+"]").length ==0){
								$('#connectProtoSelect').append("<option value=\""+item1.ProtocolId+"\" port=\""+item1.Port+"\">"+item1.ProtocolName+"("+item1.Port+")</option>");
							}
							proto_json.push(JSON.parse("{\"ProtocolId\":\""+item1.ProtocolId+"\",\"Port\":"+item1.Port+",\"ConnParamId\":\""+item1.ConnParamId+"\",\"ConnParamName\":\""+item1.ConnParamName+"\"}"))
						}
					})
				})
			}
		})
		$('#connectProtoSelect').select2('destroy').select2();
		if (n == false) {
			_alert(1, "主机", '仅支持: (MSSQL、SYBASE、ORACLE、SSH、TELNET、MYSQL、RLOGIN、DB2、VNC、FTP、RDP、INFORMIX)');	
			return false;
		}

		// var flag_acc_conn = 0;	
		// $.each(arr2,function(i,item){
		// 	if(item == 'MYSQL' || item == 'MSSQL' || item == 'SYBASE' || item == 'ORACLE' || item == 'DB2'){
		// 		$("#acc_test_conn").show();
		// 		flag_acc_conn = 1;
		// 		return false;
		// 	}
		// })
		// if(flag_acc_conn == 0){
		// 	$("#acc_test_conn").hide();
		// }

		$("#connectProtoSelect").bind("change", function () {
			var proName = $('#connectProtoSelect').find("option:selected").text().split("(")[0];
			if(proName == 'MYSQL' || proName == 'MSSQL' || proName == 'SYBASE' || proName == 'ORACLE' || proName == 'DB2'){
				$("#acc_test_conn").show();
				var proto_id;
				$.each(proto_list.data,function(i,item){
					if(item.ProtocolName == proName){
						proto_id = item.ProtocolId;
						return false;
					}
				})
				$.ajax({
					url: '/bhost/get_ConnParam_list',
					type: "post",
					async: false,
					cache: false,
					data: { a0: $("input[name=se]").val(), a1: proto_id},
					success: function (Result) {
						ConnParamData = (JSON.parse(Result)).data;
						$("#connectParamSelect").empty();
						$("#connectParamSelect").append('<option value="-1" title="请选择">请选择</option>');
						$.each(ConnParamData,function(i,item){
							$("#connectParamSelect").append('<option value="'+item.ConnParamId+'" title="'+item.ConnParamName+'">'+item.ConnParamName+'</option>');
						})
					}
				});
			}else{
				$("#acc_test_conn").hide();
			}

			//$('#connectParamSelect').select2('destroy').select2();
			//$('#connectProtoSelect').select2('destroy').select2();
		})
		$("#connectProtoSelect").change();
		var $dialogCont = $("#scDCTab4").show();
		title = '连接测试';
		var d = dialog({
			title: title,
			content: $dialogCont,
			id: "scDCTab4",
			width: "800px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		D = d;
		$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
			reload(5);
		});
		$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
			test_save(accid,arr2);
		})
	}
	function test_save(accid,arr2){
		var jsondata = {
			"HostIP": null,
			"ProtocolName": null,
			"Port": null,
			"ServiceName": null,
			"AccountName": null,
			"Password": null,
			"PasswordType": null,
			"AcctSwitchCmd": null,
			"SwitchPasswdPrompt": null,
			"FromAccountName": null,
			"FromPassword": null,
			"FromPasswordType": null,
			"IsClearText1": false,
			"IsClearText2": false
		}
		var connServiceName;
		//取测试服务的连接参数信息
		if($("#connectParamSelect").val() != undefined && $("#connectParamSelect").val() != '-1'){
			$.ajax({
				url: '/bhost/get_connection_list',
				type: "post",
				async: false,
				cache: false,
				data: {a0:$("input[name=se]").val(),a1:$("#connectParamSelect").val()},
				success: function(Result){
					var result = JSON.parse(Result);
					result = result.info.data[0];
					connServiceName = result.ServiceName;
				}
			})
		}
		$("#conn_test").val("测试中...");
		jsondata.HostIP = $("#HostIP").val();
		jsondata.ProtocolName = $("#connectProtoSelect option:selected").text().split('(')[0];
		jsondata.Port = $("#connectProtoSelect option:selected").text().split('(')[1].split(')')[0];
		jsondata.ServiceName = connServiceName;
		//取账号信息;
		var acc_data;
		var arr1,IsClearText1;
		$.each(host.AccountSet,function(i,item){
			var ser_str = "";
			$.each(item.HostServiceSet,function(i1,item1){
				ser_str += item1.ProtocolName + ',';	
			})
			ser_str = ser_str.substring(0,ser_str.length-1);		//去掉"，"
			arr1 = ser_str.split(',');
			if(parseInt(accid) == item.HostAccount.AccountId && arr1.sort().toString() == arr2.sort().toString()){
				acc_data = item;
				IsClearText1 = item.IsClearText;
			}
		})
		//取账号和切换自账号的Name;
		var accName;
		var fromAccName;
		var flag1 = 0;
		var flag2 = 0;
		$.each(AccountData,function(i,item){
			if(acc_data.HostAccount.AccountId == item.AccountId){
				accName = item.AccountName;
				flag1 = 1;
			}else if(acc_data.HostAccount.FromAccountId == item.AccountId){
				fromAccName = item.AccountName;
				flag2 = 1;
			}
			if(flag1 == 1 && flag2 == 1){
				return false;
			}
		})
		//切换自账号的Password以及passwordtype;
		var fromAccId = acc_data.HostAccount.FromAccountId;
		var arr2;
		var ser_str = "";
		var fromAPwd,fromAPwdType,IsClearText2;
		$(host.AccountSet).each(function(i,item){
			$.each(item.HostServiceSet,function(i1,item1){
				ser_str += item1.ProtocolName + ',';	
			})
			ser_str = ser_str.substring(0,ser_str.length-1);		//去掉"，"
			arr1 = ser_str.split(',');
			if(parseInt(fromAccId) == item.HostAccount.AccountId && arr1.sort().toString() == arr2.sort().toString()){
				fromAPwd = item.Password;
				fromAPwdType = item.PasswordType;
				IsClearText2 = item.IsClearText2;
			}
		})
		jsondata.AccountName = accName;
		jsondata.Password = acc_data.Password;
		jsondata.PasswordType = acc_data.PasswordType;
		jsondata.AcctSwitchCmd = acc_data.HostAccount.AcctSwitchCmd;
		jsondata.SwitchPasswdPrompt = acc_data.HostAccount.SwitchPasswdPrompt;
		jsondata.FromAccountName = fromAccName;
		jsondata.FromPassword = fromAPwd;
		jsondata.FromPasswordType = fromAPwdType;
		jsondata.IsClearText1 = IsClearText1;
		jsondata.IsClearText2 = IsClearText2;
		var taskId;
		$.ajax({
			url: '/bhost/conn_test',
			type: "post",
			async: false,
			cache: false,
			data: {a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata)},
			success: function(Result){
				var result = JSON.parse(Result);
				taskId = result.Id;
				//show 结果textarea
				var $dialogCont_1 = $("#scDCTab4_1").show();
				title = '连接测试结果';
				var d_1 = dialog({
					title: title,
					content: $dialogCont_1,
					id: "scDCTab4_1",
					width: "500px"
				});
				d_1.addEventListener('close', function () {
					$dialogCont_1.appendTo("body").hide();
					clearInterval(interval_output);
				});
				d_1.showModal();
				$("a.btn-cancle", $dialogCont_1).unbind().bind("click", function () {
					d_1.close().remove();
					D.close().remove();
					clearInterval(interval_output);
					$.ajax({
						url: '/bhost/del_conn_test',
						type: "post",
						async: false,
						data: {a0:$("input[name=se]").val(),a1:taskId},
						success: function(Result){
						}
					})
				});
				//每隔TEST_TIME秒取一次结果
				var test_timeout = 0;
				interval_output = setInterval(function(){
					$.ajax({
						url: '/bhost/get_conn_test',
						type: "post",
						async: false,
						cache: false,
						data: {a0:$("input[name=se]").val(),a1:taskId},
						success: function(Result){
							var test_result = JSON.parse(Result);
							if(test_result[0].Status == 2){
								$("#conn_test").val("连接成功!");
								clearInterval(interval_output);
							}else if(test_result[0].Status == 3 || test_result[0].Status == 4){
								$("#conn_test").val("连接失败!");
								clearInterval(interval_output);
							}else{

							}
							test_timeout += TEST_TIME;
							if(test_timeout >= TEST_TIMEOUT){
								$("#conn_test").val("连接失败!");
								clearInterval(interval_output);
							}
						}
					})}
				,TEST_TIME);
			}
		})
	}
// 连接参数 样式 可编辑
var $focusObj;
function _autoView(obj,i,j,k){
	$(document)[0].onclick = null;
	$focusObj = $(obj);
	var v = $.trim($(obj).val());
	var $view;
	if($('#autoView').length == 0){
		$('body').append('<div id="autoView" />');
	}
	$view = $('#autoView');
	var c = '';
	if (j == 0){
		$.each(connparm_list,function(i,item){
			if(v == ''){
				c += '<li><i class="edit" onclick="_addNew(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.ConnParamId+'" onclick="_setVal(this,0);">'+item.ConnParamName+'</a></li>';
			}else{
				if(item.ConnParamName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_addNew(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.ConnParamId+'" onclick="_setVal(this,0);">'+item.ConnParamName+'</a></li>';
				}
			}
		});
	}else if (j == 1){
		$.each(DomainName_list,function(i,item){
			if(v == ''){
				c += '<li><i class="edit" onclick="_addNew2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.DomainId+'" onclick="_setVal(this,1);">'+item.DomainName+'</a></li>';
			}else{
				if(item.DomainName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_addNew2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.DomainId+'" onclick="_setVal(this,1);">'+item.DomainName+'</a></li>';
				}
			}
		});
	}else if (j == 2){
		$.each(AccountData,function(i,item){
			if(v == ''){
				c += '<li><i class="edit" onclick="_addNew1(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccountId+'" onclick="_setVal(this,2);">'+item.AccountName+'</a></li>';
			}else{
				if(item.AccountName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_addNew1(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccountId+'" onclick="_setVal(this,2);">'+item.AccountName+'</a></li>';
				}
			}
		});
	}else if (j == 3){
		if(k == 0){
			$.ajax({
				url: '/bhost/get_accIP',
				type: "post",
				async: false,
				cache: false,
				data: { a0: $("input[name=se]").val() },
				success: function (Result) {
					accIP_list = JSON.parse(Result);
				}
			})
		}
		$.each(accIP_list.data,function(i,item){
			var accopod_flag = 0;
			$(accipid_list).each(function(i1,item1){
				if(item.AccIPId == item1){
					accopod_flag = 1;
					return false;
				}
			})
			if(accopod_flag == 1){
				return true;
			}
			if(v == ''){
				c += '<li><i class="del" onclick="_delNode(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccIPId+'" onclick="_setVal(this,3);">'+item.AccIP+'</a></li>';
			}else{
				if(item.AccIP.indexOf(v) >= 0 ){
					c += '<li><i class="del" onclick="_delNode(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccIPId+'" onclick="_setVal(this,3);">'+item.AccIP+'</a></li>';
				}
			}
		});
	}
	if(i==0){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" onclick="_addNew(this,0)">创建连接参数</a></div>');
	}else if(i == 1){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_addNew2(this,0);">创建AD域</a></div>');
	}else if(i == 2){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_addNew1(this,0);">创建账号</a></div>');
	}else if(i == 3){
		$view.html('<ul>'+c+'</ul>');
	}

	var offset = $(obj).offset();
	var w = $(obj).outerWidth();
	$view.css({
		top:offset.top+24,
		left:offset.left,
		width:w-12
	}).show();
	$(obj).parents('.g-tsel').addClass('on');
	if(c == ""){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
	}
}
var connection={
	"ConnParamId":0,
	"ConnParamName":null,
	"ProtocolId":0,
	"ServiceName":null,
	"ConnType":null,
	"ConnParamValue":null
};
function clear_conn(){
	$('#d_n').attr("disabled",false);
	$('#Protocol').attr("disabled",false);
	$('#d_n').next().attr('class','v-check');
	$('#ConnParamDialog input').each(function(i,item){
		$(this).val('');
	})
	$("#ConnParamDialog select").each(function(i,item){
		var val1 = $(item).find('option:first').val();
		$(this).val(val1).trigger('change');
	})
	$("#Protocol").empty();
	$("#Protocol").append('<option value="0" selected>请选择</option>');
	$('#Protocol').val('0').trigger('change');
}
function NameRepeatCheck(NameStr){
	$.ajax({
		url: '/bhost/CheckConnName',
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(), a1: NameStr},
		success: function (result) {
			result1 = JSON.parse(result);
		}
	})
	if (result1.Id == 0) {
		return 1;
	}else{
		return -1;
	}
}
function _addNew(obj,type){
	editcp1 = obj;
	editcp2 = type;
	clear_conn();
	if(type == 0){
		connection={
			"ConnParamId":0,
			"ConnParamName":null,
			"ProtocolId":0,
			"ServiceName":null,
			"ConnType":null,
			"ConnParamValue":null
		};
		$("#Protocol").attr('disabled','true');
	}else if(type == 1){
		$("#Protocol").attr('disabled','true');
	}
	
	var $dialogCont = $("#ConnParamDialog").show();
	if(type == 0)  title = "连接参数"
	else title = "连接参数"
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"ConnParamDialog",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	//协议类型下拉框
	var Protocol_old = 0;
	$.ajax({
		url: "/bhost/get_protocol_list",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a3:17,a2:1,a4:",,"},
		success:function(result){
			var userinfo_result = JSON.parse(result);
			//if (userinfo_result.Result==true){
			var userinfo_data = userinfo_result.data;	
			$.each(userinfo_data,function(i,item){
				$("#Protocol").append('<option value="'+item.ProtocolId+'" text="'+item.ProtocolName+'">'+item.ProtocolName+'</option>');
			});
			$('.form-select').select2();
			//}
		}
	});
	$("#Protocol").change(function(){
		var p_id=$(this).children("option:selected").val();
		$('#RDP').hide();
		$("#SSH").hide();
		$("#SFTP").hide();
		$('#MY_ConnType').hide();
		$("#HTTP").hide();
		$("#HTTPs").hide();
		$("#ORACLE").hide();
		$("#RADMIN").hide();
		$("#MSSQL").hide();
		$("#SYBASE").hide();
		$("#MY_DB2").hide();
		switch($('#Protocol option[value='+p_id+']').text()){
			case "RDP":
				$('#RDP').show();
				break;
			//SSH
			case "SSH":
				$('#SSH').show();
				break;
			//SFTP
			case "SFTP":
				$('#SFTP').show();
				break;
			//HTTP(S)
			case "HTTP(S)":
				$("#HTTP").show();
				break;
			//HTTPS
			case "HTTPS":
				$("#HTTPs").show();
				break;
			//ORACLE
			case "ORACLE":
				$("#ORACLE").show();
				break;
			//RADMIN
			case "RADMIN":
				$("#RADMIN").show();
				break;
			//MSSQL
			case "MSSQL":
				$("#MSSQL").show();
				break;
			//MYSQL 
			case "MYSQL":
				$("#MY_DB2").show();
				//$('#MY_ConnType').show();
				break;
			//DB2
			case "DB2":
				$("#MY_DB2").show();
				break;
			//SYBASE
			case "SYBASE":
				$("#SYBASE").show();
				break;
		}
	});
	if($("#ProtocolName").data('value') != ""){
		$("#Protocol").val($("#ProtocolName").data('value')).trigger('change');
	}else{
		$("#Protocol").removeAttr("disabled");
		$("#Protocol").val("0").trigger('change');
	}
	//编辑页面
	ConnParamId = 0;
	if(type == 1){
		ConnParamId = $(obj).children('span').attr('data-value');
		$.ajax({
			url: "/bhost/get_connection_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:ConnParamId},
			success:function(result){
				var connection_result = JSON.parse(result);
				if (connection_result.Result==true){
					var connection_data = connection_result.info.data[0];
					Protocol_old = connection_data.ProtocolId;
					$("#d_n").val(connection_data.ConnParamName);
					$("#d_n").attr("disabled",true);
					$("#Protocol").val(connection_data.ProtocolId).trigger('change');
					$("#Protocol").attr('disabled',true);

					$('#RDP').hide();
					$("#SSH").hide();
					$('#MY_ConnType').hide();
					$("#HTTP").hide();
					$("#HTTPs").hide();
					$("#ORACLE").hide();
					$("#RADMIN").hide();
					$("#MSSQL").hide();
					$("#SYBASE").hide();
					$("#MY_DB2").hide();
					switch(connection_data.ProtocolName){
						case 'RDP':
							$('#RDP').show();
							$('#rdpType').val(connection_data.ConnType).trigger('change');
							break;
						case 'SSH':
							$('#SSH').show();
							$('#ServiceName_ssh').val(connection_data.ServiceName).trigger('change');
							break;
						case 'SFTP':
							$('#SFTP').show();
							$('#ServiceName_sftp').val(connection_data.ServiceName).trigger('change');
							break;
						//HTTP(S)
						case 'HTTP(S)':
						//HTTPs
							 $("#HTTP").show();
							//
							$("#url").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#Submit").val(connection_data.ConnParamValue.substring(index+1));
							//
							break;
						case 'HTTPS':
							$("#HTTPs").show();
							$("#httpsurl").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#httpsSubmit").val(connection_data.ConnParamValue.substring(index+1));
							//
							break;
						//ORACLE
						case 'ORACLE':
							//
							//指定项必填
							if(connection_data.ConnParamValue == "SID"){
								$("#appoint").val('1').trigger('change');
							}else if(connection_data.ConnParamValue == "SERVICE_NAME"){
								$("#appoint").val('2').trigger('change');
							}
							$("#s_n").val(connection_data.ServiceName);
							if(connection_data.ConnType==null){
								connection_data.ConnType="未指定";
							}
							if(connection_data.ConnType == "SYSOPER"){
								$("#conn").val('3').trigger('change');
							}else if(connection_data.ConnType == "SYSDBA"){
								$("#conn").val('2').trigger('change');
							}else if(connection_data.ConnType == "NORMAL"){
								$("#conn").val('1').trigger('change');
							}
							//$("#conn").children("option[text='"+connection_data.ConnType+"']").attr("selected",true);
							//
							$("#ORACLE").show();
							break;
						//RADMIN
						case 'RADMIN':
							//认证方式：
							if(connection_data.ConnType==null){
								$("#authtype").val('0').trigger('change');
							}else if(connection_data.ConnType == "RADMIN"){
								$("#authtype").val('1').trigger('change');
							}else if(connection_data.ConnType == "Windows"){
								$("#authtype").val('2').trigger('change');
							}
							$("#RADMIN").show();
							break;
						//MSSQL
						case 'MSSQL':
							//
							//实例名：
							$("#o_n").val(connection_data.ServiceName);
							//认证方式：
							if(connection_data.ConnType==null){
								$("#R_authtype").val('0').trigger('change');
							}else if(connection_data.ConnType == "SQL服务器验证"){
								$("#R_authtype").val('1').trigger('change');
							}else if(connection_data.ConnType == "Windows验证"){
								$("#R_authtype").val('2').trigger('change');
							}else if(connection_data.ConnType == "Windows单一登录"){
								$("#R_authtype").val('2').trigger('change');
							}

							// $("#R_authtype").children("option[text='"+connection_data.ConnType+"']").attr("selected",true);
							//
							$("#MSSQL").show();
							break;
						//MYSQL 
						case 'MYSQL':
							//
							//数据库名：
							$('#sql_n').val(connection_data.ServiceName);
							//$('#MY_ConnType').show();
							$('#select_my').val(connection_data.ConnType).trigger('change');
							$("#MY_DB2").show();
							break;
						//DB2
						case 'DB2':
							//数据库名：
							$('#sql_n').val(connection_data.ServiceName);
							//
							$("#MY_DB2").show();
							break;
						//SYBASE
						case 'SYBASE':
							//实例名：
							$('#sy_o_n').val(connection_data.ServiceName);
							//
							$("#SYBASE").show();
							break;
					}
					$('.form-select').select2();
				}
			}
		});
	}
	
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(7);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var match1 = /^((ht|f)tps?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?$/;
		var _nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		var sp_char = /^[^@\/\'\\\"#$%&\^\*]+$/;
		var p_id=$("#Protocol").children("option:selected").val();
		var p_name = $("#Protocol").children("option:selected").text();
		var val = $("#d_n").val();
		if(val == ""){
			switch (p_name){
				case "RDP":
					ServiceName = p_name+$("#rdpType").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "SSH":
					ServiceName = p_name+$("#ServiceName_ssh").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "SFTP":
					ServiceName = p_name+$("#ServiceName_sftp").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "ORACLE":
					var appoint=$("#appoint").children("option:selected").val();
					if(appoint=="0"){
						_alert(2, "主机","请选择指定项",$("#appoint"));
						return false;
					}
					var s_n=$("#s_n").val();
					if(s_n==""){
						_alert(2, "主机","请输入实例名或服务名",$("#s_n"));
						//$("#s_n").val("");
						return false;
					}else if(!sp_char.test(s_n)){
						_alert(1, "主机","实例名或服务名格式不正确",$("#s_n"));
						//$("#s_n").val("");
						return false;
					}
					ServiceName = p_name+$("#s_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						ServiceName += $("#appoint").children("option:selected").text();
						if(NameRepeatCheck(ServiceName) == -1){
							ServiceName += $("#conn").children("option:selected").text();
							if(NameRepeatCheck(ServiceName) == -1){
								_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
								return false;
							}
						}
					}
					break;
				case "MSSQL":
					var o_n=$("#o_n").val();
					if(o_n==""){
						_alert(2, "主机","请输入实例名",$("#o_n"));
						//$("#o_n").val("");
						return false;
					}else if(!sp_char.test(o_n)){
						_alert(1, "主机","实例名格式不正确",$("#o_n"));
						//$("#o_n").val("");
						return false;
					}
					ServiceName = p_name+$("#o_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						ServiceName += $("#R_authtype").children("option:selected").text();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
					}
					break;
				case "MYSQL":
					var sql_n=$("#sql_n").val();
					if(sql_n==""){
						_alert(2, "主机","请输入数据库名",$("#sql_n"));
						//$('#sql_n').val("");
						return false;
					}else if (!sp_char.test(sql_n)){
						_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
						//$("#sql_n").val("");
						return false;
					}
					ServiceName = p_name+$("#sql_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "HTTP(S)":
					var url = $("#url").val();
					if (url == "") {
						_alert(2, "连接参数", "请输入URL", $("#url"));
						return false;
					}
					if (!match1.test(url) && url != "") {
						_alert(1, "连接参数", "URL格式不正确", $("#url"));
						//$("#UserPwd").val("");
						return false;
					}
					var UserName=$("#UserName").val();
					if (!sp_char.test(UserName) && UserName != "") {
						_alert(1, "主机", "账号格式不正确", $("#UserName"));
						//$("#UserName").val("");
						return false;
					}
					var UserPwd=$("#UserPwd").val();
					if(!sp_char.test(UserPwd) && UserPwd!=""){
						_alert(1, "主机","密码格式不正确",$("#UserPwd"));
						//$("#UserPwd").val("");
						return false;
					}
					ServiceName = "HTTPS"+$("#url").val().split('://')[1].split('/')[0];
					if(ServiceName.indexOf(':') != -1){
						ServiceName = ServiceName.split(':')[0];
					}
					if(NameRepeatCheck(ServiceName) == -1){
						ServiceName += $("#UserName").val();
						if(NameRepeatCheck(ServiceName) == -1){
							ServiceName += $("#UserPwd").val();
							if(NameRepeatCheck(ServiceName) == -1){
								ServiceName += $("#Submit").val();
								if(NameRepeatCheck(ServiceName) == -1){
									_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
									return false;
								}
							}
						}
					}
					break;
				case "RADMIN":
					ServiceName = p_name+$("#authtype").children("option:selected").text();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "SYBASE":
					var sy_o_n=$("#sy_o_n").val();
					if(sy_o_n==""){
						_alert(2, "主机","请输入实例名",$("#sy_o_n"));
						//$('#sy_o_n').val("");
						return false;
					}else if (!sp_char.test(sy_o_n)){
						_alert(1, "主机",'实例名格式不正确',$("#sy_o_n"));
						//$("#sy_o_n").val("");
						return false;
					}
					ServiceName = p_name+$("#sy_o_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "DB2":
					var sql_n=$("#sql_n").val();
					if(sql_n==""){
						_alert(2, "主机","请输入数据库名",$("#sql_n"));
						//$('#sql_n').val("");
						return false;
					}else if (!sp_char.test(sql_n)){
						_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
						//$("#sql_n").val("");
						return false;
					}
					ServiceName = p_name+$("#sql_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "TELNET":
				case "FTP":
				case "VNC":
				case "X11":
				case "RLOGIN":
				case "PCANY":
				case "TN5250":
					ServiceName = p_name;
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
			}
			val = ServiceName;			
		}
		var $i = $("#d_n").next('i.v-check');
		//事件告警信息名
		if(val==""){
			_alert(2, "连接参数",'请输入名称',$("#d_n"));
			return false;
		}
		if(!_nameReg.test(val)){
			_alert(1, "连接参数",'名称格式不正确·',$("#d_n"));
			//$("#d_n").val("");
			return false;
		}
		if(p_id=="0"){
			_hideView();
			_alert(2, "连接参数",'请选择协议类型',$("#Protocol"));
			return false;
		}
		connection.ConnParamName=val;
		connection.ConnParamId=parseInt(ConnParamId);
		switch($('#Protocol option[value='+p_id+']').text()){
			case 'RDP':
				connection.ServiceName = null;
				connection.ConnType = $('#rdpType').val();
				connection.ConnParamValue = null;
				break;
			//SSH
			case "SSH":
				var ServiceName_ssh = $('#ServiceName_ssh').val();
				connection.ServiceName = ServiceName_ssh;
				connection.ConnType = null;
				connection.ConnParamValue = null;
				break;
			//SFTP
			case "SFTP":
				var ServiceName_ssh = $('#ServiceName_sftp').val();
				connection.ServiceName = ServiceName_ssh;
				connection.ConnType = null;
				connection.ConnParamValue = null;
				break;
			//HTTP(S)
			case "HTTP(S)":
				var url = $("#url").val();
				if (url == "") {
					_alert(2, "连接参数", "请输入URL", $("#url"));
					return false;
				}
				if (!match1.test(url) && url != "") {
					_alert(1, "连接参数", "URL格式不正确", $("#url"));
					//$("#UserPwd").val("");
					return false;
				}
				var UserName=$("#UserName").val();
				if (!sp_char.test(UserName) && UserName != "") {
					_alert(1, "主机", "账号格式不正确", $("#UserName"));
					//$("#UserName").val("");
					return false;
				}
				var UserPwd=$("#UserPwd").val();
				if(!sp_char.test(UserPwd) && UserPwd!=""){
					_alert(1, "主机","密码格式不正确",$("#UserPwd"));
					//$("#UserPwd").val("");
					return false;
				}
				connection.ServiceName=url;
				connection.ConnType=null;
				var Submit=$("#Submit").val();
				var json_a = UserName + '|' + UserPwd + '|' + Submit;
				connection.ConnParamValue = json_a;
				break;
			//HTTPs
			case "HTTPS":
				var url = $("#httpsurl").val();
				if (url == "") {
					_alert(2, "连接参数", "请输入URL", $("#url"));
					return false;
				}
				var UserName = $("#httpsUserName").val();
				if (!sp_char.test(UserName) && UserName != "") {
					_alert(1, "主机", "账号格式不正确", $("#UserName"));
					//$("#UserName").val("");
					return false;
				}
				var UserPwd = $("#httpsUserPwd").val();
				if (!sp_char.test(UserPwd) && UserPwd != "") {
					_alert(1, "连接参数", "密码格式不正确", $("#UserPwd"));
					//$("#UserPwd").val("");
					return false;
				}
				connection.ServiceName = url;
				connection.ConnType = null;
				var Submit = $("#httpsSubmit").val();
				// Submit='"'+Submit+'"';
				// UserName='"'+UserName+'"';
				// UserPwd='"'+UserPwd+'"';
				var json_a = UserName + '|' + UserPwd + '|' + Submit;
				connection.ConnParamValue = json_a;
				break;
			//ORACLE
			case "ORACLE":
				connection.ProtocolId=3;
				//指定项必填
				var appoint=$("#appoint").children("option:selected").val();
				if(appoint=="0"){
					_alert(2, "主机","请选择指定项",$("#appoint"));
					return false;
				}
				var s_n=$("#s_n").val();
				if(s_n==""){
					_alert(2, "主机","请输入实例名或服务名",$("#s_n"));
					//$("#s_n").val("");
					return false;
				}else if(!sp_char.test(s_n)){
					_alert(1, "主机","实例名或服务名格式不正确",$("#s_n"));
					//$("#s_n").val("");
					return false;
				}
				var conn_text=$("#conn").children("option:selected").text();
				if(conn_text=="未指定"){
					conn_text=null;
				}
				var appoint_text=$("#appoint").children("option:selected").text();
				connection.ConnParamValue=appoint_text;
				connection.ServiceName=s_n;
				connection.ConnType=conn_text;
				break;
				//RADMIN
			//RADMIN
			case "RADMIN":
				//认证方式：
				var authtype=$("#authtype").children("option:selected").text();
				if(authtype=="未指定"){
					authtype=null;
				}
				connection.ServiceName=null;
				connection.ConnType=authtype;
				connection.ConnParamValue=null;
				break;
			//MSSQL
			case "MSSQL":
				//实例名：
				var o_n=$("#o_n").val();
				if(o_n==""){
					_alert(2, "主机","请输入实例名",$("#o_n"));
					//$("#o_n").val("");
					return false;
				}else if(!sp_char.test(o_n)){
					_alert(1, "主机","实例名格式不正确",$("#o_n"));
					//$("#o_n").val("");
					return false;
				}
				//认证方式：
				var R_authtype=$("#R_authtype").children("option:selected").text();
				if(R_authtype=="未指定"){
					R_authtype=null;
				}
				connection.ServiceName=o_n;
				connection.ConnType=R_authtype;
				connection.ConnParamValue=null;
				break;
			//MYSQL 
			case "MYSQL":
				//数据库名：
				var sql_n=$("#sql_n").val();
				if(sql_n==""){
					_alert(2, "主机","请输入数据库名",$("#sql_n"));
					//$('#sql_n').val("");
					return false;
				}else if (!sp_char.test(sql_n)){
					_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
					//$("#sql_n").val("");
					return false;
				}
				var select_my=parseInt($('#select_my').val());
				if(select_my == 0){
					select_my = null;
				}
				connection.ServiceName=sql_n;
				connection.ConnType=select_my;
				connection.ConnParamValue=null;
				break;
			//DB2
			case "DB2":
				//数据库名：
				var sql_n=$("#sql_n").val();
				if(sql_n==""){
					_alert(2, "主机","请输入数据库名",$("#sql_n"));
					//$('#sql_n').val("");
					return false;
				}else if (!sp_char.test(sql_n)){
					_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
					//$("#sql_n").val("");
					return false;
				}

				connection.ServiceName=sql_n;
				connection.ConnType=null;
				connection.ConnParamValue=null;
				break;
			//SYBASE
			case "SYBASE":
				//实例名：
				var sy_o_n=$("#sy_o_n").val();
				if(sy_o_n==""){
					_alert(2, "主机","请输入实例名",$("#sy_o_n"));
					//$('#sy_o_n').val("");
					return false;
				}else if (!sp_char.test(sy_o_n)){
					_alert(1, "主机",'实例名格式不正确',$("#sy_o_n"));
					//$("#sy_o_n").val("");
					return false;
				}
				connection.ServiceName=sy_o_n;
				connection.ConnType=null;
				connection.ConnParamValue=null;
				break;
			default:
				connection.ServiceName=null;
				connection.ConnType=null;
				connection.ConnParamValue=null;
		}
		connection.ProtocolId=parseInt(p_id);
		if(Protocol_old != $("#Protocol").val() && type != 0){
			var msstr = aceg(JSON.stringify(connection),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_connection',
				type: "POST",
				async:false,
				data: {a0:$("input[name=se]").val(),a1:JSON.stringify(connection),a10:"运维管理>主机",m1:msstr},
				success: function(result) {
					var result = JSON.parse(result);
					if(result.Result == true){
						$('.btn').blur();
						parent.layer.open({
							type:1,
							title: '连接参数',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:['确&nbsp;&nbsp;定'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							yes:function(i){
								parent.layer.close(i);
								d.close().remove();
								var id_str = $("#ConnParamName").data('value');
								var name_str = $("#ConnParamName").children().find('span').text();
								$("div[data-id=xSelect-connparam]").remove();
								$('#ConnParamName').empty().data('xSelect','');
								bind_Conn_xSelect($("#ProtocolName"));
								if(name_str == '请选择'){
									//$('#ProtocolName').change();
									$("#ConnParamName").data('value',result.ConnParamId);
									$("#ConnParamName").children().find('span').text(connection.ConnParamName);
								}else{
									//$('#ProtocolName').change();
									$("#ConnParamName").data('value',id_str);
									$("#ConnParamName").children().find('span').text(name_str);
								}
							}
						});

					}else{
						_alert(1, "连接参数",result.ErrMsg,$("#d_n"));
						return false;
					}
				}
			});
		}else{
			var msstr = aceg(JSON.stringify(connection),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_connection',
				type: "POST",
				async:false,
				data: {a0:$("input[name=se]").val(),a1:JSON.stringify(connection),a10:"运维管理>主机",m1:msstr},
				success: function(result) {
					var result = JSON.parse(result);
					if(result.Result == true){
						$('.btn').blur();
						parent.layer.open({
							type:1,
							title: '连接参数',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:['确&nbsp;&nbsp;定'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							yes:function(i){
								parent.layer.close(i);
								d.close().remove();
								var id_str = $("#ConnParamName").data('value');
								var name_str = $("#ConnParamName").children().find('span').text();
								$("div[data-id=xSelect-connparam]").remove();
								$('#ConnParamName').empty().data('xSelect','');
								bind_Conn_xSelect($("#ProtocolName"));								
								if(name_str == '请选择'){
									$('#ProtocolName').change();
									$("#ConnParamName").data('value',result.ConnParamId);
									$("#ConnParamName").children().find('span').text(connection.ConnParamName);
								}else{
									$('#ProtocolName').change();
									$("#ConnParamName").data('value',id_str);
									$("#ConnParamName").children().find('span').text(name_str);
								}
							}
						});

					}else{
						_alert(1, "连接参数",result.ErrMsg,$("#d_n"));
						return false;
					}
				}
			});
		}	
	})
}

function _delNode(obj){
	var $p = $(obj).parent();
	var id = $(obj).next('a').attr('id');
	$(document)[0].onclick = null;
	parent.layer.open({
		type:1,
		title:"主机",
		content:'<div class="layer-alert"><i class="alert warning"></i>该前置机IP可能配置于其他服务 是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			$.ajax({
				url:'/bhost/del_acc_ip',
				type:'post',
				async:false,
				data:{a0:$("input[name=se]").val(),a1:id},
				success:function(result){
					var result = JSON.parse(result);
					if (result.Result == true){
						$p.remove();
						return;
					}else{
						_alert(1, "主机",result.ErrMsg);
						_hideView(3);
						return;
					}
				}
			})
		},
		btn2:function(i){
			parent.layer.close(i);
			_hideView(3);
		}
	});
}
//---------------------------账号编辑
function clear_acce(){
	$("#first_div").siblings().remove()
	$("#first_div").after('<div id="luo0" style="float:left;width:97%;position: static;">'+
				'<div class="form-item" style="width:50%;float:left;">'+
					'<span class="form-tag" style="width:60px"><em class="imp">*</em>账号：</span>'+
					'<div class="form-c sel-type1" id = "account_name" style="margin-bottom: 15px;width: 270px;float: left;padding: 1px 10px 10px 10px;">'+
							'<input type="text" class="form-text" id="Name0" onblur="NameCheck1(this)" maxlength="127"><i class="v-check" id="check0"></i>'+
						'<p class="form-tip" id="prompt0" style="padding-left: 0px;"特殊字符仅支持@(仅可用1次)、下划线、横杠、小数点</p>'+
					'</div>'+
				'</div>'+
				'<div class="form-item" style="width:50%;float:left;margin-top: 1px;">'+
					'<span class="form-tag" style="width:70px">AD域：</span>'+
							
					'<div class="form-c sel-type1" style="float:left;width: 280px;padding-left:15px;">'+
						'<li id="add_AD0">'+
							'<select name="" id="ADregion0" onchange="AD_change(0,this);" class="type-select" style="width:250px">'+
							'</select>'+
							'<i class="ctrl add" id="edit_hide" onclick="addinput(this)"></i>'+
						'</li>'+
					'</div>'+
				'</div>'+
			'</div>')
	$('.type-select').select2();
	AD_add(number);
	$("#del_0").remove();
	$('#Name0').attr("disabled",false);
	$('#Name0').val('');
	$('#ADregion0').attr("disabled",false);
	$('#ADregion0').val('0').trigger('change');
	$("#ADregion0").attr("onchange","");
	$("#check0").attr('class','v-check');
	$("#edit_hide").show();
	if($("#edit_hide").length == 0){
		$("#add_AD0").append('<i class="ctrl add" id="edit_hide" onclick="addinput(this)"></i>');
	}
	accountType = "1";
	Name = "test";
	accountid = "";
	number=0;
	id_list=[];
	test=[];
	adc=0;
	adc1=0;
}
//---------------------------账号编辑
var json_acc={
	"AccountId":0,
	"Name":null,
	"DomainId":0,
	"AccountName":null,
	"DomainName":null,
	"AccountType":1			
};
var accountType = "1";
var Name = "test";
var accountid = "";
var AccountData = "";
var number=0;
var id_list=[];
var test=[];
var adc=0;
var adc1=0;
//获取全部账号信息---------------------------账号编辑
var account_all;
function all_account(){
	account_all = [];
	$.ajax({
		url:'/bhost/select_account_all',
		type:'post',
		async:false,
		data:{a0:$("input[name=se]").val(),z11:-1},
		success:function(result){
			account_all = JSON.parse(result);
		}
	});
}
//删除添加列表按钮实现---------------------------账号编辑
function _delinput(obj){
	var $del_div = $(obj).parent().parent().parent().parent();
	var num=$(obj).attr("value");
	$del_div.remove();
	for(var i=0;i<id_list.length;i++){
		if(id_list[i]==num){
			id_list.splice(i,1);
			break;
		}
	}
}
//向前加入一个input框 和一个X按钮
function addinput(obj){
	var flag=true;
	flag=check_data(number);
	if(flag==false){
		return ;
	}
	adc=0;
	if(flag){
		id_list.push(number+1);
		$("#prompt"+number+"").hide();
		$("#check"+number+"").hide();
		// $("#Name"+number+"").attr("disabled",true);
		if(number==0){
			$("#add_AD"+number+"").append('<i class="ctrl del" id = "del_'+number+'" value="'+number+'"  onclick="_delinput(this)"></i>').children('i.add').remove();
		}else{
			$("#add_AD"+number+"").append('<i class="ctrl del" id = "del_'+number+'" value="'+number+'" style="margin-left:5px" onclick="_delinput(this)"></i>').children('i.add').remove();
		}
		number=number+1;
		$("#first_div").after('<div id="luo'+number+'" style="float:left;width:97%;position: static;">');
		$("#luo"+number+"").append('<div class="form-item" style="width:50%;float:left;"><span class="form-tag" style="width:60px"><em class="imp">*</em>账号：</span>'+
				'<div class="form-c sel-type1" id = "account_name" style="margin-bottom: 15px;width: 270px;float: left;padding: 1px 10px 10px 10px;">'+
				'<input type="text" class="form-text" id="Name'+number+'" onblur="NameCheck1(this)" maxlength="127"><i class="v-check" id="check'+number+'"></i>'+
				'<p class="form-tip" id="prompt'+number+'" >特殊字符仅支持@(仅可用1次)、下划线、横杠、小数点</p></div></div>');
		$("#luo"+number+"").append('<div class="form-item" style="width:50%;float:left;"><span class="form-tag" style="width:70px">AD域：</span>'+		
				'<div  class="form-c sel-type1" style="float:left;width: 280px;padding-left:15px;"><li id="add_AD'+number+'">'+
				'<select name="" id="ADregion'+number+'" onchange="AD_change('+number+',this);" class="type-select" style="width:250px"></select>'+
				'<i class="ctrl add" style="margin-left:5px" onclick="addinput(this)"></i></li></div></div>');
		$('.type-select').select2();
		AD_add(number);
		var DomainId=$("#ADregion"+number+"").val();
		test.push(DomainId);
	}
}
//检查数据完整性
function check_data(num){
	var DomainId=$("#ADregion"+num+"").val();
	var Name=$("#Name"+num+"").val();
	var add=1;
	if (Name == ""){
		_alert(2, "主机账号","请输入账号",$("#Name"+num+""));
		add=0;
		return false;
	}

	if(patch(Name,"@") <= 1){
		if(!acc_namereg.test(Name)){
			_alert(1, "主机账号","账号格式不正确",$("#Name"+num+""));
			add=0;
			return false;
		}
	}else{
		_alert(1, "主机账号","账号格式不正确",$("#Name"+num+""));
		add=0;
		return false;
	}

	$.each(AccountData,function(i1,item1){
		if ((Name == item1.Name && DomainId == item1.DomainId)||(Name == item1.Name &&DomainId==0&&item1.DomainId==null)){
			add = 0;
			_alert(1, "主机账号","相同的账号已存在",$("#Name"+number+""));
		}
	});
	if(id_list.length>1){
		var endid=number;
		var endName = $("#Name"+endid+"").val().trim();
		var endDomainId=$("#ADregion"+endid+"").val();
		for(var i=0;i<id_list.length-1;i++)
		{
			if(endName==$("#Name"+id_list[i]+"").val().trim() && endDomainId == $("#ADregion"+id_list[i]+"").val())
			{
				_alert(1, "主机账号","相同的账号已存在",$("#Name"+endid+""));	
				add=0;
				return false;
			}
		}
	}
	if(add==1){
		return true;
	}else{
		return false;
	}
}
//检查数据的格式
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
function NameCheck(obj){
	var name = $(obj).val();
	var $i = $(obj).next('i.v-check');
	if (!nameReg.test(name)){
		$i.show().attr('class','v-check v-wrong');
	}else{
		$i.show().attr('class','v-check v-right');
	}
}
var nameReg1 = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.@]+$/;
function NameCheck1(obj){
	var name = $(obj).val();
	var $i = $(obj).next('i.v-check');
	if(patch(name,"@") <= 1){
		if (!nameReg1.test(name)){
			$i.show().attr('class','v-check v-wrong');
		}else{
			$i.show().attr('class','v-check v-right');
		}
	}else{
	  $i.show().attr('class','v-check v-wrong');
	}	
}
//---------------------------秘钥编辑
function _addNew3(obj,type){
	editkey1 = obj;
	editkey2 = type;
	clear_sshkey();
	sshkey = {
		"SshKeyId": 0,
		"KeyName": null,
		"KeyType": 0,
		"KeyContent": null,
		"IfValid": false,
		"Password":null
	};	
	if(type == 0){
		SshKeyId = 0;
	}else{
		SshKeyId = $(obj).children('span').attr('data-value');
		sshkey.SshKeyId = SshKeyId
		editKey(SshKeyId);
	}

	var $dialogCont = $("#SSHKeyDialog").show();
	$('.type-select').select2();
	title = "密钥";
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"SSHKeyDialog",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(10);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var p_id = $("#Protocol1").val();
		var val = $("#d_n1").val();
		var $i = $("#d_n1").next('i.v-check');
		//事件告警信息名
		if (val == "") {
			_alert(2, "密钥", '请输入名称', $("#d_n1"));
			return false;
		}
		if (!nameReg.test(val)) {
			_alert(1, "密钥", '名称格式不正确', $("#d_n1"));
			//$("#d_n1").val("");
			return false;
		}
		sshkey.KeyName = val;
		var Password=$('#Password').val().trim();
		var Password_two=$('#Password_two').val().trim();
		if(Password.length > 64){
			_alert(2, "密钥", "密码不能超过系统限定64位", $("#Password"));
			return false;
		}
		if(Password==''){
			Password=null;
		}else if(Password!=Password_two){
				_alert(2, "密钥","两次密码不匹配",$("#Password_two"));
				return false;
		}
		sshkey.Password=Password;
		var content = $("#content").val();
		// var keycheck = /^[a-zA-Z0-9/+=\s\-]*$/g;
		var keycheck = /^[\u4e00-\u9fa5]*$/g;
		if(content==""){
			_alert(2, "密钥", '请填写密钥内容', $("#content"));
			return false;
		}
		if(keycheck.test(content)){_alert(1, "密钥", '密钥格式不正确', $("#content"));return}
		if($("#d_n1").val().length>32) {
			_alert(1, "密钥", '密钥名称已达到最大值', $("#d_n1"));
			return false;
		}
		// if($("#Enable").is(':checked')){
		// 	sshkey.IfValid = true;
		// }else{
		// 	sshkey.IfValid = false;
		// }
		sshkey.KeyContent = content;
		sshkey.KeyType = parseInt(p_id);
		var msstr = aceg(JSON.stringify(sshkey),$("input[name=se]").val());
		$.ajax({
			url: '/bhost/add_sshkey_host',
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val(), a1: JSON.stringify(sshkey), a10: "运维管理>主机管理",m1:msstr},
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result == true) {
					$('.btn').blur(); parent.layer.open({
						type: 1,
						title: '密钥',
						content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							d.close().remove();
							parent.layer.close(i);

							var id_str = $("#SSHkey_s").data('value');
							var name_str = $("#SSHkey_s").children().find('span').text();
							if(name_str == '请选择'){
								bind_SSHkey_xSelect();
								$("#SSHkey_s").data('value',result.SshKeyId);
								$("#SSHkey_s").children().find('span').text(val);
							}else{
								bind_SSHkey_xSelect();
								$("#SSHkey_s").data('value',id_str);
								$("#SSHkey_s").children().find('span').text(name_str);
							}
						}
					});
				} else {
					_alert(1, "密钥管理", result.ErrMsg, $("#d_n1"));
					return false;
				}
			}
		});
	})
}
function clear_sshkey(){
	$("#d_n1").val("");
	$("#d_n1").attr("disabled",false);
	$("#SSHKeyDialog .v-check").attr("class","v-check");
	$("#Protocol1").val("1").trigger('change');
	$("#Protocol1").attr('disabled','true');
	$('#Password').val('');
	$('#Password_two').val('');
	$("#Enable").iCheck('uncheck');
	$("#content").val("");
}
function editKey(id){
	$.ajax({
		url: '/bhost/get_sshkey',
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(), a1: id, a2: null},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result == true) {
				key_Data = result.info.data[0];
				$("#d_n1").val(key_Data.KeyName);
				$('#d_n1').attr('disabled',true);
				$('#Password').val(key_Data.Password);
				$('#Password_two').val(key_Data.Password);
				$("#content").val(key_Data.KeyContent);
			} else {
				_alert(1, "密钥管理", result.ErrMsg, $("#d_n1"));
				return false;
			}
		}
	});
}
//---------------------------账号编辑
function _addNew1(obj,type){
	editAcc1 = obj;
	editAcc2 = type;
	clear_acce();
	if(type == 0){
		json_acc={
			"AccountId":0,
			"Name":null,
			"DomainId":0,
			"AccountName":null,
			"DomainName":null,
			"AccountType":1			
		};
		$("#ADregion0").attr("onchange","AD_change(0,this)");
		accountid = 0;
	}else{
		accountid = $(obj).children('span').attr('data-value');
		$("#ADregion0").attr("onchange","");
	}
	all_account();
	AD_add(number);
	id_list.push(number);
	var adregion_old = 0;
	if (parseInt(accountid) != 0){
		$("#edit_hide").hide();
		$("#check"+number+"").hide();
		$.each(AccountData,function(i1,item1){
			if (accountid == item1.AccountId){
				$("#Name0").val(item1.Name);
				adregion_old = item1.DomainId;
				if(item1.DomainId == null){
					test=[];
					$("#ADregion0").val(0).trigger('change');
				}else{
					$("#ADregion0").val(item1.DomainId).trigger('change');
					if($("#ADregion0 option:selected").text() == ""){
						$("#ADregion0").val(0).trigger('change');
					}
				}
			}
		});
		if(accountid >0 && accountid <8){
			$("#ADregion0").prop("disabled","true");
		}
		$("#Name0").prop("disabled","true");
	}
	var DomainId=$("#ADregion"+number+"").val();
	test.push(DomainId);

	var $dialogCont = $("#AccEditDialog").show();
	$('.type-select').select2();
	if(type == 0)  title = "主机账号"
	else title = "主机账号"
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"AccEditDialog",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(6);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function()
	{
		var adregion_new;
		if($("#ADregion0").val() == 0){
			adregion_new = null;
		}else{
			adregion_new = $("#ADregion0").val();
		}
		if(adregion_new != adregion_old && type != 0){
			// parent.layer.open({
			// 	type:1,
			// 	title:"主机",
			// 	content:'<div class="layer-alert"><i class="alert warning"></i>该账号可能应用于其他主机，是否修改</div>',
			// 	btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
			// 	btnAlign:'c',
			// 	closeBtn: false,
			// 	skin:'layer-custom',
			// 	area:['380px','310px'],
			// 	move: false,
			// 	resize: false,
			// 	btn1:function(i){
			// 		parent.layer.close(i);
					var account_list1 = [];
					var flag_data=true;
					var endid=number;
					if($("#Name"+number+"").val() == "" && id_list.length>1){	
						id_list.pop();
					}else{
						if(accountid==0){
							flag_data=check_data(endid);
							if(flag_data==false){
								return false;
							}
						}
					}
					var Name;
					var Adregion = '';
					for(var i=0;i<id_list.length;i++){
						Name=$("#Name"+id_list[i]+"").val().trim();
						var DomainId=parseInt($("#ADregion"+id_list[i]+"").val());
						var DomainName=null;
						if(DomainId == 0 || DomainId == null){
							DomainId=null;
							var AccountName=null;
							var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
						}else{
							var AccountName=$("#ADregion"+id_list[i]+" option:selected").text();
							Adregion = AccountName;
							accountid=parseInt(accountid);
							var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
						}
						account_list1.push(Account_data);
					}			
					var msstr = aceg(JSON.stringify(account_list1),$("input[name=se]").val());
					$.ajax({
						url:'/bhost/save_account',
						type: "post",
						async:false,
						data: {a0:$("input[name=se]").val(),d5:JSON.stringify(account_list1),a10:"运维管理>主机",m1:msstr},
						success: function(Result) {
							data = JSON.parse(Result);
							if(data.Result){
								$('.btn').blur();parent.layer.open({
										type:1,
										title: '主机账号',
										content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
										btn:['确&nbsp;&nbsp;定'],
										btnAlign:'c',
										closeBtn: false,
										skin:'layer-custom',
										area:['380px','310px'],
										move: false,
										resize: false,
										yes:function(i){
											d.close().remove();
											parent.layer.close(i);

											var id_str = $("#AccountName").data('value');
											var name_str = $("#AccountName").children().find('span').text();
											if(name_str == '请选择'){
												bind_Acc_xSelect();
												$("#AccountName").data('value',data.AccountId);
												$("#AccountName").children().find('span').text(Adregion+"/"+Name);
											}else{
												bind_Acc_xSelect();
												$("#AccountName").data('value',id_str);
												$("#AccountName").children().find('span').text(Adregion+"/"+Name);
											}
										}
									});	
							}else{
								_alert(1, "主机账号",'相同的账号已存在');
								return false;
							}
						}
					});
			// 	},
			// 	btn2:function(i){
			// 		parent.layer.close(i);
			// 		return false;
			// 	}
			// });
		}else{
			var account_list1 = [];
			var flag_data=true;
			var endid=number;
			if($("#Name"+number+"").val() == "" && id_list.length>1){
				id_list.pop();
			}else{
				if(accountid==0){
					flag_data=check_data(endid);
					if(flag_data==false){
						return false;
					}
				}
			}
			var Name;
			var Adregion = '';
			for(var i=0;i<id_list.length;i++){
				Name=$("#Name"+id_list[i]+"").val().trim();
				var DomainId=parseInt($("#ADregion"+id_list[i]+"").val());
				var DomainName=null;
				if(DomainId == 0 || DomainId == null){
					DomainId = null;
					var AccountName=null;
					var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
				}else{
					var AccountName=$("#ADregion"+id_list[i]+" option:selected").text();
					Adregion = AccountName;
					accountid=parseInt(accountid);
					var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
				}
				account_list1.push(Account_data);
			}
			var msstr = aceg(JSON.stringify(account_list1),$("input[name=se]").val());
			$.ajax({
				url:'/bhost/save_account',
				type: "post",
				async:false,
				data: {a0:$("input[name=se]").val(),d5:JSON.stringify(account_list1),a10:"运维管理>主机",m1:msstr},
				success: function(Result) {
					data = JSON.parse(Result);
					if(data.Result){
						$('.btn').blur();parent.layer.open({
								type:1,
								title: '主机账号',
								content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
								btn:['确&nbsp;&nbsp;定'],
								btnAlign:'c',
								closeBtn: false,
								skin:'layer-custom',
								area:['380px','310px'],
								move: false,
								resize: false,
								yes:function(i){
									d.close().remove();
									parent.layer.close(i);

									var id_str = $("#AccountName").data('value');
									var name_str = $("#AccountName").children().find('span').text();
									if(name_str == '请选择'){
										bind_Acc_xSelect();
										$("#AccountName").data('value',data.AccountId);
										if(Adregion = ""){
											$("#AccountName").children().find('span').text(Name);
										}else{
											if(Adregion =='') $("#AccountName").children().find('span').text(Name);
											else	$("#AccountName").children().find('span').text(Adregion+"/"+Name);
										}
									}else{
										bind_Acc_xSelect();
										$("#AccountName").data('value',id_str);
										if(Adregion =='') $("#AccountName").children().find('span').text(Name);
										else	$("#AccountName").children().find('span').text(Adregion+"/"+Name);
									}
								}
							});	
					}else{
						_alert(1, "主机账号",'相同的账号已存在');
						return false;
					}
				}
			});
		}
	})
}

function _hideView(t,obj){
	if(t == 0){
		$(connparm_list).each(function(i,item){
			$("#ConnParamName").attr('_id',"");
			if(item.ConnParamName == $("#ConnParamName").val()){
				$("#ConnParamName").attr('_id',item.ConnParamId);
				return false;
			}
			if($(obj).attr("_id") == ""){
				$(obj).val("");
			}
		})	
	}
	if(t == 1){
		$(AccountData).each(function(i,item){
			$("#AccountName").attr('_id',"");
			if(item.AccountName == $("#AccountName").val()){
				$("#AccountName").attr('_id',item.AccountId);
				return false;
			}
		})
		if($(obj).attr("_id") == ""){
			$(obj).val("");
		}
	}
	// if(t == 2){
	// 	$(AccountData).each(function(i,item){
	// 		$("#FromAccount_acc").attr('_id',"");
	// 		if(item.AccountName == $("#FromAccount_acc").val()){
	// 			$("#FromAccount_acc").attr('_id',item.AccountId);
	// 			return false;
	// 		}
	// 	})
	// 	if($(obj).attr("_id") == ""){
	// 		$(obj).val("");
	// 	}
	// }	
	if(t == 3){
		$(accIP_list.data).each(function(i,item){
			$("#select_accIP").attr('_id',"");
			if(item.AccIP == $("#select_accIP").val()){
				$("#select_accIP").attr('_id',item.AccIPId);
				return false;
			}
		})	
	}
	$(document)[0].onclick = function(){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
	}
}

function _setVal(t,t1){
	var val = $(t).text();
	$($focusObj).val(val);
	$($focusObj).attr('_id',$(t).attr('id'));
	$view = $('#autoView');
	$view.hide();
	var $item = $focusObj.parents('div.g-title').next('div.g-cont').find('div.forName');
	var $item2 = $focusObj.parent().next('input.forName');
	$item.hide();
	$item2.hide();
	if(t1 == 2){
		var t = $(t).text();
		if (t == "*") {
			$("#password1").prop("disabled", true);
			$("#password2").prop("disabled", true);
			$("#password1").val("");
			$("#password2").val("");
			$("#if_emptypwd").iCheck('uncheck');
			$("#if_emptypwd").iCheck('disable');
		} else {
			$("#password1").prop("disabled", false);
			$("#password2").prop("disabled", false);
			$("#if_emptypwd").iCheck('uncheck');
			$("#if_emptypwd").iCheck('enable');
		}
	}
}


//添加AD域 -------------------//账号编辑
function AD_add(num){
	$("#ADregion"+num+"").empty().append("<option value=\"0\" >请选择AD域</option>");
	$.ajax({
		url:'/bhost/get_ADregion',
		type:'post',
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			domian_data=JSON.parse(result);
			$.each(domian_data.data,function(i,item){
				$("#ADregion"+num+"").append("<option value=\""+item.DomainId+"\" >"+item.DomainName+"</option>");
			});
		}
	});
}

//AD域再次变化判断 -------------------//账号编辑
function AD_change(num,obj){
	setTimeout(function(){
		if(num==0&&test.length==1&&accountid==0){
			var DomainId=$("#ADregion"+number+"").val();
			test[num]=DomainId;
			var changeName = $("#Name"+num+"").val().trim();
			var changeDomainId=$("#ADregion"+num+"").val();
			$.each(AccountData,function(i1,item1){
				if (changeName == item1.Name && changeDomainId == item1.DomainId){
					$("#ADregion"+num+"").val(0).trigger('change');
					_alert(1, "主机账号","相同的账号已存在",$("#Name"+num+""));
					return false;
				}
			});
		}
		if(num<number){
			var flag=true;
			var changeName = $("#Name"+num+"").val().trim();
			var changeDomainId=$("#ADregion"+num+"").val();
			$.each(AccountData,function(i1,item1){
				if ((changeName == item1.Name && changeDomainId == item1.DomainId)||(changeName == item1.Name &&changeDomainId==0&&item1.DomainId==null)){
					flag=false;
					$("#ADregion"+num+"").val(test[num]).trigger('change');
					_alert(1, "主机账号","相同的账号已存在",$("#Name"+num+""));
				}
			});
			if(id_list.length>1){
				for(var i=0;i<id_list.length;i++)
				{
					if(changeName==$("#Name"+id_list[i]+"").val().trim() && changeDomainId == $("#ADregion"+id_list[i]+"").val() && id_list[i]!=num)
					{	
						flag=false;
						$("#ADregion"+num+"").val(test[num]).trigger('change');
						_alert(1, "主机账号","相同的账号已存在");	
						return false;
					}
				}
			}
			if(flag && num!=0){
				test[num]=changeDomainId;
			}
		}	
		if(num==number&&num>0){
			if(test[num]==0&&adc==0){
				var flag=true;
				var changeName = $("#Name"+num+"").val().trim();
				var changeDomainId=$("#ADregion"+num+"").val();
				$.each(AccountData,function(i1,item1){
					if (changeName == item1.Name && changeDomainId == item1.DomainId){
						flag=false;
						$("#ADregion"+num+"").val(0).trigger('change');
						_alert(1, "主机账号","相同的账号已存在",$("#Name"+num+""));
					}
				});
				if(id_list.length>1){
					for(var i=0;i<id_list.length-1;i++)
					{
						if(changeName==$("#Name"+id_list[i]+"").val().trim() && changeDomainId == $("#ADregion"+id_list[i]+"").val())
						{	if($("#ADregion"+id_list[i]+"").val()==0){
								adc=adc+1;
								return false;
							}
							flag=false;
							$("#ADregion"+num+"").val(0).trigger('change');
							_alert(1, "主机账号","相同的账号已存在");	
							return false;
						}
					}
				}
				if(flag && num!=0){
					test[num]=changeDomainId;
				}
			}else{
				var flag=true;
				var changeName = $("#Name"+num+"").val().trim();
				var changeDomainId=$("#ADregion"+num+"").val();
				$.each(AccountData,function(i1,item1){
					if (changeName == item1.Name && changeDomainId == item1.DomainId){
						flag=false;
						adc1=1;
						$("#ADregion"+num+"").val(test[num]).trigger('change');
						_alert(1, "主机账号","相同的账号已存在",$("#Name"+num+""));
					}
				});
				if(id_list.length>1){
					for(var i=0;i<id_list.length-1;i++)
					{
						if(changeName==$("#Name"+id_list[i]+"").val().trim() && changeDomainId == $("#ADregion"+id_list[i]+"").val() && id_list[i]!=num)
						{
							if(adc1==0){
								adc=0;
								flag=false;
								$("#ADregion"+num+"").val(test[num]).trigger('change');
								_alert(1, "主机账号","相同的账号已存在");	
								return false;
							}else{
								adc1=0;
								return false;
							}
						}
					}
				}
				if(flag && num!=0){
					test[num]=changeDomainId;
				}
			}
		}
	},1);
}



/// AD域 可编辑 浮层
function clear_ad(){
	$('#ad_n').val('').removeAttr("disabled");
	$('#ip_n span.ss').each(function(i,item){
		if(i == 0) return true;
		$(this).remove();
	})
}
function _addNew2(obj,type) {
	clear_ad();
	var $dialogCont = $("#ADDialog").show();
	if(type == 0)  title = "AD域";
	else title = "AD域";
	
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "ADDialog",
		width: "800px"
	});
	var DomainId = 0
	if(type == 1){
		DomainId = $(obj).next('a').attr('id');
		$.ajax({
			url: "/bhost/get_domain_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:DomainId},
			success:function(result){
				var domain_result = JSON.parse(result);
				if (domain_result.Result==true){
					var domain_data = domain_result.info.data[0];
					$("#ad_n").val(domain_data.DomainName);
					$("#ad_n").attr("disabled",true);
					var domain_data_ip = domain_data.ServerIP.split(";");
					$.each(domain_data_ip,function(i,item){
							var $c = $('<span class="ss" style="padding: 0 0 10px 0;" />');
							$c.html('<input type="text" class="form-text form-text2" value="'+item+'" disabled="true" style=""><i class="ctr ctr-del" style="margin-top: 6px;margin-left: -5px;" onclick="_delIp(this)"></i>');
							$("#ip_n").find("span[class='ss ss-add']").after($c);
					});
				}
			}
		});
	
	}
	
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		d.close().remove();
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		var _nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		if(type == 0){
			domain={
				"DomainId":0,
				"DomainName":"",
				"ServerIP":""
			};
		}
		var pass =1;
		var val = $("#ad_n").val();
		var $i = $("#ad_n").next('i.v-check');
		if(val==""){
			_alert(2, "主机",'请输入名称',$("#d_n"));
			return false;
		}
		if(!_nameReg.test(val)){
			_alert(1, "主机",'名称格式不正确',$("#d_n"));
			return false;
		}
		var input_str=$("#ip_n").find("span[class='ss ss-add']").children("input").val();
		if(!ipReg.test(input_str) && input_str!=""){
			_alert(1, "主机",'IP格式不正确',$("#ip_n").find("span[class='ss ss-add']").children("input"));
			//$("#ip_n").find("span[class='ss ss-add']").children("input").val("");
			return false;
		}else{
			$(">span[class='ss']","#ip_n").each(function(){
				ip_str=$(this).find("input").val();
				if (ip_str==input_str){
					_alert(2, "主机",'IP重复',$("#ip_n").find("span[class='ss ss-add']").children("input"));
					//$("#ip_n").find("span[class='ss ss-add']").children("input").val("");
					pass=0;
					return false;
				}
			});
			if (!$('#ip_n').find('span[class=ss]').length && input_str==""){
				_alert(2, "主机","请输入IP",$("#ip_n").find("span[class='ss ss-add']").children("input"));
				return false;
			}
		}
		
		if(pass==1){
			var ip_str="";
			var $all=$('#ip_n').find('span[class=ss]');
			var len=$all.length;
			for(var j=len-1;j>=0;j--){
				ip_str=ip_str+$all.eq(j).find("input").val()+";";
			}
			if(input_str!=""){
				ip_str=ip_str+input_str;
			}else{
				ip_str=ip_str.substr(0,ip_str.length-1)
			}
			domain.DomainId=DomainId;
			domain.DomainName=val;
			domain.ServerIP=ip_str;
			var msstr = aceg(JSON.stringify(domain),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_domain',
				type: "POST",
				async:false,
				data: {a0:$("input[name=se]").val(),a1:JSON.stringify(domain),m1:msstr},
				success: function(result) {
					var result = JSON.parse(result);
					if(result.Result == true){
						$('.btn').blur();parent.layer.open({
							type:1,
							title: '主机',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:['确&nbsp;&nbsp;定'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							yes:function(i){
								parent.layer.close(i);
								$.ajax({
									url: '/bhost/get_DomainName_list',
									type: "post",
									async: false,
									cache: false,
									data: { a0: $("input[name=se]").val() },
									success: function (Result) {
									DomainName_list = (JSON.parse(Result)).data;
									}
								})
								_autoView('#AccountName',2,2);
								//$('#DomainName').blur();
							}
						});	
					}else{
						_alert(1, "主机",result.ErrMsg,$("#d_n"));
						return false;
					}
				}
			});
		}
		d.close().remove();
	})
}

//删除服务器ip
function _delIp(obj){
	var $c = $(obj).parent();
	$c.fadeOut(function(){
				$c.remove();
			});
}
//input回车触发事件
function showMsg(obj){
	var code = event.keyCode;
	if(code == 13){
		_addIp($(obj).next('i'));
	}
}
var ipReg = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])(\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])){3}$/;
//加入服务器ip
function _addIp(obj){
	var pass =1;
	var v = $(obj).prev('input').val().trim();

	if(v==''){
		_alert(2, "主机",'请输入IP',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	}else if(!ipReg.test(v)){
		_alert(1, "主机",'IP格式不正确',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	}else{
		$(">span[class='ss']","#ip_n").each(function(){
			ip_str=$(this).find("input").val();
			if (ip_str==v){
				_alert(2, "主机",'IP重复',$(obj).prev('input'));
				//$(obj).prev('input').val("");
				pass=0;
				return false;
			}
		});
	}
	if(pass==1){
		var $c = $('<span class="ss"  style="padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text form-text2" value="'+v+'" disabled="true" style=""><i class="ctr ctr-del" style="margin-top: 6px;margin-left: -5px;" onclick="_delIp(this)"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').focus();
	}
}
var domain={
		"DomainId":0,
		"DomainName":"",
		"ServerIP":""
};
function pName_change(){
	if ($("#ProtocolName").data('value') == 2 || $("#ProtocolName").data('value') == 8 || $("#ProtocolName").data('value') == 15){
		jump_clear();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(9).show();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(6).show();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(7).show();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(8).show();
		$("#FromHostName").parents('div.form-item').show();
		$("#FromHostServiceName").parents('div.form-item').show();
		$("#FromAccountName").parents('div.form-item').show();
		$("#FromLoginCmd").parents('div.form-item').show();
	}else{
		jump_clear();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(9).hide();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(6).hide();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(7).hide();
		// $("#ProtocolName").parent().parent().children('.form-item').eq(8).hide();
		$("#FromHostName").parents('div.form-item').hide();
		$("#FromHostServiceName").parents('div.form-item').hide();
		$("#FromAccountName").parents('div.form-item').hide();
		$("#FromLoginCmd").parents('div.form-item').hide();
	}
}
function jump_clear(){
	$("#FromHostName").val("").trigger('change');
	$("#FromHostServiceName").val("").trigger('change');
	$("#FromAccountName").val("").trigger('change');
	$("#FromLoginCmd").val("");
}

/*
Functions about the tree search result!
*/
function click_h(){
	$("#hostTree").find('span.h-name-red').find('.font-red').removeClass('font-red');
	$('#hostTree').find('span.h-name-red').removeClass('h-name-red');
	$('#hostTree').find('ul').hide();
	$('#hostTree').find('li').hide();
	$('#hostTree').find('i.h-aicon-d').trigger('click');
}
var _jScrollBar_array = [];
function _jScrollBar(scid) {
	var myBar = new MyScrollBar({
		selId:scid,
		hasX:true,
		hasY:false,
		width:6,
		// enterShow:false,
	})
}
var path_all;
function find_hostgroup(){
	$('#hostTree').find('li').show();
	click_h();
	$('#hostTree').find('li').hide();
	var server_find_json={
		"loginusercode": null,
		"hgid": 0,
		"istree": true,
		"hgname": "",
		"hostname": "",
		"hostip": "", 
		"limitrow":null,
		"offsetrow":null
	}
	usercode = window.document.frm.us.value;
	var hgname_str='';
	$.each(search_typeall_r.split('\t'),function(i,item){
		if(item=='' || item==null){
			return true;
		}
		var item_id=item.indexOf('-');
		switch(item.substr(0,item_id)){
			case 'hgname':
				hgname_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
			case '0':
				hgname_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
		}
	});
	hgname_str=hgname_str.substr(0,hgname_str.length-1);
	server_find_json.hgname=hgname_str;
	server_find_json.loginusercode=usercode;
	if (hgname_str == ""){
		$('#hostTree').find('li').show();
		return false;
	}
	_getWait($(".waitTip1"));
	$.ajax({
		url: '/bhost/find_hostgroup',
		type: "POST",
		async: true,
		data: {a0: $("input[name=se]").val(),a1:JSON.stringify(server_find_json)},
		success: function(result){
			result = JSON.parse(result);
			result = result.info;
			if (result == null){
				$("#server_text").blur();
				_waitDone($(".waitTip1"));
				$('#hostTree').find('li').hide();
				_alert(0,'搜索','无搜索结果',$("#server_text"));
				return false;
			}
			path_all = result;
			if (path_all.length != 0){
				$.each(path_all,function(i,item){
					var Path_array=item.Path.split('/');
					var len=Path_array.length;
					for(var j=1;j<len-1;j++){
						var id=Path_array[j].split(',')[1];
						$i_item=$('#node-'+id).siblings('i.h-aicon');
						if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
							$i_item.parent('li').show();
							$i_item.trigger('click');
							$i_item.siblings('ul').find('li').hide();
						}
					}
					if(item.Type==1){
						$('#node-'+item.Id).parent('li').show();
						$('#node-'+item.Id).siblings('span.h-name').addClass('h-name-red');					
						
						var $span_son_font=$('#node-'+item.Id).siblings('span.h-name').find('font')
						var span_son_name=$('#node-'+item.Id).attr('data-name').toLowerCase();
						$.each(search_typeall_r.split('\t'),function(i1,item1){
							if(item1=='' || item1==null){
								return true;
							}
							var index=item1.indexOf('-');
							switch (item1.substring(0,index)) {
								case 'hgname':
								case '':
								case '0':
									$.each(item1.substring(index+1).split(' '),function (i_s,params_s) {
										params_s=params_s.toLowerCase();
										var index_true=span_son_name.indexOf(params_s);
										if(index_true>=0){
											for(var i_red_span=index_true;i_red_span<index_true+params_s.length;i_red_span++){
												$span_son_font.eq(i_red_span).addClass('font-red');
											}
										}
									});
									break;
							}
						});
						
					}
				})
				li_hide_while_no_red_1($('#hostTree'),0);
				scrollTop_check_server();
			}else{
				$("#server_text").blur();
				_waitDone($(".waitTip1"));
				_alert(0,'搜索','无搜索结果',$("#server_text"));
			}
		}
	});
}
function li_hide_while_no_red_1(obj,num){
	var li_visible=$(obj).children('li');
	var _len=li_visible.length
	if(num<_len){
		var item=li_visible.eq(num);
		if($(item).children('span.h-name-red').length!=0){
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
		}else if($(item).find('span.h-name-red').length==0){
			$(item).hide();
		}else{
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
			var $children_ul=$(item).children('ul');
			if($children_ul.length>0){
				setTimeout(function(){
					li_hide_while_no_red_1($children_ul,0);
				},1);
			}
		}
	}
	var item_1=li_visible.eq(num+1);
	if(item_1.length!=0){
		setTimeout(function(){
			li_hide_while_no_red_1(obj,num+1);
		},1);
	}
}
function scrollTop_check_server(){
	$('.c-cont').scrollTop(0);
	if(path_all.length!=0){
		var top=9007199254740992;
		$.each(path_all,function(i,item){
			if(item.Type==1){
				var top_item=$('#node-'+item.Id).offset().top;
				if(top_item<top){
					top=top_item;
				}
			}
		});
		$('.c-cont').scrollTop(top+300);
		_waitDone($(".waitTip1"));
	}
}
function _getWait(obj){
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
	
	$(obj).removeClass('done').show().unbind().on('mouseover',function(){
		waitlayer = layer.tips('搜索中',this,{
			tips:1,
			time:0,
			skin: 'waitlayer'
		});
	}).on('mouseout',function(){
		if(typeof waitlayer != 'undefined'){
			layer.close(waitlayer);
		}
	});
}
function _waitDone(obj){
	if(typeof waitlayer != 'undefined'){
		layer.close(waitlayer);
	}
	$(obj).fadeOut(3000);
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
}
var serverID;
var editcp1, editcp2;
var accountID;
var connTest1, connTest2;
var editAcc1, editAcc2;
/*
1:主机 2:服务浮层 3:账号浮层 4:accip 5:conn test 6:edit acc
*/
function reload(type){
	if(type == 1){
		location.reload();
	}else if(type == 2){
		if(serverID == 0){
			_getDialog1('add','');		
		}else{
			_getDialog1('edit',serverID);
		}
	}else if(type == 3){
		if(accountID == -1){
			_getDialog2('add',0);		
		}else{
			var obj = $("#service_account_list").children('tr').eq(accountID).children().find('.edit');
			_getDialog2('edit',$(obj));
		}
	}else if(type == 4){
		$("#accip_input").val("");
	}else if(type == 5){
		_getDialog_connectTest(connTest1,connTest2);
	}else if(type == 6){
		_addNew1(editAcc1,editAcc2);
	}else if(type == 7){
		_addNew(editcp1,editcp2);
	}else if(type == 8){
		_addNew3(editkey1,editkey2);
	}

}
/*
*/

///批量价主机
function batch(){
	batch_start = parseInt($("#batch_start").val());
	batch_end = parseInt($("#batch_end").val());
	if(batch_start >= batch_end){
		_alert(1, "主机",'开始不能大于结束');
		return false;
	}
	
	$.ajax({
		url: "/bhost/add_host_batch",
		type: "POST",
		async: false,
		data: { a0: batch_start, a1: batch_end},
		success: function (result) {
			var result = JSON.parse(result);
		}
	})
}
function check_hostLimit(){
	$.ajax({
		url: "/bhost/exceed_hostLimit",
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val()},
		success: function (result) {
			var result = JSON.parse(result);
			if(result.Result == false){
				layer.open({
					type: 1,
					title: "主机",
					content: '<div class="layer-alert"><i class="alert fail"></i>'+result.ErrMsg+'</div>',
					btn: '确&nbsp;&nbsp;定',
					btnAlign: 'c',
					closeBtn: false,
					skin: 'layer-custom',
					area: ['380px', '310px'],
					move: false,
					resize: false,
					btn1: function (i) {
						layer.close(i);
						document.frm.tasktype.value = 3;
						document.frm.se.value = window.parent.document.frm.se.value;
						document.frm.us.value = usercode;
						document.frm.action = '/bhost/index';
						document.frm.i10.value = 1;
						document.frm.submit();
					}
				});
			}
		}
	})
}
function patch(s, re) {
	re = eval("/" + re + "/ig")
	return s.match(re) ? s.match(re).length : 0;
}
</script>

{% endblock %}
