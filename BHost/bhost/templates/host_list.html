{% extends  "index.html" %}
{% block head %}
	<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
	<script src="/manage/js/xSelect.js"></script>
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/G-style.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<script src="/manage/js/my_scrollbar.js"></script>
	
{% endblock  %}

{% block main %}
	<!---->
		<div class="mainer" id="_HostList">
			<div class="container">
				<div class="c-top">
					<div class="manual-head">
						<div class="manual-title-other title-item" id="frist">
							<span onclick="reload(7);">主机管理</span>
							<i class="hostm_icon"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="host_test();">连接测试</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="find_host();">发现主机</span>
							<i style="display: none;"></i>
						</div>						
					</div>
				</div>
				<div class="c-wrap" style="padding: 10px 0 0;overflow:auto;">
					<div class="c-exp">
						<div class="h-explorer">
							<div class="h-top h-top1">
								<div class="h-route" id="hostRoute"></div>

								<div class="filter filter1" style="float:right;min-width:auto;">
									<div id="waitTip" class="waitTip" style="float: right;margin-top: 7px; margin-left: -26px;"></div>
									<div class="search">
										<select name="find_select" id="find_select" class="filter-select" style="height: 27px;">
											<option value="all" selected>所有</option>
											<option value="hgname">主机组名</option>
											<option value="hostname">主机名</option>
											<option value="hostip">主机IP</option>
											<option value="devicetypename">设备类型</option>
											<option value="hostservicename">主机服务名</option>
											<option value="accountname">账号</option>
											<option value="protocolname">协议</option>
										</select>
										<input type="text" class="filter-text" id="filte_value" onmouseover="" placeholder="输入关键字" style="border-left: 0px;padding-right: 22px;" 
										onchange="if($('#filte_value').val()!=''){$('#v_clear').show();}else{$('#v_clear').hide();};" onkeydown="if($('#filte_value').val()!=''){$('#v_clear').show();}else{$('#v_clear').hide();};if (event.keyCode == 13){_addFilterFuzzy(this,false);return false;} else return;" onkeyup="if($('#filte_value').val()!=''){$('#v_clear').show();}else{$('#v_clear').hide();};"
										onblur="change_input_list(this);return false;"
										>
										<i style="display:none;cursor: pointer;" class="v-check v-wrong" id="v_clear" onclick="_clearFilter(this,1)"></i>
										<button class="filter-btn" onclick="_addFilterFuzzy(this,false)"><i class="add-filter"></i></button>
										<button class="filter-btn" onclick="_addFilterFuzzy(this,true)"><i class="append-filter"></i></button>
									</div>
									<div class="search" id="clearFilter" style="margin: 0px 15px 0px -16px;display:none;">
										<button class="filter-btn" onclick="_clearFilter(this)"><i class="clear-filter"></i></button>
									</div>
									<div class="selector" id="filterWW" style="display: none;">
										<span class="ww">检索条件</span>
										<ul></ul>
									</div>
									<div style="width: auto;float: right;margin-top:0px;/*margin-right:10px;*/">
										<a style="display:none;" href="javascript:;" value="0" id="first_grp" class="btn-first-grp" onclick="select_first_grp(this);">图标</a>
										<!--
										<select name="first_grp" id="first_grp" class="filter-select" style=" float: left;height: 27px;width:60px;margin-right:10px" onchange="select_first_grp(this);">
											<option value="0" selected="">图标</option>
											<option value="1">列表</option>
										</select>
										-->
									</div>
								</div>
							</div>

							<div class="h-catelog a" style="overflow: hidden !important;padding-right: 0px;">
								<div class="icon-div" style="float: right;margin-top: 10px;margin-right: 10px;">
									<i style="display:none;" class="add-manager" title="批量管理" id="btn_3"  onclick="server_add_or_clear();"></i>
									<i style="display:none;" class="add-group" title="创建主机组" id="btn_2" onclick="add_hostgrp(0);"></i>
									<i style="display:none;" class="add-host" title="创建主机" id="btn_1" onclick="add_host();"></i>
								</div>
								<a href="javascript:;" id="route-root" style="font-size: 16px;color: #4d4d4d;font-weight: bold; margin: 15px 0 10px;"><i class="h-eicon h-eicon-t-m"></i><span>所有组</span></a>
								<div class="h-catelog-son-div" style="overflow: auto;">
								<ul id="hostCatelog"></ul>
								</div>
							</div>

							<div class="h-content" id="hostContent" style="user-select: none;-moz-user-select:none;" onselectstart="return false;" unselectable="on"></div>
						</div>
					</div>
					<div class="clearfix"></div>
					<div class="btns">
						<a href="javascript:;" class="btn btn-normal s-hide" id="importHost" onclick="_import_host(1);">导&nbsp;&nbsp;入</a>						
						<a href="javascript:;" class="btn btn-normal" onclick="_export_host(2);">导&nbsp;&nbsp;出</a>
						<!--
						<a href="javascript:;" class="btn btn-normal" onclick="back_all();">返&nbsp;&nbsp;回</a>
						-->
					</div>
					<div id="bBtn" style="position: fixed;z-index:5;">
						<a href="javascript:;" class="btn" style="float: right;" onclick="back_all();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>
				</div>
				
			</div>
		</div>
		<!-- 创建、修改主机-->
		<div class="mainer" id="_Host" style="display:none">
			<div class="container" id="step1">
				<div class="manual-head">
					<div class="manual-title">
						<span onclick="reload(1);" id="host_title">修改主机</span>
						<i class="hostm_icon"></i>
					</div>					
				</div>

				<div class="c-cont">
					<div class="c-wrap" style="padding: 10px 0 0">
						<div class="c-exp" style="margin: -1px auto;">						
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp;基本信息</strong>
									<div class="G-box2">启用：
										<input type="checkbox" class="form-checkbox" name="" id="Enabled" value="" checked="checked" >
									</div>
								</div>
								
								<div class="h-content2" style="height:auto;width: 100%;overflow: hidden;padding: 14px 0 0;">
									<div class="form-item" style="">
										<span class="form-tag" style=""><em class="imp">*</em>主机IP：</span>
										<div class="form-c" style="">
									<input type="text" class="form-text" onblur="ipCheck(this)" id="HostIP" maxlength="31" style="width: 120px;"><i class="v-check"></i>
									<button class="form-button" onclick="_getDialog_pingTest();">Ping测试</button>
										</div>
									</div>
									
									<div class="form-item" style="">
										<span class="form-tag" style=""><em class="imp">*</em>主机名：</span>
										<div class="form-c" style="">
											<input type="text" class="form-text" onblur="NameCheck(this)" id="HostName" maxlength="31" style="" ><i class="v-check"></i>
											<p class="form-tip" style="padding-left: 80px;">特殊字符仅支持下划线、横杠、小数点</p>
										</div>
									</div>
									
									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em>设备类型：</span>
										<div class="form-c">
											<select class="form-select" name="" id="host_type" style="width:215px">
												<option value="" selected >请选择</option>
											</select>

											<div class="rzj" id="host_icon" >
												<i style="margin-left: 0;display:none" class="host-type host-type1 on" data= "Windows" title= "Windows" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type2 on" data= "Linux" title= "Linux" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type3 on" data= "Unix" title= "Unix" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type5 on" data= "AS400" title= "AS400" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type6 on" data= "Cisco" title= "Cisco" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type4 on" data= "H3C" title= "H3C" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type7 on" data= "Huawei" title= "Huawei" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type8 on" data= "Network" title= "Network" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type9 on" data= "Host" title= "Host" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type10 on" data= "Server" title= "Server" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type11 on" data= "Cluster" title= "Cluster" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type12 on" data= "Switchboard" title= "Switchboard" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type13 on" data= "Firewall" title= "Firewall" ></i>
												<i style="margin-left: 0;display:none" class="host-type host-type14 on" data="Aix" title="Aix"></i>
												<i style="margin-left: 0;display:none" class="host-type host-type15 on" data="Ruijie" title="Ruijie"></i>
											</div>
										</div>
									</div>
									<div class="form-item">
										<span class="form-tag" >描述：</span>
										<div class="form-c">
											<input class="form-text" name="" id="Description" maxlength="128" />
										</div>
									</div>
									
									<div class="form-item">
										<span class="form-tag">访问速度：</span>
										<div class="form-c">
											<div class="form-label-group" id="AccessRate">
												<label class="form-label"><input class="form-radio" type="radio" name="speed" id="speed1" value="0" checked>正常</label>
												<label class="form-label"><input class="form-radio" type="radio" name="speed" id="speed2" value="1">较慢</label>
												<label class="form-label"><input class="form-radio" type="radio" name="speed" id="speed3" value="2">很慢</label>
											</div>
										</div>
									</div>
									<div class="form-item" style="width: 150px; margin-left: -33px">
										<span class="form-tag" style="width: 113px;" >唯一登录：</span>
										<div class="form-c" style="" >
											<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="" id="EnableLoginLimit"></label>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="c-exp" style="margin: -1px auto;">
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp;服务</strong> 	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
									<div class="c-table">
										
										<div class="box-table">
											<table cellpadding="0" cellspacing="0" style="margin-bottom:20px;">
												<thead>
													<tr><th style="display: none;">服务名称</th>
														<th>协议(端口)</th>
														<th>连接参数</th>
														<th>应用发布</th>
														<th width="54"></th>
													</tr>
												</thead>

												<tbody id="service_list" style="height:auto">
												
												</tbody>
											</table>
										</div>
										<div class="form" >
											<div class="form-item form-item-100" style="width:100%">
												<div style="text-align: right;"><a href="javascript:;" id="" class="btn btn-normal1" onclick="_getDialog1('add','');">添&nbsp;&nbsp;加</a><!--<a href="javascript:;" class="btn btn-normal1" onclick="clear_server();">重&nbsp;&nbsp;置</a>--></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="c-exp" style="margin: -1px auto;">
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp;账号 </strong>	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
									<div class="c-table">
										
										<div class="box-table" style="/*max-height: 350px;*/">
											<table cellpadding="0" cellspacing="0" style="margin-bottom:20px;font-weight: 400;">
												<thead>
													<tr>
														<th>账号</th>
														<th>密码</th>
														<th>服务</th>
														<th>认证方式</th>
														<th width="78"></th>
													</tr>
												</thead>

												<tbody id="service_account_list">
													
												</tbody>
											</table>
										</div>
										<div class="form" >
											<div class="form-item form-item-100" style="width:100%">
												<div style="text-align: right;"><a href="javascript:;" id="" class="btn btn-normal1" onclick="_getDialog2('add',0);" style="font-weight: normal;">添&nbsp;&nbsp;加</a><!--<a href="javascript:;" class="btn btn-normal1" onclick="clear_server();">重&nbsp;&nbsp;置</a>--></div>
											</div>
										</div>
										
									</div>
								</div>
							</div>
						</div>
						<!-- <div class="c-exp" style="margin: -1px auto;" id="exp_auth" >
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp;访问授权</strong>	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
									<div class="form-item" style="width: 100%;">
										<span class="form-tag" style="width: 180px">访问授权：</span>
										<div class="h-content3" id="select_a" style="margin-top: -19px; width:80%">
										</div>
									</div>
								</div>
							</div>
						</div> -->
						<div class="c-exp" style="margin: -1px auto; margin-bottom: 10px;">
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp主机组</strong>	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 14px 0 0 0;">
								<div class="h-top" style="background-color: #fff;border-bottom:none;    float: right;width: 50%;margin-top: -16px;">
									<div class="filter" style="float:right;min-width:652px;;">
										<div id="waitTip" class="waitTip1" style="float: right;margin-top: 7px; margin-left: -26px;"></div>
										<div class="search">
											<select name="server_select" id="server_select" class="filter-select">
												<option value="0" selected>所有</option>
												<option value="hgname">组名</option>
											</select>
											
											<input type="text" class="filter-text" placeholder="输入关键字" 
											name="server_text" id="server_text" maxlength="128" style="padding-right: 22px;"
											onchange="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
											onkeyup="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
											onkeydown="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}; if (event.keyCode == 13){_addFilterFuzzy_s(this,false);return false;} else return; " 
											onblur="change_input(this);return false;"
											>
											<i class="v-check v-wrong" id="server_text_check"
											onclick="_clearFilter_s(this,1)"
											style="display:none;cursor: pointer;float: left;position: static;"></i>
											<button class="filter-btn" onclick="_addFilterFuzzy_s(this,false)"><i class="add-filter"></i></button>
											<button class="filter-btn" onclick="_addFilterFuzzy_s(this,true)"><i class="append-filter"></i></button>
										</div>
										<div class="search" id="clearFilter_s" style="margin: 0px 15px 0px -16px;display:none;">
											<button class="filter-btn" onclick="_clearFilter_s(this)"><i class="clear-filter"></i></button>
										</div>
										<div class="selector selector-multiple" id="filterWW1" style="display: none;width: 210px;">
											<span class="ww">搜索条件</span>
											<ul style="padding-left: 0px;"></ul>
										</div>
									</div>
								</div>
								<div style="overflow: auto;width:56%;height:90%;" id="hosttree_div">
									<span class="form-tag">主机组：</span>
									<ul id="hostTree" class="hosttree" style="padding-left: 110px;margin-top: 2px;"></ul>
								</div>
							</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="btns s-hide">
				<a href="javascript:;" class="btn btn-normal " onclick="savedata();" style="font-weight: 400;">保&nbsp;&nbsp;存</a>
				<!--
				<a href="javascript:;" class="btn btn-normal " onclick="back();" style="font-weight: 400;">取&nbsp;&nbsp;消</a>
				-->
			</div>
			<div id="bBtn" style="position: fixed;z-index:5;">
				<a href="javascript:;" class="btn" style="float: right;" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
			</div>
		</div>
		
		<div class="mainer" id="_HostGrp" style="display:none">
			<div class="container">
				<div class="manual-head">
					<div class="manual-title">
						<span onclick="reload(8);" id="group_title">创建主机组</span>
						<i class="hostm_icon"></i>
					</div>				
				</div>

				<div class="c-cont">
					<div class="c-form">
						<div class="form">
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>组名：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="HostGrpName" onblur="regCheck(this,/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/)" maxlength='128' ><i class="v-check"></i>
									<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag">描述：</span>
								<div class="form-c">
									<textarea class="form-textarea" name="" id="HostGrpDescription" cols="30" rows="10" maxlength='128'></textarea>
								</div>
							</div>
							<!-- <div class="form-item">
								<span class="form-tag">访问授权：</span>
								<div class="h-content3" id="select_a_g" style="margin-top: -19px; position: relative;">
								</div>
							</div> -->						
						</div>
					</div>
				</div>
			</div>
			<div class="btns s-hide">
				<a href="javascript:;" class="btn btn-normal" onclick="SaveDataGrp();">保&nbsp;&nbsp;存</a>
				<!--
				<a href="javascript:;" class="btn btn-normal" onclick="back();">取&nbsp;&nbsp;消</a>
				-->
			</div>
			<div id="bBtn" style="position: fixed;z-index:5;">
				<a href="javascript:;" class="btn" style="float: right;" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
			</div>
		</div>
		<div class="mainer" id="_account" style="display:none">
			<div class="container">
				<div class="manual-head">
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222);" id="">
						<span onclick="server_add_or_clear();">批量服务</span>
						<i style="display: none;" class="hostm_icon"></i>
					</div>    
					<div class="manual-title-other title-item" id="frist">
						<span onclick="account_add_or_clear();">批量账号</span>
						<i class="hostm_icon"></i>
					</div>					
				</div>
				<div class="c-cont">
					<div class="c-wrap" style="padding: 10px 0 0">
						<div class="c-exp">
							<div class="h-explorer" style="">
								<div class="h-content2 h-content2_tmp" style="height: 520px;padding-top: 0px;overflow: hidden;width: 60%;float: left;border-right: 1px solid rgb(204, 204, 204);">
									<div class="h-top" style="background-color: #fff;">
										<div class="filter filter_service" style="float:right;min-width: auto;">
											<div id="waitTip" class="waitTip" style="float: right;margin-top: 7px;margin-left: -26px;"></div>
											<div class="search">
												<select name="account_select" id="account_select" class="filter-select" style="width:90px;">
														<option value="-1" selected>所有</option>
														<option value="1">组名</option>
														<option value="2">主机名</option>
														<option value="3">IP</option>
													</select>

												<input type="text" class="filter-text" placeholder="输入关键字" name="account_text" id="account_text" maxlength="128" style="padding: 0 22px 0 4px;width:100px;" onchange="if($('#account_text').val()==''){$('#account_text_check').hide();}else{$('#account_text_check').show();}" onkeyup="if($('#account_text').val()==''){$('#account_text_check').hide();}else{$('#account_text_check').show();}" onkeydown="if($('#account_text').val()==''){$('#account_text_check').hide();}else{$('#account_text_check').show();}; if (event.keyCode == 13){_addFilter_account(this,false);return false;} else return; " onblur="change_input_a(this);">
												
												<i class="v-check v-wrong" id="account_text_check" onclick="_clear_keyword(this)" style="display:none;cursor: pointer;float: left;position: static;"></i>
												<button class="btn filter-btn" onclick="_addFilter_account(this,false)"><i class="add-filter"></i></button>
												<button class="btn filter-btn" onclick="_addFilter_account(this,true)"><i class="append-filter"></i></button>
											</div>
											<div class="search" id="clearFilter_account" style="margin: 0px 15px 0px -16px;display:none;">
												<button class="filter-btn" onclick="clearFilter_account(this)"><i class="clear-filter"></i></button>
											</div>
											<div class="selector selector-multiple" id="filterWW_account" style="display: none;    width: 165px;">
												<span class="ww" style="width: 151px;">搜索条件</span>
												<ul style="padding-left: 0px;    width: 165px;"></ul>
											</div>
										</div>
									</div>
									<div style="overflow: auto;width:100%;" id="hosttree_div_account">
										<h2 style="font-size: 14px;    padding-top: 10px;">主机：</h2>
										<ul id="hostTree_z" class="hosttree" style="padding: 10px 0 0 56px;float: none;"></ul>
									</div>
								</div>
								<div class="h-catelog h-catelog2 h-catelog-tmp" style="background-color: rgb(255, 255, 255);float: none;border-right:none;padding: 0;width: 40%;overflow: hidden;">
									<div class="h-top">
										<div class="h-tit">
											<div class="form-item form-nm" style="width:200px;">
												<div id="mix_module_zdp" style="    margin-left: -10px;">
													<select name="" id="mix_select_zdp" class="filter-select" style="width: 80px;display:none;" onchange="">
														<option value="1">所有</option>
														<option value="2">共有</option>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="server_div">
										<h2 style="float: left;padding-left: 1em;font-weight: normal;font-size: 14px;padding-top: 10px;">账号：</h2>
										<div class="c-table r-list tab-type2" style="padding-top: 35px;padding-bottom: 10px;">
											<div class="box-table" style="overflow: hidden;">
												<table cellpadding="0" cellspacing="0">
													<thead>
														<tr id="width_flag">
															<th style="width:44%"><input type="checkbox" class="form-checkbox" id="check_one_page_zdp"/></th>
															<th style="width:64%">账号</th>
														</tr>
													</thead>
												</table>
											</div>
											<div class="box-table server_table_div" style="overflow: auto;margin-top: -1px;">
												<table cellpadding="0" cellspacing="0">
													<tbody name="service_list_a" id="service_list_a">
													</tbody>
												</table>
											</div>
											<div class="form s-hide" >
												<div class="form-item form-item-100" style="width:100%">
													<div style="text-align: right;">
														<a href="javascript:;" id="add_account_z" class="btn btn-normal1" onclick="account_Dialog('add',this);">添&nbsp;&nbsp;加</a>
														<a href="javascript:;" id="del_account_z" class="btn btn-normal1" onclick="delete_account();">删&nbsp;&nbsp;除</a>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
						  </div>
						</div>
						
						<div class="clearfix"></div>
							<!--
							<div class="btns">
								<a href="javascript:;" class="btn btn-normal" onclick="back();">返&nbsp;&nbsp;回</a>
							</div>
							-->
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn" style="float: right;" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="mainer" id="_Server" style="display:none">
			<div class="container">
				<div class="manual-head">
					<div class="manual-title-other title-item" id="frist">
						<span onclick="server_add_or_clear();">批量服务</span>
						<i class="hostm_icon"></i>
					</div>	
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222);" id="">
						<span onclick="account_add_or_clear();">批量账号</span>
						<i style="display: none;" class="hostm_icon"></i>
					</div>
				</div>
				<div class="c-cont">
					<div class="c-wrap" style="padding: 10px 0 0">
						<div class="c-exp">
							<div class="h-explorer" style="" id="service_div0">
								<div class="h-content2 h-content2_tmp" id="service_div1" style="height: 520px;padding-top: 0px;overflow: hidden;width: 430px;float: left;border-right: 1px solid rgb(204, 204, 204);">
									<div class="h-top" style="background-color: #fff;">
										<div class="filter filter_service" style="float:right;min-width: auto;">
											<div id="waitTip" class="waitTip_server" style="float: right;margin-top: 7px;margin-left: -20px;"></div>
											<div class="search">
												<select name="service_select" id="service_select" class="filter-select" style="width:72px;">
														<option value="all" selected>所有</option>
														<option value="hgname">组名</option>
														<option value="hostname">主机名</option>
														<option value="ip">IP</option>
													</select>

												<input type="text" class="filter-text" placeholder="输入关键字" name="service_text" id="service_text" maxlength="128" 
													style="padding-right: 22px;width:72px;"
													onchange="if($('#service_text').val()==''){$('#service_text_check').hide();}else{$('#service_text_check').show();}"
													onblur="if($('#service_text').val()=='' && search_typeall_new!=''){search_typeall_new='';find_hostgroup_service();}"
													onkeyup="if($('#service_text').val()==''){$('#service_text_check').hide();}else{$('#service_text_check').show();}"										 
													onkeydown="if($('#service_text').val()==''){$('#service_text_check').hide();}else{$('#service_text_check').show();}; if (event.keyCode == 13){_addFilter_service(this,false);return false;} else return; ">
													<i class="v-check v-wrong" id="service_text_check" onclick="clearFilter_service(this,1)" style="display:none;cursor: pointer;float: left;position: static;"></i>
												<button class="btn filter-btn" onclick="_addFilter_service(this,false)"><i class="add-filter"></i></button>
												<button class="btn filter-btn" onclick="_addFilter_service(this,true)"><i class="append-filter"></i></button>
											</div>
											<div class="search" id="clearFilter_service" style="margin: 0px 15px 0px -16px;display:none;">
												<button class="filter-btn" onclick="clearFilter_service(this)"><i class="clear-filter"></i></button>
											</div>
											<div class="selector selector-multiple" id="filterWW_service" style="display: none;    width: 120px;">
												<span class="ww" style="width: 106px;">搜索条件</span>
												<ul style="padding-left: 0px;    width: 120px;"></ul>
											</div>
										</div>
									</div>
									<div style="overflow: auto;width:100%;" id="hosttree_div_service">
										<h2 style="font-size: 14px;float: left;padding-top: 10px;">主机：</h2>
										<ul id="userTree" class="hosttree" style="padding: 6px 0 0 56px;float: none;margin-top: 0px;"></ul>
									</div>
								</div>
								<div class="h-catelog h-catelog2 h-catelog-tmp" id="service_div2" style="background-color: rgb(255, 255, 255);float: none;border-right:none;padding: 0;overflow: hidden;">
									<div class="h-top">
										<div class="h-tit">
											<div class="form-item form-nm" style="width:200px;padding-left: 0px;">
												<div id="mix_module" style="margin-left: 5px;">
													<select name="" id="mix_select" class="filter-select" style="width: 80px;display:none;" onchange="">
														<option value="PGetAccountProtocolForAuth" selected>所有</option>
														<option value="PGetSameAccountProtocolForAuth">共有</option>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="server_div">
										<h2 style="float: left;padding-left: 1em;font-weight: normal;font-size: 14px;padding-top: 10px;">服务：</h2>
										<div class="c-table r-list" style="padding-top: 35px;padding-bottom: 10px;">
											<div class="box-table" style="overflow: hidden;">
												<table cellpadding="0" cellspacing="0">
													<thead>
														<tr>
															<th width="50"><input type="checkbox" class="form-checkbox" id="check_one_page"/></th>
															<!-- <th>名称</th> -->
															<th>协议</th>
															<th>端口</th>
															<th>连接参数</th>
															<th width="33"></th>
														</tr>
													</thead>
												</table>
											</div>
											<div class="box-table server_table_div" style="overflow: auto;margin-top: -1px;">
												<table cellpadding="0" cellspacing="0">
													
													<tbody name="service_list_" id="service_list_">
														
													</tbody>
												</table>
											</div>
											<div class="form s-hide" >
												<div class="form-item form-item-100" style="width:100%">
													<div style="text-align: right;">
														<a href="javascript:;" id="" class="btn btn-normal1" onclick="getService_Dialog('add',this);">添&nbsp;&nbsp;加</a>
														<a href="javascript:;" id="" class="btn btn-normal1" onclick="del_service_all();">删&nbsp;&nbsp;除</a>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
				            </div>
			            </div>
						
						<div class="clearfix"></div>
						<!--
						<div class="btns">
							<a href="javascript:;" class="btn btn-normal" onclick="back();">返&nbsp;&nbsp;回</a>
						</div>
						-->
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn" style="float: right;" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 浮层 -->
		<!-- 服务-->
		<div class="dialog-cont" id="scDCTab1" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:425px;max-height:430px;overflow:hidden;">
					<div class="c-wrap" style="padding:0;/*margin-top: -10px;*/overflow-y: auto;overflow-x: hidden;max-height: 368px;">
						<div class="c-form c-form-host col3">
							
							<div class="clearfix"></div>
							<div class="c-table" style="padding: 0;">
								<div class="form" style="overflow: hidden;">
									<div class="form-item" style="width:100%" id="item_server">
										<span class="form-tag" style="">服务载入：</span>
										<div class="form-c" style="">
											<select class="form-select" name="" id="def_server" style="width: 132px;">
												
											</select>
										</div>
									</div>
									
									<div class="form-item" style="display: none;">
										<span class="form-tag">服务名称：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="HostServiceName" maxlength="128">
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em>协议：</span>
										<div class="form-c" id="ProtocolName"></div>
									</div>

									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em>端口：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="Port" maxlength="5">
										</div>
									</div>
									<div class="form-item" style="/*width:20%;*/display: none;" id="same_sftp" >
										<span class="form-tag" style="margin-left: -4px;">同步创建SFTP：</span>
										<div class="form-c" style="margin-top: 3px;">
											<label>
												<input type="checkbox" class="form-checkbox" id="same_sftp_check">
											</label>
										</div>
									</div>
									<!--
									<div class="form-item" id="connparam">
										<span class="form-tag">连接参数：</span>
											<div class="form-c">
												<div class="xSelect xSelect_connList" id="ConnParamName"></div>
											</div>
									</div>
									-->
									<div class="form-item">
										<span class="form-tag">跳转来源主机：</span>
										<div class="form-c">
											<select class="form-select" name="" id="FromHostName" style="width: 132px;">
												<option value="">请选择</option>
											</select>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">跳转来源服务：</span>
										<div class="form-c">
											<select class="form-select" name="" id="FromHostServiceName" style="width: 132px;">
												<option value="">请选择</option>
											</select>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">跳转来源账号：</span>
										<div class="form-c">
											<select class="form-select" name="" id="FromAccountName" style="width: 132px;">
												<option value="">请选择</option>
											</select>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">跳转命令：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="FromLoginCmd" maxlength="128">
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">普通提示符：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="NormalPrompt" maxlength="128">
										</div>
									</div>
									<div class="form-item" style="">
										<span class="form-tag">特权提示符：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="SuperPrompt" maxlength="128" >
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">账号切换命令：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="AcctSwitchCmd" maxlength="128">
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">切换密码提示：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="SwitchPasswdPrompt" maxlength="128">
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">登录名提示：</span>
										<div class="form-c">									
											<input type="text" class="form-text" id="LoginUserPrompt" maxlength="128">
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">登录密码提示：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="LoginPasswdPrompt" maxlength="128">
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">登录成功提示：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="LoginSuccPrompt" maxlength="128">
										</div>
									</div>
									
									<div class="form-item" style="display:none;">
										<span class="form-tag">额外提示：</span>
										<div class="form-c">									
											<input type="text" class="form-text" id="ExtraPrompt"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item" style="display:none;">
										<span class="form-tag">额外应答：</span>
										<div class="form-c">									
											<input type="text" class="form-text" id="ExtraReply"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">换行符：</span>
										<div class="form-c">
											<select class="form-select" name="" id="LineBreak" style="width: 132px;">
												<option value="1" selected >LF</option>
												<option value="2">CR</option>
												<option value="3">CRLF</option>
											</select>
										</div>
									</div>
									<div class="form-item" id="_div_isacc" style="display:none;"  >
										<span class="form-tag">应用通道：</span>
										<div class="form-c">
											<select class="form-select" name="" id="IsAcc" style="width: 132px;" onchange="change_isacc(this);">
												<option value="0" selected >禁用</option>
												<option value="1">启用</option>
												<option value="2">可选</option>
											</select>
										</div>
									</div>
									<div class="form-item form-item-100" id="div_conn" style="padding-bottom: 0px;">
										<span class="form-tag" style="line-height:33px;">连接参数：</span>
										<div class="form-item" id="conn_cont" style="width: 620px;/*max-height: 104px;*/overflow: hidden;padding: 2px 0;height: auto;">
											<div class="form-c srsCtl1" style="width:175px;padding: 0;float: left;margin-bottom:10px;">
												<div class="form-c" style="padding:0;width: 133px;float: left;">
													<div class="xSelect xSelect_connList" id="ConnParamName" style="border-bottom-left-radius: 5px;border-top-left-radius: 5px;border-top-right-radius: 5px;border-bottom-right-radius: 5px;"></div>
												</div>
												<a href="javascript:;" class="ctrl add" id="add5" style="display: inline;float: left;width: 15px;height: 15px;overflow: hidden;background: url(/manage/images/icon-ctr.png) no-repeat 0 0;background-position: 0 -15px;margin: 6px 0 0 10px;" onclick="_addconn(this);"></a>
											</div>
										</div>
									</div>
									<div class="form-item form-item-100" id="div_inip" style="">
										<span class="form-tag" style="line-height:33px;">应用发布：</span>
										<div class="form-item" id="accIP_cont" style="width: 620px;max-height: 104px;overflow: auto;padding: 2px 0;">
											<div class="form-c srsCtl" style="width:265px;padding: 0;float: left;margin-bottom:10px;">
												<div class="accIP_type" style="float:left;">
													<select class="filter-select" name="accIP_type" id="accIP_type" style="width:80px;border-bottom-right-radius: 0px;border-top-right-radius: 0px;float:left;" tabindex="-1" aria-hidden="false" onchange="change_acc_type(this);"> 
														<option value="1">内置</option>
														<option value="2" selected>外置</option>
													</select>
												</div>
												<div class="in_ip" style="float:left;margin-left: -1px;display:none;" >
													<select class="filter-select" name="in_ip" id="in_ip" style="width:138px;border-bottom-right-radius: 0px;border-top-right-radius: 0px;float:left;" tabindex="-1" aria-hidden="false"> 
														<option value="1">1</option>
														<option value="2">2</option>
														<option value="1">3</option>
														<option value="2">4</option>
														<option value="1">5</option>
														<option value="2">6</option>
														<option value="1">7</option>
														<option value="2">8</option>
														<option value="1">9</option>
														<option value="2">10</option>
														<option value="1">11</option>
														<option value="2">12</option>
														<option value="1">13</option>
														<option value="2">14</option>
														<option value="1">15</option>
														<option value="2">16</option>
														<option value="1">17</option>
														<option value="2">18</option>
														<option value="1">19</option>
														<option value="2">20</option>
													</select>
												</div>
												<div class="form-c" id="accIP" style="float:left;padding:0px;"></div>
												<a href="javascript:;" class="ctrl add" id="add4" style="display: inline;" onclick="_addaccIP(this);"></a>
											</div>
										</div>
										<div class="form-item" id="accIP_cont1" style="width: 620px;max-height: 104px;overflow: auto;padding: 2px 0;display: none;">
											<input type="text" class="form-text" id="" maxlength="128" value="全局指定" disabled="disabled">
										</div>
									</div>
								</div>
							</div>
							
							<div class="btns" style="padding: 10px 0 10px;">
								<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
								<a href="javascript:;" class="btn btn-normal btn-cancel" onclick="clear_server();">重&nbsp;&nbsp;置</a>
							</div>
						</div>
					</div>
				</div>  
			</div>
		</div>		
		<!-- 账号 -->
		<div class="dialog-cont" id="scDCTab2" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:300px;max-height:300px;overflow:hidden;">
					<div class="c-form c-form-host" style="padding: 0 0 90px;margin-top: -30px">
						<div class="clearfix"></div>
						<div class="c-table">
							<div class="form">
								<div class="form-item" style="width:100%">
									<span class="form-tag" style="width: 7em;"><em class="imp">*</em>服务：</span>
									<div class="form-c" name="" id="server_list" style="max-height: 77px;overflow: auto;padding-left: 0px;">
									</div>
								</div>
								<div class="form-item" style="width: 33%; margin-left: 1px;">
									<span class="form-tag" style="width: 7em;"><em class="imp">*</em>账号：</span>
									<div class="form-c">
										<div class="xSelect xSelect_AccList" id="AccountName"></div>
									</div>
								</div>
								<div class="form-item" style="width: 33%;">
									<span class="form-tag" style="width: 7em; margin-left: 31px;">认证方式：</span>
									<div class="form-c">
										<select class="form-select" name="" id="authType" style="width:142px" onchange="auth_change();" disabled>
											<option value="0">密码</option>
											<option value="1">密钥</option>
										</select>
									</div>
								</div>								
								<div class="form-item" style="width: 33%;">
									<span class="form-tag" style="width: 7em; margin-left: 10px;">特权帐号：</span>
									<div class="form-c" style="margin-top: 3px;">
										<label><input type="checkbox" name=""  class="form-checkbox" id="IsSuperAcct"></label>
									</div>
								</div>								
								<div class="form-item" style="width: 37%;padding-bottom: 9px;" id="item_pwd">
									<span class="form-tag" style="width: 7em;">密码：</span>
									<div class="form-c" style="/*margin-top: 1px;*/float: left;width: 170px;padding-left: 1px;">
										<input type="password" class="form-text" id="password1" style="width: 110px;/*margin-top: -1px;*/">
										<label style="	/*line-height: 28px;*/" id="if_emptypwd_label" >
											<input type="checkbox" name=""  class="form-checkbox" id="if_emptypwd" style="/*margin-top: -2px;*/" >
										</label>
									</div>	
									<span class="form-tag" style="width: auto;float: none;">空密码</span>
								</div>
								<div class="form-item" style="width: 29%;" id="item_pwd_con">
									<span class="form-tag" style="width: 7em;">确认密码：</span>
									<div class="form-c">
										<input type="password" class="form-text" id="password2" style="width: 110px">	
									</div>
								</div>
								<div class="form-item" style="width: 33%; display: none;" id="item_SSHKey">
									<span class="form-tag" style="width: 7em; margin-left: 2px;">密钥：</span>
									<div class="form-c">
										<div class="xSelect xSelect_SSHkey" id="SSHkey_s"></div>
									</div>
								</div>
								<div class="form-item" style="width: 33%;">
									<span class="form-tag" style="width: 7em; margin-left: 10px;">同一帐号：</span>
									<div class="form-c" style="margin-top: 3px;">
										<label><input type="checkbox" name=""  class="form-checkbox" id="IsSameUser"></label>
									</div>
								</div>
								<div class="form-item" style="width: 33%;">
									<span class="form-tag" style="width: 7em;">切换账号：</span>
									<div class="form-c" style="padding-left: 99px;">
										<select class="form-select" name="" id="FromAccount_acc" style="width:142px">
											<option value="0">请选择</option>
										</select>
									</div>
								</div>
								<div class="form-item" style="width: 30%;">
									<span class="form-tag" style="width: 7em; margin-left: 32px;">切换命令：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="AcctSwitchCmd_account" style="width: 110px">
									</div>
								</div>
								<div class="form-item" style="width: 30%; margin-left: 34px;">
									<span class="form-tag" style="width: 7em;">切换密码提示：</span>
									<div class="form-c">
										<input type="text" class="form-text" id="SwitchPasswdPrompt_account" style="width: 110px">
									</div>
								</div>
							</div>
						</div>

						<div class="btns" style="padding: 10px 0 10px;">
							<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
							<a href="javascript:;" class="btn btn-normal btn-cancel" onclick="clear_account();">重&nbsp;&nbsp;置</a>
						</div>
					</div>
				</div>
			
			</div>
		</div>
		
		<!-- 账号删除 -->
		<div class="dialog-cont" id="scDCTab2_delete" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:300px;max-height:300px;overflow:hidden;">
					<div class="c-form c-form-host" style="padding: 0 0 90px;margin-top: -30px">
						<div class="clearfix"></div>
						<div class="c-table">
							<div class="form">
								<div class="form-item" style="width:100%">
									<span class="form-tag" style="width: 7em;"><em class="imp">*</em>服务：</span>
									<div  class="" class="form-c" name="" id="server_list_select" style="font-size: 14px; max-height: 200px; overflow-y: auto;">
										
									</div>
								</div>
							</div>
						</div>
						
						<div class="btns" style="padding: 10px 0 10px;">
							<a href="javascript:;" class="btn btn-normal btn-submit s-hide" >保&nbsp;&nbsp;存</a>
							<a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 前置机IP添加浮层 -->
		<div class="dialog-cont" id="ConnIPDialog" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
					<div class="c-form c-form-host" style="padding: 0 0 90px;">
						<div class="clearfix"></div>
						<div class="c-table">
							<div class="form">
								<div class="form-item" style="width: 25%;">
									<span class="form-tag" style=""><em class="imp">*</em>IP：</span>
									<div class="form-c" style="">
										<input type="text" class="form-text" id="accip_input" maxlength="15" style="" tabindex="1">
									</div>
								</div>
							</div>
							<div class="btns" style="padding: 10px 0 10px;">
								<a href="javascript:;" class="btn btn-normal btn-submit s-hide" >保&nbsp;&nbsp;存</a>
								<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="dialog-cont" id="protoDialog" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
					<div class="c-form c-form-host" style="padding: 0 0 90px;">
						<div class="clearfix"></div>
						<div class="c-table">
							<div class="form">
								<div class="form-item" style="width: 300px;">
									<span class="form-tag" style="width: 72px;"><em class="imp">*</em>名称：</span>
									<div class="form-c" style="padding-left: 0;">
										<input type="text" class="form-text" id="Protocol_Name0" maxlength="15" style="width: 195px;" tabindex="1">
										<i class="v-check" style=""></i>
										<p class="form-tip" style="width: 185px;margin-left: 66px;">特殊字符仅支持下划线、横杠</p>
									</div>
								</div>
								<div class="form-item" style="width: 185px;">
									<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口：</span>
									<div class="form-c" style="padding-left: 0px;">
										<input type="text" class="form-text" id="Port0" maxlength="5" style="width: 50px;" tabindex="1">
										<i class="v-check" style=""></i>
										<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
									</div>
								</div>
								<div class="form-item" style="width: 185px;">
									<span class="form-tag" style="width:85px;"><em class="imp">*</em>端口1：</span>
									<div class="form-c" style="padding-left: 0px;">
										<input type="text" class="form-text" id="Port1" maxlength="5" style="width: 50px;" tabindex="1">
										<i class="v-check" style=""></i>
										<p class="form-tip" style="width: 78px;margin-left: 80px;">0-65535之间</p>
									</div>
								</div>
								<div class="form-item" style="width: 250px;">
									<span class="form-tag" style="width:85px;">描述：</span>
									<div class="form-c" style="padding-left: 0px;">
										<input type="text" class="form-text" id="Description0" maxlength="128" style="width:170px;" tabindex="1">
									</div>
								</div>
							</div>
							<div class="btns" style="padding: 10px 0 10px;">
								<a href="javascript:;" class="btn btn-normal btn-submit s-hide" >保&nbsp;&nbsp;存</a>
								<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 主机导出-->
		<div class="dialog-cont s-hide" id="scDCTab2_export" style="display:none;">
			<div class="fsel" style="margin-left: 0;">
				<ul><li><a class="active" href="javascript:;" id="export_tab_1" onclick="get_export_tab(1);">主机导出</a></li>
					<li><a href="javascript:;" id="export_tab_2" onclick="get_export_tab(2);">任务列表</a></li>
				</ul>
			</div>
			<div class="container">
				<div id="export_1" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;">
					<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
						<span>方式：</span>
						<label class="form-label" style="width: 60px;">
							<input type="radio" class="form-radio" id="all_check" value="all" name="exportType_radio" checked="checked"/>所有
						</label>
						<label class="form-label" style="width: 60px;">
							<input type="checkbox" class="form-checkbox" id="resource_check" value="resource" name="exportType_radio"/>资源
						</label>
						<label class="form-label" style="width: 60px;">
							<input type="checkbox" class="form-checkbox" id="host_check" value="host" name="exportType_radio"/>主机
						</label>
						<label class="form-label" style="width: 60px;">
							<input type="checkbox" class="form-checkbox" id="host_group_check" value="host_group" name="exportType_radio"/>主机组
						</label>
					</div>
					<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
						<span>格式：</span>
						<label class="form-label" style="width: 60px;">
							<input type="radio" class="form-radio" value=0 name="exportType_radio2" checked="checked"/>CSV
						</label>
						<label class="form-label" style="width: 60px;">
							<input type="radio" class="form-radio" value=1 name="exportType_radio2"/>XLS
						</label>
					</div>
					<div class="btns" style="/*padding: 20px 0 0px;*/">
						<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
					</div>
				</div>
			
				<div id="export_2" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;display:none;">
					<div class="c-form" style="padding:0;width: auto;">
						<div class="c-wrap" style="padding:0;">
							<div class="c-table r-list" style="padding:0;">
								<div class="tab-t">
									<div class="ctr">
										<a href="javascript:;" class="btn btn-default" onclick="export_all_check();">全选</a>
										<a href="javascript:;" class="btn btn-default" onclick="export_del();">删除</a>
										<a href="javascript:;" class="btn btn-default" onclick="export_refresh();">刷新</a>
									</div>
								</div>
								<div class="box-table" style="/*max-height: 256px;min-height:256px;*/overflow: hidden;">
									<table cellpadding="0" cellspacing="0" id="export_list">
										<thead>
											<tr>		
												<th width="50"><input type="checkbox" class="form-checkbox" id="check_export_page"></th>
												<th>名称</th>
												<th width="140">开始时间</th>
												<th>状态</th>
												<th>错误信息</th>
												<th width="60"></th>
											</tr>
										</thead>
										<tbody>
											
										</tbody>
									</table>
								</div>
								<div class="tab-i">
									<div class="il">
										每页显示<span id="exportpage_total">10</span>条 总数<span id = "export_total">25</span>  选中：<span id = "export_select_total">0</span>
									</div>

									<div class="ipage">
										<a href="javascript:;" class="nav2 begin" onclick="turn_export_page(1);"><i></i></a>
										<a href="javascript:;" class="nav prev" onclick="turn_export_page(2);"><i></i></a>
										<input type="text" value="1" id="exportcurpage" onchange="turn_export_page(5);">/ <span id = "exporttotalpage">25</span>
										<a href="javascript:;" class="nav next" onclick="turn_export_page(3);"><i></i></a>
										<a href="javascript:;" class="nav2 end" onclick="turn_export_page(4);"><i></i></a>
									</div>
								</div>
							</div>
							
							<div class="clearfix"></div>
						</div>
					</div>
				</div>
			</div>
		</div>



		<!-- 主机导入 -->
		<div class="dialog-cont s-hide" id="scDCTab2_import" style="display:none;">
			<div class="fsel" style="margin-left: 0;">
				<ul><li><a class="active" href="javascript:;" id="task_import" onclick="set_tab(this,1);">主机导入</a></li>
					<li><a href="javascript:;" id="task_list_tab" onclick="set_tab(this,2);">任务列表</a></li>
				</ul>
			</div>
			<div class="container">
				<div id="import_module" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;">
					<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
						<div class="tab-t c-form">
							<span class="form-tag">下载模板：</span>
							<div class="ctr" style="margin-left:6px;">
								<a class="btn" href="javascript:;" style="" onclick="_export_host(1);">下载</a>
							</div>
						</div>
						<div class="c-form" style="">
							<form id="uploadForm">
								<div class="form-item tab-t">
									<span class="form-tag"><em class="imp">*</em>选择文件：</span>
									<div class="form-c ctr" style="width:300px;padding:0 0 0 7px;">
										<div class="item" style="float: left;width:67%">
											<input id="file_v" name="file_v" class="form-text" type="text" style="float: left;width: 220px;">
											<input id="file_change" name="file_change" class="form-text" type="text" onclick="browes();" onchange="/*filetip(this);*/" style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;">
											<input id="file_change1" name="file_change1" class="form-text" type="file" onchange="filetip(this);" style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;display: none;">
										</div>
										<div class="item" style="float: left;width:33%">
											<a class="btn" href="javascript:;" style="margin-left: 70px;height: 26px;width:33px;" onclick="browes();">浏览</a>
										</div>
									</div>
									<p class="form-tip" id="" style="margin-top: 28px;width: 243px;height: 32px;margin-left: 194px;">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</form>
						</div>
						<div class="c-form">
							<span class="form-tag">审核：</span>
							<div style="width: 215px;margin-left: 200px;margin-top: 4px;">
								<input class="form-checkbox" id="pending_box" type="checkbox"/>
								<span class="tip" style="color: #b2b2b2;">导入前对主机进行连接测试</span>
							</div>
						</div>
						<div class="c-form">
							<span class="form-tag">覆盖：</span>
							<div style="width: 215px;margin-left: 200px;margin-top: 4px;">
								<input class="form-checkbox" id="cover_box1" type="checkbox"/>
								<span class="tip" style="color: #b2b2b2;">覆盖相同IP的主机</span>
							</div>
						</div>
						<div class="btns" style="/*padding: 20px 0 0px;*/">
							<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
						</div>
					</div>
				</div>
			
				<div id="details_module" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;display:none;">
					<div class="c-form" style="padding:0;width: auto;">
						<div class="c-wrap" style="padding:0;">
							<div class="c-table r-list" style="padding:0;">
								<div class="tab-t">
									<div class="ctr">
										<a href="javascript:;" class="btn btn-default" onclick="select_all()">全选</a>
										<a href="javascript:;" class="btn btn-default" onclick="del_hosttask_more()">删除</a>
										<a href="javascript:;" class="btn btn-default" onclick="fresh_task_list()">刷新</a>
									</div>
								</div>
								<div class="box-table" style="/*max-height: 256px;min-height:256px;*/overflow: hidden;">
									<table cellpadding="0" cellspacing="0" id="hosttask_list">
										<thead>
											<tr>		
												<th width="50"><input type="checkbox" class="form-checkbox" id="check_task_page"/></th>
												<th>名称</th>
												<th>成功数</th>
												<th>失败数</th>
												<th>状态</th>
												<th>错误信息</th>
												<th width="60"></th>
											</tr>
										</thead>
										<tbody>
											
										</tbody>
									</table>
								</div>
								<div class="tab-i">
									<div class="il">
										每页显示<span id="page_total">10</span>条 总数<span id = "task_total">25</span>  选中：<span id = "select_total">0</span>
									</div>

									<div class="ipage">
										<a href="javascript:;" class="nav2 begin" onclick="turn_page(1);"><i></i></a>
										<a href="javascript:;" class="nav prev" onclick="turn_page(2)"><i></i></a>
										<input type="text" value="1" id="curpage" onchange="turn_page(5)">/ <span id = "totalpage">25</span>
										<a href="javascript:;" class="nav next" onclick="turn_page(3)"><i></i></a>
										<a href="javascript:;" class="nav2 end" onclick="turn_page(4)"><i></i></a>
									</div>
								</div>
							</div>
							
							<div class="clearfix"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	
	<!-- 任务详情 -->
	<!--
	<div class="dialog-cont" id="scDCTab2_importtask" style="display:none;">
		<div class="container">
			<div id="" class="c-cont" style="min-height:430px;max-height:430px;overflow:hidden;">
				<div class="c-form" style="padding:0;width: auto;">
					<div class="c-wrap" style="padding:0;">
						<div class="c-table r-list" style="padding:0;">
							<div class="tab-t">
								<div class="ctr">
									<a href="javascript:;" class="btn btn-default" onclick="fresh_task_list_detail()">刷新</a>
									<ul id="" style="margin-top: 3px;">
										<li style="margin-left: 350px;"><label style="padding-left: 30px;"><input type="checkbox" class="form-checkbox" value="1" id="cover_box" style="position: absolute; opacity: 0;">覆盖</label><label style="padding-left: 30px;"><input type="checkbox" class="form-checkbox" id="succ_checkbox" checked="checked" style="position: absolute; opacity: 0;">连接成功</label><label style="padding-left:30px;"><input type="checkbox" class="form-checkbox" id="fail_checkbox" checked="checked" style="position: absolute; opacity: 0;">连接失败</label><label style="padding-left:30px;"><input id="refuse" type="checkbox" class="form-checkbox" checked="checked" style="position: absolute; opacity: 0;">不支持连接测试</label></li>
									</ul>
								</div>
							</div>
							<div>
								<table cellpadding="0" cellspacing="0" id="table_title">
									<thead>
										<tr>
											<th>IP</th>
											<th>协议</th>
											<th>连接参数</th>
											<th>账号</th>
											<th>状态</th>
										</tr>
									</thead>
								</table>
							</div>
							
							<div class="c-table tab-type2" style="max-height: 253px;min-height:253px;overflow: auto;padding:0;width:auto;" id="scrollAppend">
								<table cellpadding="0" cellspacing="0" id="hosttask_list_detail">
									<tbody>
										
									</tbody>
								</table>
							</div>
							
							<div class="tab-i">
								<div class="il">
									 总数：<span id = "task_total_detail">25</span>
								</div>
							</div>
							
						</div>
						
						<div class="clearfix"></div>
						<div class="btns" style="padding: 20px 0 0px;">
							<a href="javascript:;" class="btn btn-normal btn-submit" >导&nbsp;&nbsp;入</a>
							<a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	-->
	<!--审核详情-->
	
	<div id="allPage" style="display: none;">
		<div class="ap-top" id="">
			<div class="ctrl">
				<a href="javascript:;" class="re" onclick="_reloadDetail(1)"><i></i></a>
				<a href="javascript:;" class="close" onclick="_closeDetail(1)"><i></i></a>
			</div>
			<div class="types">
				<label>
					<input type="checkbox" name="" id="succ_checkbox" class="form-checkbox" checked="checked">连接成功</label>
				<label>
					<input type="checkbox" name="" id="fail_checkbox" class="form-checkbox" checked="checked">连接失败</label>
				<label>
					<input type="checkbox" name="" id="refuse" class="form-checkbox" checked="checked">不支持连接测试</label>
			</div>
		</div>
		<div class="apWrap" style="margin: 50px auto 0px;">
			<div class="title">
				<h2>任务详情</h2>
			</div>
			<div class="top">
				<div class="mm">
					主机：<span class="span_s">11</span> 账号：<span class="span_s">11</span> 失败账号：<span class="a">2</span> 成功账号：<span class="b">9</span> 不支持连接测试账号：<span>0</span>
				</div>
				<div style="width: 60px;float: left;margin-top: 5px;margin-left: 10px;">
					<input style="" type="checkbox" name="dr" id="cover_box" class="form-radio" checked=""/>覆  盖
				</div>
				<div class="tbtns">
					<!--
					<a href="javascript:;"><i class="icon1"></i>导出</a>
					-->
					<a href="javascript:;" id="import_btn" onclick=""><i class="icon2"></i>导入</a>
				</div>
			</div>
			<div class="clearfix"></div>
			<div id="apArea" style="">
			</div>
			<div id="aploadTip">正在加载</div>
		</div>
	</div>
	
	<!--导入信息详情-->
	<div id="importPage" style="display: none;">
		<div class="ap-top" id="">
			<div class="ctrl">
				<a href="javascript:;" style="border-radius: 14px;" class="re" onclick="_reloadDetail(2)"><i style="margin: 3px auto;margin-left: 8px;"></i></a>
			</div>
			<div class="types">
				<label>
					<input type="checkbox" name="" id="fail_IP_box" class="form-checkbox" >失败的主机</label>
			</div>
		</div>
		<div class="apWrap">
			<div class="title">
				<h2>导入详情</h2>
			</div>
			<div class="top">
				<div class="mm mm1">
					主机：<span class="span_s">11</span> 账号：<span class="span_s">11</span> 成功主机：<span class="span_s">11</span>失败主机：<span class="span_s">11</span> 存在主机：<span class="span_s">11</span> 新增主机：<span class="span_s">11</span>
				</div>
			</div>
			<div class="clearfix"></div>
			<div id="apArea1" style="height:auto;">
				<div class="apSort"></div>
			</div>
			
			<div id="aploadTip1">正在加载</div>
		</div>
		<div id="bBtn" style="position: fixed;z-index:5;">
			<a href="javascript:;" class="btn" style="float: right;" onclick="_closeDetail(2)"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
		</div>
	</div>
	
	<!-- 服务-->
	<div class="dialog-cont" id="scDCTab_service" style="display:none;">
		<div class="container">
				<div class="c-wrap" style="padding:0 0 90px;overflow: hidden;">
				<div class="c-form c-form-host col3">
					
					<div class="clearfix"></div>
					<div class="c-table" style="padding: 0;">
						<div class="form" style="overflow: hidden;">
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>协议：</span>
								<div class="form-c">
									<select class="form-select" name="" id="ProtocolName_service" style="width: 140px;">
										<option value="">请选择</option>
									</select>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>端口：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="Port_service" maxlength="5" onkeyup="port_check(this);" onblur="port_check(this);" style="width:108px">
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">连接参数：</span>
								<div class="form-c">
									<select class="form-select" name="" id="ConnParamName_service" style="width: 140px;">
										<option value="-1" selected>请选择</option>
									</select>
								</div>
							</div>
						</div>
					</div>
					
					<div class="btns" style="/*margin-left: -20px;width: 840px;margin-bottom: -20px;*/">
						<a href="javascript:;" class="btn btn-normal btn-submit s-hide" >保&nbsp;&nbsp;存</a>
						<a href="javascript:;" class="btn btn-normal btn-cancel" onclick="clear_server();">重&nbsp;&nbsp;置</a>
					</div>
				</div>
				</div>
			<!-- </div>   -->
		</div>
	</div>
		
	<form action="/bhost/host_manage" method="POST" name="frm_access">
		<input type="hidden" name="tasktype" value="0" />
		<input type="hidden" name="se"  value="{{se}}" />
		<input type="hidden" name="us"  value="" />
	</form>

	<!--ping test-->
	<div class="dialog-cont" id="scDCTab3" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:300px;max-height:300px">
				<div class="c-form" style="width: 450px;padding: 0px;">
					<div class="clearfix"></div>
					<div class="form">
						<div class="form-item" style="width:100%">
							<div class="form-c" style="padding-left: 0px;">
								<textarea class="form-textarea" name="" id="ping" cols="30" rows="10" disabled="disabled"style="width: 430px;height: 150px; font-size: 13px;" value=""></textarea>
							</div>
						</div>					
					</div>
					<div class="btns" style="padding: 10px 0 10px;">
						
						<a href="javascript:;" class="btn btn-normal btn-submit">返&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>

		</div>
	</div>

	<!--连接测试-->
	<div class="dialog-cont" id="scDCTab4" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:20px;max-height:200px">
				<div class="c-form c-form-host" style="padding: 0 0 90px;">
					<div class="clearfix"></div>
					<div class="c-table" style="padding:0px;">
						<div class="form">
							<div class="form-item" style="width: 100%;">
								<span class="form-tag" style="width: 7em; margin-left: 2px;">&nbsp;&nbsp;&nbsp;支持的协议：SSH, ORACLE, MSSQL, MYSQL, TELNET, FTP, VNC, SYBASE, DB2, RLOGIN, RDP, INFORMIX</span>
							</div>
						
						</div>
						<div class="form">
							<div class="form-item" style="width: 33%;">
								<span class="form-tag" style="width: 7em;">协议：</span>
								<div class="form-c">
									<select class="form-select" name="" id="connectProtoSelect" style="width: 160px;">
									</select>
								</div>

							</div>
							<div class="form-item" style="width: 33%;" id = "acc_test_conn">
								<span class="form-tag" style="width: 7em;">连接参数：</span>
								<div class="form-c">
									<select class="form-select" name="" id="connectParamSelect" style="width: 160px;">
									</select>
								</div>
							</div>
							
						</div>
					</div>

					<div class="btns" style="padding: 10px 0 10px;">
						<a href="javascript:;" class="btn btn-normal btn-submit">确&nbsp;&nbsp;定</a>
						<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
					</div>
				</div>
			</div>

		</div>
	</div>
	<!--连接测试结果-->
	<div class="dialog-cont" id="scDCTab4_1" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:300px;max-height:300px">
				<div class="c-form" style="width: 450px;padding: 0px;">
					<div class="clearfix"></div>
					<div class="form">
						<div class="form-item" style="width:100%">
							<div class="form-c" style="padding-left: 0px;">
								<textarea class="form-textarea" name="" id="conn_test" cols="30" rows="10" disabled="disabled" style="width: 430px;height: 150px; font-size: 13px;" value=""></textarea>
							</div>
						</div>					
					</div>
					<div class="btns" style="padding: 10px 0 10px;">
						
						<a href="javascript:;" class="btn btn-normal btn-cancle">返&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--AD域-->
	<div class="dialog-cont" id="ADDialog" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:320px;max-height:320px">
				<div class="c-form" style="padding-bottom:10px;padding-top:0px">
						<div class="form">	
							<div class="form-item" >
								<span class="form-tag"><em class="imp">*</em>名称：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="ad_n" name="ad_n" maxlength="128" onblur="regCheck(this,nameReg);">
									<i class="v-check"></i>
									<p class="form-tip" style="margin-left: 109px;">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</div>
						</div>
					</div>
				<div class="c-form c-form-host"style="min-width:650px;padding-top:0px;    margin-left: -9px;">
					<div class="form">
						<div class="form-item form-item-100 " style="width:900px;">
							<span class="form-tag"style="" ><em class="imp">*</em>服务器IP：</span>
							<div id="ip_n" name="ip_n" class="form-c"style="float: left;width:560px;    max-height: 154px;overflow: auto;">
								<span class="ss ss-add">
									<input type="text" style="" class="form-text form-text2" onkeyup="/*showMsg(this);*/" onkeyup="this.value=this.value.replace(/[^0-9.]/g,'')" onafterpaste="this.value=this.value.replace(/[^0-9.]/g,'')">
									<i class="ctr ctr-add" onclick="_addIp(this)" style="margin-top: 9px;    margin-left: 3px;"></i>
								</span>
							</div>
						</div>
					</div>
				</div>

				<div class="btns" style="padding: 10px 0 10px;">
					<a href="javascript:;" class="btn btn-normal btn-submit s-hide" >确&nbsp;&nbsp;定</a>
					<a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a>
				</div>
			</div>
		</div>
	</div>
	
	<!-- 连接参数 -->
	<div class="dialog-cont" id="ConnParamDialog" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:320px;max-height:320px">
				<div class="c-form"  style="padding: 0px;">
					<div class="form" style="">	
						<div class="form-item">
							<span class="form-tag">名称：</span>
							<div class="form-c" style="">
								<input type="text" class="form-text" id="d_n" name="d_n" onblur="if($(this).val()==''){$(this).next().hide();return false;}regCheck(this,nameReg);" maxlength="128">
								<i class="v-check"></i>
								<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
							</div>
							<span class="form-tag" style=""><em class="imp">*</em>协议类型：</span>
							<div class="form-c" style="">
								<select class="form-select" name="Protocol" id="Protocol" style="width:150px;">
									<option value="0" selected>请选择</option>
								</select>
							</div>
							<span class="form-tag" id="Protocol_port"></span>
						</div>
						<!-- SSH -->
						<div id="SSH" style="display:none;">
							<div class="form-item">
								<span class="form-tag">版本号：</span>
								<div class="form-c">
									<select class="form-select" name="ServiceName_ssh" id="ServiceName_ssh" style="width:150px;">
										<option value="1" selected>1</option>
										<option value="2" >2</option>
									</select>
								</div>
							</div>
						</div>
						<!-- SFTP -->
						<div id="SFTP" style="display:none;">
							<div class="form-item">
								<span class="form-tag">版本号：</span>
								<div class="form-c">
									<select class="form-select" name="ServiceName_sftp" id="ServiceName_sftp" style="width:150px;">
										<option value="1" selected>1</option>
										<option value="2" >2</option>
									</select>
								</div>
							</div>
						</div>
						<!--HTTP-->
						<div id="HTTP"  style="display:none;" >
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>URL：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="url" name="url" maxlength="128" style="width:252px;padding-right:8px;">
								</div>
								<span class="form-tag">账号元素：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="UserName" name="UserName" maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag">密码元素：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="UserPwd" name="UserPwd"  maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
								<span class="form-tag">提交元素：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="Submit" name="Submit" maxlength="128" style="width:252px;padding-right:8px;">
								</div>
							</div>
						</div>
						<!--HTTPS-->
						<div id="HTTPs" style="display:none;">
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>URL：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="httpsurl" name="httpsurl" maxlength="128" style="width:252px;padding-right:8px;">
								</div>
								<span class="form-tag">账号：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="httpsUserName" name="httpsUserName" maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag">密码：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="httpsUserPwd" name="httpsUserPwd" maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
								<span class="form-tag">提交元素：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="httpsSubmit" name="httpsSubmit" maxlength="128" style="width:252px;padding-right:8px;">
								</div>
							</div>
						</div>
						<!--RDP-->
						<div id="RDP" style="display:none;">
							<div class="form-item">
								<span class="form-tag">访问方式：</span>
								<div class="form-c">
									<select class="form-select" name="rdpType" id="rdpType" style="width:150px;">
										<option value="NORMAL" text="NORMAL">NORMAL</option>
										<option value="CONSOLE" text="CONSOLE">CONSOLE</option>
									</select>
								</div>
							</div>
						</div>						
						<!--ORACLE-->
						<div id="ORACLE" style="display:none;">
							<div class="form-item">							
								<span class="form-tag"><em class="imp">*</em>实例名或服务名：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="s_n" name="s_n"  maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
								<span class="form-tag"><em class="imp">*</em>指定：</span>
								<div class="form-c">
									<select class="form-select" name="appoint" id="appoint" style="width:150px;">
										<option value="0" text="请选择" selected>请选择</option>
										<option value="1" text="SID">SID</option>
										<option value="2" text="SERVICE_NAME">SERVICE_NAME</option>
									</select>
								</div>
							</div>
							<div class="form-item">
								<span class="form-tag">连接方式：</span>
								<div class="form-c">
									<select class="form-select" name="conn" id="conn" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="1" text="NORMAL">NORMAL</option>
										<option value="2" text="SYSDBA">SYSDBA</option>
										<option value="3" text="SYSOPER">SYSOPER</option>
									</select>
								</div>
							</div>
						</div>
						<!--RADMIN-->
						<div id="RADMIN" style="display:none;">
							<div class="form-item">
								<span class="form-tag">认证方式：</span>
								<div class="form-c">
									<select class="form-select" name="authtype" id="authtype" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="1" text="RADMIN">RADMIN</option>
										<option value="2" text="Windows">Windows</option>
									</select>
								</div>
							</div>
						</div>
						<!--MSSQL-->
						<div id="MSSQL" style="display:none;">
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>实例名：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="o_n" name="o_n" maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
								<span class="form-tag">认证方式：</span>
								<div class="form-c">
									<select class="form-select" name="R_authtype" id="R_authtype" style="width:150px;">
										<option value="0" text="未指定" selected>未指定</option>
										<option value="1" text="SQL服务器验证" >SQL服务器验证</option>
										<option value="2" text="Windows验证" >Windows验证</option>
										<option value="3" text="Windows单一登录" >Windows单一登录</option>
									</select>
								</div>
							</div>
						</div>
						<!--MYSQL &&　DB2-->
						<div id="MY_DB2" style="display:none;">
							<div class="form-item" style="min-height:40px;">
								<span class="form-tag"><em class="imp">*</em>数据库名：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="sql_n" name="sql_n" maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
							</div>
						</div>
						<div id="MY_ConnType" style="display:none;">
							<div class="form-item" style="min-height:40px;">
								<span class="form-tag"><em class="imp">*</em>版本号：</span>
								<div class="form-c">
									<select class="form-select" name="select_my" id="select_my" style="width:150px;">
										<option value="0" text="0" selected>&lt;7.5</option>
										<option value="1" text="1" >≥7.5</option>
									</select>
								</div>
							</div>
						</div>						
						<!--SYBASE-->
						<div id="SYBASE" style="display:none;">
							<div class="form-item"  style="min-height:40px;">
								<span class="form-tag"><em class="imp">*</em>实例名：</span>
								<div class="form-c">
									<input type="text" class="form-text" id="sy_o_n" name="sy_o_n" maxlength="128" style="width:252px;padding-right:8px;">
									<p class="form-tip">不能含有特殊字符</p>
								</div>
							</div>
						</div>
						<!---->
					</div>
				</div>

				<div class="btns" style="padding: 10px 0 10px;">
					<a href="javascript:;" class="btn btn-normal btn-submit s-hide">保&nbsp;&nbsp;存</a>
					<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
				</div>
			</div>
		</div>
	</div>
	<!-- 添加账号内账号编辑浮层 -->
	<div class="dialog-cont" id="AccEditDialog" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:320px;max-height:320px">
				<div class="c-form" style="padding: 0px; max-height: 240px; overflow: auto;">
					<div id="first_div"></div>
						<div id="luo0" style="float:left;width:97%;position: static;">
							<div class="form-item" style="width:50%;float:left;">
								<span class="form-tag" style="width:60px"><em class="imp">*</em>账号：</span>
								<div class="form-c sel-type1" id = "account_name" style="margin-bottom: 15px;width: 270px;float: left;padding: 1px 10px 10px 10px;">
										<input type="text" class="form-text" id="Name0" onblur="NameCheck1(this)" maxlength="127"><i class="v-check" id="check0"></i>
									<p class="form-tip" id="prompt0" style="padding-left: 0px;">特殊字符仅支持@(仅可用1次)、下划线、横杠、小数点</p>
								</div>
							</div>
							<div class="form-item" style="width:50%;float:left;margin-top: 1px;">
								<span class="form-tag" style="width:70px">AD域：</span>
										
								<div class="form-c sel-type1" style="float:left;width: 280px;padding-left:15px;">
									<li id="add_AD0">
										<select name="" id="ADregion0" onchange="AD_change(0,this);" class="type-select" style="width:250px">
										</select>
										<i class="ctrl add" id="edit_hide" onclick="addinput(this)"></i>
									</li>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="btns" style="padding: 10px 0 10px;">
					<a href="javascript:;" class="btn btn-normal btn-submit s-hide">保&nbsp;&nbsp;存</a>
					<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
				</div>
			</div>
		</div>
	</div>

	<!-- 添加（编辑）密钥浮层 -->
	<div class="dialog-cont" id="SSHKeyDialog" style="display:none;">
		<div class="container">
			<div class="c-cont" style="max-height: 450px; min-height: 450px;">
				<div class="c-form" style="width:auto; padding: 0px 0 0;">
					<div class="form">
						<div class="form-item">
							<span class="form-tag"><em class="imp">*</em>名称：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="d_n1" name="d_n1" onblur="regCheck(this,nameReg);" maxlength="128">
								<i class="v-check"></i>
								<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
							</div>
						</div>
						<div class="form-item">
							<span class="form-tag">类型：</span>
							<div class="form-c">
								<select class="form-select form-select2" name="Protocol1" id="Protocol1" style="width:150px;">
									<option value="1" selected>私钥</option>
									<option value="0" >公钥</option>
								</select>
							</div>
						</div>
						
						<!-- <div class="form-item">
							<span class="form-tag">状态：</span>
							<div class="form-c" style="margin-top: 3px;">
									<input type="checkbox" class="form-checkbox" id="Enable"/>
									<span style="vertical-align:middle;font-size:16px; color: #000;">启用</span>
							</div>
						</div> -->
						<div class="form-item" style="width: 380px;">
							<span class="form-tag"><!--<em class="imp">*</em>-->设置密码：</span>
							<div class="form-c">
								<input type="password" class="form-text" id="Password" name="Password" onblur="" maxlength="128" style="width: 160px;padding-right: 8px;">
									<!-- <p class="form-tip">长度为16位</p> -->
							</div>
						</div>
						<div class="form-item" style="width: 280px;">
							<span class="form-tag" style="width: 92px;"><!--<em class="imp">*</em>-->确认密码：</span>
							<div class="form-c" style="padding-left: 100px;">
								<input type="password" class="form-text" id="Password_two" name="Password_two" onblur="" maxlength="128" style="width: 160px;padding-right: 8px;">
								<!-- <p class="form-tip">长度为16位</p> -->
							</div>
						</div>
						<div class="form-item">
							<span class="form-tag"><em class="imp">*</em>内容：</span>
							<div class="form-c">
								<textarea type="textarea" class="form-text" id="content" style="width: 430px; height: 150px; resize: none"></textarea>
							</div>
						</div>
						
					</div>
				</div>

			</div>
			<div class="btns" style="padding: 10px 0 10px;">
				<a href="javascript:;" class="btn btn-normal btn-submit s-hide">保&nbsp;&nbsp;存</a>
				<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
			</div>
		</div>
	</div>
	<!-- 导出方式 浮层-->
	<!--<div class="dialog-cont s-hide" id="export_type" style="display:none;">
		<div class="container">
			<div id="export_module" class="c-cont" style="min-height:350px;max-height:300px;overflow:hidden;">
				<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
					<span>方式：</span>
					<label class="form-label" style="width: 60px;">
						<input type="radio" class="form-radio" id="all_check" value="all" name="exportType_radio" checked="checked"/>所有
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="resource_check" value="resource" name="exportType_radio"/>资源
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="host_check" value="host" name="exportType_radio"/>主机
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="host_group_check" value="host_group" name="exportType_radio"/>主机组
					</label>
				</div>
				<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
					<span>格式：</span>
					<label class="form-label" style="width: 60px;">
						<input type="radio" class="form-radio" value=0 name="exportType_radio2" checked="checked"/>CSV
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="radio" class="form-radio" value=1 name="exportType_radio2"/>XLS
					</label>
					<label class="form-label" style="width: 60px;display:none;">
						<input type="radio" class="form-radio" value=2 name="exportType_radio2"/>XLSX
					</label>
				</div>
			</div>
			<div class="btns" style="/*padding: 20px 0 0px;*/">
				<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
			</div>
		</div>
	</div>
	-->
	<form action="/bhost/import_data" method="POST" name="frm1" enctype="multipart/form-data">
		<input type="hidden" name="z1"  value="" />
		<input type="hidden" name="a0"  value="" />
		<input type="hidden" name="a1"  value="" />
		<input type="hidden" name="a99"  value="" />
	</form>
{% endblock  %}		


{% block script %}
<style>
	.span_s{
		margin:20px;
	}
	#SSHKeyDialog .form-item{
		float:left;
	}
	.btns a.btn-normal {
		outline: none;
	}
	a.btn-normal1{
		outline: none;
	}
	#importHost {
		outline: none;
	}
	.srsCtl:hover a.del{
		display: inline-block;
	}
	.srsCtl1:hover a.del.ctrl{
		display: inline-block !important;
	}
	#accIP .xSelect-show {
		/*border-bottom-right-radius: 5px;
		border-top-right-radius: 5px;*/
		border-bottom-left-radius: 0px;
		border-top-left-radius: 0px;
		margin-left: -1px;
	}
	#AccountName.xSelect-show {
		border-bottom-right-radius: 5px;
		border-top-right-radius: 5px;
		border-bottom-left-radius: 0px;
		border-top-left-radius: 0px;
		margin-left: -1px;
	}
	.form-c.srsCtl .xSelect-show {
		/*border-bottom-right-radius: 5px;
		border-top-right-radius: 5px;*/
		border-bottom-left-radius: 0px;
		border-top-left-radius: 0px;
		margin-left: -1px;
	}
	.accIP_type span.select2-selection {
		border-bottom-right-radius: 0px;
	    border-top-right-radius: 0px;
	}
	.in_ip span.select2-selection {
		border-bottom-left-radius: 0px;
	    border-top-left-radius: 0px;
	}

	#ProtocolName .xSelect-show {
		/*border-bottom-left-radius: 5px;*/
	    /*border-top-left-radius: 5px;*/
	    margin-left: 0px;
	}

	#ConnParamName .xSelect-show {
		/*border-bottom-left-radius: 5px;
	    border-top-left-radius: 5px;*/
	    margin-left: 0px;
	}
	.ui-dialog-body{
		padding: 20px 0 0 0;
	}
	.filter_service .selector.selector-multiple:after {
		content: '';
		display: block;
		border-color: #888 transparent transparent transparent;
		border-style: solid;
		border-width: 5px 4px 0 4px;
		height: 0;
		width: 0;
		overflow: hidden;
		position: fixed;
		margin: 11px 0 0 7.5em;
		float: none;
		left: 55px;
	}
	#ConnParamDialog span.form-tag {
		width:115px;
	}
	#ConnParamDialog div.form-c {
		float: left;padding-left: 0px;
	}
	#ConnParamDialog div.form-item {
		min-height: 33px;
	}

	#ADDialog span.form-tag {
		width:115px;
	}
	#ADDialog div.form-c {
		padding-left: 0px;
	}
	a.btn-first-grp {
		float: left;
		padding: 0 15px;
		line-height: 24px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
		margin-top: 2px;
		background-color: #fff;
	}
	a.btn-first-grp:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}
	.as{
		width:190px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		float:left;
		margin-top: 4px;
	}
	.h-content2 .form-item {
		height: auto;
		padding: 20px 0 10px;
		min-height: 46px;
		padding: 5px;
		width: 380px;
		float: left;
	}
	.h-content2 .form-tag {
		float: left;
		width: 80px;
		text-align: right;
		color: #000;
		line-height: 28px;
	}
	.h-content2 .form-c {
	    padding-left: 0px;
	    position: relative;
	}
	.h-content2 .form-text {
	    width: 200px;
	}
	.h-content2 .rzj {
		float: right;
		margin-right: 20px;
		color: #000;
		margin-top: -11px;
	}
	.h-content2 .form-tip {
	    padding-left: 48px;

	}
	a.btn-normal1{
		display: inline-block;
		width: 90px;
		height: 32px;
		border: 1px solid #DDD;
		text-align: center;
		line-height: 32px;
		border-radius: 18px;
		margin: 0 10px;
		background-color: #fff;
		transition: background-color 0.4s;
		color: #7c7c7c;
	}
	.ani_dot {
	    font-family: simsun;    
	}
	:root .ani_dot {
		display: inline-block;
		width: 1.5em;
		vertical-align: bottom;
		overflow: hidden;
	}
	@-webkit-keyframes dot {
		0% { width: 0; margin-right: 1.5em; }
		33% { width: .5em; margin-right: 1em; }
		66% { width: 1em; margin-right: .5em; }
		100% { width: 1.5em; margin-right: 0;}
	}
	.ani_dot {
	    -webkit-animation: dot 3s infinite step-start;
	}

	@keyframes dot {
		0% { width: 0; margin-right: 1.5em; }
		33% { width: .5em; margin-right: 1em; }
		66% { width: 1em; margin-right: .5em; }
		100% { width: 1.5em; margin-right: 0;}
	}
	.ani_dot {
	    animation: dot 3s infinite step-start;
	}
	.h-catelog-tmp a.active {
		background-color:#fff;
		color: rgb(77, 77, 77);
	}
	a.btn-normal1:hover{
		background-color: #8d808a;
		color: #fff;
	}
	.ui-dialog-content .c-form-host{
		min-width: 780px;
	}
	.c-table{
		padding: 20px 10px;
	}
	.c-form-host.col3 .form-item{
		width: 33.3%;
	}
	.c-form-host.col3 .form-item-100{
		width: 100%;
	}
	.c-form-host.col3 .form-item .form-text{
		width: 100px;
	}
	.c-form-host.col3 .form-item .h-content3{
		padding: 0;
	}
	.select2-container--open{z-index: 9999999;}
	#autoView{z-index: 99999990;}
	.blank_in{width: 12px;}

	.fsel{
		position:fixed;
		margin:-67px 0 0 -20px;
		width:580px;
		height:45px;
		background:#FFF;
	}
	.fsel ul li{
		float:left;
	}
	.fsel ul li a{
		float:left;
		padding:0 32px;
		line-height:45px;
		font-size:18px;
		color:#000;
	}
	.fsel ul li a.active{
		border-top:5px solid #4cb2d0;
		border-right:1px solid #DDD;
		border-left:1px solid #DDD;
		line-height:41px;
		border-bottom:1px solid #FFF;
	}

	#details_module table th {
		text-align:center
	}
	#details_module table td {
		text-align:center
	}
	#table_title th{
		text-align:center
	}
	#hosttask_list_detail td{
		text-align:center
	}
	#import_host_list_detail td{
		text-align:center
	}
	#importPage{
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: #f3f3f3;
		overflow: auto;
	}
	.apItem .label.succ:before{
		content: '';
		float: left;
		/*width: 8px;
		height: 4px;
		background-color: green;*/
		width: 20px;
		height:20px;
		margin: 3px 14px 0 14px;
		background: url(/manage/images/host_succ.png) no-repeat 0 0;
	}
	.apItem .label.fail:before{
		content: '';
		float: left;
		/*width: 8px;
		height: 4px;
		background-color: red;*/
		width: 20px;
		height:20px;
		margin: 3px 14px 0 14px;
		background: url(/manage/images/host_fail.png) no-repeat 0 0;
	}
	#filterWW_account:after{
		margin: 10px 0 0 30.5em;
	}
	/*
	#AccountName div {
		border-bottom-left-radius: 5px;
		border-top-left-radius: 5px;
	}
	*/
	.h-content .item{
		height:105px;
	}
	.h-content .item .c, .h-content .item .c2{
		width:110px;
	}
	#hosttask_list .tab-ctr {
		display: none !important;
	}
	#hosttask_list tr:hover td div.tab-ctr {
		display: block !important;
	}
	#export_list .tab-ctr {
		display: none !important;
	}
	#export_list tr:hover td div.tab-ctr {
		display: block !important;
	}
	.h-content-list{
		padding-top:0px !important;
	}
	.h-content-list tr td.in {
		width:10px;
	}
	.h-content-list tr td:last-child {
		width:125px;
	}
	.h-content-list tr td:nth-child(3){
		width:50px;
	}
	.h-content-list tr td:nth-child(5){
		width:40px;
	}
	.h-content-list tr td:nth-child(4){
		width:100px;
	}
	.h-content-list .tab-ctr a {
		width:16px !important;
	}
	.h-content-list .item{
		display:none;
	}
	.h-content-list .item i{
		display:none;
	}
	.h-content-list .item .c {
		width: 99%;/*写给不支持calc()的浏览器*/ 
		width:-moz-calc(100% - (1px) * 2); 
		width:-webkit-calc(100% - (1px) * 2); 
		width: calc(100% - (1px) * 2);
		padding: 6px 0;
	}
	.h-content-list .item .div_item {
		float: left;
		width: 25%;
	}
	.h-content-list .c-table {
		padding: 10px 10px 0 10px;
	}
	.h-content-list .c-table {
		padding: 10px 10px 0 10px;
	}
	.h-path-wrap a {
		line-height: 18px;
		padding: 0px 4px;
		border-width: 1px;
		border-style: solid;
		border-color: rgb(217, 217, 217);
		border-image: initial;
	}
	div.icon-div i {
		width: 30px;
    	height: 30px;
	}
	div.icon-div i.add-host {
		float: right;
		margin-right: 0;
		margin-left: 5px;
		margin-top: 3px;
		background: url(/manage/images/icon-coll24.png) no-repeat 50% 50%;
		cursor: pointer;
	}
	div.icon-div i.add-group {
		float: right;
		margin-right: 0;
		margin-left: 5px;
		margin-top: 3px;
		background: url(/manage/images/icon-coll22.png) no-repeat 50% 50%;
		cursor: pointer;
	}
	div.icon-div i.add-manager {
		float: right;
		margin-right: 0;
		margin-left: 5px;
		margin-top: 3px;
		background: url(/manage/images/icon-coll21.png) no-repeat 50% 50%;
		cursor: pointer;
	}
</style>

<script src="/manage/js/xSelect.js"></script>
<script>
var first_grp='{{first_grp}}';
if (first_grp=='0'){
	$('#first_grp').text('列表');
	$('#first_grp').attr("value", '0');
	$('#first_grp').show();
}else{
	$('#first_grp').text('图标');
	$('#first_grp').attr("value",'1');
	$('#first_grp').show();
}
$('.filter-select,.form-select').select2({ minimumResultsForSearch: -1 });
var service_json={
	"HostSet": [],
	"HGroupSet": []
}
var SUP_PROTOCOL = ['SSH','ORACLE','MSSQL','MYSQL','TELNET','FTP','VNC','SYBASE','DB2','RLOGIN','RDP','INFORMIX'];		//连接测试支持协议；
var TEST_TIME = 1000;				//取连接测试结果间隔时间；
var TEST_TIMEOUT = 300000;		//连接测试超时时间；
var acc_namereg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.@]+$/;
var se;
var service_ajax_value='PGetAccountProtocolForAuth';
var import_data_result = {{result|safe}};
var last_object=null;
var edit_id=null;
var push_filter_wait = [];
var top1=9007199254740991;
var data_array_Path=null;
var search_typeall_new='';
var host_path_all =[];
var index_f = 0;
var push_hgid = [];
var push_hid = [];
var hdata=null;
var filter_flag_append = false;
var flag_loading=false;
var loading_hgid=0;
var find_host_arry=[];
var find_host_flag = 0;
var old_path_all = [];
var sess = window.parent.document.frm.se.value;
var _if_disable = '2';
$(function(){
	_if_disable = $('#nav-s1 li[data-modeid=4]',parent.document).attr('_if_disable').split('-')[1];
	if(_if_disable == '1'){
		$('.s-hide').remove();
		//disabled_class = '-role-disabled';
	}

	/*
	repeat_msg = function(){
		if_msg = setInterval(function(){
			get_over_msg();
		},5000)}
	repeat_msg();
	*/
	//输入数字
	$('#Port_service').bind('keydown', function(e){
		DigitInput(e);
	});
	document.frm_access.us.value=window.parent.document.frm.us.value;
	document.frm_access.se.value=window.parent.document.frm.se.value;
	usercode = window.parent.document.frm.us.value;
	se = window.parent.document.frm.se.value;
	// server_find_json.loginusercode=usercode;
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
	$('.form-select,.filter-select').select2({ minimumResultsForSearch: -1 });

	// $("#account_text").val("");
	/*
	$("#account_select").change(function(){
		var type = $(this).val();
		if(type == -1){
			$("#account_text").hide();
			$('#filterWW_account').hide();
			$('#clearFilter_account').hide();
		}else{
			$("#account_text").show();
			if($('#filterWW_account ul li').length){
				$('#filterWW_account').show();
				$('#clearFilter_account').show();
			}
		}
	});
	*/
	$('#mix_select_zdp').on('change',function(){
		//save_host($('#hostTree_z'));
		$("#check_one_page_zdp").iCheck('uncheck');
		account_list_show();
	});
	$("#service_list_a").on("ifChanged",function(){
		if($("#service_list_a").find("input:checked").length==$("#service_list_a").find('input').length){
			$('#check_one_page_zdp').iCheck('check');
		}else{
			$('#check_one_page_zdp').iCheck('uncheck');
		}	
	});
	
	$('#check_one_page_zdp').on('ifClicked',function(e){
		if(!$('#check_one_page_zdp').is(':checked')){
			$("#service_list_a").find("input").iCheck('check');
		}else{
			$("#service_list_a").find("input").iCheck('uncheck');
		}
	});
	
	
	$('#mix_select').on('change',function(){
		service_ajax_value=$('#mix_select').val();
		service_list_ajax();
		var w=$(window).width();
		$('#service_div0').width(w-40);
		$('#service_div2').width($('#service_div0').width()-$('#service_div1').width()-4);
	})
	$("#service_list_").on("ifChecked",function(e){
		if($("#service_list_").find("input:checked").length==$("#service_list_ tr").length){
			$('#check_one_page').iCheck('check');
		}
	}).on("ifUnchecked",function(e){
		$('#check_one_page').iCheck('uncheck');	
	});
	$('#check_one_page').on('ifClicked',function(e){
		if(!$('#check_one_page').is(':checked')){
			$("#service_list_").find("input").iCheck('check');
		}else{
			$("#service_list_").find("input").iCheck('uncheck');
		}
	});
	$("#service_select").change(function(){
		var type = $(this).val();
		if(type == 0){
			$("#service_text").hide();
			$('#filterWW_service').hide();
			$('#clearFilter_service').hide();
		}else{
			$("#service_text").show();
			if($('#filterWW_service ul li').length){
				$('#filterWW_service').show();
				$('#clearFilter_service').show();
			}
		}
	});
	
	//tr双击事件
	$("#service_list_").on('dblclick','tr',function(e){
	}).on("click", "tr", function (e){  
		x=e.target;
		//删除按钮
		if(x.id == 'del'){
			var id=$(this).find("td");
			$('.btn').blur();
			parent.layer.open({
				type:1,
				title: '批量服务',
				content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
				btn:['删&nbsp;&nbsp;除','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				yes:function(i){
					parent.layer.close(i);
					var service_del=JSON.parse(JSON.stringify(service_json));
					service_del["ServiceSet"]=new Array();
					if($(id).eq(4).text()==''){
						var json_a='{"ProtocolId":'+$(id).eq(1).text()+',"Port":'+$(id).eq(3).text()+',"ProtocolName":"'+$(id).eq(2).text()+'"}';
					}else{
						var json_a='{"ProtocolId":'+$(id).eq(1).text()+',"Port":'+$(id).eq(3).text()+',"ConnParamId":'+$(id).eq(4).text()+',"ProtocolName":"'+$(id).eq(2).text()+'","ConnParamName":"'+$(id).eq(5).text()+'"}';
					}
					service_del.ServiceSet.push(JSON.parse(json_a));
					del_function(service_del);
				}
			});
		}
		//编辑按钮
		if(x.id == 'edit'){
			var id=$(this).find("td");
			var edit_item=$(id).eq(1).text();
		}
	});
	$("#ProtocolName_service").on("change",function(){
		$("#Port_service").val($("#ProtocolName_service option:selected").attr("data"));
		//获取 连接参数
		$.ajax({
			url:'/bhost/get_ConnParam_list',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:$(this).val()},
			success: function(Result) {
				var data = (JSON.parse(Result)).data;
				$("#ConnParamName_service").empty();
				$("#ConnParamName_service").append("<option value=\"-1\">请选择</option>");
				$.each(data,function(i,item){		
					$("#ConnParamName_service").append("<option value=\""+item.ConnParamId+"\" >"+item.ConnParamName+"</option>");
				})	
			}
		})
	})
	$('#userTree').on('change','input',function(){
		service_json.HGroupSet=new Array();
		service_json.HostSet=new Array();
		save_service_hg_host($('#userTree'),0);
		service_list_ajax();
		var w=$(window).width();
		$('#service_div0').width(w-40);
		$('#service_div2').width($('#service_div0').width()-$('#service_div1').width()-4);
	})
})
function del_service_all(){
	if(service_json.HGroupSet.length==0 && service_json.HostSet.length==0){
		_alert(2,'批量服务','请选择主机');
		return false;
	}
	var service_del_all=JSON.parse(JSON.stringify(service_json));
	service_del_all["ServiceSet"]=new Array();
	if($('#service_list_ tr').find('input:checked').length==0){
		_alert(2,"批量服务","请选择要删除的数据");
		return false;
	}
	$('.btn').blur();parent.layer.open({
		type:1,
		title: '批量服务',
		content: '<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
		btn:['删&nbsp;&nbsp;除','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		yes:function(i){
			parent.layer.close(i);
			$.each($('#service_list_ tr'),function(e){
				if($(this).find('input').is(':checked')){
					var id=$(this).find("td");
					if($(id).eq(4).text()==''){
						var json_a='{"ProtocolId":'+$(id).eq(1).text()+',"Port":'+$(id).eq(3).text()+',"ProtocolName":"'+$(id).eq(2).text()+'"}';
					}else{
						var json_a='{"ProtocolId":'+$(id).eq(1).text()+',"Port":'+$(id).eq(3).text()+',"ConnParamId":'+$(id).eq(4).text()+',"ProtocolName":"'+$(id).eq(2).text()+'","ConnParamName":"'+$(id).eq(5).text()+'"}';
					}
					service_del_all.ServiceSet.push(JSON.parse(json_a));
				}
			})
			del_function(service_del_all);
		}
	});
}

function del_function(service_del) {
	var msstr = aceg(JSON.stringify(service_del),$("input[name=se]").val());
	$.ajax({
		url:'/bhost/PBatchDeleteHostService',
		type: "post",
		async:false,
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(service_del), m1:msstr},
		success: function(result) {
			var result=JSON.parse(result);
			if(result.Result){
				_alert(0,'批量服务','成功数：'+result.SuccCount+'，失败数：'+result.FailCount);
				service_list_ajax();

			}else{
				_alert(2,'批量服务',result.ErrMsg);
			}
		}
	})
}

function service_list_ajax(){
	$('#check_one_page').iCheck('uncheck');
	$.ajax({
		url:'/bhost/'+service_ajax_value,
		type: "post",
		async:false,
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(service_json)},
		success: function(result) {
			//_initSize();
			var result=JSON.parse(result);
			if(result.Result){
				$('#service_list_').empty();
				$('#service_list_').hide();
				$.each(result.info.ServiceSet,function (i,item) {
					if (item.ServiceName==null){
						item.ServiceName='';
					}
					if(item.ConnParamId==null){
						item.ConnParamId='';
						item["ConnParamName"]='';
					}
					$('#service_list_').append('<tr>'+
					'<td width="50" class="in"><input type="checkbox" class="form-checkbox" id=""/></td>'+
					// '<td>'+item.ServiceName+'</td>'+
					'<td style = "display:none">'+item.ProtocolId+'</td>'+
					'<td>'+item.ProtocolName+'</td>'+
					'<td>'+item.Port+'</td>'+
					'<td style = "display:none">'+item.ConnParamId+'</td>'+
					'<td>'+item.ConnParamName+'</td>'+
					'<td width="23"><div class=\"tab-ctr\">'+
					// '<a href=\"javascript:;\" style = "width:6px;" class=\"edit\" id=\"edit\"></a>'+
					'<a href=\"javascript:;\" style = "width:8px;" class=\"del\" id=\"del\"></a></div></td></tr>');
				})
				$('#service_list_ input').iCheck({
					checkboxClass: 'icheckbox_minimal-blue',
					radioClass: 'iradio_minimal-blue',
					increaseArea: '0' // optional
				});
				$('#service_list_').show();
			}else{
				_alert(2,'批量服务',result.ErrMsg);
			}
		}
	})
}

//递归查询服务树选中情况
function save_service_hg_host(obj, id) {
	$(">li", obj).children('input').each(function () {
		var input_id = $(this).attr('id');
		var i_class=$(this).prev('i').attr('class');
		var input_str = input_id.split('-');
		var input_state = $(this).next('span.checkbox').attr('class');
		var $u = $(this).parent().children('ul');
		var name=$(this).siblings('span.h-name').text();
		if (input_state.indexOf('checked') > 0) {
			if (input_str[0] == "HGId" && i_class.indexOf('h-aicon')>=0) {
				var json_a = '{"HGId":' + input_str[1] + ',"Name":"'+name+'"}';
				service_json.HGroupSet.push(JSON.parse(json_a));
			} else if(input_str[0] == "HostId"){
				var index=name.indexOf('(');
				name=name.substring(0,index);
				var json_a = '{"HostId":' + input_str[2] + ',"Name":"'+name+'"}';
				service_json.HostSet.push(JSON.parse(json_a));
			}
		} else if (input_state.indexOf('half') > 0) {
			if ($u.text() != "Loading..." && $u.text() != "") {
				save_service_hg_host($u, input_str[1]);
			}
		}
	});
}

function port_check(obj){
	obj.value = obj.value.replace(/\D/g,"");
	if(parseInt(obj.value)<1){
		obj.value=1;
	}else if(parseInt(obj.value)>65534){
		obj.value=65534;
	}
}
//服务添加or编辑浮层
function getService_Dialog(type,obj){
	var obj_class=$(obj).attr('class');
	obj_class.replace('active','');
	$(obj).attr('class',obj_class);
	if(service_json.HGroupSet.length==0 && service_json.HostSet.length==0){
		_alert(2,'批量服务','请选择主机');
		return false;
	}
	clear_service();
	var $dialogCont = $("#scDCTab_service").show();
	if(type == 'edit'){
		title = '编辑服务';
	}else{
		title = '添加服务';
	}
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"scDCTab_service",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	//获取协议
	$.ajax({
		url:'/bhost/get_protocol_list',
		type: "post",
		async:false,
		cache:false,
		data: {a0: $("input[name=se]").val(),a1:1,a2:null,a3:null,a4:',,',a5:null},
		success: function(Result) {
			proto_list = JSON.parse(Result);
			$("#ProtocolName_service").empty();
			$("#ProtocolName_service").append("<option value=\"-1\" data=\"\">请选择</option>");
			$.each(proto_list.data,function(i,item){		
				$("#ProtocolName_service").append("<option value=\""+item.ProtocolId+"\" data=\""+item.Port+"\">"+item.ProtocolName+"</option>");
			})	
		}
	})
	if(type == 'edit'){
	}
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		clear_service();
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		// if(_addService(type) == false) return false;
		var service_save=JSON.parse(JSON.stringify(service_json));
		service_save["ServiceSet"]=new Array();
		var ProtocolName_service=$('#ProtocolName_service').val();
		if(ProtocolName_service=='-1'){
			_alert(2,title,'请选择协议');
			return false;
		}
		var Port_service=$('#Port_service').val();
		if(Port_service==''){
			_alert(2,title,'请输入端口');
			return false;
		}else if(parseInt(Port_service)<1){
			_alert(1,title,'端口格式不正确');
			return false;
		}else if(parseInt(Port_service)>65534){
			_alert(1,title,'端口格式不正确');
			return false;
		}
		var ProtocolName_service_text=$('#ProtocolName_service option:selected').text();
		var ConnParamName_service=$('#ConnParamName_service').val();
		if(ConnParamName_service!='-1'){
			var ConnParamName_service_text=$('#ConnParamName_service option:selected').text();
			var json_a = '{"ProtocolId":' + ProtocolName_service + 
							',"ProtocolName":"'+ProtocolName_service_text+
							'","Port":'+Port_service+
							',"ConnParamId":'+ConnParamName_service+
							',"ConnParamName":"'+ConnParamName_service_text+'"}';
		}else{
			var json_a = '{"ProtocolId":' + ProtocolName_service + 
							',"ProtocolName":"'+ProtocolName_service_text+
							'","Port":'+Port_service+'}';
		}
		service_save.ServiceSet.push(JSON.parse(json_a));
		service_save['LoginUserCode']=window.document.frm.us.value;
		var pass=save_service(service_save);
		if(pass!=false){
			$('.btn').blur();parent.layer.open({
				type:1,
				title: '批量服务',
				content: '<div class="layer-alert"><i class="alert succ"></i>'+pass+'</div>',
				btn:['确&nbsp;&nbsp;定'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				yes:function(i){
					parent.layer.close(i);
					d.close().remove();
					service_list_ajax();
				}
			});
		}
	})
}
function save_service(service_save){
	var pass=false;
	var msstr = aceg(JSON.stringify(service_save),$("input[name=se]").val());
	$.ajax({
		url:'/bhost/PBatchSaveHostService',
		type: "post",
		async:false,
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(service_save),m1:msstr},
		success: function(result) {
			var result=JSON.parse(result);
			if(result.Result){
					pass='成功：'+result.SuccCount+'，失败：'+result.FailCount;
			}else{
				_alert(2,'批量服务',result.ErrMsg);
			}
		}
	})
	return pass;
}
function clear_service(){
	$('#Port_service').val('');
	$('#ConnParamName_service option[value!=-1]').remove();
	$('#ProtocolName_service').val('-1').trigger('change');
}
/* 
* 处理过长的字符串，截取并添加省略号 
* 注：半角长度为1，全角长度为2 
*  
* pStr:字符串 
* pLen:截取长度 
*  
* return: 截取后的字符串 
*/
function autoAddEllipsis(pStr, pLen) {

	var _ret = cutString(pStr, pLen);
	var _cutFlag = _ret.cutflag;
	var _cutStringn = _ret.cutstring;

	if ("1" == _cutFlag) {
		return _cutStringn + "...";
	} else {
		return _cutStringn;
	}
}
/* 
* 取得指定长度的字符串 
* 注：半角长度为1，全角长度为2 
*  
* pStr:字符串 
* pLen:截取长度 
*  
* return: 截取后的字符串 
*/
function cutString(pStr, pLen) {

	// 原字符串长度  
	var _strLen = pStr.length;

	var _tmpCode;

	var _cutString;

	// 默认情况下，返回的字符串是原字符串的一部分  
	var _cutFlag = "1";

	var _lenCount = 0;

	var _ret = false;

	if (_strLen <= pLen / 2) {
		_cutString = pStr;
		_ret = true;
	}

	if (!_ret) {
		for (var i = 0; i < _strLen; i++) {
			if (isFull(pStr.charAt(i))) {
				_lenCount += 2;
			} else {
				_lenCount += 1;
			}

			if (_lenCount > pLen) {
				_cutString = pStr.substring(0, i);
				_ret = true;
				break;
			} else if (_lenCount == pLen) {
				_cutString = pStr.substring(0, i + 1);
				_ret = true;
				break;
			}
		}
	}

	if (!_ret) {
		_cutString = pStr;
		_ret = true;
	}

	if (_cutString.length == _strLen) {
		_cutFlag = "0";
	}

	return { "cutstring": _cutString, "cutflag": _cutFlag };
}

/* 
* 判断是否为全角 
*  
* pChar:长度为1的字符串 
* return: true:全角 
*          false:半角 
*/
function isFull(pChar) {
	if ((pChar.charCodeAt(0) > 128)) {
		return true;
	} else {
		return false;
	}
}
function server_add_or_clear(){
	$('#_HostList').hide();
	search_typeall_new='';
	search_typeall_r='';
	$("#service_select").val('all').trigger('change');
	$("#service_text").val("");
	$('#service_text_check').hide();
	data_array_Path_service=null;
	$("#service_list_").empty();
	$('#check_one_page').iCheck('uncheck');
	$('#_account').hide();
	$('#_Server').show();
	var w=$(window).width();
	$('#service_div0').width(w-40);
	$('#service_div2').width($('#service_div0').width()-$('#service_div1').width()-4);
	$('#hosttree_div_service').scrollTop(0);
	_initList_service();
}
function host_manage(){
	document.frm_access.tasktype.value=tasktype;
	document.frm_access.action = '/bhost/host_manage';
	document.frm_access.submit();
}
function host_manage1(){
	document.frm_access.tasktype.value=10;
	document.frm_access.action = '/bhost/host_manage';
	document.frm_access.submit();
}

var search_typeall_new='';
var search_typeall_r = "";
//加入搜索zdp
var find_host_arry=[];
var find_host_flag = 0;
var blur_keyword = "";
var find_account_loading = false;
function _addFilter_account(obj,type){
	if (find_account_loading){
		_alert(2,"搜索","正在搜索中，请先等待搜索完成");
		return false; 
	}
	var v1 = $("#account_select").val();
	var v2 = $("#account_text").val();
	
	if(v2 == ''){
		$("#account_text").blur();
		_alert(2,"搜索","请输入关键字",$("#account_text"));
		return false;
	}
	v2 = v2.ResetBlank();
	var filter_value;
	var filter_flag = true;
	var filter_v = "";
	if (v1 == "-1"){
		filter_name = "所有";
		filter_value = filter_name + '-' + v2;
		filter_v = v2;
	}else if (v1 == "1"){
		filter_name = "组名";
		filter_value = filter_name + '-' + v2;
		filter_v = filter_value;
	}else if (v1 == "2"){
		filter_name = "主机名";
		filter_value = filter_name + '-' + v2;
		filter_v = filter_value;
	}else if (v1 == '3'){
		filter_name = "IP";
		filter_value = filter_name + '-' + v2;
		filter_v = filter_value;
	}
	
	var type_value = true;
	if (type){
		$("#filterWW_account").children('ul').children('li').each(function(i,item){
			if ($(this).children('span').text() == filter_v){
				filter_flag = false;
				_alert(2,"搜索","相同的搜索条件已存在",$("#account_text"));
				return false;
			}
		});
		
		/*
		if (v1 != '-1'){
			$("#account_select").empty().append('<option value="-1">所有</option><option value="'+v1+'">'+filter_name+'</option>');
			$("#account_select").val(v1).trigger('change');
		}
		*/
		if (filter_flag == true){
			if (blur_keyword == filter_value){
				type_value = false;
			}
			if (find_host_flag == 1){
				find_host_arry.splice(-1,1);
				find_host_flag = 0;
			}
			$("#account_text").val("");
			blur_keyword = "";
			$("#account_text_check").hide();
			find_host_arry.push(filter_value);
			$('#filterWW_account>ul').append('<li style="height: 18px;"><span class="ww" data-value="'+filter_value+'" style="width:9em">'+filter_v+'</span><i class="del" style="margin-top: 2px;" onclick="_delFilter_account(this)"></i></li>')
			selView2(type_value);
		}
	}else{
		if (blur_keyword == filter_value){
			type_value = false;
		}
		if (find_host_flag != 0){
			find_host_arry.splice(-1,1);
		}
		find_host_flag = 1;
		find_host_arry.push(filter_value);
		blur_keyword = filter_value;
		selView2(type_value);
	}

}

function selView2(type_value){
	var $sel = $('#filterWW_account');
	var len = $('li',$sel).length;

	if(len == 0){
		$sel.hide();
		$("#clearFilter_account").hide();
	}else if(len == 1){
		$("#filterWW_account").show();
		$("#clearFilter_account").show();
		$('>span.ww',$sel).show();
		$sel.addClass('selector-multiple');
	}else{
		$("#filterWW_account").show();
		$("#clearFilter_account").show();
		$('>span.ww',$sel).show();
		$sel.addClass('selector-multiple');
	}
	if (type_value){
		find_host_group();
	}
}

function change_input_a(obj){
	if ($(obj).val() == "" && blur_keyword != ""){
		blur_keyword = "";
		find_host_flag = 0;
		find_host_arry.splice(-1,1);
		selView2(true);
	}
}

var index_f_a = 0;
var filter_flag_append_a = false;
var old_path_all_a = [];
var push_filter_wait_a = [];
var host_path_all_a;
function find_host_group(){
	_getWait($(".waitTip"));
	find_account_loading = true;
	/*
	$('#hostTree_z').scrollTop(0);
	if(find_host_arry.length!=0 && $.inArray(first_find_index,find_host_arry)>=0){
		if(ajax_find_host_doing==false){
			if(mtr==null){
				_getWait($(".waitTip"));
				//消红+展开标红
				$('#hostTree_z').find('.font-red').removeClass('font-red');
				$('#hostTree_z').find('span.h-name-red').removeClass('h-name-red');
				setTimeout(function () {
					red_to_no_red_and_open_to_red($('#hostTree_z'),0);
				},1);
			}else{
				
			}
		}else{
			
		}
		return false;
	}
	*/
	click_h1_a();
}
function  coverString(subStr,str){
	subStr=subStr.replace(/\?/g, "\\?").replace(/\|/g, "\\|").replace(/\\/g, "\\\\").replace(/\$/g, "\\$").replace(/\(/g, "\\(").replace(/\)/g, "\\)").replace(/\*/g, "\\*").replace(/\./g, "\\.").replace(/\[/g, "\\[").replace(/\^/g, "\\^").replace(/\{/g, "\\{");
	var reg = eval("/"+subStr+"/ig");
	return reg.test(str);
}
function red_to_no_red_and_open_to_red(obj,num){
	for(var i=0;i<tmp_list.length;i++){
		var item=tmp_list[i];
		var pass=true;
		for(var jm=0;jm<find_host_arry.length;jm++){
			var pass_one=false;
			var search_index=find_host_arry[jm].indexOf('-');
			var search_str = find_host_arry[jm].substring(search_index+1);
			var search_arr=search_str.split(' ');
			$.each(search_arr,function(i1,item1){
				if(item1!=''){
					var Name = item.Name;
					if (find_host_arry[jm].substr(0,search_index) == "组名"){
						if (item.Type != 1){
							return false;
						}
					}else if (find_host_arry[jm].substr(0,search_index) == "主机名"){
						var Name=item.Name.split('\t')[0];
						if (item.Type != 2){
							return false;
						}
					}else if (find_host_arry[jm].substr(0,search_index) == "IP"){
						var Name=item.Name.split('\t')[1];
						if (item.Type != 2){
							return false;
						}
					}
					if(coverString(item1,Name)){
						pass_one=true;
						return false;
					}
				}
			});
			if(pass_one==false){
				pass=false;
			}
		}
		if(pass==true){
			open_and_make_red(item);
		}else{
		}
	}
	li_red_to_no_red(obj);
	//非红隐藏
	// setTimeout(function () {
	_jScrollBar_array = [];
	li_hide_while_no_red($('#hostTree_z'),0);
	// },0);
	//定位
	top_to_move($('#hostTree_z'));
}

function open_and_make_red(item){
	var Path_array=item.Path.split('/');
	var len=Path_array.length;
	if (len == 2){//主机层
		//show
		$('#nodehg-'+item.Id).parent('li').show();
		$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
	}else{
		for(var j=1;j<len-1;j++){
			var id=Path_array[j].split(',')[1];
			//show
			$('#nodehg-'+id).parent('li').show();
			$i_item=$('#nodehg-'+id).prev('i');
			if(($i_item.attr('class').indexOf('h-aicon-d')) == -1){
				filter_flag_append_a = true;
				$i_item.trigger('click');
			}		
			//}
		}
		if(item.Type==1){
			//show
			$('#nodehg-'+item.Id).parent('li').show();
			$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
		}else{
			//show
			$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).parent('li').show();
			//$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).addClass('show_input');
			$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).siblings('span.h-name').addClass('h-name-red');
		}
	}
}

function top_to_move(obj){
	var top_arr=$(obj).find('span.h-name-red');
	if(top_arr.length!=0){
		$('#hosttree_div_account').scrollTop(top_arr.eq(0).offset().top-200);
		_waitDone($(".waitTip"));
	}else{
		_alert(0,'搜索','无搜索结果',$("#_addFilter_account"));
		_waitDone($(".waitTip"));
	}
}

function click_h1_a(){
	var i = 0;
	index = 0;
	flag_ajax_true = true;
	$("#hostTree_z").find('i.h-aicon.h-aicon-d').trigger('click');
	$('#hostTree_z').find('.font-red').removeClass('font-red');
	$("#hostTree_z").find('span.h-name-red').removeClass('h-name-red');
	host_path_all_a = [];
	old_path_all = [];
	push_filter_wait = [];
	click_h0_a();
}

var time_all_=0;
var mtr;
var flag_ajax_true = false;
function click_h0_a(){
	time_all_=0;
	if (mtr != null) {
		mtr.abort();
		mtr = null;
	}
	flag_ajax_true = true;
	//条件没有的情况 直接返回
	
	if (JSON.stringify(find_host_arry) == "[]"){
		_waitDone($(".waitTip"));
		$('#hosttree_div_account').scrollTop(0);
		tmp_list=null;
		first_find_index=null;
		$('#hostTree_z').find('li').show();
		$("#hostTree_z").find('i.h-aicon.h-aicon-d').trigger('click');
		$('#hostTree_z').find('.font-red').removeClass('font-red');
		$("#hostTree_z").find('span.h-name-red').removeClass('h-name-red');
		find_account_loading = false;
		return false;
	}
	//first_find_index=find_host_arry[0];
	//var a=new Array();
	//a[0]=find_host_arry[0];
	mtr = $.ajax({
		url: '/bhost/PFindHostDirectory_account',
		type: "POST",
		async: true,
		data: {a0:se,a1:JSON.stringify(find_host_arry)},
		success: function(result){
			mtr=null;
			tmp_list=null;
			flag_ajax_true = false;
			$('#hostTree_z').find('li').show();
			$('#hostTree_z').children('li').hide();
			if (result == "None"){
				_alert(0,'搜索','无搜索结果');
				_waitDone($(".waitTip"));
				tmp_list=new Array();
				flag_ajax_true = true;
				find_account_loading = false;
				return false;
			}
			tmp_list = JSON.parse(result);
			ajax_find_host_doing=true;
			$(tmp_list).each(function(i,item){
				if (item.Type != 3 && item.Type != 4){
					host_path_all_a.push(item);
					tmp_list = [];
				}
			});
			tmp_list = host_path_all_a.slice(0);
			/*
			if(find_host_arry.length>1){
				var new_list_arr=new Array();
				new_list_arr=host_path_all_a.filter(function (item) {
					var pass=true;
					for(var jm=0;jm<find_host_arry.length;jm++){
						var pass_one=false;
						var search_index=find_host_arry[jm].indexOf('-');
						var search_str = find_host_arry[jm].substring(search_index+1);
						var search_arr=search_str.split(' ');
						$.each(search_arr,function(i1,item1){
							if(item1!=''){
								if(coverString(item1,item.Name)){
									pass_one=true;
									return false;
								}
							}
						});
						if(pass_one==false){
							pass=false;
							break;
						}
					}
					return pass;
				});
				if(new_list_arr.length==0){
					ajax_find_host_doing=false;
					_alert(0,'搜索','无搜索结果');
					_waitDone($(".waitTip"));
					flag_ajax_true = true;
					return false;
				}
			}
			*/
			
			//把 过滤信息放入 host_path_all 全局变量
			if (tmp_list.length != 0){
				//开始过滤
				tmp_list_path_strarray=tmp_list.map(function (params) {
					return params.Path;
				});
				$(tmp_list).each(function(i,item){
					host_path_all_a.push(item);
				})
				flag_ajax_true = false;
				find_append_a();
			}else{
				ajax_find_host_doing=false;
				flag_ajax_true = true;
				_alert(0,'搜索','无搜索结果');
				find_account_loading = false;
				_waitDone($(".waitTip"));
			}
		}
	});
}

var flag_loading_a = false;
function find_append_a(){
	ajax_data = [];
	ajax_flag = false;
	var i = 0;
	index_f_a = 0;
	var t_do1;
	function _do1(){
		clearTimeout(t_do1);
		for(i = index_f_a; i< index_f_a + 50;i++){
			if(ajax_flag == true) {
				t_do1=setTimeout(function () {_do1();},1);
				return false;
			}
			if(flag_ajax_true == true)  {
				t_do1=setTimeout(function () {_do1();},1);
				return false;
			}
			if (i >= host_path_all_a.length){   //
				if(flag_ajax_true == true)  {
					t_do1=setTimeout(function () {_do1();},1);
					return false;
				}
				if (host_path_all_a.length == 0){
					//过滤结束 开始标红
					scrollTop_check_server1_a();
					return false;
				}else{	
					//if(ajax_data.length > 0) ajax_host(); //300个检索叫条件里面的主机 都没达到50 也去执行ajax——host
					index_f_a = 0;
					t_do1=setTimeout(function () {_do1();},1);
					return false;
				}
			}
			var Path_array=host_path_all_a[i].Path.split('/');
			var len=Path_array.length;
			if (len == 2){//主机层
				if($('#nodehg-'+host_path_all_a[i].Id).length == 0) {
					continue;
				}//
				//show
				$('#nodehg-'+host_path_all_a[i].Id).parent('li').show();
				$('#nodehg-'+host_path_all_a[i].Id).siblings('span.h-name').addClass('h-name-red');
				red_to_font_a($('#nodehg-'+host_path_all_a[i].Id));
				$('#nodehg-'+host_path_all_a[i].Id).siblings('ul').find('li').show();
			}else{
				s = 0;
				for(var j=1;j<len-1;j++){
					var id=Path_array[j].split(',')[1];
					if($('#nodehg-'+id).length == 0) {
						s = 1;
						break;//
					}
					if(flag_loading_a == true) {
						s = 1;
						break;
					}
					$('#nodehg-'+id).parent('li').show();
					$i_item=$('#nodehg-'+id).prev('i');
					
					if($i_item.attr('class') == "h-blank"){ //
						host_path_all_a.splice(i,1);	
						s = 1;
						break;//
					}
					
					if($('#nodehg-'+id).length >0){
						red_to_font_a($('#nodehg-'+id));
						if(($i_item.attr('class').indexOf('h-aicon-d')) == -1){
							filter_flag_append_a = true;
							$i_item.trigger('click');
						}		
					}
				}
				if(s) continue;
				if(host_path_all_a[i].Type==1){
					if($('#nodehg-'+host_path_all_a[i].Id).length == 0) continue;//
					//show
					$('#nodehg-'+host_path_all_a[i].Id).parent('li').show();
					$('#nodehg-'+host_path_all_a[i].Id).siblings('span.h-name').addClass('h-name-red');
					red_to_font_a($('#nodehg-'+host_path_all_a[i].Id));
					$('#nodehg-'+host_path_all_a[i].Id).siblings('ul').find('li').show();
				}else{
					if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all_a[i].Id).length == 0){
						continue;
					}//
					//show
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all_a[i].Id).parent('li').show();
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all_a[i].Id).addClass('show_input');
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all_a[i].Id).siblings('span.h-name').addClass('h-name-red');
					red_to_font_a($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all_a[i].Id));
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all_a[i].Id).siblings('ul').find('li').show();
				}
			}
			//数据展开后 从host_path_all删除掉，并且放在old_path_all，为标红和定位准备
			push_filter_wait.push(host_path_all_a[i]);
			old_path_all_a.push(host_path_all_a[i]);
			host_path_all_a.splice(i,1);	
			
		}
		index_f_a = i;
		get_msg();	
		t_do1=setTimeout(function () {_do1();},1);
	}
	_do1();
}
function get_msg(){
	var n=0;
	$.ajax({
		url: '/bhost/get_msg',
		type: "post",
		async:false,
		data: {a0:se},
		success: function(result) {
			var result=JSON.parse(result);
			if(result.Result == false){
				if(result.info.indexOf('系统异常')>=0 || result.info.indexOf('非法访问')>=0 || result.info.indexOf('系统超时') >=0 ){
					_alert(2,'系统',result.info);
				}else{
					_alert(2,'系统',result.info);
				}
			}
			else{
			}
		}
	})
	if(n) return false;	
}
var top1_a=9007199254740991;
var ajax_find_host_doing=false;
var first_find_index=null;
var tmp_list=null;
var tmp_list_path_strarray=null;
function scrollTop_check_server1_a(){
	var i = 0;
	var index_i = 0;
	//li_red_to_no_red($('#hostTree_z'));
	//_jScrollBar_array = [];
	li_hide_while_no_red($('#hostTree_z'),0);
	find_account_loading = false;
	if($('#hostTree_z').find('span.h-name-red').length==0){
		_alert(0,'搜索','无搜索结果');
		_waitDone($(".waitTip"));
		flag_ajax_true = true;
		ajax_find_host_doing=false;
		return false;
	}
	$('#hosttree_div_account').scrollTop($('#hostTree_z').find('span.h-name-red').eq(0).offset().top-200);
	ajax_find_host_doing=false;
	flag_ajax_true = true;
	_waitDone($(".waitTip"));
	old_path_all=new Array();
}

function li_red_to_no_red(obj){//继续
	var red_input=$(obj).find('span.h-name-red');
	for(var im=0;im<red_input.length;im++){
		var item=red_input.eq(im);
		var pass=true;
		var item_name=item.siblings('input').attr('data-name');
		var Type = item.siblings('input').attr('id');
		var $span_son_font=$('.h-name-son',item).find('font');
		if(Type.indexOf('nodeh')<0){
			var span_son_name=item_name.toLowerCase();
		}else{
			var host_span_arr=item_name.split('\t');
			var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
		}
		for(var jm=0;jm<find_host_arry.length;jm++){
			var pass_one=false;
			var search_index=find_host_arry[jm].indexOf('-');
			var search_str = find_host_arry[jm].substring(search_index+1);
			var search_arr=search_str.split(' ');
			$.each(search_arr,function(i1,item1){
				if (find_host_arry[jm].substr(0,search_index) == "组名"){
					var Name = item_name;
					if(Type.indexOf('nodehg')<0){
						return false;
					}
				}else if (find_host_arry[jm].substr(0,search_index) == "主机名"){
					var Name = item_name.split('\t')[0];
					if(Type.indexOf('nodeh')<0){
						return false;
					}
				}else if (find_host_arry[jm].substr(0,search_index) == "IP"){
					var Name = item_name.split('\t')[1];
					if(Type.indexOf('nodeh')<0){
						return false;
					}
				}else{
					var Name = item_name;
				}
				if(coverString(item1,Name)){
					item1=item1.toLowerCase();
					if(find_host_arry[jm].substr(0, search_index).toLowerCase() == 'ip'){
						var index_start=span_son_name.indexOf('(');
						var index_true=span_son_name.indexOf(item1,index_start);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}else{
						var index_true=span_son_name.indexOf(item1);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}
					pass_one=true;
					return false;
				}
			});
			if(pass_one==false){
				pass=false;
			}
		}
		if(pass==false){
			item.removeClass('h-name-red');
			$span_son_font.removeClass('font-red');
		}else{
		}
	}
}
var _jScrollBar_array = [];
function _jScrollBar(scid) {
	var myBar = new MyScrollBar({
		selId:scid,
		hasX:true,
		hasY:false,
		width:6,
		// enterShow:false,
	})
}
function li_hide_while_no_red(obj,num){
    var li_visible=$(obj).children('li');
	for(var i=num;i<num+100;i++){
        if(i>=li_visible.length){
            break;
        }
		var item=li_visible.eq(i);
		var span_id = $(item).children('span.h-name').attr('id');
		if (_jScrollBar_array.indexOf(span_id) === -1){
			_jScrollBar_array.push(span_id);
			_jScrollBar(span_id);
		}
		var span_red_time=$(item).find('span.h-name-red').length;
		if(span_red_time==0){
			$(item).hide();
			$(item).find('font.font-red').removeClass('font-red');
		}else if(span_red_time>0){
			$(item).show();
			var children_red_time=$(item).children('span.h-name-red').length;
			if(children_red_time>0 && span_red_time==1){
				$(item).children('i.h-aicon-d').removeClass('h-aicon-d');
				$(item).children('ul').hide();
			}
			else if(children_red_time>0 && span_red_time>1){
				$(item).find('li').show();
			}
			else if (children_red_time==0) {
				var $children_ul=$(item).children('ul');
				li_hide_while_no_red($children_ul,0);
			}
		}
	}
    if(i<li_visible.length){
        setTimeout(function () {li_hide_while_no_red(obj,i);},1);
    }
}


function clearFilter_account(obj){
	if (find_account_loading){
		_alert(2,"搜索","正在搜索中，请先等待搜索完成");
		return false; 
	}
	$("#filterWW_account").children('ul').empty();
	$("#filterWW_account").hide();
	$("#account_text").val('');
	$("#clearFilter_account").hide();
	find_host_arry=[];
	//$("#account_select").empty().append('<option value="-1">所有</option><option value="1">组名</option><option value="2">主机名</option><option value="3">IP</option>');
	selView2(true);
}

function _delFilter_account(obj){
	if (find_account_loading){
		_alert(2,"搜索","正在搜索中，请先等待搜索完成");
		return false; 
	}
	var v = $(obj).parent().children('span').attr('data-value');
	$(obj).parent().remove();
	find_host_arry.splice($.inArray(v,find_host_arry),1);
	/*
	var li_len = 0;
	var filter_v = $("#account_select").val();
	$("#filterWW2").find('li').each(function(i,item){
		var addfilter_arry = $(item).children('span').attr('data-value').split('-');
		
		if (addfilter_arry[0] == "组名"){
			var addfilter_v = 1;
		}else if (addfilter_arry[0] == "主机名"){
			var addfilter_v = 2;
		}else if (addfilter_arry[0] == "IP"){
			var addfilter_v = 3;
		}
		if (addfilter_arry[0] != "所有"){
			$("#account_select").empty().append('<option value="-1">所有</option><option value="'+addfilter_v+'">'+addfilter_arry[0]+'</option>');
			$("#account_select").val(filter_v).trigger('change');
			return false;
		}else{
			li_len += 1;
		}
	});
	if (li_len == $("#filterWW2").find('li').length){
		$("#account_select").empty().append('<option value="-1">所有</option><option value="1">组名</option><option value="2">主机名</option><option value="3">IP</option>');
		$("#account_select").val(filter_v).trigger('change');
	}
	*/
	selView2(true);
}

function _clear_keyword(){
	$("#account_text").val("");
	$("#account_text_check").hide();
	if (find_host_flag != 0){
		if (find_account_loading){
			_alert(2,"搜索","正在搜索中，请先等待搜索完成");
			return false; 
		}
		find_host_flag = 0;
		find_host_arry.splice(-1,1);
		selView2(true);
	}
}

//加入搜索
function _addFilter_service(obj,type) {
	if(find_hostgroup_service_loading){
		_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
		return false;
	}
	var id = $(obj).parent().children('select').children('option:selected').val();
	var v1 = $(obj).parent().children('select').children('option:selected').text();
	var v2 = $(obj).parent().children('input[type=text]').val().trim();
	if(id=='all'){
		v1='';
	}else{
		v1=v1+'-';
	}
	if (v2 == '') {
		$(obj).parent().children('input[type=text]').blur();
		_alert(2, '搜索', '请输入关键字', $(obj).parent().children('input[type=text]'));
		return false;
	} else {
		switch(id){
			case 'hgname':
				var Reg=/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
				break;
			case 'hostname':
				var Reg=/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
				break;
			case 'ip':
				var Reg=/^[0-9\.]*$/;
				break;
		}
		if(id!='all' && !Reg.test(v2)){
			$(obj).parent().children('input[type=text]').blur();
			_alert(1, '搜索', '关键字格式不正确', $(obj).parent().children('input[type=text]'));
			return false;
		}
		if(search_typeall_r.indexOf(id+'-'+v2+'\t')>=0){
			$(obj).parent().children('input[type=text]').blur();
			_alert(2,'搜索','相同的关键字已存在', $(obj).parent().children('input[type=text]'));
			return false;
		}
		if(type){
			var type_value=(search_typeall_new==id + '-' + v2 + '\t');
			search_typeall_r=search_typeall_r+id+'-'+v2+'\t';
			search_typeall_new='';
			$('#filterWW_service>ul').append('<li style="height: 18px;"><span style = "display:none;">' + id +'-'+v2+ '</span><span class="ww" style="width: 86px;" title="' + v1 + v2 + '">' + v1 + v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter_service(this);"></i></li>')
			$("#service_text").val("");
			$('#service_text_check').hide();
			selView_service(type_value);
		}else{
			if(search_typeall_new == id + '-' + v2 + '\t'){
				return false;
			}
			search_typeall_new=id+'-'+v2+'\t';
			find_hostgroup_service();
		}
		
	}
}

var first_find_index_s=null;
var ajax_find_host_doing_s=false;
var flag_ajax_true_s = false;
var find_host_arry_s=[];
var find_hostgroup_service_loading=false;
function find_hostgroup_service(){
	find_hostgroup_service_loading=true;
	var search_typeall_all = search_typeall_r + search_typeall_new;
	find_host_arry_s = search_typeall_all.split('\t');
	for (var i = 0; i < find_host_arry_s.length; i++) {
		if (find_host_arry_s[i] == '') {
			find_host_arry_s.splice(i, 1);
			i--;
		}
	}
	_getWait($('.waitTip_server'));
	$('#hosttree_div_service').scrollTop(0);
	_getWait($('.waitTip_server'));
	//先清空之前的过滤信息 
	click_h1();
}
function red_to_no_red_and_open_to_red_s(obj, num) {
	for (var i = 0; i < tmp_list_s.length; i++) {
		var item = tmp_list_s[i];
		var pass = true;
		find_host_arry_s = (search_typeall_r + search_typeall_new).split('\t');
		for (var jm = 0; jm < find_host_arry_s.length; jm++) {
			if (find_host_arry_s[jm] == '' || find_host_arry_s[jm] == undefined || find_host_arry_s[jm] == null) {
				continue;
			}
			var pass_one = false;
			var jm_index_=find_host_arry_s[jm].indexOf('-');
			var search_arr = find_host_arry_s[jm].substr(jm_index_ + 1, find_host_arry_s[jm].length).split(' ');
			$.each(search_arr, function (i1, item1) {
				if (item1 != '') {
					if(find_host_arry_s[jm].substr(0,jm_index_)=='hostname'){
						var Name=item.Name.split('\t')[0];
						if(item.Type!=2){
							return false;
						}
					}else if(find_host_arry_s[jm].substr(0,jm_index_)=='ip'){
						var Name=item.Name.split('\t')[1];
						if(item.Type!=2){
							return false;
						}
					}else if(find_host_arry_s[jm].substr(0,jm_index_)=='hgname'){
						var Name=item.Name;
						if(item.Type!=1){
							return false;
						}
					}else{
						var Name=item.Name;
					}
					if (coverString(item1, Name)) {
						pass_one = true;
						return false;
					}
				}
			});
			if (pass_one == false) {
				pass = false;
				break;
			}
		}
		if (pass == true) {
			open_and_make_red_s(item);
		} else {
		}
	}
	li_red_to_no_red_s($('#userTree'));
	//非红隐藏
	li_hide_while_no_red($('#userTree'), 0);
	//定位
	top_to_move_s($('#userTree'));
}
function top_to_move_s(obj) {
	var top_arr = $(obj).find('span.h-name-red');
	if (top_arr.length != 0) {
		$('#hosttree_div_service').scrollTop(top_arr.eq(0).offset().top - 200);
		_waitDone($('.waitTip_server'),0);
	} else {
		$("#service_text").blur();
		_alert(0, '搜索', '无搜索结果');
		_waitDone($('.waitTip_server'),0);
	}
}
function open_and_make_red_s(item) {
	var Path_array = item.Path.split('/');
	var len = Path_array.length;
	if (len == 2) {//主机层
		//show
		$('#HGId-' + item.Id).parent('li').show();
		$('#HGId-' + item.Id).siblings('span.h-name').addClass('h-name-red');
	} else {
		if (item.Type == 3 || item.Type == 4) { //服务/账号

		} else {
			for (var j = 1; j < len - 1; j++) {
				var id = Path_array[j].split(',')[1];
				//show
				$('#HGId-' + id).parent('li').show();
				$i_item = $('#HGId-' + id).prev('i');
				if (($i_item.attr('class').indexOf('h-aicon-d')) == -1) {
					filter_flag_append = true;
					$i_item.trigger('click');
				}
			}
			if (item.Type == 1) {
				//show
				$('#HGId-' + item.Id).parent('li').show();
				$('#HGId-' + item.Id).siblings('span.h-name').addClass('h-name-red');
			} else {
				//show
				$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + item.Id).parent('li').show();
				$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + item.Id).siblings('span.h-name').addClass('h-name-red');
			}
		}
	}
}
function click_h1(){
	//清空数据
	var i = 0;
	index = 0;
	flag_ajax_true_s = true;
	$('#userTree').find('i.h-aicon.h-aicon-d').trigger('click');
	$("#userTree").find('.font-red').removeClass('font-red');
	$("#userTree").find('span.h-name-red').removeClass('h-name-red');
	host_path_all = [];
	old_path_all = [];
	push_filter_wait = [];
	//开始过滤
	click_h0();
}
var mtr=null;
var tmp_list_s=null
String.prototype.ResetBlank=function(){
	var regEx = /\s+/g; 
	return this.replace(regEx, ' '); 
};
function click_h0(){
	var server_find_json={
		"loginusercode": null,
		"hgid": 0,    
		"type": 0,
		"id": 0,  
		"istree": true,
		"hgname": "",   
		"hostname": "",    
		"hostip": "",
		"searchstring":'', 
		"limitrow":null,
		"offsetrow":null  
	}
	usercode = window.document.frm.us.value;
	server_find_json.loginusercode=usercode;
	if(mtr!=null){
		mtr.abort();
		mtr=null;
	}
	flag_ajax_true_s = true;
	//条件没有的情况 直接返回
	var search_typeall_all=search_typeall_r+search_typeall_new;
	find_host_arry_s = search_typeall_all.split('\t');
	for (var i = 0; i < find_host_arry_s.length; i++) {
		if (find_host_arry_s[i] == '') {
			find_host_arry_s.splice(i, 1);
			i--;
		}
	}
	if (search_typeall_all == ""){
		_waitDone('.waitTip_server',0);
		$('#hosttree_div_service').scrollTop(0);
		$('#userTree').children('li').show();
		tmp_list_s = null;
		first_find_index_s = null;
		$('#userTree').find('li').show();
		$("#userTree").find('i.h-aicon.h-aicon-d').trigger('click');
		$("#userTree").find('.font-red').removeClass('font-red');
		$("#userTree").find('span.h-name-red').removeClass('h-name-red');
		find_hostgroup_service_loading=false;
		return false;
	}
	_getWait($('.waitTip_server'));
	var hgname_str='';
	var hostname_str='';
	var hostip_str='';
	var searchstring_str='';
	$.each(find_host_arry_s,function(i,item){
		var item_id=item.indexOf('-');
		switch(item.substr(0,item_id)){
			case 'hgname':
				hgname_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
			case 'hostname':
				hostname_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
			case 'ip':
				hostip_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
			case 'all':
				searchstring_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
		}
	});
	hgname_str=hgname_str.substr(0,hgname_str.length-1).ResetBlank();
	hostname_str=hostname_str.substr(0,hostname_str.length-1).ResetBlank();
	hostip_str=hostip_str.substr(0,hostip_str.length-1).ResetBlank();
	searchstring_str=searchstring_str.substr(0,searchstring_str.length-1).ResetBlank();
	server_find_json.hgname=hgname_str;
	server_find_json.hostname=hostname_str;
	server_find_json.hostip=hostip_str;
	server_find_json.searchstring=searchstring_str;
	mtr=$.ajax({
		url: '/bhost/find_hostgroup',
		type: "POST",
		async: true,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(server_find_json)},
		success: function(result){
			ajax_find_host_doing_s = true;
			var result = JSON.parse(result);
			flag_ajax_true_s = false;
			$('#userTree').find('li').show();
			$('#userTree').children('li').hide();
			mtr = null;
			_getWait('.waitTip_server');
			tmp_list_s = null;
			if (result.Result) {
				tmp_list_s=result.info;
				if(tmp_list_s.length!=0){
					host_path_all = JSON.parse(JSON.stringify(tmp_list_s));
					flag_ajax_true_s = false;
					//开始过滤
					find_append();
				}else{
					flag_ajax_true_s = true;
					ajax_find_host_doing_s = false;
					_alert(0,'搜索','无搜索结果');
					_waitDone('.waitTip_server',0);//延迟5秒退出
					find_hostgroup_service_loading=false;
					return false;
				}
			}else{
				flag_ajax_true_s = true;
				ajax_find_host_doing_s = false;
				$("#service_text").blur();
				_alert(2,'搜索',result.ErrMsg,$("#service_text"));
				_waitDone('.waitTip_server',0);
				find_hostgroup_service_loading=false;
				return false;
			}
		}
	});
}
function red_to_font(obj){
	var item=$(obj).siblings('span.h-name');
	var item_name = item.siblings('input').attr('data-name');
	var Type = item.siblings('input').attr('id');
	var $span_son_font=$('.h-name-son',item).find('font');
	if(Type.indexOf('HostId')<0){
		var span_son_name=item_name.toLowerCase();
	}else{
		var host_span_arr=item_name.split('\t');
		var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
	}
	for (var jm = 0; jm < find_host_arry_s.length; jm++) {
		var pass_one = false;
		var jm_index_ = find_host_arry_s[jm].indexOf('-');
		var search_arr = find_host_arry_s[jm].substr(jm_index_ + 1, find_host_arry_s[jm].length).split(' ');
		$.each(search_arr, function (i1, item1) {
			if(item1==''){
				return true;
			}
				if (find_host_arry_s[jm].substr(0, jm_index_) == 'hgname'){
					var Name = item_name;
					if(Type.indexOf('HGId')<0){
						return true;
					}
				}else if (find_host_arry_s[jm].substr(0, jm_index_) == 'hostname') {
					var Name = item_name.split('\t')[0];
					if(Type.indexOf('HostId')<0){
						return true;
					}
				} else if (find_host_arry_s[jm].substr(0, jm_index_) == 'ip'){
					var Name = item_name.split('\t')[1];
					if(Type.indexOf('HostId')<0){
						return true;
					}
				}else if (find_host_arry_s[jm].substr(0, jm_index_) == '服务'){
					var Name = item_name;
					if(Type.indexOf('nodes')<0){
						return true;
					}
				}else if (find_host_arry_s[jm].substr(0, jm_index_) == '账号'){
					var Name = item_name;
					if(Type.indexOf('nodea')<0){
						return true;
					}
				}else{
					var Name = item_name;
				}
			if (coverString(item1, Name)) {
				item1=item1.toLowerCase();
				if(find_host_arry_s[jm].substr(0, jm_index_) == 'ip'){
					var index_start=span_son_name.indexOf('(');
					var index_true=span_son_name.indexOf(item1,index_start);
					if(index_true>=0){
						for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
							$span_son_font.eq(i_red_span).addClass('font-red');
						}
					}
				}else{
					var index_true=span_son_name.indexOf(item1);
					if(index_true>=0){
						for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
							$span_son_font.eq(i_red_span).addClass('font-red');
						}
					}
				}
			}
		});
	}
}
function find_append(){
	var i = 0;
	var t_do1;
	index_f = 0;
	function _do1(){
		for(i = index_f; i< index_f + 50;i++){
			if (i >= host_path_all.length){    //
				if (host_path_all.length == 0){
					//过滤结束 开始标红
					scrollTop_check_server1();
					return false;
				}else{	
					index_f = 0;
					t_do1 = setTimeout(function () { _do1(); }, 1);
					return false;
				}
			}
			if(host_path_all[i].Type!=1 && host_path_all[i].Type!=2){
				host_path_all.splice(i,1);
				continue;
			}
			var Path_array=host_path_all[i].Path.split('/');
			var len=Path_array.length;
			if (len == 2){//主机层
				//数据未完全展开 留在 host_path_all，下次继续执行
				if($('#HGId-'+host_path_all[i].Id).length == 0) continue;//
				$('#HGId-' + host_path_all[i].Id).parent('li').show();
				$('#HGId-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
				red_to_font($('#HGId-' + host_path_all[i].Id));
				$('#HGId-' + host_path_all[i].Id).siblings('ul').find('li').show();
			}else{
				s = 0;
				for(var j=1;j<len-1;j++){
					var id=Path_array[j].split(',')[1];
					if($('#HGId-'+id).length == 0) {
						s = 1;
						break;//
					}
					if(flag_loading == true) {
						s = 1;
						break;
					}
					$('#HGId-' + id).parent('li').show();
					$i_item=$('#HGId-'+id).prev('i');
					if($i_item.attr('class') == "h-blank"){ //
						host_path_all.splice(i,1);	
						s = 1;
						break;//
					}
					if (push_hgid.indexOf(Path_array[j - 1].split(',')[1] + ':true') != -1) {
						continue;
					}
					if (push_hgid.indexOf(Path_array[j - 1].split(',')[1] + ':false') != -1) {
						continue;
					}
					if($('#HGId-'+id).length >0){
						red_to_font($('#HGId-'+id));
						if(($i_item.attr('class').indexOf('h-aicon-d')) == -1){
							filter_flag_append = true;
							$i_item.trigger('click');
						}		
					}
				}
				if(s) continue;
				if(host_path_all[i].Type==1){
					if($('#HGId-'+host_path_all[i].Id).length == 0) continue;//
					$('#HGId-' + host_path_all[i].Id).parent('li').show();
					$('#HGId-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
					red_to_font($('#HGId-' + host_path_all[i].Id));
					$('#HGId-' + host_path_all[i].Id).siblings('ul').find('li').show();
				}else{
					if($('#HostId-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).length == 0) continue;//
					$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).parent('li').show();
							$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
							red_to_font($('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id));
							$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).siblings('ul').find('li').show();
				}
			}
			//数据展开后 从host_path_all删除掉，并且放在old_path_all，为标红和定位准备
			old_path_all.push(host_path_all[i]);
			host_path_all.splice(i,1);	
			
		}
		index_f = i;
		get_msg();
		t_do1 = setTimeout(function () { _do1(); }, 1);
	}
	_do1();
}
function li_red_to_no_red_s(obj) {
	var red_input = $(obj).find('span.h-name-red');
	for (var im = 0; im < red_input.length; im++) {
		var item = red_input.eq(im);
		var pass = true;
		var item_name = item.siblings('input').attr('data-name');
		var $span_son_font=$('.h-name-son',item).find('font');
		var Type = item.siblings('input').attr('id');
		if(Type.indexOf('HostId')<0){
			var span_son_name=item_name.toLowerCase();
		}else{
			var host_span_arr=item_name.split('\t');
			var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
		}
		find_host_arry_s = (search_typeall_r + search_typeall_new).split('\t');

		for (var jm = 0; jm < find_host_arry_s.length; jm++) {
			if (find_host_arry_s[jm] == '' || find_host_arry_s[jm] == undefined || find_host_arry_s[jm] == null) {
				continue;
			}
			var pass_one = false;
			var jm_index_=find_host_arry_s[jm].indexOf('-');
			var search_arr = find_host_arry_s[jm].substr(jm_index_ + 1, find_host_arry_s[jm].length).split(' ');
			$.each(search_arr, function (i1, item1) {

				if(find_host_arry_s[jm].substr(0,jm_index_)=='hostname'){
					var Name=item_name.split('\t')[0];
					if (Type.indexOf('HostId')<0){
						return false;
					}
				}else if(find_host_arry_s[jm].substr(0,jm_index_)=='ip'){
					var Name=item_name.split('\t')[1];
					if (Type.indexOf('HostId')<0){
						return false;
					}
				}else if (find_host_arry_s[jm].substr(0, jm_index_) == 'hgname') {
					var Name = item_name;
					if (Type.indexOf('HGId')<0){
						return false;
					}
				} else{
					var Name=item_name;
				}
				if (coverString(item1, Name)) {
					item1=item1.toLowerCase();
					if(find_host_arry_s[jm].substr(0, jm_index_) == 'ip'){
						var index_start=span_son_name.indexOf('(');
						var index_true=span_son_name.indexOf(item1,index_start);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}else{
						var index_true=span_son_name.indexOf(item1);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}
					pass_one = true;
					return false;
				}
			});
			if (pass_one == false) {
				pass = false;
				break;
			}
		}
		if (pass == false) {
			item.removeClass('h-name-red');
			$span_son_font.removeClass('font-red');
		} else {
		}
	}
}
function scrollTop_check_server1(){
	var i = 0;
	var index_i = 0;
	li_hide_while_no_red($('#userTree'), 0);
	if ($('#userTree').find('span.h-name-red').length == 0) {
		_alert(0, '搜索', '无搜索结果');
		_waitDone('.waitTip_server',0);
		flag_ajax_true_s = true;
		ajax_find_host_doing_s = false;
		find_hostgroup_service_loading=false;
		return false;
	} else {
		ajax_find_host_doing_s = false;
		flag_ajax_true_s = true;
		old_path_all = new Array();
		find_hostgroup_service_loading=false;
		$('#hosttree_div_service').scrollTop($('#userTree').find('span.h-name-red').eq(0).offset().top - 200);
		_waitDone('.waitTip_server',3000);
		return false;
	}
}

//删除搜索
function _delFilter_service(obj) {
	if(find_hostgroup_service_loading){
		_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
		return false;
	}
	var id = $(obj).parent().find("span");
	var ids=$(id).eq(0).text();
	search_typeall_r = search_typeall_r.replace(ids+'\t','');
	var server_text=$('#service_text').val().trim();
	$(obj).parent().remove();
	selView_service();
}
function clearFilter_service(obj,num){
	if(find_hostgroup_service_loading){
		_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
		return false;
	}
	if(num==1){
	$('#service_text').val('');
	$('#service_text_check').hide();
	search_typeall_new='';
	selView_service();
		return;
	}
	$('#clearFilter_service').next().children('ul').empty();
	$('#service_text').val('');
	$('#service_text_check').hide();
	$('#clearFilter_service').hide();
	search_typeall_new='';
	search_typeall_r='';
	selView_service();
}


//显示搜索条件
function selView_service(type_value) {
	var $sel = $('#filterWW_service');
	var len = $('li',$sel).length;

	if (len == 0) {
		$sel.hide();
		$('#clearFilter_service').hide();
	} else {
		$("#filterWW_service").show();
		$('#clearFilter_service').show();
		$('>span.ww', $sel).show();
		$sel.addClass('selector-multiple');
	}
	if(!type_value) find_hostgroup_service();
}

function get_export_tab(type){
	if (type == 1){
			$("#export_1").show();
			$("#export_2").hide();
			$('#export_tab_1').addClass("active").parent().siblings().children().removeClass("active");
			$('#resource_check').unbind().on('ifChecked',function(){
				$('#all_check').iCheck('uncheck');
			}).on('ifUnchecked',function(){
				if (!$('#resource_check').is(':checked') && !$('#host_check').is(':checked') && !$('#host_group_check').is(':checked')){
					$('#all_check').iCheck('check');
				}
			});
			$('#host_check').unbind().on('ifChecked',function(){
				$('#all_check').iCheck('uncheck');
			}).on('ifUnchecked',function(){
				if (!$('#resource_check').is(':checked') && !$('#host_check').is(':checked') && !$('#host_group_check').is(':checked')){
					$('#all_check').iCheck('check');
				}
			});
			$('#host_group_check').unbind().on('ifChecked',function(){
				$('#all_check').iCheck('uncheck');
			}).on('ifUnchecked',function(){
				if (!$('#resource_check').is(':checked') && !$('#host_check').is(':checked') && !$('#host_group_check').is(':checked')){
					$('#all_check').iCheck('check');
				}
			});
	}else if(type == 2){
		$('#exportcurpage').val('1');
		$("#export_1").hide();
		$("#export_2").show();
		$('#export_tab_2').addClass("active").parent().siblings().children().removeClass("active");
		get_host_export_list();
	}
	
	if (type == 2){
		clearInterval(if_ok);
		repeat_execute = function(){
			if_ok = setInterval(function(){
				get_host_export_list();
			},5000)}
		repeat_execute();
	}else{
		clearInterval(if_ok);
	}
	var w = $(window).width();
	_initSize();

}

function export_del(){
	if (export_selectid.length == 0){
			_alert(2,"主机任务","请选择要删除的数据");
			return;
	}
	$('.btn').blur();
	parent.layer.open({
			type:1,
			title:"主机任务",
			content:'<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
			btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
					parent.layer.close(i);
					delete_hostexport(1,JSON.stringify(export_selectid));
					export_selectid=[];
					get_host_export_list();
			},
			btn2:function(i){
					parent.layer.close(i);
			}
	});

}

function delete_hostexport(type,id){
	var msstr = aceg(JSON.stringify(type),se);
	$.ajax({
			url:'/bhost/del_hostexport',
			type:'post',
			async:false,
			data:{a0:se,z1:type,z2:id,m1:msstr},
			success:function(result){
					var del_result = JSON.parse(result);
					if (del_result.Result){
							_alert(0,"主机任务","删除成功");
							return false;
					}else{
							_alert(1,"主机任务",del_result.ErrMsg);
							return false;
					}
			}
	})
}

function get_export_data(){
        $.ajax({
                url:'/bhost/get_hostexport_data',
                type:"post",
                async:false,
                data:{a0:se,z1:'null',z2:'null'},
                success:function(result){
                        var result = JSON.parse(result);
                        $.each(result.data,function(i,item){
							export_selectid.push(item.HostExportTaskId);
                        });
                }
        });
}

function export_all_check(){
	export_selectid=[];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
	var select_total = $("#export_select_total").text();
	var task_total = $("#export_total").text();
	if (parseInt(select_total) == parseInt(task_total)){
			$("#export_2").find('input').iCheck('uncheck');
	}else{
		get_export_data();
		$("#export_list tbody input[type='checkbox']").each(function(){
				if (!$(this).prop("disabled")){
						$(this).iCheck('check');
				}
		})
	}
	$("#export_select_total").text(export_selectid.length);

}

//删除任务
function del_export_r(id){
        $('.btn').blur();
        parent.layer.open({
                type:1,
                title:"主机任务",
                content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
                btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
                btnAlign:'c',
                closeBtn: false,
                skin:'layer-custom',
                area:['380px','310px'],
                move: false,
                resize: false,
                btn1:function(i){
					parent.layer.close(i);
					delete_hostexport(0,id);
					if($.inArray(parseInt(id),export_selectid)>=0){
						var num = $("#select_total").text();
						num = parseInt(num)-1;
						$("#select_total").text(num);
						export_selectid.splice($.inArray(parseInt(id),export_selectid),1);
					}
					get_host_export_list();
                },
                btn2:function(i){
                        parent.layer.close(i);
                }
        });
}


function export_refresh(){
	get_host_export_list();
	export_selectid = [];
	$("#export_2 input[type='checkbox']").each(function(){
			$(this).iCheck('uncheck');
	});
	$("#export_select_total").text(0);

}

//任务列表翻页
function turn_export_page(type){
	switch (type){
		case 1: //首页
			$("#exportcurpage").val(1);
			break;
		case 2://上一页
			var cur = $("#exportcurpage").val();
			if (cur == '1'){
				return false;
			}else{
				$("#exportcurpage").val((parseInt(cur)-1));	
			}
			break;
		case 3://下一页
			var cur = $("#exportcurpage").val();
			var total = $("#exporttotalpage").text();
			if (cur == total){
				return false;
			}else {
				$("#exportcurpage").val((parseInt(cur)+1));
			}
			break;
		case 4:
			$("#exportcurpage").val($("#exporttotalpage").text());
			break;
		case 5:
			var cur = $("#exportcurpage").val();
			var numReg = /\D/;
			if (numReg.test(cur) || parseInt(cur) < 1 || cur == ''){
				$("#exportcurpage").val(1);
			}
			break;
		default:
			;
	}
	get_host_export_list();
}

var export_selectid=[];
function get_host_export_list(){
	var MAX_PAGE = 5;
        var cur = $("#exportcurpage").val();
        $.ajax({
                url:'/bhost/get_hostexport_data',
                type:'post',
                async:false,
                data:{a0:se,z1:cur,z2:MAX_PAGE},
                success:function(result){
                        task_list = JSON.parse(result);
                        $("#export_list tbody").empty();
                        var Status = "";
                        var ErrorLog;
						var HostExportTaskName;
                        $.each(task_list.data,function(i,item){
                                if (item.Status == 0){
                                        Status = "执行中";
                                }else if (item.Status == 1){
                                        Status = "成功";
                                }else if (item.Status == 2){
                                        Status = "失败";
                                }
                                if (item.ErrorLog == null){
									ErrorLog = "";
                                }else{
									ErrorLog = item.ErrorLog;
                                }
								HostExportTaskName=item.HostExportTaskName.split('.');
								HostExportTaskName.splice(-2,1);
								HostExportTaskName.splice(-2,1);
								HostExportTaskName.splice(-2,1);
								HostExportTaskName=HostExportTaskName.join('.');
                                float_str = "<p>错误信息："+ErrorLog+"</p>";
                                $("#export_list tbody").append('<tr><td width="50"><input type="checkbox" class="form-checkbox" value="'+item.HostExportTaskId+'"/></td>'+
								'<td style="display:none;" title="'+item.HostExportTaskName+'">'+item.HostExportTaskName+'</td>'+
								'<td title="'+HostExportTaskName+'">'+HostExportTaskName+'</td>'+
								'<td title="'+item.CreateTime+'">'+item.CreateTime+'</td>'+
								'<td title="'+Status+'">'+Status+'</td>'+
								'<td title="'+ErrorLog+'">'+ErrorLog+'</td>'+
								'<td width="60"><div class=\"tab-ctr\">'+
								'<a href="javascript:;" class="icon6 '+(Status=='成功'?'':'disabled')+'" id="edit" title="下载" data="'+item.HostExportTaskName+'" data1="'+item.Status+'" onclick="'+(Status=='成功'?'download_host(this,'+item.HostExportTaskId+');':'')+'"></a>'+
								'<a href=\"javascript:;\" class=\"del\" id=\"del\" title="删除任务" onclick=\"del_export_r('+item.HostExportTaskId+');\"></a></div>'+
								'<div class="tab-moreinfo">'+float_str+'</div></td></tr>');
                        });
                        $('.form-checkbox,.form-radio').iCheck({
                                checkboxClass: 'icheckbox_minimal-blue',
                                radioClass: 'iradio_minimal-blue',
                                increaseArea: '0'
                        });
                }
        });
        tabArr2();
		$("#export_total").text(task_list.totalrow);
        totalpage = Math.ceil(parseInt(task_list.totalrow)/MAX_PAGE);
        if (totalpage < 1){
                totalpage = 1;
        }
        $("#exporttotalpage").text(totalpage.toString());
        $("#exportpage_total").text(MAX_PAGE);
        //<tr>中选择按钮进行设置
        $('#check_export_page').iCheck('uncheck');
        var check_page_flag = 0;
        $("#export_list tbody input[type='checkbox']").each(function(){
                if ($.inArray(parseInt(this.value), export_selectid) != -1){
					$(this).iCheck('check');
					check_page_flag++;
                }
    });
        if (check_page_flag == $("#export_list tbody input[type='checkbox']").length && check_page_flag != 0){
			$('#check_export_page').iCheck('check');
        }
		if (parseInt(cur) > totalpage){
                $("#exportcurpage").val(totalpage);
                get_host_export_list();
        }
        var flag_id = 0;
        num = export_selectid.length;
        $("#export_select_total").text(num);
        $("#export_list tbody input[type='checkbox']").unbind().on("ifChanged",function(){
                if ($(this).is(":checked")){
                        num = $("#select_total").text();
                        num++;
                        if (export_selectid.indexOf(parseInt(this.value)) == -1){
							export_selectid.push(parseInt(this.value))
                        }
                        $("#select_total").text(num);
                }else{
                        num = $("#select_total").text();
                        num--;
                        export_selectid.splice($.inArray(parseInt(this.value),export_selectid),1);
                        $("#select_total").text(num);
                }
                var check_num = 0;
                $("#export_list tbody input[type='checkbox']").each(function(){
                        if (!$(this).prop("disabled")){
                                check_num++;
                        }
                })
                if ($("#export_list tbody").find('input[type=checkbox]:checked').length == check_num){
                        $('#check_export_page').iCheck('check');
                }else{
                        $('#check_export_page').iCheck('uncheck');
                }
        });
        $('#check_export_page').unbind().on('ifClicked',function(e){
                if(!$('#check_export_page').prop('checked')){
                        $("#export_list tbody input[type='checkbox']").each(function(){
                                $(this).iCheck('check');
                        })
                }else{
                        $("#export_list").children('tbody').find('input[type=checkbox]').iCheck('uncheck');
                }
        });


}

function download_host(obj,id){
	var file_name=$(obj).attr('data');
	var file_name_arr=file_name.split('.');
	file_name_arr.splice(-2,1);
	file_name_arr.splice(-2,1);
	file_name_arr.splice(-2,1);
	$.ajax({
		url: "/bhost/exist_download_host",
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(),a1:file_name },
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result) {
				if(window.parent.parent.document.frm.use_BH.value=='0'){
					location.href = '/bhost/download_file?a0='+$("input[name=se]").val()+'&a1='+file_name;
					return 0;
				}
				var sesstimet = (new Date()).valueOf();
				var referrer_arr=document.referrer.toString().split('/');
				referrer_arr.pop();
				var referrer=referrer_arr.join('/');
				var json_download = {
						"Type": "Download",
						"Url": referrer,
						"Path": '/usr/storage/.system/dwload/',
						"Filename": file_name,
						"Session": $("input[name=se]").val(),
						"sesstimet":sesstimet,
						"Filenewname": file_name_arr.join('.')
				}
				var if_html_client = false;
				var base64_str = '';
				$.ajax({
						url: "/bhost/get_base64",
						type:"POST",
						async:false,
						data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
						success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
										if_html_client = result.info;
										base64_str = result.b64;
								}else{
										_alert(1,"主机导出",result.ErrMsg); 
								}
						}
				})
				if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
				else{
					get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
					$('#YuFrame1').remove();
					$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
					$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
				}
			} else {
				_alert(2, '主机导出', result.ErrMsg);
				return false;
			}
		}
	})
}

function _export_host(type){
	if (type == 1){
		var data = [
			['*协议名称','*端口','描述'],
			['特殊字符仅支持下划线、横杠','0-65535之间'],
			['*AD域名称','*服务器IP（多个IP用;分隔）'],
			['特殊字符仅支持下划线、横杠、小数点','0.0.0.0-255.255.255.255之间'],
			['*密钥名称','*类型','密码','*内容'],
			['特殊字符仅支持下划线、横杠、小数点','公钥/私钥','不能为中文','不能为中文'],
			// ['*连接参数名称','*协议','配置'],
			// ['特殊字符仅支持下划线、横杠、小数点','RDP/SSH/ORACLE/MSSQL/MYSQL/HTTP/HTTPS/TELNET/FTP/VNC/X11/RADMIN/SYBASE/DB2/RLOGIN/PCANY/TN5250','TELNET/FTP/VNC/X11/RLOGIN/PCANY/TN5250协议，配置为空即不填'],
			// ['','','RDP：1.访问方式：NORMAL/CONSOLE；2.格式：访问方式'],
			// ['','','SSH：1.版本号：1/2；2.格式：版本号'],
			// ['','','ORACLE：1.指定：SID/SERVICE_NAME；2.实例名或服务名：不能含有特殊字符；3.连接方式：未指定/NORMAL/SYSDBA/SYSOPER；4.格式：指定|实例名/服务名|连接方式'],
			// ['','','MSSQL：1.实例名：不能含有特殊字符；2.认证方式：未指定/SQL服务器验证/Windows验证/Windows单一登录；3.格式：实例名|认证方式'],
			// ['','','MYSQL/DB2：1.数据库名：不能含有特殊字符；2.格式：数据库名'],
			// ['','','SYBASE：1.实例名：不能含有特殊字符；2.格式：实例名'],
			// ['','','HTTP/HTTPS：1.URL；2.账号元素：不能含有特殊字符；3.密码元素：不能含有特殊字符；4.提交元素；5.格式：URL|账号|密码|提交元素'],
			// ['','','RADMIN：1.认证方式：未指定/RADMIN/Windows；2.格式：认证方式'],
			['*设备类型名称','*类型','账号切换命令','切换密码提示','描述','*服务名称','*协议:端口','是否隐藏(是、否)'],
			['特殊字符仅支持下划线、横杠、小数点','Windows/Linux/Unix/Aix/As400/Cisco/H3c/Huawei/Ruijie/Network/Host/Server/Cluster/Switchboard/Firewall','','','','',''],
			['*主机组','主机'],
			['特殊字符仅支持下划线、横杠、小数点,格式：主机组的绝对路径,即若主机组a在主机组b下，则填/b/a','多个用;分隔结尾'],
			['*主机IP','*主机名','*设备类型','描述','访问速度（正常、较慢、很慢）','唯一登录（是、否）','主机组','*协议:端口','连接参数','应用发布','跳转来源主机','跳转来源服务','跳转来源账号','跳转命令','普通提示符','账号切换命令','切换密码提示','登录密码提示','登录名提示','登陆成功提示','换行符','*账号','AD域','密码','*对应协议（多个协议用;分隔）','特权账号（是、否）','切换自账号','账号切换命令','切换命令提示'],
			['0.0.0.0-255.255.255.255之间','特殊字符仅支持下划线、横杠、小数点','','','正常/较慢/很慢','是/否','默认未分组','格式要求:协议:端口号 多个之间用;分隔 ','格式：协议:端口"连接参数"，对应不同的协议:端口的连接参数用;分隔结尾，对应相同的协议:端口写在同一个;里面，例如:协议1:端口"配置1""配置2";协议2:端口"配置3";','对应同一协议:端口的多个应用发布ip用|分隔（不以其结尾），对应不同协议:端口的应用发布ip用;分隔结尾。如果是RDP协议的话有应用通道字段，"-"表示禁用，":ip值"表示启用，格式不变表示可选','多个之间用;分隔，与协议:端口对应（后面到换行符为止规则一样）','','','','','','','','','','','','','密码不填：1.主机已存在，不去修改他的密码   2.主机不存在，提示密码不能为空   3.密码为空：符号为-  密码没有：符号为* 4.密钥，格式：“密钥-密钥名称”，空为“密钥-”','对应协议格式要求:协议:端口必须填写 例如:RDP:3389;，如有连接参数的配置，则例如：RDP:3389"配置";，多个协议例如：RDP:3389"配置";SSH:2222"配置";','是/否','','',''],
			['','','','','','','','','TELNET/FTP/VNC/X11/RLOGIN/PCANY/TN5250协议，配置为空即不填','','','','','','','','','','','','','','','','TELNET/FTP/VNC/X11/RLOGIN/PCANY/TN5250协议，配置为空即不填','','','',''],
			['','','','','','','','','RDP：1.访问方式：NORMAL/CONSOLE；2.配置格式：访问方式','','','','','','','','','','','','','','','','RDP：1.访问方式：NORMAL/CONSOLE；2.配置格式：访问方式','','','',''],
			['','','','','','','','','SSH：1.版本号：1/2；2.配置格式：版本号','','','','','','','','','','','','','','','','SSH：1.版本号：1/2；2.配置格式：版本号','','','',''],
			['','','','','','','','','ORACLE：1.指定：SID/SERVICE_NAME；2.实例名或服务名：不能含有特殊字符；3.连接方式：未指定/NORMAL/SYSDBA/SYSOPER；4.配置格式：指定|实例名/服务名|连接方式','','','','','','','','','','','','','','','','ORACLE：1.指定：SID/SERVICE_NAME；2.实例名或服务名：不能含有特殊字符；3.连接方式：未指定/NORMAL/SYSDBA/SYSOPER；4.配置格式：指定|实例名/服务名|连接方式','','','',''],
			['','','','','','','','','MSSQL：1.实例名：不能含有特殊字符；2.认证方式：未指定/SQL服务器验证/Windows验证/Windows单一登录；3.配置格式：实例名|认证方式','','','','','','','','','','','','','','','','MSSQL：1.实例名：不能含有特殊字符；2.认证方式：未指定/SQL服务器验证/Windows验证/Windows单一登录；3.配置格式：实例名|认证方式','','','',''],
			['','','','','','','','','MYSQL/DB2：1.数据库名：不能含有特殊字符；2.配置格式：数据库名','','','','','','','','','','','','','','','','MYSQL/DB2：1.数据库名：不能含有特殊字符；2.配置格式：数据库名','','','',''],
			['','','','','','','','','SYBASE：1.实例名：不能含有特殊字符；2.配置格式：实例名','','','','','','','','','','','','','','','','SYBASE：1.实例名：不能含有特殊字符；2.配置格式：实例名','','','',''],
			['','','','','','','','','HTTP(S)：1.URL；2.账号元素：不能含有特殊字符；3.密码元素：不能含有特殊字符；4.提交元素；5.配置格式：URL|账号|密码|提交元素','','','','','','','','','','','','','','','','HTTP(S)：1.URL；2.账号元素：不能含有特殊字符；3.密码元素：不能含有特殊字符；4.提交元素；5.配置格式：URL|账号|密码|提交元素','','','',''],
			['','','','','','','','','RADMIN：1.认证方式：未指定/RADMIN/Windows；2.配置格式：认证方式','','','','','','','','','','','','','','','','RADMIN：1.认证方式：未指定/RADMIN/Windows；2.配置格式：认证方式','','','',''],
		]; 
		// var csvContent = "data:text/csv;charset=utf-8,\ufeff";
		var csvContent = "";
		// if (window.navigator.msSaveOrOpenBlob) {
		//         csvContent = "\ufeff";
		// }
		data.forEach(function(infoArray, index){
			dataString = infoArray.join(",");
			csvContent += index < data.length ? dataString+ "\n" : dataString;
		});
		if (window.navigator.msSaveOrOpenBlob) {
			// if browser is IE
			csvContent = "\ufeff"+csvContent;
			var blob = new Blob([decodeURIComponent(encodeURI(csvContent))],{
					type: "text/csv;charset=utf-8;"
			});
			navigator.msSaveBlob(blob, 'host.csv');
		}else{
			csvContent = "data:text/csv;charset=utf-8,\ufeff"+csvContent;
			var encodedUri = encodeURI(csvContent);
			var link = document.createElement("a");
			link.setAttribute("href", encodedUri);
			link.setAttribute("download", "host.csv");
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		}
	}
	else{
		var $dialogCont = $("#scDCTab2_export").show();	
		title="主机导出";
		var d = dialog({
                title:title,
                content:$dialogCont,
                id:"scDCTab2_export",
                width:"850px"
        });
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
			if (if_ok == null){
			}else{
				clearInterval(if_ok);
			}
		});
		$('#resource_check').unbind().on('ifChecked',function(){
			$('#all_check').iCheck('uncheck');
		}).on('ifUnchecked',function(){
			if (!$('#resource_check').is(':checked') && !$('#host_check').is(':checked') && !$('#host_group_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		});
		$('#host_check').unbind().on('ifChecked',function(){
			$('#all_check').iCheck('uncheck');
		}).on('ifUnchecked',function(){
			if (!$('#resource_check').is(':checked') && !$('#host_check').is(':checked') && !$('#host_group_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		});
		$('#host_group_check').unbind().on('ifChecked',function(){
			$('#all_check').iCheck('uncheck');
		}).on('ifUnchecked',function(){
			if (!$('#resource_check').is(':checked') && !$('#host_check').is(':checked') && !$('#host_group_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		});
		$('#all_check').iCheck('check');
		$('input[name=exportType_radio2][value=0]').iCheck('check');
		d.showModal();
		$('#export_1').show();
		$('#export_2').hide();
		$("#export_tab_1").addClass("active").parent().siblings().children().removeClass("active");
		$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
			parent.layer.open({
				type:1,
				title:"主机管理",
				content:'<div class="layer-alert"><i class="alert warning"></i>是否导出</div>',
				btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					var exportType=[];
					var format=$("#export_1").find("input[name=exportType_radio2]:checked").val();
					if($('#resource_check').is(':checked')){
						exportType.push('resource');
					}
					if($('#host_check').is(':checked')){
						exportType.push('host');
					}
					if($('#host_group_check').is(':checked')){
						exportType.push('hostgroup');
					}
					if($('#all_check').is(':checked')){
						exportType.push('all');
					}
					exportType=exportType.join(',');
					parent.layer.close(i);
					time1=new Date().getTime();
						$.ajax({
							url:'/bhost/export_data',
							type:'post',
							async:false,
							data:{a0:se,z1:type,z2:exportType,z3:format,z4:time1},
							success:function(result){
								_getLoadBar_l(format,time1);
								// get_export_tab(2);
							}
						});
				},	
				btn2:function(i){
					parent.layer.close(i);
				}
			});
		});	
		
	}
}
var loadBarLayer_l;//批量操作进度条
var progress_d=0;
var imax=100;
var run_time=0;
function _getLoadBar_l(format,time1){
	run_time=1;
	progress_d=0;
	var _loadBar_l = function(){
		$('#loadBarWrap').html('<div class="loadperw-host"><span id="loadNum"></span><span id="loadPer"></span></div><span id="loadPerText_host">0%</span><div class="loadberBtn"><a id="loadberBtn" href="javascript:;" style="display:block !important;" onclick="_close_l(this)">隐藏</a></div>');
		var _runOut;
		var progress = 0;
		var _run = function(){
			_runOut = setTimeout(function(){
				var file_name='';
				if(run_time==0){
					clearTimeout(_runOut);
					return false;
				}
				$.ajax({
					url: '/bhost/get_down_ok',
					type: "POST",
					async: false,
					data:{a0:se,a1:format,a2:time1},
					success: function(result) {
						var result = JSON.parse(result);
						if(result.Result == true){
							progress = result.progress;
							file_name=result.file_name;
							if(progress < progress_d){
								progress = progress_d;
							}else{
								progress_d = progress;
							}
						}
						else{
							_alert(1,"导出主机",result.ErrMsg);	
							_close_l();
							return false;
						}	
					}
				})
				var j = progress;
				if(j<imax){
					$('#loadPer').width(j+'%');
					$('#loadPerText_host').text(j+"%");
					$('#loadberBtn').css('display','block');
					_run();
				}else{
					$('#loadPer').width('100%');
					$('#loadPerText_host').text("100%");
					clearTimeout(_runOut);
					$('#loadberBtn').css('display','block');
					setTimeout(function(){
						_close_l();
						$.ajax({
							url: "/bhost/del_host_file",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),z1:time1},
							success:function(result){
							}
						})
						if(use_BH=='0'){
							document.frm1.action='/bhost/download_file';
							document.frm1.a0.value = se;
							document.frm1.a1.value = file_name;
							document.frm1.submit();
							return 0;
						}
						var file_name_arr=file_name.split('.');
						file_name_arr.splice(-2,1);
						file_name_arr.splice(-2,1);
						file_name_arr.splice(-2,1);
						var sesstimet = (new Date()).valueOf();
						var referrer_arr=document.referrer.toString().split('/');
						referrer_arr.pop();
						var referrer=referrer_arr.join('/');
						var json_download = {
								"Type": "Download",
								"Url": referrer,
								"Path": '/usr/storage/.system/dwload/',
								"Filename": file_name,
								"Session": $("input[name=se]").val(),
								"sesstimet":sesstimet,
								"Filenewname": file_name_arr.join('.')
						}
						var if_html_client = false;
						var base64_str = '';
						$.ajax({
								url: "/bhost/get_base64",
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
								success:function(result){
										var result=JSON.parse(result);
										if(result.Result){
												if_html_client = result.info;
												base64_str = result.b64;
										}else{
												_alert(1,"主机导出",result.ErrMsg); 
										}
								}
						})
						if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
						else{
							get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
							$('#YuFrame1').remove();
							$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
							$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
						}
					},1000);
				}
			},1000);
		}
		_run();
	}

	loadBarLayer_l = layer.open({
		title:false,
		closeBtn:false,
		content:'<div class="lodabar-w-host" id="loadBarWrap">加载中...</div>',
		btn:false,
		skin:'loadbar',
		area:['430px','400px'],
		move:false,
		success:function(i){
			_loadBar_l();
		}
	})
}
function _close_l(obj){
	run_time=0;
	layer.close(loadBarLayer_l);
}

var use_BH=window.parent.parent.document.frm.use_BH.value;
function get_down_ok(format,time1){
	$.ajax({
		url:'/bhost/get_down_ok',
		type:'post',
		async:false,
		data:{a0:se,a1:format,a2:time1},
		success:function(result){
			var down_result = JSON.parse(result);
			if (down_result.Result){
				clearInterval(if_ok_down);
				_closeLoading();
				if (down_result.ErrMsg != "None"){
					_alert(1,"主机导出",down_result.ErrMsg);
					return false;
				}
				_closeLoading();
				if(use_BH=='0'){
					document.frm1.action='/bhost/download_file';
					document.frm1.a0.value = se;
					document.frm1.a1.value = file_name;
					document.frm1.submit();
					return 0;
				}
				
				$.ajax({
					url:'/bhost/download_file',
					type:'post',
					async:false,
					data:{a0:se,z1:format,a99:use_BH},
					success:function(result){
						var result=JSON.parse(result);
						if(result.Result){
							var sesstimet = (new Date()).valueOf();
							var referrer_arr=document.referrer.toString().split('/');
							referrer_arr.pop();
							var referrer=referrer_arr.join('/');
							var json_download = {
									"Type": "Download",
									"Url": referrer,
									"Path": result.path,
									"Filename": result.filename,
									"Session": $("input[name=se]").val(),
									"sesstimet":sesstimet,
									"Filenewname": result.filenewname
							}
							var if_html_client = false;
							var base64_str = '';
							$.ajax({
									url: "/bhost/get_base64",
									type:"POST",
									async:false,
									data:{a0:se,z1:JSON.stringify(json_download)},
									success:function(result){
											var result=JSON.parse(result);
											if(result.Result){
													if_html_client = result.info;
													base64_str = result.b64;
											}else{
													_alert(1,"主机管理",result.ErrMsg); 
											}
									}
							})
							if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
							else{
								get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
								$('#YuFrame1').remove();
								$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
								$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
							}
						}
					}
				});
			}
		}
	});
}

//任务列表翻页
function turn_page(type){
	switch (type){
		case 1: //首页
			$("#curpage").val(1);
			break;
		case 2://上一页
			var cur = $("#curpage").val();
			if (cur == '1'){
				return false;
			}else{
				$("#curpage").val((parseInt(cur)-1));	
			}
			break;
		case 3://下一页
			var cur = $("#curpage").val();
			var total = $("#totalpage").text();
			if (cur == total){
				return false;
			}else {
				$("#curpage").val((parseInt(cur)+1));
			}
			break;
		case 4:
			$("#curpage").val($("#totalpage").text());
			break;
		case 5:
			var cur = $("#curpage").val();
			var numReg = /\D/;
			if (numReg.test(cur) || parseInt(cur) < 1 || cur == ''){
				$("#curpage").val(1);
			}
			break;
		default:
			;
	}
	get_hosttask_list();
}

function _compare_ip(x,y){
	var ip1 = x.split('.');
	var ip2 = y.split('.');
	for (var i1 = 0; i1 < 4; i1++){
		if (parseInt(ip1[i1]) < parseInt(ip2[i1])){
			return 3;
		}else if (parseInt(ip1[i1]) > parseInt(ip2[i1])){
			return 2
		}else{
			
		}
	}
	return 1
}

function downdata(x,y){
	var r_v = _compare_ip(x.HostIP,y.HostIP);
	if (r_v == 3){
		return -1;
	}else if (r_v == 2){
		return 1
	}
}
var task_list_detail;
function get_hosttask_list_detail(id){
	$.ajax({
		url:'/bhost/get_hosttask_detail',
		type:'post',
		async:false,
		data:{a0:se,z1:'null',z2:'null',z3:JSON.stringify(keyword_re_detail),z4:id},
		success:function(result){
			task_list_detail = JSON.parse(result);
			task_list_detail.data.sort(downdata);
			_initLoadData();
		}
	});
}

var hostip = "";
var append_taskdetail = 0;
function get_data(page,maxpage){
	if($("#apArea").find('.apSort').length==0){
		$("#apArea").append('<div class="apSort"></div>');
	}
	$('#aploadTip').show();
	var k = (parseInt(page)-1)*parseInt(maxpage);
	var ConnParamName = "";
	if (k >= task_list_detail.totalrow && task_list_detail.totalrow != 0){
		$('#aploadTip').html('已全部加载').show();
		return false;
	}
	var limitrow = k + 10;
	if (limitrow > task_list_detail.totalrow){
		limitrow = task_list_detail.totalrow;
	}
	var _append = 0;
	var html = '';
	hostip = "";
	if (task_list_detail.data[k].HostIP != hostip){
		var html = '';
	}else{
		var html = '<div class="apItem"><div class="label"></div><div class="cc"><table cellpadding="0" cellspacing="0"><tbody>';
	}
	for (var i = k;i < limitrow;i++){
		// if (task_list_detail.data[i].DisplayConnParam == null){
		// 	continue;
		// }
		if (task_list_detail.data[i].HostIP != hostip || task_list_detail.data[i].ErrorSource != null ||(task_list_detail.data[i].HostIP == hostip && task_list_detail.data[i].ErrorSource == null)){
			hostip = task_list_detail.data[i].HostIP;
			if (i != k){
				html += '</tbody></table></div></div>';
				$("#apArea").find('.apSort:last').append(html);
				html = "";
			}
			if (task_list_detail.data[i].DetailStatus == 5 && task_list_detail.data[i].ProtocolName == "" && task_list_detail.data[i].DisplayConnParam == null && task_list_detail.data[i].AccountName == ""){
				html += '<div class="apItem"><div class="label">' + task_list_detail.data[i].ErrorSource + '</div><div class="cc"><table cellpadding="0" cellspacing="0"><tbody>';
			}else{
				html += '<div class="apItem"><div class="label">主机:' + task_list_detail.data[i].HostIP + '</div><div class="cc"><table cellpadding="0" cellspacing="0"><tbody>';
			}
			
		}
		var detail_Status;
		var status;
		var AccountName;
		switch(task_list_detail.data[i].DetailStatus){
			case 0:
				detail_Status = "尚未审核";
				break;
			case 1:
				detail_Status = "正在审核";
				break;
			case 2:
				detail_Status = "审核成功";
				break;
			case 3:
				detail_Status = "连接失败";
				break;
			case 4:
				detail_Status = "登录失败";
				break;
			case 5:
				detail_Status = "不支持连接测试";
				break;
			default:
				detail_Status = "错误";
				break;
		}
		if (task_list_detail.data[i].DisplayConnParam == null){
			ConnParamName = "";
		}else{
			ConnParamName = task_list_detail.data[i].DisplayConnParam;
		}
		if (task_list_detail.data[i].AccountName == "*"){
			AccountName = "*";
		}else if (task_list_detail.data[i].AccountName == "-"){
			AccountName = "-";
		}else{
			AccountName = task_list_detail.data[i].AccountName;
		}
		// if(ConnParamName!=''){
			if (task_list_detail.data[i].DetailStatus == 5 && task_list_detail.data[i].ProtocolName == "" && task_list_detail.data[i].DisplayConnParam == null && task_list_detail.data[i].AccountName == ""){
				task_list_detail.data[i].DetailStatus == 2 ? status = '<span class="suc">'+task_list_detail.data[i].ErrorText+'</span>':status = '<span class="err">'+task_list_detail.data[i].ErrorText+'</span>';
				html += '<tr><td width="190">协议：' + '</td><td>连接参数：<span class="a">' + '</span></td><td width="0">账号：' + '</td><td width="0">' + status + '</td></tr>';
			}else{
				task_list_detail.data[i].DetailStatus == 2 ? status = '<span class="suc">'+detail_Status+'</span>':status = '<span class="err">'+detail_Status+'</span>';
				html += '<tr><td width="190">协议：' + task_list_detail.data[i].ProtocolName + '</td><td>连接参数：<span class="a">' + ConnParamName + '</span></td><td width="170">账号：' + AccountName + '</td><td width="140">' + status + '</td></tr>';
			}
		// }
		if (i == limitrow-1){
			html += '</tbody></table></div></div>';
			$("#apArea").find('.apSort:last').append(html);
		}
	}
	var maxPage = Math.floor(task_list_detail.totalrow / 10);
	var re_page = page - 1,
		num = 10;
	var pnum = (re_page * num + 1) + '-' + (re_page + 1) * num;
	if((re_page + 1) * num > task_list_detail.totalrow){
		pnum = (re_page * num + 1) + '-' + task_list_detail.totalrow;
	}
	html = '<div class="ap-pc"> 共' + task_list_detail.totalrow + '条</div>';
	$('#apArea').find('.ap-pc').remove();
	$('#apArea').append(html);
	if (re_page >= maxPage) {
		$('#aploadTip').html('已全部加载').show();
		return;
	} else if (re_page < maxPage) {
		$('#aploadTip').hide();
	}
}

var append_flag = 0;
var ppage = 0;
var row_len = 0;
var remain_page = 0;
var page_flag = 0;
var same_page = 0;
function get_data_i(type_add){
	if($("#apArea1").find('.apSort').length==0){
		$("#apArea1").append('<div class="apSort"></div>');
	}
	$('#aploadTip1').show();
	var Status;
	var html = '';
	var npage = 0;
	
	var page_i = -1;
	var page_re = 0;
	if (import_list_detail.data.length == 0){
	}
	$.each(import_list_detail.data,function(i,item){
		if (item.HostInfo == null){
			source = item.HostIP
                 	if (source == null){
                      		source = item.ErrorSource
                     	}else{
                      		source = "主机:" + source
                       	}
			html += '<div class="apItem"><div class="label fail" style="width:210px;">' +source + '</div><div class="cc" style="padding-left: 210px;"><table cellpadding="0" cellspacing="0" style="width:450px;"><tbody><tr><td style="/*text-align:center;*/" title="失败：'+item.DetailError+'">失败：' + item.DetailError + '</td></tr>';
			html += '</tbody></table></div></div>';
			$('#apArea1').find('.apSort:last').append(html);
			html = "";
		}
		else{
			var host_v = JSON.parse(item.HostInfo);
			if (item.DetailStatus == 0){
				html += '<div class="apItem"><div class="label succ" style="width:210px">' +"主机:"+ host_v.HostIP + '</div><div class="cc" style="padding-left: 210px;"><table cellpadding="0" cellspacing="0"><tbody>';
				Status = "成功";
			}else if (item.DetailStatus == 1){
				source = host_v.HostIP
				if (source == null){
					source = item.ErrorSource
				}else{
					source = "主机:" + source
				}			
				html += '<div class="apItem"><div class="label fail" style="width:210px;">' + source + '</div><div class="cc" style="padding-left: 210px;"><table cellpadding="0" cellspacing="0"><tbody>';
				Status = "失败：" + item.DetailError;
			}
			
			if (host_v.ServiceSet == null){
				html += '<tr><td style="width:153px;"><span class="a"></td><td width="168px"><span class="a"></td><td width="153px"><span class="a"></td><td width="140" style="text-align:center;" title="'+Status+'">' + Status + '</td></tr>';
				html += '</tbody></table></div></div>';
				$("#apArea1").find('.apSort:last').append(html);
				html = "";
				return 0;
			}
			var DeviceTypeName = "";
			var ServiceSet_arr=[];
			var num_i2=0;
			if (host_v.ServiceSet==null)host_v.ServiceSet=[];
			for(var i2=0;i2<host_v.ServiceSet.length;i2++){
				var item2=host_v.ServiceSet[i2];
				if($.inArray((item2.ProtocolName+item2.Port),ServiceSet_arr)>=0){
					host_v.ServiceSet.splice(i2,1);
					i2--;
					continue;
				}
				item2.HostServiceName=(item2.ProtocolName+item2.Port);
				ServiceSet_arr.push(item2.HostServiceName);
			};
			$.each(host_v.ServiceSet,function(i2,item2){ //服务
				var AccountName = [];
				var a_name;
				$.each(host_v.AccountSet,function(i3,item3){//账号
					$.each(item3.HostServiceSet,function(i4,item4){//账号服务
						item4.HostServiceName=(item4.ProtocolName+item4.Port);
						if (item4.HostServiceName == item2.HostServiceName){
							if (item3.HostAccount != null && item3.HostAccount.AccountName != null){
								if (item3.HostAccount.AccountName == "-"){
									a_name = "-";
								}else if (item3.HostAccount.AccountName == "*"){
									a_name = "*";
								}else{
									a_name = item3.HostAccount.AccountName;
								}
								if($.inArray(a_name,AccountName)<0){
									AccountName.push(a_name);
								}
							}	
						}
					});
				});
				if (AccountName.length != 0){
					AccountName = AccountName.join(';');
				}else{
					AccountName='';
				}
				if (i2 == 0){
					html += '<tr><td style="width:153px;">设备类型：<span class="a">'+host_v.DeviceTypeName+'</td><td width="168px">服务名称：<span class="a">' + item2.HostServiceName + '</td><td width="153px">账号：<span class="a">' + AccountName + '</td><td width="140" style="text-align:center;" title="'+Status+'">' + Status + '</td></tr>';
				}else{
					html += '<tr><td style="width:153px;"></td><td width="168px">服务名称：<span class="a">' + item2.HostServiceName + '</td><td width="153px">账号：<span class="a">' + AccountName + '</td><td width="140"></td></tr>';
				}
			});
			html += '</tbody></table></div></div>';
			$("#apArea1").find('.apSort:last').append(html);
			html='';
		}	
	});
	html = '</div><div class="ap-pc"> 共' + import_list_detail.totalrow + '条</div>';
	$("#apArea1").find('.ap-pc:last').remove();
	$('#apArea1').append(html);
	var maxPage = Math.floor(import_list_detail.totalrow / 10);
	var task_page = page - 1,
		num = 10;
	var pnum = (task_page * num + 1) + '-' + (task_page + 1) * num;
	if((task_page + 1) * num > import_list_detail.totalrow){
		pnum = (task_page * num + 1) + '-' + import_list_detail.totalrow;
	}

	if (task_page >= maxPage) {
		$('#aploadTip1').html('已全部加载').show();
		return;
	} else if (task_page < maxPage) {
		$('#aploadTip1').hide();
	}
	if(type_add<1){
		type_add++;
		_addData1(type_add);
	}
}

//任务详情列表
var keyword_re_detail=["status-2","status-5","status-7"];//搜索条件

var status;
//刷新任务详情
function fresh_task_list_detail(){
	$("#hosttask_list_detail tbody").empty();
	page = 1;
	get_hosttask_list_detail(host_task_id);
	status = task_list_detail.data[0].TaskStatus
}
/*
function get_task_status(){
	$.ajax({
		url:"/bhost/get_task_status",
		type:'post',
		async:false,
		data:{a0:se,z1:taskname},
		success:function(result){
			task_data = JSON.parse(result);
			task_status = 
		}
	});
}
*/
function fresh_task_IP_detail(){
	$("#import_host_list_detail tbody").empty();
	get_import_deatil(host_task_IP_id);
}

//切换导入/任务
function set_tab(obj,type){
	if (type == 1){
		$("#import_module").show();
		$("#details_module").hide();
	}else if(type == 2){
		$("#details_module").show();
		$("#import_module").hide();
	}
	$(obj).addClass("active").parent().siblings().children().removeClass("active");
	if (type == 2){
		clearInterval(if_ok);
		get_hosttask_list();
		/*
		repeat_execute = function(){
			if_ok = setInterval(function(){
				get_hosttask_list();
			},5000)}
		repeat_execute();
		*/
	}else{
		clearInterval(if_ok);
	}
	var w = $(window).width();
	_initSize();
}
//任务列表
var keyword_re=[];//搜索条件
var selectid = [];
function get_hosttask_list(){
	var MAX_PAGE = 5;
	var cur = $("#curpage").val();
	$.ajax({
		url:'/bhost/get_hosttask_data',
		type:'post',
		async:false,
		data:{a0:se,z1:cur,z2:MAX_PAGE,z3:JSON.stringify(keyword_re)},
		success:function(result){
			task_list = JSON.parse(result);
			$("#hosttask_list tbody").empty();
			var Status = "";
			var succcount;
			var FailCount;
			var ErrorText;
			$.each(task_list.data,function(i,item){
				if (item.Status == 0){
					//Status = "准备执行";
					Status = "准备审核";
				}else if (item.Status == 1){
					Status = "正在审核";
					//Status = "正在执行";
				}else if (item.Status == 2){
					Status = "审核完成";
					//Status = "执行完成";
				}else if (item.Status == 3){
					Status = "审核异常";
					//Status = "执行异常";
				}else if (item.Status == 4){ //正在导入
					Status = "正在导入";
				}else if (item.Status == 5){ //导入完成
					Status = "导入完成";
				}else if (item.Status == 6){ //导入中断
					Status = "导入中断";
				}else if (item.Status == 7){
					Status = "审核中断";
				}
				if (item.SuccCount == null){
					SuccCount = "";
				}else{
					SuccCount = item.SuccCount;
				}
				if (item.FailCount == null){
					FailCount = "";
				}else{
					FailCount = item.FailCount;
				}
				if (item.ErrorText == null){
					ErrorText = "";
				}else{
					ErrorText = item.ErrorText;
				}
				float_str = "<p>错误信息："+ErrorText+"</p>";
				$("#hosttask_list tbody").append('<tr><td width="50"><input type="checkbox" class="form-checkbox" value="'+item.HostLeadInTaskId+'"/></td><td title="'+item.HostLeadInTaskName+'">'+item.HostLeadInTaskName+'</td><td title="'+SuccCount+'">'+SuccCount+'</td><td title="'+FailCount+'">'+FailCount+'</td><td title="'+Status+'">'+Status+'</td><td title="'+ErrorText+'">'+ErrorText+'</td><td width="60"><div class=\"tab-ctr\"><a href="javascript:;" class="icon7" id="edit" title="测试任务" data="'+item.HostLeadInTaskName+'" data1="'+item.Status+'" data2="'+item.HostCount+'" data3="'+item.AcctCount+'" data4="'+item.NewCount+'" data5="'+item.ExistedCount+'"  onclick="task_detail(this,'+item.HostLeadInTaskId+');"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" title="删除任务" onclick=\"del_hosttask_r('+item.HostLeadInTaskId+')\"></a></div><div class="tab-moreinfo">'+float_str+'</div></td></tr>');
			});
			$('.form-checkbox,.form-radio').iCheck({
				checkboxClass: 'icheckbox_minimal-blue',
				radioClass: 'iradio_minimal-blue',
				increaseArea: '0' 
			});
		}
	});
	tabArr1();
	 $("#task_total").text(task_list.totalrow);
	totalpage = Math.ceil(parseInt(task_list.totalrow)/MAX_PAGE);
	if (totalpage < 1){
		totalpage = 1;
	}
	$("#totalpage").text(totalpage.toString());
	$("#page_total").text(MAX_PAGE);
	//<tr>中选择按钮进行设置
	$('#check_task_page').iCheck('uncheck');
	var check_page_flag = 0;
	$("#hosttask_list tbody input[type='checkbox']").each(function(){
		if ($.inArray(parseInt(this.value), selectid) != -1){					
			$(this).iCheck('check');
			check_page_flag++;
		}
    });
	if (check_page_flag == $("#hosttask_list tbody input[type='checkbox']").length && check_page_flag != 0){
		$('#check_task_page').iCheck('check');
	}
	if (parseInt(cur) > totalpage){
		$("#curpage").val(totalpage);
		get_hosttask_list();
	}
	var flag_id = 0;
	num = selectid.length;
	$("#select_total").text(num);
	$("#hosttask_list tbody input[type='checkbox']").unbind().on("ifChanged",function(){
		if ($(this).is(":checked")){
			num = $("#select_total").text();   
			num++;
			if (selectid.indexOf(parseInt(this.value)) == -1){
				selectid.push(parseInt(this.value))	
			}
			$("#select_total").text(num);
		}else{
			num = $("#select_total").text();
			num--;
			selectid.splice($.inArray(parseInt(this.value),selectid),1);
			$("#select_total").text(num);   
		}
		var check_num = 0;
		$("#hosttask_list tbody input[type='checkbox']").each(function(){
			if (!$(this).prop("disabled")){
				check_num++;
			}
		}) 
		if ($("#hosttask_list tbody").find('input[type=checkbox]:checked').length == check_num){
			$('#check_task_page').iCheck('check');
		}else{
			$('#check_task_page').iCheck('uncheck');
		}
	});
	$('#check_task_page').unbind().on('ifClicked',function(e){
		if(!$('#check_task_page').prop('checked')){
			$("#hosttask_list tbody input[type='checkbox']").each(function(){
				$(this).iCheck('check');   
			}) 
		}else{
			$("#hosttask_list").children('tbody').find('input[type=checkbox]').iCheck('uncheck');
		}
	});
}

//弹窗列表绑定
function tabArr1(){
	$('div.tab-moreinfo-on').remove();
	$('table').unbind();
	var tout,tin;
	var $cloneItem;
	var z = false;

	$('#hosttask_list').on('mouseover','tbody>tr',function(){
		document.onclick = null;
	}).on('mouseout','tbody>tr',function(){
		document.onclick = function(){
			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
		}
	}).on('click','tbody>tr',function(e){		
		x=e.target;
		if(x.id=='del'){
			return false;
		}
		if(x.id=='edit'){
			return false;
		}
		document.onclick = null;

		var $this = $(this);

			var $tr = $this;
			var oset = $tr.offset();
			var trc = $tr.attr('class');
			if(trc && trc.indexOf('on') >=0 ){
				$('div.tab-moreinfo-on').hide();
				$('div.tab-moreinfo-on').remove();
				$('tr.on').removeClass('on');
				return;
			}

			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
			$tr.addClass('on');
			
			var $box = $this.parents('div.box-table');
			var boxh = $box.outerHeight(), boxo = $box.offset();
			var $item = $this.children('td:last').children('div.tab-moreinfo');
			var ih = $item.outerHeight(),th = $tr.outerHeight();
			$cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');
			if(boxh < oset.top-boxo.top + ih + th - 40 ){
				$cloneItem.css({
					top:oset.top - ih,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}else{
				$cloneItem.css({
					top:oset.top + $tr.outerHeight() + 1,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}
			z_v = $cloneItem.prev('div').css('z-index');
			$cloneItem.css('z-index',z_v+1);
    });
    $('.box-table,body,.c-cont2,.c-cont').off("scroll");
	$('.box-table,body,.c-cont2,.c-cont').on('scroll',function(){
		$('div.tab-moreinfo-on').remove();
		$('tr.on').removeClass('on');
	})
	
	var len = $('#hosttask_list tbody tr .tab-ctr:first').children('a').length;
	$('#hosttask_list>thead>tr>th:last').width(len*30);
}
function tabArr2(){
	$('div.tab-moreinfo-on').remove();
	$('table').unbind();
	var tout,tin;
	var $cloneItem;
	var z = false;

	$('#export_list').on('mouseover','tbody>tr',function(){
		document.onclick = null;
	}).on('mouseout','tbody>tr',function(){
		document.onclick = function(){
			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
		}
	}).on('click','tbody>tr',function(e){		
		x=e.target;
		if(x.id=='del'){
			return false;
		}
		if(x.id=='edit'){
			return false;
		}
		document.onclick = null;

		var $this = $(this);

			var $tr = $this;
			var oset = $tr.offset();
			var trc = $tr.attr('class');
			if(trc && trc.indexOf('on') >=0 ){
				$('div.tab-moreinfo-on').hide();
				$('div.tab-moreinfo-on').remove();
				$('tr.on').removeClass('on');
				return;
			}

			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
			$tr.addClass('on');
			
			var $box = $this.parents('div.box-table');
			var boxh = $box.outerHeight(), boxo = $box.offset();
			var $item = $this.children('td:last').children('div.tab-moreinfo');
			var ih = $item.outerHeight(),th = $tr.outerHeight();
			$cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');
			if(boxh < oset.top-boxo.top + ih + th - 40 ){
				$cloneItem.css({
					top:oset.top - ih,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}else{
				$cloneItem.css({
					top:oset.top + $tr.outerHeight() + 1,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}
			z_v = $cloneItem.prev('div').css('z-index');
			$cloneItem.css('z-index',z_v+1);
    });
    $('.box-table,body,.c-cont2,.c-cont').off("scroll");
	$('.box-table,body,.c-cont2,.c-cont').on('scroll',function(){
		$('div.tab-moreinfo-on').remove();
		$('tr.on').removeClass('on');
	})
	
	var len = $('#export_list tbody tr .tab-ctr:first').children('a').length;
	$('#export_list>thead>tr>th:last').width(len*30);
}
//删除任务
function del_hosttask_r(id){
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"主机任务",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			delete_hosttask(0,id);
			for (var i = 0; i < selectid.length; i++){      
				if (selectid[i] == parseInt(id)){
					num = $("#select_total").text();
					num = parseInt(num)-1;
					$("#select_total").text(num);
					selectid.splice($.inArray(parseInt(id),selectid),1);
					break;
				}
        	}
			get_hosttask_list();
		},
		btn2:function(i){
			parent.layer.close(i);
		}
	});
}
//批量删除
function del_hosttask_more(){
	if (selectid.length == 0){
		_alert(2,"主机任务","请选择要删除的数据");
		return;
	}
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"主机任务",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			delete_hosttask(1,JSON.stringify(selectid));
			selectid=[];
			get_hosttask_list();
		},
		btn2:function(i){
			parent.layer.close(i);
		}
	});
}
//删除任务
function delete_hosttask(type,id){
	var msstr = aceg(JSON.stringify(type),se);
	$.ajax({
		url:'/bhost/del_hosttask',
		type:'post',
		async:false,
		data:{a0:se,z1:type,z2:id,m1:msstr},
		success:function(result){
			del_result = JSON.parse(result);
			if (del_result.Result){
				_alert(0,"主机任务","删除成功");
				return false;
			}else{
				_alert(1,"主机任务",del_result.ErrMsg);
				return false;
			}
		}
	})
}


function get_task_data(){
	$.ajax({  
		url:'/bhost/get_hosttask_data',
		type:"post",
		async:false,
		data:{a0:se,z1:'null',z2:'null',z3:JSON.stringify(keyword_re)},
		success:function(result){
			var result = JSON.parse(result);
			$.each(result.data,function(i,item){
				selectid.push(item.HostLeadInTaskId);
			});
		}
	});
}
//全选任务
function select_all(){
	selectid=[];
	var select_total = $("#select_total").text();
	var task_total = $("#task_total").text();
	if (parseInt(select_total) == parseInt(task_total)){
		$("#hosttask_list").find('input').iCheck('uncheck');
	}else{
		get_task_data();
		$("#hosttask_list tbody input[type='checkbox']").each(function(){
			if (!$(this).prop("disabled")){
				$(this).iCheck('check');   
			}
		})      
	}
	$("#select_total").text(selectid.length);
}
//刷新任务
function fresh_task_list(){
	get_hosttask_list();
	selectid = [];
	$("#details_module input[type='checkbox']").each(function(){	
		$(this).iCheck('uncheck');
	});
	$("#select_total").text(0);
}

//导入浮层
var d;
var if_ok;
function _import_host(type){
	$("#file_v").val('');
	$("#file_change").val('');$("#file_change1").val('');
	$("#pending_box").iCheck('uncheck');
	$("#cover_box1").iCheck('uncheck');
	var $dialogCont = $("#scDCTab2_import").show();
	d = dialog({
		title:"主机导入",
		content:$dialogCont,
		id:"scDCTab2_import",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
		if (if_ok == null){
		}else{
			clearInterval(if_ok);
		}
		//------------------------------------------------
		_initList();
		//--------------------------------------------------
	});
	d.showModal();
	if (type == 1){
		$("#import_module").show();
		$("#details_module").hide();
		$("#task_import").addClass("active").parent().siblings().children().removeClass("active");
		_initSize();
	}
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		d.close().remove();
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if ($("#details_module").is(':visible')){
			d.close().remove();
			return false;
		}
		var cover_flag = 0;
		var pending_flag = 0;
		if ($("#file_v").val() == ""){
			_alert(2,"主机导入","请选择文件");
			return false;
		}
		var file_v = $("#file_v").val();
		var fileReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		if (!fileReg.test(file_v)){
			_alert(1,"主机导入","导入文件名称格式不正确");
			return false;
		}
		
		if (file_v.substr(file_v.length-3) != "csv" && file_v.substr(file_v.length-3) != "CSV" && file_v.substr(file_v.length-3) != "xls" && file_v.substr(file_v.length-3) != "XLS" && file_v.substr(file_v.length-4) != "xlsx" && file_v.substr(file_v.length-4) != "XLSX"){
			_alert(1,"主机导入","导入文件格式不正确，只支持.csv、.xls、.xlsx格式文件");
			return false;
		}
		if (file_v.substr(file_v.length-4) == "xlsx" || file_v.substr(file_v.length-4) == "XLSX"){
			var file_name = file_v.substring(0,file_v.length-5);
		}else{
			var file_name = file_v.substring(0,file_v.length-4);
		}		
		var file_exist = 0;
		var formData_f = new FormData($("#uploadForm")[0]);
		formData_f.append('a0',se);
		$.ajax({
			url:'/bhost/isexist_data',
			type:'post',
			data:formData_f,
			async: false,  
			cache: false,
			contentType: false,
			processData: false,
			success:function(result){
				var is_r = JSON.parse(result);
				if (is_r.Result){
					file_exist = 0;
				}else{
					file_exist = 1;
					_alert(2,"主机导入","该任务已存在");
					return false;
				}	
			}
		});
		if (file_exist == 1){
			return false;
		}
		var formData = new FormData($("#uploadForm")[0]);
		formData.append('a0',se);
		formData.append('a99',use_BH);
		var bo = $("#pending_box").prop("checked");
		if ($("#pending_box").prop("checked")){
			$.ajax({
				url:'/bhost/pending_data',
				type: 'POST',
				data: formData,  
				async: false,  
				cache: false,
				contentType: false,  
				processData: false,  
				success: function (result) {
					$("#file_v").val('');
					$("#file_change").val('');$("#file_change1").val('');
					$("#pending_box").iCheck('uncheck');
					$("#cover_box1").iCheck('uncheck');
					$.ajax({
						url:'/bhost/get_hosttask_data',
						type:'post',
						async:false,
						data:{a0:se,z1:1,z2:MAX_PAGE_T,z3:'[]'},
						success:function(result){
							var task_list_data = JSON.parse(result);
							var totalpage = Math.ceil(parseInt(task_list_data.totalrow)/MAX_PAGE_T);
							if (totalpage < 1){
								totalpage = 1;
							}
							//$("#curpage").val(totalpage);
							$("#curpage").val(1);
							set_tab($("#task_list_tab"),2);
						}
					});
				},
				error: function(XMLHttpRequest,textStatus,errorThrown){
				}
			});
		}
		else{
		    var b1 = $("#cover_box1").prop('checked');
			if ($("#cover_box1").prop('checked')){
				cover_flag = 1;
			}else{
				cover_flag = 0;
			}
			var formData = new FormData($("#uploadForm")[0]);
			formData.append('z1',cover_flag);
			formData.append('a0',se);
			formData.append('a99',use_BH);
			$.ajax({
				url:'/bhost/import_data',
				type: 'POST',
				data: formData,  
				async: false,  
				cache: false,
				contentType: false,  
				processData: false,  
				success: function (result) {
					$("#file_v").val('');
					$("#file_change").val('');
					$("#file_change1").val('');
					$("#pending_box").iCheck('uncheck');
					$("#cover_box1").iCheck('uncheck');
					$.ajax({
						url:'/bhost/get_hosttask_data',
						type:'post',
						async:false,
						data:{a0:se,z1:1,z2:MAX_PAGE_T,z3:'[]'},
						success:function(result){
							var task_list_data = JSON.parse(result);
							var totalpage = Math.ceil(parseInt(task_list_data.totalrow)/MAX_PAGE_T);
							if (totalpage < 1){
								totalpage = 1;
							}
							$("#curpage").val(totalpage);
							$("#curpage").val(1);
							set_tab($("#task_list_tab"),2);
						}
					});
					//set_tab($("#task_list_tab"),2);
				}
			});	
		}
	});
	_initSize();
}
var MAX_PAGE_T = 5;
var host_task_id;
var host_task_IP_id;
function task_detail(obj,id){
	var filename = $(obj).attr('data');
	status = $(obj).attr('data1');
	var host_count = $(obj).attr('data2');
	var acct_count = $(obj).attr('data3');
    var new_count = $(obj).attr('data4');
    var exist_count = $(obj).attr('data5');
	$("#hosttask_list_detail tbody").empty();
	$("#cover_box").iCheck('uncheck');
	$("#import_host_list_detail tbody").empty();
	$(".tab-moreinfo.tab-moreinfo-on").remove();
	$('#apArea').empty();
	$('#apArea1').empty();
	page = 0;
	ppage = 0;
	append_flag = 0;
	row_len = 0;
	remain_page = 0;
	page_flag = 0;
	same_page = 0;
	if (status == 0){
		_alert(2,"主机任务","该任务正在审核中");
		return false;
	}
	if (status == 4){
		_alert(2,"主机任务","该任务正在导入中");
		return false;
	}
	if (status == 6 || status == 7){//导入中断
		_alert(1,"主机任务","该任务发生错误");
		return false;
	}
	d.close().remove();
	var succ_flag = $(obj).parents('tr:first').children('td:eq(2)').text();
	var fail_flag = $(obj).parents('tr:first').children('td:eq(3)').text();
	clearInterval(if_ok);
	if (status == 5){//导入完成
		$("#fail_IP_box").iCheck('uncheck');
		$(".mm.mm1").children('span').eq(0).text(host_count);
		$(".mm.mm1").children('span').eq(1).text(acct_count);
		$(".mm.mm1").children('span').eq(2).text(succ_flag);
		$(".mm.mm1").children('span').eq(3).text(fail_flag);
        $(".mm.mm1").children('span').eq(4).text(exist_count);
        $(".mm.mm1").children('span').eq(5).text(new_count);
		host_task_IP_id = id;
		_initLoadData1();
		$("#fail_IP_box").unbind().on('ifChanged',function(){//仅显示导入失败的主机信息
			if ($(this).prop("checked")){
				keyword_t.push("status-1");
			}else{
				keyword_t = [];
			}
			$('#apArea1').empty();
			page = 0;
			ppage = 0;
			append_flag = 0;
			row_len = 0;
			remain_page = 0;
			page_flag = 0;
			same_page = 0;
			_initLoadData1();
			//get_import_deatil(id,10,0);
		});
		$("#_HostList").hide();
		$('#importPage').show();
	}else{
		keyword_re_detail=["status-2","status-5","status-7"];//搜索条件
		$("#succ_checkbox").iCheck('check');
		$("#fail_checkbox").iCheck('check');
		$("#refuse").iCheck('check');
		$("#pending_show").iCheck('check');
		$(".mm").children('span:eq(0)').text(host_count);
		host_task_id = id;
		get_hosttask_list_detail(id);
		get_detail_count(id);
		//$("#task_total_detail").text(task_list_detail.totalrow);
		$("#succ_checkbox").unbind().on("ifChanged",function(){
			if ($(this).prop("checked")){
				keyword_re_detail.push("status-2");
			}else{
				keyword_re_detail.splice($.inArray("status-2", keyword_re_detail),1);
			}
			$('#apArea').empty();
			page = 0;
			hostip = "";
			if (keyword_re_detail.length == 0){
				return false;
			}
			get_hosttask_list_detail(host_task_id);
			get_detail_count(host_task_id);
		});
		$("#fail_checkbox").unbind().on("ifChanged",function(){
			if ($(this).prop("checked")){
				keyword_re_detail.push("status-7");//表示3，4
			}else{
				keyword_re_detail.splice($.inArray("status-7", keyword_re_detail),1);
			}
			$('#apArea').empty();
			page = 0;
			hostip = "";
			if (keyword_re_detail.length == 0){
				return false;
			}
			get_hosttask_list_detail(host_task_id);
			get_detail_count(host_task_id);
		});
		$("#refuse").unbind().on("ifChanged",function(){
			if ($(this).prop("checked")){
				keyword_re_detail.push("status-5");//表示5
			}else{
				keyword_re_detail.splice($.inArray("status-5", keyword_re_detail),1);
			}
			$('#apArea').empty();
			page = 0;
			hostip = "";
			if (keyword_re_detail.length == 0){
				return false;
			}
			get_hosttask_list_detail(host_task_id);
			get_detail_count(host_task_id);
			$("#task_total_detail").text(task_list_detail.totalrow);
		});
		$("#import_btn").unbind().bind('click',function(){
			import_task(filename,status);
		});
		$("#_HostList").hide();
		$('#allPage').show();
	}
	
}

function get_detail_count(id){
	$.ajax({
		url:'/bhost/get_detail_count',
		type:'post',
		async:false,
		data:{a0:se,z1:id},
		success:function(result){
			count_result = JSON.parse(result);
			if (count_result.Result){
				$(".mm").children('span:eq(1)').text(count_result.account_count);
				$(".mm").children('span:eq(2)').text(count_result.fail_count);
				$(".mm").children('span:eq(3)').text(count_result.succ_count);
				$(".mm").children('span:eq(4)').text(count_result.support_count);
			}
		}
	});
}

function down_importdata(x,y){
	//var a = JSON.parse(x.HostInfo);
	//var b = JSON.parse(y.HostInfo);
	if (x.HostIP == null){
		return -1
	}
	if (y.HostIP == null){
		return 1
	}
	var r_v = _compare_ip(x.HostIP,y.HostIP);
	if (r_v == 3){
		return -1;
	}else if (r_v == 2){
		return 1
	}
}

//获取导入完成的详细信息
var import_list_detail;
var keyword_t = [];
function get_import_deatil(id,limitrow,offsetrow){
	$.ajax({
		url:'/bhost/get_import_deatil',
		type:'post',
		async:false,
		data:{'a0':se,'z1':id,'z2':JSON.stringify(keyword_t),z3:limitrow,z4:offsetrow},
		success:function(result){
			import_list_detail = JSON.parse(result);
			import_list_detail.data.sort(down_importdata);
		}
	});
}

//导入任务列表主机
function import_task(name,status){
	var succ = 0;
	var cover_flag = 1;
	
	if (status == 3){
		_alert(2,"主机导入","该任务审核异常");
		return false;
	}
	if (status != 2){
		_alert(2,"主机导入","该任务未审核完成");
		return false;
	}
	if ($("#apArea").children().length == 0){
		_alert(2,"主机导入","没有可导入的主机");
		return false;
	}
	/*
	if ($("#hosttask_list_detail").find('tr').length == 0){
		_alert(2,"主机导入","没有可导入的主机");
		return false;
	}
	*/
	if ($("#succ_checkbox").prop("checked")){//成功
		succ = succ + 1;
	}
	if ($("#fail_checkbox").prop("checked")){//失败
		succ = succ + 2;
	}
	if ($("#refuse").prop("checked")){ //不支持连接测试
		succ = succ + 4;
	}
	//succ 1.导成功;2.导失败;3.不导不支持连接测试;4.导不支持连接测试;5.不导失败;6.不导成功;7.全导
	/*
	if ($("input[name='succ']").eq(0).prop('checked')){
		succ = 1;
	}else{
		succ = 2;
	}
	*/
	if ($("#cover_box").prop('checked')){
		cover_flag = 1;
	}else{
		cover_flag = 0;
	}
	import_task_true(name,succ,cover_flag);
}

function import_task_true(name,succ,cover_flag){
	var msstr = aceg(JSON.stringify(name),se);
	var formData = new FormData($("#uploadForm")[0]);
	formData.append('z1',cover_flag);
	formData.append('a0',se);
	formData.append('z2',name);
	formData.append('z3',succ);
	formData.append('z4',host_task_id);
	formData.append('m1',msstr);
	$.ajax({
		url:'/bhost/import_task',
		type: 'POST',
		data: formData,  
		async: false,  
		cache: false,
		contentType: false,  
		processData: false,  
		success: function (result) {
			_closeDetail(1);
		},
		error: function(XMLHttpRequest,textStatus,errorThrown){
		}
	});
}

var host_su_flag = 0;
function get_over_msg(){
	$.ajax({
		url:'/bhost/get_over_msg',
		type:'POST',
		async:false,
		data:{a0:se},
		success:function(result){
			if (result == '1'){
				return false;
			}
			host_msg = JSON.parse(result);
			if (host_msg.Result){
				if (host_msg.info != 1){
					_alert(0,"主机导入","导入成功");
					return false;
				}
			}else{
				_alert(1,"主机导入","导入失败");
				return false;
			}
		}
	})
}

function filetip(obj){
	var c=$(obj).val();
	c = c.split("\\");
	var b = c[c.length-1];
	$('#file_v').val(b);
}
var setinterval=null;
function browes(){
	if(use_BH=='0'){
		$("#file_change1").click();
		return 0;
	}
	var referrer_arr=document.referrer.toString().split('/');
	referrer_arr.pop();
	var referrer=referrer_arr.join('/');
	var sesstimet = (new Date()).valueOf();
	var json_download = {
			"Type": "Upload",
			"Url": referrer,
			"Path": "/usr/storage/.system/upload/",
			"Filename": sesstimet+'',
			"Session": se,
			"sesstimet":sesstimet+''
	}
	var if_html_client = false;
	var base64_str = '';
	$.ajax({
			url: "/bhost/get_base64",
			type:"POST",
			async:false,
			data:{a0:window.parent.document.frm.se.value,z1:JSON.stringify(json_download)},
			success:function(result){
					var result=JSON.parse(result);
					if(result.Result){
							if_html_client = result.info;
							base64_str = result.b64;
					}else{
							_alert(1,"主机管理",result.ErrMsg); 
					}
			}
	})
	if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
	else{
		get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
		$('#YuFrame1').remove();
		$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
		$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
	}
	clearInterval(setinterval);
	setinterval=setInterval(function(){
		$.ajax({
			url: "/bhost/find_item_sql",
			type:"POST",
			async:false,
			data:{a0:window.parent.document.frm.se.value,a1:sesstimet},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
					if(result.info==null){

					}else{
						var info_arr=result.info.split('/');
						if(info_arr.length>1){
							$('#file_v').val(info_arr.pop());
							$('#file_change').val('/usr/storage/.system/upload/'+sesstimet);
						}else{
							if(result.info=='NULL'){
								$('#file_v').val('');
								$('#file_change').val('');
							}else{
								$('#file_v').val(result.info);
								$('#file_change').val('/usr/storage/.system/upload/'+sesstimet);
							}
						}
						
						clearInterval(setinterval);
					}
				}
			}
		});
	}, 3000);
}


//批量账号
function account_add_or_clear(){
	$('#_HostList').hide();
	$('#hostTree_z').empty();
	$("#service_list_a").empty();
	$("#account_select").val(-1).trigger('change');
	$("#account_text").val("");
	$('#_Server').hide();
	$('#_account').show();
	$('#check_one_page_zdp').iCheck('uncheck');
	_initList_account();
	bind_SSHkey_xSelect();
}

//加载树
function _initList_account(){
	$('#hostTree_z').unbind();
	//get_hostdirectory(-1,0);
	var hdata;
	$.ajax({
		url:"/bhost/get_h_Dir",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:0,a2:0},
		success:function(result){
			hdata = JSON.parse(result);
		}
	})
    _viewHTML_account(hdata,'#hostTree_z');
	
    $('#hostTree_z').on('click','i.h-aicon',function(){
    	var $item = $(this);
    	var id = $item.data('id').split('-')[1];
		var t = $item.data('id').split('-')[0];
    	var $u = $item.parent().children('ul');
    	if($u.is(':hidden')){
    		$item.addClass('h-aicon-d');
    		$u.show();
    		if($u.children('li').length == 0){
    			var v = 2,d = 1;
    			var $input = $(this).siblings('span.checkbox');
		    	var c = $input.attr('class');
		    	if(c.indexOf('checked')>0){
		    		v=1;
		    	}else if(c == 'checkbox'){
		    		v=0;
		    	}
				_initHTML_account($u,id,v,d);
    		}
    	}else{
    		$item.removeClass('h-aicon-d');
    		$u.hide();
    	}
    });
	/*
	$('.zcheck.zcheck-g').on('change',function(){
		host_json={
			"HostSet":[],
			"HGroupSet":[],
			"IPAddr":[],
			"ServerScopeSet":[]
		};
		save_host($('#hostTree_z'));
		account_list_show();
	});
	*/
}

var host_json={
	"LoginUserCode":"",
	"HostSet":[],
	"HGroupSet":[],
	"IPAddr":[],
	"ServerScopeSet":[]
};
function save_host(obj) {
	$(obj).find('span.checkbox.half,span.checkbox.checked').each(function (i,item) {
		var state = $(item).attr('class');
		var $u = $(item).parent().children('ul');
		if (state == "checkbox checked") {
			var id = $(item).siblings('input').attr('id').split('-');
			var name = $(item).siblings('span.h-name').text();
			
			if (id[0] == "nodehg") {
				if ($(item).parents('ul:first').siblings('span.checkbox').length != 0){
					var p_class = $(item).parents('ul:first').siblings('span.checkbox').attr('class');
					if (p_class == "checkbox checked"){
						return true;
					}
				}
				var set = '{"HGId":' + id[1] + ',"HGName":"' + name + '"}';
				var object_str = JSON.stringify(host_json.HGroupSet);
				if (object_str.indexOf(set) === -1){
					host_json.HGroupSet.push(JSON.parse(set));
				}
			} else {
				var p_class = $(item).parents('ul:first').siblings('span.checkbox').attr('class');
				if (p_class == "checkbox checked"){
					return true;
				}else{
					var set = '{"HostId":' + id[2] + ',"HostName":"' + name + '"}';
					var object_str = JSON.stringify(host_json.HostSet);
					if (object_str.indexOf(set) === -1){
						host_json.HostSet.push(JSON.parse(set));
					}
				}
			}
		} else {
			save_host($u);
		}
	});
}
function _getWait(obj){
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
	
	$(obj).removeClass('done').show().unbind().on('mouseover',function(){
		waitlayer = layer.tips('搜索中',this,{
			tips:1,
			time:0,
			skin: 'waitlayer'
		});
	}).on('mouseout',function(){
		if(typeof waitlayer != 'undefined'){
			layer.close(waitlayer);
		}
	});
	// //完成
	// setTimeout(function(){
	// 	_waitDone();
	// },3000)
}
function _waitDone(obj,num){
	if(typeof waitlayer != 'undefined'){
		layer.close(waitlayer);
	}
	if (num==0) {
		$(obj).stop();
		$(obj).hide();
	}else{
		$(obj).fadeOut(num);
	}
	
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
}
var accountid_z = [];
//获取所有的账号和服务
function get_all_aors(){
	$.ajax({
		url:'/bhost/get_AccountProtocolForAuth',
		type:'post',
		async:false,
		data:{a0:se,z1:JSON.stringify(host_json)},
		success:function(result){
			apdata = JSON.parse(result);
		}
	});
}
//获取共有的账号和服务
function get_same_aorp(){
	$.ajax({
		url:'/bhost/Get_SameAccountProtocolForAuth',
		type:'post',
		async:false,
		data:{a0:se,z1:JSON.stringify(host_json)},
		success:function(result){
			if (result == "None"){
				apdata = "";
			}else{
				apdata = JSON.parse(result);
			}			
		}
	})
}
function account_list_show(){
	var all_flag = $("#mix_select_zdp").val();
	//获取所有的账号和服务
	$("#service_list_a").empty();
	$("#service_list_a").hide();
	$('#check_one_page_zdp').iCheck('uncheck');
	if (all_flag == 1){
		get_all_aors();
	}else{
		get_same_aorp();
	}
	accountid_z = [];
	$.each(apdata.AccountSet,function(i,item){
		if (item.AccountId != 5 && accountid_z.indexOf(item.AccountId) === -1){
			$("#service_list_a").append('<tr><td style="width:'+($("#width_flag").width()*0.44-48)+'px;"><input type="checkbox" class="form-checkbox" id="ai'+item.AccountId+'"/></td><td>'+item.AccountName+'</td></tr>');
			accountid_z.push(item.AccountId);
		}
	});
	$('#service_list_a').find('input').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
	$("#service_list_a").find('input').unbind().on('ifChanged',function(){
		var aid = $(this).attr('id').substring(2);
		if ($(this).prop('checked')){
			if (select_aid.indexOf(aid) === -1){
				select_aid.push(parseInt(aid));
			}	
		}else{
			select_aid.splice($.inArray(aid,select_aid),1);
		}
	});
	$("#service_list_a").children('tr').bind('click',function(e){
		x=e.target;
		if (x.nodeName != 'A'){
			var input = $(this).find("input[type='checkbox']");
			if ($(input).prop('checked') == false){
				$(input).iCheck('check');
			}else{
				$(input).iCheck('uncheck');
			}
		}
	});
	$("#service_list_a").show();
}

var select_aid = [];

//账号删除
function delete_account(){
	var ser_name;
	if ($("#service_list_a").find('input:checked').length == 0){
		_alert(2,"批量账号","请选择账号");
		return false;
	}
	$('#server_list_select').empty();
	if ($("#mix_select_zdp").val() == 2){
		get_same_aorp();
	}else{
		get_all_aors();
	}
	$.each(apdata.ServiceSet,function(i,item){
		if (item.ConnParamName != null){
			var ser_name1 = item.ProtocolName+ ':' + item.Port + ':' + item.ConnParamName;
		}else{
			var ser_name1 = item.ProtocolName+ ':' + item.Port;
		}
		ser_name = item.ProtocolName+ ':' + item.Port;
		var ser_id = item.ProtocolId + '-' + item.Port;
		// var ser_id = item.ProtocolId + '-' + item.Port + '-' + item.ConnParamId;
		if($("#server_list_select #s-"+ser_id).length>0){
			$("#server_list_select #s-"+ser_id).attr('coni',$("#server_list_select #s-"+ser_id).attr('coni')+';'+item.ConnParamId);
			$("#server_list_select #s-"+ser_id).attr('seri',$("#server_list_select #s-"+ser_id).attr('seri')+';'+ser_name1);
		}else{
			$("#server_list_select").append("<div class=\"as\"><label><input type=\"checkbox\" id=\"s-" + ser_id + "\" coni=\""+item.ConnParamId+"\" seri=\""+ser_name1+"\" class=\"form-checkbox\" >" + ser_name + "</label></div>");
		}
		
	});
	$("#server_list_select").find('input').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	})
	var $dialogCont = $("#scDCTab2_delete").show();
	var d = dialog({
		title:"服务",
		content:$dialogCont,
		id:"scDCTab2_delete",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$('#del_account_z').removeClass('active');
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();

	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		$('#del_account_z').removeClass('active');
		d.close().remove();
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if(_delete_Acount() == false) return false;
		$('#del_account_z').removeClass('active');
		d.close().remove();
	});
}

function _delete_Acount(){
	var del_json = {
		"LoginUserCode":"",
		"HostSet": [],
		"HGroupSet": [],
		"AccountSet": []
	}
	if ($("#server_list_select").find('input:checked').length == 0){
		_alert(2,"账号删除","请选择服务");
		return false;
	}
	del_json.LoginUserCode = window.parent.document.frm.us.value;
	del_json.HostSet = host_json.HostSet;
	del_json.HGroupSet = host_json.HGroupSet;
	$.each(select_aid,function(i,item){
		var account_set	= {	
			"AccountId": 4,                         
			"HostServiceSet": [],
			"AccountName":""
		};
		account_set.AccountId = item;
		account_set.AccountName = $("#ai"+item).parents("td:first").next('td').text();
		$("#server_list_select").find('input:checked').each(function(){
			var ppc = $(this).attr('id').split('-');
			var con_id=$(this).attr('coni').split(';');
			var ser_str=$(this).attr('seri').split(';');
			var text = $(this).parents('label:first').text();
			$.each(con_id,function(co_i,co_item){
				var set = '{"ProtocolId":'+ppc[1]+',"Port":'+ppc[2]+',"ConnParamId":'+co_item+',"ServiceName":"'+ser_str[co_i]+'"}';
				account_set.HostServiceSet.push(JSON.parse(set));
			});
		});
		del_json.AccountSet.push(account_set);
	});
	var Host_all_arr=new Array();
	var Host_all=new Array();
	$.each(del_json.HostSet,function(i,item){
		if($.inArray(item.HostId,Host_all_arr)<0){
			Host_all_arr.push(item.HostId);
			Host_all.push({"HostId":item.HostId,"HostName":item.HostName});
		}
	});
	$.each(del_json.HGroupSet,function(i,item){
		$.ajax({
			url:'/bhost/PGetHostList_m',
			type:'post',
			async:false,
			data:{a0:se,a1:JSON.stringify(item.HGId)},
			success:function(result){
				var results = JSON.parse(result);
				if (results.Result){
					$.each(results.info,function(i1,item1){
						if($.inArray(item1.HostId,Host_all_arr)<0){
							Host_all_arr.push(item1.HostId);
							Host_all.push({"HostId":item1.HostId,"HostName":item1.HostName});
						}
					});
				}else{
					_alert(1,"批量账号",results.info);
					return false;
				}
			}
		});
	});
	_getLoadBar_a_d(Host_all,del_json);
	/*
	msstr = aceg(JSON.stringify(del_json),se);
	$.ajax({
		url:"/bhost/delete_account_z",
		type:'post',
		async:false,
		data:{a0:se,a1:JSON.stringify(del_json),m1:msstr},
		success:function(result){
			var results = JSON.parse(result);
			if (results.Result){
				_alert(0,"主机账号","成功数："+ results.SuccCount + "，失败数：" + results.FailCount);
				$("#check_one_page_zdp").iCheck('uncheck');
				select_aid=[];
				account_list_show();
				return false;
			}else{
				_alert(1,"主机账号",results.ErrMsg);
				return false;
			}
		}
	});
	*/
}
function _close_a_d(obj,type){
	if(type==1){
		parent.layer.open({
			type:1,
			title: '批量账号',
			content: '<div class="layer-alert"><i class="alert warning"></i>是否取消</div>',
			btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			yes:function(i){
				parent.layer.close(i);
				_getLoadBar_a_state=0;
				layer.close(loadBarLayer);
				_alert(0,"批量账号","成功数："+SuccCount+",失败数："+FailCount);
				$("#check_one_page_zdp").iCheck('uncheck');
				select_aid=[];
				account_list_show();
			},
			no:function(i){
				parent.layer.close(i);
			}
		});
	}else{
		layer.close(loadBarLayer);
		_alert(0,"批量账号","成功数："+SuccCount+",失败数："+FailCount);
		$("#check_one_page_zdp").iCheck('uncheck');
		select_aid=[];
		account_list_show();
	}
	
}
function _getLoadBar_a_d(Host_all_arr,save_json){ //prog 为当前任务进度
	SuccCount = 0;
	FailCount=0;
	_getLoadBar_a_state=1;
	var _loadBar = function(){
		$('#loadBarWrap').html('<div class="loadperw"><span id="loadPer"></span></div><span id="loadPerText">0%</span><div class="loadberBtn"><a id="loadberBtn0" style="display:block" href="javascript:;" onclick="_close_a_d(this,1)">取消</a></div>');
		var j=0,imax=Host_all_arr.length;
		var j_old=0;
		var j_all_num=0;
		var _runOut;
		var _run_a = function(){
			_runOut = setTimeout(function(){
				clearTimeout(_runOut);
				var ajax_num=0;
				var ajax_for_num=3;
				for(var j_item=0;j_item<ajax_for_num;j_item++){
					var save_jsondata=JSON.parse(JSON.stringify(save_json));
					save_jsondata.HostSet=new Array();
					save_jsondata.HGroupSet=new Array();
					var j_num=0;
					for(;j<imax;j++){
						if(j<(j_old+50)){
							j_num++;
							save_jsondata.HostSet.push({"HostId":Host_all_arr[j].HostId,"HostName":Host_all_arr[j].HostName});
						}else{
							j_old=j;
							break;
						}
					}
					if(save_jsondata.HostSet.length==0){
						break;
					}
					function SaveHostAccount(save_jsondata,j_num){
						var msstr = aceg(JSON.stringify(save_jsondata),se);
						$.ajax({
							url:'/bhost/delete_account_z',
							type:'post',
							async:true,
							data:{a0:se,a1:JSON.stringify(save_jsondata),m1:msstr},
							success:function(result){
								var results = JSON.parse(result);
								if (results.Result){
									ajax_num++;
									SuccCount+=results.SuccCount;
									FailCount+=results.FailCount;
									j_all_num+=j_num;
									if(j_all_num<imax){
										var j_m=Math.round((j_all_num*100)/imax);
										$('#loadPer').width(j_m+'%');
										$('#loadPerText').text(j_m+"%");
										if(_getLoadBar_a_state==1 && ajax_num==ajax_for_num) _run_a();
									}else{
										$('#loadPer').width('100%');
										$('#loadPerText').text("100%");
										_close_a_d(this,0);
									}
								}else{
									ajax_num++;
									j=j-j_num;
									j_old=j;
									if(_getLoadBar_a_state==1 && ajax_num==ajax_for_num) _run_a();
								}
							},
							error:function(){
								ajax_num++;
								j=j-j_num;
								j_old=j;
								if(_getLoadBar_a_state==1 && ajax_num==ajax_for_num) _run_a();
							}
						})
					}
					SaveHostAccount(save_jsondata,j_num);
				}
			},100);
		}
		_run_a();
	}
	loadBarLayer = layer.open({
		title:false,
		closeBtn:false,
		content:'<div class="lodabar-w" id="loadBarWrap">加载中...</div>',
		btn:false,
		skin:'loadbar',
		area:['430px','400px'],
		move:false,
		success:function(i){
			_loadBar();
		}
	})
}
//账号添加or编辑浮层
function account_Dialog(type,obj){
	if ($("#hostTree_z").find('span.checkbox.half,span.checkbox.checked').length == 0){
		_alert(2,"添加账号","请选择主机");
		return false;
	}
	$("#FromAccount_acc").select2();
	clear_account();
	bind_SSHkey_xSelect();
	$('#SSHkey_s').data('value',-1);
	bind_Acc_xSelect();
	//get_account();
	$("#AccountName").change(function(){
		var t = $(this).children().find('span').text();
		// if( t == "*"){
		// 	$("#password1").prop("disabled",true);
		// 	$("#password2").prop("disabled",true);
		// 	$("#password1").val("");
		// 	$("#password2").val("");			
		// 	$("#if_emptypwd").iCheck('uncheck');
		// 	$("#if_emptypwd").iCheck('disable');
		// }else{
		// 	$("#password1").prop("disabled",false);
		// 	$("#password2").prop("disabled",false);
		// 	$("#if_emptypwd").iCheck('uncheck');
		// 	$("#if_emptypwd").iCheck('enable');
		// }	
	});
	$("#if_emptypwd").unbind().on('ifChanged', function(event){
		var t = $(this).prop("checked");
		var a = $("#AccountName").children().find('span').text();
		//if(a == "*"){
			/*$("#password1").prop("disabled",true);
			$("#password2").prop("disabled",true);
			$("#password1").val("");
			$("#password2").val("");
			$("#if_emptypwd").iCheck('uncheck');
			$("#if_emptypwd").iCheck('disable');*/
		//}else{
			if( t == true){
				$("#password1").val("");
				$("#password2").val("");
				$("#password1").prop("disabled",true);
				$("#password2").prop("disabled",true);
			}else{
				$("#password1").prop("disabled",false);
				$("#password2").prop("disabled",false);
			}
		//}
	});
	if ($("#mix_select_zdp").val() == 2){
		get_same_aorp();
	}else{
		get_all_aors();
	}
	var ser_name;
	$("#server_list").empty();
	$.each(apdata.ServiceSet,function(i,item){
		/*if (item.ConnParamName != null){
			ser_name = item.ProtocolName+ ':' + item.Port + ':' + item.ConnParamName;
		}else{
			ser_name = item.ProtocolName+ ':' + item.Port;
		}*/
		ser_name = item.ProtocolName+ ':' + item.Port;
		// var ser_id = item.ProtocolId + '-' + item.Port + '-' + item.ConnParamId;
		var ser_id = item.ProtocolId + '-' + item.Port;
		if($("#server_list #"+ser_id).length>0){
			$("#server_list #"+ser_id).attr('paramid',$("#server_list #"+ser_id).attr('paramid')+';'+item.ConnParamId);
		}else{
			$("#server_list").append("<div class=\"as\" style=\"width:228px;\"><label><input type=\"checkbox\" id=\"" + ser_id + "\" proid=\""+item.ProtocolId+"\" proto=\""+item.ProtocolName+"\" port=\""+item.Port+"\" paramid=\""+item.ConnParamId+"\" param=\""+item.ConnParamName+"\" value=\"" + item.HostServiceName + "\" name=\"" + item.HostServiceName + "\" class=\"form-checkbox\" >" + ser_name + "</label></div>");
		}
		
	});
	$('#server_list').children().find('input[type=checkbox]').unbind().on('ifChecked', function(event){
		get_fromacc();
		_checkServerStatus();
	}).on('ifUnchecked', function(event){
		get_fromacc();
		_checkServerStatus();
	});
	$("#server_list").find('input').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	})
	var $dialogCont = $("#scDCTab2").show();
	if(type == 'edit'){
		title = '编辑账号';
	}else{
		title = '添加账号';
	}
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"scDCTab2",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$('#add_account_z').removeClass('active');
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();

	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		clear_account();
		//d.close().remove();
		//$('#add_account_z').removeClass('active');
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if(_add_Acount(type) == false) return false;
		d.close().remove();
		$('#add_account_z').removeClass('active');
	});
}

function _add_Acount(type){
	var save_json = {
		"LoginUserCode":"",
		"HostSet": [],
		"HGroupSet": [],
		"AccountSet": [
			{
				"Password": null,                
				"PasswordType": 1, 	//0 '' 1 输入 2 null 
				"HostServiceSet": [],
				"SshKeyId": null,	
				"HostAccount": {				        
					"AccountId": 4,
					"IsSuperAcct": true,
					"IsSameUser": true,
					//"FromAccountId": 8,
					"AcctSwitchCmd": null, 
					"SwitchPasswdPrompt": null,
					"AccountName":""
				}
			}
		]
	}
	if ($("#server_list input:checked").length == 0){
		_alert(2,"批量账号","请选择服务");
		return false;
	}

	var AccountId = $("#AccountName").data('value');
	var AccountName = $("#AccountName").find('span').text();
	if (AccountId == undefined || AccountId == 0){
		_alert(2,"添加账号","请选择账号");
		return false;
	}
	var close_flag = 0;
	$("#server_list input").each(function(){
		if($(this).attr('proid') == "null"){
			_alert(2,"添加账号","存在未指定协议的服务");
			close_flag = 1;
			return false;
		}
	});
	if(close_flag == 1){
		return false;
	}
	$("#server_list input:checked").each(function(){
		var all_id = $(this).attr('id').split('-');
		pro_id = all_id[0];
		port = all_id[1];
		var con_id_arr=$(this).attr('paramid').split(';');
		$.each(con_id_arr,function(con_i,con_item){
			ser_set ='{"ProtocolId":'+pro_id+',"Port": '+port+',"ConnParamId": '+con_item+'}';
			save_json.AccountSet[0].HostServiceSet.push(JSON.parse(ser_set));
		});
		
	});

	save_json.LoginUserCode = window.parent.document.frm.us.value;
	save_json.HostSet = host_json.HostSet;
	save_json.HGroupSet = host_json.HGroupSet;
	var password1 = $("#password1").val();
	var password2=$('#password2').val();
	if($('#authType').val()=='0'){
		if($('#if_emptypwd').is(':checked')){
			save_json.AccountSet[0].PasswordType=2
		}else{
			if(password1.length > 64){
				_alert(2, "添加账号", "密码不能超过系统限定64位", $("#password1"));
				return false;
			}
			if (password1 != ""){
				if(password1!=password2){
					_alert(2,"添加账号","两次密码不匹配",$("#password1"));
					return false;
				}
				save_json.AccountSet[0].Password = password1;
				save_json.AccountSet[0].PasswordType=1
			}else{
				save_json.AccountSet[0].Password = null;
				save_json.AccountSet[0].PasswordType=0
			}
		}
	}else{
		save_json.AccountSet[0].PasswordType=3
		var SSHkey_s_value=$('#SSHkey_s').data('value');
		if(SSHkey_s_value==undefined || SSHkey_s_value<=0){
			// _alert(2,"添加账号","请选择密钥");
			// return false;
			SSHkey_s_value=null;
		}
		else{
			save_json.AccountSet[0].SshKeyId=SSHkey_s_value;
		}
	}
	
	save_json.AccountSet[0].HostAccount.AccountId = AccountId;
	save_json.AccountSet[0].HostAccount.AccountName = AccountName;
	
	var FromAccount_acc_id = $("#FromAccount_acc").val();
	if (FromAccount_acc_id == undefined || FromAccount_acc_id == "" || FromAccount_acc_id == 0){
		FromAccount_acc_id = null;
	}
	
	save_json.AccountSet[0].HostAccount.FromAccountId = FromAccount_acc_id;
	
	if ($("#IsSuperAcct").prop('checked')){
		save_json.AccountSet[0].HostAccount.IsSuperAcct = true;
	}else{
		save_json.AccountSet[0].HostAccount.IsSuperAcct = false;
	}
	if ($("#IsSameUser").prop('checked')){
		save_json.AccountSet[0].HostAccount.IsSameUser = true;
	}else{
		save_json.AccountSet[0].HostAccount.IsSameUser = false;
	}
	var AcctSwitchCmd_account = $("#AcctSwitchCmd_account").val();
	if (AcctSwitchCmd_account != ""){
		save_json.AccountSet[0].HostAccount.AcctSwitchCmd = AcctSwitchCmd_account;
	}else{
		save_json.AccountSet[0].HostAccount.AcctSwitchCmd = null;
	}
	var SwitchPasswdPrompt_account = $("#SwitchPasswdPrompt_account").val();
	if (SwitchPasswdPrompt_account != ""){
		save_json.AccountSet[0].HostAccount.SwitchPasswdPrompt = SwitchPasswdPrompt_account;
	}else{
		save_json.AccountSet[0].HostAccount.SwitchPasswdPrompt = null;
	}
	if(!$('#IsSameUser').prop('checked')){
		var HostServiceSet_arr=JSON.parse(JSON.stringify(save_json.AccountSet[0].HostServiceSet));
		var AccountSet=JSON.parse(JSON.stringify(save_json.AccountSet[0]));
		save_json.AccountSet=new Array();
		var pr_po_arr=[];
		// '{"ProtocolId":'+pro_id+',"Port": '+port+',"ConnParamId": '+con_item+'}';
		$(HostServiceSet_arr).each(function(i,item){
			var pr_po_arr_index=$.inArray(item.ProtocolId+'-'+item.Port,pr_po_arr);
			if(pr_po_arr_index<0){
				AccountSet.HostServiceSet=new Array();
				AccountSet.HostServiceSet.push(item);
				save_json.AccountSet.push(JSON.parse(JSON.stringify(AccountSet)));
				pr_po_arr.push(item.ProtocolId+'-'+item.Port);
			}else{
				save_json.AccountSet[pr_po_arr_index].HostServiceSet.push(item);
			}
		});
	}
	var Host_all_arr=new Array();
	$.each(save_json.HostSet,function(i,item){
		if($.inArray(item.HostId,Host_all_arr)<0){
			Host_all_arr.push(item.HostId);
		}
	});
	$.each(save_json.HGroupSet,function(i,item){
		$.ajax({
			url:'/bhost/PGetHostList_m',
			type:'post',
			async:false,
			data:{a0:se,a1:JSON.stringify(item.HGId)},
			success:function(result){
				
				var results = JSON.parse(result);
				if (results.Result){
					$.each(results.info,function(i1,item1){
						if($.inArray(item1.HostId,Host_all_arr)<0){
							Host_all_arr.push(item1.HostId);
						}
					});
				}else{
					_alert(1,"批量账号",results.info);
					return false;
				}
			}
		});
	});
	_getLoadBar_a(Host_all_arr,save_json);
	/*
	msstr = aceg(JSON.stringify(save_json),se);
	$.ajax({
		url:'/bhost/load_account_z',
		type:'post',
		async:false,
		data:{a0:se,a1:JSON.stringify(save_json),m1:msstr},
		success:function(result){
			var results = JSON.parse(result);
			if (results.Result){
				_alert(0,"批量账号","成功数："+results.SuccCount+",失败数："+results.FailCount);
				$("#check_one_page_zdp").iCheck('uncheck');
				account_list_show();
				return false;
			}else{
				_alert(1,"批量账号",results.ErrMsg);
				return false;
			}
		}
	})
	*/
}
function _close_a(obj,type){
	if(type==1){
		parent.layer.open({
			type:1,
			title: '批量账号',
			content: '<div class="layer-alert"><i class="alert warning"></i>是否取消</div>',
			btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			yes:function(i){
				parent.layer.close(i);
				_getLoadBar_a_state=0;
				layer.close(loadBarLayer);
				_alert(0,"批量账号","成功数："+SuccCount+",失败数："+FailCount);
				$("#check_one_page_zdp").iCheck('uncheck');
				account_list_show();
			},
			no:function(i){
				parent.layer.close(i);
			}
		});
	}else{
		layer.close(loadBarLayer);
		_alert(0,"批量账号","成功数："+SuccCount+",失败数："+FailCount);
		$("#check_one_page_zdp").iCheck('uncheck');
		account_list_show();
	}
	
}
var SuccCount = 0,FailCount=0;
var _getLoadBar_a_state=1;
function _getLoadBar_a(Host_all_arr,save_json){ //prog 为当前任务进度
	SuccCount = 0;
	FailCount=0;
	_getLoadBar_a_state=1;
	var _loadBar = function(){
		$('#loadBarWrap').html('<div class="loadperw"><span id="loadPer"></span></div><span id="loadPerText">0%</span><div class="loadberBtn"><a id="loadberBtn0" style="display:block" href="javascript:;" onclick="_close_a(this,1)">取消</a></div>');
		var j=0,imax=Host_all_arr.length;
		var j_old=0;
		var j_all_num=0;
		var _runOut;
		var _run_a = function(){
			_runOut = setTimeout(function(){
				clearTimeout(_runOut);
				var ajax_num=0;
				var ajax_for_num=3;
				for(var j_item=0;j_item<ajax_for_num;j_item++){
					var save_jsondata=JSON.parse(JSON.stringify(save_json));
					save_jsondata.HostSet=new Array();
					save_jsondata.HGroupSet=new Array();
					var j_num=0;
					for(;j<imax;j++){
						if(j<(j_old+50)){
							j_num++;
							save_jsondata.HostSet.push({"HostId":Host_all_arr[j]});
						}else{
							j_old=j;
							break;
						}
					}
					if(save_jsondata.HostSet.length==0){
						break;
					}
					function SaveHostAccount(save_jsondata,j_num){
						var msstr = aceg(JSON.stringify(save_jsondata),se);
						$.ajax({
							url:'/bhost/load_account_z',
							type:'post',
							async:true,
							data:{a0:se,a1:JSON.stringify(save_jsondata),m1:msstr},
							success:function(result){
								var results = JSON.parse(result);
								if (results.Result){
									ajax_num++;
									SuccCount+=results.SuccCount;
									FailCount+=results.FailCount;
									j_all_num+=j_num;
									if(j_all_num<imax){
										var j_m=Math.round((j_all_num*100)/imax);
										$('#loadPer').width(j_m+'%');
										$('#loadPerText').text(j_m+"%");
										if(_getLoadBar_a_state==1 && ajax_num==ajax_for_num) _run_a();
									}else{
										$('#loadPer').width('100%');
										$('#loadPerText').text("100%");
										_close_a(this,0);
									}
								}else{
									ajax_num++;
									j=j-j_num;
									j_old=j;
									if(_getLoadBar_a_state==1 && ajax_num==ajax_for_num) _run_a();
								}
							},
							error:function(){
								ajax_num++;
								j=j-j_num;
								j_old=j;
								if(_getLoadBar_a_state==1 && ajax_num==ajax_for_num) _run_a();
							}

						})
					}
					SaveHostAccount(save_jsondata,j_num);
				}
			},100);
		}
		_run_a();
	}
	loadBarLayer = layer.open({
		title:false,
		closeBtn:false,
		content:'<div class="lodabar-w" id="loadBarWrap">加载中...</div>',
		btn:false,
		skin:'loadbar',
		area:['430px','400px'],
		move:false,
		success:function(i){
			_loadBar();
		}
	})
}

/*
var save_json = {
	"HostSet": [],
	"HGroupSet": [],
	"AccountSet": [
		{
			"Password": "123456",                
			"PasswordType": 1, 	
			"HostServiceSet": [],
			"HostAccount": {				        
				"AccountId": 4,
				"IsSuperAcct": true,
				//"FromAccountId": 8,
				"AcctSwitchCmd": null, 
				"SwitchPasswdPrompt": null            
			}
		}
	]
}
*/
var a_data;
//获取账号
function get_account(){
	$.ajax({
		url:'/bhost/select_account_all',
		type:'post',
		async:true,
		data:{a0:se,z11:-1},
		success:function(result){
			a_data = JSON.parse(result);
			$("#FromAccount_acc").empty();
			//$("#AccountName").append('<option value="-1">请选择</option>');
			$("#FromAccount_acc").append('<option value="0">请选择</option>');
			account_list = a_data.data;
			$.each(a_data.data,function(i,item){
				if(item.AccountType == 0){
					item.AccountName = "*";
				}else if(item.AccountType == 2){
					item.AccountName = "-";
				}
				//$("#AccountName").append('<option value="'+item.AccountId+'">'+item.AccountName+'</option>');
				$("#FromAccount_acc").append('<option value="'+item.AccountId+'">'+item.AccountName+'</option>');
			});
		}
	});
	//$('#AccountName,#FromAccount_acc').select2({minimumResultsForSearch: -1});
}

//批量账号根目录
function _viewHTML_account(data,obj){
	$.each(data.data.HGroup,function(i,item){
		var $H = $('<li></li>');
		if (item.MemberNum + item.HostNum == 0){
			$H.html('<i class="h-blank" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" id="nodehg-'+item.HGId+'" data-mode="2" data-name="'+item.HGName+'" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + item.HGName.split('').map(function (params) {
					    return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+'</span><ul style="display:none">Loading...</ul>');
		}else{
			$H.html('<i class="h-aicon" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" id="nodehg-'+item.HGId+'" data-mode="2" data-name="'+item.HGName+'" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + item.HGName.split('').map(function (params) {
					    return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+'</span><ul style="display:none">Loading...</ul>');
		}
		$(obj).append($H);
	});
	_checkView_account(obj);
	
}

//加载树
function _initList_service() {
	_viewHTML_service('#userTree');
}

//批量账号加载下拉树
function _initHTML_account(obj,id,v,d){
	if(filter_flag_append_a == true) filter_flag_append_a=false;
	else _showLoading();
	flag_loading_a = true;
	var hdata;
	$(obj).empty();
	$.ajax({
		url:'/bhost/get_hostdirectory_pwd',
		type:'post',
		async:true,
		cache:false,
		data:{a0:se,z1:id,z2:ajax_find_host_doing?'true':'false'},
		success:function(result){
			hdata = JSON.parse(result);
			disabled_flag_a = "";
			var loadfirst = 0;
			var loadlast = 0;
			var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
			var _p_loadfirst = $(obj).siblings('input').attr('data-loadfirst');
			var _p_loadlast = $(obj).siblings('input').attr('data-loadlast');
			var auth_type_checked = false;
			
			if ($(obj).siblings('span.authtype').find('input').length != 0){
				auth_type_checked = $(obj).siblings('span.authtype').find('input').prop('checked');
			}
			if (_p_loadfirst == _p_loadlast){ 
				if (_p_loadlast == 2){
					loadfirst = 2
					loadlast = 2;
				}
			}else{
				if (_p_loadlast == 2){
					loadlast = 2;
				}
				if (_p_loadfirst == 2){
					loadfirst = 2;
				}
				
			}
			if(hdata.data.HGroup == null) hdata.data.HGroup = [];
			$.each(hdata.data.HGroup,function(i,item){
				if((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
				else i_class = "h-aicon";
				var $H = $('<li></li>');
				//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
				//data-loadlast(最后保存的状态) 
				if(v==1 && d == 0){
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" checked="checked" id="nodehg-'+item.HGId+'" data-check="1" class="zcheck zcheck-g" '+disabled_flag_a+' data-mode="2" data-name="'+item.HGName+'" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
                            item.HGName.split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') + 
                            '</span>'+'</span><ul style="display:none">Loading...</ul>');
				}else if(v==1){ //v == 1 d ==1
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" checked="checked" id="nodehg-'+item.HGId+'" data-check="1" class="zcheck zcheck-g" data-name="'+item.HGName+'" data-mode="2" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' ><i class="h-eicon h-eicon-g" id="spanHG-' + item.HGId + '" style="width: 12em;"></i><span class="h-name">'+'<span class="h-name-son" style="">' + 
                            item.HGName.split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') + 
                            '</span>'+'</span><ul style="display:none">Loading...</ul>');
				}else if(v==0){
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" id="nodehg-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" data-mode="2" data-name="'+item.HGName+'" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
                            item.HGName.split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') + 
                            '</span>'+'</span><ul style="display:none">Loading...</ul>');
				}else{
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" id="nodehg-'+item.HGId+'" data-mode="2" data-name="'+item.HGName+'" data-check="0" class="zcheck zcheck-g" '+disabled_flag_a+' data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
                            item.HGName.split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') + 
                            '</span>'+'</span><ul style="display:none">Loading...</ul>');
					
				}
				$(obj).append($H);
			})
			_checkView_account(obj);
			if(hdata.data.Host == null) {
				hdata.data.Host = [];
				flag_loading_a = false;
				_closeLoading();
				return false;
			}
			var i = 0;
			index = 0;
			
			$.each(hdata.data.Host,function (i,item) {
				if(item.Selected==0 && item.Mode==0){
					return true;
				}
				/*
				if(hdata.data.Host[i].Selected==0 && hdata.data.Host[i].Mode==0 && ajax_find_host_doing==true){
					return true;
				}
				*/
				if(ajax_find_host_doing==true && $(obj).siblings('span.h-name-red').length==0){
					var $H = $('<li style="display: none;"></li>');
				}else{
					var $H = $('<li></li>');
				}
				/*
				if(hdata.data.Host[i].Mode == 2){
					var $H = $('<li></li>');
				}else{
					var $H = $('<li style="display:none;"></li>');
				}
				*/
				i_class = "h-blank";
				//var HostName_h = autoAddEllipsis(hdata.data.Host[i].HostName,'12');
				var HostName_h = hdata.data.Host[i].HostName;
				if(v==1 && d == 0){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" checked="checked" data-mode="'+hdata.data.Host[i].Mode+'" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+'  data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'" disabled ><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
                            (HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span><ul style="display:none">Loading...</ul>');
					
				}else if(v==1){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" checked="checked" data-mode="'+hdata.data.Host[i].Mode+'" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+'><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
                            (HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span><ul style="display:none">Loading...</ul>');
				}else if(v==0){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" data-mode="'+hdata.data.Host[i].Mode+'" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'" ><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
                            (HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span><ul style="display:none">Loading...</ul>');
				}else{
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" data-mode="'+hdata.data.Host[i].Mode+'" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'" data-loadfirst=0 data-loadlast='+loadlast+' '+disabled_flag+' ><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
                            (HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span><ul style="display:none">Loading...</ul>');
				}

				$(obj).append($H);
				_checkView1($('#nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId));		
			});
			_closeLoading();
			var _ajax_find_host_doing=ajax_find_host_doing;
			flag_loading_a = false;
		}
	});
}

//加载下拉树
function _initHTML_service(obj, id, v, d) {
	//过滤中 不需要 showloading
	if(filter_flag_append == true) filter_flag_append=false;
	else _showLoading();			
	flag_loading = true;
	var loading_hgid;
	$.ajax({
		url: '/bhost/get_hostdirectory',
		type:'post',
		async:true,
		data: { a0: $("input[name=se]").val(), a2: id, a5: '0', a6: 0 },
		success:function(result){
			hdata = JSON.parse(result).info.data;
			loading_hgid = id;
			disabled_flag = "";
			var loadfirst = 0;
			var loadlast = 0;
			var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
			var _p_loadfirst = $(obj).siblings('input').attr('data-loadfirst');
			var _p_loadlast = $(obj).siblings('input').attr('data-loadlast');
			var auth_type_checked = false;
			if ($(obj).siblings('span.authtype').find('input').length != 0) {
				auth_type_checked = $(obj).siblings('span.authtype').find('input').prop('checked');
			}
			if ((_p_loadfirst == 0) && (_p_loadlast == 0)) {
			}
			if (auth_type_checked) {
				disabled_flag = "";
			}
			if (_p_loadfirst == _p_loadlast) {
				if (_p_loadlast == 2) {
					loadfirst = 2
					loadlast = 2;
				}
			} else {
				if (_p_loadlast == 2) {
					loadlast = 2;
				}
				if (_p_loadfirst == 2) {
					loadfirst = 2;
				}

			}
			if(hdata.HGroup == null) hdata.HGroup = [];
			$(obj).empty();
			$.each(hdata.HGroup,function(i,item){
				// var $H = $('<li></li>');
				if (ajax_find_host_doing_s == true && $(obj).siblings('span.h-name-red').length == 0) {
					var $H = $('<li style="display: none;"></li>');
				} else {
					var $H = $('<li></li>');
				}
				if((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
				else i_class = "h-aicon";
				if(v==1 && d == 0){
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
					'<input type="checkbox" checked="checked" id="HGId-'+item.HGId+'" data-check="1" class="zcheck zcheck-g"  data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="2" data-name="' + item.HGName + '" >'+
					'<i class="h-eicon h-eicon-g"></i>'+
					'<span class="h-name" id="spanSHG-' + item.HGId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						item.HGName.split('').map(function (params) {
							return '<font>'+params+'</font>'    
						}).join('') + 
						'</span>'+
						'</span>'+
					'<ul style="display:none">Loading...</ul>');
				}else if(v==1){ //v == 1 d ==1
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
					'<input type="checkbox" checked="checked" id="HGId-'+item.HGId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="2" data-name="' + item.HGName + '" >'+
					'<i class="h-eicon h-eicon-g"></i>'+
					'<span class="h-name" id="spanSHG-' + item.HGId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						item.HGName.split('').map(function (params) {
							return '<font>'+params+'</font>'    
						}).join('') + 
					'</span>'+
					'</span>'+
					'<ul style="display:none">Loading...</ul>');
				}else if(v==0){
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
					'<input type="checkbox" id="HGId-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="2" data-name="' + item.HGName + '" >'+
					'<i class="h-eicon h-eicon-g"></i>'+
					'<span class="h-name" id="spanSHG-' + item.HGId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						item.HGName.split('').map(function (params) {
							return '<font>'+params+'</font>'    
						}).join('') + 
						'</span>'+
						'</span>'+
						'<ul style="display:none">Loading...</ul>');
				}else{
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
					'<input type="checkbox" id="HGId-'+item.HGId+'" data-check="0" class="zcheck zcheck-g"  data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="2" data-name="' + item.HGName + '" >'+
					'<i class="h-eicon h-eicon-g"></i>'+
					'<span class="h-name" id="spanSHG-' + item.HGId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						item.HGName.split('').map(function (params) {
							return '<font>'+params+'</font>'    
						}).join('') + 
					'</span>'+
					'</span>'+
					'<ul style="display:none">Loading...</ul>');
				}
				$(obj).append($H);
				setTimeout(_jScrollBar, 1000,'spanSHG-' + item.HGId);
			})
			_checkView_service(obj);	
			if(hdata.Host == null) {
				hdata.Host = [];
				flag_loading = false;
				_closeLoading();
				return false;
			}
			var i = 0;
			index = 0;
			html_str = "";
			i_class = "h-blank";
			$.each(hdata.Host, function (i, item) {
				if (item.Selected == 0 && item.Mode == 0) {
					return true;
				}
				if (ajax_find_host_doing_s == true && $(obj).siblings('span.h-name-red').length == 0) {
					var $H = $('<li style="display: none;"></li>');
				} else {
					var $H = $('<li></li>');
				}
				if(v==1 && d == 0){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+item.HostId+'" />'+
					'<input type="checkbox" checked="checked" id="HostId-'+parent_id+'-'+item.HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+'  disabled data-ifselect=false data-mode="' + item.Mode + '" data-name="' + item.HostName + '\t' + item.HostIP + '">'+
					'<i class="h-eicon h-eicon-u"></i>'+
					'<span class="h-name" id="spanSHG-' + parent_id+'-'+item.HostId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						(item.HostName+'('+item.HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
						'</span>'+
						'</span>'+
						'<ul style="display:none">Loading...</ul>');
				}else if(v==1){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+item.HostId+'" />'+
					'<input type="checkbox" checked="checked" id="HostId-'+parent_id+'-'+item.HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="' + item.Mode + '" data-name="' + item.HostName + '\t' + item.HostIP + '">'+
					'<i class="h-eicon h-eicon-u"></i>'+
					'<span class="h-name" id="spanSHG-' + parent_id+'-'+item.HostId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						(item.HostName+'('+item.HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
						'</span>'+
						'</span>'+
						'<ul style="display:none">Loading...</ul>');
				}else if(v==0){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+item.HostId+'" />'+
					'<input type="checkbox" id="HostId-'+parent_id+'-'+item.HostId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="' + item.Mode + '" data-name="' + item.HostName + '\t' + item.HostIP + '">'+
					'<i class="h-eicon h-eicon-u"></i>'+
					'<span class="h-name" id="spanSHG-' + parent_id+'-'+item.HostId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						(item.HostName+'('+item.HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
						'</span>'+
						'</span>'+
						'<ul style="display:none">Loading...</ul>');
				}else{
					$H.html('<i class="'+i_class+'" data-id="arrH-'+item.HostId+'" />'+
					'<input type="checkbox" id="HostId-'+parent_id+'-'+item.HostId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst=0 data-loadlast='+loadlast+' data-ifselect=false data-mode="' + item.Mode + '" data-name="' + item.HostName + '\t' + item.HostIP + '" >'+
					'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
					'<span class="h-name" id="spanSHG-' + parent_id+'-'+item.HostId + '" style="width: 12em;">'+
							'<span class="h-name-son" style="">' + 
						(item.HostName+'('+item.HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
						'</span>'+
						'</span>'+
						'<ul style="display:none">Loading...</ul>');
				}
				$(obj).append($H);
				setTimeout(_jScrollBar,1000,'spanSHG-' + parent_id+'-'+item.HostId);
				_checkView1($('#HostId-' + parent_id + '-' + item.HostId));
			});
			_closeLoading();
			flag_loading = false;
		}
	});
	return true;
	
}

function red_to_font_a(obj){
	var span_obj=$(obj).siblings('span.h-name');
	var item_name=span_obj.siblings('input').attr('data-name');
	var Type = span_obj.siblings('input').attr('id');
	var $span_son_font=$('.h-name-son',span_obj).find('font');
	
	if(Type.indexOf('nodeh')<0){
		var span_son_name=item_name.toLowerCase();
	}else{
		var host_span_arr=item_name.split('\t');
		var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
	}
	
	for(var jm=0;jm<find_host_arry.length;jm++){
		var jm_index_ = find_host_arry[jm].indexOf('-');
		var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
		$.each(search_arr,function(i1,item1){
			if(item1==''){
				return true;
			}
			if (find_host_arry[jm].substr(0, jm_index_) == '组名'){
				Name = item_name;
				if(Type.indexOf('nodehg')<0){
					return true;
				}
			}else if (find_host_arry[jm].substr(0, jm_index_) == '主机名') {
				Name = item_name.split('\t')[0];
				if(Type.indexOf('nodeh')<0 || Type.indexOf('nodehg')>=0){
					return true;
				}
				/*
				if(Type.indexOf('nodeh')<0){
					return false;
				}
				*/
			} else if (find_host_arry[jm].substr(0, jm_index_) == 'IP'){
				Name = item_name.split('\t')[1];
				if(Type.indexOf('nodeh')<0 || Type.indexOf('nodehg')>=0){
					return true;
				}
				/*
				if(Type.indexOf('nodeh')<0){
					return false;
				}
				*/
			}else if (find_host_arry[jm].substr(0, jm_index_) == '账号'){
				Name = item_name;
				if(Type.indexOf('nodea')<0){
					return true;
				}
			}else{
				Name = item_name;
			}
			if(coverString(item1,Name)){
				item1=item1.toLowerCase();
				if(find_host_arry[jm].substr(0, jm_index_) == 'IP'){
					var index_start=span_son_name.indexOf('(');
					var index_true=span_son_name.indexOf(item1,index_start);
					if(index_true>=0){
						for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
							$span_son_font.eq(i_red_span).addClass('font-red');
						}
					}
				}else{
					var index_true=span_son_name.indexOf(item1);
					if(index_true>=0){
						for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
							$span_son_font.eq(i_red_span).addClass('font-red');
						}
					}
				}
			}
		});
	}
}

function _checkView1(obj){
	_authTypeTheme($(obj).parent().find('span.authtype input'));
	$(obj).each(function(){
		var $s = $('<span class="checkbox"></span>');
		$(this).after($s);
		var v = $(this).prop('checked');
		if(v){
			$s.addClass('checked');
		}else{
			var c = $(this).data('check');
			if(c && c==2){
				$s.addClass('half');
			}
		}

		var d = $(this).prop('disabled');
		if(d){
			$s.addClass('disabled');
		}
		var span_id = $(this).siblings('span.h-name').attr('id');
		setTimeout(function () {
			if (_jScrollBar_array.indexOf(span_id) === -1){
				_jScrollBar_array.push(span_id);
				_jScrollBar(span_id);
			}
		},1000);
	}).on('change',function(){
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul');
		var d;
		if($(this).siblings('span.authtype').find('input').is(':checked')){
			d = 0;
		}else{
			d = 1;
		}
	
		if(v){
			$s.attr('class','checkbox checked');
			$('input.zcheck',$u).prop('checked',true);
			$('span.checkbox',$u).attr('class','checkbox checked');			
			$(this).attr("data-loadlast","2");	
			
		}else{
			$s.attr('class','checkbox');
	    	$('input.zcheck',$u).prop('checked',false).prop('disabled',false);
			$('span.checkbox',$u).attr('class','checkbox');
			$(this).siblings('span.authtype').find('input').prop('checked',false);
			$(this).siblings('span.authtype').find('span').attr('class','checkbox');
			$(this).siblings('span.authtype').find('span').trigger('change');
			//$u.find('span.authtype').find('input').iCheck('uncheck');	
			$(this).attr("data-loadlast","0");
		}
		_checkEvent(this);
		if($(this).parents('.hosttree').attr('id')!='userTree')
		{
			host_json={
				"LoginUserCode":"",
				"HostSet":[],
				"HGroupSet":[],
				"IPAddr":[],
				"ServerScopeSet":[]
			};
			host_json.LoginUserCode = window.parent.document.frm.us.value;
			save_host($('#hostTree_z'));
			account_list_show();
		}
	});
}

//回显下拉树
function _viewHTML_service(obj) {
	$.ajax({
		url: '/bhost/get_hostdirectory',
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(), a2: "0", a5: '0', a6: 0 },
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result) {
				var host_data = result.info;
				var total_all = host_data.totalrow;
				$(obj).empty();
				$.each(host_data.data.HGroup, function (i, item) {
					var $H = $('<li></li>');
					var $auth = '';
					var $H = $('<li></li>');
					if((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
					else i_class = "h-aicon";
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
					'<input type="checkbox" id="HGId-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst=0 data-loadlast=0 data-ifselect=false data-mode="2" data-name="' + item.HGName + '" >'+
					'<i class="h-eicon h-eicon-g" ></i>'+
					'<span class="h-name" id="spanSHG-' + item.HGId + '" style="width: 12em;">'+
						'<span class="h-name-son" style="">' + 
						item.HGName.split('').map(function (params) {
							return '<font>'+params+'</font>'    
						}).join('') + 
					'</span>'+
					'</span>'+
					'<ul style="display:none">Loading...</ul>');
					$(obj).append($H);
					setTimeout(_jScrollBar,1000,'spanSHG-' + item.HGId);
				});
				_checkView_service(obj);
			}
		}
	});
}

function _checkView_account(obj){
	_authTypeTheme($('span.authtype input',obj));
    $('input.zcheck',obj).each(function(){
    	var $s = $('<span class="checkbox"></span>');
    	$(this).after($s);
    	var v = $(this).prop('checked');
    	if(v){
    		$s.addClass('checked');
    	}else{
    		var c = $(this).data('check');
    		if(c && c==2){
    			$s.addClass('half');
    		}
    	}

    	var d = $(this).prop('disabled');
    	if(d){
    		$s.addClass('disabled');
    	}
		
		var span_id = $(this).siblings('span.h-name').attr('id');
		setTimeout(function () {
			if (_jScrollBar_array.indexOf(span_id) === -1){
				_jScrollBar_array.push(span_id);
				_jScrollBar(span_id);
			}
		},1000);
    }).on('change',function(){
    	var v = $(this).prop('checked');
    	var $s = $(this).next('span.checkbox');
    	var $u = $(this).parent().children('ul');
		var d;
		if($(this).siblings('span.authtype').find('input').is(':checked')){
    		d = 0;
    	}else{
    		d = 1;
    	}
		
    	if(v){
    		$s.attr('class','checkbox checked');
	    	$('input.zcheck',$u).prop('checked',true);
	    	$('span.checkbox',$u).attr('class','checkbox checked');
    	}else{
    		$s.attr('class','checkbox');
	    	$('input.zcheck',$u).prop('checked',false);
	    	$('span.checkbox',$u).attr('class','checkbox');
			$(this).parent().children('span.authtype').find('input').iCheck('uncheck');
			$u.find('span.authtype').find('input').iCheck('uncheck');	
    	}

    	if(d==0){
    		$('span.checkbox',$u).addClass('disabled');
    	}
		
    	_checkEvent(this);
		host_json={
			"LoginUserCode":"",
			"HostSet":[],
			"HGroupSet":[],
			"IPAddr":[],
			"ServerScopeSet":[]
		};
		host_json.LoginUserCode = window.parent.document.frm.us.value;
		save_host($('#hostTree_z'));
		account_list_show();
    });
}
//
function _authTypeTheme(obj){
	$.each(obj,function(i,item){
		var $_item = $(item);

		if($_item.parent().children('span').length == 0){
			$_item.after('<span class="checkbox"></span>');
		}

		var $s = $_item.next('span');
		var checked = $_item.prop('checked');
		var disabled = $_item.prop('disabled');

		if(checked){
			$s.addClass('checked');
		}else{
			$s.removeClass('checked');
		}

		if(disabled){
			$s.addClass('disabled');
		}else{
			$s.removeClass('disabled');
		}
	})
}
//选中回显
function _checkView_service(obj) {
	_authTypeTheme($('span.authtype input',obj));
	$('input.zcheck',obj).each(function(){
		var $s = $('<span class="checkbox"></span>');
		$(this).after($s);
		var v = $(this).prop('checked');
		if(v){
			$s.addClass('checked');
		}else{
			var c = $(this).data('check');
			if(c && c==2){
				$s.addClass('half');
			}
		}

		var d = $(this).prop('disabled');
		if(d){
			$s.addClass('disabled');
		}
	}).on('change',function(){
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul').find('li');
		var $authInput = $(this).siblings('span.authtype').find('input');

		if(v){
			$s.attr('class','checkbox checked');
			$('input.zcheck',$u).prop('checked',true);
			$('span.checkbox:first',$u).attr('class','checkbox checked');
			$(this).attr("data-loadlast",2);
			$('input.zcheck',$u).attr("data-loadlast",2);	
			$u.each(function(){
				if ($(this).children('span.authtype').find('input').prop('checked')){
					var $u_li = $(this).children('ul').find('li');
					$('input.zcheck',$u_li).prop('disabled',true);
					$('span.checkbox:first',$u_li).addClass('disabled');
				};
			});		
		}else{
			$s.attr('class','checkbox');
			$('input',$u).prop('checked',false).prop('disabled',false);
			$('span.checkbox',$u).attr('class','checkbox');
			$(this).attr("data-loadlast",0);
			$('input.zcheck',$u).attr("data-loadlast",0);

			$authInput.prop('checked',false).trigger('change');
			$(this).siblings('span.authtype').find('span').attr('class','checkbox');			
		}
		_checkEvent_service(this);
	});
}

//选中后树的input check变化
function _checkEvent_service(obj) {
	var _run = function(){
		var $li = $(obj).parent().parent().parent();
		var tagname = $li[0].tagName.toLowerCase();
		var v = $(obj).prop('checked');
		if(tagname == 'li'){
			var c1=0,c2=0;
			var len = $(obj).parent().parent().children('li').length;
			$(obj).parent().parent().children('li').each(function(){
				var c = $(this).children('span.checkbox').attr('class');
				if(c.indexOf('checked')>0){
					c1++;
				}else if(c.indexOf('half')>0){
					c2++;
				}

				if(c1 == len){
					$li.children('input.zcheck').prop('checked',true).siblings('span.checkbox').attr('class','checkbox checked');//.siblings('span.authtype').show();
					$li.children('input.zcheck').attr("data-loadlast",2);
				}else if(c1==0 && c2==0){
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox');//.siblings('span.authtype').hide();
					$li.children('input.zcheck').attr("data-loadlast",0);
				}else{
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox half');
					$li.children('input.zcheck').attr("data-loadlast",1);
				}
			});
			_checkEvent_service($li.children('input.zcheck'));
		}else{
			return;
		}
	}

	_run();
}

//树控件
$(function(){
	_initList();
	_initSize();
	$('#userTree').on('change','span.authtype input',function(){
		var checked = $(this).prop('checked');
		_authTypeTheme($(this));
		if(checked){
			var $input1 = $(this).parent().parent().siblings('ul').find('span.authtype input');
			var $input2 = $(this).parent().parent().siblings('ul').find('input.zcheck');
			var $input3 = $(this).parent().parent().siblings('input.zcheck');
			$input3.attr("data-loadlast",2);
			$input1.prop('disabled',true);
			_authTypeTheme($input1);
					$input2.prop('checked',true).prop('disabled',true);
			$(this).parent().parent().siblings('input.zcheck').prop('checked',true).next('span.checkbox').attr('class','checkbox checked');;
			$.each($input2,function(){
				$(this).next('span.checkbox').attr('class','checkbox checked disabled');
			});

			_checkEvent($(this).parent().parent().siblings('input.zcheck'));
		}else{
			var $input1 = $(this).parent().parent().siblings('ul').children('li').find('span.authtype').find('input');
			var $input2 = $(this).parent().parent().siblings('ul').children('li').find('input.zcheck');

			$input1.prop('disabled',false);
			_authTypeTheme($input1);
			_checkEvent1($(this));
		}
	}).on('click', 'i.h-aicon', function () {
		var $item = $(this);
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if ($u.is(':hidden')) {
			$item.addClass('h-aicon-d');
			$u.show();
			if ($u.children('li').length == 0) {
				var v = 2, d;
				var $input = $(this).siblings('span.checkbox');
				if ($(this).siblings('span.authtype').find('input').is(':checked')) {
					d = 0;
				} else {
					d = 1;
				}

				if ($input.attr('class').indexOf('disabled') > 0) {
					d = 0;
				}
				var c = $input.attr('class');
				if (c.indexOf('checked') > 0) {
					v = 1;
				} else if (c == 'checkbox') {
					v = 0;
				}
				_initHTML_service($u, id, v, d);
			}
		} else {
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	}).on('dblclick', 'i.h-eicon,span.h-name',function () {
		var i_class_arr = $(this).siblings('i.h-aicon');
		if (i_class_arr.length == 0) {
			return false;
		}
		var $item = $(i_class_arr);
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if ($u.is(':hidden')) {
			$item.addClass('h-aicon-d');
			$u.show();
			if ($u.children('li').length == 0) {
				var v = 2, d;
				var $input = $(this).siblings('span.checkbox');
				if ($(this).siblings('span.authtype').find('input').is(':checked')) {
					d = 0;
				} else {
					d = 1;
				}

				if ($input.attr('class').indexOf('disabled') > 0) {
					d = 0;
				}
				var c = $input.attr('class');
				if (c.indexOf('checked') > 0) {
					v = 1;
				} else if (c == 'checkbox') {
					v = 0;
				}
				_initHTML_service($u, id, v, d);
			}
		} else {
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	});
});
function _checkEvent1(obj){
	if($(obj).length == 0) return false;
	var _run1 = function(){
		_input = $(obj).parent().parent().siblings('input.zcheck');
		_ul = _input.siblings('ul');
		if(_input.length>0 && (_ul.children('li').length >0)){
			$inp = _ul.children('li').children('input.zcheck');
			$($inp).each(function(i,item){	
				$parent = $(item).parent().parent().siblings('span.authtype').find('input');
				v = $($parent).prop("checked");
				$spanp = $(item).siblings('span.authtype');
				//如果发现父节点还是disabled
				if($($parent).prop("disabled") == true) v = true;
				if(v == false){
					$(item).prop("disabled",false);
					$(item).siblings('span.checkbox').removeClass("disabled");
					$spanp.find('input').prop("disabled",false);
					$spanp.find('span').removeClass("disabled");
					if($spanp.length == 0) {
						_checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
					}
					else {
						if($(item).prop('checked') == false) $spanp.find('input').prop('checked',false).next('span').removeClass('checked');
						_checkEvent1($spanp.find('input'));
					}
				}else{
					$(item).prop("checked",true).prop("disabled",true);
					$(item).siblings('span.checkbox').addClass("disabled");
					$spanp.find('input').prop("disabled",true);
					$spanp.find('span').addClass("disabled");
					if($spanp.length == 0) _checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
					else _checkEvent1($spanp.find('input'));
					
				}
			})
				
			
		}else{
			
			return;
		}	
	}

	_run1();
}
function _checkEvent2(obj){
	if(obj.length == 0) return false;
	var _run2 = function(){
		_input = $(obj).parent().parent().siblings('input.zcheck');;
		if($(_input).prop('disabled') == true){
			$(obj).prop("checked",true).prop("disabled",true);
			$(obj).siblings('span.checkbox').addClass("disabled");
		}else{
			$(obj).prop("disabled",false);
			$(obj).siblings('span.checkbox').removeClass("disabled");
		}
		_checkEvent2($(obj).siblings('ul').children('li').children('input.zcheck'));
	}

	_run2();
}
$(window).resize(function(){
	_initSize();
        _pathWrap();
});
	/*
	loginusercode:登录用户账号
hgid:主机组ID，即取这个组下所有主机组和主机信息
{"totalrow":4,"data":{
    "HGroup": [
        {
            "HGId": 4,
            "HGName": "HGrp1",
            "MemberNum": 4
            "Mode":1   --0-无权限，1-只读权限，2-可写(复制、剪切、粘贴时要父组有可写权限)
        }
    ],
    "Host": [
        {
        	"HostId": 7,
            "HostName": "主机1",            
            "HostIP": "192.168.1.189",
            "DeviceTypeName": "Windows",
            "Mode":2  --同主机组，但主机只有1和2，如果无权限，就不显示
        }
    ]
}}
	*/
    //一级节点
    var firstData_grp = [
    ];
	var firstData_host = [
    ];
    //子节点
	/*
    var nodeData = [
        {id: 11,name: '主机组11',type: 0,hasNode: true,mark:'描述：text text<br>子主机：name ， name……'},
        {id: 12,name: '主机组12',type: 0,hasNode: true,mark:'描述：text text<br>子主机：name ， name……'},
        {id: 13,name: '主机组13',type: 0,hasNode: false,mark:'描述：text text<br>子主机：name ， name……'},
        {id: 14,name: '主机11',type: 1,mark:'姓名：name<br>部门：研发部<br>手机：13999999999<br>email：384351684@168.com<br>配置管理员：admin'}
    ]*/


    //list
function list_initList(){
    if (first_grp == '0') {
        return 0;
    }
	if($('.host_list_div table').height()>$('.host_list_div').height()){
		$('#host_list thead tr th:last').width(135);
	}else{
		$('#host_list thead tr th:last').width(125);
	}
	$('#host_list_ td.in .input_checkbox').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
	$('#host_list_').unbind();
	$('#host_list_ .input_checkbox').unbind();
	$('#host_list_all').unbind();
	tabArr_host_line();
	$('#host_list_ .input_checkbox').on("ifChecked",function(e){
		//console.log('ifChecked');
		$(this).parents('td.in').find('div.c').addClass('on');
		if($("#host_list_ tr input.input_checkbox:checked:enabled").length==$("#host_list_ tr input.input_checkbox:enabled").length){
			$('#host_list_all').iCheck('check');
		}
	}).on("ifUnchecked",function(e){
		//console.log('ifUnchecked');
		$(this).parents('td.in').find('div.c').removeClass('on');
		$('#host_list_all').iCheck('uncheck');	
	});
	$('#host_list_all').on('ifClicked',function(e){
		if(!$('#host_list_all').is(':checked')){
			$("#host_list_ tr input.input_checkbox:enabled").iCheck('check');
		}else{
			$("#host_list_ tr input.input_checkbox:enabled").iCheck('uncheck');
		}
		
	});
	//tabArr();
	$('#host_list_').on("click", "tr",
		function (e){
			x=e.target;
			switch(x.id){
				case '_edit':
					{
						current_id=$(this).find('div.c').attr('id');
						modify();
					}
					break;
				case '_copy':
					{
						$('#host_list_ tr div.c.on').removeClass('on');
						$(this).find('div.item div.c').addClass('on');
						copy();
						$('#host_list_ tr .input_checkbox:checked:enabled').parents('td.in').find('div.c').addClass('on');
					}
					break;
				case '_cut':
					{
						$('#host_list_ tr div.c.on').removeClass('on');
						$(this).find('div.item div.c').addClass('on');
						cut();
						$('#host_list_ tr .input_checkbox:checked:enabled').parents('td.in').find('div.c').addClass('on');
					}
					break;
				case '_del':
					{
						$('#host_list_ tr div.c.on').removeClass('on');
						$(this).find('div.item div.c').addClass('on');
						delete_node();
						$('#host_list_ tr .input_checkbox:checked:enabled').parents('td.in').find('div.c').addClass('on');
					}
					break;
				case '_remove':
					{
						$('#host_list_ tr div.c.on').removeClass('on');
						$(this).find('div.item div.c').addClass('on');
						move_node();
						$('#host_list_ tr .input_checkbox:checked:enabled').parents('td.in').find('div.c').addClass('on');
					}
					break;
			}
		}
	).on('dblclick','tr',
		function(e){
			x=e.target;
			if(x.nodeName !='A' && x.nodeName !='INS'){
				var tr_dbl_value=$(this).find('div.c').attr('id').split('-');
				var id = tr_dbl_value[1];
				var iid = tr_dbl_value[2];
				if(parent_id.indexOf('root')<0){
					if($('#'+parent_id).prev().attr("class").indexOf('h-aicon-d') <0){
						$('#'+parent_id).prev().click();
					}
				}
				$('#node-'+id +'-'+ iid).click();
				//$('#node-'+id).prev().trigger('click');
				if($(this).find('i.h-bicon-c').length==1){ //双击 主机  编辑
					current_id = $(this).find('div.c').attr('id');
					modify();
				}
			}
		}
	);
}

function tabArr_host_line(){
	$('div.tab-moreinfo-on').remove();
        $('#host_list_').parent('table').unbind();
        var tout,tin;
        var $cloneItem;
        var z = false;

        $('#host_list_').parent('table').on('mouseover','tbody>tr',function(){
                document.onclick = null;
        }).on('mouseout','tbody>tr',function(){
                document.onclick = function(){
                        $('div.tab-moreinfo-on').hide();
                        $('tr.on').removeClass('on');
                }
        }).on('click','tbody>tr',function(e){

                x=e.target;
                if(x.id=='del'){
                        return false;
                }
                if(x.id=='edit'){
                        return false;
                }
                if (x.localName=='a'){
                        return false;
                }
                document.onclick = null;

                var $this = $(this);
                        var $tr = $this;
                        var oset = $tr.offset();

                        var trc = $tr.attr('class');
                        if(trc && trc.indexOf('on') >=0 ){
                                $('div.tab-moreinfo-on').hide();
                                $('tr.on').removeClass('on');
                                return;
                        }

                        $('div.tab-moreinfo-on').hide();
                        $('tr.on').removeClass('on');
                        $tr.addClass('on');
                        var $box = $this.parents('div.box-table');
                        var boxh = $box.height() - 40, boxo = $box.offset();
						var $this_trlast=$this.children('td:last');
						var $item = $this_trlast.children('div.tab-moreinfo');
						$item.remove();
						var $this_trfirst=$this.children('td:first');
						var hg_h_id = $this_trfirst.find('div.c').attr('id').split('-');
						//判断是否是主机 还是主机组
						if($this_trfirst.find('i').attr('class').indexOf('h-bicon-t') >=0){
							var hg_h_flag = 'hgrp';
						}else{
							var hg_h_flag = 'host';
						}
						//获取详细信息
						$.ajax({
							url:'/bhost/getDetail',
							type: "post",
							async:false,
							cache:false,
							data: {a0:$("input[name=se]").val(),a1:hg_h_id[2],a2:hg_h_flag,a3:usercode},
							success: function(Result) {
								result = JSON.parse(Result);				
								if(hg_h_flag =='host'){
									//账号信息
									account_tmp = result.AccountSet;
									var account_str = "";
									$(account_tmp).each(function(i,item){
										var server_str = "";
										$(item.HostServiceSet).each(function(i1,item1){
											server_str =  server_str + item1.HostServiceName+":"+item1.ProtocolName+";";
										})
										server_str = server_str.substr(0,server_str.length-1);
										if(item.HostAccount == null){
											account_str = "";
										}else{
											account_str = account_str + item.HostAccount.AccountName+"("+server_str+")"+",";
										}
									})
									account_str = account_str.substr(0,account_str.length-1);
									
									markText =  "<p>主机名：" +result.HostName +"</p>" +
												"<p>主机IP：" +result.HostIP +"</p>" +
												"<p>设备类型：" +result.DeviceTypeName +"</p>" +
												"<p>账号信息：" + account_str + "</p>" +
												"<p>状态："   +((result.Status == 0)?'启用':'停用')+'</p>';
								}else{
									markText =  "<p>主机组名：" +result.HGName +"</p>" +
												"<p>描述：" + HTMLEncode(result.Description)+'</p>';
								}
								if(filter_flag) markText = markText+"<p>路径：" + ($this_trfirst.find('div.c').attr('ppath')==""?"/":$this_trfirst.find('div.c').attr('ppath'))+'</p>';
								$this_trlast.append('<div class="tab-moreinfo" style="">'+markText+'</div>');
							}
						})
						$item = $this_trlast.children('div.tab-moreinfo');
                        var ih = $item.outerHeight(),th = $tr.outerHeight();
                        $cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');

                        if(boxh < oset.top-boxo.top + ih + th - 40 ){
                                $cloneItem.css({
                                        top:oset.top - ih,
                                        left:oset.left,
                                        width:$tr.outerWidth() - 1,
                                        opacity:0,
                                        display:'block'
                                }).stop().animate({
                                        opacity:1
                                });

                                var iof = $cloneItem.offset().top + $cloneItem.outerHeight();
                                var tof = $tr.offset().top;
                                if(iof != tof){
                                        $cloneItem.css('top',$tr.offset().top - $cloneItem.outerHeight());
                                }
                        }else{
                                $cloneItem.css({
                                        top:oset.top + $tr.outerHeight() + 1,
                                        left:oset.left,
                                        width:$tr.outerWidth() - 1,
                                        opacity:0,
                                        display:'block'
                                }).stop().animate({
                                        opacity:1
                                });
                        }
        })
        $('.box-table,body,.c-cont2,.c-cont').off("scroll");
        $('.box-table,body,.c-cont2,.c-cont').on('scroll',function(){
                $('div.tab-moreinfo-on').remove();
                $('tr.on').removeClass('on');
        })

}

				
function list_or_ico(){
	first_grp=$('#first_grp').attr('value');
	if(first_grp=='0'){
		$('#hostContent').removeClass('h-content-list');
		$('#hostContent').empty();
	}else{
		$('#hostContent').addClass('h-content-list');
		if($('#hostContent .c-table').length==0){
			$('#hostContent').empty().html('<div class="c-table">'+
				'<div class="tab-t">'+
					'<div class="ctr" style="width: auto;">'+
						//'<a href="javascript:;" id="btn_1" class="btn btn-default" onclick="add_host();">创建主机</a>'+
						//'<a href="javascript:;" id="btn_2" class="btn btn-default" onclick="add_hostgrp(0);">创建主机组</a>'+
						//'<a href="javascript:;" id="btn_3" class="btn btn-default" onclick="server_add_or_clear();">批量管理</a>'+
						'<a href="javascript:;" id="btn_6" class="btn btn-default" onclick="copy();">复制</a>'+
						'<a href="javascript:;" id="btn_7" class="btn btn-default" onclick="cut();">剪切</a>'+
						'<a href="javascript:;" id="btn_4" class="btn btn-default" onclick="paste();">粘贴</a>'+
						'<a href="javascript:;" id="btn_8" class="btn btn-default" onclick="delete_node();">删除</a>'+
						'<a href="javascript:;" id="btn_9" class="btn btn-default" onclick="move_node();">移除</a>'+
						'<a href="javascript:;" id="btn_5" class="btn btn-default" onclick="refresh();">刷新</a>'+
					'</div>'+
				'</div>'+
				'<div class="box-table">'+
					'<table cellpadding="0" cellspacing="0" id="host_list">'+
						'<thead>'+
							'<tr>'+
								'<th style="width: 10px;"><input type="checkbox" class="form-checkbox" id="host_list_all" style=""></th>'+
								'<th style="">名称</th>'+
								'<th width="50">类型</th>'+
								'<th width="100">设备类型</th>'+
								'<th width="40">状态</th>'+
								'<th width="135"></th>'+	
							'</tr>'+
						'</thead>'+
					'</table>'+
				'</div>'+
				'<div class="box-table host_list_div" style="overflow: auto; margin-top: -1px;">'+
					'<table cellpadding="0" cellspacing="0">'+
						'<tbody id="host_list_">'+
						'</tbody>'+
					'</table>'+
				'</div>'+
			'</div>');
			$('#host_list_all').iCheck({
				checkboxClass: 'icheckbox_minimal-blue',
				radioClass: 'iradio_minimal-blue',
				increaseArea: '0' // optional
			});
		}
		else{
			$('#host_list_').empty();
		}
		$('#host_list_all').iCheck('uncheck');
		}
		$('#btn_1').show();
		$('#btn_2').show();
		$('#btn_3').show();
		$('#btn_4').show();
		$('#btn_5').show();
		$('#btn_6').show();
		$('#btn_7').show();
		$('#btn_8').show();
		$('#btn_9').show();
		//console.log(filter_flag);
		if(filter_flag){
			$('#btn_1').hide();
			$('#btn_2').hide();
			$('#btn_3').hide();
			$('#btn_4').hide();
		}else if(copy_flag == 1){
			
		}else if(copy_flag == 0){
			$('#btn_4').hide();
		}
		if(_if_disable =='1'){
		$('#btn_1').hide();
		$('#btn_2').hide();
		$('#btn_3').hide();
		$('#btn_4').hide();
		$('#btn_6').hide();
		$('#btn_7').hide();
		$('#btn_8').hide();
		$('#btn_9').hide();
		}
		//console.log(parent_id);
		if(parent_id == 'node-0-1'){		//未分组下
			$('#btn_2').hide();
			$('#btn_6').hide();
			$('#btn_9').hide();
		}else if(parent_id == 'route-root' || parent_id==''){		//所有组下
			$('#btn_1').hide();
			$("#btn_4").hide();
			$('#btn_9').hide();
		}
		//console.log($("#hostCatelog").find('.active').attr('auth') == 1 && $("#hostCatelog").find('.active').attr('title') != '未分组');
		if($("#hostCatelog").find('.active').attr('auth') == 1 && $("#hostCatelog").find('.active').attr('title') != '未分组'){
			$('#btn_1').hide();
			$('#btn_2').hide();
		}
		//console.log($("#hostCatelog").find('.active').attr('title'));
		if($("#hostCatelog").find('.active').attr('title') == undefined){
			$("#btn_2").show();
	}
	_initSize();
}
	
function _initList(){
	//获取 第一层数据
	var hostgrp_data=[];
	var host_data = [];
	$.ajax({
		url:'/bhost/getHostDir',
		type: "post",
		async:false,
		cache : false,
		data: {a0:$("input[name=se]").val(),a1:0},
		success: function(Result) {
			result = JSON.parse(Result);
			firstData_grp = result.data.HGroup;
			firstData_host = result.data.Host;
		}
	});
	//$('#hostCatelog,#hostContent').empty();
	$('#hostCatelog').empty();
	$('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a>');
	clear_filter();
	$('#find_select').val('all').trigger('change');
	list_or_ico();
	$.each(firstData_grp,function(i,item){
		if(( item.Mode==2 || (item.Mode ==0 && item.Selected!=0) ) || '{{us}}' == 'admin'|| item.HGName == '未分组'){
			if(item.MemberNum > 0){
				$('#hostCatelog').append('<li><i class="h-aicon" /><a href="javascript:;" id="node-0-'+item.HGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'"  title="'+item.HGName+'"><i class="h-eicon h-eicon-t-m"></i><span>'+item.HGName+'</span></a><ul><p>Loading...</p></ul></li>');
			}else{
				$('#hostCatelog').append('<li><i class="h-blank" /><a href="javascript:;" id="node-0-'+item.HGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'"  title="'+item.HGName+'"><i class="h-eicon h-eicon-t-m"></i><span>'+item.HGName+'</span></a></li>');
			}
			//$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HGId+'" data-mark="'+item.mark+'"><i class="h-bicon h-bicon-t"></i>'+item.HostName+'</div></div>');
			if(first_grp=='0'){
				$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HGId+'-g" auth="'+item.Mode+'" mem="'+item.MemberNum+'" type="'+item.Mode+'"><i class="h-bicon h-bicon-t"></i>'+item.HGName+'</div></div>');
			}else{
				//$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HGId+'-g" auth="'+item.Mode+'" mem="'+item.MemberNum+'" type="'+item.Mode+'"><i class="h-bicon h-bicon-t"></i><div class="div_item">'+item.HGName+'</div><div class="div_item">主机组</div><div class="div_item"></div><div class="div_item"></div></div></div>');
				$('#host_list_').append('<tr>'+
					'<td class="in">'+
						'<input type="checkbox" class="input_checkbox" id="in" style="" '+(item.HGName=='未分组'?'disabled':'')+'>'+
						'<div class="item"><div class="c" id="cnode-0-'+item.HGId+'-g" auth="'+item.Mode+'" mem="'+item.MemberNum+'" type="'+item.Mode+'"><i class="h-bicon h-bicon-t"></i></div></div>'+
					'</td>'+
					'<td title="'+item.HGName+'">'+item.HGName+'</td>'+
					'<td title="主机组">主机组</td>'+
					'<td></td>'+
					'<td></td>'+
					'<td><div class="tab-ctr">'+
						'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+' '+((item.HGName=='未分组')?'disabled':'')+'" id="'+
						((item.HGName=='未分组')?'':'_edit')+'" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
						'<a href="javascript:;" style="width:8px;" class="copy '+((item.HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
						((item.HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
						'<a href="javascript:;" style="width:8px;" class="cut '+((item.HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((item.HGName=='未分组' || _if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
						'<a href="javascript:;" style="width:8px;" class="del '+((item.HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((item.HGName=='未分组' || _if_disable =='1')?'':'_del')+'" title="删除"></a>'+
						'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>'+
					'</div></td>'+
				'</tr>');
			}
		}
		
	});
	$.each(firstData_host,function(i,item){
		if(( item.Mode==2 || (item.Mode ==0 && item.Selected!=0) ) || '{{us}}' == 'admin'){
			if(item.Status == 0){
				if(first_grp=='0'){
					$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+item.HostIP+'</br>('+item.HostName+')</div></div>');
				}else{
					//$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i><div class="div_item">'+item.HostIP+'('+item.HostName+')</div><div class="div_item">主机</div><div class="div_item"></div><div class="div_item">启用</div></div></div>');
					$('#host_list_').append('<tr>'+
						'<td class="in">'+
							'<input type="checkbox" class="input_checkbox" id="in" style="">'+
							'<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i></div></div>'+
						'</td>'+
						'<td title="'+item.HostIP+'('+item.HostName+')'+'">' + item.HostIP + '(' + item.HostName + ')' +'</td>'+
						'<td title="主机">主机</td>'+
						'<td title="'+item.DeviceTypeName+'">'+item.DeviceTypeName+'</td>'+
						'<td title="启用">启用</td>'+
						'<td><div class="tab-ctr">'+
							'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+'" id="_edit" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
							'<a href="javascript:;" style="width:8px;" class="copy '+((_if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
							((_if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
							'<a href="javascript:;" style="width:8px;" class="cut '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
							'<a href="javascript:;" style="width:8px;" class="del '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_del')+'" title="删除"></a>'+
							'<a href="javascript:;" style="width:8px;" class="move '+((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'disabled':'')+'" id="'+
							((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'':'_remove')+'" title="移除"></a>'+
						'</div></td>'+
					'</tr>');
				}
			}else if(item.Status == 2){
				if(first_grp=='0'){
					$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+item.HostIP+'</br>('+item.HostName+')</div></div>');			
				}else{
					//$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i><div class="div_item">'+item.HostIP+'('+item.HostName+')</div><div class="div_item">主机</div><div class="div_item">'+item.DeviceTypeName+'</div><div class="div_item">禁用</div></div></div>');			
					$('#host_list_').append('<tr>'+
						'<td class="in">'+
							'<input type="checkbox" class="input_checkbox" id="in" style="">'+
							'<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i></div></div>'+
						'</td>'+
						'<td title="' + item.HostIP + '(' + item.HostName + ')' +'">' + item.HostIP + '(' + item.HostName + ')' +'</td>'+
						'<td title="主机">主机</td>'+
						'<td title="'+item.DeviceTypeName+'">'+item.DeviceTypeName+'</td>'+
						'<td title="停用">停用</td>'+
						'<td><div class="tab-ctr">'+
							'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+'" id="_edit" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
							'<a href="javascript:;" style="width:8px;" class="copy '+((_if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
							((_if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
							'<a href="javascript:;" style="width:8px;" class="cut '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
							'<a href="javascript:;" style="width:8px;" class="del '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_del')+'" title="删除"></a>'+
							'<a href="javascript:;" style="width:8px;" class="move '+((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'disabled':'')+'" id="'+
							((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'':'_remove')+'" title="移除"></a>'+
						'</div></td>'+
					'</tr>');
				}
			}
		}
	});
	list_initList();
	parent_id = 'route-root';
	_initHostCatalog();
	_initHostMenu();
	_initRoute();
}

//catalog
function _initHostCatalog(){
	var $_root = $('.h-catelog.a');
	$_root.off('click').off('dblclick');
	$_root.on('click','i.h-aicon',function(){
		var $_item = $(this).next('a');
		var c = $_item.attr('class');
		var $_u = $_item.next('ul');
		if($_u.length == 1){
			if($_u.is(':visible')){
				$(this).removeClass('h-aicon-d');
				$_u.slideUp();
			}else{
				$(this).addClass('h-aicon-d');
				$_u.slideDown();
			}
		}
		_getNode(0,this);
	}).on('dblclick','i.h-eicon,span',function(){
		var $item = $(this).parent().prev('i');
		var $_item = $item.next('a');
		var c = $_item.attr('class');
		var $_u = $_item.next('ul');
		 if($_u.length == 1){
			if($_u.is(':visible')){
				$item.removeClass('h-aicon-d');
				$_u.slideUp();
			}else{
				$item.addClass('h-aicon-d');
				$_u.slideDown();
			}
		}
		_getNode(0,$item);
	}).on('click','a',function(){
		_hideMenu();
		$('a',$_root).removeClass('active');
		$(this).addClass('active');
		_getNode(1,this);
	});
}
var copy_flag = 0;
//get menu
var flag_id = "";
function _initHostMenu(){	//当FLAG = 1 的时候 说明选中的是   未分组 
	if(filter_flag){
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul><li><a href="javascript:;" onclick="refresh();">刷新</a></ul></div>';
	}else if(copy_flag == 1){
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul>'+
		'<li><a href="javascript:;" onclick="refresh();">刷新</a></li>'+
		'<li><a href="javascript:;" onclick="add_host();" id="addHost" >创建主机</a></li>'+
		'<li><a href="javascript:;" id="addHostGrp" onclick="add_hostgrp(0);">创建主机组</a></li>'+
		'<li><a href="javascript:;" onclick="paste()" id="paste_id">粘贴</a></li>'+
		'<li><a href="javascript:;" onclick="server_add_or_clear();">批量管理</a></li>'+
		//'<li><a href="javascript:;" onclick="server_add_or_clear();">批量导入</a></li>'+
		//'<li><a href="javascript:;" onclick="server_add_or_clear();">批量服务</a></li>'+
		//'<li><a href="javascript:;" onclick="account_add_or_clear();">批量账号</a></li>'+
		'</ul></div>';
	}else if(copy_flag == 0){
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul>'+
		'<li><a href="javascript:;" onclick="refresh();">刷新</a></li>'+
		'<li><a href="javascript:;" onclick="add_host();" id="addHost" >创建主机</a></li>'+
		'<li><a href="javascript:;" id="addHostGrp" onclick="add_hostgrp(0);">创建主机组</a></li>'+
		'<li><a href="javascript:;" onclick="server_add_or_clear();">批量管理</a></li>'+
		//'<li><a href="javascript:;" onclick="server_add_or_clear();">批量导入</a></li>'+
		//'<li><a href="javascript:;" onclick="server_add_or_clear();">批量服务</a></li>'+
		//'<li><a href="javascript:;" onclick="account_add_or_clear();">批量账号</a></li>'+
		'</ul></div>';
	}
	var $menu2 = '<div class="hostmenu" id="hostMenu2"><ul><li><a href="javascript:;" onclick="modify();" id="Edit">修改</a></li><li><a href="javascript:;" onclick="copy();" id="Copy">复制</a></li><li><a href="javascript:;" onclick="cut();">剪切</a></li><li><a href="javascript:;" onclick="delete_node();">删除</a></li><li><a href="javascript:;" id="move_n" onclick="move_node();">移除</a></li></ul></div>';
	if(_if_disable =='1'){
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul><li><a href="javascript:;" onclick="refresh()">刷新</a></li></ul></div>';
		var $menu2 = '<div class="hostmenu" id="hostMenu2"><ul><li><a href="javascript:;" onclick="modify()" id="Edit">查看</a></li></ul></div>';
	}
	// if(flag == 1){
	// 	$menu2 = '';
	// }
	var $_root = $('#hostContent');
	var $_menu;
	var mtop = 0, mleft = 0;
	$_root.off("contextmenu");
	$_root.on('contextmenu',function(e){
		if(first_grp=='1'){
			return;
		}
		e.preventDefault();
		e.stopPropagation();
		_hideMenu();
		
		$('#hostContent').append($menu1);
		if(parent_id == 'node-0-1'){		//未分组下
			$('#addHostGrp').hide();
		}else if(parent_id == 'route-root'){		//所有组下
			$('#addHost').hide();
			$("#paste_id").hide();
		}
		if($("#hostCatelog").find('.active').attr('auth') == 1 && $("#hostCatelog").find('.active').attr('title') != '未分组'){
			$('#addHost').hide();
			$('#addHostGrp').hide();
		}
		if($("#hostCatelog").find('.active').attr('title') == undefined){
			$("#addHostGrp").show();
		}
		$_menu = $('#hostMenu1');
		var $_item = $(this);

		var $p = $('div.h-explorer');
		var offset = $p.offset();

		var maxRight = offset.left + $p.width();
		var maxBottom = offset.top + $p.height();
		mtop = e.clientY + $_menu.height() < maxBottom ? e.clientY : e.clientY - $_menu.height() - 20;
		mleft = e.clientX + $_menu.width() < maxRight ? e.clientX : e.clientX  - 100;

		$_menu.css({
			'top': mtop,
			'left': mleft
		}).show().on('mouseout',function(){
				$_root.on('click',function(){
				$_menu.hide();
			})
		});
		$('#hostContent a').unbind().on('click',function(e){
			text_tmp = $(this).text();
			if(if_paste) $('#paste_id').show();
			else $('#paste_id').hide();
		})
		_initSize();
	});

	//-----11/30 ctrl shift 多选功能 
	var boardkey=0;  //记录ctrl/shift键
	var $_fcitem,onlen = 0;
	$(window).keydown(function(e){
		if(e.ctrlKey){
			boardkey=1;
		}else if(e.shiftKey){
			boardkey=2;
		}
	}).keyup(function(){
		boardkey=0;
	})
	//-----11/30_e
	$_root.off('click').off("dblclick").off("scroll").off("mouseover");
	$_root.on('contextmenu','div.c',function(e){
		if(first_grp=='1'){
			return;
		}
		e.preventDefault();
		e.stopPropagation();
		_hideMenu();
		var $_item = $(this);
		// $_item.addClass('on').parent().siblings('div.item').children('div.c').removeClass('on');
		//11-30_s
		var c = $_item.attr('class').split(' ');
		var ids = new Array();
		if(c.indexOf('on') < 0){
			$_item.addClass('on').parent().siblings('div.item').children('div.c').removeClass('on');
			var id = $_item.attr('id').split('-')[1];
			ids.push(id);
			onlen = 1;
		}else{
			$('div.item>div.c.on',$_root).each(function(){
				var id = $(this).attr('id').split('-')[1];
				ids.push(id);
			});
		}
		
		
		
		//11-30_e
		if(flag_id != 'cnode-0-1-g'){//不是在未分组上
			$('#hostContent').append($menu2);
			if(parent_id == 'node-0-1'){		//未分组下
				$('#Copy').hide();
				$('#move_n').hide();
				//11-30_s
				if(onlen > 1){				//多选
					$("#Edit").hide();
					$('#transfer').hide();
					$('#move_n').hide();
					
				}
				//11-30_e
			}else if(parent_id == 'route-root'){		//所有组下
				$('#move_n').hide();
			
				if($(this).attr('ppath') != undefined){
					if($(this).attr('ppath').indexOf('/未分组/')>=0){
						$('#Copy').hide();
					}
				}
				if(onlen > 1){				//多选
					$("#Edit").hide();
					$('#transfer').hide();
					$('#move_n').hide();
					
				}
			}else if($("#hostContent").find("div[class='item']").find("div[class='c on']").find('i').attr('class') == "h-bicon h-bicon-t"){		//主机组
				$('#move_n').hide();
				if(onlen > 1){				//多选
					$("#Edit").hide();					
				}
			}else{
			}
		}
		$_menu = $('#hostMenu2');
		
		var $p = $('div.h-explorer');
		var offset = $p.offset();

		var maxRight = offset.left + $p.width();
		var maxBottom = offset.top + $p.height();

		mtop = e.clientY + $_menu.height() < maxBottom ? e.clientY : e.clientY - $_menu.height() - 20;
		mleft = e.clientX + $_menu.width() < maxRight ? e.clientX : e.clientX - 100;

		$_menu.css({
			'top': mtop-20,
			'left': mleft
		}).show().on('mouseout',function(){
				$_root.on('click',function(){
				$_menu.hide();
			})
		});
		
		var Mode = $("#hostContent").find("div[class='c on']").attr('type');//1-->只读 2-->可编辑
		if(Mode == 0){
			$("#Edit").hide();
		}	
		current_id = $_item.attr('id');
		z_current_name = $_item.text();
		var id_arr=current_id.split('-');
		id_arr[0]='node';
		id_arr.splice(id_arr.length-1,1);
		z_current_class=$('#'+id_arr.join('-')).prev('i').attr('class');
		if(filter_flag) c_parent_id = current_id.split('-')[1];//
		_initSize();
		var fa = false;
		$('#hostMenu2 a').each(function(i,item){
			if($(item).is(':visible')){
				fa =true;
				return false;
			}
		})
		if(fa == false){
			$_menu.hide();
		}
	}).on('click',function(e){
		if(first_grp=='1'){
			return;
		}
		if(e.target.className == 'h-content'){
			$("#hostContent").find('.c.on').removeClass('on');
		}else{
			if(e.target.className == 'c' || e.target.className == 'c on' ){
				var $_item = $(e.target); 
			}else{
				var $_item = $(e.target).parent();
			}
			if(boardkey == 0){
				$_item.addClass('on').parent().siblings('div.item').children('div.c').removeClass('on');
				$_fcitem = $_item;
			}else if(boardkey == 1){		//ctrl
				var c = $_item.attr('class').split(' ');
				if(c.indexOf('on') < 0){
					$_item.addClass('on');
					$_fcitem = $_item;
				}else{
					$_item.removeClass('on');
				}
			}else if(boardkey == 2){//shift
				var index = $_item.parent().index();
				var fi;
				if(typeof $_fcitem == 'undefined'){
					fi = index;
				}else{
					fi = $_fcitem.parent().index();
				}
				$('div.item>div.c',$_root).removeClass('on');
				if(index > fi){
					$('div.item',$_root).each(function(i,item2){
						if(i >= fi && i <= index){
							$(item2).children('div.c').addClass('on');
						}
					})
				}else if(index < fi){
					$('div.item',$_root).each(function(i,item2){
						if(i <= fi && i >= index){
							$(item2).children('div.c').addClass('on');
						}
					})
				}else{
					$_item.addClass('on');
					$_fcitem = $_item;
				}
			}
			onlen = $('>div.item>div.c.on',$_root).length;
		}
	}).on('scroll',function(){
		if($_menu){
			$_menu.hide();
		}
	}).on('mouseover','div.c',function(e){
		markText = '';
		$('#markView').remove();
		//markText = $(this).data('mark');
		obj = $(this);
		flag_id = $(this).attr("id");
		id_list = $(this).attr('id').split('-');

		//判断是否是主机 还是主机组
		if($(this).find('i').attr('class').indexOf('h-bicon-t') >=0){
			flag = 'hgrp';
		}else{
			flag = 'host';
		}
		
		//获取详细信息
		$.ajax({
			url:'/bhost/getDetail',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:id_list[2],a2:flag,a3:usercode},
			success: function(Result) {
				result = JSON.parse(Result);				
				if(flag =='host'){
					if(result.Status == 0) Status="启用";
					else Status="停用";
					//账号信息
					account_tmp = result.AccountSet;
					var account_str = "";
					$(account_tmp).each(function(i,item){
						server_str = "";
						$(item.HostServiceSet).each(function(i1,item1){
							server_str =  server_str + item1.HostServiceName+":"+item1.ProtocolName+";";
						})
						server_str = server_str.substr(0,server_str.length-1);
						if(item.HostAccount == null){
							account_str = "";
						}else{
							account_str = account_str + item.HostAccount.AccountName+"("+server_str+")"+",";
						}
					})
					account_str = account_str.substr(0,account_str.length-1);
					markText =  "主机名：" +result.HostName +"<br>" +
								"主机IP：" +result.HostIP +"<br>" +
								"设备类型：" +result.DeviceTypeName +"<br>" +
								"账号信息：" + account_str + "<br>" +
								"状态："   +Status;
				}else{
					markText =  "主机组名：" +result.HGName +"<br>" +
								"描述：" + HTMLEncode(result.Description);
				}
				if(filter_flag) markText = markText+"<br>路径：" + (obj.attr('ppath')==""?"/":obj.attr('ppath'));
			}
		})
		
		var HTML = '<div id="markView" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" >'+markText+'</div>';
		$('body').append(HTML);

		var $_mark = $('#markView');

		var $p = $('div.h-explorer');
		var offset = $p.offset();

		var maxRight = offset.left + $p.width();
		var maxBottom = offset.top + $p.height();

		mtop = e.clientY + $_mark.height() < maxBottom ? e.clientY + 5 : e.clientY - $_mark.height() - 25;
		mleft = e.clientX + $_mark.width() < maxRight ? e.clientX + 5 : e.clientX  - 205;

		$_mark.css({
			'top': mtop,
			'left': mleft
		}).show();
		_initSize();
	}).on('mouseout','div.c',function(){
		markText = '';
		$('#markView').remove();
	});
	//console.log('#hostContent>div.item>div.c');
	$('#hostContent>div.item>div.c').unbind().bind('dblclick',function(){
		var id = $(this).attr('id').split('-')[1];
		var iid = $(this).attr('id').split('-')[2];
		if(parent_id.indexOf('root')<0){
			if($('#'+parent_id).prev().attr("class").indexOf('h-aicon-d') <0){
				$('#'+parent_id).prev().click();
			}
		}
		$('#node-'+id +'-'+ iid).click();
		//$('#node-'+id).prev().trigger('click');
		//console.log($(this).children('i').attr('class').indexOf('h-bicon-c')>=0);
		if($(this).children('i').attr('class').indexOf('h-bicon-c')>=0){ //双击 主机  编辑
			current_id = $(this).attr('id');
			modify();
		}
	})
}

//获取子节点
function _getNode(i,obj){
	//var data = nodeData;
	var id; // id
	if(i == 0){
		id = parseInt($(obj).next('a').attr('id').split('-')[2]);
		//获取 节点数据
		var hostgrp_data=[];
		var host_data = [];
		$.ajax({
			url:'/bhost/getHostDir',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:id},
			success: function(Result) {
				result = JSON.parse(Result);
				hostgrp_data = result.data.HGroup;
				host_data = result.data.Host;
			}
		});
		var $_u = $(obj).next('a').next('ul');
		//已加载节点，返回不再插入节点数据
		if($('li',$_u).length > 0){
		    return false;
		}
		//
		$_u.unbind();
		$_u.empty();
		list_or_ico();
		$.each(hostgrp_data,function(i,item){
			if(( item.Mode==2 || (item.Mode ==0 && item.Selected!=0) ) || '{{us}}' == 'admin'|| item.HGName == '未分组'){
				if(item.MemberNum > 0){
					$_u.append('<li><i class="h-aicon" /><a href="javascript:;" id="node-'+id+'-'+item.HGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'" title="'+item.HGName+'"><i class="h-eicon h-eicon-t-m"></i><span>'+item.HGName+'</span></a><ul><p>Loading...</p></ul></li>');
				}else{
					$_u.append('<li><i class="h-blank" /><a href="javascript:;" id="node-'+id+'-'+item.HGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'" title="'+item.HGName+'"><i class="h-eicon h-eicon-t-m"></i><span>'+item.HGName+'</span></a></li>');
				}
			}
		});
	}else{	
		parent_id = $(obj).attr('id');
		id_list = $(obj).attr('id').split('-');
		iid = id_list[1];
		if(iid == 'root'){
			id = 0;
		}else{
			id = id_list[2];
		}
		//获取 节点数据
		var hostgrp_data=[];
		var host_data = [];
		$.ajax({
			url:'/bhost/getHostDir',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:id},
			success: function(Result) {
				result = JSON.parse(Result);
				hostgrp_data = result.data.HGroup;
				host_data = result.data.Host;
			}
		});
		
		var $_c = $('#hostContent');
		if(first_grp=='0'){
			$_c.unbind();
			$_c.empty();
		}
		clear_filter();
		$('#find_select').val('all').trigger('change');
		list_or_ico();
		//$('div.item',$_c).remove();
		$.each(hostgrp_data,function(i,item){
			if(( item.Mode==2 || (item.Mode ==0 && item.Selected!=0) ) || '{{us}}' == 'admin'|| item.HGName == '未分组'){
				if(first_grp=='0'){
					$_c.append('<div class="item"><div class="c" auth="'+item.Mode+'" mem="'+item.MemberNum+'" id="cnode-'+id+'-'+item.HGId+'-g" type="'+item.Mode+'"><i class="h-bicon h-bicon-t"></i>'+item.HGName+'</div></div>');
				}else{
					//$_c.append('<div class="item"><div class="c" auth="'+item.Mode+'" mem="'+item.MemberNum+'" id="cnode-'+id+'-'+item.HGId+'-g" type="'+item.Mode+'"><i class="h-bicon h-bicon-t"></i><div class="div_item">'+item.HGName+'</div><div class="div_item">主机组</div><div class="div_item"></div><div class="div_item"></div></div></div>');
					$('#host_list_').append('<tr>'+
						'<td class="in">'+
							'<input type="checkbox" class="input_checkbox" id="in" style="" '+(item.HGName=='未分组'?'disabled':'')+'>'+
							'<div class="item"><div class="c" auth="'+item.Mode+'" mem="'+item.MemberNum+'" id="cnode-'+id+'-'+item.HGId+'-g" type="'+item.Mode+'"><i class="h-bicon h-bicon-t"></i></div></div>'+
						'</td>'+
						'<td title="'+item.HGName+'">'+item.HGName+'</td>'+
						'<td title="主机组">主机组</td>'+
						'<td></td>'+
						'<td></td>'+
						'<td><div class="tab-ctr">'+
							'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+' '+((item.HGName=='未分组')?'disabled':'')+'" id="'+
							((item.HGName=='未分组')?'':'_edit')+'" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
							'<a href="javascript:;" style="width:8px;" class="copy '+((item.HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
							((item.HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
							'<a href="javascript:;" style="width:8px;" class="cut '+((item.HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((item.HGName=='未分组' || _if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
							'<a href="javascript:;" style="width:8px;" class="del '+((item.HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((item.HGName=='未分组' || _if_disable =='1')?'':'_del')+'" title="删除"></a>'+
							'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>'+
						'</div></td>'+
					'</tr>');
				}
			}
		});
		$.each(host_data,function(i,item){
			if(( item.Mode==2 || (item.Mode ==0 && item.Selected!=0) ) || '{{us}}' == 'admin'){
				if(item.Status == 0){
					if(first_grp=='0'){
						$_c.append('<div class="item"><div class="c" id="cnode-'+id+'-'+item.HostId+'-h" ><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+item.HostIP+'</br>('+item.HostName+')</div></div>');
					}else{
						//$_c.append('<div class="item"><div class="c" id="cnode-'+id+'-'+item.HostId+'-h" ><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i><div class="div_item">'+item.HostIP+'('+item.HostName+')</div><div class="div_item">主机</div><div class="div_item"></div><div class="div_item">启用</div></div></div>');
						$('#host_list_').append('<tr>'+
							'<td class="in">'+
								'<input type="checkbox" class="input_checkbox" id="in" style="">'+
								'<div class="item"><div class="c" id="cnode-'+id+'-'+item.HostId+'-h" ><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i></div></div>'+
							'</td>'+
							'<td title="' + item.HostIP + '(' + item.HostName + ')' +'">' + item.HostIP + '(' + item.HostName + ')' +'</td>'+
							'<td title="主机">主机</td>'+
							'<td title="'+item.DeviceTypeName+'">'+item.DeviceTypeName+'</td>'+
							'<td title="启用">启用</td>'+
							'<td><div class="tab-ctr">'+
								'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+'" id="_edit" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
								'<a href="javascript:;" style="width:8px;" class="copy '+((_if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
								((_if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
								'<a href="javascript:;" style="width:8px;" class="cut '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
								'<a href="javascript:;" style="width:8px;" class="del '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_del')+'" title="删除"></a>'+
								'<a href="javascript:;" style="width:8px;" class="move '+((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'disabled':'')+'" id="'+
								((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'':'_remove')+'" title="移除"></a>'+
							'</div></td>'+
						'</tr>');
					}
				}else if(item.Status == 2){
					if(first_grp=='0'){
						$_c.append('<div class="item"><div class="c" id="cnode-'+id+'-'+item.HostId+'-h" ><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+item.HostIP+'</br>('+item.HostName+')</div></div>');
					}else{
						//$_c.append('<div class="item"><div class="c" id="cnode-'+id+'-'+item.HostId+'-h" ><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i><div class="div_item">'+item.HostIP+'('+item.HostName+')</div><div class="div_item">主机</div><div class="div_item"></div><div class="div_item">启用</div></div></div>');
						$('#host_list_').append('<tr>'+
							'<td class="in">'+
								'<input type="checkbox" class="input_checkbox" id="in" style="">'+
								'<div class="item"><div class="c" id="cnode-'+id+'-'+item.HostId+'-h" ><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i></div></div>'+
							'</td>'+
							'<td title="' + item.HostIP + '(' + item.HostName + ')' +'">' + item.HostIP + '(' + item.HostName + ')' +'</td>'+
							'<td title="主机">主机</td>'+
							'<td title="'+item.DeviceTypeName+'">'+item.DeviceTypeName+'</td>'+
							'<td title="停用">停用</td>'+
							'<td><div class="tab-ctr">'+
								'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+'" id="_edit" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
								'<a href="javascript:;" style="width:8px;" class="copy '+((_if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
								((_if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
								'<a href="javascript:;" style="width:8px;" class="cut '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
								'<a href="javascript:;" style="width:8px;" class="del '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_del')+'" title="删除"></a>'+
								'<a href="javascript:;" style="width:8px;" class="move '+((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'disabled':'')+'" id="'+
								((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'':'_remove')+'" title="移除"></a>'+
							'</div></td>'+
						'</tr>');
					}
				}
			}
		});
		list_initList();
		var rpath;
		var rarr = new Array();
		var _getRoute = function(item){
			var tagname = $(item).parent().parent()[0].tagName;
			var tagname_id=$(item).parent().parent()[0].id;
			if(tagname.toLowerCase() == 'ul'){
				var iid = $(item).attr('id').split('-')[2];
				var id = parseInt($(item).attr('id').split('-')[1]);
				rarr.unshift('<a href="javascript:;" id="route-'+id+'-'+iid+'" auth="'+$(item).attr('auth')+'" title="'+$(item).text()+'">'+$(item).text()+'</a>');
				if(tagname_id=='hostCatelog'){
					_getRoute($(item).parent().parent().parent().prev());
				}else{
					_getRoute($(item).parent().parent().prev());
				}
				
			}else{
				rpath = rarr.join('<span class="fix" />');
			}
		}

		_getRoute(obj);
		
		if(id !=0) $('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a><div class="h-path-wrap">'+rpath+'</div>');
		else $('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a>');
			_pathWrap();
		_initHostMenu();
			
	}
}

//route
function _initRoute(){
	var $_root = $('#hostRoute');
	$_root.unbind().on('click','a',function(){
		var id = $(this).attr('id').split('-')[1];
		if(id == 'root'){
			$.ajax({
				url:'/bhost/getHostDir',
				type: "post",
				async:false,
				cache:false,
				data: {a0:$("input[name=se]").val(),a1:0},
				success: function(Result) {
					result = JSON.parse(Result);
					firstData_grp = result.data.HGroup;
					firstData_host = result.data.Host;
				}
			});
			
			$('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a>');
			$('#hostCatelog a.active').removeClass('active');
			$('#hostContent div.item').remove();
			clear_filter();
			$('#find_select').val('all').trigger('change');
			list_or_ico();
			$.each(firstData_grp,function(i,item){
				if(( item.Mode==2 || (item.Mode ==0 && item.Selected!=0) ) || '{{us}}' == 'admin'|| item.HGName == '未分组'){
					if(first_grp=='0'){
						$('#hostContent').append('<div class="item"><div class="c" auth="'+item.Mode+'"  mem="'+item.MemberNum+'" id="cnode-0-'+item.HGId+'-g" type="'+item.Mode+'" ><i class="h-bicon h-bicon-t"></i>'+item.HGName+'</div></div>');
					}else{
						$('#host_list_').append('<tr>'+
							'<td class="in">'+
								'<input type="checkbox" class="input_checkbox" id="in" style="" '+(item.HGName=='未分组'?'disabled':'')+'>'+
								'<div class="item"><div class="c" auth="'+item.Mode+'"  mem="'+item.MemberNum+'" id="cnode-0-'+item.HGId+'-g" type="'+item.Mode+'" ><i class="h-bicon h-bicon-t"></i></div></div>'+
							'</td>'+
							'<td title="'+item.HGName+'">'+item.HGName+'</td>'+
							'<td title="主机组">主机组</td>'+
							'<td></td>'+
							'<td></td>'+
							'<td><div class="tab-ctr">'+
								'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+' '+((item.HGName=='未分组')?'disabled':'')+'" id="'+
								((item.HGName=='未分组')?'':'_edit')+'" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
								'<a href="javascript:;" style="width:8px;" class="copy '+((item.HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
								((item.HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
								'<a href="javascript:;" style="width:8px;" class="cut '+((item.HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((item.HGName=='未分组' || _if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
								'<a href="javascript:;" style="width:8px;" class="del '+((item.HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((item.HGName=='未分组' || _if_disable =='1')?'':'_del')+'" title="删除"></a>'+
								'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>'+
							'</div></td>'+
						'</tr>');
					}
				}
			});
			$.each(firstData_host,function(i,item){
				if(( item.Mode==2 || (item.Mode ==0 && item.Selected!=0) ) || '{{us}}' == 'admin'){
					if(item.Status == 0){
						if(first_grp=='0'){
							$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+item.HostIP+'</br>('+item.HostName+')</div></div>');
						}else{
							$('#host_list_').append('<tr>'+
								'<td class="in">'+
									'<input type="checkbox" class="input_checkbox" id="in" style="">'+
									'<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i></div></div>'+
								'</td>'+
								'<td title="' + item.HostIP + '(' + item.HostName + ')' +'">' + item.HostIP + '(' + item.HostName + ')' +'</td>'+
								'<td title="主机">主机</td>'+
								'<td title="'+item.DeviceTypeName+'">'+item.DeviceTypeName+'</td>'+
								'<td title="启用">启用</td>'+
								'<td><div class="tab-ctr">'+
									'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+'" id="_edit" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
									'<a href="javascript:;" style="width:8px;" class="copy '+((_if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
									((_if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
									'<a href="javascript:;" style="width:8px;" class="cut '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
									'<a href="javascript:;" style="width:8px;" class="del '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_del')+'" title="删除"></a>'+
									'<a href="javascript:;" style="width:8px;" class="move '+((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'disabled':'')+'" id="'+
									((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'':'_remove')+'" title="移除"></a>'+
								'</div></td>'+
							'</tr>');
						}
					}else if(item.Status == 2){
						if(first_grp=='0'){
							$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+item.HostIP+'</br>('+item.HostName+')</div></div>');
						}else{
							$('#host_list_').append('<tr>'+
								'<td class="in">'+
									'<input type="checkbox" class="input_checkbox" id="in" style="">'+
									'<div class="item"><div class="c" id="cnode-0-'+item.HostId+'-h"><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i></div></div>'+
								'</td>'+
								'<td title="' + item.HostIP + '(' + item.HostName + ')' +'">' + item.HostIP + '(' + item.HostName + ')' +'</td>'+
								'<td title="主机">主机</td>'+
								'<td title="'+item.DeviceTypeName+'">'+item.DeviceTypeName+'</td>'+
								'<td title="停用">停用</td>'+
								'<td><div class="tab-ctr">'+
									'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+'" id="_edit" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
									'<a href="javascript:;" style="width:8px;" class="copy '+((_if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
									((_if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
									'<a href="javascript:;" style="width:8px;" class="cut '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
									'<a href="javascript:;" style="width:8px;" class="del '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_del')+'" title="删除"></a>'+
									'<a href="javascript:;" style="width:8px;" class="move '+((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'disabled':'')+'" id="'+
									((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'':'_remove')+'" title="移除"></a>'+
								'</div></td>'+
							'</tr>');
						}
					}
				}
			});
			list_initList();
			_hideMenu();
			parent_id = "route-root";
			_initHostMenu();
		}else{
			$("#route-root").next().children('a').each(function(i,item){
				var id_str = $(item).attr('id').split('route')[1];
				if($("#node"+id_str).prev().attr('class') == 'h-aicon'){
					$("#node"+id_str).prev().click();
				}
			})
			var iid = $(this).attr('id').split('-')[2];
			$('#node-'+id+'-'+iid).click();
		}
	});
}

function _hideMenu(){
	var $_menu = $('#hostMenu1,#hostMenu2,#markView');
	if($_menu.is(':visible')){
		$_menu.remove();
	}
}

function _initSize(){
	var h = $(window).height();
	var w = $(window).width();
	$('.h-catelog').height(h-200);
	$('.h-catelog-son-div').height(h-200-57);
	$('.h-content').height(h-220);
	$('.host_list_div').height(h-220-(296-210));
	$('.h-content').width($('.h-explorer').width()-$('.h-catelog').width() - 21);
	$('.server_div').height(h-260);
	// $('.h-content2').height(h-200);
	$('.h-content2_tmp').height(h-200);
	$('#service_div0').width(w-40);
	$('#service_div2').width($('#service_div0').width()-$('#service_div1').width()-4);
	$('.server_table_div').css('max-height',h-383);
	$('.r-list').height(h-338);
	$('#hosttree_div_service').height(h-236);
	$('#hosttree_div_account').height(h-236);
}

function _pathWrap(){
	var w1 = $('div.h-top1').width(),
		w2 = $('#route-root').outerWidth(),
		w3 = $('div.filter1').outerWidth();
	var ww = w1-w2-w3-120;

	$('div.h-path-wrap span.over').next('span.fix').remove();
	$('div.h-path-wrap span.over').remove();

	$('div.h-path-wrap').width(ww);

	var len = $('div.h-path-wrap>a').length;
	var z = Math.floor(ww/90);
	if(len>z){
		if($('#hOver').length == 0){
			$('body').append('<div id="hOver" />');
		}

		var $over = $('#hOver');
		var n = len-z+1;
		$over.empty();
		$('div.h-path-wrap>a').each(function(i){
			if(i<=n && i>0){
				$(this).clone().show().appendTo($over);
				$(this).hide().next('span.fix').hide();
			}else{
				 $(this).show().next('span.fix').show();
			}
		});

		$('div.h-path-wrap>span.fix:first').after('<span class="over">……</span><span class="fix"></span>');
	}else{
		$('div.h-path-wrap>a').show().next('span.fix').show();
	}
	var $_root = $('#hostCatelog');
	$('#hOver').unbind().on('click','a',function(){
		id = $(this).attr('id').replace('route','node');
		$('#'+ id).click(); 
	});
}

$(function(){
	var hHide = function(){
		$('#hOver').hide();
		$('span.over').removeClass('on');
	},hout;

	$('.h-route').on('mouseover','span.over',function(){
		clearTimeout(hout);
		$(this).addClass('on');
		var offset = $(this).offset();
		$('#hOver').css({
			top:offset.top+19,
			left:offset.left
		}).show();
	}).on('mouseout','span.over',function(){
		hout = setTimeout(function(){
			hHide();
		},100);
	});

	$('body').on('mouseover','#hOver',function(){
		clearTimeout(hout);
		$(this).show();
		$('span.over').addClass('on');
	}).on('mouseout','#hOver',function(){
		hout = setTimeout(function(){
			hHide();
		},100);
	}).on('click','#hOver a',function(){
		var id = $(this).attr('id').split('-')[1];
		$('#node-'+id).click();
		$('#hOver').hide();
	});
	$("#Port").bind('keydown', function(e){
		DigitInput(e);
	});
})
//添加、修改 主机主机组 0->创建 1->修改
var parent_id='';
var current_id = "";
var flag_service_empty = false;
var host = {
	"HostId": 0,
	"HostName": "",
	"HostIP": "",
	"Description": null,
	"AccessRate": 0,   
	"EnableLoginLimit": false,  
	"Status": 0,
	"DeviceTypeId": 0,
	"HGroupSet": [
	],      
	"ServiceSet": [
	],
	"AccountSet": [
	]     
}
var current_path = [];
function add_host(){
	$("#_HostList").hide();
	$("#_Host").show();
	$("#_Host").show();
	$("#step1" ).show();
	$("#step2" ).hide();
	$("#step3" ).hide();
	$('#exp_auth').show();
	$("#host_title").text("创建主机");
	check_hostLimit();
	//_get_an();
	init_host();
	clear_host_baseinfo();
	clear_server();
	clear_account();
	$('#host_type').select2('destroy').select2();
	host = {
		"HostId": 0,
		"HostName": "",
		"HostIP": "",
		"Description": null,
		"AccessRate": 0,   
		"EnableLoginLimit": false,  
		"Status": 0,
		"DeviceTypeId": 0,
		"HGroupSet": [
		],      
		"ServiceSet": [
		],
		"AccountSet": [
		]     
	}
	var par_id = $("#route-root").next().find('a:last').attr('id').split('-')[2];
	current_path = [];
	$.each($("#route-root").next().find('a').not(':last'),function(i,item){
		current_path.push($(item).attr('id').split('-')[2]);
	});
	current_id = 'cnode-'+par_id+'-0-h';
	global_path = [];
	_initList_hg();
	$("#HostIP").attr("disabled",false);
	$('#service_list').empty();
	$('#service_account_list').empty();
	//$('#host_type').attr('disabled',false).trigger('change');
	
	//$('#add_btn_account').show();
	//$('#mod_btn_account').hide();
	document.getElementsByClassName('c-cont')[1].scrollTop = 0;//让滚动条出现在最上面
}
function modify(){
	$('#markView').remove();
	$("#_HostList").hide();
	//获取当前 主机或者主机组
	if(current_id.indexOf('-h')>=0){
		flag_service_empty = false
		$("#_Host").show();
		$("#step1" ).show();
		$("#step2" ).hide();
		$("#step3" ).hide();
		$('#exp_auth').hide();
		$("#host_title").text("编辑主机");
		init_host();
		clear_host_baseinfo();
		clear_server();
		clear_account();
		$('#add_btn_server').show();
		$('#mod_btn_server').hide();
		$('#add_btn_account').show();
		$('#mod_btn_account').hide();
		host_id = current_id.split('-')[2];
		$.ajax({
			url:'/bhost/getHost_info',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:host_id},
			success: function(Result) {
				host = JSON.parse(Result);
			}
		})
		_initList_hg(host.HGroupSet);
		//绑定数据 
		//基本信息
		$("#HostName").val(host.HostName);
		$("#HostIP").val(host.HostIP);
		$("#HostIP").attr("disabled",true);
		$("#Description").val(host.Description);
		$("#AccessRate input").each(function(i,item){
			if($(this).val() == host.AccessRate) $(this).iCheck('check');
			else $(this).iCheck('uncheck');
		})
		if(host.Status == 0) $("#Enabled").iCheck('check');
		else  $("#Enabled").iCheck('uncheck');
		if($("#host_type").children("option[value="+host.DeviceTypeId+"]").length != 0){
			$("#host_type").val(host.DeviceTypeId).select2().trigger('change');
		}
		//$("#host_type").change();
		if(host.EnableLoginLimit == true){
			$("#EnableLoginLimit").iCheck('check');
		}else if(host.EnableLoginLimit == false){
			$("#EnableLoginLimit").iCheck('uncheck');
		}
		
		$("#SwitchPasswdPrompt").val(_SwitchCmd);
		$("#LoginUserPrompt").val(_SwitchPasswdPrompt);
		
		//绑定 服务
   		service_list_refresh();
		//绑定账号
		service_account_list_refresh();
		tabArr();	
		flag_service_empty = true;
	}
	else{
		$("#_HostGrp").show();
		$("#group_title").text("编辑主机组");
		$('#_HostGrp').find('.form').children('.form-item').eq(2).hide();
		//编辑 回显 主机组
		hostgrp_id = current_id.split('-')[2];
		$.ajax({
			url:'/bhost/getHostgrp_info',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:hostgrp_id},
			success: function(Result) {
				HostGrp = JSON.parse(Result);
				$("#HostGrpName").val(HostGrp.HGName);
				$("#HostGrpDescription").val(HostGrp.Description);
			}
		})
	}
	document.getElementsByClassName('c-cont')[1].scrollTop = 0;//让滚动条出现在最上面
}
//绑定 服务
function service_list_refresh(){
	//绑定 服务
	$("#service_list").empty();
	if(host.ServiceSet ==null) host.ServiceSet=[];
	var Service_arr=[];
	$(host.ServiceSet).each(function(i,item){
		if ($.inArray(item.ProtocolName+'('+item.Port+')',Service_arr)>=0){
			return true;
		}else{
			Service_arr.push(item.ProtocolName+'('+item.Port+')');
		}
		var from_accountname;
		if(item.FromAccountName == "-"){
			from_accountname = "-";
		}else if(item.FromAccountName == "*"){
			from_accountname = "*";
		}else{
			from_accountname = item.FromAccountName;
		}
		$("#LineBreak").val(item.LineBreak).trigger('change');
		$("#FromHostName").val(item.FromHostId).trigger('change');
		$("#FromAccountName").val(item.FromAccountId).trigger('change');
		$("#FromHostServiceName").val(item.FromHostServiceId).trigger('change');
		var float_str = ((item.FromHostId == null)?"":"<p>跳转来源主机："+$("#FromHostName option:selected").text()+"</p>")+ 
			((item.FromHostServiceId == null)?"":"<p>跳转来源服务："+$("#FromHostServiceName option:selected").text()+"</p>")+ 
			((item.FromAccountId == null)?"":"<p>跳转来源账号："+$("#FromAccountName option:selected").text()+"</p>")+ 
			((item.FromLoginCmd == null || item.FromLoginCmd == '')?"":"<p>跳转命令："+item.FromLoginCmd+"</p>")+ 
			((item.NormalPrompt == null || item.NormalPrompt == '')?"":"<p>普通提示符："+item.NormalPrompt+"</p>")+ 
			((item.SuperPrompt == null || item.SuperPrompt == '')?"":"<p>特权提示符："+item.SuperPrompt+"</p>")+ 
			((item.AcctSwitchCmd == null || item.AcctSwitchCmd == '')?"":"<p>账号切换命令："+item.AcctSwitchCmd+"</p>")+ 
			((item.SwitchPasswdPrompt == null || item.SwitchPasswdPrompt == '')?"":"<p>切换密码提示："+item.SwitchPasswdPrompt+"</p>")+ 
			((item.LoginUserPrompt == null || item.LoginUserPrompt == '')?"":"<p>登录名提示："+item.LoginUserPrompt+"</p>")+ 
			((item.LoginPasswdPrompt == null || item.LoginPasswdPrompt == '')?"":"<p>登录密码提示："+item.LoginPasswdPrompt+"</p>")+ 
			((item.LoginSuccPrompt == null || item.LoginSuccPrompt == '')?"":"<p>登录成功提示："+item.LoginSuccPrompt+"</p>")+ 
			"<p>换行符："+$("#LineBreak option:selected").text()+"</p>";
		var accip_list = [];
		if(GlobalStartegy.AccIPSet == null){
			var accIP_select_tmp = [];
			if(item.AccIPSet == null) accip_list=[];
			$(item.AccIPSet).each(function(i1,item1){
				if(item1.IsBuildin == false){
					accip_list.push(item1.AccIP);
				}else if(item1.IsBuildin == true){
					accip_list.push(item1.AccIPId);
				}else if(item1.AccIP==''){
					accip_list.push(item1.AccIPId);
				}else{
					accip_list.push(item1.AccIP);
				}
			});
		}else{
			accip_list = ['全局指定'];
		}
		var ConnParamName_arr=[];
		var HostServiceName_arr=[];
		$(host.ServiceSet).each(function(i1,item1){
			if(item1.ProtocolId==item.ProtocolId && item1.Port==item.Port /*&& item1.ConnParamId!=null*/){
				if(item1.ConnParamId!=null){
					ConnParamName_arr.push(item1.ConnParamName);
				}
				HostServiceName_arr.push(item1.HostServiceId);
			}
		});
		if(item.ProtocolName == null){
			ProtocolName_tmp = "未指定";
		}else{
			ProtocolName_tmp = item.ProtocolName;
		}
		$("#service_list").append("<tr id=\"ser_"+(HostServiceName_arr.join('_'))+"\">"+
		"<td style=\"display: none;\">"+item.HostServiceName+"</td>"+
		"<td style=\"border-left: 1px solid #FFF;\" value=\""+ProtocolName_tmp+"("+item.Port+")\">"+ProtocolName_tmp+"("+item.Port+")</td>"+
		"<td>"+ConnParamName_arr.join(',')+"</td>"+
		"<td>"+accip_list.join(',')+"</td>"+
		"<td><div class=\"tab-ctr\">"+
		"<a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog1('edit','"+item.HostServiceName+"')\"></a>"+
		"<a href=\"javascript:;\" class=\"del\" id=\"del\"onclick=\"_delServer('"+item.HostServiceName+"',this)\"></a>"+
		"</div><div class=\"tab-moreinfo\">"+float_str+"</div></td>"+
		"</tr>");
	});
}

//绑定账号
function service_account_list_refresh(){
	//绑定账号
	$("#service_account_list").empty();
	if(host.AccountSet == null) host.AccountSet=[];
	$(host.AccountSet).each(function(i,item){
		AccountSet = item;
		//获取 主机、服务
		var server_str = [];
		$(AccountSet.HostServiceSet).each(function(i1,item1){
			if(item1.ProtocolName == null){
				ProtocolName_tmp1 = "未指定";
			}else{
				ProtocolName_tmp1 = item1.ProtocolName;
			}
			if($.inArray(ProtocolName_tmp1+'-'+item1.Port,server_str)<0){
				server_str.push(ProtocolName_tmp1+'-'+item1.Port);
			}
		});
		// server_str = server_str.substr(0,server_str.length-1);
		/*
		if(AccountSet.HostAccount.IsSuperAcct == true)
			$("#IsSuperAcct").iCheck("check");
		else{
			$("#IsSuperAcct").iCheck("uncheck");
		}*/
		if(AccountSet.HostAccount == null){
			a1 = "";
			a2 = "";
			a3 = "";
		}else{
			if(AccountSet.HostAccount.FromAccountName == null){
				a1 = "";
			}else{
				a1 = AccountSet.HostAccount.FromAccountName;
			}
			if(AccountSet.HostAccount.AcctSwitchCmd == null){
				a2 = "";
			}else{
				a2 = AccountSet.HostAccount.AcctSwitchCmd;
			}
			if(AccountSet.HostAccount.SwitchPasswdPrompt == null){
				a3 = "";
			}else{
				a3 = AccountSet.HostAccount.SwitchPasswdPrompt;
			}
		}
		var float_str =  "<p>切换账号：" +a1+ "</p>" +
		"<p>切换命令："+a2+"</p>"+
		"<p>切换密码提示："+a3+"</p>";
		if(AccountSet.HostAccount.AccountName == null){
			var AccountName = "未指定";
		}else{
			if(AccountSet.HostAccount.AccountName == '*'){
				var AccountName = "*";
			}else if(AccountSet.HostAccount.AccountName == '-'){
				var AccountName = "-";
			}else{
				var AccountName = AccountSet.HostAccount.AccountName;
			}
		}
		var server_array = [];
		$.each(AccountSet.HostServiceSet,function(i1,item1){
			server_array.push(item1.ProtocolName);
		})
		var flag_ser = 0;
		var ser_str = server_array.join(',');
		$.each(server_array,function(i,item){
			$.each(SUP_PROTOCOL,function(i2,item2){
				if(item == item2){
					flag_ser = 1;
					return false;
				}
			})
		})
		var psdType;
		if(item.Password == null && item.PasswordType != 2 || item.PasswordType == 0 || item.PasswordType == 3){
			psdType = "未保存";
			flag_ser = 0;
		}else{
			psdType = "已保存";
			flag_ser = 1;
		}
		if(item.PasswordType == 3){
			AuthType = "密钥";
		}else{
			AuthType = "密码";
		}
		if(AccountSet.HostAccount == null){
			return false;
		}
		if(item.IsClearText == true){
			pwd_tmp = "";
		}else{
			pwd_tmp = item.Password;
		}
		if(flag_ser == 1){
			if(AccountSet.HostAccount.IsSuperAcct == true){
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td style=\"color:red;\" id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog2('edit',this,'"+pwd_tmp+"')\"></a><a href=\"javascript:;\" class=\"icon2\" onclick=\"_getDialog_connectTest('"+AccountSet.HostAccount.AccountId+"','"+ser_str+"');\" ></a><a href=\"javascript:;\" class=\"del\" id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}	else{
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\"  id=\"edit\"onclick=\"_getDialog2('edit',this,'"+pwd_tmp+"')\"></a><a href=\"javascript:;\" class=\"icon2\" onclick=\"_getDialog_connectTest('"+AccountSet.HostAccount.AccountId+"','"+ser_str+"');\" ></a><a href=\"javascript:;\" class=\"del\"  id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}
		}else if(flag_ser == 0){
			if(AccountSet.HostAccount.IsSuperAcct == true){
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td style=\"color:red;\" id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\" id=\"edit\" onclick=\"_getDialog2('edit',this,'"+pwd_tmp+"')\"></a><a href=\"javascript:;\" class=\"icon2 disabled\"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}	else{
				$("#service_account_list").append("<tr id=\"acc_"+(i+1)+"\"><td id = \""+AccountSet.HostAccount.AccountId+"\">"+AccountName+"</td><td>"+psdType+"</td><td>"+server_str.join(',').replace(/-/g,'')+"</td><td>"+AuthType+"</td><td><div class=\"tab-ctr\"><a href=\"javascript:;\" class=\"edit\"  id=\"edit\"onclick=\"_getDialog2('edit',this,'"+pwd_tmp+"')\"></a><a href=\"javascript:;\" class=\"icon2 disabled\"></a><a href=\"javascript:;\" class=\"del\"  id=\"del\" onclick=\"_delAccount("+item.PasswordAuthId+",this,1)\"></a></div><div class=\"tab-moreinfo\">"+float_str+"</div></td></td></tr>");
			}				
		}
	});
}
//主机相关信息
function nameCheck(obj){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check')

	if(nameReg.test(val)){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}

function ipCheck(obj){
	var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

	var val = $(obj).val().trim();
	var $i = $(obj).next('i.v-check')

	if(hostIPReg.test(val)){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}
var DomainName_list =[];
var connparm_list = [];
function init_host(){
	//获取初始信息
	//获取协议
	// $.ajax({
	// 	url:'/bhost/get_protocol_list',
	// 	type: "post",
	// 	async:true,
	// 	cache:false,
	// 	data: {a0:$("input[name=se]").val(),a1:1,a2:null,a3:null,a4:',,',a5:null},
	// 	success: function(Result) {
	// 		proto_list = JSON.parse(Result);
	// 		$("#ProtocolName").empty();
	// 		$("#ProtocolName").append("<option value=\"\" data=\"\">请选择</option>");
	// 		$.each(proto_list.data,function(i,item){		
	// 			$("#ProtocolName").append("<option value=\""+item.ProtocolId+"\" data=\""+item.Port+"\">"+item.ProtocolName+"</option>");
	// 		})	
	// 	}
	// })
	// $("#ProtocolName").unbind().bind("change",function(){
	// 	$("#Port").val($("#ProtocolName option:selected").attr("data"));
	// 	if($("#ProtocolName").val() == ""){
	// 		$("#connparam").hide();
	// 	}else{
	// 		$("#connparam").show();
	// 			//获取 连接参数
	// 			bind_Conn_xSelect(this);
	// 			$("#ConnParamName").data('value','');
	// 			//$("#")
	// 	}
	// })
	//$("#ProtocolName").change();

	//获取 全局策略
	$.ajax({
		url: '/bhost/get_globalstrategy',
		type: "post",
		async: false,
		cache: false,
		data: { a0: $("input[name=se]").val() },
		success: function (Result) {
			GlobalStartegy = JSON.parse(Result);
		}
	})
	//获取 AD域
	$.ajax({
		url:'/bhost/get_DomainName_list',
		type: "post",
		async:true,
		cache:false,
		data: {a0:$("input[name=se]").val()},
		success: function(Result) {
			DomainName_list = (JSON.parse(Result)).data;
			// $("#DomainName").val('');
			/*
			$("#DomainName").empty();
			$("#DomainName").append("<option value=\"\">请选择</option>");
			$.each(DomainName_list,function(i,item){		
				$("#DomainName").append("<option value=\""+item.DomainId+"\">"+item.DomainName+"</option>");
			})	*/
		}
	})
	
	//获取 来源主机 、来源服务、来源账号
	$.ajax({
		url:'/bhost/get_fromhost',
		type: "post",
		async:true,
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:usercode},
		success: function(Result) {
			fromhost_list = JSON.parse(Result);
			$("#FromHostName").empty();
			$("#FromHostName").append("<option value=\"\">请选择</option>");
			$.each(fromhost_list, function (i, item) {
				$("#FromHostName").append("<option value=\"" + item.HostId + "\" title=\"" + item.HostName + "("+item.HostIP+") \">" + item.HostName + "(" + (item.HostIP) + ")</option>");
			})
		}
	})
	$("#AccIpType").unbind().bind("change",function(){
		if($("#AccIpType").val() == 1){
			$("#acc_ip").hide();
		}else if($("#AccIpType").val() == 2){
			$("#acc_ip").show();
		}
	})	
	$("#FromHostName").unbind().bind("change",function(){
		var FromHostServiceName_list = []
		var FromAccountName_list=[];
		var host_id=$(this).val();
		$.ajax({
			url:'/bhost/get_FromHostServiceName',
			type: "post",
			async:false,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:host_id,a2:usercode},
			success: function(Result) {
				result = JSON.parse(Result)
				FromHostServiceName_list = result.ServiceSet;
				FromAccountName_list = result.AccountSet;
				$("#FromHostServiceName").empty();
				$("#FromHostServiceName").append("<option value=\"\">请选择</option>");
				var pro_id = $("#ProtocolName").data('value');
				$.each(FromHostServiceName_list,function(i,item){
					if(item.ProtocolId == pro_id){
						$("#FromHostServiceName").append("<option value=\""+item.HostServiceId+"\">"+item.HostServiceName+"</option>");
					}
				})	
				//$("#FromHostServiceName").select2();
			}
		})
		
		$("#FromHostServiceName").change(function(){
			var FromHostService_name = $("#select2-FromHostServiceName-container").text();
			$("#FromAccountName").empty();
			$("#FromAccountName").append("<option value=\"\">请选择</option>");
			$.each(FromAccountName_list,function(i,item){
				AccountName = item.HostAccount.AccountName;
				if(AccountName == "*"){
					AccountName = "*";
				}else if(AccountName == "-"){
					AccountName = "-";
				}
				AccountId = item.HostAccount.AccountId;
				HostServiceSet = item.HostServiceSet;
				$.each(HostServiceSet,function(i1,item1){
					if(FromHostService_name == item1.HostServiceName){
						$("#FromAccountName").append("<option value=\""+AccountId+"\">"+AccountName+"</option>");
					}
				
				})
			})
			$("#FromAccountName").select2();
		})
		$("#FromHostServiceName").change();
	})
	//$("#FromHostName").change();
	//bind_IP_xSelect();
	bind_accip_select();
	bind_in_ip();
	bind_Acc_xSelect();
	bind_SSHkey_xSelect();
	//获取 所有的账号
	$.ajax({
		url:'/bhost/get_account',
		type: "post",
		async:true,
		cache:false,
		data: {a0:$("input[name=se]").val()},
		success: function(Result) {
			result = JSON.parse(Result)
			account_list = result.data;
			$.each(account_list,function(i,item){
				if(item.AccountType == 0){
					item.AccountName = "*";
				}else if(item.AccountType == 2){
					item.AccountName = "-";
				}
			})
		}
	})
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
	
	$("#if_emptypwd").unbind().on('ifChanged', function(event){
		var t = $(this).prop("checked");
		var a = $("#AccountName").find('span').text();
		//if(a == "*"){
			/*$("#password1").prop("disabled",false);
			$("#password2").prop("disabled",false);
			$("#password1").val("");
			$("#password2").val("");
			$("#if_emptypwd").iCheck('uncheck');
			$("#if_emptypwd").iCheck('enable');*/
		//}else{
			if( t == true){
				$("#password1").val("");
				$("#password2").val("");
				$("#password1").prop("disabled",true);
				$("#password2").prop("disabled",true);
			}else{
				$("#password1").prop("disabled",false);
				$("#password2").prop("disabled",false);
			}
		//}
	})
	$('.form-select').select2();
	get_DeviceType();
	$("a.btn-submit").unbind().bind("click",function(){
		save_data_host();
	});
	$("a.btn-cancel").unbind().bind("click",function(){
		document.frm.tasktype.value = 3;
		document.frm.se.value = sess;
		document.frm.action = '/bhost/index';
		document.frm.i10.value = 0;
		document.frm.submit();
	});
	$("#host_type").change(function(){
		host_type = $("#host_type option:selected").attr('_icon');
		_SwitchCmd = $("#host_type option:selected").attr('_SwitchCmd');
		_SwitchPasswdPrompt = $("#host_type option:selected").attr('_SwitchPasswdPrompt');
		DeviceTypeId = $(this).val();
		$("#host_icon i").each(function(){
			if(host_type == $(this).attr("data")) $(this).show();
			else $(this).hide();
		})
		//服务模板
		$(device_list).each(function(i,item){
			if(item.DeviceTypeId == DeviceTypeId){
				def_server_list = item.ServiceSet;
				return false;
			}
		})
		$('#service_list').empty();
		$('#service_account_list').empty();
		if(flag_service_empty == true) {
			host.ServiceSet = [];
			host.AccountSet = [];
		}
		
	})
	$("#host_type").change();
	/*$('#timeSet').on('ifChecked', function(event){
	  $('#timeSetSpan').show();
	}).on('ifUnchecked', function(event){
	  $('#timeSetSpan').hide();
	});*/
}
var _SwitchCmd = "";
var _SwitchPasswdPrompt = "";
var accIP_nomal="";

//绑定客户端集合
var ConnParamData;
var conn_index_all;
function binding_Conn(obj) {
	if($(obj).data('value') == "" || $(obj).data('value') == '-1'){
		ConnParamData = []
	}else{
		$.ajax({
			url: '/bhost/get_ConnParam_list',
			type: "post",
			async: false,
			cache: false,
			data: { a0: $("input[name=se]").val(), a1: $(obj).data('value') },
			success: function (Result) {
				ConnParamData = (JSON.parse(Result)).data;
			}
		});
	}
}
function bind_Conn_xSelect(obj){
	binding_Conn(obj);
	var conn_array = [{
				'value':-1,
				'name':'请选择'
			}];
	conn_index_all = [-1];
	var btn_tmp = [];
	var protocol_set = ['RDP','SSH','SFTP','ORACLE','MSSQL','MYSQL','HTTP(S)','TELNET','VNC','FTP','X11','RADMIN','SYBASE','DB2','RLOGIN','PCANY','TN5250'];
	if($.inArray($(obj).find('span').text(), protocol_set) != -1){
		btn_tmp = [
			{
				'name':'新增',
				'event': function(items,obj){
					$('.'+$('.xSelect_connList .xSelect-show').data('id')).hide();
					_addNew(obj,0);
				}
			}
		];
	}
	$.each(ConnParamData,function(i,item){
		conn_index_all.push(item.ConnParamId);
		if($.inArray(item.ConnParamId,conn_arr)>=0){
			return true;
		}
		if(_if_disable == '2'){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'edit'
			};
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'check'
			};
		}
		select_data_json.value = item.ConnParamId;
		select_data_json.name = item.ConnParamName;
		conn_array.push(select_data_json);
	});
	$("#ConnParamName").empty().data('xSelect','');
	$("div[data-id=xSelect-connparam]").remove();
	if(_if_disable == '2'){
		$('#ConnParamName').xSelect({
			width: 132,
			defaultText: '请选择',
			items:conn_array,
			module_type:'connparam',
			edit: function(item,obj){
				$('.'+$('.xSelect_connList .xSelect-show').data('id')).hide();
				_addNew(obj,1);
			},
			btn:btn_tmp,
			setval:function(item,obj){
			}
		});
		$("#ConnParamName").data('value','-1');
	}else{
		$('#ConnParamName').xSelect({
			width: 132,
			defaultText: '请选择',
			items:conn_array,
			module_type:'connparam',
			check: function(item,obj){
				$('.'+$('.xSelect_connList .xSelect-show').data('id')).hide();
				_addNew(obj,1);
			},
			setval:function(item,obj){
			}
		});
		$("#ConnParamName").data('value','-1');
	}
}
			//<input id="ConnParamName" type="text" style="width: 100px" class="form-text"  _id="" placeholder="输入连接参数" onkeyup="_autoView(this,0,0)" onfocus="_autoView(this,0,0)" onblur="_hideView(0,this);">
			//		get_accIP();
//协议
var proto_list;
function get_protocol_list(){
	$.ajax({
		url:'/bhost/get_protocol_list',
		type: "post",
		async:false,
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:1,a2:null,a3:null,a4:',,',a5:null},
		success: function(Result) {
			proto_list = JSON.parse(Result);		
		}
	});
}	
function clear_protocol(){
	$("#protoDialog").find('input').val('');
	$("#Protocol_Name0").attr('disabled',false);	
}
var protocol_id;
function _editNode1(obj,type){
	clear_protocol();
	var title;
	if (type == 1) {//
		protocol_id = $(obj).children('span').data('value');
		title = "协议";
	} else if (type == 2) {
		protocol_id = 0;
		title = "协议";
	}
	var $dialogCont = $("#protoDialog").show();
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "protoDialog",
		width: "1000px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	protocol_main(type);
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		clear_protocol();
		protocol_main(type);
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		save_pro(d);
	})
}
function protocol_main(type){
	$("#Port1").parent().parent().hide();
	$("#Port0").unbind().on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	$("#Port1").unbind().on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	if(type == 1){
		$.ajax({
			url:'/bhost/select_protocol',
			type:"post",
			async:false,
			data:{a0:$("input[name=se]").val(),x1:protocol_id},
			success:function(result){
				protdata = JSON.parse(result);
				$.each(protdata.data,function(i,item){
					if(item.ProtocolName=="PCANY")
					{
						$("#Port1").parent().parent().show();
						$("#Port1").val(item.Port1);
					}
					$("#Protocol_Name0").val(item.ProtocolName);
					$("#Port0").val(item.Port);
					$("#Description0").val(item.Description);
					$("#Protocol_Name0").attr("disabled",true);
				});
			}
		});
	}
}
function nameCheck(name){
	var flag=true;
	$.ajax({
		url:'/bhost/select_name',
		type: "post",
		async:false,
		data: {a0:$("input[name=se]").val(),x1:name},
		success:function(result){
			data = parseInt(result);
			if (data !=0){
				flag=false;
			}
		}
	});
	return flag;
}
function save_pro(d){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-]+$/;
	var ProtocolName = $("#Protocol_Name0").val();
	var des = $("#Description0").val();
	var Port = $("#Port0").val();
	if ($("#Port1").is(":visible")){
		var Port1 = $("#Port1").val();
	}else{
		var Port1 = "0";
	}
	
	if(ProtocolName == ""){
		_alert(2,"协议","请输入名称",$("#Protocol_Name0"));	
		return false;
	}
	var len = 0;
	if (des != ""){
		for (var i = 0; i < des.length; i++) {
		   if (des.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null){ //全角 
				len += 2; 
			}else{
				len += 1; 
			}
		}
		if(len >= 255){
			_alert(1,"协议","描述内容过长",$("#Description0"));
			return false;                   
		}
	}
	if(Port == ""){
		_alert(1,"协议","请输入端口",$("#Port0"));
		return false;
	}
	
	if(Port1 == ""){
		_alert(1,"协议","请输入端口",$("#Port1"));
		return false;
	}
	//检查输入框格式
	if(!nameReg.test(ProtocolName) && ProtocolName != 'HTTP(S)'){
		_alert(1,"协议","名称格式不正确",$("#Protocol_Name0"));
		return false;
    }
	if (protocol_id == 0){
		if(nameCheck(ProtocolName)==false){
			_alert(1,"协议","相同名称已存在",$("#Protocol_Name0"));
			return false;
		}
	}
	var datalist = [];
	var dataP='{"ProtocolId":'+protocol_id+',"ProtocolName":"'+ProtocolName+'","Port":'+Port+',"Port1":'+Port1+',"Description":"'+des+'"}';
	datalist.push(dataP);
	var msstr = aceg(JSON.stringify(datalist),$("input[name=se]").val());
	$.ajax({
		url:'/bhost/set_protocol',
		type: "post",
		async:false,
		data: {a0:$("input[name=se]").val(),x1:JSON.stringify(datalist),a10:"运维管理>主机管理",m1:msstr},
		success:function(result){
			data = JSON.parse(result);
			if (data.Result){
				$('.btn').blur();
				_alert(0,"协议","保存成功");
				var pro_text = $('#ProtocolName').find('span').text();
				var pro_value = $("#ProtocolName").data('value');			
				$("div[data-id=xSelect-protocol]").remove();
				$('#ProtocolName').empty().data('xSelect','');
				bind_protocol_select();
				if (pro_value == "-1" || pro_value == undefined){
					$("#ProtocolName").data('value',data.ProtocolId);
					$("#ProtocolName").find('span').text(ProtocolName);
					$("#Port").val(Port);
				}else{
					$("#ProtocolName").data('value',pro_value);
					$('#ProtocolName').find('span').text(pro_text);
					if(protocol_id == pro_value){
						$("#Port").val(Port);
					}
				}
				d.close().remove();
			}else{
				_alert(1,"协议","执行失败：" + data.ErrMsg);
			}
		}
	});
}

function change_isacc(obj){
	//
	if($(obj).val() == 0){
		if($("#ProtocolName").find('span').text() == "RDP"){
			$("#div_inip").hide();
		}else{
			$("#div_inip").show();
		}
	}else{	
		$("#div_inip").show();
	}
}
var ProtocolName_old=-1;
function bind_protocol_select(){
	get_protocol_list();
	var protocol_array = [{
			'value':-1,
			'name':'请选择'
		}];
	$.each(proto_list.data,function(i,item){
		if(_if_disable == '2'){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'edit'
			};
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'check'
			};
		}		
		select_data_json.value = item.ProtocolId;
		select_data_json.name = item.ProtocolName;
		protocol_array.push(select_data_json);
	});
	$('#ProtocolName').empty().data('xSelect',"");
	$('div[data-id=xSelect-protocol]').remove();
	if(_if_disable == '2'){
		$('#ProtocolName').xSelect({
			width: 132,
			defaultText: '请选择',
			items:protocol_array,
			module_type:'protocol',
			edit: function(item,obj){
				$(obj).parents('.xSelect-view').hide();
				_editNode1(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_editNode1(obj,2);
					}
				}
			],
			setval:function(item,obj){
				sel_id = $(obj).find('span').data('value');		
				if(sel_id!=ProtocolName_old){
					$('#conn_cont a.ctrl.del').click();
				}
				ProtocolName_old=sel_id;
				bind_Conn_xSelect($("#ProtocolName"));
				pName_change();
				$.each(proto_list.data,function(i,item){
					if (sel_id == item.ProtocolId){
						$("#Port").val(item.Port);
						if(item.ProtocolName == "SSH"){
							$('#same_sftp').show();
							$('#same_sftp_check').iCheck('check');
						}else{
							$('#same_sftp').hide();
						}
						if(item.ProtocolName == "RDP" ){
							$('#_div_isacc').show();
						}else{
							$('#_div_isacc').hide();
							//$("#div_inip").hide();
						}
						if($("#IsAcc").val() == 0){
							if($("#ProtocolName").find('span').text() == "RDP" ){
								$("#div_inip").hide();
							}else{
								$("#div_inip").show();
							}
						}else{	
							$("#div_inip").show();
						}
						return false;
					}
				});
				var ProtocolId_arr=[9,10,11,12,16,17,18];
				if($.inArray(sel_id,ProtocolId_arr)>=0){
					$('#div_conn').hide();
				}else{
					$('#div_conn').show();
				}
			}
		});
	}
	else{
		$('#ProtocolName').xSelect({
			width: 132,
			defaultText: '请选择',
			items:protocol_array,
			module_type:'protocol',
			check: function(item,obj){
				$(obj).parents('.xSelect-view').hide();
				_editNode1(obj,1);
			},
			setval:function(item,obj){
				sel_id = $(obj).find('span').data('value');		
				bind_Conn_xSelect($("#ProtocolName"));
				pName_change();
				$.each(proto_list.data,function(i,item){
					if (sel_id == item.ProtocolId){
						$("#Port").val(item.Port);
						if(item.ProtocolName == "SSH"){
							$('#same_sftp').show();
							$('#same_sftp_check').iCheck('check');
						}else{
							$('#same_sftp').hide();
						}
						return false;
					}
				});
			}
		});
	}
	$("#ProtocolName").data('value','-1');
}
	//绑定应用发布IP
var accIP_nomal="";
var accIP_list;
function get_accIP(){
	//获取accIP
	$.ajax({
		url:'/bhost/get_accIP',
		type: "post",
		async:false,
		cache:false,
		data: {a0: $("input[name=se]").val()},
		success: function(Result) {
			accIP_list = JSON.parse(Result);
		}
	})
}

var in_ip_list = [];
function bind_in_ip(){
	var option_str = "";
	$.each(accIP_list.data,function(i,item){
		if (item.IsBuildin){
			in_ip_list.push(item);
			option_str = option_str + '<option value="'+item.AccIPId+'">'+item.AccIPId+'</option>';
		}
	});
	$("#in_ip").empty().append(option_str);
}
function bind_accip_select(){
	get_accIP();
	var accip_array = [{
			'value':-1,
			'name':'请选择'
		}];
	acc_index_all = [];
	$.each(accIP_list.data,function(i,item){
		acc_index_all.push(item.AccIPId);
		if (manager_arry.indexOf(item.AccIPId) > 0){
			return true;
		}
		if(_if_disable == '2'){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'delete'
			};
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2'
			};
		}
		if (item.IsBuildin){
			return true;
		}
		select_data_json.value = item.AccIPId;
		select_data_json.name = item.AccIP;
		accip_array.push(select_data_json);	
	});
	$('#accIP').empty().data('xSelect',"");
	$('div[data-id=xSelect-accIP]').remove();
	if(_if_disable == '2'){
		$('#accIP').xSelect({
			width: 138,
			defaultText: '请选择',
			items:accip_array,
			module_type:'accIP',
			delete:function(item,obj){
				del_accip(obj);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_editaccIP(obj);
					}
				}
			]
		});
		$("#accIP").data('value','-1');
	}else{
		$('#accIP').xSelect({
			width: 138,
			defaultText: '请选择',
			items:accip_array,
			module_type:'accIP',
			delete:function(item,obj){
				del_accip(obj);
			}
		});
		$("#accIP").data('value','-1');
	}
}
function _editaccIP(){
	$("#accip_input").val('');
	var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

	var $dialogCont = $("#ConnIPDialog").show();
	var title = '应用发布IP';
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"ConnIPDialog",
		width:"780px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(7);
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var acc_ip = $("#accip_input").val();
		if(acc_ip == ""){
			_alert(2, title, '请输入应用发布IP');
			return false;
		}else{
			if (!hostIPReg.test(acc_ip)) {
				_alert(1, title, "应用发布IP格式不正确");
				return false;
			};
		}
		var flag_1 = 0;
		$.each(accIP_list.data,function(i,item){
			if(item.AccIP == acc_ip){
				_alert(1, title, '相同的应用发布IP已存在');
				flag_1 = 1;
				return false;
			}
		})
		if(flag_1 == 1){
			return false;
		}
		save_accip(acc_ip,d);
	});
}

//保存应用发布IP
function save_accip(ip,obj){
	var jsondata = {
		"AccIPId": 0,
		"AccIP": ""
	}
	jsondata.AccIP = ip;
	var msstr = aceg(JSON.stringify(jsondata),se);
	$.ajax({
		url:'/bhost/save_acc_ip',
		type:"POST",
		async:false,
		data:{a0: $("input[name=se]").val(),a1: JSON.stringify(jsondata),a10:"运维管理>主机管理",m1:msstr},
		//contentType: 'application/json',
		success: function(Result) {
			var data = JSON.parse(Result);
			if(data.Result){
				var result_id = data.AccIPId
				_alert(0,"应用发布IP","保存成功");
				obj.close().remove();
				var accIP_text = $("#accIP").find('span').text();
				var accIP_Id = $("#accIP").find('span').data('value');
				bind_accip_select();
				if (accIP_Id == "-1" || accIP_Id == undefined){
					$("#accIP").data('value',result_id);
					$("#accIP").find('span').text(ip);
				}else{
					$("#accIP").find('span').text(accIP_text);
					$("#accIP").data('value',accIP_Id);
				}
				return false;
			}else{
				_alert(1,"应用发布",data.ErrMsg);
				return false;
			}
		}
	})
}
function del_accip(obj){
	var id = $(obj).find('span').data('value');
	var sel_id = $("#accIP").data('value');
	var accip_str = $(obj).find('span').text();
	$(document)[0].onclick = null;
	$.ajax({
		url:'/bhost/del_acc_ip',
		type:'post',
		async:false,
		data:{a0: $("input[name=se]").val(),a1:id,a10:"运维管理>主机管理"},
		success:function(result){
			var result = JSON.parse(result);
			if (result.Result == true){
				$(obj).remove();
				acc_index_all.splice($.inArray(id, acc_index_all), 1);
				$.each(accIP_list.data,function(i,item){
					if (id == item.AccIPId){
						accIP_list.data.splice(i,1);
						return false;
					}
				})
				if (id == sel_id){
					$("#accIP").data('value','-1');
					$("#accIP").find('span').text('请选择');
				}
				//删除目前主机中配置的被删除应用发布
				$.each(host.ServiceSet,function(i,item){
					$.each(item.AccIPSet,function(i1,item1){
						if(item1.AccIP == accip_str){
							item.AccIPSet.splice(i1,1);
							return false;
						}
					})
				})
				$.each($("#service_list").find('tr'),function(i,item){
					accip_tmp_array = $(item).children('td').eq(3).text().split(',');
					$.each(accip_tmp_array,function(i1,item1){
						if(item1 == accip_str){
							accip_tmp_array.splice(i1,1);
						}
					})
					$(item).children('td').eq(3).text(accip_tmp_array.join(','));
				})
				//
				return;
			}else{
				_alert(1, "主机",result.ErrMsg);
				return;
			}
		}
	})
}	
			// 	<span class="ss" style="position:static;padding-bottom: 20px;">
			// 	<input id="select_accIP" type="text" style="width:110px;" class="form-text"  _id="" placeholder="输入应用发布IP" onkeyup="_autoView(this,3,3)" onfocus="_autoView(this,3,3,0)" onblur="_hideView(3,this);">
			// </span>
//绑定账号
var AccountData;
var acc_index_all;
function binding_Acc() {
	$.ajax({
		url: '/bhost/get_account',
		type: "post",
		async: false,
		//cache: false,
		data: { a0: $("input[name=se]").val() },
		success: function (Result) {
			result = JSON.parse(Result)
			AccountData = result.data;
			$.each(AccountData, function (i, item) {
				if (item.AccountType == 0) {
					item.AccountName = "*";
				} else if (item.AccountType == 2) {
					item.AccountName = "-";
				}
			})
		}
	});
}

function bind_Acc_xSelect_z(){
	binding_Acc();
	var acc_array = [{
			'value':5,
			'name':'*'

		},{
			'value':6,
			'name':'-'

		}];
	acc_index_all = [{
			'value':5,
			'name':'*'

		},{
			'value':6,
			'name':'-'

		}];
		$.each(AccountData,function(i,item){
			if(item.AccountId != 5 && item.AccountId != 6){
				if(item.AccountId < 8){
					var select_data_json = {
						'value':1,
						'name':'admin2',
					};
					select_data_json.value = item.AccountId;
					select_data_json.name = item.AccountName;
					acc_array.push(select_data_json);
					acc_index_all.push(item.AccountId);					
				}else{
					if(_if_disable == '2'){
						var select_data_json = {
							'value':1,
							'name':'admin2',
							'type':'edit'
						};
					}else{
						var select_data_json = {
							'value':1,
							'name':'admin2',
							'type':'check'
						};
					}
					select_data_json.value = item.AccountId;
					select_data_json.name = item.AccountName;
					acc_array.push(select_data_json);
					acc_index_all.push(item.AccountId);
				}
			}
		});
	$("#AccountName_z").empty().data('xSelect','');
	if(_if_disable == '2'){
		$('#AccountName_z').xSelect({
			width: 159,
			defaultText: '请选择',
			items:acc_array,
			module_type:'account_z',
			edit: function(item,obj){
				$('.'+$('.xSelect_AccList .xSelect-show').data('id')).hide();
				_addNew1(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_addNew1(obj,0);
					}
				}
			],
			setval:function(item,obj){
				var t = $("#AccountName_z").children().find('span').text();
				if( t == "*"){
					$("#password1_z").prop("disabled",true);
					$("#password2_z").prop("disabled",true);
					$("#if_emptypwd_z").iCheck('uncheck');
					$("#if_emptypwd_z").iCheck('disable');
				}else{
					$("#password1_z").prop("disabled",false);
					$("#password2_z").prop("disabled",false);
					$("#if_emptypwd_z").iCheck('uncheck');
					$("#if_emptypwd_z").iCheck('enable');
				}
			}
		});
	}else{
		$('#AccountName_z').xSelect({
			width: 159,
			defaultText: '请选择',
			items:acc_array,
			module_type:'account_z',
			check: function(item,obj){
				$('.'+$('.xSelect_AccList .xSelect-show').data('id')).hide();
				_addNew1(obj,1);
			},
			setval:function(item,obj){
				var t = $("#AccountName_z").children().find('span').text();
				if( t == "*"){
					$("#password1_z").prop("disabled",true);
					$("#password2_z").prop("disabled",true);
					$("#if_emptypwd_z").iCheck('uncheck');
					$("#if_emptypwd_z").iCheck('disable');
				}else{
					$("#password1_z").prop("disabled",false);
					$("#password2_z").prop("disabled",false);
					$("#if_emptypwd_z").iCheck('uncheck');
					$("#if_emptypwd_z").iCheck('enable');
				}
			}
		});
	}
}	

function bind_Acc_xSelect(){
	binding_Acc();
	var acc_array = [{
			'value':5,
			'name':'*'
		},{
			'value':6,
			'name':'-'
		}];
	acc_index_all = [{
			'value':5,
			'name':'*'
		},{
			'value':6,
			'name':'-'
		}];
		$.each(AccountData,function(i,item){
			if(item.AccountId != 5 && item.AccountId != 6){
				if(item.AccountId < 8){
					var select_data_json = {
						'value':1,
						'name':'admin2',
					};
					select_data_json.value = item.AccountId;
					select_data_json.name = item.AccountName;
					acc_array.push(select_data_json);
					acc_index_all.push(item.AccountId);					
				}else{
					if(_if_disable == '2'){
						var select_data_json = {
							'value':1,
							'name':'admin2',
							'type':'edit'
						};
					}else{
						var select_data_json = {
							'value':1,
							'name':'admin2',
							'type':'check'
						};
					}
					select_data_json.value = item.AccountId;
					select_data_json.name = item.AccountName;
					acc_array.push(select_data_json);
					acc_index_all.push(item.AccountId);
				}
			}
		});
	$("#AccountName").empty().data('xSelect','');
	$("div[data-id=xSelect-account]").remove();
	if(_if_disable == '2'){
		$('#AccountName').xSelect({
			width: 142,
			defaultText: '请选择',
			items:acc_array,
			module_type:'account',
			edit: function(item,obj){
				$('.'+$('.xSelect_AccList .xSelect-show').data('id')).hide();
				_addNew1(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_addNew1(obj,0);
					}
				}
			],
			setval:function(item,obj){
				var t = $("#AccountName").children().find('span').text();
				if( t == "#"){
					$("#authType").prop("disabled",true);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('disable');	
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",true);
					$("#password2").prop("disabled",true);
				}else{
					$("#authType").prop("disabled",false);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('enable');
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",false);
					$("#password2").prop("disabled",false);
				}
			}
		});
	}else{
		$('#AccountName').xSelect({
			width: 142,
			defaultText: '请选择',
			items:acc_array,
			module_type:'account',
			check: function(item,obj){
				$('.'+$('.xSelect_AccList .xSelect-show').data('id')).hide();
				_addNew1(obj,1);
			},
			setval:function(item,obj){
				var t = $("#AccountName").children().find('span').text();
				if( t == "#"){
					$("#authType").prop("disabled",true);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('disable');	
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",true);
					$("#password2").prop("disabled",true);					
				}else{
					$("#authType").prop("disabled",false);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('enable');
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",false);
					$("#password2").prop("disabled",false);					
				}
			}
		});
	}
}

//绑定密钥
var SSHkeyData;
var SSHkey_index_all;
function binding_SSHkey() {
	$.ajax({
		url: '/bhost/get_sshkey_host',
		type: "post",
		async: false,
		cache: false,
		data: { a0: $("input[name=se]").val() },
		success: function (Result) {
			result = JSON.parse(Result)
			SSHkeyData = result.info.data;
		}
	});
}	

function bind_SSHkey_xSelect(){
	binding_SSHkey();
	var ssh_array = [{
		'value':-1,
		'name':'请选择'
	}];
	SSHkey_index_all = [];
	$.each(SSHkeyData,function(i,item){
		if(_if_disable == '2'){
			if(item.IfValid == true){
				var select_data_json = {
					'value':1,
					'name':'admin2'
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'type':'edit'
				};
			}
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'check'
			};
		}
		select_data_json.value = item.SshKeyId;
		select_data_json.name = item.KeyName;
		ssh_array.push(select_data_json);
		SSHkey_index_all.push(item.SshKeyId);
	});
	$("#SSHkey_s").empty().data('xSelect','');
	if(_if_disable == '2'){
		$('#SSHkey_s').xSelect({
			width: 142,
			defaultText: '请选择',
			items:ssh_array,
			module_type:'SSHkey_s',
			edit: function(item,obj){
				$('.'+$('.xSelect_SSHkey .xSelect-show').data('id')).hide();
				_addNew3(obj,1);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_addNew3(obj,0);
					}
				}
			],
			setval:function(item,obj){
			}
		});
	}else{
		$('#SSHkey_s').xSelect({
			width: 142,
			defaultText: '请选择',
			items:ssh_array,
			module_type:'SSHkey_s',
			check: function(item,obj){
				$('.'+$('.xSelect_SSHkey .xSelect-show').data('id')).hide();
				_addNew3(obj,1);
			},
			setval:function(item,obj){
			}
		});
	}
}

	// <span class="g-tsel" onclick="g_tsel(this)" id="g-tsel_account" style="margin-left: 10px;">
	// 			<input style="width: 127px; margin-left: -10px;" type="text" class="form-text " placeholder="选择账号" onkeyup="_autoView(this,2,2)" onfocus="_autoView(this,2,2)" onblur="_hideView(1,this);" id="AccountName" name = "">
	// 	</span>

//添加 服务
//服务 浮层
var old_pro_name='';
var old_prot=0;
function _getDialog1(type,name){
	old_prot=0;
	old_pro_name='';
	HostServiceName_id_arr=new Array();
	if(type == 'add'){
		serverID = 0;
		ServerIndex=-1;
	}else{
		serverID = name;
	}
	if($('#host_type').val() == ""){
		_alert(2,'添加服务','请先选择设备类型');
		return false;
	}
	bind_protocol_select();
	clear_server();
	$('#LineBreak').select2('destroy').select2({minimumResultsForSearch: -1});

	$('#item_server').show();
	$('#def_server').empty();
	$('#def_server').unbind();
	$('#def_server').append('<option value="" >请选择</option>');
	$(def_server_list).each(function(i,item){
		$('#def_server').append('<option value="'+item.DeviceServiceId+'" >'+item.DeviceServiceName+'</option>');
	})
	$('#def_server').select2('destroy').select2();
	$('#def_server').change(function(){
		show_def_server($(this).val());
	})
	$('#def_server').change();

	if(type == 'edit'){
		_editServer(name);
	}else{
	}
	pName_change(1);
	var $dialogCont = $("#scDCTab1").show();
	if(type == 'edit'){
		title = '服务';
	}else{
		title = '服务';
	}
	if(GlobalStartegy.AccIPSet != null){
		$("#accIP_cont").hide();
		$("#accIP_cont1").show();
	}else{
		$("#accIP_cont").show();
		$("#accIP_cont1").hide();
	}
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"scDCTab1",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	var old_n = $("#HostServiceName").val();
	
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(2);
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if(_addServer(type,old_n) == false) return false;
		d.close().remove();
	})
}

function show_def_server(DeviceServiceId) {
	var def_server = [];
	$(def_server_list).each(function (i, item) {
		if (DeviceServiceId == item.DeviceServiceId) {
			def_server = item;
			return false;
		}
	})
	if (def_server.length == 0) {
		clear_server();
		return false;
	}
	$("#HostServiceName").val(def_server.DeviceServiceName);
	$("#ProtocolName").data('value',def_server.ProtocolId);
	$("#ProtocolName").find('span').text(def_server.ProtocolName);
	bind_Conn_xSelect($("#ProtocolName"));
	if(def_server.ConnParamId != null){
		$("#ConnParamName").data('value',def_server.ConnParamId);
		$("#ConnParamName").find('span').text(def_server.ConnParamName);		
	}
	$("#Port").val(def_server.Port);
	//
	//$("#DomainName").val(def_server.DomainId).trigger("change");
	//
	$("#FromHostName").val(def_server.FromHostId).trigger("change");
	$("#FromHostServiceName").val(def_server.FromHostServiceId).trigger("change");
	$("#FromAccountName").val(def_server.FromAccountId).trigger("change");

	$("#FromLoginCmd").val(def_server.FromLoginCmd);
	$("#NormalPrompt").val(def_server.NormalPrompt);
	$("#SuperPrompt").val(def_server.SuperPrompt);
	$("#AcctSwitchCmd").val(_SwitchCmd);
	$("#SwitchPasswdPrompt").val(_SwitchPasswdPrompt);
	$("#LoginUserPrompt").val(def_server.LoginUserPrompt);
	$("#LoginPasswdPrompt").val(def_server.LoginPasswdPrompt);
	$("#LoginSuccPrompt").val(def_server.LoginSuccPrompt);
	$("#ExtraPrompt").val(def_server.ExtraPrompt);
	$("#ExtraReply").val(def_server.ExtraReply);
	$("#LineBreak").val(def_server.LineBreak == null ? "1" : def_server.LineBreak).trigger('change');
	//get_accIP();
	if(def_server.ProtocolName == "RDP" ){
		$("#_div_isacc").show();
	}else{
		$("#_div_isacc").hide();
		//$("#div_inip").hide();
	}
	if(def_server.IsAcc == null) def_server.IsAcc = 0;
	$("#IsAcc").val(def_server.IsAcc).trigger("change");
	
	if($("#IsAcc").val() == 0){
		if($("#ProtocolName").find('span').text() == "RDP" ){
			$("#div_inip").hide();
		}else{
			$("#div_inip").show();
		}
	}else{	
		$("#div_inip").show();
	}
	//绑定应用发布ip
	accIP_select_tmp = [];
	if (def_server.AccIPSet != null && def_server.AccIPSet != []){
		for (var i1 = def_server.AccIPSet.length; i1 > 0; i1--){
			var v = def_server.AccIPSet[i1-1].AccIPId;
			var t = def_server.AccIPSet[i1-1].AccIP;
			var type = def_server.AccIPSet[i1-1].IsBuildin;

			manager_arry.push(v);
			if (i1 != 1){
				$("#accIP_type").val(2).trigger('change');
				$("#accIP").data('value',v);
				$("#accIP").find('span').text(t);
				$('#add4').click();
			}else{
				if (!type){
					$("#accIP_type").val(2).trigger('change');
					$("#accIP").data('value',v);
					$("#accIP").find('span').text(t);
				}else{
					$("#accIP_type").val(1).trigger('change');
					$("#in_ip").val(v).trigger('change');
				}
			}			
		}
	}else{
		$("#accIP").data('value','-1');
		$("#accIP").find('span').text('请选择');
	}
}
var ServiceSet = {
		"HostServiceId": 0,
		"HostServiceName": "", 
		"ProtocolId": 0,                          
		"Port": 0,
		"ConnParamId": 0,    
		// "DomainId": null,   
		"FromHostServiceId": 0,
		"FromAccountId": 0,
		"FromLoginCmd": null,        
		"NormalPrompt": null,           
		"SuperPrompt": null,
		"AcctSwitchCmd": null,
		"SwitchPasswdPrompt": null,
		"LoginUserPrompt": null,           
		"LoginPasswdPrompt": null,
		"LoginSuccPrompt": null,  
		"ExtraPrompt": null, 
		"ExtraReply": null,            
		"LineBreak": null,        
		"AccIPSet": [
		],
		"IsAcc":0
	}
var ServerIndex = -1;
function init_server(){
	ServiceSet=
	{
		"HostServiceId": 0,
		"HostServiceName": "", 
		"ProtocolId": 0,                          
		"Port": 0,
		"ConnParamId": 0,    
		// "DomainId": null,   
		"FromHostServiceId": 0,
		"FromAccountId": 0,
		"FromLoginCmd": null,        
		"NormalPrompt": null,           
		"SuperPrompt": null,
		"AcctSwitchCmd": null,
		"SwitchPasswdPrompt": null,
		"LoginUserPrompt": null,           
		"LoginPasswdPrompt": null,
		"LoginSuccPrompt": null,  
		"ExtraPrompt": null, 
		"ExtraReply": null,            
		"LineBreak": null,        
		"AccIPSet": [
		]        
	}
}
function _addServer(type,o_name){
	//
	$('.'+$('.xSelect_connList .xSelect-show').data('id')).hide();
	$('.'+$('.xSelect-accIP .xSelect-show').data('id')).hide();
	ProtocolId = $("#ProtocolName").data('value');
	if (ProtocolId == "" || ProtocolId == "-1") {
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
		_alert(2,title,"请选择协议");
		return false;
	}
	Port = $("#Port").val();
	if(Port == ""){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
		_alert(2,title,"请输入端口",$("#Port"));
		return false;
	}
	
	if(parseInt(Port)<=0 || parseInt(Port) >=65535){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
		_alert(2,title,"协议端口在0~65535之间",$("#Port"));
		return false;
	}
	var n = 0;
	$(host.ServiceSet).each(function(i,item){
		if((ProtocolId == item.ProtocolId && Port == item.Port) && (item.ProtocolName!=old_pro_name || item.Port!=old_prot)){
			$('#autoView').hide();
			$('.g-tsel').removeClass('on');
			_alert(2,title,'相同的配置已存在');
			n=1;
			return false;
		}
		if(item.ProtocolName==old_pro_name && item.Port==old_prot){
			return false;
		}
	})
	if(n) return false;
	// ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
	if(type == 'add') ServiceSet.HostServiceId = 0;
	// else ServiceSet.HostServiceId = ServiceSet.HostServiceId;
	ServiceSet.ProtocolId = parseInt($("#ProtocolName").data('value'));
	ServiceSet.ProtocolName =  $("#ProtocolName").find('span').text();
	ServiceSet.Port = parseInt($("#Port").val());
	if($("#FromHostName").val() == ""){
		ServiceSet.FromHostId = null;
	}else{
		ServiceSet.FromHostId = parseInt($("#FromHostName").val());		
	}
	if($("#FromHostServiceName").val() == ""){
		ServiceSet.FromHostServiceId = null;
	}else{
		ServiceSet.FromHostServiceId = parseInt($("#FromHostServiceName").val());
	}
	if($("#FromAccountName").val() == ""){
		ServiceSet.FromAccountId = null;
	}else{
		ServiceSet.FromAccountId = parseInt($("#FromAccountName").val());		
	}
	ServiceSet.FromLoginCmd = $("#FromLoginCmd").val();
	ServiceSet.NormalPrompt = $("#NormalPrompt").val();
	ServiceSet.SuperPrompt = $("#SuperPrompt").val();
	ServiceSet.AcctSwitchCmd = $("#AcctSwitchCmd").val();
	ServiceSet.SwitchPasswdPrompt = $("#SwitchPasswdPrompt").val();
	ServiceSet.LoginUserPrompt = $("#LoginUserPrompt").val();
	ServiceSet.LoginPasswdPrompt = $("#LoginPasswdPrompt").val();
	ServiceSet.LoginSuccPrompt = $("#LoginSuccPrompt").val();
	ServiceSet.ExtraPrompt= $("#ExtraPrompt").val();
	ServiceSet.ExtraReply = $("#ExtraReply").val();
	ServiceSet.LineBreak = parseInt($("#LineBreak").val());
	
	if($("#ProtocolName").find('span').text() == "RDP" ){
		ServiceSet.IsAcc = parseInt($("#IsAcc").val());
	}else{
		ServiceSet.IsAcc = 0;
	}
	
	ServiceSet.AccIPSet = [];
	var accip_list = [];
	var accip_name = [];
	if(($("#ProtocolName").find('span').text() == "RDP"  && ServiceSet.IsAcc !=0) || ($("#ProtocolName").find('span').text() != "RDP")){
		if ($("#accIP_cont").children('div:first').find('select:first').val() == 1){//內置
			var id = $("#accIP_cont").children('div:first').children('div:eq(1)').find('select').val();
			accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\"\"}");
			ServiceSet.AccIPSet.push(accIP_json);
			accip_list.push(id);
		}else{//外置
			var id = $("#accIP_cont").children('div:first').children('div:eq(2)').data('value');
			if (id != undefined && id != "-1"){
				var name = $("#accIP_cont").children('div:first').children('div:eq(2)').find('span').text();
				accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\""+name+"\"}");
				ServiceSet.AccIPSet.push(accIP_json);
				accip_list.push(name);
			}
		}
		
		$("#accIP_cont").children('div:not(:first)').each(function(i,item){
			var id = $(item).children('div:eq(2)').data('value');
			var name = $(item).children('div:eq(2)').find('span').text();
			accIP_json = JSON.parse("{\"AccIPId\":"+id+",\"AccIP\":\""+name+"\"}");
			ServiceSet.AccIPSet.push(accIP_json);
			accip_list.push(name);
		});
		if(ServiceSet.IsAcc == 1 && ($("#ProtocolName").find('span').text() == "RDP")){
			if(accip_list.length == 0){
				_alert(1, title, '请选择应用发布');
				return false;
			}
		}
	}
	
	var float_str = (($("#FromHostName option:selected").text().replace("请选择","")=='')?"":("<p>跳转来源主机："+$("#FromHostName option:selected").text().replace("请选择","")+"</p>"))+ 
		(($("#FromHostServiceName option:selected").text().replace("请选择","")=='')?"":("<p>跳转来源服务："+$("#FromHostServiceName option:selected").text().replace("请选择","")+"</p>"))+ 
		($("#FromAccountName option:selected").text().replace("请选择","")==''?"":("<p>跳转来源账号："+$("#FromAccountName option:selected").text().replace("请选择","")+"</p>"))+ 
		(($("#FromLoginCmd").val()=='')?"":("<p>跳转命令："+$("#FromLoginCmd").val()+"</p>"))+ 
		(($("#NormalPrompt").val()=='')?"":("<p>普通提示符："+$("#NormalPrompt").val()+"</p>"))+ 
		(($("#SuperPrompt").val()=='')?"":("<p>特权提示符："+$("#SuperPrompt").val()+"</p>"))+ 
		(($("#AcctSwitchCmd").val()=='')?"":("<p>账号切换命令："+$("#AcctSwitchCmd").val()+"</p>"))+ 
		(($("#SwitchPasswdPrompt").val()=='')?"":("<p>切换密码提示："+$("#SwitchPasswdPrompt").val()+"</p>"))+ 
		(($("#LoginUserPrompt").val()=='')?"":("<p>登录名提示："+$("#LoginUserPrompt").val()+"</p>"))+ 
		(($("#LoginPasswdPrompt").val()=='')?"":("<p>登录密码提示："+$("#LoginPasswdPrompt").val()+"</p>"))+ 
		(($("#LoginSuccPrompt").val()=='')?"":("<p>登录成功提示："+$("#LoginSuccPrompt").val()+"</p>"))+ 
		(($("#LineBreak option:selected").text()=='')?"":("<p>换行符："+$("#LineBreak option:selected").text()+"</p>"));
	if (type == "add") {
		var ConnParamName_arr=new Array();
		var no_pass=true;
		$.each(host.ServiceSet,function(i,item){
			if(item.ProtocolId==3 && item.Port==ServiceSet.Port){
				no_pass=false;
				return false;
			}
		});
		$('#div_conn div.srsCtl1').each(function(i,item){
			ConnParamId =$(item).find('.xSelect_connList').data('value');
			if(ConnParamId == "" || ConnParamId == "-1" || ConnParamId == undefined){
				ConnParamId = null;
				ConnParamName = '';
				if($('#div_conn div.srsCtl1').length>1){
					return true;
				}
				//return true;
			}else{
				ConnParamName = $(item).find('.xSelect_connList').find('span').text();
			}
			ServiceSet.ConnParamId = ConnParamId;
			ServiceSet.ConnParamName = ConnParamName;
			if(ConnParamName!=''){
				ConnParamName_arr.push(ConnParamName);
				ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
			}else{
				ConnParamName_arr.push(null);
				ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
			}
			ServiceSet.HostServiceId = 0;
			host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
			if(ServiceSet.ProtocolName=='SSH' && $('#same_sftp_check').is(':checked')){
				if(no_pass){
					ServiceSet.ProtocolName='SFTP';
					ServiceSet.ProtocolId=3;
					ServiceSet.FromHostId = null;
					ServiceSet.FromHostServiceId=null;
					ServiceSet.FromAccountId=null;
					ServiceSet.NormalPrompt=null;
					ServiceSet.SuperPrompt=null;
					if(ServiceSet.ConnParamName!=''){
						ServiceSet.HostServiceName=ServiceSet.ProtocolName+ServiceSet.Port+'('+ServiceSet.ConnParamName+')';
					}else{
						ServiceSet.HostServiceName=ServiceSet.ProtocolName+ServiceSet.Port;
					}
					host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
				}
			}
		});
		service_list_refresh();
	}
	else {
		var ConnParamId_arr=[];
		var ConnParam_arr=[];
		var ConnParamName_arr=[];
		var no_pass=false;
		if(ServiceSet.ProtocolName=='SSH' && $('#same_sftp_check').is(':checked')){
			no_pass=true;
			$.each(host.ServiceSet,function(i,item){
				if(item.ProtocolId==3 && item.Port==ServiceSet.Port){
					no_pass=false;
					return false;
				}
			});
		}
		var ConnParamId_arr=[];
		$('#div_conn div.srsCtl1').each(function(i,item){
			var ConnParamId =$(item).find('.xSelect_connList').data('value');
			var ConnParamName = '';
			if(ConnParamId == "" || ConnParamId == "-1" || ConnParamId == undefined){
				ConnParamId = null;
				ConnParamName = '';
				if($('#div_conn div.srsCtl1').length>1){
					return true;
				}
				//return true;
			}else{
				ConnParamName = $(item).find('.xSelect_connList').find('span').text();
			}
			ConnParamId_arr.push(ConnParamId);
			ServiceSet.ConnParamId = ConnParamId;
			ServiceSet.ConnParamName = ConnParamName;
			if(ConnParamName!=''){
				ConnParamId_arr.push(ConnParamId);
				ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
			}else{
				ConnParamId_arr.push(null);
				ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
			}
			var refresh=false;
			$(host.ServiceSet).each(function(i,item){
				if(old_pro_name == item.ProtocolName && old_prot == item.Port && ConnParamId==item.ConnParamId){
					ServiceSet.HostServiceId = item.HostServiceId;
					if(item.ConnParamId==null || item.ConnParamId==''){
						ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
					}else{
						ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
					}
					host.ServiceSet[i]=JSON.parse(JSON.stringify(ServiceSet));
					$(host.AccountSet).each(function(i2,item2){
						HostServiceSet_tmp = item2.HostServiceSet;
						$(HostServiceSet_tmp).each(function(i1,item1){
							if(item1.ProtocolName == old_pro_name && item1.Port==old_prot && ConnParamId==item1.ConnParamId){
								item1.HostServiceName = ServiceSet.HostServiceName;
								item1.ProtocolId = ServiceSet.ProtocolId;
								item1.Port = ServiceSet.Port;
								item1.ConnParamId = ServiceSet.ConnParamId;
								item1.ProtocolName = ServiceSet.ProtocolName;
								item1.ConnParamName = ServiceSet.ConnParamName;
								// num++;
							}
						})
					})
					refresh=true;
					return true;
				}
			});
			if (!refresh){
				ServiceSet.HostServiceId=0;
				if(ConnParamName==''){
					ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port;
				}else{
					ServiceSet.HostServiceName=$("#ProtocolName").find('span').text() + Port + '(' + ConnParamName + ')';
				}
				host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
			}
			if(no_pass){
				ServiceSet.HostServiceId=0;
				ServiceSet.ProtocolName='SFTP';
				ServiceSet.ProtocolId=3;
				ServiceSet.FromHostId = null;
				ServiceSet.FromHostServiceId=null;
				ServiceSet.FromAccountId=null;
				ServiceSet.HostServiceName=ServiceSet.ProtocolName+ServiceSet.Port+'('+ServiceSet.ConnParamName+')';
				host.ServiceSet.unshift(JSON.parse(JSON.stringify(ServiceSet)));
			}
		});
		var num=0;
		$(host.ServiceSet).each(function(i,item){
			if(old_pro_name == item.ProtocolName && old_prot == item.Port && $.inArray(item.ConnParamId,ConnParamId_arr)<0){
				var ConnParamId=item.ConnParamId;
				host.ServiceSet.splice(i-num,1);
				num++;
			}else if(old_pro_name == item.ProtocolName && old_prot == item.Port && $.inArray(item.ConnParamId,ConnParamId_arr)>=0){
				$(host.AccountSet).each(function(i2,item2){
					var num1=0;
					var ConnParamId_AccountSet_arr=null;
					HostServiceSet_tmp=item2.HostServiceSet;
					$(HostServiceSet_tmp).each(function(i1,item1){
						if(item1.ProtocolName == old_pro_name && item1.Port==old_prot){
							if (ConnParamId_AccountSet_arr==null){
								ConnParamId_AccountSet_arr=[]
							}
							ConnParamId_AccountSet_arr.push(item1.ConnParamId);
						}
					})
					if(ConnParamId_AccountSet_arr!=null && $.inArray(item.ConnParamId,ConnParamId_AccountSet_arr)<0){
						var tmp={"HostId": host_id,"HostServiceId": item.HostServiceId,"HostServiceName": item.HostServiceName,"ProtocolName": item.ProtocolName,"ProtocolId": item.ProtocolId,"Port": item.Port,"ConnParamId": item.ConnParamId,"ConnParamName": item.ConnParamName};
						item2.HostServiceSet.push(tmp);
					}
				})
			}
		});
		$(host.AccountSet).each(function(i2,item2){
			var num1=0;
			HostServiceSet_tmp=item2.HostServiceSet;
			$(HostServiceSet_tmp).each(function(i1,item1){
				if(item1.ProtocolName == old_pro_name && item1.Port==old_prot && $.inArray(item1.ConnParamId,ConnParamId_arr)<0){
					item2.HostServiceSet.splice(i1-num1,1);
					num1++;
				}
			})
		})
		service_list_refresh();
		service_account_list_refresh();
	}
	tabArr();
	clear_server();
}

//保存应用发布IP
var manager_arry=['-1'];
var manageradd = 0;
var manager_index = 0;
var manager_value = "";
var conn_arr=['-1'];
function _addconn(obj){
	var connid = $('#ConnParamName').data('value');
	var v = $('#ConnParamName').find('span').text();
	var $c = $(obj).parent().clone();
	$c.unbind();
	if (connid == undefined || connid == '-1'){
		_alert(2, "设备类型", "请选择连接参数");
		return false;
	}
	connid = parseInt(connid);
	if (conn_arr.indexOf(connid) === -1) {
		conn_arr.push(connid);
	}
	
	conn_index_all.splice($.inArray(connid, conn_index_all), 1);
	$(obj).parent().parent().append($c);
	$c.find('select').attr('disabled',true);
	$c.find('.xSelect-show').attr('disabled',true);
	$c.find('span.select2-selection--single').css("background-color","rgb(235, 235, 228)");
	$c.find('a').after('<a class="ctrl del" style="float: left;width: 15px;height: 15px;overflow: hidden;background: url(/manage/images/icon-ctr.png) no-repeat 0 0;margin: 6px 0 0 10px;display: none;background-position: 0 0;cursor: pointer;" onclick="_delconn(this)"></a>').remove();
	$c.find('.xSelect_connList').css("background-color","rgb(235, 235, 228)");
	$c.find('.xSelect_connList').data('value',connid);
	$c.find('select').attr('id',"");
	$c.find('.xSelect_connList').attr('id',"");
	$c.find('.xSelect-show').attr('data-id',"");
	$('#ConnParamName').find('span').text('请选择');
	$('#ConnParamName').data('value',-1);
	$("div[data-id=xSelect-connparam]").children('input').val('');
	$("div[data-id=xSelect-connparam]").find('span[data-value='+connid+']').parent('li').remove();
}
function _delconn(obj){
	var $c = $(obj).prev().children('.xSelect_connList');
	var id = $c.data('value');
	var t = $c.find('span').text();
	var v, data, max;
	var min = 0;
	max = conn_index_all.length - 1;
	data = conn_index_all;
	//$('.ctrl.add').parent('.form-c.srsCtl').show();
	conn_arr.splice($.inArray(id, conn_arr), 1);
	var $p = $("div[data-id=xSelect-connparam]").children('ul');
	$(obj).parent().remove();
	var index_1 = search_i(min, max, parseInt(id), data);
	index_1 = parseInt(index_1);
	if(_if_disable == '1'){
		i_class = '';
	}else{
		i_class = 'edit';
	}
	
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'"  style="">'+t+'</span></li>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.prepend('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'" style="">'+t+'</span></li>');
	} else {
		$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'" style="">'+t+'</span></li>');
	}
	data.splice(index_1, 0, parseInt(id));
}
function _addaccIP(obj){
	var accip_id = $(obj).prev('div').data('value');
	var v = $(obj).prev('div').find('span').text();
	var $c = $(obj).parent().clone();
	if (accip_id == undefined || accip_id == '-1'){
		_alert(2, "设备类型", "请选择应用发布");
		return false;
	}
	accip_id = parseInt(accip_id);
	if (manager_arry.indexOf(accip_id) === -1) {
		manager_arry.push(accip_id);
	}
	acc_index_all.splice($.inArray(accip_id, acc_index_all), 1);
	$(obj).parent().parent().append($c);
	$c.find('select').attr('disabled',true);
	$c.find('span.select2-selection--single').css("background-color","rgb(235, 235, 228)");
	//$c.find('span.select2-selection__arrow').remove();
	$c.find('a').after('<a class="ctrl del" style="cursor: pointer;" onclick="_delIP(this)"></a>').remove();
	$c.find('.form-c').css("background-color","rgb(235, 235, 228)");
	$c.find('.form-c').data('value',accip_id);
	$c.find('select').attr('id',"");
	$c.find('.form-c').attr('id',"");
	$(obj).prev().find('span').text('请选择');
	$(obj).prev().data('value',-1);
	$("div[data-id=xSelect-accIP]").children('input').val('');
	$("div[data-id=xSelect-accIP]").find('span[data-value='+accip_id+']').parent('li').remove();
}

function change_acc_type(obj){
	if ($(obj).val() == 1){
		$(obj).parent().next().show();
		$(obj).parent().next().next().hide();
		$(obj).parent().next().next().next().hide();
		$(obj).siblings('a').hide();
	}else{
		$(obj).parent().next().hide()
		$(obj).parent().next().next().show();
		$(obj).parent().next().next().next().show();
		$(obj).siblings('a').show();
	}
}

function _delIP(obj){
	var $c = $(obj).prev();
	var id = $c.data('value');
	var t = $(obj).prev().find('span').text();
	var v, data, max;
	var min = 0;
	max = acc_index_all.length - 1;
	data = acc_index_all;
	//$('.ctrl.add').parent('.form-c.srsCtl').show();
	manager_arry.splice($.inArray(id, manager_arry), 1);
	var $p = $("div[data-id=xSelect-accIP]").children('ul');
	$(obj).parent().remove();
	var index_1 = search_i(min, max, parseInt(id), data);
	index_1 = parseInt(index_1);
	if(_if_disable == '1'){
		i_class = '';
	}else{
		i_class = 'delete';
	}
	
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'"  style="width:132px">'+t+'</span></li>');
	} else if (index_1 == -2) {
		index_1 = 0;
		//$p.children('li').eq(0).before('<li style=""><i class="delete"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
		$p.prepend('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
	} else {
		$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="'+i_class+'"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
	}
	data.splice(index_1, 0, parseInt(id));
}

//重置数据
function clear_server(){
	accIP_select_tmp=[];
	// ServerIndex = -1;
	$("#HostServiceName").val("");
	$("#Port").val("");
	$("#FromHostName").select2('destroy').select2();
	$("#FromHostName option:eq(0)").prop("selected",true);
	$("#FromHostName").change();

	$("#FromLoginCmd").val("");
	$("#NormalPrompt").val("");
	$("#SuperPrompt").val("");
	$("#AcctSwitchCmd").val("");
	//$("#host_type").change();
	$("#AcctSwitchCmd").val(_SwitchCmd);
	$("#SwitchPasswdPrompt").val(_SwitchPasswdPrompt);
	//alert(_SwitchCmd);
	$("#LoginPasswdPrompt").val("");
	$("#LoginSuccPrompt").val("");
	$("#LoginUserPrompt").val("");
	$("#ExtraPrompt").val("");
	$("#ExtraReply").val("");
	$("#LineBreak").val("1").trigger('change');
	$('#same_sftp').hide();
	//清空应用发布
	bind_protocol_select();
	bind_Conn_xSelect($("#ProtocolName"));
	$('#div_conn').show();
	init_server();
	$("#AccIpType").val('1').trigger('change');
	accipid_list = [];
	$('#mod_btn_server').hide();
	$('#add_btn_server').show();

	manager_arry=['-1'];
	conn_arr=['-1'];
	manageradd = 0;
	manager_index = 0;
	manager_value = "";
	$("#accIP_type").val(2).trigger('change');
	bind_accip_select();
	$("#accIP_cont").children('div:not(:first)').remove();	
	$("#conn_cont").children('div:not(:first)').remove();	
	$("#_div_isacc select").val(0).trigger('change');
	$("#_div_isacc").hide();
	$("#div_inip").show();
}
var accIP_select_tmp=[];
var accIP_list = [];
var accipid_list = ['-1'];

function _delaccIP(obj) {
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var t = $(obj).siblings('input').val();
	var v, data, max;
	var min = 0;
	max = ip_index_all.length - 1;
	data = ip_index_all;
	$("#select_accIP").show();
	accipid_list.splice($.inArray(id, accipid_list), 1);
	var $p = $("div[data-id=xSelect-IPlist]").children('ul');
	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('li').eq(0).before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
	} else {
		$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:132px">'+t+'</span></li>');
	}
	data.splice(index_1, 0, parseInt(id));
	$c.remove();
}
function search_i(min, max, id, data) {
	var mid, res;
	if (data[max] < id) {
		return -1;
	}
	if (data[min] > id) {
		return -2;
	}
	while (min <= max) {
		mid = parseInt((min + max) / 2);
		if (data[mid] > id) {
			max = mid - 1;
			res = mid;
		} else {
			min = mid + 1;
		}
	}
	return res;
}

function set_select(obj){
	if ($(obj).children('option').length == 2){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}
}
var HostServiceName_id_arr=[];
//编辑 服务列表数据绑定
function _editServer(Name){
	// clear_server();
	$("#add_btn_server").hide();
	$("#mod_btn_server").show();
	$(host.ServiceSet).each(function(i,item){
		if(Name == item.HostServiceName){
			ServerIndex = i;
			ServiceSet = JSON.parse(JSON.stringify(item));
			$("#HostServiceName").val(item.HostServiceName);
			if(item.ProtocolName == null){
				ProtocolId_tmp = -1;
				ProtocolName_tmp = "请选择";
			}else{
				ProtocolId_tmp = item.ProtocolId;
				ProtocolName_tmp = item.ProtocolName;
			}
			$("#ProtocolName").data('value',ProtocolId_tmp);
			$("#ProtocolName").find('span').text(ProtocolName_tmp);
			var ProtocolId_arr=[9,10,11,12,16,17,18];
			if($.inArray(ProtocolId_tmp,ProtocolId_arr)>=0){
				$('#div_conn').hide();
			}else{
				$('#div_conn').show();
			}			
			old_prot=item.Port;
			old_pro_name=item.ProtocolName;
			if(item.ProtocolId==2){
				$('#same_sftp').show();
				$('#same_sftp_check').iCheck('check');
			}
			bind_Conn_xSelect($("#ProtocolName"));
			HostServiceName_id_arr=new Array();
			for(var i1=0;i1<=host.ServiceSet.length-1;i1++){
				var item1=host.ServiceSet[i1];
				if (item1.ProtocolId==item.ProtocolId && item1.Port==item.Port){
					HostServiceName_id_arr.push(item1.HostServiceId);
					if(item1.ConnParamName != null && item1.ConnParamName != ""){
						$("#ConnParamName").find('span').text(item1.ConnParamName);
						$("#ConnParamName").data('value',item1.ConnParamId);			
						$('#add5').click();
					}
				}
			}
			$("#Port").val(item.Port);
			if(item.FromHostId == ""){
				$("#FromHostName").val("").trigger("change");
			}else{
				$("#FromHostName").val(item.FromHostId).trigger("change");
			}
			
			if(item.FromHostServiceId == ""){
				$("#FromHostServiceName").val("").trigger("change");
			}else{
				$("#FromHostServiceName").val(item.FromHostServiceId).trigger("change");
			}
			
			if(item.FromAccountId == ""){
				$("#FromAccountName").val("").trigger("change");
			}else{
				$("#FromAccountName").val(item.FromAccountId).trigger("change");
			}
			//
			$("#FromLoginCmd").val(item.FromLoginCmd);
			$("#NormalPrompt").val(item.NormalPrompt);
			$("#SuperPrompt").val(item.SuperPrompt);
			$("#AcctSwitchCmd").val(item.AcctSwitchCmd);
			$("#SwitchPasswdPrompt").val(item.SwitchPasswdPrompt);
			$("#LoginUserPrompt").val(item.LoginUserPrompt);
			$("#LoginPasswdPrompt").val(item.LoginPasswdPrompt);
			$("#LoginSuccPrompt").val(item.LoginSuccPrompt);
			$("#ExtraPrompt").val(item.ExtraPrompt);
			$("#ExtraReply").val(item.ExtraReply);
			$("#LineBreak").val(item.LineBreak==null?1:item.LineBreak).trigger('change');;
			
			if(item.ProtocolName == "RDP") $("#_div_isacc").show();
			else $("#_div_isacc").hide();
			if(item.IsAcc == null) item.IsAcc = 0;			
			$("#IsAcc").val(item.IsAcc).trigger("change");
			
			//绑定应用发布ip
			var inid = 0;
			if (item.AccIPSet != null){
				for (var i1 = item.AccIPSet.length; i1 > 0; i1--){
					manager_arry.push(item.AccIPSet[i1-1].AccIPId);
					if (i1 != 1){
						if (item.AccIPSet[i1-1].AccIP != "" && item.AccIPSet[i1-1].AccIP != "2.2.2.2"){
							$("#accIP_type").val(2).trigger('change');
							$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
							$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
							$('#add4').click();
						}
					}else{
						if (item.AccIPSet[i1-1].AccIP != "" && item.AccIPSet[i1-1].AccIP != "2.2.2.2"){
							$("#accIP_type").val(2).trigger('change');
							$("#accIP").data('value',item.AccIPSet[i1-1].AccIPId);
							$("#accIP").find('span').text(item.AccIPSet[i1-1].AccIP);
						}else{
							$("#accIP_type").val(1).trigger('change');
							$("#in_ip").val(item.AccIPSet[i1-1].AccIPId).trigger('change');
						}
					}
				}
			}
		}
	})

}
function _delServer(Name,obj){
	var pro_value=$(obj).parents('tr').children('td').eq(1).text();
	var pro_value_arr=[pro_value]
	layer.open({
		type:1,
		title:"删除服务",
		content:'<div class="layer-alert"><i class="alert warning"></i>确定删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			layer.close(i);
			if(pro_value.split('(')[0]=='SSH' ){
				var pro_value_other=pro_value.replace('SSH','SFTP');
				var has_sftp=false;
				$(host.ServiceSet).each(function (i, item) {
					if (pro_value_other == (item.ProtocolName+'('+item.Port+')')) {
						has_sftp=true;
						return false;
					}
				})
				if (has_sftp){
					layer.open({
						type:1,
						title:"删除服务",
						content:'<div class="layer-alert"><i class="alert warning"></i>是否同步删除SFTP</div>',
						btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
						btnAlign:'c',
						closeBtn: false,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						btn1:function(i){
							layer.close(i);
							pro_value_arr.push(pro_value_other);
							var flag_n = 0;//防止多个确认窗口重复弹出
							$(host.AccountSet).each(function (i, item) {
								if(flag_n == 1){
									return false;
								}
								$(item.HostServiceSet).each(function (i1, item1) {
									if(flag_n == 1){
										return false;
									}
									// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
									if(item1.ProtocolName == null){
										ProtocolName_tmp1 = "未指定";
									}else{
										ProtocolName_tmp1 = item1.ProtocolName;
									}
									if ($.inArray((ProtocolName_tmp1+'('+item1.Port+')'),pro_value_arr)>=0) {
										flag_n = 1;
										layer.open({
											type: 1,
											title: "主机管理",
											content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
											btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
											btnAlign: 'c',
											closeBtn: false,
											skin: 'layer-custom',
											area: ['380px', '310px'],
											move: false,
											resize: false,
											btn1: function (i) {
												layer.close(i);
												//删除AccountSet 中的相关数据，并将下方相关账号删除。
												var num=0;
												$(host.AccountSet).each(function (i2, item2) {
													$(item2.HostServiceSet).each(function (i3, item3) {
														if(item3.ProtocolName == null){
															ProtocolName_tmp1 = "未指定";
														}else{
															ProtocolName_tmp1 = item3.ProtocolName;
														}
														if ($.inArray((ProtocolName_tmp1+'('+item3.Port+')'),pro_value_arr)>=0) {
														// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
															host.AccountSet.splice(i2-num,1);
															num++
															return true;
														}
													})
												})
												//ServiceSet 中的相关数据
												var num=0;
												$(host.ServiceSet).each(function (i2, item2) {
													// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
													if(item2.ProtocolName == null){
														ProtocolName_tmp1 = "未指定";
													}else{
														ProtocolName_tmp1 = item2.ProtocolName;
													}
													if ($.inArray((ProtocolName_tmp1+'('+item2.Port+')'),pro_value_arr)>=0) {
														host.ServiceSet.splice(i2-num, 1);
														num++;
														// return false;
													}
												})
												flag_n = 1;
												$(obj).parent().parent().parent().remove();
												clear_server();
												service_list_refresh();
												service_account_list_refresh();
											},
											btn2: function (i) {
												layer.close(i);
												flag_n = 1;
												return false;
											}
										});
									}
								})
								
							})
							if(flag_n == 0){
								//ServiceSet 中的相关数据
								var num=0;
								$(host.ServiceSet).each(function (i, item) {
									if(item.ProtocolName == null){
										ProtocolName_tmp1 = "未指定";
									}else{
										ProtocolName_tmp1 = item.ProtocolName;
									}
									if ($.inArray((ProtocolName_tmp1+'('+item.Port+')'),pro_value_arr)>=0) {
									// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
										host.ServiceSet.splice(i-num, 1);
										num++;
										// return false;
									}
								})
								flag_n = 1;
								$(obj).parent().parent().parent().remove();
								clear_server();
								service_list_refresh();
								service_account_list_refresh();
							}
						},
						btn2:function(i){
							layer.close(i);
							var flag_n = 0;//防止多个确认窗口重复弹出
							$(host.AccountSet).each(function (i, item) {
								if(flag_n == 1){
									return false;
								}
								$(item.HostServiceSet).each(function (i1, item1) {
									if(flag_n == 1){
										return false;
									}
									// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
									if(item1.ProtocolName == null){
										ProtocolName_tmp1 = "未指定";
									}else{
										ProtocolName_tmp1 = item1.ProtocolName;
									}
									if ($.inArray((ProtocolName_tmp1+'('+item1.Port+')'),pro_value_arr)>=0) {
										flag_n = 1;
										layer.open({
											type: 1,
											title: "主机管理",
											content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
											btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
											btnAlign: 'c',
											closeBtn: false,
											skin: 'layer-custom',
											area: ['380px', '310px'],
											move: false,
											resize: false,
											btn1: function (i) {
												layer.close(i);
												//删除AccountSet 中的相关数据，并将下方相关账号删除。
												var num=0;
												$(host.AccountSet).each(function (i2, item2) {
													$(item2.HostServiceSet).each(function (i3, item3) {
														if(item3.ProtocolName == null){
															ProtocolName_tmp1 = "未指定";
														}else{
															ProtocolName_tmp1 = item3.ProtocolName;
														}
														if ($.inArray((ProtocolName_tmp1+'('+item3.Port+')'),pro_value_arr)>=0) {

														// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
															host.AccountSet.splice(i2-num,1);
															num++
															return true;
														}
													})
												})
												//ServiceSet 中的相关数据
												var num=0;
												$(host.ServiceSet).each(function (i2, item2) {
													// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
													if(item2.ProtocolName == null){
														ProtocolName_tmp1 = "未指定";
													}else{
														ProtocolName_tmp1 = item2.ProtocolName;
													}
													if ($.inArray((ProtocolName_tmp1+'('+item2.Port+')'),pro_value_arr)>=0) {
														host.ServiceSet.splice(i2-num, 1);
														num++;
														// return false;
													}
												})
												flag_n = 1;
												$(obj).parent().parent().parent().remove();
												clear_server();
												service_list_refresh();
												service_account_list_refresh();
											},
											btn2: function (i) {
												layer.close(i);
												flag_n = 1;
												return false;
											}
										});
									}
								})
								
							})
							if(flag_n == 0){
								//ServiceSet 中的相关数据
								var num=0;
								$(host.ServiceSet).each(function (i, item) {
									if(item.ProtocolName == null){
										ProtocolName_tmp1 = "未指定";
									}else{
										ProtocolName_tmp1 = item.ProtocolName;
									}
									if ($.inArray((ProtocolName_tmp1+'('+item.Port+')'),pro_value_arr)>=0) {
									// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
										host.ServiceSet.splice(i-num, 1);
										num++;
										// return false;
									}
								})
								flag_n = 1;
								$(obj).parent().parent().parent().remove();
								clear_server();
								service_list_refresh();
								service_account_list_refresh();
							}
						}
					})
				}
				else{
					var flag_n = 0;//防止多个确认窗口重复弹出
					$(host.AccountSet).each(function (i, item) {
						if(flag_n == 1){
							return false;
						}
						$(item.HostServiceSet).each(function (i1, item1) {
							if(flag_n == 1){
								return false;
							}
							// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
							if(item1.ProtocolName == null){
								ProtocolName_tmp1 = "未指定";
							}else{
								ProtocolName_tmp1 = item1.ProtocolName;
							}
							if ($.inArray((ProtocolName_tmp1+'('+item1.Port+')'),pro_value_arr)>=0) {
								flag_n = 1;
								layer.open({
									type: 1,
									title: "主机管理",
									content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
									btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
									btnAlign: 'c',
									closeBtn: false,
									skin: 'layer-custom',
									area: ['380px', '310px'],
									move: false,
									resize: false,
									btn1: function (i) {
										layer.close(i);
										//删除AccountSet 中的相关数据，并将下方相关账号删除。
										var num=0;
										$(host.AccountSet).each(function (i2, item2) {
											$(item2.HostServiceSet).each(function (i3, item3) {
												if(item3.ProtocolName == null){
													ProtocolName_tmp1 = "未指定";
												}else{
													ProtocolName_tmp1 = item3.ProtocolName;
												}
												if ($.inArray((ProtocolName_tmp1+'('+item3.Port+')'),pro_value_arr)>=0) {
												// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
													host.AccountSet.splice(i2-num,1);
													num++
													return true;
												}
											})
										})
										//ServiceSet 中的相关数据
										var num=0;
										$(host.ServiceSet).each(function (i2, item2) {
											// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
											if(item2.ProtocolName == null){
												ProtocolName_tmp1 = "未指定";
											}else{
												ProtocolName_tmp1 = item2.ProtocolName;
											}
											if ($.inArray((ProtocolName_tmp1+'('+item2.Port+')'),pro_value_arr)>=0) {
												host.ServiceSet.splice(i2-num, 1);
												num++;
												// return false;
											}
										})
										flag_n = 1;
										$(obj).parent().parent().parent().remove();
										clear_server();
										service_list_refresh();
										service_account_list_refresh();
									},
									btn2: function (i) {
										layer.close(i);
										flag_n = 1;
										return false;
									}
								});
							}
						})
						
					})
					if(flag_n == 0){
						//ServiceSet 中的相关数据
						var num=0;
						$(host.ServiceSet).each(function (i, item) {
							if(item.ProtocolName == null){
								ProtocolName_tmp1 = "未指定";
							}else{
								ProtocolName_tmp1 = item.ProtocolName;
							}
							if ($.inArray((ProtocolName_tmp1+'('+item.Port+')'),pro_value_arr)>=0) {
							// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
								host.ServiceSet.splice(i-num, 1);
								num++;
								// return false;
							}
						})
						flag_n = 1;
						$(obj).parent().parent().parent().remove();
						clear_server();
						service_list_refresh();
						service_account_list_refresh();
					}
				}
			}
			else{
				var flag_n = 0;//防止多个确认窗口重复弹出
				$(host.AccountSet).each(function (i, item) {
					if(flag_n == 1){
						return false;
					}
					$(item.HostServiceSet).each(function (i1, item1) {
						if(flag_n == 1){
							return false;
						}
						// if (pro_value == (item1.ProtocolName+'('+item1.Port+')')) {
						if(item1.ProtocolName == null){
							ProtocolName_tmp1 = "未指定";
						}else{
							ProtocolName_tmp1 = item1.ProtocolName;
						}
						if ($.inArray((ProtocolName_tmp1+'('+item1.Port+')'),pro_value_arr)>=0) {
							flag_n = 1;
							layer.open({
								type: 1,
								title: "主机管理",
								content: '<div class="layer-alert"><i class="alert warning"></i>该服务已配置账号，是否删除</div>',
								btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
								btnAlign: 'c',
								closeBtn: false,
								skin: 'layer-custom',
								area: ['380px', '310px'],
								move: false,
								resize: false,
								btn1: function (i) {
									layer.close(i);
									//删除AccountSet 中的相关数据，并将下方相关账号删除。
									var num=0;
									$(host.AccountSet).each(function (i2, item2) {
										$(item2.HostServiceSet).each(function (i3, item3) {
											if(item3.ProtocolName == null){
												ProtocolName_tmp1 = "未指定";
											}else{
												ProtocolName_tmp1 = item3.ProtocolName;
											}
											if ($.inArray((ProtocolName_tmp1+'('+item3.Port+')'),pro_value_arr)>=0) {
											// if (pro_value == (item3.ProtocolName+'('+item3.Port+')')) {
												host.AccountSet.splice(i2-num,1);
												num++
												return true;
											}
										})
									})
									//ServiceSet 中的相关数据
									var num=0;
									$(host.ServiceSet).each(function (i2, item2) {
										// if (pro_value == (item2.ProtocolName+'('+item2.Port+')')) {
										if(item2.ProtocolName == null){
											ProtocolName_tmp1 = "未指定";
										}else{
											ProtocolName_tmp1 = item2.ProtocolName;
										}
										if ($.inArray((ProtocolName_tmp1+'('+item2.Port+')'),pro_value_arr)>=0) {
											host.ServiceSet.splice(i2-num, 1);
											num++;
											// return false;
										}
									})
									flag_n = 1;
									$(obj).parent().parent().parent().remove();
									clear_server();
									service_list_refresh();
									service_account_list_refresh();
								},
								btn2: function (i) {
									layer.close(i);
									flag_n = 1;
									return false;
								}
							});
						}
					})
					
				})
				if(flag_n == 0){
					//ServiceSet 中的相关数据
					var num=0;
					$(host.ServiceSet).each(function (i, item) {
						if(item.ProtocolName == null){
							ProtocolName_tmp1 = "未指定";
						}else{
							ProtocolName_tmp1 = item.ProtocolName;
						}
						if ($.inArray((ProtocolName_tmp1+'('+item.Port+')'),pro_value_arr)>=0) {
						// if (pro_value == (item.ProtocolName+'('+item.Port+')')) {
							host.ServiceSet.splice(i-num, 1);
							num++;
							// return false;
						}
					})
					flag_n = 1;
					$(obj).parent().parent().parent().remove();
					clear_server();
					service_list_refresh();
					service_account_list_refresh();
				}
			}
		},
		btn2:function(i){
			layer.close(i);
		}
	})
}
//添加账号
//账号 浮层
function _getDialog2(type,obj,o_pwd){
	accountID2 = o_pwd;
	if(type == "edit"){
		accountID = $(obj).parents('tr').index();
	}else{
		accountID = -1;
	}
	var acc_id = $(obj).parent().parent().siblings().eq(0).attr('id');//账号ID
	var acc_server = $(obj).parent().parent().siblings().eq(2).text().split(',');//服务名字
	var index;
	$(host.AccountSet).each(function (i, item) {
		var acc_server_1 = [];
		var flag_tmp = "";
		if(item.HostAccount.AccountId == null){
			flag_tmp = "null"
		}else{
			flag_tmp = item.HostAccount.AccountId;
		}
		if (acc_id == flag_tmp) {
			$(item.HostServiceSet).each(function(i1,item1){
				if($.inArray(item1.ProtocolName+item1.Port,acc_server_1)<0){
					if(item1.ProtocolName == null){
						ProtocolName_tmp1 = "未指定";
					}else{
						ProtocolName_tmp1 = item1.ProtocolName;
					}
				  acc_server_1.push(ProtocolName_tmp1+item1.Port);
				}
				//acc_server_1.push(item1.ProtocolName+item1.Port);
			})
			if(acc_server_1.sort().toString() == acc_server.sort().toString()){
				index = i;
				return false;
			}
		}
	});
	if($('#service_list>tr').length == 0){
		_alert(2,'添加服务','请先添加服务');
		return false;
	}
	
	clear_account();
	$("#server_list").empty();
	var server_list_pro_port=new Array();
	var server_conn=new Array();
	$(host.ServiceSet).each(function (i, item) {
		if(item.ProtocolName == null){
			ProtocolName_tmp1 = "未指定";
		}else{
			ProtocolName_tmp1 = item.ProtocolName;
		}
		if($.inArray(ProtocolName_tmp1+'-'+item.Port,server_list_pro_port)<0){
			server_list_pro_port.push(ProtocolName_tmp1+'-'+item.Port);
			server_conn.push([]);
			if(item.ConnParamName!='' && item.ConnParamName!=null){
				server_conn[$.inArray(ProtocolName_tmp1+'-'+item.Port,server_list_pro_port)].push(item.ConnParamName);
			}
			//server_conn[$.inArray(ProtocolName_tmp1+'-'+item.Port,server_list_pro_port)].push(item.ConnParamName);
			$("#server_list").append("<div class=\"as\"><label><input type=\"checkbox\" id=\"" + item.HostServiceId + "\" proid=\""+item.ProtocolId+"\" proto=\""+ProtocolName_tmp1+"\" port=\""+item.Port+"\" paramid=\""+item.ConnParamId+"\" param=\""+item.ConnParamName+"\" value=\"" + item.HostServiceName + "\" name=\"" + item.HostServiceName + "\" class=\"form-checkbox\" >" +ProtocolName_tmp1+item.Port+ "</label></div>");
			if(ProtocolName_tmp1 == "未指定"){
				//$("#"+item.HostServiceId+"").attr("disabled","disabled");
				//$("#"+item.HostServiceId+"").parent("class",$("#"+item.HostServiceId+"").parent("class")+" disabled");
			}
		}else{
			if(item.ConnParamName!='' && item.ConnParamName!=null){
			  server_conn[$.inArray(ProtocolName_tmp1+'-'+item.Port,server_list_pro_port)].push(item.ConnParamName);
			}
		}
	});
	var $server_list_as=$('#server_list').children('.as');
	$(server_conn).each(function(i,item){
		$server_list_as.eq(i).children('label').attr('title',item);
	});
	$('#server_list').children().find('input[type=checkbox]').on('ifChecked', function(event){
		get_fromacc();
	}).on('ifUnchecked', function(event){
		get_fromacc();
	});
	$('#server_list .form-checkbox').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
	var $dialogCont = $("#scDCTab2").show();
	
	if(type == 'edit'){
		title = '账号';
	}else{
		title = '账号';
	}
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"scDCTab2",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	//绑定服务事件
	$('#server_list input[type=checkbox]').on('ifChecked',function(){
		_checkServerStatus();
	}).on('ifUnchecked',function(){
		_checkServerStatus();
	});	

	var old_accid;	//记录编辑账号之前ID 防止修改服务后ID 改变
	if(type == 'edit'){
		_editAccount(index);
		var ser_for_id = "";
		$("#server_list input:checked").each(function(){
			ser_for_id += $(this).attr("proid");		
		})
		var str_id = $("#AccountName").data('value');
		old_accid = str_id.toString() +'_'+ ser_for_id.toString();
	}

	var create;
	if(o_pwd == undefined || o_pwd == 'undefined'){
		create = true;
	}
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(3);
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if(_addAcount(type,o_pwd,create,old_accid,obj) == false) return false;
		d.close().remove();
	})
}

var SSHKey_flag = false;
function _checkServerStatus(){
	SSHKey_flag = false;
	var other_flag = false;
	$.each($("#server_list").find('input[type=checkbox]'),function(i,item){
		if($(item).prop('checked') == true){
			if($(item).attr('proto') == "SSH" || $(item).attr('proto') == "SFTP"){
				SSHKey_flag = true;
			}else{
				other_flag = true;
			}
		}
	})
	if(other_flag == true){
		SSHKey_flag = false;
	}
	if(SSHKey_flag == true){
		$("#authType").removeAttr('disabled');
		$("#authType").val($("#authType").val()).trigger('change');
		// $("#item_SSHKey").show();
		// $("#item_pwd").hide();
		// $("#item_pwd_con").hide();
		// $("#item_pwd_con").css("width","30%");
		// $("#item_SSHKey").css("width","80%");
	}else{
		$("#authType").val(0).trigger('change');
		$("#authType").attr('disabled','true');
		// $("#item_pwd").show();
		// $("#item_pwd_con").show();
		// $("#item_SSHKey").hide();
		// $("#item_pwd_con").css("width","29%");
		// $("#item_SSHKey").css("width","85%");
	}
}
function auth_change(){
	if($("#authType").val() == 0){
		$("#item_pwd").show();
		$("#item_pwd_con").show();
		$("#item_SSHKey").hide();
		$("#item_pwd_con").css("width","29%");
		$("#item_SSHKey").css("width","66%");
	}else{
		$("#item_SSHKey").show();
		$("#item_pwd").hide();
		$("#item_pwd_con").hide();
		$("#item_pwd_con").css("width","29%");
		$("#item_SSHKey").css("width","66%");
	}
}

function init_account(){
	AccountSet={
		"PasswordAuthId": 0,        
		"Password": null,
		"PasswordType": 0,
		"IsClearText": true,
		"HostServiceSet": [ 
		],
		"HostAccount": {                
			"AccountId": 3,
			"IsSuperAcct": false,
			"IsSameUser": true,
			"FromAccountId": null,
			"AcctSwitchCmd": null, 
			"SwitchPasswdPrompt": null               
		}
	}
}
var AccountIndex = -1;
function _addAcount(type,o_pwd,create,old_accid,obj){
	$('.'+$('.xSelect_AccList .xSelect-show').data('id')).hide();
	if(type == 'add')
		init_account();
	//AccountSet.PasswordAuthId = 0;
	host_id = host.HostId;
	var close_flag = 0;
	$("#server_list input").each(function(){
		if($(this).attr('proid') == "null"){
			_alert(2,"添加账号","存在未指定协议的服务");
			close_flag = 1;
			return false;
		}
	});
	if(close_flag == 1){
		return false;
	}
	//账号
	AccountId = $("#AccountName").data('value');
	if (AccountId == "0" || AccountId == undefined) {			
		_alert(2, title, "请选择账号");
		return false;
	}
	AccountName=$("#AccountName").find('span').text();
	if (AccountId == "") {
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
		_alert(2, title, "请选择账号");
		return false;
	}
	FromAccountId = $("#FromAccount_acc").val();
	
	//密码(密钥)
	if($("#SSHkey_s").is(":visible")){
		AccountSet.Password = "";
		AccountSet.PasswordType = 3;
		AccountSet.SshKeyId = $("#SSHkey_s").data('value');
		if(AccountSet.SshKeyId == -1 || AccountSet.SshKeyId == undefined){
			AccountSet.SshKeyId = null;
		}
		AccountSet.KeyName = $("#SSHkey_s").find('span').text();
		if(AccountSet.KeyName == '请选择'){
			AccountSet.KeyName = "";
		}			
		AccountSet.IsClearText = false;
	}else if ($("#AccountName").find('span').text() == "*") {
	}else if($("#if_emptypwd").prop("checked") == true){
	}else{
		if($("#password1").val() != $("#password2").val()){
			$('#autoView').hide();
			$('.g-tsel').removeClass('on');
			_alert(1,title,"两次密码不一致",$('#password1'));
			return false;
		}
		var pwd_old = o_pwd;
	}
	host_id = host.HostId;
	//获取
	var server_str = "";
	$("#server_list input:checked").each(function(){
		server_str = server_str + $(this).attr('proto')+'-'+$(this).attr('port')+",";	
	})
	server_str = server_str.substr(0,server_str.length-1);
	if($("#server_list input:checked").length<=0){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
		_alert(2,'主机管理','请选择服务');
		return false;
	}
	//判断 是否存在相同的服务 相同的账号
	var check_same_account = [];
	$(host.AccountSet).each(function(i,item){
		account_tmp = item.HostAccount.AccountId;
		server_tmp = item.HostServiceSet;
		var ProtocolName_Port=[];
		$(server_tmp).each(function(i1,item1){
			if($.inArray(item1.ProtocolName+item1.Port,ProtocolName_Port)<0){
				check_same_account.push(account_tmp + ":" + item1.ProtocolName+item1.Port);
				ProtocolName_Port.push(item1.ProtocolName+item1.Port);
			}
		})
	})
	var server_listtmp = server_str.split(',');
	
	if(type == 'edit'){
		//剔除当前 自己的账号和服务
		var acc_server = $(obj).parent().parent().siblings().eq(2).text().split(',');//服务名字
		$(server_listtmp).each(function(i,item){
			item=item.replace('-','');
			if(acc_server.indexOf(item) <0) return true;
			index = check_same_account.indexOf(AccountId + ":" + item);
			if(index >=0 )
				check_same_account.splice(index,1);
		})
	}
	var k = false;
	$(server_listtmp).each(function(i,item){
		item=item.replace('-','');
		if(check_same_account.indexOf(AccountId + ":" + item) >=0){
			k = true;
			return false;
		}
	})
	if(k){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
		_alert(1,'主机管理','相同的服务和账号已存在');
		return false;
	}
	
	//获取 主机、服务
	AccountSet.HostServiceSet = [];
	var ser_for_id = "";		//用于创建账号时的账号ID
	$("#server_list input:checked").each(function(){
		var ProtocolName=$(this).attr("proto");
		var Protocolid=$(this).attr("proid");
		var Port=$(this).attr("port");
		$(host.ServiceSet).each(function(i,item){
			if(item.ProtocolName==ProtocolName && item.ProtocolId==Protocolid && item.Port==Port){
				tmp = {"HostId": host_id,"HostServiceId": item.HostServiceId,"HostServiceName": item.HostServiceName,"ProtocolName": item.ProtocolName,"ProtocolId": item.ProtocolId,"Port": item.Port,"ConnParamId": item.ConnParamId,"ConnParamName": item.ConnParamName};
				AccountSet.HostServiceSet.push(JSON.parse(JSON.stringify(tmp)));		
			}
		});
	})
	//密码
	if($("#SSHkey_s").is(":visible")){
		AccountSet.Password = "";
		AccountSet.PasswordType = 3;
		AccountSet.SshKeyId = $("#SSHkey_s").data('value');
		if(AccountSet.SshKeyId == -1 || AccountSet.SshKeyId == undefined){
			AccountSet.SshKeyId = null;
		}
		AccountSet.KeyName = $("#SSHkey_s").find('span').text();
		if(AccountSet.KeyName == '请选择'){
			AccountSet.KeyName = "";
		}			
		AccountSet.IsClearText = false;
	}
	else if($("#if_emptypwd").prop("checked") == true){
		AccountSet.Password = "";
		AccountSet.PasswordType = 2;
		AccountSet.IsClearText = false;
		AccountSet.SshKeyId = null;
		AccountSet.KeyName = "";
	}
	else{
		var pwd_old = o_pwd;
		if($("#password1").val() == ''){
			AccountSet.Password = $("#password1").val();
			AccountSet.PasswordType = 0;
			AccountSet.IsClearText = false;
		}else{
			if(pwd_old == $("#password1").val() && pwd_old != ''){
				AccountSet.IsClearText = false;
			}else{
				AccountSet.IsClearText = true;
				if($("#password1").val().length > 64){
					_alert(1, title, "密码不能超过系统限定64位", $("#password1"));
					return false;
				}
			}
			AccountSet.Password = $("#password1").val();
			AccountSet.PasswordType = 1;
		}
		AccountSet.SshKeyId = null;
		AccountSet.KeyName = "";
	}
	host_id = host.HostId;
	
	AccountSet.HostAccount.AccountId = parseInt(AccountId);
	AccountSet.HostAccount.AccountName = AccountName;
	AccountSet.HostAccount.IsSuperAcct = $("#IsSuperAcct").prop("checked");
	AccountSet.HostAccount.IsSameUser = $("#IsSameUser").prop("checked");
	if($('#FromAccount_acc').val() == "" || $('#FromAccount_acc').val() == 0){
		FromAccount_acc = null;
	}else{
		FromAccount_acc = parseInt($('#FromAccount_acc').val());
	}
	AccountSet.HostAccount.FromAccountId = FromAccount_acc;
	AccountSet.HostAccount.AcctSwitchCmd = $("#AcctSwitchCmd_account").val();
	AccountSet.HostAccount.SwitchPasswdPrompt = $("#SwitchPasswdPrompt_account").val();
	sty = "";
	if(AccountSet.HostAccount.IsSuperAcct == true){
		sty = 'color:red';
	}
	if($("#AcctSwitchCmd_account").val() == 'null'){
		AcctSwitchCmd_acc = "";
	}else{
		AcctSwitchCmd_acc = $("#AcctSwitchCmd_account").val();
	}
	if($("#SwitchPasswdPrompt_account").val() == 'null'){
		SwitchPasswdPrompt_acc = "";
	}else{
		SwitchPasswdPrompt_acc = $("#SwitchPasswdPrompt_account").val();
	}

	var float_str = "<p>切换账号：" + $("#FromAccount_acc").children('option:selected').text() + "</p>" +
			"<p>切换命令：" + $("#AcctSwitchCmd_account").val() + "</p>" +
			"<p>切换密码提示：" + $("#SwitchPasswdPrompt_account").val() + "</p>";
	var flag_ser = 0;
	var ser_array = [];
	$("#server_list input:checked").each(function () {
		ser_array.push($(this).attr('proto'));
	})
	$.each(ser_array,function(i,item){
		$.each(SUP_PROTOCOL,function(i2,item2){
			if(item == item2){
				flag_ser = 1;
				return false;
			}
		})
	})
	var psdType;
	if(AccountSet.Password == "" && AccountSet.PasswordType != 2 || AccountSet.PasswordType == 3){
		psdType = "未保存";
		flag_ser = 0;
	}else{
		psdType = "已保存";
		flag_ser = 1;
	}
	var IsSameUser_value=$('#IsSameUser').prop('checked');
	$.each(host.AccountSet,function(i,item){
		
	});
	if(flag_ser == 1){
		if (type == 'add') {
			//导入到列表中
			if(IsSameUser_value){
				host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
			}
			else{
				var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
				var pro_value='';
				var used_pro=new Array();
				$(HostServiceSet_arr).each(function(i,item){
					pro_value=item.ProtocolName+'-'+item.Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						AccountSet.PasswordAuthId=0;
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
						used_pro.unshift(pro_value);
					}else{
						return true;
					}
				})
			}
		}
		else {
			if(create){
				if(IsSameUser_value){
					host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					pro_value=HostServiceSet_arr[0].ProtocolName+'-'+HostServiceSet_arr[0].Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
						used_pro.unshift(pro_value);
					}
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;
							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
				
			}
			else{
				if(IsSameUser_value){
					host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					pro_value=HostServiceSet_arr[0].ProtocolName+'-'+HostServiceSet_arr[0].Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
						used_pro.unshift(pro_value);
					}
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;
							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
				
			}
		}
	}
	else if(flag_ser == 0){
		if (type == 'add') {
			if(IsSameUser_value){
				host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
			}
			else{
				var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
				var pro_value='';
				var used_pro=new Array();
				$(HostServiceSet_arr).each(function(i,item){
					pro_value=item.ProtocolName+'-'+item.Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						AccountSet.PasswordAuthId=0;
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
						used_pro.unshift(pro_value);
					}else{
						return true;
					}
				})
			}
			
		}
		else {
			if(create){
				if(IsSameUser_value){
					host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					pro_value=HostServiceSet_arr[0].ProtocolName+'-'+HostServiceSet_arr[0].Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
						used_pro.unshift(pro_value);
					}
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;
							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
				
			}
			else{
				if(IsSameUser_value){
					host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
				}
				else{
					var HostServiceSet_arr=JSON.parse(JSON.stringify(AccountSet.HostServiceSet));
					var pro_value='';
					var used_pro=new Array();
					pro_value=HostServiceSet_arr[0].ProtocolName+'-'+HostServiceSet_arr[0].Port;
					if($.inArray(pro_value,used_pro)<0){
						AccountSet.HostServiceSet=new Array();
						$(HostServiceSet_arr).each(function(i1,item1){
							if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
								AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
							}
						});
						host.AccountSet[AccountIndex] = JSON.parse(JSON.stringify(AccountSet));
						used_pro.unshift(pro_value);
					}
					$(HostServiceSet_arr).each(function(i,item){
						pro_value=item.ProtocolName+'-'+item.Port;
						if($.inArray(pro_value,used_pro)<0){
							AccountSet.HostServiceSet=new Array();
							AccountSet.PasswordAuthId=0;
							$(HostServiceSet_arr).each(function(i1,item1){
								if(pro_value==(item1.ProtocolName+'-'+item1.Port)){
									AccountSet.HostServiceSet.push(HostServiceSet_arr[i1]);
								}
							});
							host.AccountSet.unshift(JSON.parse(JSON.stringify(AccountSet)));
							used_pro.unshift(pro_value);
						}else{
							return true;
						}
					})
				}
			}
		}
	}
	//
	service_account_list_refresh();
	tabArr();
	//$("#add_btn_account").show();
	//$("#mod_btn_account").hide();
	clear_account();	
}
function clear_account(){
	AccountIndex = -1;
	$("#server_list input[type=checkbox]").each(function(){
		$(this).iCheck("uncheck");
	})
	bind_Acc_xSelect();
	$("#FromAccount_acc").val("0").trigger('change');
	//$("#FromAccount_acc").empty().append("<option value=\"0\">请选择</option>");
	$("#password1").val("");
	$("#password2").val("");
	$("#password1").prop("disabled",false);
	$("#password2").prop("disabled",false);
	$("#if_emptypwd").iCheck('uncheck');
	$("#if_emptypwd").iCheck('enable');
	$("#IsSuperAcct").iCheck("uncheck");
	$("#IsSameUser").iCheck("uncheck");
	//$("#AcctSwitchCmd_account").val("");
	//$("#SwitchPasswdPrompt_account").val("");
	init_account();
	//$('#add_btn_account').show();
	//$('#mod_btn_account').hide();
	$("#AcctSwitchCmd_account").val(_SwitchCmd);
	$("#SwitchPasswdPrompt_account").val(_SwitchPasswdPrompt);
	$('#AccountName').find('span').text('请选择');
	$('#AccountName').data('value',"0");
}
function clear_host_baseinfo(){
	current_path = [];
	$("#HostIP").val("");
	$("#Enabled").iCheck("check");
	$("#EnableLoginLimit").iCheck("uncheck");
	$("#HostName").val("");
	$("#host_type").val("").select2({minimumResultsForSearch: -1}).trigger('change');
	$("#Description").val("");
	$("#speed1").iCheck("check");
	$("#speed2").iCheck("uncheck");
	$("#speed3").iCheck("uncheck");
	$("#step1 div.form-c i").hide();
	$('#server_select').val('0').trigger('change');
	$('#filterWW1>ul').empty();
	$("#server_text").val('');
	$('#server_text_check').hide();
	search_typeall_r = "";
	$("#filterWW1").attr("style", "display:none;");
	$('#hostTree').empty();
	//global_path = [];
}
function get_fromacc(){
	var ser_array = [];
	$("#server_list input:checked").each(function () {
		ser_array.push($(this).attr('proto'));
	})
	$("#FromAccount_acc").empty().append("<option value=\"0\">请选择</option>");	
	$.each(host.AccountSet,function(i,item){
		var ser_arr = [];
		$.each(item.HostServiceSet,function(i1,item1){
			ser_arr.push(item1.ProtocolName);
		})
		if(ser_array.sort().toString().indexOf(ser_arr.sort().toString()) != -1){
			var accountName;
			$.each(AccountData,function(i3,item3){
				if(item3.AccountId == item.HostAccount.AccountId){
					accountName = item3.Name;
					if(accountName == "*"){
						accountName = "*";
					}else if(accountName == "-"){
						accountName = "-";
					}
					return false;
				}
			})
			if($("#AccountName").find('span').text() != accountName){
				$("#FromAccount_acc").append('<option value="'+item.HostAccount.AccountId+'" title="'+accountName+'">'+accountName+'</option>');
			}
		}
	});
	$("#FromAccount_acc").val('0').trigger('change');
}
//回显账号信息
function _editAccount(index,AuthId){
	
	clear_account();
	// $("#add_btn_account").hide();
	// $("#mod_btn_account").show();
	$(host.AccountSet).each(function(i,item){
		if(i == index){
			AccountIndex = i;
			AccountSet = JSON.parse(JSON.stringify(item));
			//绑定服务
			HostServiceSet = item.HostServiceSet;
			$(HostServiceSet).each(function(i1,item1){
				$("#server_list input").each(function(){
					if(item1.ProtocolId == null){
						ProtocolId_tmp1 = "null";
					}else{
						ProtocolId_tmp1 = item1.ProtocolId;
					}
					if($(this).attr("proid") == ProtocolId_tmp1 && $(this).attr("port") == item1.Port){
						$(this).iCheck("check");
					}
				})
			})
			//绑定账号 密码
			HostAccount = item.HostAccount;
			if(HostAccount.AccountId != null){
				$.each(AccountData,function(i,item){
					if(item.AccountId == HostAccount.AccountId){
						AccountName = item.AccountName;
					}
				})
				AccountId = HostAccount.AccountId;
				if(AccountName == "*"){
					AccountName = "*";
				}
				if(AccountName == "-"){
					AccountName = "-";
				}
				$("#AccountName").find('span').text(AccountName);
				$("#AccountName").data('value',AccountId);

				if ($("#AccountName").children().find('span').text() == "*") {
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",true);
					$("#password2").prop("disabled",true);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('disable');
					$("#authType").prop("disabled",false);
				}else if( $("#AccountName").children().find('span').text() == "#"){
					$("#authType").prop("disabled",true);
					$("#if_emptypwd").iCheck('uncheck');
					$("#if_emptypwd").iCheck('disable');
					$("#password1").val("");
					$("#password2").val("");
					$("#password1").prop("disabled",true);
					$("#password2").prop("disabled",true);
				}else{
					$("#authType").prop("disabled",false);
					PasswordType = item.PasswordType;
					if(PasswordType == 2 ){
						$("#password1").val("");
						$("#password2").val("");
						$("#password1").prop("disabled",true);
						$("#password2").prop("disabled",true);
						$('#if_emptypwd').iCheck('check');
					}else{
						$("#password1").prop("disabled",false);
						$("#password2").prop("disabled",false)
						$("#password1").val(item.Password);
						$("#password2").val(item.Password);
					}
				}
			}
			get_fromacc();
			//绑定其他
			if(item.PasswordType == 3){//密钥
				$("#authType").val(1).trigger('change');
				if(item.KeyName == "" || item.KeyName == null){
					$("#SSHkey_s").find('span').text('请选择');
				}else{
					$("#SSHkey_s").find('span').text(item.KeyName);						
				}
				if(item.SshKeyId == -1 || item.SshKeyId == undefined || item.SshKeyId == null){
					$("#SSHkey_s").data('value',-1);						
				}else{
					$("#SSHkey_s").data('value',item.SshKeyId);	
				}
			}
			if(HostAccount.IsSuperAcct == true) $("#IsSuperAcct").iCheck('check');
			else $("#IsSuperAcct").iCheck('uncheck');
			if(HostAccount.IsSameUser == true) $("#IsSameUser").iCheck('check');
			else $("#IsSameUser").iCheck('uncheck');
			if(HostAccount.FromAccountId == null)
				$("#FromAccount_acc").val('0').trigger('change');
			else $("#FromAccount_acc").val(HostAccount.FromAccountId).trigger('change');
			// HostAccount = item.HostAccount;
			$("#AcctSwitchCmd_account").val(HostAccount.AcctSwitchCmd);
			$("#SwitchPasswdPrompt_account").val(HostAccount.SwitchPasswdPrompt);
			
		}
	})
}
function _delAccount(AuthId,obj,flag){
	var acc_id = $(obj).parent().parent().siblings().eq(0).attr('id');
	var acc_server = $(obj).parent().parent().siblings().eq(2).text().split(',');
	var acc_server_1 = [];
	layer.open({
		type:1,
		title:"主机账号",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			layer.close(i);
			if(flag == 0){ //创建账号的删除
				$(host.AccountSet).each(function (i, item) {
					var acc_server_1 = [];
					if (acc_id == item.HostAccount.AccountId || (acc_id == null && item.HostAccount.AccountId == null)) {
						$(item.HostServiceSet).each(function(i1,item1){
							if(item1.ProtocolName == null){
								ProtocolName_tmp1 = "未指定";
							}else{
								ProtocolName_tmp1 = item1.ProtocolName;
							}
							if($.inArray(ProtocolName_tmp1+item1.Port,acc_server_1)<0){
								acc_server_1.push(item1.ProtocolName+item1.Port);
							}
							//acc_server_1.push(item1.ProtocolName+item1.Port);
						})
						if(acc_server_1.sort().toString() == acc_server.sort().toString()){
							host.AccountSet.splice(i, 1);
							return false;
						}
					}
				})
			}else{ //编辑账号的删除
				$(host.AccountSet).each(function (i, item) {
					var acc_server_1 = [];					
					if (acc_id == item.HostAccount.AccountId || (acc_id == 'null' && item.HostAccount.AccountId == null)) {
						$(item.HostServiceSet).each(function(i1,item1){
							if(item1.ProtocolName == null){
								ProtocolName_tmp1 = "未指定";
							}else{
								ProtocolName_tmp1 = item1.ProtocolName;
							}
							if($.inArray(ProtocolName_tmp1+item1.Port,acc_server_1)<0){
								acc_server_1.push(item1.ProtocolName+item1.Port);
							}
							//acc_server_1.push(item1.ProtocolName+item1.Port);
						})
						if(acc_server_1.sort().toString() == acc_server.sort().toString()){
							host.AccountSet.splice(i, 1);
							return false;
						}
					}
				})
			}
			$(obj).parent().parent().parent().remove();
			clear_account();
		},btn2:function(i){
			 layer.close(i);
		}
	})	
}
function next(type){
	/*
	"HostId": 0,
    "HostName": "",
    "HostIP": "",
    "Description": null,
    "AccessRate": 0,   
    "EnableLoginLimit": false,  
    "Status": 0,
    "DeviceTypeId": 0,
	*/
	if(type == 2){
		var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

		var namecheck = /^[_\-.\n\w\u4e00-\u9fa5]*$/;
		var HostIP = $("#HostIP").val();
		if(HostIP == "")
		{
			_alert(2,title,"请输入主机IP",$('#HostIP'));
			return false;
		};
		if(!hostIPReg.test(HostIP))
		{
			_alert(1,title,"主机IP格式不正确",$('#HostIP'));
			return false;
		};
		
		if(HostIP == "0.0.0.0"){
			_alert(2,title,"请不要输入0.0.0.0的IP",$('#HostIP'));
			return false;
		};
		if(HostIP == "255.255.255.255"){
			_alert(2,title,"请不要输入255.255.255.255的IP",$('#HostIP'));
			return false;
		};
		var HostName = $("#HostName").val().replace(/(^\s*)|(\s*$)/g,"");
		if(HostName==""){
			_alert(2,title,"请输入主机名",$('#HostName'));
			return false;
		}
		var len = 0;
		for (var i = 0; i < HostName.length; i++) {
		   if (HostName.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null) //全角 
			   len += 2; 
		   else
			   len += 1; 
		}
		if(len >= 128){
			_alert(2,title,"输入的主机名过长",$('#HostName'));
			return false;			
		}	
		if(!namecheck.test(HostName)){
			_alert(1,title,'主机名格式不正确',$('#HostName'));
			return false;
		}
		if($("#Description").val().length > 255){
			_alert(2,title,'主机描述内容过长',$('#Description'));	
			return false;
		}
		var DeviceTypeId = $("#host_type").val();
		if(DeviceTypeId == ""){
			_alert(2,title,"请选择设备类型");
			return false;
		}
		
		var AccessRate= parseInt($('input:radio[name="speed"]:checked').val());
		Description = $("#Description").val();
		//AccessRate = $("#AccessRate").children("option:selected").text();
		//if($("#EnableLoginLimit").prop("checked") == true)EnableLoginLimit = true;
		//else EnableLoginLimit = false;
		EnableLoginLimit = $("#EnableLoginLimit").is(":checked");
		
		if($("#Enabled").prop("checked") == true) Status = 0;
		else Status = 2;
		
		
		host.HostName = HostName;
		host.HostIP = HostIP;
		host.Description = Description;
		host.AccessRate = AccessRate;
		host.EnableLoginLimit = EnableLoginLimit;
		host.Status = Status;
		host.DeviceTypeId = parseInt(DeviceTypeId);
		//清空 账号信息
		clear_account();
		AccountIndex = -1;
	}
	else if(type == 3){//绑定获取当前所有的服务
		if(host.ServiceSet.length == 0){
			_alert(2,title,'请添加服务');
			return false;
		}
		// 清除 服务信息
		clear_server();
		$('#mod_btn_server').hide();
		$('#add_btn_server').show();
		ServerIndex = -1;
		$("#server_list").empty();		
		$(host.ServiceSet).each(function(i,item){
			$("#server_list").append("<div class=\"as\"><label><input type=\"checkbox\" id=\""+item.HostServiceId+"\" value=\""+item.HostServiceName+"\" name=\""+item.HostServiceName+"\" class=\"form-checkbox\" >"+item.HostServiceName+"</label></div>");
		})
	}
	$("#step" + type).show();
	$("#step" + (type+1)).hide();
	$("#step" + (type-1)).hide();
	$('#server_list .form-checkbox').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
}
function savedata(){
	var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
	
	var namecheck = /^[_\-.\n\w\u4e00-\u9fa5]*$/;
	var HostIP = $("#HostIP").val();
	if(HostIP == "")
	{
		_alert(2,'主机',"请输入主机IP",$('#HostIP'));
		return false;
	};
	if(!hostIPReg.test(HostIP))
	{
		_alert(1,'主机',"主机IP格式不正确",$('#HostIP'));
		return false;
	};
	
	if(HostIP == "0.0.0.0"){
		_alert(2,'主机',"请不要输入0.0.0.0的IP",$('#HostIP'));
		return false;
	};
	if(HostIP == "255.255.255.255"){
		_alert(2,'主机',"请不要输入255.255.255.255的IP",$('#HostIP'));
		return false;
	};
	var HostName = $("#HostName").val().replace(/(^\s*)|(\s*$)/g,"");
	if(HostName==""){
		_alert(2,'主机',"请输入主机名",$('#HostName'));
		return false;
	}
	var len = 0;
	for (var i = 0; i < HostName.length; i++) {
	   if (HostName.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null) //全角 
		   len += 2; 
	   else
		   len += 1; 
	}
	if(len >= 128){
		_alert(1,'主机',"输入的主机名过长",$('#HostName'));
		return false;			
	}	
	if(!namecheck.test(HostName)){
		_alert(1,'主机','主机名格式不正确',$('#HostName'));
		return false;
	}
	var DeviceTypeId = $("#host_type").val();
	if(DeviceTypeId == ""){
		_alert(2,'主机',"请选择设备类型");
		return false;
	}
	if($("#Description").val().length > 255){
		_alert(2,'主机','主机描述内容过长',$('#Description'));	
		return false;
	}
	
	var AccessRate= parseInt($('input:radio[name="speed"]:checked').val());
	Description = $("#Description").val();

	EnableLoginLimit = $("#EnableLoginLimit").is(":checked");
	if($("#Enabled").prop("checked") == true) Status = 0;
	else Status = 2;
	host.HostName = HostName;
	host.HostIP = HostIP;
	host.Description = Description;
	host.AccessRate = AccessRate;
	host.EnableLoginLimit = EnableLoginLimit;
	host.Status = Status;
	host.DeviceTypeId = parseInt(DeviceTypeId);

	curr_HGId = parent_id.split('-')[1];
	if(curr_HGId == 'root') curr_HGId=0;
	else{
		curr_HGId = parseInt(parent_id.split('-')[2]);
	}
	
	//保存 主机组

	var HGroupSet = [];
	
	$('#hostTree li').each(function(){ 
		if($(this).children('input').prop('checked') == true){
			HGId = $(this).children('input').attr('id').split('-')[1];
			HGroupSet.push(JSON.parse('{"HGId":'+HGId+'}'));
		}
	})
	if(HGroupSet.length == 0){
		host.HGroupSet = [{"HGId":1}];
	}else{
		host.HGroupSet = HGroupSet;
	}
	//新建的主机加入访问授权
	var AccessAuth = {
		"HGId": curr_HGId,
		"HostId": 0, 
		"AccessAuthSet": [
		]
	}
	if(host.HostId >0) title="修改主机";
	else {
		title="创建主机";
		$.each(auth_arry,function(i,item){
			if (item != '-1'){
				var auth = '{"AccessAuthId":'+item+'}';
				auth = JSON.parse(auth);
				AccessAuth.AccessAuthSet.push(auth);
			}
		});
	}
	var save_flag_ser = 0;
	var save_flag_acc = 0;
	$.each(host.ServiceSet,function(i,item){
		if(item.ProtocolId == null){
			_alert(2,'主机',"存在未指定协议的服务");
			save_flag_ser = 1;
			return false;
		}
	})
	if(save_flag_ser == 1){
		return false;
	}
	$.each(host.AccountSet,function(i,item){
		if(item.HostAccount.AccountId == null){
			_alert(2,'主机',"存在未指定的账号");
			save_flag_acc = 1;
			return false;
		}
	})
	if(save_flag_acc == 1){
		return false;
	}
	//return false;
	var msstr = aceg(JSON.stringify(host),$("input[name=se]").val());
	$.ajax({
		url:'/bhost/save_data_host',
		type: "post",
		async:false,
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(host),a2:JSON.stringify(AccessAuth),a10:"运维管理>主机管理",m1:msstr},
		success: function(Result) {
			data = JSON.parse(Result);
			if(data.Result)
			{
				layer.open({
					type:1,
					title:title,
					content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						$("#_HostList").show();
						$("#_Host").hide();
						//重新加载下改主机组
						if(filter_flag){
							if(title="修改主机"){
								var path_str = $("#hostContent").find('.c.on').attr('ppath');
								var idd_str = $("#hostContent").find('.c.on').attr('id');
								if(host.Status == 0){
									$("#hostContent").find('.c.on').parent().html('<div class="c on" ppath="'+path_str+'" id="'+idd_str+'"><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+HostName+'</div>');	
								}else if(host.Status == 2){
									$("#hostContent").find('.c.on').parent().html('<div class="c on" ppath="'+path_str+'" id="'+idd_str+'"><i class="h-bicon h-bicon-c-disabled h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+HostName+'</div>');	
								}
								//重新绑定修改后主机图标的双击事件
								$('#hostContent>div.item>div.c').unbind().bind('dblclick',function(){
									var id = $(this).attr('id').split('-')[1];
									var iid = $(this).attr('id').split('-')[2];
									if(parent_id.indexOf('root')<0){
										if($('#'+parent_id).prev().attr("class").indexOf('h-aicon-d') <0){
											$('#'+parent_id).prev().click();
										}
									}
									$('#node-'+id +'-'+ iid).click();
									if($(this).children('i').attr('class').indexOf('h-bicon-c')>=0){ //双击 主机  编辑
										current_id = $(this).attr('id');
										modify();
									}
								})

							}
						}
						else $("#" + parent_id).click();
					}
				});
				
			}
			else
			{
				_alert(1,"创建主机",data.ErrMsg);
			}
		}
	})
}
//获取设备类型
var device_list = []
var def_server_list = [];
function get_DeviceType(){
	$.ajax({
		url:'/bhost/get_DeviceType',
		type: "post",
		async:false,
		cache:false,
		data: {a0:$("input[name=se]").val()},
		success: function(Result) {
			data = JSON.parse(Result);
			device_list = data.data;
			$("#host_type").empty();
			$("#host_type").append("<option value='' _icon=\"\" _SwitchCmd=\"\" _SwitchPasswdPrompt=\"\" >请选择</option>");
			$.each(device_list,function(i,item){
				if(item.Status == 1) return true;
				$("#host_type").append("<option _icon='"+item.DeviceTypeIcon+"' value=\""+item.DeviceTypeId+"\"  _SwitchCmd='"+HTMLEncode(item.AcctSwitchCmd)+"' _SwitchPasswdPrompt='"+HTMLEncode(item.SwitchPasswdPrompt)+"'>"+item.DeviceTypeName+"</option>");
			})
		}
	})
}

//创建、编辑 主机组
var HostGrp ={
		"HGId": 0,
		"HGName": "",
		"Description": "",
		"ParentHGId": 0
	}
function init_hostgrp(){
	HostGrp ={
		"HGId": 0,
		"HGName": "",
		"Description": "",
		"ParentHGId": 0
	}
}
function add_hostgrp(){
	$("#_HostList").hide();
	$("#_HostGrp").show();
	$("#group_title").text("创建主机组");

	$.ajax({
		url:'/bhost/check_manageAuth',
		type: "post",
		cache:false,
		data: {a0:$("input[name=se]").val()},
		success: function(Result) {
			if(Result == 'true'){
				M_AUTH = true;
			}else{
				M_AUTH = false;
				par_id_tmp = parent_id.split('-')[2];
				if(par_id_tmp != undefined){//根目录
					Mode_tmp = $(".h-path-wrap").find('a:last').attr('auth');
					if(Mode_tmp == 2){
						M_AUTH = true;//有访问授权
					}else{
						M_AUTH = false;
					}
				}				
			}
			if(M_AUTH == true){
				//$('#_HostGrp').find('.form').children('.form-item').eq(2).show();
				//_get_an();		
			}else{
				$('#_HostGrp').find('.form').children('.form-item').eq(2).hide();
			}

			auth_tmp_g = [];
			auth_arry_g = ['-1'];
			clear_HostGrp();
			//HostGrp = HostGrp_tmp;
			init_hostgrp();
		}
	})
}
function select_first_grp(){
	$('#find_select').val('all').trigger('change');
	first_grp = $('#first_grp').attr('value');
	if (first_grp == '0') {
		$('#first_grp').text('图标');
		$('#first_grp').attr("value", '1');
		first_grp = '1';
		$('#first_grp').show();
	} else {
		$('#first_grp').text('列表');
		$('#first_grp').attr("value", '0');
		first_grp = '0';
		$('#first_grp').show();
	}
	$.ajax({
		url:'/bhost/save_select_first_grp',
		type: "post",
		cache: true,
		data: { a0: $("input[name=se]").val(), a1: first_grp },
		success: function (Result) {

		}
	})
	if($(".h-catelog").find("a[class ='active']").length>0){
		$(".h-catelog").find("a[class ='active']").click();
	}
	else{
		_initList();
	}
	
}

function clear_HostGrp(){
	$("#HostGrpName").val("");
	$("#HostGrpDescription").val("");
	$('#_HostGrp').find('i.v-check').attr('class','v-check');
}
var AccessSet_g;
function SaveDataGrp(){
	HGName = $("#HostGrpName").val();
	if (HGName=='') {
        _alert(2,'主机组','请输入组名',$('#HostGrpName'));
		return false;
	}
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	if(!nameReg.test(HGName)){
		_alert(1,'主机组','组名格式不正确',$('#HostGrpName'));
		return false;
	}
	Description=$("#HostGrpDescription").val();
	if(parent_id.split('-')[1] == 'root'){
		ParentHGId = 0;
	}else ParentHGId = parseInt(parent_id.split('-')[2]);
	HostGrp.HGId = HostGrp.HGId;
	HostGrp.HGName = HGName;
	HostGrp.Description = Description;
	HostGrp.ParentHGId = ParentHGId;
	AccessSet_g = {
		"HGId": 0, 
		"AccessAuthSet": [
		]
	}
	if($('#_HostGrp').find('.form').children('.form-item').eq(2).is(':visible')){
		$.each(auth_arry_g,function(i,item){
			if (item != '-1'){
				var auth = '{"AccessAuthId":'+item+'}';
				auth = JSON.parse(auth);
				AccessSet_g.AccessAuthSet.push(auth);
			}
		});
	}
	if(HostGrp.HGId > 0) title="修改主机组"
	else  title="创建主机组"
	var msstr = aceg(JSON.stringify(HostGrp),$("input[name=se]").val());
	$.ajax({
		url:'/bhost/save_hostgrp',
		type: "post",
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(HostGrp),a2:JSON.stringify(AccessSet_g),a10:"运维管理>主机管理",m1:msstr},
		success: function(Result) {
			data = JSON.parse(Result);
			if(data.Result)
			{
				layer.open({
					type:1,
					title:title,
					content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						$("#_HostList").show();
						$("#_HostGrp").hide();
						//将新加的主机组 加到左侧树中
						if(filter_flag){
							if(title="修改主机组"){
								var path_str = $("#hostContent").find('.c.on').attr('ppath');
								var idd_str = $("#hostContent").find('.c.on').attr('id');
								$("#hostContent").find('.c.on').parent().html('<div class="c on" ppath="'+path_str+'" id="'+idd_str+'"><i class="h-bicon h-bicon-t"></i>'+HGName+'</div>');
							}
						}
						else $("#" + parent_id).click();
						if(HostGrp.HGId == 0){
							if(parent_id.split('-')[1] == 'root') {
								var new_Gid = 'cnode-0-'+data.HGId+'-g';
								if($("#"+new_Gid+"").length != 0){
									$('#hostCatelog').append('<li><i class="h-blank" /><a href="javascript:;" id="node-0-'+data.HGId+'"><i class="h-eicon h-eicon-t-m"></i><span>'+HGName+'</span></a></li>');
								}
							}
							else{
								pid =  parent_id.split('-')[2];
								
								if($("#" + parent_id).prev().attr("class").indexOf('h-aicon-d') >=0){
									var $_u = $("#"+parent_id).next('ul');
									$_u.append('<li><i class="h-blank" /><a href="javascript:;" id="node-'+pid+'-'+data.HGId+'"><i class="h-eicon h-eicon-t-m"></i><span>'+HGName+'</span></a></li>');
								}else{ 
									if($("#" + parent_id).prev().attr("class").indexOf('h-blank') >=0){								
										$("#" + parent_id).prev().attr("class",'h-aicon');
										$("#" + parent_id).after('<ul style="display:none;"><p>Loading...</p></ul>');
									}
								}
							}
						}else{
							if(parent_id.split('-')[1] == 'root') {
								pid = 0;
							}else{
								pid = parent_id.split('-')[2];
							}
							$('#node-'+pid+'-'+data.HGId+'>span').text(HGName);
						}
						return true;
					}
				});
				
			}
			else{
				_alert(1,"主机组",data.ErrMsg);
				return false;
			}
		}
	})	
}
function back(){
	$("#_HostList").show();
	$("#_Host").hide();
	$("#_HostGrp").hide();
	$('#_account').hide();
	$('#_Server').hide();
	_initSize();
	_pathWrap();
	if(first_grp=='1'){list_initList();}
}
//删除主机、主机组
function delete_node(){
	var hostContent_on_len=$("#hostContent").find("div[class='c on']").length;
	if(hostContent_on_len==0){
		_alert(2,'主机','请选择主机或主机组');
		return false;
	}
	if(hostContent_on_len > 1){
		_delete_batch(0);
		return false;
	}
	if(first_grp=='1'){
		current_id=$("#hostContent").find("div[class='c on']").attr('id');
		c_parent_id == current_id.split('-')[1];
	}
	if(current_id.indexOf('-h')>=0){
		title="删除主机"
		ishost = true; 
	}else{
		title="删除主机组"
		ishost = false; 
	}	
	id = current_id.split('-')[2];
	if(c_parent_id == ""){
		if(parent_id.split('-')[1] == 'root') pid = 0;
		else pid = parent_id.split('-')[2];
	}else{
		pid = c_parent_id;
	}
	
	layer.open({
		type:1,
		title:"主机管理",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			layer.close(i);
			if(ishost == false){
				layer.open({
					type: 1,
					title: '主机管理',
					content: '<div class="layer-alert"><i class="alert warning"></i>是否删除组内主机</div>',
					btn:['是','否'],
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						isdeletehost = true;
						delete_h_g(id,pid,ishost,isdeletehost,"Hgrp");
					},
					btn2:function(i){
						layer.close(i);
						isdeletehost = false;
						delete_h_g(id,pid,ishost,isdeletehost,"Hgrp");
					}
				});
			}else{
				isdeletehost = true;
				delete_h_g(id,pid,ishost,isdeletehost,"Host");
			}
		},
		btn2:function(i){
			 layer.close(i);
		}
	});
}
function _delete_batch(typ){
	var isdeletehost = "";
	var c = $("#route-root").next().children().length; // 0-->根目录
	if(c == 0){
		global_pid = 0;
	}else{
		c = $("#route-root").next().children().last();
		global_pid = c.attr("id").split('-')[2];		
	}
	//获取选中信息
	var delete_ids = {
		userGroups:[],
		users:[]
	}
	var userGroups = [];
	var users = [];
	if(filter_flag != true){
		$("#hostContent").find("div[class='c on']").each(function(i,item){
			if($(item).attr("id") == 'cnode-0-1-g'){
				return false;
			}
			var tmp = {id:null,pid:null};
			if($(item).children('i').attr('class').indexOf('h-bicon-t') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = global_pid;
				userGroups.push(tmp);
			}else if($(item).children('i').attr('class').indexOf('h-bicon-c') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = global_pid;
				users.push(tmp);
			}
		});
	}else{				//当前为过滤结果
		$("#hostContent").find("div[class='c on']").each(function(i,item){
			var tmp = {id:null,pid:null};
			if($(item).children('i').attr('class').indexOf('h-bicon-t') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];
				userGroups.push(tmp);
			}else if($(item).children('i').attr('class').indexOf('h-bicon-c') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];				
				users.push(tmp);
			}
		});
	}
	delete_ids.userGroups = userGroups;
	delete_ids.users = users;

	var loginusercode = window.parent.document.frm.us.value;

	//记录结果
	result_tmp = {
		total:0,
		finish:0,
		success:0,
		fail:0
	};
	result_tmp.total = userGroups.length + users.length;

	if(typ == 0){
		layer.open({
			type: 1,
			title: '主机管理',
			content: '<div class="layer-alert"><i class="alert warning"></i>确认删除</div>',
			btn:['是','否'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
				layer.close(i);
				_getLoadBar();
				if(delete_ids.userGroups.length != 0){	//多选中有用户组
					var ishost = false;
					layer.open({
						type: 1,
						title: '主机管理',
						content: '<div class="layer-alert"><i class="alert warning"></i>是否删除组内主机</div>',
						btn:['是','否'],
						btnAlign:'c',
						closeBtn: false,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						btn1:function(i){
							layer.close(i);
							isdeletehost = true;
							delete_function();
						},
						btn2:function(i){
							layer.close(i);
							isdeletehost = false;
							delete_function();
						}
					});
				}else{
					isdeletehost = true;
					delete_function();
				}
			},
			btn2:function(i){
				layer.close(i);
			}
		})
	}else{
		layer.open({
			type: 1,
			title: '主机管理',
			content: '<div class="layer-alert"><i class="alert warning"></i>确认移除</div>',
			btn:['是','否'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
				layer.close(i);
				_getLoadBar();
				isdeletehost = false;
				delete_function();				
			},
			btn2:function(i){
				layer.close(i);
			}
		})
	}
	function delete_function(){
		var finishNum = 0;
		var successNum = 0;
		var failNum = 0;

		function deleteUserG(){
			var time;
			var ishost = false;
			_do = function () {
				var g_id;
				var g_pid;	//用户组的父组ID，为了记录检索后被选组的父组ID
				if(finishNum < delete_ids.userGroups.length){
					g_id = delete_ids.userGroups[finishNum].id;
					g_pid = delete_ids.userGroups[finishNum].pid
				}else{	//用户组操作结束 ，开始处理被选用户
					deleteUser();
					clearTimeout(time);
					return false;
				}

				$.ajax({
					url:"/bhost/delete_node",
					type:"POST",
					async:false,
					cache:false,
					data:{a0:$("input[name=se]").val(),a1:g_id,a2:g_pid,a3:ishost,a4:isdeletehost,a5:loginusercode,a10:"运维管理>主机管理"},
					success:function(result){
						clearTimeout(time);
						var ugroup_result = JSON.parse(result);
						time = setTimeout(function(){_do();},1);
						if(ugroup_result.Result == false){
							finishNum++;
							result_tmp.finish = finishNum;
							failNum++;
							result_tmp.fail = failNum;
						}else{
							finishNum++;
							result_tmp.finish = finishNum;
							successNum++;
							result_tmp.success = successNum;
							// $("#hostCatelog").find("a[class ='active']").click();//刷新移到任务结束
							if(global_pid == 0){
								$("#node"+"-"+g_pid+"-"+g_id).parent().remove();
								$("#cnode"+"-"+g_pid+"-"+g_id+"-g").parent().remove();
							}else{
								$("#node"+"-"+g_pid+"-"+g_id).parent().remove();
								$("#cnode"+"-"+g_pid+"-"+g_id+"-g").parent().remove();
							}
						}
					}
				})
			}
			_do();
		}
		function deleteUser(){
			var time;
			var ishost = true;
			_do = function () {
				var g_id;
				var g_pid;
				var index = finishNum - delete_ids.userGroups.length;
				if(index < delete_ids.users.length){
					g_id = delete_ids.users[index].id;
					g_pid = delete_ids.users[index].pid;
				}else{	//操作结束
					//删除后处理左边目录
					if(filter_flag != true){
						if($("#hostContent").find(".h-bicon.h-bicon-t").length == 0){
							$("#hostCatelog").find('.active').prev().attr('class','h-blank');
						}
						$("#hostCatelog").find("a[class ='active']").click();
					}else{	//过滤后
						$("#hostCatelog").find(".h-aicon.h-aicon-d").each(function(i,item){
							if($(item).siblings('ul').children('li').length == 0){
								$(item).attr("class",'h-blank');
							}
						})
					}
					clearTimeout(time);
					return false;
				}
				$.ajax({
					url:"/bhost/delete_node",
					type:"POST",
					async:false,
					cache:false,
					data:{a0:$("input[name=se]").val(),a1:g_id,a2:g_pid,a3:ishost,a4:isdeletehost,a5:loginusercode,a10:"运维管理>主机管理"},
					success:function(result){
						clearTimeout(time);
						time = setTimeout(function(){_do();},1);
						var ugroup_result = JSON.parse(result);
						if(ugroup_result.Result == false){
							finishNum++;
							result_tmp.finish = finishNum;
							failNum++;
							result_tmp.fail = failNum;
						}else{
							finishNum++;
							result_tmp.finish = finishNum;
							successNum++;
							result_tmp.success = successNum;
							$("#cnode"+"-"+g_pid+"-"+g_id+"-h").parent().remove();
						}
					}
				})
			}
			_do();
		}
		deleteUserG();
	}
}

var loadBarLayer;//批量操作进度条
function _getLoadBar(){
	var _loadBar = function(){
		$('#loadBarWrap').html('<div class="loadperw-host"><span id="loadNum"></span><span id="loadPer"></span></div><span id="loadPerText_host">0%</span><div class="loadberBtn"><a id="loadberBtn" href="javascript:;" onclick="_close(this)">关闭</a></div>');

		var _runOut;
		var _run = function(){
			_runOut = setTimeout(function(){
				var i = parseInt(result_tmp.finish),imax = parseInt(result_tmp.total);
				if(i < imax){
					$('#loadNum').text(i+'/'+imax);
					var per = parseInt(i/imax * 100);
					$('#loadPer').width(per+'%');
					$('#loadPerText_host').text(per+"%");
					_run();
				}else{
					$('#loadNum').text(i+'/'+imax);
					var per = parseInt(i/imax * 100);
					$('#loadPer').width(per+'%');
					$('#loadPerText_host').text(per+"%");
					$("#loadPerText_host").after('<p style="margin: -2px 0 0 8px;">成功数：'+result_tmp.success+'条，失败数：'+result_tmp.fail+'条</p>');
					clearTimeout(_runOut);
					$('#loadberBtn').css('display','block');
				}
			},10);
		}
		_run();
	}

	loadBarLayer = layer.open({
		title:false,
		closeBtn:false,
		content:'<div class="lodabar-w-host" id="loadBarWrap">加载中...</div>',
		btn:false,
		skin:'loadbar',
		area:['430px','400px'],
		move:false,
		success:function(i){
			_loadBar();
		}
	})
}
function _close(obj){
	layer.close(loadBarLayer);
}
function delete_h_g(id,pid,ishost,isdeletehost,type){
	
	$.ajax({
		url:'/bhost/delete_node',
		type: "post",
		async:false,
		cache:false,
		data: {a0:$("input[name=se]").val(),a1:id,a2:pid,a3:ishost,a4:isdeletehost,a5:usercode,a10:"运维管理>主机管理"},
		success: function(Result) {
			data = JSON.parse(Result);
			if(data.Result)
			{
				var str;
				if(isdeletehost == true || type == "Hgrp"){
					str = "删除成功";
				}else{
					str = "移除成功";
				}
				layer.open({
					type:1,
					title:"主机管理",
					content:'<div class="layer-alert"><i class="alert succ"></i>'+str+'</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						//删除主机、主机组
						if(filter_flag == false){
							$("#" + parent_id).click();
						}else{
							// $("#"+current_id).parent().remove();
							var del_str = $("#"+current_id).text();
							$.each($("#"+current_id).parent().parent().children(),function(i,item){
								if($(item).children().text() == del_str){
									$(item).remove();
								}
							})
						}
						if(ishost){					
						}else{
							
							if(pid == 0) {
								$("#node"+current_id.replace('cnode','').replace('-g','')).parent().remove();
							}
							else{							
								if($("#" + parent_id).prev().attr("class").indexOf('h-aicon-d') >=0){
									$("#node"+current_id.replace('cnode','').replace('-g','')).parent().remove();
									if($("#hostContent div.item>div.c>i[class='h-bicon h-bicon-t']").length == 0){
										$("#" + parent_id).prev().attr("class",'h-blank');										
									}
								}else{
									if($("#hostContent div.item>div.c>i[class='h-bicon h-bicon-t']").length == 0){
										$("#" + parent_id).prev().attr("class",'h-blank');
									}
									
								}
							}
						}
						
						return true;
					}
				});
				
			}
			else{
				_alert(1,"主机管理",data.ErrMsg);
			}
		}
	})
}
function move_node(){
	var hostContent_on_hg_len=$("#hostContent div.c.on i.h-bicon-t").length;
	var hostContent_on_len=$("#hostContent div.c.on").length;
	if(hostContent_on_hg_len>0){
		_alert(2,'主机','无法移除主机组');
		return false;
	}
	if(hostContent_on_len==0){
		_alert(2,'主机','请选择主机');
		return false;
	}
	if(hostContent_on_len > 1){
		_delete_batch(1);
		return false;
	}
	if(first_grp=='1'){
		current_id=$("#hostContent").find("div[class='c on']").attr('id');
		c_parent_id == current_id.split('-')[1];
	}
	id = current_id.split('-')[2];
	if(c_parent_id == ""){
		if(parent_id.split('-')[1] == 'root') pid = 0;
		else pid = parent_id.split('-')[2];
	}else{
		pid = c_parent_id;
	}
	layer.open({
		type:1,
		title:"移除",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否移除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			layer.close(i);
			delete_h_g(id,pid,true,false);
		},
		btn2:function(i){
			 layer.close(i);
		}
	});
}
//复制、剪切、粘贴
var paste_id="";
var dec_parent_id = "";
var src_parent_id = "";
var paste_type=true;// true->主机 false 主机组
var iscut=false;
var if_cut=false; 
var c_parent_id = "";
var if_paste=false;
var z_current_id = "";//复制、剪切 要用的当前id
var z_current_name = "";//复制、剪切 要用的当前名称
var z_current_class='';
function copy(){
	var hostContent_on_len=$("#hostContent").find("div[class='c on']").length;
	if(hostContent_on_len==0){
		_alert(2,'主机','请选择主机或主机组');
		return false;
	}
	copy_name = "";
	copy_mem = "";
	copyArray = {
		userGroups:[],
		users:[]
	};
	if(hostContent_on_len > 1){
		_copy_batch();
		if(first_grp=='1'){
			_alert(0,'主机管理','复制成功');
			if(parent_id != 'route-root' && parent_id!=''){
				$('#btn_4').show();
			}
		}
		return false;
	}
	_hideMenu();
	copyArray = [];
	copy_flag = 1;
	_initHostMenu();
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-t-cut").removeClass("h-bicon-t-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-cut").removeClass("h-bicon-c-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-disabled-cut").removeClass("h-bicon-c-disabled-cut");
	if(first_grp=='1'){
		current_id=$("#hostContent").find("div[class='c on']").attr('id');
		c_parent_id == current_id.split('-')[1];
		var id_arr=current_id.split('-');
		id_arr[0]='node';
		id_arr.splice(id_arr.length-1,1);
		z_current_class=z_current_class=$('#'+id_arr.join('-')).prev('i').attr('class');
		z_current_name = $("#hostContent").find("div[class='c on']").parents('td').next('td').text();
	}
	if(c_parent_id =="")
		src_parent_id = parent_id;
	else
		src_parent_id = c_parent_id;
	z_current_id = current_id;
		
	if(z_current_id.indexOf('-h') >=0) paste_type=true;
	else paste_type=false;
	iscut = false;
	if_paste = true;
	//console.log(current_id);
	if(first_grp=='1'){
		_alert(0,'主机管理','复制成功');
		if(parent_id != 'route-root' && parent_id!=''){
			$('#btn_4').show();
		}
	}
}
function _copy_batch(){
	iscut = false;
	copy_flag = 1;
	_initHostMenu();
	_hideMenu();
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-t-cut").removeClass("h-bicon-t-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-cut").removeClass("h-bicon-c-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-disabled-cut").removeClass("h-bicon-c-disabled-cut");
	var a = $("#hostContent").find("div[class='c on']");
	copy_name = [];
	$.each(a,function(i,item){
		copy_name.push($(item).children('span').text());
	})
	//console.log(copy_name);
	copyArray = {
		userGroups:[],
		users:[]
	};

	var userGroups = [];
	var users = [];
	if(filter_flag != true){
		$("#hostContent").find("div[class='c on']").each(function(i,item){
			if($(item).attr("id") == 'cnode-0-1-g'){
				return false;
			}
			var tmp = {id:null,pid:null};
			if($(item).children('i').attr('class').indexOf('h-bicon-t') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];
				userGroups.push(tmp);
			}else if($(item).children('i').attr('class').indexOf('h-bicon-c') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];
				users.push(tmp);
			}
		});
	}else{				//当前为过滤结果
		$("#hostContent").find("div[class='c on']").each(function(i,item){
			var tmp = {id:null,pid:null};
			if($(item).children('i').attr('class').indexOf('h-bicon-t') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];
				userGroups.push(tmp);
			}else if($(item).children('i').attr('class').indexOf('h-bicon-c') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];				
				users.push(tmp);
			}
		});
	}
	copyArray.userGroups = userGroups;
	copyArray.users = users;
	//console.log(copyArray);
}
function cut(){
	var hostContent_on_len=$("#hostContent").find("div[class='c on']").length;
	if(hostContent_on_len==0){
		_alert(2,'主机','请选择主机或主机组');
		return false;
	}
	copyArray = {
		userGroups:[],
		users:[]
	};
	if(hostContent_on_len > 1){
		_cut_batch();
		if(first_grp=='1'){
			_alert(0,'主机管理','剪切成功');
			if(parent_id != 'route-root' && parent_id!=''){
				$('#btn_4').show();
			}
		}
		return false;
	}
	_hideMenu();
	copy_flag = 1;
	_initHostMenu();
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-t-cut").removeClass("h-bicon-t-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-cut").removeClass("h-bicon-c-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-disabled-cut").removeClass("h-bicon-c-disabled-cut");
	if(first_grp=='1'){
		current_id=$("#hostContent").find("div[class='c on']").attr('id');
		var id_arr=current_id.split('-');
		id_arr[0]='node';
		id_arr.splice(id_arr.length-1,1);
		z_current_class=z_current_class=$('#'+id_arr.join('-')).prev('i').attr('class');
		z_current_name = $("#hostContent").find("div[class='c on']").parents('td').next('td').text();
	}
	//console.log(current_id);
	src_parent_id = parent_id;
	if(current_id.indexOf('-h') >=0) paste_type=true;
	else paste_type=false;
	
	z_current_id = current_id;
	
	class_tmp = $("#" +z_current_id).children('i').attr('class');

	if($("#" +z_current_id).children("i.h-bicon.h-bicon-t").length>0) {
		$("#" +z_current_id).children('i').addClass('h-bicon-t-cut');
	}else if($("#" +z_current_id).children("i.h-bicon.h-bicon-c").length>0) {	
		$("#" +z_current_id).children('i').addClass('h-bicon-c-cut');
	}else if($("#" +z_current_id).children("i.h-bicon.h-bicon-c-disabled").length>0) {	
		$("#" +z_current_id).children('i').addClass('h-bicon-c-disabled-cut');
	}
	
	if_cut = true;
	iscut = true;
	if_paste = true;
	if(first_grp=='1'){
		_alert(0,'主机管理','剪切成功');
		if(parent_id != 'route-root' && parent_id!=''){
			$('#btn_4').show();
		}
	}
}
var copyArray = [];
function _cut_batch(){
	iscut = true;
	copy_flag = 1;
	_initHostMenu();
	_hideMenu();
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-t-cut").removeClass("h-bicon-t-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-cut").removeClass("h-bicon-c-cut");
	$("#hostContent").find("div[class ='item']").find("i.h-bicon-c-disabled-cut").removeClass("h-bicon-c-disabled-cut");
	var a = $("#hostContent").find("div[class='c on']");
	copy_name = [];
	$.each(a,function(i,item){
		copy_name.push($(item).children('span').text());
		//var class_tmp = $(item).children('i').attr('class');
		//$(item).children('i').attr("class",class_tmp +"-cut");
		if($(item).children("i.h-bicon.h-bicon-t").length>0) {
			$(item).children('i').addClass('h-bicon-t-cut');
		}else if($(item).children("i.h-bicon.h-bicon-c").length>0) {	
			$(item).children('i').addClass('h-bicon-c-cut');
		}else if($(item).children("i.h-bicon.h-bicon-c-disabled").length>0) {	
			$(item).children('i').addClass('h-bicon-c-disabled-cut');
		}
	})

	copyArray = {
		userGroups:[],
		users:[]
	};

	var userGroups = [];
	var users = [];
	if(filter_flag != true){
		$("#hostContent").find("div[class='c on']").each(function(i,item){
			if($(item).attr("id") == 'cnode-0-1-g'){
				return false;
			}
			var tmp = {id:null,pid:null,mem:null,name:null};
			if($(item).children('i').attr('class').indexOf('h-bicon-t') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];
				tmp.mem = $(item).attr("mem");
				tmp.name = $(item).text();
				userGroups.push(tmp);
			}else if($(item).children('i').attr('class').indexOf('h-bicon-c') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];
				users.push(tmp);
			}
		});
		oldGId = $("#hostCatelog").find('.active').attr('id');
		oldGMember = $("#hostCatelog").find('.active').attr('mem');
	}
	else{				//当前为过滤结果
		$("#hostContent").find("div[class='c on']").each(function(i,item){
			var tmp = {id:null,pid:null,mem:null,name:null,oldGId:null,oldMem:null};
			if($(item).children('i').attr('class').indexOf('h-bicon-t') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];
				var itemId = $(item).attr("id").split('cnode')[1];
				var groupMemNum = $("#node"+itemId).attr('mem');
				if(itemId.split('-')[1] == 0){
					oldGId = 0;
					oldMem = 0;
				}else{
					var oldGId = $("#node"+itemId).parent().parent().prev().attr('id').split('node')[1];
					var oldMem = $("#node"+itemId).parent().parent().prev().attr('mem');
				}
				tmp.mem = groupMemNum;
				tmp.name = $(item).text();
				tmp.oldGId = oldGId;
				emp.oldMem = oldMem;		
				userGroups.push(tmp);
			}else if($(item).children('i').attr('class').indexOf('h-bicon-c') >= 0 ){
				var id_s = $(item).attr("id").split('-')[2];
				tmp.id = id_s;
				tmp.pid = $(item).attr("id").split('-')[1];				
				users.push(tmp);
			}
		});
	}
	copyArray.userGroups = userGroups;
	copyArray.users = users;
}
//记录结果
var result_tmp = {
	total:0,
	finish:0,
	success:0,
	fail:0
};
function paste(){
	//console.log(parent_id);
	//console.log(src_parent_id);
	//console.log(current_id);
	//console.log(copyArray);
	if(copyArray == "" || (copyArray.userGroups == "" && copyArray.users == "")){//判断是否未批量粘贴
		//console.log(parent_id);
		dec_parent_id = parent_id;
		if(src_parent_id.indexOf('root')>=0) oldparentid =0;
		else if(src_parent_id.indexOf('-')>=0) oldparentid = src_parent_id.split('-')[2];
		else oldparentid = src_parent_id;
		if(dec_parent_id.indexOf('root')>=0) newparentid =0;
		else newparentid = dec_parent_id.split('-')[2];
		z_current_id = current_id;
		id = z_current_id.split('-')[2];
		
		if(z_current_id.indexOf('-h')>=0){
			ishost = true; 
		}else{
			ishost = false; 
		}	
		//判断
		var flag_g = 0;
		if($("#route-root").next().children().last().attr('id') == 'route-0-1'){//在未分组下
			if(iscut == false && ishost == true){			//复制粘贴主机操作
				_alert(1,"主机管理","不能将其他组下主机复制到未分组下");
				return false;
			}
			if(iscut == true && ishost == true){			//剪切粘贴主机操作
				$.ajax({		//回显主机信息
					url:"/bhost/getHost_info",
					type:"POST",
					async:false,
					data:{a0:$("input[name=se]").val(),a1:id},
					success:function(result){
						var user_item = JSON.parse(result);
						if(user_item.HGroupSet.length != 1){
							_alert(1,"主机管理","该主机从属多个主机组");
							flag_g = 1;
							return false;
						}
					}
				})
			}
		}
		if(flag_g == 1){
			return false;
		}
		$.ajax({
			url:'/bhost/paste_node',
			type: "post",
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:oldparentid,a2:newparentid,a3:paste_type,a4:iscut,a5:id,a10:"运维管理>主机管理"},
			success: function(Result) {
				data = JSON.parse(Result);
				if(data.Result){
					_alert(0,'主机管理','粘贴成功');
					$("#"+dec_parent_id).click();
					if(ishost){				
					}else{
						if(iscut == true){
							$('#node-'+oldparentid+'-'+id).parent('li').remove();
						}
						if(dec_parent_id.split('-')[1] == 'root') {
								$('#hostCatelog').append('<li><i class="h-blank" /><a href="javascript:;" id="node-0-'+id+'"><i class="h-eicon h-eicon-t-m"></i><span>'+z_current_name+'</span></a></li>');
						}
						else{
							pid =  dec_parent_id.split('-')[1];
							//console.log(dec_parent_id);
							if($("#" + dec_parent_id).prev().attr("class").indexOf('h-aicon-d') >=0){
								var $_u = $("#"+dec_parent_id).next('ul');
								$_u.append('<li><i class="'+z_current_class+'" /><a href="javascript:;" id="node-'+newparentid+'-'+id+'"><i class="h-eicon h-eicon-t-m"></i><span>'+z_current_name+'</span></a></li>');
							}
							else{ 
								if($("#" + dec_parent_id).prev().attr("class").indexOf('h-blank') >=0){								
									$("#" + dec_parent_id).prev().attr("class",'h-aicon');
									$("#" + dec_parent_id).after('<ul style="display:none;"><p>Loading...</p></ul>');
								}
							}
						}
					}
					return true;
				}else{
					_alert(1,"主机管理",data.ErrMsg);
					return false;
				}
				if_cut = false;
				
			}
		})
	}
	else{
		//记录结果
		result_tmp = {
			total:0,
			finish:0,
			success:0,
			fail:0,
			userGSusNum:0
		};
		result_tmp.total = copyArray.userGroups.length + copyArray.users.length;
		_getLoadBar();
		var finishNum = 0;
		var successNum = 0;
		var failNum = 0;
		var userGSusNum = 0;
		var loginusercode = window.parent.document.frm.us.value;
		var d = $("#route-root").next().children().length;
		var newpid;
		if(d == 0){
			newpid = 0;
		}else{
			d = $("#route-root").next().children().last();
			newpid = d[0].id.split('-')[2];		
		}
		function pasteUserG(){
			var time;
			var isuser = false;
			_do = function () {
				var copy_id;
				var oldpid;
				if(finishNum < copyArray.userGroups.length){
					copy_id = copyArray.userGroups[finishNum].id;
					oldpid = copyArray.userGroups[finishNum].pid;
				}else{	//用户组操作结束 ，开始处理被选用户
					pasteUser();
					clearTimeout(time);
					return false;
				}

			$.ajax({
				url:'/bhost/paste_node',
				type: "post",
				cache:false,
				data: {a0:$("input[name=se]").val(),a1:oldpid,a2:newpid,a3:isuser,a4:iscut,a5:copy_id,a10:"运维管理>主机管理"},
				success: function(Result) {
						clearTimeout(time);
						var ugroup_result = JSON.parse(Result);
						time = setTimeout(function(){_do();},1);
						if(ugroup_result.Result == false){
							finishNum++;
							result_tmp.finish = finishNum;
							failNum++;
							result_tmp.fail = failNum;
						}else{
							finishNum++;
							result_tmp.finish = finishNum;
							successNum++;
							result_tmp.success = successNum;
							userGSusNum++;
							result_tmp.userGSusNum = userGSusNum;
							if(iscut == true){
								$("#node"+"-"+oldpid+"-"+copy_id).parent().remove();
							}
							if($("#hostCatelog").find("a[class ='active']").prev().attr('class') == 'h-aicon h-aicon-d'){//catelog中当前组展开时加入新复制、粘贴的用户组
								var flag_mem = copyArray.userGroups[finishNum-1].mem;
								var groupName = copyArray.userGroups[finishNum-1].name;
								if(flag_mem == 0){
									$("#hostCatelog").find("a[class ='active']").next('ul').append('<li><i class="h-blank"></i><a href="javascript:;" id="node-'+newpid+'-'+copy_id+'"  auth=2 mem="'+flag_mem+'" title="'+groupName+'"><i class="h-eicon h-eicon-g"></i><span>'+groupName+'</span></a></li>');
								}else{
									$("#hostCatelog").find("a[class ='active']").next('ul').append('<li><i class="h-aicon"></i><a href="javascript:;" id="node-'+newpid+'-'+copy_id+'" auth=2 mem="'+flag_mem+'" title="'+groupName+'"><i class="h-eicon h-eicon-g"></i><span>'+groupName+'</span></a></li>');
								}
							}
						}
					}
				})
			}
			_do();
		}
		function pasteUser(){
			var time;
			var isuser = true;
			_do = function () {
				var copy_id;
				var index = finishNum - copyArray.userGroups.length;
				if(index < copyArray.users.length){
					copy_id = copyArray.users[index].id;
					oldpid = copyArray.users[index].pid;
				}else{	//操作结束
					//粘贴后处理左边目录
					if(iscut == true && filter_flag == false){
						var oldGMember_now = oldGMember - result_tmp.userGSusNum;
						$('#'+oldGId).attr('mem',oldGMember_now);
						if(oldGMember_now < 0){
							oldGMember_now = 0;
						}
						if(oldGMember_now == 0){
							$('#'+oldGId).prev().attr('class','h-blank'); 
						}
					}else if(iscut == true && filter_flag == true){
						var count = 0;
						var s = copyArray.userGroups[index].oldGId;
						$.each(copyArray.userGroups,function(i,item){
							if(item.oldGId == s){
								count++;
							}
						})
						var oldGMember_now = copyArray.userGroups[index].oldGMem - count;
						$('#'+copyArray.userGroups[index].oldGId).attr('mem',oldGMember_now);
						if(oldGMember_now <= 0){
							$('#'+copyArray.userGroups[index].oldGId).prev().attr('class','h-blank'); 
						}
					}
					$("#hostCatelog").find("a[class ='active']").click();
					var groupsNum = $("#hostContent").find('.h-bicon.h-bicon-t').length;
					$("#hostCatelog").find("a[class ='active']").attr('mem',groupsNum);
					if(groupsNum > 0 && $("#hostCatelog").find("a[class ='active']").prev().attr('class') == 'h-blank'){
						$("#hostCatelog").find("a[class ='active']").prev().attr('class','h-aicon');
						$("#hostCatelog").find("a[class ='active']").after('<ul><p>Loading...</p></ul>');
					}
					clearTimeout(time);
					return false;
				}
				var flag_paste = 0;
				if($("#route-root").next().children().last().attr('id') == 'route-0-1'){//在未分组下
					if(iscut == false && isuser == true){			//复制粘贴用户操作
						finishNum++;
						result_tmp.finish = finishNum;
						failNum++;
						result_tmp.fail = failNum;
						flag_paste = 1;
					}
					else if(iscut == true && isuser == true){			//剪切粘贴用户操作
						$.ajax({		//回显用户信息
							url:"/bhost/getHost_info",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),a1:copy_id},
							success:function(result){
								//console.log(result);
								var user_item = JSON.parse(result);
								//user_item = user_item.info;
								if(user_item.HGroupSet.length != 1){
									finishNum++;
									result_tmp.finish = finishNum;
									failNum++;
									result_tmp.fail = failNum;
									flag_paste = 1;
								}
							}
						})
					}
				}
				if(flag_paste == 1){
					clearTimeout(time);
					time = setTimeout(function(){_do();},1);
					return false;
				}
				if(iscut == false && oldpid == 1){
					finishNum++;
					result_tmp.finish = finishNum;
					failNum++;
					result_tmp.fail = failNum;
					_do();
					return false;
				}
				$.ajax({
					url:'/bhost/paste_node',
					type: "post",
					cache:false,
					data: {a0:$("input[name=se]").val(),a1:oldpid,a2:newpid,a3:isuser,a4:iscut,a5:copy_id,a10:"运维管理>主机管理"},
					success: function(Result) {
						clearTimeout(time);
						time = setTimeout(function(){_do();},1);
						var ugroup_result = JSON.parse(Result);
						if(ugroup_result.Result == false){
							finishNum++;
							result_tmp.finish = finishNum;
							failNum++;
							result_tmp.fail = failNum;
						}else{
							finishNum++;
							result_tmp.finish = finishNum;
							successNum++;
							result_tmp.success = successNum;
						}
					}
				})
			}
			_do();
		}
		pasteUserG();
	}
}
//刷新
function refresh(){
	if(filter_flag) filterHostManage();
	else $("#"+ parent_id).click();
	if_paste = false;
	_initSize();
}

//检索过滤
function ChangeFilterSelect(){
	return false;
	if($("#filtername").val() == -1){
		$("#filterWW").hide();
		$("#filte_value").hide();
		$('#filte_value').val('');
		filter_flag = false;
	}else{
		var $sel = $('#filterWW');
		var len = $('li',$sel).length;

		if(len == 0){
			$sel.hide();
		}else if(len == 1){
			$("#filterWW").show();
			$('>span.ww',$sel).show();
			$sel.addClass('selector-multiple');
		}else{
			$("#filterWW").show();
			$('>span.ww',$sel).show();
			$sel.addClass('selector-multiple');
		}	
		$("#filte_value").show();
		//$("#filterWW").show();
		//selView();
	}
}

//搜索条件
var nameReg = /^[A-Za-z0-9_-]+$/;
function _addFilter(obj,type){  // 0 -> 只是搜索   1-> 添加條件
	var type_text = $(obj).parent().children('select').children('option:selected').text();
	var type_value = $(obj).parent().children('select').children('option:selected').val();
	
	var filte_value = $(obj).parent().children('input[type=text]').val();
	if(filte_value == '' && type_value != -1){
		_alert(2,'搜索',"请输入关键字");
		return;
	}else{
		filte_value = $.trim(filte_value);
		if(filter_list.indexOf(type_text+'：'+filte_value) >=0){
			_alert(2,'搜索',"已存在相同的搜索条件");
			return;
		}
		if(type_value == -1){
			$('#filterWW').hide();
			$('#clearFilter').hide();
			filter_list = [];
			filter_v = "";
			filter_flag = false;
			$('#filterWW>ul').empty();
			$('#' + parent_id).click();
			return false;
		}else if(type_value == 0){
			var namecheck = /^[_\-.\n\w\s\u4e00-\u9fa5]*$/;
			if(!namecheck.test(filte_value)){
				_alert(2,'搜索',"组名格式不正确");
				return;
			}
		}else if(type_value == 1){
			var namecheck = /^[_\-.\n\s\w\u4e00-\u9fa5]*$/;
			if(!namecheck.test(filte_value)){
				_alert(2,'搜索',"主机名格式不正确");
				return;
			}
		}
		else if(type_value == 2){
			var namecheck = /^[_\-.\n\w\s]*$/;
			if(!namecheck.test(filte_value)){
				_alert(2,'搜索',"IP地址格式不正确");
				return;
			}
		}else if(type_value == 3){
			var namecheck = /^[_\-.\n\w\s]*$/;
			if(!namecheck.test(filte_value)){
				_alert(2,'搜索',"设备类型格式不正确");
				return;
			}
		}else if(type_value == 4){
			if(patch(filte_value,"@") <= 1){
				if(!acc_namereg.test(filte_value)){
					_alert(2,'搜索',"账号格式不正确");
					return false;
				}
			}else{
				_alert(2,'搜索',"账号格式不正确");
				return false;
			}			
		}
		
		if(type == false){
			filterHostManage(false);
		}
		else{
			$('#filterWW>ul').append('<li><span class="ww" name="'+type_value+'" data=\"'+filte_value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/ /g, "&nbsp;")+'\">'+type_text+'：'+filte_value+'</span><i class="del" onclick="_delFilter(this)"></i></li>');
			selView();
		}
	}
}

//模糊检索

function change_input_list(obj){
	if ($(obj).val() == ""){
		flag_addF = true;
		filterHostManage();
	}
}

var flag_addF = false;
function _addFilterFuzzy(obj,type){
	var type_text = $(obj).parent().children('select').children('option:selected').text();
	var type_value = $(obj).parent().children('select').children('option:selected').val();
	if (type_text=='所有'){
		type_text='';
	}else{
		type_text=type_text+'-';
	}
	type_value=type_value+'-';
	var filte_value = $(obj).parent().children('input[type=text]').val();
	if(filte_value == ''){
		if(type == true){
			$('button').blur();
			_alert(2,'搜索',"请输入关键字");
			return;
		}else{
			$('button').blur();
			_alert(2,'搜索',"请输入关键字");
			return;
			filterHostManage();
			flag_addF = true;
		}
	}else{
		filte_value = $.trim(filte_value);
		if($('span[name="'+type_value+filte_value+'"]').length>0){
			$('button').blur();
			_alert(2,'搜索',"已存在相同的搜索条件");
			return;
		}
		/*
		if (type_text != "所有"){
			$("#find_select").empty().append('<option value="0">所有</option><option value="'+type_value+'">'+type_text+'</option>');
			$("#find_select").val(type_value).trigger('change');
		}*/
		/*
		var namecheck = /^[_\-.\n\w\s\u4e00-\u9fa5]*$/;
		if(!namecheck.test(filte_value)){
			_alert(2,'搜索',"关键词格式不正确",$(obj).parent().children('input[type=text]'));
			return;
		}*/
		
		
		if(type == false){
			flag_addF = true;
			filterHostManage();
		}
		else{
			flag_addF = false;
			$('#filterWW>ul').append('<li><span class="ww" name="'+type_value+filte_value+'" data=\"'+filte_value+'\">'+type_text+filte_value+'</span><i class="del" onclick="_delFilter(this)"></i></li>');
			selView();
			$('#filte_value').val('');
			$('#v_clear').hide();
			////yt 2018 0503
			//change_select(type_text);
			
		}
	}
}
function change_select(type_text){
	type_value = $("#find_select").val();
	if(type_text == ""){
		$("#find_select").empty().append('<option value="all" selected="">所有</option><option value="hgname">主机组名</option><option value="hostname">主机名</option><option value="hostip">主机IP</option><option value="devicetypename">设备类型</option><option value="hostservicename">主机服务名</option><option value="accountname">账号</option><option value="protocolname">协议</option>');
	}else if(type_text.indexOf( "主机组名") >=0){
        $("#find_select").empty().append('<option value="all" selected="">所有</option><option value="hgname">主机组名</option><option value="hostname">主机名</option><option value="hostip">主机IP</option><option value="devicetypename">设备类型</option><option value="hostservicename">主机服务名</option><option value="accountname">账号</option><option value="protocolname">协议</option>');
    }else{
		$("#find_select").empty().append('<option value="all" selected="">所有</option><option value="hgname">主机组名</option><option value="hostname">主机名</option><option value="hostip">主机IP</option><option value="devicetypename">设备类型</option><option value="hostservicename">主机服务名</option><option value="accountname">账号</option><option value="protocolname">协议</option>');
	}
	$("#find_select").val(type_value).trigger('change');
}
function _clearFilter(obj,num){
	if(num==1){
		$('#filte_value').val('');
		$('#v_clear').hide();
		flag_addF = true;
		selView();
		//change_select('','all');
		return;
	}
	//$(obj).next().children('ul').empty();
	$('#v_clear').hide();
	flag_addF = false;
	$('#clearFilter').next().children('ul').empty();
	selView();
	//change_select('');
	
}
function _delFilter(obj){
	//ft = $(obj).parent().children('span').text().split("-");
	$(obj).parent().remove();//删除父元素，也就是一行。
	selView();
	//get_allprotocol_list();
	//filter_all();
	//jump(0);
	//filterHostManage();
}
var filter_v = "";
var  filter_list = [];	
var filter_flag = false;
var filter_res =[];
function selView(){
	var $sel = $('#filterWW');
	var len = $('li',$sel).length;
	if(len == 0){
		$sel.hide();
		$('#clearFilter').hide();
	}else if(len == 1){
		$("#filterWW").show();		
		$('>span.ww',$sel).show();
		$sel.addClass('selector-multiple');
		$('#clearFilter').show();
	}else{
		$("#filterWW").show();
		$('>span.ww',$sel).show();
		$sel.addClass('selector-multiple');
		$('#clearFilter').show();
	}
	//filter_all();
	var flag_hgname = false;
	var flag_all_count = 0;
	if(len == 0){
		change_select('');
	}else{
		$("#filterWW li span").each(function(i,item){
			if($(this).attr("name").indexOf('hgname') >=0){
				flag_hgname = true;
				return false;
			}
			if($(this).attr("name").indexOf('all') >=0){
				flag_all_count +=1;
			}
		})
		if(flag_hgname == true){
			change_select('主机组名');
		}else if(flag_all_count == $("#filterWW li span").length){
			change_select('');
		}else{
			change_select('主机名');
		}
	}
	filterHostManage();
}
function filterHostManage(){
	$('#hostContent').empty();
	
	var all = "";
	var hgname = "";
	var hostname = "";
	var hostip = "";
	var devicetypename = "";
	var hostservicename = "";
	var accountname = "";
	var protocolname = "";
	var filter_v;
	$("#filterWW>ul span").each(function(i,item){
		type_text=$(this).attr('name');
		filte_value = $(this).attr('data');
		var type_filte=type_text.substring(0,type_text.indexOf('-'));
		var value_filte=type_text.substring(type_text.indexOf('-')+1);
		switch (type_filte) {
			case 'all':
				all+=(value_filte+'\\n');
				break;
			case 'hgname':
			hgname+=(value_filte+'\\n');
				break;
			case 'hostname':
			hostname+=(value_filte+'\\n');
				break;
			case 'hostip':
			hostip+=(value_filte+'\\n');
				break;
			case 'devicetypename':
			devicetypename+=(value_filte+'\\n');
				break;
			case 'hostservicename':
			hostservicename+=(value_filte+'\\n');
				break;
			case 'accountname':
			accountname+=(value_filte+'\\n');
				break;
			case 'protocolname':
			protocolname+=(value_filte+'\\n');
				break;
		}
	}) 
	if(flag_addF == true){ 
		filte_value = $('#filte_value').val();
		switch ($('#find_select').val()) {
			case 'all':
				all+=(filte_value+'\\n');
				break;
			case 'hgname':
				hgname+=(filte_value+'\\n');
				break;
			case 'hostname':
				hostname+=(filte_value+'\\n');
				break;
			case 'hostip':
				hostip+=(filte_value+'\\n');
				break;
			case 'devicetypename':
				devicetypename+=(filte_value+'\\n');
				break;
			case 'hostservicename':
				hostservicename+=(filte_value+'\\n');
				break;
			case 'accountname':
				accountname+=(filte_value+'\\n');
				break;
			case 'protocolname':
				protocolname+=(filte_value+'\\n');
				break;
		}
	}
	if(all!=''){
		all = all.substr(0,all.length-2);
	}	
	if(hgname!=''){
		hgname = hgname.substr(0,hgname.length-2);
	}
	if(hostname!=''){
		hostname = hostname.substr(0,hostname.length-2);
	}
	if(hostip!=''){
		hostip = hostip.substr(0,hostip.length-2);
	}
	if(devicetypename!=''){
		devicetypename = devicetypename.substr(0,devicetypename.length-2);
	}
	if(hostservicename!=''){
		hostservicename = hostservicename.substr(0,hostservicename.length-2);
	}
	if(accountname!=''){
		accountname = accountname.substr(0,accountname.length-2);
	}
	if(protocolname!=''){
		protocolname = protocolname.substr(0,protocolname.length-2);
	}
	filter_v = all+'\t'+hgname+'\t'+hostname+'\t'+hostip+'\t'+devicetypename+'\t'+hostservicename+'\t'+accountname+'\t'+protocolname;
	if(filter_v.replace(/\t/g,'')==''){
		filter_v='';
	}
	if(parent_id.indexOf('root')>=0) pid = 0;
	else pid = parent_id.split('-')[2];
	if(filter_v == ''){
		$('#'+parent_id).click();
		return false;
	}
	if(filter_v != ""){
		_getWait($(".waitTip"));
		$.ajax({
			url:'/bhost/FindHostDirectory',
			type: "post",
			async:true,
			cache:false,
			data: {a0:$("input[name=se]").val(),a1:pid,a2:filter_v},
			success: function(Result) {
				_waitDone($(".waitTip"));
				var par_id = $("#hostRoute").children().next().children("a:last").attr("id");
				if(par_id == undefined){
					par_id = 0;
				}else{
					par_id = $("#hostRoute").children().next().children("a:last").attr("id").split('-')[2];
				}
				if(par_id == pid){
					filter_res = JSON.parse(Result);
					filter_flag = true;
					//展开 左侧
					foldAll(pid);
					//展示所有的过滤信息;
					if(filter_res == ""){
						$('button').blur();
						_alert(0,"搜索","无搜索结果");
					}
					getFliterInfo();
					return true;
				}else{
					filter_flag = false;
				}
			}
		})
	}else{
		filter_flag = false;
		refresh();
	}
}
function clear_filter(){
	$('#filterWW').hide();
	filter_list = [];
	filter_v = "";
	filter_flag = false;
	$('#filterWW>ul').empty();
	$('#filte_value').val('');
	$('#v_clear').hide();
	$('#clearFilter').hide();
	//$('#filtername').val('-1').trigger('change');
	//_initHostMenu();
	_initSize();
	c_parent_id = "";
}
function foldAll(id){
	if(parent_id.indexOf('root') >=0){
	
	}
	else if($('#'+parent_id).prev().attr('class').indexOf('h-aicon-d') <0){
		$('#'+parent_id).prev().click();
	}
	$(filter_res).each(function(i,item){
		ppath = item.Path;
		ppathlist = ppath.split('/');
		var pid = 0;
		$(ppathlist).each(function(i1,item1){
			if(i1 == 0) {
				pid = id;
				return true;
			}
			pid_curr = item1.split(',')[1];
			if(i1 == ppathlist.length-1) {
				if(item.Type == 2){
					return false;
				}
			}
			if($('#node-'+ pid +'-'+pid_curr).prev().length>0 && $('#node-'+ pid +'-'+pid_curr).prev().attr('class').indexOf('h-aicon-d') <0){
				$('#node-'+ pid +'-'+pid_curr).prev().click();
			}
			pid = pid_curr;
		})
		
	})
}
function getFliterInfo(){
	list_or_ico();
	$.each(filter_res,function(i,item){
		if(item.Type == 1){
			var curr_path = [];
			curr_tmp = item.Path.split('/');
			HGName = curr_tmp[curr_tmp.length-1].split(',')[0];
			//curr_tmp.pop();
			$(curr_tmp).each(function(i1,item1){
				curr_path.push(item1.split(',')[0]);
			})
			if(first_grp=='0'){
				$('#hostContent').append('<div class="item"><div class="c" ppath="'+curr_path.join('/')+'" id="cnode-'+item.Parent+'-'+item.Id+'-g"><i class="h-bicon h-bicon-t"></i>'+HGName+'</div></div>');
			}
			else{
				$('#host_list_').append('<tr>'+
					'<td class="in">'+
						'<input type="checkbox" class="input_checkbox" id="in" style="" '+(HGName=='未分组'?'disabled':'')+'>'+
						'<div class="item"><div class="c" ppath="'+curr_path.join('/')+'" id="cnode-'+item.Parent+'-'+item.Id+'-g"><i class="h-bicon h-bicon-t"></i>'+HGName+'</div></div>'+
					'</td>'+
					'<td title="'+HGName+'">'+HGName+'</td>'+
					'<td title="主机组">主机组</td>'+
					'<td></td>'+
					'<td></td>'+
					'<td><div class="tab-ctr">'+
						'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+' '+((HGName=='未分组')?'disabled':'')+'" id="'+
						((HGName=='未分组')?'':'_edit')+'" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
						'<a href="javascript:;" style="width:8px;" class="copy '+((HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
						((HGName=='未分组' || _if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
						'<a href="javascript:;" style="width:8px;" class="cut '+((HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((HGName=='未分组' || _if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
						'<a href="javascript:;" style="width:8px;" class="del '+((HGName=='未分组' || _if_disable =='1')?'disabled':'')+'" id="'+((HGName=='未分组' || _if_disable =='1')?'':'_del')+'" title="删除"></a>'+
						'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>'+
					'</div></td>'+
				'</tr>');
			}
		}	
	});
	$.each(filter_res,function(i,item){
		if(item.Type == 2){
			var curr_path = [];
			curr_tmp = item.Path.split('/');
			HostName = curr_tmp[curr_tmp.length-1].split(',')[0].split('\t')[0];;
			HostIp = curr_tmp[curr_tmp.length-1].split(',')[0].split('\t')[1];
			$(curr_tmp).each(function(i1,item1){
				curr_path.push(item1.split(',')[0].split('\t')[0]);
			})
			if(first_grp=='0'){
				$('#hostContent').append('<div class="item"><div class="c" ppath="'+curr_path.join('/')+'" id="cnode-'+item.Parent+'-'+item.Id+'-h"><i class="h-bicon h-bicon-c'+(item.Status == 2?'-disabled':'')+' h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+HostIp+'</br>('+HostName+')</div></div>');
			}
			else{
				$('#host_list_').append('<tr>'+
					'<td class="in">'+
						'<input type="checkbox" class="input_checkbox" id="in" style="">'+
						'<div class="item"><div class="c" ppath="'+curr_path.join('/')+'" id="cnode-'+item.Parent+'-'+item.Id+'-h"><i class="h-bicon h-bicon-c h-bicon-c-'+item.DeviceTypeIcon+'"></i>'+HostIp+'</br>('+HostName+')</div></div>'+
					'</td>'+
					'<td title="'+HostIp+'('+HostName+')">'+HostIp + '(' + HostName +')</td>'+
					'<td title="主机">主机</td>'+
					'<td title="'+item.DeviceTypeName+'">'+item.DeviceTypeName+'</td>'+
					'<td title="'+(item.Status == 2?'停用':'启用')+'">'+(item.Status == 2?'停用':'启用')+'</td>'+
					'<td><div class="tab-ctr">'+
						'<a href="javascript:;" style="width:8px;" class="'+(_if_disable =='1'?'search_result':'edit')+'" id="_edit" title="'+(_if_disable =='1'?'查看':'修改')+'"></a>'+
						'<a href="javascript:;" style="width:8px;" class="copy '+((_if_disable =='1' || parent_id == 'node-0-1')?'disabled':'')+'" id="'+
						((_if_disable =='1' || parent_id == 'node-0-1')?'':'_copy')+'" title="复制"></a>'+
						'<a href="javascript:;" style="width:8px;" class="cut '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_cut')+'" title="剪切"></a>'+
						'<a href="javascript:;" style="width:8px;" class="del '+((_if_disable =='1')?'disabled':'')+'" id="'+((_if_disable =='1')?'':'_del')+'" title="删除"></a>'+
						'<a href="javascript:;" style="width:8px;" class="move '+((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'disabled':'')+'" id="'+
						((_if_disable =='1' || parent_id == 'node-0-1' || parent_id == 'route-root')?'':'_remove')+'" title="移除"></a>'+
					'</div></td>'+
				'</tr>');
			}
		}	
	});
	list_initList();
	_initHostMenu();
	_initSize();
}
function back_all(){
	document.frm.tasktype.value = 3;
	document.frm.se.value = sess;
	document.frm.action = '/bhost/index';
	document.frm.i10.value = 0;
	document.frm.submit();
}

//
//访问授权
var auth_data; 
var auth_tmp = [];
var auth_tmp_g = [];
var auth_data_all = [];
var auth_arry=['-1'];
var auth_arry_g=['-1'];
function auth_select(obj,type){
	var t = $(obj).children('option:selected').val();
	if(type == 'g'){
		if (auth_arry_g.indexOf(t) === -1 && t != undefined){
			auth_arry_g.splice(0,1,t);
		}
	}else{
		if (auth_arry.indexOf(t) === -1 && t != undefined){
			auth_arry.splice(0,1,t);
		}
	}
	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();

		$(obj).parent().hide();

	}
}
function _addAuth(obj,type){
	var add = 0;
	var name2 = $(obj).parent().children('select').children('option:selected').val();
	if (name2 == undefined){
		$(obj).parent().children('select').val('-1').trigger('change');
		return false;
	}
	var t = $(obj).parent().children('select').children('option[value='+name2+']').text();
	if (name2 == -1){
		_alert(2,'主机管理',"请选择访问授权");
		return;
	}
	if(type == 'g'){
		auth_arry_g.splice(0,0,'-1');
	}else{
		auth_arry.splice(0,0,'-1');
	}
	auth_data_all.splice($.inArray(parseInt(name2), auth_data_all), 1);
	var $c = $(obj).parent();
	// $c.children('select').select2('destroy');
	var d = $('select>option:first',$c).val();
	if(type == 'g'){
		var $s = $('<li class="item" id="'+name2+'" style="float: left;margin-left: -19px; width: 315px; padding: 10px 6px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:238px;" disabled="true"><i class="ctrl del" onclick="_delAuth(this,\'g\')"></i></li>');
	}else{
		var $s = $('<li class="item" id="'+name2+'"style="width: 32%;float: left;margin-left: -19px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:170px;" disabled="true"><i class="ctrl del" onclick="_delAuth(this)"></i></li>');		
	}
	$c.children('select').val(d);
	$c.children('select').find('option[value='+name2+']').remove();

	$c.after($s);
	// $c.children('select').select2({minimumResultsForSearch: -1});
	auth_tmp=[];
	auth_tmp_g=[];
	if(type == 'g'){
		$("#select_a_g>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp_g.push(v_tmp);
		});
	}else{
		$("#select_a>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp.push(v_tmp);
		});
	}
}
function _delAuth(obj,type){
	var $c = $(obj).parent();
	var id = $c.attr('id');
	if(type == 'g'){
		var $p = $("#an_g");
	}else{
		var $p = $("#an");
	}
	var data, max;
	var min = 0;
	max = auth_data_all.length - 1;
	data = auth_data_all;

	var t = $(obj).siblings('input').val();
	$c.remove();
	if(type == 'g'){
		$("#an_g").parent().show();
	}else{
		$("#an").parent().show();
	}
	if(type == 'g'){
		auth_arry_g.splice($.inArray(id,auth_arry_g),1);
	}else{
		auth_arry.splice($.inArray(id,auth_arry),1);
	}

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<option value="' + id + '">' + t + '</option>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('option').eq(0).after('<option value="' + id + '">' + t + '</option>');
	} else {
		$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '">' + t + '</option>');
	}
	auth_data_all.splice(index_1, 0, parseInt(id));

	auth_tmp=[];
	auth_tmp_g = [];
	if(type == 'g'){
		$("#select_a_g>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp_g.push(v_tmp);
		});
	}else{
		$("#select_a>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp.push(v_tmp);
		});
	}
}

function _get_an(){
	$('#select_a').empty().html('<div class="item" style="width: 32%;float: left;margin-left: -19px;"><select class="filter-select" name="an" id="an" style="width:232px;" tabindex="-1" aria-hidden="false" onchange="auth_select(this)"></select><i class="ctrl add" onclick="_addAuth(this)"></i></div>');
	$('#select_a_g').empty().html('<div class="item" style="float: left;margin-left: -19px; width: 315px; padding: 10px 6px;"><select class="filter-select" name="an_g" id="an_g" style="width:270px;" tabindex="-1" aria-hidden="false" onchange="auth_select(this,\'g\')"></select><i class="ctrl add" onclick="_addAuth(this,\'g\')"></i></div>');
	$.ajax({
		url:"/bhost/get_access_way_x",
		type:"POST",
		async: true,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var result = JSON.parse(result);
			auth_data = result;
			if(result){
				data = result.data;
				$("#an").empty().append('<option value=\"-1\">请选择</option>');
				$("#an_g").empty().append('<option value=\"-1\" selected>请选择</option>');
				$.each(auth_data.data,function(i,item){
					if(item.AuthMode == 1) //只有 访问授权是对象指定的 才可以加
						$("#an").append('<option value="'+item.AccessAuthId+'" title="'+item.UserCode+'">'+item.AccessAuthName+'</option>');
						$("#an_g").append('<option value="'+item.AccessAuthId+'" title="'+item.UserCode+'">'+item.AccessAuthName+'</option>');
					auth_data_all.push(item.AccessAuthId);
				})
			}else{
				_alert(1,"获取访问授权",'失败：'+data.ErrMsg);
			}
		}
		
	})
	$('#select_a .filter-select').select2();
	$('#select_a_g .filter-select').select2();
}
function _del_frame(obj,data,arry){
	$(obj).children('select').children('option').remove();
	$(obj).children('select').append('<option value=\"-1\">请选择</option>');
	if (data[0].AccessAuthId != undefined){
		$.each(data,function(i1,item1){
			if(item1.AuthMode == 1){ //只有 访问授权是对象指定的 才可以加
				$(obj).children('select').append("<option value="+item1.AccessAuthId+">"+item1.AccessAuthName+"</option>");
			}
		});
	}
	$(obj).children('select').val(arry[0]).trigger('change');
}
</script>

<script>
function myBrowser(){
	var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
	var isOpera = userAgent.indexOf("Opera") > -1;
	if (isOpera) {
		return "Opera"
	}; //判断是否Opera浏览器
	if (userAgent.indexOf("Firefox") > -1) {
		return "FF";
	} //判断是否Firefox浏览器
	if (userAgent.indexOf("Chrome") > -1){
		return "Chrome";
	}
	if (userAgent.indexOf("Safari") > -1) {
		return "Safari";
	} //判断是否Safari浏览器
	if (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera) {
		return "IE";
	}; //判断是否IE浏览器
}
var M_AUTH = false;//false在管理授权下  true全部白名单
$(function () {
	var myBrowser_value=myBrowser();
	if(myBrowser_value=='FF'){
		$('#v_clear').css('margin-left',-77);
	}
	usercode = window.parent.document.frm.us.value;
	//初始化搜索
	// $('#server_text').hide();
	// $('#server_select').on('change', function () {
	// 	var server_select = $('#server_select').val();
	// 	if (server_select == 0) {
	// 		if (!$('#server_text').is(':hidden')) {
	// 			$('#server_text').hide();
	// 		}
	// 	} else {
	// 		if ($('#server_text').is(':hidden')) {
	// 			$('#server_text').show();
	// 		}
	// 	}
	// });
	
})
	var search_typeall_r = ''; //所有的条件
	var search_all_tmp = '';//添加的条件
	var search_all_tmp = '';//添加的条件
	//加入搜索
	function _addFilter1(obj) {
		var id = $(obj).parent().children('select').children('option:selected').val();
		if (id == "0") {
			$('#filterWW1>ul').empty();
			search_typeall_r = "";
			$("#filterWW1").attr("style", "display:none;");
			selView_s();
			return false;
		}
		var v1 = $(obj).parent().children('select').children('option:selected').text();
		var v2 = $(obj).parent().children('input[type=text]').val().trim();
		if (v2 == '') {
			_alert(2, '搜索', '请输入关键字');
			return false;
		} else {
			if (id == 'ip') {
				var ip_reg = /^[0-9\.]*$/;
				if (!ip_reg.test(v2)) {
					_alert(1, '搜索', 'IP格式不正确');
					return false;
				}
			}
			var search_typeall = search_typeall_r;
			search_typeall = search_typeall + id + '-' + v2 + '\t';
			search_typeall_r = search_typeall;
			$('#filterWW1>ul').append('<li style="height: 18px;"><span style = "display:none;">' + id + '</span><span class="ww">' + v1 + '-' + v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter(this);"></i></li>')
			$("#server_text").val("");
		$('#server_text_check').hide();
			selView_s();
		}
	}
	function change_input(obj){
		if ($(obj).val() == ""){
			search_typeall_r = search_all_tmp;
			find_hostgroup();
		}
	}
	function _addFilterFuzzy_s(obj,type){
		var id = $(obj).parent().children('select').children('option:selected').val();
		var v1 = $(obj).parent().children('select').children('option:selected').text();
		var v2 = $(obj).parent().children('input[type=text]').val().trim();
		if (id == "0") {
			// $('#filterWW1>ul').empty();
			// search_typeall_r = "";
			// $("#filterWW1").attr("style", "display:none;");
			// selView_s();
			// return false;
			v1='';
		}else{
			v1=v1+'-';
		}
		if (v2 == '') {
			_alert(2, '搜索', '请输入关键字');
			return false;
		} else {
			if (id == 'ip') {
				var ip_reg = /^[0-9\.]*$/;
				if (!ip_reg.test(v2)) {
					_alert(1, '搜索', 'IP格式不正确');
					return false;
				}
			}
			if(type == false){ //直接搜索 不累加条件
				search_typeall_r = search_all_tmp + id + '-' + v2 + '\t';
			}else{
				search_all_tmp = search_all_tmp + id + '-' + v2 + '\t';
				search_typeall_r = search_all_tmp;
				$('#filterWW1>ul').append('<li style="height: 18px;"><span style = "display:none;">' + id+'-'+v2 + '</span><span class="ww">' + v1 + v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter_s(this);"></i></li>');
				$("#server_text").val("");
				$('#server_text_check').hide();
			}			
			selView_s();
		}
	}
	//清除
	function _clearFilter_s(obj,num){
		if(num==1){
			search_typeall_r = search_all_tmp;
			$("#server_text").val("");
			$('#server_text_check').hide();
			selView_s();	
			return;	
		}
		//$(obj).next().children('ul').empty();
		$('#clearFilter_s').next().children('ul').empty();
		search_typeall_r = "";
		search_all_tmp='';
		$("#server_text").val("");
		$('#server_text_check').hide();
		selView_s();		
	}
	//删除搜索
	function _delFilter_s(obj) {
		var id = $(obj).parent().find("span");
		var ids = $(id).eq(0).text();
		var v2_text = $(id).eq(1).text();
		var v2_str = v2_text.split("-");
		var search_typeall = search_typeall_r;
		v2_str[0] = "";
		var str_v2 = v2_str.join('-');
		var str = ids + '-' + str_v2.substr(1, str_v2.length);
		var search_str = "";
		var search_typeall_str = search_typeall.split("\t");
		var i2 = 0;
		$.each(search_typeall_str, function (i, item) {
			if (i2 == 0 && item == ids) {
				i2 = 1;
			} else if (item != "") {
				search_str = search_str + item + '\t';
			}
		})
		search_typeall_r = search_str;
		$(obj).parent().remove();
		selView_s();
	}
	//显示搜索条件
	function selView_s() {
		//$('#hostTree').find('span.h-name-red').find('.font-red').removeClass('font-red');
		var $sel = $('#filterWW1');
		var len = $('li', $sel).length;

		if (len == 0) {
			$sel.hide();
			$('#clearFilter_s').hide();
		} else if (len == 1) {
			$("#filterWW1").show();
			$('>span.ww', $sel).show();
			$sel.addClass('selector-multiple');
			$('#clearFilter_s').show();
		} else {
			$("#filterWW1").show();
			$('>span.ww', $sel).show();
			$sel.addClass('selector-multiple');
			$('#clearFilter_s').show();
		}
		find_hostgroup();
	}
	
//返回第一个标红处
function scrollTop_check() {
	if (data_array_Path.length != 0) {
		var top = 9999;
		$.each(data_array_Path, function (i, item) {
			if (item.Type == 1) {
				var top_item = $('#node-' + item.Id).offset().top;
				if (top_item < top) {
					top = top_item;
				}
			} else {
				var Path_array = item.Path.split('/');
				var len = Path_array.length;
				var $i_item = $('#node-' + Path_array[len - 2].split(',')[1]).siblings('i.h-aicon');
				var top_item = $i_item.siblings('ul').find('li').find('input[id=HostId-' + item.Id + ']').eq(0).offset().top;
				if (top_item < top) {
					top = top_item;
				}
			}
		});
		$('.c-cont').scrollTop(top - 100);
	}
}
var usercode = "";

</script>

<script>
	// $.each(hgs,function(i,item){
	// 	global_path.push(parseInt(item.HGId));
	// })
var global_path = [];
function _initList_hg(hgs){
	global_path = [];
	h_id = current_id.split('-')[2];
	if(h_id == 0){
		$('#hostRoute div.h-path-wrap a').each(function(){
			global_path.push(parseInt($(this).attr('id').split('-')[2]))
		})	
	}else{
		$(hgs).each(function(i,item){
			global_path.push(item.HGId);
		})	
	}
	var Data = [];
	$.ajax({
		url:"/bhost/get_h_Dir",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:0,a2:h_id,t0:12},
		success:function(result){
			var result = JSON.parse(result);
			Data = result.data.HGroup;
		}
	})
	$('#hostTree').unbind();
	$('#hostTree').on('click','i.h-aicon',function(){
		var $item = $(this);
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if($u.is(':hidden')){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2;
				var $input = $(this).siblings('span.checkbox');
				
	    	var c = $input.attr('class');
	    	if(c.indexOf('checked')>0){
	    		v=1;
	    	}else if(c == 'checkbox'){
	    		v=0;
	    	}
				_initHTML($u,id,v);
			}
		}else{
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	}).on('dblclick','i.h-eicon,span.h-name',function(){
		var $item = $(this).siblings('i:first');
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if($u.is(':hidden')){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2;
				var $input = $(this).siblings('span.checkbox');
				
	    	var c = $input.attr('class');
	    	if(c.indexOf('checked')>0){
	    		v=1;
	    	}else if(c == 'checkbox'){
	    		v=0;
	    	}

				_initHTML($u,id,v);
			}
		}else{
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	})
	var data = Data;
	_viewHTML(data,'#hostTree');
}

function _initHTML(obj,id,v){
	var host_id = current_id.split('-')[2];
	
	$.ajax({
		url:"/bhost/get_h_Dir",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a1:id,a2:h_id,t0:12},
		success:function(result){
			var result = JSON.parse(result);
			nodeData = result.data.HGroup;
		}
	})	
	var cdata = nodeData;
	$(obj).empty();
	var PGetHNodeSelected_json ={
		"type":7,
		"id":host_id,
		"ishost": false,
		"hnodeset": [
			{
				"parentid": 7,
				"hid": 3
			}
		],
		"srcinfo":{
		}
	}
	$.each(nodeData,function(i,item){
		var $H = $('<li></li>');
		if(item.MemberNum <= 0 ){
			class_name = 'h-blank blank_in';
		}else{
			class_name = 'h-aicon';
		}
		item.Selected_host = 0;
		if(host_id == 0){
			if(( index_path= global_path.indexOf(item.HGId)) >=0){
				if(index_path == global_path.length-1 && item.Mode == 2) item.Selected=2;
			}
		}else{
			$.ajax({
				url: "/bhost/IsHNodeSelected",
				type:"POST",
				async:false,
				data:{a0:$("input[name=se]").val(),z1:7,z2:host_id,z3:item.HGId,z4:false,z5:'null',z6:0},
				success:function(result){
					var result = JSON.parse(result);
					if (result.info.status == 2) {
						item.Selected = result.info.status;
						if (item.Selected == 2 && global_path.indexOf(item.HGId) == -1) item.Selected = 1;
					}
					item.Selected_host= result.info.status;
					
				}
			})
		}
		var flag_disabled = '';
		if(item.Mode == 0){
			flag_disabled = 'disabled';
		}
		if(item.Selected==2){ //全选
			$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" checked="checked" id="node-'+item.HGId+'" '+flag_disabled+' data-check="1" class="zcheck zcheck-g" mode="'+item.Mode+'" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
			'<span class="h-name-son" style="">' + 
			item.HGName.split('').map(function (params) {
				return '<font>'+params+'</font>'    
			}).join('') + 
			'</span>'+
			'</span>'+		
			'<ul style="display:none">Loading...</ul>');
		}
		else if(item.Selected==0){ //不选
			if (item.Mode == 0) {
				return true;
			}
			$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" id="node-'+item.HGId+'" ' + flag_disabled +' data-check="0" class="zcheck zcheck-g" mode="'+item.Mode+'" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'+
			'<span class="h-name-son" style="">' + 
			item.HGName.split('').map(function (params) {
				return '<font>'+params+'</font>'    
			}).join('') + 
			'</span>'+
			'</span>'+
			'</span><ul style="display:none">Loading...</ul>');
		}
		else{ //部分选
			$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" id="node-'+item.HGId+'" '+flag_disabled+' data-check="0" class="zcheck zcheck-g" mode="'+item.Mode+'" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
			'<span class="h-name-son" style="">' + 
			item.HGName.split('').map(function (params) {
				return '<font>'+params+'</font>'    
			}).join('') + 
			'</span>'+
			'</span><ul style="display:none">Loading...</ul>');
		}
		$(obj).append($H);
		_checkView(obj);
		if(item.Selected_host !=0){
			$("#node-"+item.HGId+"").parent().children('i').eq(0).click();
		}
	});
	_checkView(obj);
}

/*
{
	"HGId": 1,
	"Mode": 0,
	"HGName": "未分组",
	"HostNum": 38,
	"Selected": 0,
	"MemberNum": 0
}

*/

function _viewHTML(data,obj){
	$(obj).empty();
	var host_id = current_id.split('-')[2];
	if(host_id == 0){
		$.each(data,function(i,item){
			if(item.HGId == 1) return true;
			var $H = $('<li></li>');
			if(item.MemberNum <= 0 ){
				class_name = 'h-blank blank_in';
			}else{
				class_name = 'h-aicon';
			}
			item.Selected_host = 0;
			var index_path = 0;
			if (host_id == 0) {
				if ((index_path = global_path.indexOf(item.HGId)) >= 0) {
					if (index_path == global_path.length - 1 && item.Mode == 2) item.Selected = 2;
				}
			} else {
				$.ajax({
					url: "/bhost/IsHNodeSelected",
					type: "POST",
					async: false,
					data: { a0: $("input[name=se]").val(), z1: 7, z2: host_id, z3: item.HGId, z4: false, z5: 'null', z6: 0 },
					success: function (result) {
						var result = JSON.parse(result);
						if (result.info.status == 2) {
							item.Selected = result.info.status;
							if (item.Selected == 2 && global_path.indexOf(item.HGId) == -1) item.Selected = 1;
						}
						item.Selected_host = result.info.status;
					}
				})
			}
			var flag_disabled = '';
			if(item.Mode == 0){
				flag_disabled = 'disabled';
			}
			if(item.Selected==2){ //全选
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" checked="checked" id="node-'+item.HGId+'" '+flag_disabled+' data-check="1" class="zcheck zcheck-g" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			}else if(item.Selected==0){ //不选
				if(item.Mode == 0) return true;
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" id="node-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'+
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			}else{ //部分选
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" id="node-'+item.HGId+'" '+flag_disabled+' data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'+
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			}

			$(obj).append($H);
			_checkView(obj);	
		});
		$.each(current_path,function(i,item){
			$("#node-"+item+"").parent().children('i').eq(0).click();
		});
		var host_pid = current_id.split('-')[1];
		if($('#node-'+host_pid).is(':checked') == false && $('#node-' + host_pid).is(':disabled')==false){
			$('#node-'+host_pid).click();
		}
	}
	else{
		var PGetHNodeSelected_json ={
			"type":7,
			"id":host_id,
			"ishost": false,
			"hnodeset": [
				{
					"parentid": 7,
					"hid": 3
				}
			],
			"srcinfo":{
			}
		}
		$.each(data,function(i,item){
			if(item.HGId == 1) return true;
			var $H = $('<li></li>');
			if(item.MemberNum <= 0 ){
				class_name = 'h-blank blank_in';
			}else{
				class_name = 'h-aicon';
			}
			item.Selected_host = 0;
			$.ajax({
				url: "/bhost/IsHNodeSelected",
				type:"POST",
				async:false,
				data:{a0:$("input[name=se]").val(),z1:7,z2:host_id,z3:item.HGId,z4:false,z5:'null',z6:0},
				success:function(result){
					var result = JSON.parse(result);
					if(result.info.status==2){
						item.Selected = result.info.status;
						if (item.Selected == 2 && global_path.indexOf(item.HGId) == -1) item.Selected = 1;
					}
					item.Selected_host = result.info.status;
				}
			})
			var flag_disabled = '';
			if(item.Mode == 0){
				flag_disabled = 'disabled';
			}
			if(item.Selected==2){ //全选
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" checked="checked" id="node-'+item.HGId+'" '+flag_disabled+' data-check="1" class="zcheck zcheck-g" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'+
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			}else if(item.Selected==0){ //不选
				if(item.Mode == 0) return true;
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" id="node-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'" ><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'+
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			}else{ //部分选
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.HGId+'" /><input type="checkbox" id="node-'+item.HGId+'" '+flag_disabled+' data-check="0" class="zcheck zcheck-g" data-name="'+item.HGName+'"><i class="h-eicon h-eicon-t-m"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;" >'+
				'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
				'</span><ul style="display:none">Loading...</ul>');
			}

			$(obj).append($H);
			_checkView(obj);
			if(item.Selected_host !=0){
				$("#node-"+item.HGId+"").parent().children('i').eq(0).click();
			}	
		});
	}
	_checkView(obj);	
}

function _checkView(obj){
    $('input.zcheck',obj).each(function(){
    	var $s = $('<span class="checkbox"></span>');
		if($(this).parent().find('span.checkbox').length == 0)
			$(this).after($s);
    	var v = $(this).prop('checked');
    	if(v){
    		$s.addClass('checked');
    	}else{
    		var c = $(this).data('check');
    		if(c && c==2){
    			$s.addClass('half');
    		}
    	}

    	var d = $(this).prop('disabled');
    	if(d){
    		$s.addClass('disabled');
    	}
    }).on('change',function(){
    	var v = $(this).prop('checked');
    	var $s = $(this).next('span.checkbox');
    	var $u = $(this).parent().children('ul');
    	if(v){
    		$s.attr('class','checkbox checked');
	    	//$('input.zcheck',$u).prop('checked',true);
	    	//$('span.checkbox',$u).attr('class','checkbox checked');
    	}else{
    		$s.attr('class','checkbox');
	    	//$('input.zcheck',$u).prop('checked',false);
	    	//$('span.checkbox',$u).attr('class','checkbox');
    	}

    	//_checkEvent(this);
    });
}

function _checkEvent(obj){
	var _run = function(){
		var $li = $(obj).parent().parent().parent();
		var tagname = $li[0].tagName.toLowerCase();
		var v = $(obj).prop('checked');
		if(tagname == 'li'){
			var c1=0,c2=0;
			var len = $(obj).parent().parent().children('li').length;
			$(obj).parent().parent().children('li').each(function(){
				var c = $(this).children('span.checkbox').attr('class');
				if(c.indexOf('checked')>0){
					c1++;
				}else if(c.indexOf('half')>0){
					c2++;
				}

				if(c1 == len){
					$li.children('input.zcheck').prop('checked',true).siblings('span.checkbox').attr('class','checkbox checked');//.siblings('span.authtype').show();
					$li.children('input.zcheck').attr("data-loadlast",2);
				}else if(c1==0 && c2==0){
					$li.children('input.zcheck').prop('checked',false).prop('disabled',false).siblings('span.checkbox').attr('class','checkbox').removeClass('disabled');//.siblings('span.authtype').hide();
							$li.children('input.zcheck').attr("data-loadlast",0);
					$li.children('input.zcheck').siblings('span.authtype').children('input').prop('checked',false).siblings('span.checkbox').attr('class','checkbox');
				}else{
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox half');
					$li.children('input.zcheck').attr("data-loadlast",1);
				}
			});
			_checkEvent($li.children('input.zcheck'));
		}else{
			return;
		}
	}
	_run();
}

//ping test 浮层
function _getDialog_pingTest() {

	if ($('#HostIP').val() == '') {
		_alert(2, 'PING测试', '请先输入主机IP',$('#HostIP'));
		return false;
	}
	$("#ping").val($('#HostIP').val()+" PING测试中...");
	var $dialogCont = $("#scDCTab3").show();
	title = 'PING测试';
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "scDCTab3",
		width: "500px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		d.close().remove();
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		d.close().remove();
	})
	$.ajax({
		url: '/bhost/ping_test',
		type: "post",
		async: true,
		cache: false,
		data: { a0: $("input[name=se]").val(), a1:$('#HostIP').val()},
		success: function (result) {
			res = JSON.parse(result.replace(/\n/g,"\\\\n").replace(/\r/g,"\\\\r"));
			if(res.ip == $('#HostIP').val()){
				str_o = res.result;
				str_n = str_o.replace(/\\n/g,"\r\n");
				$("#ping").val(str_n);
			}
		}
	})
}
//连接测试 浮层
var D;
function _getDialog_connectTest(accid,ser_arr) {
	connTest1 = accid;
	connTest2 = ser_arr;
	var hostIPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;

	var HostIP = $("#HostIP").val();
	if (HostIP == "") {
		_alert(2, "主机", "请输入主机IP", $('#HostIP'));
		return false;
	};
	if (!hostIPReg.test(HostIP)) {
		_alert(1, "主机", "主机IP格式不正确", $('#HostIP'));
		return false;
	};

	var n = false;
	$('#connectProtoSelect').empty();
	var proto_json=[];
	var arr1;
	var arr2;
	var ser_str = "";
	$(host.AccountSet).each(function(i,item){
		ser_str = "";
		$.each(item.HostServiceSet,function(i1,item1){
			ser_str += item1.ProtocolName + ',';	
		})
		ser_str = ser_str.substring(0,ser_str.length-1);		//去掉"，"
		arr1 = ser_str.split(',');
		arr2 = ser_arr.split(',');
		if(parseInt(accid) == item.HostAccount.AccountId && arr1.sort().toString() == arr2.sort().toString()){
			HostServiceSet_tmp = item.HostServiceSet;
			$(HostServiceSet_tmp).each(function(i1,item1){
				$(SUP_PROTOCOL).each(function(i2,item2){
					if(item2 == item1.ProtocolName){
						n = true;
						if($("#connectProtoSelect option[value="+item1.ProtocolId+"][port="+item1.Port+"]").length ==0){
							$('#connectProtoSelect').append("<option value=\""+item1.ProtocolId+"\" port=\""+item1.Port+"\">"+item1.ProtocolName+"("+item1.Port+")</option>");
						}
						proto_json.push(JSON.parse("{\"ProtocolId\":\""+item1.ProtocolId+"\",\"Port\":"+item1.Port+",\"ConnParamId\":\""+item1.ConnParamId+"\",\"ConnParamName\":\""+item1.ConnParamName+"\"}"))
					}
				})
			})
		}
	})
	$('#connectProtoSelect').select2('destroy').select2();
	if (n == false) {
		_alert(1, "主机", '仅支持: (MSSQL、SYBASE、ORACLE、SSH、TELNET、MYSQL、RLOGIN、DB2、VNC、FTP、RDP、INFORMIX)');	
		return false;
	}

	// var flag_acc_conn = 0;
	// $.each(arr2,function(i,item){
	// 	if(item == 'MYSQL' || item == 'MSSQL' || item == 'SYBASE' || item == 'ORACLE' || item == 'DB2'){
	// 		$("#acc_test_conn").show();
	// 		flag_acc_conn = 1;
	// 		return false;
	// 	}
	// })
	// if(flag_acc_conn == 0){
	// 	$("#acc_test_conn").hide();
	// }

	$("#connectProtoSelect").bind("change", function () {
		var proName = $('#connectProtoSelect').find("option:selected").text().split("(")[0];
		if(proName == 'MYSQL' || proName == 'MSSQL' || proName == 'SYBASE' || proName == 'ORACLE' || proName == 'DB2'){
			$("#acc_test_conn").show();
			var proto_id;
			$.each(proto_list.data,function(i,item){
				if(item.ProtocolName == proName){
					proto_id = item.ProtocolId;
					return false;
				}
			})
			$.ajax({
				url: '/bhost/get_ConnParam_list',
				type: "post",
				async: false,
				cache: false,
				data: { a0: $("input[name=se]").val(), a1: proto_id},
				success: function (Result) {
					ConnParamData = (JSON.parse(Result)).data;
					$("#connectParamSelect").empty();
					$("#connectParamSelect").append('<option value="-1" title="请选择">请选择</option>');
					$.each(ConnParamData,function(i,item){
						$("#connectParamSelect").append('<option value="'+item.ConnParamId+'" title="'+item.ConnParamName+'">'+item.ConnParamName+'</option>');
					})
				}
			});
		}else{
			$("#acc_test_conn").hide();
		}

		//$('#connectParamSelect').select2('destroy').select2();
		//$('#connectProtoSelect').select2('destroy').select2();
	})
	$("#connectProtoSelect").change();
	var $dialogCont = $("#scDCTab4").show();
	title = '连接测试';
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "scDCTab4",
		width: "800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	D = d;
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		reload(5);
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		test_save(accid,arr2);
	})
}
function test_save(accid,arr2){
	var jsondata = {
		"HostIP": null,
		"ProtocolName": null,
		"Port": null,
		"ServiceName": null,
		"AccountName": null,
		"Password": null,
		"PasswordType": null,
		"AcctSwitchCmd": null,
		"SwitchPasswdPrompt": null,
		"FromAccountName": null,
		"FromPassword": null,
		"FromPasswordType": null,
		"IsClearText1": false,
		"IsClearText2": false
	}
	var connServiceName;
	//取测试服务的连接参数信息
	if($("#connectParamSelect").val() != undefined && $("#connectParamSelect").val() != '-1'){
		$.ajax({
			url: '/bhost/get_connection_list',
			type: "post",
			async: false,
			cache: false,
			data: {a0:$("input[name=se]").val(),a1:$("#connectParamSelect").val()},
			success: function(Result){
				var result = JSON.parse(Result);
				result = result.info.data[0];
				connServiceName = result.ServiceName;
			}
		})
	}
	$("#conn_test").val("测试中...");
	jsondata.HostIP = $("#HostIP").val();
	jsondata.ProtocolName = $("#connectProtoSelect option:selected").text().split('(')[0];
	jsondata.Port = $("#connectProtoSelect option:selected").text().split('(')[1].split(')')[0];
	jsondata.ServiceName = connServiceName;
	//取账号信息;
	var acc_data;
	var arr1,IsClearText1;
	$.each(host.AccountSet,function(i,item){
		var ser_str = "";
		$.each(item.HostServiceSet,function(i1,item1){
			ser_str += item1.ProtocolName + ',';	
		})
		ser_str = ser_str.substring(0,ser_str.length-1);		//去掉"，"
		arr1 = ser_str.split(',');
		if(parseInt(accid) == item.HostAccount.AccountId && arr1.sort().toString() == arr2.sort().toString()){
			acc_data = item;
			IsClearText1 = item.IsClearText;
		}
	})
	//取账号和切换自账号的Name;
	var accName;
	var fromAccName;
	var flag1 = 0;
	var flag2 = 0;
	$.each(AccountData,function(i,item){
		if(acc_data.HostAccount.AccountId == item.AccountId){
			accName = item.AccountName;
			flag1 = 1;
		}else if(acc_data.HostAccount.FromAccountId == item.AccountId){
			fromAccName = item.AccountName;
			flag2 = 1;
		}
		if(flag1 == 1 && flag2 == 1){
			return false;
		}
	})
	//切换自账号的Password以及passwordtype;
	var fromAccId = acc_data.HostAccount.FromAccountId;
	var arr2;
	var ser_str = "";
	var fromAPwd,fromAPwdType,IsClearText2;
	$(host.AccountSet).each(function(i,item){
		$.each(item.HostServiceSet,function(i1,item1){
			ser_str += item1.ProtocolName + ',';	
		})
		ser_str = ser_str.substring(0,ser_str.length-1);		//去掉"，"
		arr1 = ser_str.split(',');
		if(parseInt(fromAccId) == item.HostAccount.AccountId && arr1.sort().toString() == arr2.sort().toString()){
			fromAPwd = item.Password;
			fromAPwdType = item.PasswordType;
			IsClearText2 = item.IsClearText2;
		}
	})
	jsondata.AccountName = accName;
	jsondata.Password = acc_data.Password;
	jsondata.PasswordType = acc_data.PasswordType;
	jsondata.AcctSwitchCmd = acc_data.HostAccount.AcctSwitchCmd;
	jsondata.SwitchPasswdPrompt = acc_data.HostAccount.SwitchPasswdPrompt;
	jsondata.FromAccountName = fromAccName;
	jsondata.FromPassword = fromAPwd;
	jsondata.FromPasswordType = fromAPwdType;
	jsondata.IsClearText1 = IsClearText1;
	jsondata.IsClearText2 = IsClearText2;
	var taskId;
	var msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
	$.ajax({
		url: '/bhost/conn_test',
		type: "post",
		async: false,
		cache: false,
		data: {a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
		success: function(Result){
			var result = JSON.parse(Result);
			taskId = result.Id;
			//show 结果textarea
			var $dialogCont_1 = $("#scDCTab4_1").show();
			title = '连接测试结果';
			var d_1 = dialog({
				title: title,
				content: $dialogCont_1,
				id: "scDCTab4_1",
				width: "500px"
			});
			d_1.addEventListener('close', function () {
				$dialogCont_1.appendTo("body").hide();
				clearInterval(interval_output);	
			});
			d_1.showModal();
			$("a.btn-cancle", $dialogCont_1).unbind().bind("click", function () {
				d_1.close().remove();
				D.close().remove();
				clearInterval(interval_output);
				$.ajax({
					url: '/bhost/del_conn_test',
					type: "post",
					async: false,
					data: {a0:$("input[name=se]").val(),a1:taskId},
					success: function(Result){
					}
				})
			});
			//每隔TEST_TIME秒取一次结果
			var test_timeout = 0;
			interval_output = setInterval(function(){
				$.ajax({
					url: '/bhost/get_conn_test',
					type: "post",
					async: false,
					cache: false,
					data: {a0:$("input[name=se]").val(),a1:taskId},
					success: function(Result){
						var test_result = JSON.parse(Result);
						if(test_result[0].Status == 2){
							$("#conn_test").val("连接成功!");
							clearInterval(interval_output);
						}else if(test_result[0].Status == 3 || test_result[0].Status == 4){
							$("#conn_test").val("连接失败!");
							clearInterval(interval_output);
						}else{

						}
						test_timeout += TEST_TIME;
						if(test_timeout >= TEST_TIMEOUT){
							$("#conn_test").val("连接失败!");
							clearInterval(interval_output);
						}
					}
				})}
			,TEST_TIME);
		}
	})
}

function host_test(){
		document.frm_access.tasktype.value=3;	
		document.frm_access.action = '/bhost/host_test_trust';
		document.frm_access.submit();
	}
function find_host(){
		document.frm_access.tasktype.value=1;
		document.frm_access.action = '/bhost/f_host_show';
		document.frm_access.submit();
}
	
// 连接参数 样式 可编辑
var $focusObj;
function _autoView(obj,i,j,k){
	$(document)[0].onclick = null;
	$focusObj = $(obj);
	
	var v = $.trim($(obj).val());
	var $view;
	if($('#autoView').length == 0){
		$('body').append('<div id="autoView" />');
	}
	$view = $('#autoView');
	var c = '';
	if (j == 0){
		$.each(connparm_list,function(i,item){
			if(v == ''){
				c += '<li><i class="edit" onclick="_addNew(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.ConnParamId+'" onclick="_setVal(this,0);">'+item.ConnParamName+'</a></li>';
			}else{
				if(item.ConnParamName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_addNew(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.ConnParamId+'" onclick="_setVal(this,0);">'+item.ConnParamName+'</a></li>';
				}
			}
		});
	}else if (j == 1){
		$.each(DomainName_list,function(i,item){
			if(v == ''){
				c += '<li><i class="edit" onclick="_addNew2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.DomainId+'" onclick="_setVal(this,1);">'+item.DomainName+'</a></li>';
			}else{
				if(item.DomainName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_addNew2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.DomainId+'" onclick="_setVal(this,1);">'+item.DomainName+'</a></li>';
				}
			}
		});
	}else if (j == 2){
		$.each(AccountData,function(i,item){
			if(item.AccountType == 0){
				item.AccountName = "*";
			}else if(item.AccountType == 2){
				item.AccountName = "-";
			}
			if(v == ''){
				c += '<li><i class="edit" onclick="_addNew1(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccountId+'" onclick="_setVal(this,2);">'+item.AccountName+'</a></li>';
			}else{
				if(item.AccountName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_addNew1(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccountId+'" onclick="_setVal(this,2);">'+item.AccountName+'</a></li>';
				}
			}
		});
	}else if (j == 3){
		if(k == 0){
			$.ajax({
				url: '/bhost/get_accIP',
				type: "post",
				async: true,
				cache: false,
				data: { a0: $("input[name=se]").val() },
				success: function (Result) {
					accIP_list = JSON.parse(Result);
				}
			})
		}
		$.each(accIP_list.data,function(i,item){
			var accopod_flag = 0;
			$(accipid_list).each(function(i1,item1){
				if(item.AccIPId == item1){
					accopod_flag = 1;
					return false;
				}
			})
			if(accopod_flag == 1){
				return true;
			}
			if(v == ''){
				c += '<li><i class="del" onclick="_delNode(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccIPId+'" onclick="_setVal(this,3);">'+item.AccIP+'</a></li>';
			}else{
				if(item.AccIP.indexOf(v) >= 0 ){
					c += '<li><i class="del" onclick="_delNode(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.AccIPId+'" onclick="_setVal(this,3);">'+item.AccIP+'</a></li>';
				}
			}
		});
	}else if (j == 4){
		var ser_array = [];
		$("#server_list input:checked").each(function () {
			ser_array.push($(this).attr('proto'));
		})
		$.each(host.AccountSet,function(i,item){
			var ser_arr = [];
			$.each(item.HostServiceSet,function(i1,item1){
				ser_arr.push(item1.ProtocolName);
			})
			if(ser_array.sort().toString().indexOf(ser_arr.sort().toString()) != -1){
				var accountName;
				$.each(account_list,function(i3,item3){
					if(item3.AccountId == item.HostAccount.AccountId){
						accountName = item3.Name;
						if(accountName == "*"){
							accountName = "*";
						}else if(accountName == "-"){
							accountName = "-";
						}
						return false;
					}
				})
				if($("#AccountName").find('span').text() != accountName){
					if(v == ''){
						c += '<li><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.HostAccount.AccountId+'" onclick="_setVal(this,2);">'+accountName+'</a></li>';
					}else{
						if(accountName.indexOf(v) >= 0 ){
							c += '<li><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden; href="javascript:;" id="'+item.HostAccount.AccountId+'" onclick="_setVal(this,2);">'+accountName+'</a></li>';
						}
					}							
				}
			}
		});
	}
	if(i==0){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" onclick="_addNew(this,0)">创建连接参数</a></div>');
	}else if(i == 1){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_addNew2(this,0);">创建AD域</a></div>');
	}else if(i == 2){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_addNew1(this,0);">创建账号</a></div>');
	}else if(i == 3){
		$view.html('<ul>'+c+'</ul>');
	}

	var offset = $(obj).offset();
	var w = $(obj).outerWidth();
	$view.css({
		top:offset.top+24,
		left:offset.left,
		width:w-12
	}).show();
	$(obj).parents('.g-tsel').addClass('on');
	if(c == ""){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
	}
}
var connection={
	"ConnParamId":0,
	"ConnParamName":null,
	"ProtocolId":0,
	"ServiceName":null,
	"ConnType":null,
	"ConnParamValue":null
};
function clear_conn(){
	$('#d_n').attr("disabled",false);
	$('#d_n').next().attr('class','v-check');
	$('#ConnParamDialog input').each(function(i,item){
		$(this).val('');
	})
	$("#ConnParamDialog select").each(function(i,item){
		var val1 = $(item).find('option:first').val();
		$(this).val(val1).trigger('change');
	})
	$("#Protocol").empty();
	$("#Protocol").append('<option value="0" selected>请选择</option>');
	$('#Protocol').val('0').trigger('change');
}
function NameRepeatCheck(NameStr){
	$.ajax({
		url: '/bhost/CheckConnName',
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(), a1: NameStr},
		success: function (result) {
			result1 = JSON.parse(result);
		}
	})
	if (result1.Id == 0) {
		return 1;
	}else{
		return -1;
	}
}
function _addNew(obj,type){
	editcp1 = obj;
	editcp2 = type;
	clear_conn();
	if(type == 0){
		connection={
			"ConnParamId":0,
			"ConnParamName":null,
			"ProtocolId":0,
			"ServiceName":null,
			"ConnType":null,
			"ConnParamValue":null
		};
		$("#Protocol").attr('disabled','true');
	}else if(type == 1){
		$("#Protocol").attr('disabled','true');
	}
	
	var $dialogCont = $("#ConnParamDialog").show();
	if(type == 0)  title = "连接参数"
	else title = "连接参数"
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"ConnParamDialog",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	//协议类型下拉框
	var Protocol_old = 0;
	$.ajax({
		url: "/bhost/get_protocol_list",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a3:30,a2:1,a4:",,"},
		success:function(result){
			var userinfo_result = JSON.parse(result);
			//if (userinfo_result.Result==true){
			var userinfo_data = userinfo_result.data;	
			$.each(userinfo_data,function(i,item){
				if(item.ProtocolId<1000){
				$("#Protocol").append('<option value="'+item.ProtocolId+'" text="'+item.ProtocolName+'">'+item.ProtocolName+'</option>');
				}
			});
			$('.form-select').select2();
			//}
		}
	});
	$("#Protocol").change(function(){
		var p_id=$(this).children("option:selected").val();
		$('#RDP').hide();
		$("#SSH").hide();
		$("#SFTP").hide();
		$('#MY_ConnType').hide();
		$("#HTTP").hide();
		$("#HTTPs").hide();
		$("#ORACLE").hide();
		$("#RADMIN").hide();
		$("#MSSQL").hide();
		$("#SYBASE").hide();
		$("#MY_DB2").hide();
		switch($('#Protocol option[value='+p_id+']').text()){
			case "RDP":
				$('#RDP').show();
				break;
			//SSH
			case "SSH":
				$('#SSH').show();
				break;
			case "SFTP":
				$('#SFTP').show();
				break;
			//HTTP(S)
			case "HTTP(S)":
				$("#HTTP").show();
				break;
			//HTTPS
			case "HTTPS":
				$("#HTTPs").show();
				break;
			//ORACLE
			case "ORACLE":
				$("#ORACLE").show();
				break;
			//RADMIN
			case "RADMIN":
				$("#RADMIN").show();
				break;
			//MSSQL
			case "MSSQL":
				$("#MSSQL").show();
				break;
			//MYSQL 
			case "MYSQL":
				$("#MY_DB2").show();
				//$('#MY_ConnType').show();
				break;
			//DB2
			case "DB2":
				$("#MY_DB2").show();
				break;
			//SYBASE
			case "SYBASE":
				$("#SYBASE").show();
				break;
		}
	});
	if($("#ProtocolName").data('value') != -1){
		$("#Protocol").val($("#ProtocolName").data('value')).trigger('change');
	}else{
		$("#Protocol").removeAttr("disabled");
		$("#Protocol").val("0").trigger('change');
	}
	//编辑页面
	ConnParamId = 0;
	if(type == 1){
		ConnParamId = $(obj).children('span').attr('data-value');
		$.ajax({
			url: "/bhost/get_connection_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:ConnParamId},
			success:function(result){
				var connection_result = JSON.parse(result);
				if (connection_result.Result==true){
					var connection_data = connection_result.info.data[0];
					Protocol_old = connection_data.ProtocolId;
					$("#d_n").val(connection_data.ConnParamName);
					$("#d_n").attr("disabled",true);
					$("#Protocol").val(connection_data.ProtocolId).trigger('change');
					$("#Protocol").attr('disabled',true);

					$('#RDP').hide();
					$("#SSH").hide();
					$("#SFTP").hide();
					$('#MY_ConnType').hide();
					$("#HTTP").hide();
					$("#HTTPs").hide();
					$("#ORACLE").hide();
					$("#RADMIN").hide();
					$("#MSSQL").hide();
					$("#SYBASE").hide();
					$("#MY_DB2").hide();
					switch(connection_data.ProtocolName){
						case 'RDP':
							$('#RDP').show();
							$('#rdpType').val(connection_data.ConnType).trigger('change');
							break;
						case 'SSH':
							$('#SSH').show();
							$('#ServiceName_ssh').val(connection_data.ServiceName).trigger('change');
							break;
						case 'SFTP':
							$('#SFTP').show();
							$('#ServiceName_sftp').val(connection_data.ServiceName).trigger('change');
							break;
						//HTTP(S)
						case 'HTTP(S)':
							$("#HTTP").show();
							$("#url").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#UserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#Submit").val(connection_data.ConnParamValue.substring(index+1));
							break;
						//HTTPs
						case 'HTTPS':
							$("#HTTPs").show();
							$("#httpsurl").val(connection_data.ServiceName);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserName").val(connection_data.ConnParamValue.substring(0,index));
							connection_data.ConnParamValue=connection_data.ConnParamValue.substring(index+1);
							var index=connection_data.ConnParamValue.indexOf('|');
							$("#httpsUserPwd").val(connection_data.ConnParamValue.substring(0,index));
							$("#httpsSubmit").val(connection_data.ConnParamValue.substring(index+1));
							//
							break;
						//ORACLE
						case 'ORACLE':
							//
							//指定项必填
							if(connection_data.ConnParamValue == "SID"){
								$("#appoint").val('1').trigger('change');
							}else if(connection_data.ConnParamValue == "SERVICE_NAME"){
								$("#appoint").val('2').trigger('change');
							}
							$("#s_n").val(connection_data.ServiceName);
							if(connection_data.ConnType==null){
								connection_data.ConnType="未指定";
							}
							if(connection_data.ConnType == "SYSOPER"){
								$("#conn").val('3').trigger('change');
							}else if(connection_data.ConnType == "SYSDBA"){
								$("#conn").val('2').trigger('change');
							}else if(connection_data.ConnType == "NORMAL"){
								$("#conn").val('1').trigger('change');
							}
							//$("#conn").children("option[text='"+connection_data.ConnType+"']").attr("selected",true);
							//
							$("#ORACLE").show();
							break;
						//RADMIN
						case 'RADMIN':
							//认证方式：
							if(connection_data.ConnType==null){
								$("#authtype").val('0').trigger('change');
							}else if(connection_data.ConnType == "RADMIN"){
								$("#authtype").val('1').trigger('change');
							}else if(connection_data.ConnType == "Windows"){
								$("#authtype").val('2').trigger('change');
							}
							// $("#authtype").children("option[text='"+connection_data.ConnType+"']").attr("selected",true);
							$("#RADMIN").show();
							break;
						//MSSQL
						case 'MSSQL':
							//
							//实例名：
							$("#o_n").val(connection_data.ServiceName);
							//认证方式：
							if(connection_data.ConnType==null){
								$("#R_authtype").val('0').trigger('change');
							}else if(connection_data.ConnType == "SQL服务器验证"){
								$("#R_authtype").val('1').trigger('change');
							}else if(connection_data.ConnType == "Windows验证"){
								$("#R_authtype").val('2').trigger('change');
							}else if(connection_data.ConnType == "Windows单一登录"){
								$("#R_authtype").val('2').trigger('change');
							}

							// $("#R_authtype").children("option[text='"+connection_data.ConnType+"']").attr("selected",true);
							//
							$("#MSSQL").show();
							break;
						//MYSQL 
						case 'MYSQL':
							//
							//数据库名：
							$('#sql_n').val(connection_data.ServiceName);
							//$('#MY_ConnType').show();
							$('#select_my').val(connection_data.ConnType).trigger('change');
							$("#MY_DB2").show();
							break;
						//DB2
						case 'DB2':
							//数据库名：
							$('#sql_n').val(connection_data.ServiceName);
							//
							$("#MY_DB2").show();
							break;
						//SYBASE
						case 'SYBASE':
							//实例名：
							$('#sy_o_n').val(connection_data.ServiceName);
							//
							$("#SYBASE").show();
							break;
					}
					$('.form-select').select2();
				}
			}
		});
	}

	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(9);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var match1 = /^((ht|f)tps?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?$/;
		var _nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		var sp_char = /^[^@\/\'\\\"#$%&\^\*]+$/;
		var p_id=$("#Protocol").children("option:selected").val();
		var p_name = $("#Protocol").children("option:selected").text();
		var val = $("#d_n").val();
		if(val == ""){
			switch (p_name){
				case "RDP":
					ServiceName = p_name+$("#rdpType").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "SSH":
					ServiceName = p_name+$("#ServiceName_ssh").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "SFTP":
					ServiceName = p_name+$("#ServiceName_sftp").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "ORACLE":
					var appoint=$("#appoint").children("option:selected").val();
					if(appoint=="0"){
						_alert(2, "主机","请选择指定项",$("#appoint"));
						return false;
					}
					var s_n=$("#s_n").val();
					if(s_n==""){
						_alert(2, "主机","请输入实例名或服务名",$("#s_n"));
						//$("#s_n").val("");
						return false;
					}else if(!sp_char.test(s_n)){
						_alert(1, "主机","实例名或服务名格式不正确",$("#s_n"));
						//$("#s_n").val("");
						return false;
					}
					var conn_text=$("#conn").children("option:selected").text();
					if(conn_text=="未指定"){
						conn_text=null;
					}
					ServiceName = p_name+$("#s_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						ServiceName += $("#appoint").children("option:selected").text();
						if(NameRepeatCheck(ServiceName) == -1){
							ServiceName += $("#conn").children("option:selected").text();
							if(NameRepeatCheck(ServiceName) == -1){
								_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
								return false;
							}
						}
					}
					break;
				case "MSSQL":
					var o_n=$("#o_n").val();
					if(o_n==""){
						_alert(2, "主机","请输入实例名",$("#o_n"));
						//$("#o_n").val("");
						return false;
					}else if(!sp_char.test(o_n)){
						_alert(1, "主机","实例名格式不正确",$("#o_n"));
						//$("#o_n").val("");
						return false;
					}
					ServiceName = p_name+$("#o_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						ServiceName += $("#R_authtype").children("option:selected").text();
						if(NameRepeatCheck(ServiceName) == -1){
							_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
							return false;
						}
					}
					break;
				case "MYSQL":
					var sql_n=$("#sql_n").val();
					if(sql_n==""){
						_alert(2, "主机","请输入数据库名",$("#sql_n"));
						//$('#sql_n').val("");
						return false;
					}else if (!sp_char.test(sql_n)){
						_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
						//$("#sql_n").val("");
						return false;
					}
					ServiceName = p_name+$("#sql_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "HTTP(S)":
					var url=$("#url").val();
					if (url == "") {
						_alert(2, "连接参数", "请输入URL", $("#url"));
						return false;
					}
					if (!match1.test(url) && url != "") {
						_alert(1, "连接参数", "URL格式不正确", $("#url"));
						//$("#UserPwd").val("");
						return false;
					}
					var UserName=$("#UserName").val();
					if(!sp_char.test(UserName) && UserName!=""){
						_alert(1, "主机","账号格式不正确",$("#UserName"));
						//$("#UserName").val("");
						return false;
					}
					var UserPwd=$("#UserPwd").val();
					if(!sp_char.test(UserPwd) && UserPwd!=""){
						_alert(1, "主机","密码格式不正确",$("#UserPwd"));
						//$("#UserPwd").val("");
						return false;
					}
					ServiceName = "HTTPS"+$("#url").val().split('://')[1].split('/')[0];
					if(ServiceName.indexOf(':') != -1){
						ServiceName = ServiceName.split(':')[0];
					}
					if(NameRepeatCheck(ServiceName) == -1){
						ServiceName += $("#UserName").val();
						if(NameRepeatCheck(ServiceName) == -1){
							ServiceName += $("#UserPwd").val();
							if(NameRepeatCheck(ServiceName) == -1){
								ServiceName += $("#Submit").val();
								if(NameRepeatCheck(ServiceName) == -1){
									_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
									return false;
								}
							}
						}
					}
					break;
				case "RADMIN":
					ServiceName = p_name+$("#authtype").children("option:selected").text();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "SYBASE":
					var sy_o_n=$("#sy_o_n").val();
					if(sy_o_n==""){
						_alert(2, "主机","请输入实例名",$("#sy_o_n"));
						//$('#sy_o_n').val("");
						return false;
					}else if (!sp_char.test(sy_o_n)){
						_alert(1, "主机",'实例名格式不正确',$("#sy_o_n"));
						//$("#sy_o_n").val("");
						return false;
					}
					ServiceName = p_name+$("#sy_o_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "DB2":
					var sql_n=$("#sql_n").val();
					if(sql_n==""){
						_alert(2, "主机","请输入数据库名",$("#sql_n"));
						//$('#sql_n').val("");
						return false;
					}else if (!sp_char.test(sql_n)){
						_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
						//$("#sql_n").val("");
						return false;
					}
					ServiceName = p_name+$("#sql_n").val();
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
				case "TELNET":
				case "FTP":
				case "VNC":
				case "X11":
				case "RLOGIN":
				case "PCANY":
				case "TN5250":
					ServiceName = p_name;
					if(NameRepeatCheck(ServiceName) == -1){
						_alert(1, "连接参数", "已存在相同配置", $("#d_n"));
						return false;
					}
					break;
			}
			val = ServiceName;
		}	
		var $i = $("#d_n").next('i.v-check');
		//事件告警信息名
		if(val==""){
			_alert(2,"主机",'请输入名称',$("#d_n"));
			return false;
		}
		if(!_nameReg.test(val)){
			_alert(1,"主机",'名称格式不正确',$("#d_n"));
			//$("#d_n").val("");
			return false;
		}
		if(p_id=="0"){
			_alert(2,"主机",'请选择协议类型',$("#Protocol"));
			return false;
		}
		connection.ConnParamName=val;
		connection.ConnParamId=parseInt(ConnParamId);
		connection.ProtocolId=parseInt(p_id);
		switch($('#Protocol option[value='+p_id+']').text()){
			case 'RDP':
				connection.ServiceName = null;
				connection.ConnType = $('#rdpType').val();
				connection.ConnParamValue = null;
				break;
			//SSH
			case "SSH":
				var ServiceName_ssh = $('#ServiceName_ssh').val();
				connection.ServiceName = ServiceName_ssh;
				connection.ConnType = null;
				connection.ConnParamValue = null;
				break;
			//SFTP
			case "SFTP":
				var ServiceName_ssh = $('#ServiceName_sftp').val();
				connection.ServiceName = ServiceName_ssh;
				connection.ConnType = null;
				connection.ConnParamValue = null;
				break;
			//HTTP(S)
			case "HTTP(S)":
				var url=$("#url").val();
				if (url == "") {
					_alert(2, "连接参数", "请输入URL", $("#url"));
					return false;
				}
				if (!match1.test(url) && url != "") {
					_alert(1, "连接参数", "URL格式不正确", $("#url"));
					//$("#UserPwd").val("");
					return false;
				}
				var UserName=$("#UserName").val();
				if(!sp_char.test(UserName) && UserName!=""){
					_alert(1, "主机","账号格式不正确",$("#UserName"));
					//$("#UserName").val("");
					return false;
				}
				var UserPwd=$("#UserPwd").val();
				if(!sp_char.test(UserPwd) && UserPwd!=""){
					_alert(1, "主机","密码格式不正确",$("#UserPwd"));
					//$("#UserPwd").val("");
					return false;
				}
				connection.ServiceName=url;
				connection.ConnType=null;
				var Submit=$("#Submit").val();
				var json_a = UserName + '|' + UserPwd + '|' + Submit;
				connection.ConnParamValue = json_a;
				break;
			//HTTPs
			case "HTTPS":
				var url = $("#httpsurl").val();
				if (url == "") {
					_alert(2, "主机", "请输入URL", $("#url"));
					return false;
				}
				var UserName = $("#httpsUserName").val();
				if (!sp_char.test(UserName) && UserName != "") {
					_alert(1, "主机", "账号格式不正确", $("#UserName"));
					//$("#UserName").val("");
					return false;
				}
				var UserPwd = $("#httpsUserPwd").val();
				if (!sp_char.test(UserPwd) && UserPwd != "") {
					_alert(1, "主机", "密码格式不正确", $("#UserPwd"));
					//$("#UserPwd").val("");
					return false;
				}
				connection.ServiceName = url;
				connection.ConnType = null;
				var Submit = $("#httpsSubmit").val();
				// Submit='"'+Submit+'"';
				// UserName='"'+UserName+'"';
				// UserPwd='"'+UserPwd+'"';
				var json_a = UserName + '|' + UserPwd + '|' + Submit;
				connection.ConnParamValue = json_a;
				break;
			//ORACLE
			case "ORACLE":
				//指定项必填
				var appoint=$("#appoint").children("option:selected").val();
				if(appoint=="0"){
					_alert(2, "主机","请选择指定项",$("#appoint"));
					return false;
				}
				var s_n=$("#s_n").val();
				if(s_n==""){
					_alert(2, "主机","请输入实例名或服务名",$("#s_n"));
					//$("#s_n").val("");
					return false;
				}else if(!sp_char.test(s_n)){
					_alert(1, "主机","实例名或服务名格式不正确",$("#s_n"));
					//$("#s_n").val("");
					return false;
				}
				var conn_text=$("#conn").children("option:selected").text();
				if(conn_text=="未指定"){
					conn_text=null;
				}
				var appoint_text=$("#appoint").children("option:selected").text();
				connection.ConnParamValue=appoint_text;
				connection.ServiceName=s_n;
				connection.ConnType=conn_text;
				break;
				//RADMIN
			//RADMIN
			case "RADMIN":
				//认证方式：
				var authtype=$("#authtype").children("option:selected").text();
				if(authtype=="未指定"){
					authtype=null;
				}
				connection.ServiceName=null;
				connection.ConnType=authtype;
				connection.ConnParamValue=null;
				break;
			//MSSQL
			case "MSSQL":
				//实例名：
				var o_n=$("#o_n").val();
				if(o_n==""){
					_alert(2, "主机","请输入实例名",$("#o_n"));
					//$("#o_n").val("");
					return false;
				}else if(!sp_char.test(o_n)){
					_alert(1, "主机","实例名格式不正确",$("#o_n"));
					//$("#o_n").val("");
					return false;
				}
				//认证方式：
				var R_authtype=$("#R_authtype").children("option:selected").text();
				if(R_authtype=="未指定"){
					R_authtype=null;
				}
				connection.ServiceName=o_n;
				connection.ConnType=R_authtype;
				connection.ConnParamValue=null;
				break;
			//MYSQL 
			case "MYSQL":
				//数据库名：
				var sql_n=$("#sql_n").val();
				if(sql_n==""){
					_alert(2, "主机","请输入数据库名",$("#sql_n"));
					//$('#sql_n').val("");
					return false;
				}else if (!sp_char.test(sql_n)){
					_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
					//$("#sql_n").val("");
					return false;
				}
				var select_my=parseInt($('#select_my').val());
				if(select_my == 0){
					select_my = null;
				}
				connection.ServiceName=sql_n;
				connection.ConnType=select_my;
				connection.ConnParamValue=null;
				break;
			//DB2
			case "DB2":
				//数据库名：
				var sql_n=$("#sql_n").val();
				if(sql_n==""){
					_alert(2, "主机","请输入数据库名",$("#sql_n"));
					//$('#sql_n').val("");
					return false;
				}else if (!sp_char.test(sql_n)){
					_alert(1, "主机",'数据库名格式不正确',$("#sql_n"));
					//$("#sql_n").val("");
					return false;
				}

				connection.ServiceName=sql_n;
				connection.ConnType=null;
				connection.ConnParamValue=null;
				break;
			//SYBASE
			case "SYBASE":
				//实例名：
				var sy_o_n=$("#sy_o_n").val();
				if(sy_o_n==""){
					_alert(2, "主机","请输入实例名",$("#sy_o_n"));
					//$('#sy_o_n').val("");
					return false;
				}else if (!sp_char.test(sy_o_n)){
					_alert(1, "主机",'实例名格式不正确',$("#sy_o_n"));
					//$("#sy_o_n").val("");
					return false;
				}
				connection.ServiceName=sy_o_n;
				connection.ConnType=null;
				connection.ConnParamValue=null;
				break;
			default:
				connection.ProtocolId=parseInt(p_id);
				connection.ServiceName=null;
				connection.ConnType=null;
				connection.ConnParamValue=null;
		}
		// $.ajax({
		// 	url: '/bhost/add_connection',
		// 	type: "POST",
		// 	async:false,
		// 	data: {a0:$("input[name=se]").val(),a1:JSON.stringify(connection)},
		// 	success: function(result) {
		// 		var result = JSON.parse(result);
		// 		if(result.Result == true){
		// 			$('.btn').blur();parent.layer.open({
		// 				type:1,
		// 				title: '连接参数',
		// 				content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
		// 				btn:['确&nbsp;&nbsp;定'],
		// 				btnAlign:'c',
		// 				closeBtn: false,
		// 				skin:'layer-custom',
		// 				area:['380px','310px'],
		// 				move: false,
		// 				resize: false,
		// 				yes:function(i){
		// 					parent.layer.close(i);
		// 					d.close().remove();
		// 					$('#ProtocolName').change();
		// 					$("#ConnParamName").val(val);
		// 					$("#ConnParamName").attr("_id",result.ConnParamId);
		// 				}
		// 			});

		// 		}else{
		// 			_alert(1,"事件告警信息操作",result.ErrMsg,$("#d_n"));
		// 			return false;
		// 		}
		// 	}
		// });
		if(Protocol_old != $("#Protocol").val() && type != 0){
			var msstr = aceg(JSON.stringify(connection),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_connection',
				type: "POST",
				async:false,
				data: {a0:$("input[name=se]").val(),a1:JSON.stringify(connection),a10:"运维管理>主机管理",m1:msstr},
				success: function(result) {
					var result = JSON.parse(result);
					if(result.Result == true){
						$('.btn').blur();
						parent.layer.open({
							type:1,
							title: '连接参数',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:['确&nbsp;&nbsp;定'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							yes:function(i){
								parent.layer.close(i);
								d.close().remove();
								var id_str = $("#ConnParamName").data('value');
								var name_str = $("#ConnParamName").children().find('span').text();
								$("div[data-id=xSelect-connparam]").remove();
								$('#ConnParamName').empty().data('xSelect','');
								bind_Conn_xSelect($("#ProtocolName"));								
								if(name_str == '请选择'){
									//$('#ProtocolName').change();
									$("#ConnParamName").data('value',result.ConnParamId);
									$("#ConnParamName").children().find('span').text(connection.ConnParamName);
								}else{
									//$('#ProtocolName').change();
									$("#ConnParamName").data('value',id_str);
									$("#ConnParamName").children().find('span').text(name_str);
								}
							}
						});

					}else{
						_alert(1, "连接参数",result.ErrMsg,$("#d_n"));
						return false;
					}
				}
			});
		}else{
			var msstr = aceg(JSON.stringify(connection),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_connection',
				type: "POST",
				async:false,
				data: {a0:$("input[name=se]").val(),a1:JSON.stringify(connection),a10:"运维管理>主机管理",m1:msstr},
				success: function(result) {
					var result = JSON.parse(result);
					if(result.Result == true){
						$('.btn').blur();
						parent.layer.open({
							type:1,
							title: '连接参数',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:['确&nbsp;&nbsp;定'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							yes:function(i){
								parent.layer.close(i);
								d.close().remove();
								var id_str = $("#ConnParamName").data('value');
								var name_str = $("#ConnParamName").children().find('span').text();
								$("div[data-id=xSelect-connparam]").remove();
								$('#ConnParamName').empty().data('xSelect','');
								bind_Conn_xSelect($("#ProtocolName"));	
								if(name_str == '请选择'){
									$('#ProtocolName').change();
									$("#ConnParamName").data('value',result.ConnParamId);
									$("#ConnParamName").children().find('span').text(connection.ConnParamName);
								}else{
									$('#ProtocolName').change();
									$("#ConnParamName").data('value',id_str);
									$("#ConnParamName").children().find('span').text(name_str);
								}
							}
						});

					}else{
						_alert(1, "连接参数",result.ErrMsg,$("#d_n"));
						return false;
					}
				}
			});
		}	
	})	
}

function _delNode(obj){
	var $p = $(obj).parent();
	var id = $(obj).next('a').attr('id');
	$(document)[0].onclick = null;
	parent.layer.open({
		type:1,
		title:"应用发布IP",
		content:'<div class="layer-alert"><i class="alert warning"></i>该应用发布IP可能配置于其他服务 是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			$.ajax({
				url:'/bhost/del_acc_ip',
				type:'post',
				async:false,
				data:{a0:$("input[name=se]").val(),a1:id},
				success:function(result){
					var result = JSON.parse(result);
					if (result.Result == true){
						$p.remove();
						return;
					}else{
						_alert(1,"应用发布IP",result.ErrMsg);
						_hideView(3);
						return;
					}
				}
			})
		},
		btn2:function(i){
			parent.layer.close(i);
			_hideView(3);
		}
	});
}

function clear_acce(){
	$("#first_div").siblings().remove()
	$("#first_div").after('<div id="luo0" style="float:left;width:97%;position: static;">'+
				'<div class="form-item" style="width:50%;float:left;">'+
					'<span class="form-tag" style="width:60px"><em class="imp">*</em>账号：</span>'+
					'<div class="form-c sel-type1" id = "account_name" style="margin-bottom: 15px;width: 270px;float: left;padding: 1px 10px 10px 10px;">'+
							'<input type="text" class="form-text" id="Name0" onblur="NameCheck1(this)" maxlength="127"><i class="v-check" id="check0"></i>'+
						'<p class="form-tip" id="prompt0" style="padding-left: 0px;">特殊字符仅支持@(仅可用1次)、下划线、横杠、小数点</p>'+
					'</div>'+
				'</div>'+
				'<div class="form-item" style="width:50%;float:left;margin-top: 1px;">'+
					'<span class="form-tag" style="width:70px">AD域：</span>'+
							
					'<div class="form-c sel-type1" style="float:left;width: 280px;padding-left:15px;">'+
						'<li id="add_AD0">'+
							'<select name="" id="ADregion0" onchange="AD_change(0,this);" class="type-select" style="width:250px">'+
							'</select>'+
							'<i class="ctrl add" id="edit_hide" onclick="addinput(this)"></i>'+
						'</li>'+
					'</div>'+
				'</div>'+
			'</div>')
	$('.type-select').select2();
	AD_add(number);
	$("#del_0").remove();
	$('#Name0').attr("disabled",false);
	$('#Name0').val('');
	$('#ADregion0').attr("disabled",false);
	$('#ADregion0').val('0').trigger('change');
	$("#ADregion0").attr("onchange","");
	$("#check0").attr('class','v-check');
	$("#edit_hide").show();
	if($("#edit_hide").length == 0){
			$("#add_AD0").append('<i class="ctrl add" id="edit_hide" onclick="addinput(this)"></i>');
		}
	accountType = "1";
	Name = "test";
	accountid = "";
	number=0;
	id_list=[];
	test=[];
	adc=0;
	adc1=0;
}

var json_acc={
	"AccountId":0,
   "Name":null,
	"DomainId":0,
	"AccountName":null,
   "DomainName":null,
	"AccountType":1			
};
var accountType = "1";
var Name = "test";
var accountid = "";
var AccountData = "";
var number=0;
var id_list=[];
var test=[];
var adc=0;
var adc1=0;
//获取全部账号信息
var account_all;
function all_account(){
	account_all = [];
	$.ajax({
		url:'/bhost/select_account_all',
		type:'post',
		async:false,
		data:{a0:$("input[name=se]").val(),z11:-1},
		success:function(result){
			account_all = JSON.parse(result);
		}
	});
}
//删除添加列表按钮实现
function _delinput(obj){
	var $del_div = $(obj).parent().parent().parent().parent();
	var num=$(obj).attr("value");
	$del_div.remove();
	for(var i=0;i<id_list.length;i++){
		if(id_list[i]==num){
			id_list.splice(i,1);
			break;
		}
	}
}
//向前加入一个input框 和一个X按钮
function addinput(obj){
	var flag=true;
	flag=check_data(number);
	if(flag==false){
		return ;
	}
	adc=0;
	if(flag){
		id_list.push(number+1);
		$("#prompt"+number+"").hide();
		$("#check"+number+"").hide();
		// $("#Name"+number+"").attr("disabled",true);
		if(number==0){
			$("#add_AD"+number+"").append('<i class="ctrl del" id = "del_'+number+'" value="'+number+'"  onclick="_delinput(this)"></i>').children('i.add').remove();
		}else{
			$("#add_AD"+number+"").append('<i class="ctrl del" id = "del_'+number+'" value="'+number+'" style="margin-left:10px" onclick="_delinput(this)"></i>').children('i.add').remove();
		}
		number=number+1;
		$("#first_div").after('<div id="luo'+number+'" style="float:left;width:97%;position: static;">');
		$("#luo"+number+"").append('<div class="form-item" style="width:50%;float:left;"><span class="form-tag" style="width:60px"><em class="imp">*</em>账号：</span>'+
									'<div class="form-c sel-type1" id = "account_name" style="margin-bottom: 15px;width: 270px;float: left;padding: 1px 10px 10px 10px;">'+
									'<input type="text" class="form-text" id="Name'+number+'" onblur="NameCheck1(this)" maxlength="127"><i class="v-check" id="check'+number+'"></i>'+
									'<p class="form-tip" id="prompt'+number+'" style="padding-left: 0px;">特殊字符仅支持@(仅可用1次)、下划线、横杠、小数点</p></div></div>');
		$("#luo"+number+"").append('<div class="form-item" style="width:50%;float:left;"><span class="form-tag" style="width:70px">AD域：</span>'+		
									'<div  class="form-c sel-type1" style="float:left;width: 280px;padding-left:15px;"><li id="add_AD'+number+'">'+
									'<select name="" id="ADregion'+number+'" onchange="AD_change('+number+',this);" class="type-select" style="width:250px"></select>'+
									'<i class="ctrl add" style="margin-left:5px" onclick="addinput(this)"></i></li></div></div>');
		$('.type-select').select2();
		AD_add(number);
		var DomainId=$("#ADregion"+number+"").val();
		test.push(DomainId);
	}
}
//检查数据完整性
function check_data(num){
	var DomainId=$("#ADregion"+num+"").val();
	var Name=$("#Name"+num+"").val();
	var add=1;
	if (Name == ""){
		_alert(2, "主机账号","请输入账号",$("#Name"+num+""));
		add=0;
		return false;
	}
	if(patch(Name,"@") <= 1){
		if(!acc_namereg.test(Name)){
			_alert(1, "主机账号","账号格式不正确",$("#Name"+num+""));
			add=0;
			return false;
		}
	}else{
		_alert(1, "主机账号","账号格式不正确",$("#Name"+num+""));
		add=0;
		return false;
	}
	$.each(AccountData,function(i1,item1){
		if ((Name == item1.Name && DomainId == item1.DomainId)||(Name == item1.Name &&DomainId==0&&item1.DomainId==null)){
			add = 0;
			_alert(1, "主机账号","相同的账号已存在",$("#Name"+number+""));
		}
	});
	if(id_list.length>1){
		var endid=number;
		var endName = $("#Name"+endid+"").val().trim();
		var endDomainId=$("#ADregion"+endid+"").val();
		for(var i=0;i<id_list.length-1;i++)
		{
			if(endName==$("#Name"+id_list[i]+"").val().trim() && endDomainId == $("#ADregion"+id_list[i]+"").val())
			{
				_alert(1, "主机账号","相同的账号已存在",$("#Name"+endid+""));	
				add=0;
				return false;
			}
		}
	}
	if(add==1){
		return true;
	}else{
		return false;
	}
}
//检查数据的格式
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
function NameCheck(obj){
	var name = $(obj).val();
	var $i = $(obj).next('i.v-check');
	if (!nameReg.test(name)){
		$i.show().attr('class','v-check v-wrong');
	}else{
		$i.show().attr('class','v-check v-right');
	}
}
var nameReg1 = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.@]+$/;
function NameCheck1(obj){
	var name = $(obj).val();
	var $i = $(obj).next('i.v-check');
	if(patch(name,"@") <= 1){
		if (!nameReg1.test(name)){
			$i.show().attr('class','v-check v-wrong');
		}else{
			$i.show().attr('class','v-check v-right');
		}
	}else{
	  $i.show().attr('class','v-check v-wrong');
	}	
}
//---------------------------密钥编辑
function _addNew3(obj,type){
	editkey1 = obj;
	editkey2 = type;
	clear_sshkey();
	sshkey = {
		"SshKeyId": 0,
		"KeyName": null,
		"KeyType": 0,
		"KeyContent": null,
		"IfValid": false,
		"Password":null
	};	
	if(type == 0){
		SshKeyId = 0;
	}else{
		SshKeyId = $(obj).children('span').attr('data-value');
		sshkey.SshKeyId = SshKeyId
		editKey(SshKeyId);
	}

	var $dialogCont = $("#SSHKeyDialog").show();
	$('.type-select').select2();
	title = "密钥";
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"SSHKeyDialog",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(10);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var p_id = $("#Protocol1").val();
		var val = $("#d_n1").val();
		var $i = $("#d_n1").next('i.v-check');
		//事件告警信息名
		if (val == "") {
			_alert(2, "密钥", '请输入名称', $("#d_n1"));
			return false;
		}
		if (!nameReg.test(val)) {
			_alert(1, "密钥", '名称格式不正确', $("#d_n1"));
			//$("#d_n1").val("");
			return false;
		}
		sshkey.KeyName = val;
		var Password=$('#Password').val().trim();
		var Password_two=$('#Password_two').val().trim();
		if(Password.length > 64){
			_alert(2, "密钥", "密码不能超过系统限定64位", $("#Password"));
			return false;
		}
		if(Password==''){
			Password=null;
		}else if(Password!=Password_two){
				_alert(2, "密钥","两次密码不匹配",$("#Password_two"));
				return false;
		}
		sshkey.Password=Password;
		var content = $("#content").val();
		// var keycheck = /^[a-zA-Z0-9/+=\s\-]*$/g;
		var keycheck = /^[\u4e00-\u9fa5]*$/g;
		if(content==""){
			_alert(2, "密钥", '请填写密钥内容', $("#content"));
			return false;
		}
		if(keycheck.test(content)){_alert(1, "密钥", '密钥格式不正确', $("#content"));return}
		if($("#d_n1").val().length>32) {
			_alert(1, "密钥", '密钥名称已达到最大值', $("#d_n1"));
			return false;
		}
		// if($("#Enable").is(':checked')){
		// 	sshkey.IfValid = true;
		// }else{
		// 	sshkey.IfValid = false;
		// }
		sshkey.KeyContent = content;
		sshkey.KeyType = parseInt(p_id);
		var msstr = aceg(JSON.stringify(sshkey),$("input[name=se]").val());
		$.ajax({
			url: '/bhost/add_sshkey_host',
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val(), a1: JSON.stringify(sshkey), a10: "运维管理>主机管理",m1:msstr},
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result == true) {
					$('.btn').blur(); parent.layer.open({
						type: 1,
						title: '密钥',
						content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							d.close().remove();
							parent.layer.close(i);

							var id_str = $("#SSHkey_s").data('value');
							var name_str = $("#SSHkey_s").children().find('span').text();
							if(name_str == '请选择'){
								bind_SSHkey_xSelect();
								$("#SSHkey_s").data('value',result.SshKeyId);
								$("#SSHkey_s").children().find('span').text(val);
							}else{
								bind_SSHkey_xSelect();
								$("#SSHkey_s").data('value',id_str);
								$("#SSHkey_s").children().find('span').text(name_str);
							}
						}
					});
				} else {
					_alert(1, "密钥管理", result.ErrMsg, $("#d_n1"));
					return false;
				}
			}
		});
	})
}
function clear_sshkey(){
	$("#d_n1").val("");
	$("#d_n1").attr("disabled",false);
	$("#SSHKeyDialog .v-check").attr("class","v-check");
	$("#Protocol1").val("1").trigger('change');
	$("#Protocol1").attr('disabled','true');
	$('#Password').val('');
	$('#Password_two').val('');
	$("#Enable").iCheck('uncheck');
	$("#content").val("");
}
function editKey(id){
	$.ajax({
		url: '/bhost/get_sshkey',
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(), a1: id, a2: null},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result == true) {
				key_Data = result.info.data[0];
				$("#d_n1").val(key_Data.KeyName);
				$('#d_n1').attr('disabled',true);
				$('#Password').val(key_Data.Password);
				$('#Password_two').val(key_Data.Password);
				$("#content").val(key_Data.KeyContent);
			} else {
				_alert(1, "密钥管理", result.ErrMsg, $("#d_n1"));
				return false;
			}
		}
	});
}

function _addNew1(obj,type){
	editAcc1 = obj;
	editAcc2 = type;
	clear_acce();
	if(type == 0){
		json_acc={
			"AccountId":0,
			"Name":null,
			"DomainId":0,
			"AccountName":null,
			"DomainName":null,
			"AccountType":1			
		};
		$("#ADregion0").attr("onchange","AD_change(0,this)");
		accountid = 0;
	}else{
		accountid = $(obj).children('span').attr('data-value');
		$("#ADregion0").attr("onchange","");
	}
	all_account();
	AD_add(number);
	id_list.push(number);
	var adregion_old = 0;
	if (parseInt(accountid) != 0){
		$("#edit_hide").hide();
		$("#check"+number+"").hide();
		$.each(AccountData,function(i1,item1){
			if (accountid == item1.AccountId){
				$("#Name0").val(item1.Name);
				adregion_old = item1.DomainId;
				if(item1.DomainId == null){
					test=[];
					$("#ADregion0").val(0).trigger('change');
				}else{
					$("#ADregion0").val(item1.DomainId).trigger('change');
					if($("#ADregion0 option:selected").text() == ""){
						$("#ADregion0").val(0).trigger('change');
					}
				}
			}
		});
		if(accountid >0 && accountid <8){
			$("#ADregion0").prop("disabled","true");
		}
		$("#Name0").prop("disabled","true");
	}
	var DomainId=$("#ADregion"+number+"").val();
	test.push(DomainId);

	var $dialogCont = $("#AccEditDialog").show();
	$('.type-select').select2();
	if(type == 0)  title = "主机账号"
	else title = "主机账号"
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"AccEditDialog",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(6);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var adregion_new;
		if($("#ADregion0").val() == 0){
			adregion_new = null;
		}else{
			adregion_new = $("#ADregion0").val();
		}
		if(adregion_new != adregion_old && type != 0){
			// parent.layer.open({
			// 	type:1,
			// 	title:"主机",
			// 	content:'<div class="layer-alert"><i class="alert warning"></i>该账号可能应用于其他主机，是否修改</div>',
			// 	btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
			// 	btnAlign:'c',
			// 	closeBtn: false,
			// 	skin:'layer-custom',
			// 	area:['380px','310px'],
			// 	move: false,
			// 	resize: false,
			// 	btn1:function(i){
			// 		parent.layer.close(i);
					var account_list1 = [];
					var flag_data=true;
					var endid=number;
					if($("#Name"+number+"").val() == "" && id_list.length>1)
					{	
						id_list.pop();
					}else{
						if(accountid==0){
							flag_data=check_data(endid);
							if(flag_data==false){
								return false;
							}
						}
					}
					var Name;
					var Adregion ='';
					for(var i=0;i<id_list.length;i++){
						Name=$("#Name"+id_list[i]+"").val().trim();
						var DomainId=parseInt($("#ADregion"+id_list[i]+"").val());
						var DomainName=null;
						if(DomainId == 0 || DomainId == null){
							DomainId=null;
							var AccountName=null;
							var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
						}else{
							var AccountName=$("#ADregion"+id_list[i]+" option:selected").text();
							Adregion = AccountName;
							accountid=parseInt(accountid);
							var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
						}
						account_list1.push(Account_data);
					}			
					var msstr = aceg(JSON.stringify(account_list1),$("input[name=se]").val());
					$.ajax({
						url:'/bhost/save_account',
						type: "post",
						async:false,
						data: {a0:$("input[name=se]").val(),d5:JSON.stringify(account_list1),a10:"运维管理>主机管理",m1:msstr},
						success: function(Result) {
							data = JSON.parse(Result);
							if(data.Result){
								$('.btn').blur();
								parent.layer.open({
									type:1,
									title: '主机账号',
									content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
									btn:['确&nbsp;&nbsp;定'],
									btnAlign:'c',
									closeBtn: false,
									skin:'layer-custom',
									area:['380px','310px'],
									move: false,
									resize: false,
									yes:function(i){
										d.close().remove();
										parent.layer.close(i);
										var id_str = $("#AccountName").data('value');
										var name_str = $("#AccountName").children().find('span').text();
										if(name_str == '请选择'){
											bind_Acc_xSelect();
											$("#AccountName").data('value',data.AccountId);
											if(Adregion =='') $("#AccountName").children().find('span').text(Name);
											else	$("#AccountName").children().find('span').text(Adregion+"/"+Name);
										}else{
											bind_Acc_xSelect();
											$("#AccountName").data('value',id_str);
											$("#AccountName").children().find('span').text(name_str);
										}
									}
								});	
							}else{
								_alert(1, "主机账号",'相同的账号已存在');
								return false;
							}
						}
					});
			// 	},
			// 	btn2:function(i){
			// 		parent.layer.close(i);
			// 		return false;
			// 	}
			// });
		}else{
			var account_list1 = [];
			var flag_data=true;
			var endid=number;
			if($("#Name"+number+"").val() == "" && id_list.length>1){
				id_list.pop();
			}else{
				if(accountid==0){
					flag_data=check_data(endid);
					if(flag_data==false){
						return false;
					}
				}
			}
			var Name;
			var Adregion ='';
			for(var i=0;i<id_list.length;i++){
				Name=$("#Name"+id_list[i]+"").val().trim();
				var DomainId=parseInt($("#ADregion"+id_list[i]+"").val());
				var DomainName=null;
				if(DomainId == 0 || DomainId == null){
					DomainId = null;
					var AccountName=null;
					var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
				}else{
					var AccountName=$("#ADregion"+id_list[i]+" option:selected").text();
					Adregion = AccountName;
					accountid=parseInt(accountid);
					var Account_data = '{"AccountId":'+accountid+',"Name":"'+Name+'","DomainId":'+DomainId+',"AccountType":1}';
				}
				account_list1.push(Account_data);
			}
			var msstr = aceg(JSON.stringify(account_list1),$("input[name=se]").val());
			$.ajax({
				url:'/bhost/save_account',
				type: "post",
				async:false,
				data: {a0:$("input[name=se]").val(),d5:JSON.stringify(account_list1),a10:"运维管理>主机管理",m1:msstr},
				success: function(Result) {
					data = JSON.parse(Result);
					if(data.Result){
						$('.btn').blur();parent.layer.open({
							type:1,
							title: '主机账号',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:['确&nbsp;&nbsp;定'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							yes:function(i){
								d.close().remove();
								parent.layer.close(i);

								var id_str = $("#AccountName").data('value');
								var name_str = $("#AccountName").children().find('span').text();
								if(name_str == '请选择'){
									bind_Acc_xSelect();
									$("#AccountName").data('value',data.AccountId);
									if(Adregion =='') $("#AccountName").children().find('span').text(Name);
									else	$("#AccountName").children().find('span').text(Adregion+"/"+Name);
								}else{
									bind_Acc_xSelect();
									$("#AccountName").data('value',id_str);
									$("#AccountName").children().find('span').text(name_str);
								}
							}
						});	
					}else{
						_alert(1, "主机账号",'相同的账号已存在');
						return false;
					}
				}
			});
		}
	})
}

function _hideView(t,obj){
	if(t == 0){
		$(connparm_list).each(function(i,item){
			$("#ConnParamName").attr('_id',"");
			if(item.ConnParamName == $("#ConnParamName").val()){
				$("#ConnParamName").attr('_id',item.ConnParamId);
				return false;
			}
			if($(obj).attr("_id") == ""){
				$(obj).val("");
			}
		})	
	}
	if(t == 1){
		$(AccountData).each(function(i,item){
			$("#AccountName").attr('_id',"");
			if(item.AccountName == $("#AccountName").find('span').text()){
				$("#AccountName").attr('_id',item.AccountId);
				return false;
			}
		})
		if($(obj).attr("_id") == ""){
			$(obj).val("");
		}
	}
	// if(t == 2){
	// 	$(account_list).each(function(i,item){
	// 		$("#FromAccount_acc").attr('_id',"");
	// 		if(item.AccountName == $("#FromAccount_acc").val()){
	// 			$("#FromAccount_acc").attr('_id',item.AccountId);
	// 			return false;
	// 		}
	// 	})
	// 	if($(obj).attr("_id") == ""){
	// 		$(obj).val("");
	// 	}
	// }	
	if(t == 3){
		$(accIP_list.data).each(function(i,item){
			$("#select_accIP").attr('_id',"");
			if(item.AccIP == $("#select_accIP").val()){
				$("#select_accIP").attr('_id',item.AccIPId);
				return false;
			}
		})	
	}
	$(document)[0].onclick = function(){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
	}
}

function _setVal(t,t1){
	var val = $(t).text();
	$($focusObj).val(val);
	$($focusObj).attr('_id',$(t).attr('id'));
	$view = $('#autoView');
	$view.hide();
	var $item = $focusObj.parents('div.g-title').next('div.g-cont').find('div.forName');
	var $item2 = $focusObj.parent().next('input.forName');
	$item.hide();
	$item2.hide();
	if(t1 == 2){
		var t = $(t).text();
		if (t == "*") {
			$("#password1").prop("disabled", true);
			$("#password2").prop("disabled", true);
			$("#if_emptypwd").iCheck('uncheck');
			$("#if_emptypwd").iCheck('disable');
		} else {
			$("#password1").prop("disabled", false);
			$("#password2").prop("disabled", false);
			$("#if_emptypwd").iCheck('uncheck');
			$("#if_emptypwd").iCheck('enable');
		}
	}
}

//添加AD域 
function AD_add(num){
	$("#ADregion"+num+"").empty().append("<option value=\"0\" >请选择AD域</option>");
	$.ajax({
		url:'/bhost/get_ADregion',
		type:'post',
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			domian_data=JSON.parse(result);
			$.each(domian_data.data,function(i,item){
				$("#ADregion"+num+"").append("<option value=\""+item.DomainId+"\" >"+item.DomainName+"</option>");
			});
		}
	});
}

//AD域再次变化判断 
function AD_change(num,obj){
	setTimeout(function(){
		if(num==0&&test.length==1&&accountid==0){
			var DomainId=$("#ADregion"+number+"").val();
			test[num]=DomainId;
			var changeName = $("#Name"+num+"").val();
			var changeDomainId=$("#ADregion"+num+"").val();
			$.each(AccountData,function(i1,item1){
				if (changeName == item1.Name && changeDomainId == item1.DomainId){
					$("#ADregion"+num+"").val(0).trigger('change');
					_alert(2,"AD域","相同的账号已存在",$("#Name"+num+""));
					return false;
				}
			});
		}
		if(num<number){
			var flag=true;
			var changeName = $("#Name"+num+"").val().trim();
			var changeDomainId=$("#ADregion"+num+"").val();
			$.each(AccountData,function(i1,item1){
				if ((changeName == item1.Name && changeDomainId == item1.DomainId)||(changeName == item1.Name &&changeDomainId==0&&item1.DomainId==null)){
					flag=false;
					$("#ADregion"+num+"").val(test[num]).trigger('change');
					_alert(2,"AD域","相同的账号已存在",$("#Name"+num+""));
				}
			});
			if(id_list.length>1){
				for(var i=0;i<id_list.length;i++)
				{
					if(changeName==$("#Name"+id_list[i]+"").val().trim() && changeDomainId == $("#ADregion"+id_list[i]+"").val() && id_list[i]!=num)
					{	
						flag=false;
						$("#ADregion"+num+"").val(test[num]).trigger('change');
						_alert(2,"AD域","相同的账号已存在");	
						return false;
					}
				}
			}
			if(flag && num!=0){
				test[num]=changeDomainId;
			}
		}	
		if(num==number&&num>0){
			if(test[num]==0&&adc==0){
				var flag=true;
				var changeName = $("#Name"+num+"").val().trim();
				var changeDomainId=$("#ADregion"+num+"").val();
				$.each(AccountData,function(i1,item1){
					if (changeName == item1.Name && changeDomainId == item1.DomainId){
						flag=false;
						$("#ADregion"+num+"").val(0).trigger('change');
						_alert(2,"AD域","相同的账号已存在",$("#Name"+num+""));
					}
				});
				if(id_list.length>1){
					for(var i=0;i<id_list.length-1;i++)
					{
						if(changeName==$("#Name"+id_list[i]+"").val().trim() && changeDomainId == $("#ADregion"+id_list[i]+"").val())
						{	if($("#ADregion"+id_list[i]+"").val()==0){
								adc=adc+1;
								return false;
							}
							flag=false;
							$("#ADregion"+num+"").val(0).trigger('change');
							_alert(2,"AD域","相同的账号已存在");	
							return false;
						}
					}
				}
				if(flag && num!=0){
					test[num]=changeDomainId;
				}
			}else{
				var flag=true;
				var changeName = $("#Name"+num+"").val().trim();
				var changeDomainId=$("#ADregion"+num+"").val();
				$.each(AccountData,function(i1,item1){
					if (changeName == item1.Name && changeDomainId == item1.DomainId){
						flag=false;
						adc1=1;
						$("#ADregion"+num+"").val(test[num]).trigger('change');
						_alert(2,"AD域","相同的账号已存在",$("#Name"+num+""));
					}
				});
				if(id_list.length>1){
					for(var i=0;i<id_list.length-1;i++)
					{
						if(changeName==$("#Name"+id_list[i]+"").val().trim() && changeDomainId == $("#ADregion"+id_list[i]+"").val() && id_list[i]!=num)
						{
							if(adc1==0){
								adc=0;
								flag=false;
								$("#ADregion"+num+"").val(test[num]).trigger('change');
								_alert(2,"AD域","相同的账号已存在");	
								return false;
							}else{
								adc1=0;
								return false;
							}
						}
					}
				}
				if(flag && num!=0){
					test[num]=changeDomainId;
				}
			}
		}
	},1);
}


// AD域 可编辑 浮层
function clear_ad(){
	$('#ad_n').val('').removeAttr("disabled");
	$('#ip_n span.ss').each(function(i,item){
		if(i == 0) return true;
		$(this).remove();
	})
}
function _addNew2(obj,type) {
	clear_ad();
	var $dialogCont = $("#ADDialog").show();
	if(type == 0)  title = "AD域";
	else title = "AD域";
	
	var d = dialog({
		title: title,
		content: $dialogCont,
		id: "ADDialog",
		width: "800px"
	});
	var DomainId = 0
	if(type == 1){
		DomainId = $(obj).next('a').attr('id');
		$.ajax({
			url: "/bhost/get_domain_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:DomainId},
			success:function(result){
				var domain_result = JSON.parse(result);
				if (domain_result.Result==true){
					var domain_data = domain_result.info.data[0];
					$("#ad_n").val(domain_data.DomainName);
					$("#ad_n").attr("disabled",true);
					var domain_data_ip = domain_data.ServerIP.split(";");
					$.each(domain_data_ip,function(i,item){
							var $c = $('<span class="ss" style="padding: 0 0 10px 0;" />');
							$c.html('<input type="text" class="form-text form-text2" value="'+item+'" disabled="true" style=""><i class="ctr ctr-del" style="margin-top: 6px;margin-left: -5px;" onclick="_delIp(this)"></i>');
							$("#ip_n").find("span[class='ss ss-add']").after($c);
					});
				}
			}
		});
	
	}
	
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
		d.close().remove();
	});
	$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
		if(type == 0){
			domain={
				"DomainId":0,
				"DomainName":"",
				"ServerIP":""
			};
		}
		var pass =1;
		var val = $("#ad_n").val();
		var $i = $("#ad_n").next('i.v-check');
		if(val==""){
			_alert(2,'AD域操作','请输入名称',$("#d_n"));
			return false;
		}
		if(!nameReg.test(val)){
			_alert(1,'AD域操作','名称格式不正确',$("#d_n"));
			return false;
		}
		var input_str=$("#ip_n").find("span[class='ss ss-add']").children("input").val();
		if(!ipReg.test(input_str) && input_str!=""){
			_alert(1,'AD域操作','IP格式不正确',$("#ip_n").find("span[class='ss ss-add']").children("input"));
			//$("#ip_n").find("span[class='ss ss-add']").children("input").val("");
			return false;
		}else{
			$(">span[class='ss']","#ip_n").each(function(){
				ip_str=$(this).find("input").val();
				if (ip_str==input_str){
					_alert(2,'AD域操作','IP重复',$("#ip_n").find("span[class='ss ss-add']").children("input"));
					//$("#ip_n").find("span[class='ss ss-add']").children("input").val("");
					pass=0;
					return false;
				}
			});
			if (!$('#ip_n').find('span[class=ss]').length && input_str==""){
				_alert(2,'AD域操作',"请输入IP",$("#ip_n").find("span[class='ss ss-add']").children("input"));
				return false;
			}
		}
		
		if(pass==1){
			var ip_str="";
			var $all=$('#ip_n').find('span[class=ss]');
			var len=$all.length;
			for(var j=len-1;j>=0;j--){
				ip_str=ip_str+$all.eq(j).find("input").val()+";";
			}
			if(input_str!=""){
				ip_str=ip_str+input_str;
			}else{
				ip_str=ip_str.substr(0,ip_str.length-1)
			}
			domain.DomainId=DomainId;
			domain.DomainName=val;
			domain.ServerIP=ip_str;
			var msstr = aceg(JSON.stringify(domain),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_domain',
				type: "POST",
				async:false,
				data: {a0:$("input[name=se]").val(),a1:JSON.stringify(domain),m1:msstr},
				success: function(result) {
					var result = JSON.parse(result);
					if(result.Result == true){
						$('.btn').blur();parent.layer.open({
							type:1,
							title: 'AD域操作',
							content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:['确&nbsp;&nbsp;定'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							yes:function(i){
								parent.layer.close(i);
								$.ajax({
									url: '/bhost/get_DomainName_list',
									type: "post",
									async: true,
									cache: false,
									data: { a0: $("input[name=se]").val() },
									success: function (Result) {
									DomainName_list = (JSON.parse(Result)).data;
									}
								})
									_autoView('#AccountName',2,2);
							}
						});	
					}else{
						_alert(1,'AD域操作',result.ErrMsg,$("#d_n"));
						return false;
					}
				}
			});
		}
		d.close().remove();
	})
}

//删除服务器ip
function _delIp(obj){
	var $c = $(obj).parent();
	$c.fadeOut(function(){
				$c.remove();
			});
}
//input回车触发事件
function showMsg(obj){
	var code = event.keyCode;
	if(code == 13){
		_addIp($(obj).next('i'));
	}
}
var ipReg = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])(\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])){3}$/;
//加入服务器ip
function _addIp(obj){
	var pass =1;
	var v = $(obj).prev('input').val().trim();

	if(v==''){
		_alert(2,'AD域操作','请输入IP',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	}else if(!ipReg.test(v)){
		_alert(2,'AD域操作','IP格式不正确',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	}else{
		$(">span[class='ss']","#ip_n").each(function(){
			ip_str=$(this).find("input").val();
			if (ip_str==v){
				_alert(2,'AD域操作','相同的IP已存在',$(obj).prev('input'));
				//$(obj).prev('input').val("");
				pass=0;
				return false;
			}
		});
	}
	if(pass==1){
		var $c = $('<span class="ss"  style="padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text form-text2" value="'+v+'" disabled="true" style=""><i class="ctr ctr-del" style="margin-top: 6px;margin-left: -5px;" onclick="_delIp(this)"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').focus();
	}
}
var domain={
	"DomainId":0,
    "DomainName":"",
    "ServerIP":""
};
function pName_change(num){
	if ($("#ProtocolName").data('value') == 2 || $("#ProtocolName").data('value') == 8 || $("#ProtocolName").data('value') == 15){
		if (num!=1) jump_clear();
		$("#FromHostName").parents('div.form-item').show();
		$("#FromHostServiceName").parents('div.form-item').show();
		$("#FromAccountName").parents('div.form-item').show();
		$("#FromLoginCmd").parents('div.form-item').show();
	}else{
		jump_clear();
		$("#FromHostName").parents('div.form-item').hide();
		$("#FromHostServiceName").parents('div.form-item').hide();
		$("#FromAccountName").parents('div.form-item').hide();
		$("#FromLoginCmd").parents('div.form-item').hide();
	}
}
function jump_clear(){
	$("#FromHostName").val("").trigger('change');
	$("#FromHostServiceName").val("").trigger('change');
	$("#FromAccountName").val("").trigger('change');
	$("#FromLoginCmd").val("");
}
	

 $('#allPage').scroll(function() {
	var wh = $('#allPage').height(),
		vh = $('#apArea').height(),
		st = $('#allPage').scrollTop();

	if (wh + st >= vh) {
		_addData();
	}
})

 $('#importPage').scroll(function() {
	var wh = $('#importPage').height(),
		vh = $('#apArea1').height(),
		st = $('#importPage').scrollTop();

	if (wh + st >= vh) {
		_addData1(0);
	}
})

function _closeDetail(type) {
	if (type == 1){
		$('#allPage').hide();
	}else{
		$('#importPage').hide();
	}
	$("#_HostList").show();
	_import_host(1);
	$("#task_list_tab").click();
}

function _reloadDetail(type) {
	$('#apArea').empty();
	$('#apArea1').empty();
	$('#aploadTip').html('正在加载').hide();
	$('#aploadTip1').html('正在加载').hide();
	page = 0;
	ppage = 0;
	append_flag = 0;
	row_len = 0;
	hostip = "";
	remain_page = 0;
	page_flag = 0;
	same_page = 0;
	if (type == 1){
		if (keyword_re_detail.length == 0){
			get_detail_count(host_task_id);
			return false;
		}
		get_hosttask_list_detail(host_task_id);
		get_detail_count(host_task_id);
		status = task_list_detail.data[0].TaskStatus
	}else{
		_initLoadData1();
	}
	//_initLoadData();
}

var page = 0;

function _addData() {
	if ($('#aploadTip').is(':visible')) {
		return;
	}
	page++;
	get_data(page,10);
}

function _addData1(type_add) {
	if ($('#aploadTip1').is(':visible')) {
		return;
	}
	page++;
	var offsetrow = (page-1)*10;
	get_import_deatil(host_task_IP_id,10,offsetrow);
	get_data_i(type_add);
}

function _initLoadData1() {
	var h1 = $('#importPage').height();
	var h2 = $('#apArea1').height();
	var add = function() {
		if (h1 - 203 > h2) {
			page++;
			var offsetrow = (page-1)*10;
			get_import_deatil(host_task_IP_id,10,offsetrow);
			get_data_i(0);
			h2 = $('#apArea1').height();
		}else{
			clearInterval(if_select1);
			return false;
		}
	}
	
	var if_select1 = setInterval(function(){
		/*
		if (h1 - 203 > h2 || row_len <= 10){
			clearInterval(if_select1);
			return false;
		}
		*/
		if (row_len < 10){
			clearInterval(if_select1);
			return false;
		}
		if (row_len == 10 && import_list_detail.totalrow == 10){
			clearInterval(if_select1);
			return false;
		}
		add();	
	},1000);
	
	add();
}

function _initLoadData() {
	var h1 = $('#allPage').height();
	var h2 = $('#apArea').height();
	var add = function() {
		if (h1 - 203 > h2){
			page++;
			get_data(page,10);
			h2 = $('#apArea').height();
		}else{
			clearInterval(if_select);
			return false;
		}
	}

	var if_select = setInterval(function(){
		if (h1 - 203 <= h2 || task_list_detail.totalrow <= 10){
			clearInterval(if_select);
			return false;
		}
		add();	
	},1000);

	add();
}

function _getRenderData(obj){
	var offset = $(obj).offset();
	var $c = $('#renderDiv');
	$c.css({
		top:offset.top - 68,
		left:offset.left - 95
	}).fadeIn();
}
function g_tsel(obj){
	var this_id=$(obj).attr('id');
	var this_class=$(obj).attr('class');
	if(this_id=='g-tsel_connparamname' && this_class=='g-tsel'){
		$('#ConnParamName').focus().select();
		_autoView(obj,0,0);
	}else if (this_id=='g-tsel_account' && this_class=='g-tsel') {
		$('#AccountName').focus().select();
		_autoView(obj,2,2);
	}else if (this_id=='g-tsel_fromaccount' && this_class=='g-tsel') {
		$('#FromAccount_acc').focus().select();
		_autoView(obj,2,4);
	}
}



/*
Functions about the tree search result!
*/
function click_h(){
	$("#hostTree").find('.font-red').removeClass('font-red');
	$('#hostTree').find('span.h-name-red').removeClass('h-name-red');
	$('#hostTree').find('i.h-aicon-d').trigger('click');
}

var path_all;
function find_hostgroup(){
	$('#hostTree').find('li').show();
	click_h();
	$('#hostTree').find('li').hide();
	var server_find_json={
		"loginusercode": null,
		"hgid": 0,
		"istree": true,
		"hgname": "",
		"hostname": "",
		"hostip": "", 
		"limitrow":null,
		"offsetrow":null
	}
	usercode = window.document.frm.us.value;
	var hgname_str='';
	$.each(search_typeall_r.split('\t'),function(i,item){
		if(item=='' || item==null){
			return true;
		}
		var item_id=item.indexOf('-');
		switch(item.substr(0,item_id)){
			case 'hgname':
				hgname_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
			case '0':
				hgname_str+=(item.substr(item_id+1,item.length)+'\n');
				break;
		}
	});
	hgname_str=hgname_str.substr(0,hgname_str.length-1);
	server_find_json.hgname=hgname_str;
	server_find_json.loginusercode=usercode;
	if (hgname_str == ""){
		$('#hostTree').find('li').show();
		return false;
	}
	_getWait(".waitTip1");
	$.ajax({
		url: '/bhost/find_hostgroup',
		type: "POST",
		async: true,
		data: {a0: $("input[name=se]").val(),a1:JSON.stringify(server_find_json)},
		success: function(result){
			result = JSON.parse(result);
			result = result.info;
			if (result == null){
				_waitDone($(".waitTip1"));
				$('#hostTree').find('li').hide();
				_alert(0,'搜索','无搜索结果');
				return false;
			}
			path_all = result;
			if (path_all.length != 0){
				$.each(path_all,function(i,item){
					var Path_array=item.Path.split('/');
					var len=Path_array.length;
					for(var j=1;j<len-1;j++){
						var id=Path_array[j].split(',')[1];
						$i_item=$('#node-'+id).siblings('i.h-aicon');
						if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
							$i_item.parent('li').show();
							$i_item.trigger('click');
							$i_item.siblings('ul').find('li').hide();
						}
					}
					if(item.Type==1){
						$('#node-'+item.Id).parent('li').show();
						$('#node-'+item.Id).siblings('span.h-name').addClass('h-name-red');
						
						var $span_son_font=$('#node-'+item.Id).siblings('span.h-name').find('font')
						var span_son_name=$('#node-'+item.Id).attr('data-name').toLowerCase();
						$.each(search_typeall_r.split('\t'),function(i1,item1){
							if(item1=='' || item1==null){
								return true;
							}
							var index=item1.indexOf('-');
							switch (item1.substring(0,index)) {
								case 'hgname':
								case '':
								case '0':
									$.each(item1.substring(index+1).split(' '),function (i_s,params_s) {
										params_s=params_s.toLowerCase();
										var index_true=span_son_name.indexOf(params_s);
										if(index_true>=0){
											for(var i_red_span=index_true;i_red_span<index_true+params_s.length;i_red_span++){
												$span_son_font.eq(i_red_span).addClass('font-red');
											}
										}
									});
									break;
							}
						});
					}
				})
				li_hide_while_no_red_1($('#hostTree'),0);
				scrollTop_check_server();
			}else{
				_waitDone($(".waitTip1"));
				_alert(0,'搜索','无搜索结果');
			}
		}
	});
}
function li_hide_while_no_red_1(obj,num){
	var li_visible=$(obj).children('li');
	var _len=li_visible.length
	if(num<_len){
		var item=li_visible.eq(num);
		if($(item).children('span.h-name-red').length!=0){
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
		}else if($(item).find('span.h-name-red').length==0){
			$(item).hide();
		}else{
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
			var $children_ul=$(item).children('ul');
			if($children_ul.length>0){
				setTimeout(function(){
					li_hide_while_no_red_1($children_ul,0);
				},1);
			}
		}
	}
	var item_1=li_visible.eq(num+1);
	if(item_1.length!=0){
		setTimeout(function(){
			li_hide_while_no_red_1(obj,num+1);
		},1);
	}
}
function scrollTop_check_server(){
	$('.c-cont').scrollTop(0);
	if(path_all.length!=0){
		var top=9007199254740992;
		$.each(path_all,function(i,item){
			if(item.Type==1){
				var top_item=$('#node-'+item.Id).offset().top;
				if(top_item<top){
					top=top_item;
				}
			}
		});
		$('.c-cont').scrollTop(top+300);
		_waitDone($(".waitTip1"));
	}
}
/*
*/
var serverID;
var accountID, accountID2;
var connTest1, connTest2;
var editAcc1, editAcc2, editAcc3;
var EditHost, EditHostG;
/*
1:主机 2:服务浮层 3:账号浮层 4:accip 5:conn test 6:edit acc 7:host list 8:host group 9:connparam
*/
function reload(type){
	if(type == 1){
		if($("#host_title").text() == "创建主机"){
			add_host();
		}else if($("#host_title").text() == "编辑主机"){
			modify();
		}
	}else if(type == 2){
		if(serverID == 0){
			_getDialog1('add','');		
		}else{
			_getDialog1('edit',serverID);
		}
	}else if(type == 3){
		if(accountID == -1){
			_getDialog2('add',0,accountID2);		
		}else{
			var obj = $("#service_account_list").children('tr').eq(accountID).children().find('.edit');
			_getDialog2('edit',$(obj),accountID2);
		}
	}else if(type == 4){
		$("#accip").val("");
	}else if(type == 5){
		_getDialog_connectTest(connTest1,connTest2);
	}else if(type == 6){
		_addNew1(editAcc1,editAcc2);
	}else if(type == 7){
		document.frm_access.tasktype.value=1;
		document.frm_access.action = '/bhost/host_manage';
		document.frm_access.submit();
	}else if(type == 8){
		if($("#group_title").text() == "创建主机组"){
			add_hostgrp();
		}else if($("#group_title").text() == "编辑主机组"){
			modify();
		}
	}else if(type == 9){
		_addNew(editcp1,editcp2);
	}else if(type == 10){
		_addNew3(editkey1,editkey2);
	}
}
function check_hostLimit(){
	$.ajax({
		url: "/bhost/exceed_hostLimit",
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val()},
		success: function (result) {
			var result = JSON.parse(result);
			if(result.Result == false){
				layer.open({
					type: 1,
					title: "主机管理",
					content: '<div class="layer-alert"><i class="alert fail"></i>'+result.ErrMsg+'</div>',
					btn: '确&nbsp;&nbsp;定',
					btnAlign: 'c',
					closeBtn: false,
					skin: 'layer-custom',
					area: ['380px', '310px'],
					move: false,
					resize: false,
					btn1: function (i) {
						layer.close(i);
						$("#_HostList").show();
						$("#_Host").hide();						
					}
				});
			}
		}
	})
}
function patch(s, re) {
	re = eval("/" + re + "/ig")
	return s.match(re) ? s.match(re).length : 0;
}
</script>

{% endblock  %}
