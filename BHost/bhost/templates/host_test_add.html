{% extends "index.html" %} {% block head %}
<!--icheck111-->
	<script src="/manage/js/icheck.min.js"></script>
	<script src="/manage/js/select2.full.min.js"></script>
	<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
	<script src="/manage/js/jquery.datepick.js"></script>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/G-style.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/jquery.datepick.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
    <link rel="stylesheet" href="/manage/css/jedate.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<script src="/manage/js/jquery.jedate.min.js"></script>
	<script src="/manage/js/my_scrollbar.js"></script>
	<style>
	.h-top .filter {
		float: right;
		margin: 4px;
		min-width: 398px;
	}
	.h-name-son{
		display: inline-block;
	}
	.filter .selector.selector-multiple:after {
		content: '';
		display: block;
		border-color: #888 transparent transparent transparent;
		border-style: solid;
		border-width: 5px 4px 0 4px;
		height: 0;
		width: 0px;
		overflow: hidden;
		position: absolute;
		margin: 11px 0 0 9.3em;
	}
	.h-content2 .form-item {
		height: auto;
		min-height: 38px;
		float: left;
		width: auto;
		padding: 10px 0 10px;
	}

	.h-content2 .form-tag {
		float: left;
		width: 120px;
		text-align: right;
		color: #000;
		line-height: 28px;
	}

	.h-content2 .form-c {
		padding-left: 0px;
		position: relative;
	}

	.h-content2 .form-text {
		width: 200px;
	}

	.ui-dialog-content .c-form-host {
		min-width: 780px;
	}

	.select2-container--open {
		z-index: 9999999;
	}

	.blank_in {
		width: 12px;
	}
	.h-content2 span.checkbox:not(.disabled) {
	cursor: pointer;
	}
	.h-content2 span.disabled {
		cursor: default;
	}
</style>
{% endblock %} {% block main %}
<!---->
<!---->
<script>
	var perm={{perm}};
	if (perm==0) parent.$('#nav-s1 a.active').click();
</script>
<div class="rwrap">
	<div class="c-top">
           <div class="c-title">
		<div class="manual-head" style="float:left;width:100px"> 
			<div class="manual-title">
				<span onclick="host_test_add()" style="cursor: pointer;"> 连接测试</span>
				<i class="hosttest_icon"></i>
			</div>				
		</div>
           </div>
	</div>
	<div class="mainer">
		<div class="container" id="step1">
		<div class="c-cont">
			<div class="c-wrap" style="padding: 10px 0;">
				<div class="c-exp" style="margin-bottom:0">
					<div class="h-explorer" style="height:auto;">
						<div class="G-top">
							<div class="G-box1"></div>
							<strong>&nbsp;计划配置</strong>
						</div>
						<div class="h-content2" style="height:auto;padding-top:0px;">
							<div class="form-item" style="">
								<span class="form-tag"><em class="imp">*</em>名称：</span>
								<div class="form-c" style="float: left;">
									<input type="text" class="form-text" id="HostName" maxlength="31" onblur="regCheck(this,nameReg);"><i class="v-check"></i>
									<p class="form-tip" style="/*padding-left: 120px;*/">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</div>
							<div class="form-item" style="padding-left: 400px;float: none;">
								<span class="form-tag">立即执行：</span>
								<label class="form-label" style="margin-top:5px">
									<input type="checkbox" class="form-checkbox" id="Execution">
								</label>
							</div>
							<div class="form-item" style="">
								<span class="form-tag" style=""><em class="imp">*</em>开始时间：</span>
								<!-- <span>
									<input style="width:80px;cursor:pointer;padding-right:8px" name="t_date" id="t_date" type="text" class="form-text datepicker" readOnly="true">
									<input style="width:18px;padding-right:8px" type="text" class="form-text" name="t_hour" id="t_hour"> : 
									<input style="width:18px;padding-right:8px" type="text" class="form-text" name="t_minute" id="t_minute" > : 
									<input style="width:18px;padding-right:8px" type="text" class="form-text" name="t_second" id="t_second" >
								</span> -->
								<div class="form-c form-c1" style="float: left;">
									<div class="srSort" id="srTemp-xtime" style="">
										<span class="stwrap">
											<input type="text" id="t_date" value="" placeholder="日期" class="datepicker" readonly>
											<input type="text" id="t_hour" placeholder="时" class="timeinput" min="00" max="23" value="00">
											<span class="srTip">:</span>
											<input type="text" id="t_minute" placeholder="分" class="timeinput" min="00" max="59" value="00">
											<span class="srTip">:</span>
											<input type="text" id="t_second" placeholder="秒" class="timeinput" min="00" max="59" value="00">
										</span>
									</div>
								</div>
							</div>
							<div class="form-item" style="float:none;padding-left: 400px;">
								<span class="form-tag"><em class="imp">*</em>重复周期：</span>
								<div class="form-c">
									<div class="input-group g-sel">
										<input type="text" class="form-text g-item" value="30" style="width:34px;padding-right:8px;" id="periodValue" maxlength="4">
										<select id="periodType" class="select2 g-item" style="width:64px">
											<option value="1" selected>天</option>
											<option value="2">分钟</option>
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="c-exp" style="margin:-1px auto">
					<div class="h-explorer" style="height:auto;">
						<div class="G-top">
							<div class="G-box1"></div>
							<strong>&nbsp;连接对象配置</strong>
						</div>
						<div class="h-top" style="background-color: #fff;margin-top: -20px;border-bottom:none;z-index: 999;top: 0;width: auto;float: right;">
							<div class="filter" style="float:right; min-width: auto">
								<div id="waitTip" class="waitTip" style="float: right;margin-top: 7px; margin-left: -26px;"></div>
								<div class="search">
									<select name="server_select" id="server_select" class="filter-select">
										<option value="0" selected>所有</option>
										<option value="hgname">组名</option>
										<option value="hostname">主机名</option>
										<option value="ip">IP</option>
										<option value="hostservicename">服务名</option>
										<option value="accountname">账号</option>
									</select>

									<input type="text" class="filter-text" placeholder="输入关键字" 
									name="server_text" id="server_text" maxlength="128" 
									style="border-left:none;padding-right: 22px;"
									onchange="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
									onblur="if($('#server_text').val()=='' && search_typeall_new!=''){search_typeall_new='';find_host_group();}"
									onkeyup="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
									onkeydown="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}; if (event.keyCode == 13){_addFilter(this,false);return false;} else return; ">
									<i class="v-check v-wrong" id="server_text_check" 
									onclick="_clearFilter(this,1)" 
									style="display:none;cursor: pointer;float: left;position: static;"></i>
									<button class="btn filter-btn" onclick="_addFilter(this,false)"><i class="add-filter"></i></button>
									<button class="btn filter-btn" onclick="_addFilter(this,true)"><i class="append-filter"></i></button>
								</div>
								<div class="search" id="clearFilter2" style="margin: 0px 15px 0px -16px;display:none;">
									<button class="filter-btn" onclick="_clearFilter(this)"><i class="clear-filter"></i></button>
								</div>
								<div class="selector selector-multiple" id="filterWW2" style="display: none;width: 146px;">
									<span class="ww" style="width:132px;">搜索条件</span>
									<ul style="padding-left: 0px; width: 146px;"></ul>
								</div>
							</div>
						</div>
						<div class="h-content2" style="padding-top:0px; min-height: 350px;width: inherit;">
							<div class="form-item" style="padding-top: 0px;">
								<span class="form-tag" style="width: 95px;margin-top: 8px;"><em class="imp">*</em>主机：</span>
								<div class="form-c" style="float: left;">
									<ul id="hostTree" class="hosttree" style="padding: 14px 0 0 0px;"></ul>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="btns" style="display:none;">
		<a href="javascript:;" class="btn btn-normal " onclick="savedata();" style="font-weight: 400;">保&nbsp;&nbsp;存</a>
		<!--<a href="javascript:;" class="btn btn-normal " onclick="back(0);" style="font-weight: 400;">取&nbsp;&nbsp;消</a>-->
	</div>
	<script>
		if(perm==1){
			$('.btns').remove();
		}else{
			$('.btns').show();
		}
	</script>
	<div id="bBtn" style="z-index: 5;    bottom: 45px;">
		<a href="javascript:;" class="btn" onclick="back(0);"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
	</div>
</div>
</div>
<form name="pageForm" action="" method="POST">
	<input id="tasktype" name="tasktype" style="display:none" type="text">

	<input id="planId" name="planId" type="hidden" value="{{ planId }}">

	<input type="hidden" name="a" id = "a" value="{{a}}" />
	<!--需要查询id-->
	<input type="hidden" name="c" id = "c" value="{{c}}" />
	<!--页码-->
	<input type="hidden" name="d" id = "d" value="{{d}}" />
	<!--search_typeall-->
	<input type="hidden" name="e" id = "e" value="{{e}}" />
	<!--search_typeall_new-->
	<input type="hidden" name="se" id = "se" value="{{se}}" />
</form>
{% endblock %} {% block script %}
<script>
	$('.filter-select,.form-select,.select2').select2({ minimumResultsForSearch: -1 });
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;		//计划名的条件表达式
	var SUP_PROTOCOL = ['SSH','ORACLE','MSSQL','MYSQL','TELNET','FTP','VNC','SYBASE','DB2','RLOGIN','RDP','INFORMIX'];//连接测试支持协议；
	var plan = null;
	var editid = -1;
	var usercode = '';
	var type = 1;
	var server_edit = null;
	var authtype_click = 0;
	var search_typeall_r = new Array();
	var server = {
		"ServerScopeId": 0,
		"ServerScopeName": "",
		"IsApplyToClientScope": false,
		"HostList": [],
		"IPList": {
			"IPSetId": 0,
			"Set": []
		}
	};
	var server_find_json = {
		"loginusercode": null,
		"hgid": 0,
		"istree": true,
		"limitrow": null,
		"offsetrow": null
	}
	$(function () {
		$(document).on('keydown','input.timeinput',function(){
			var i = $(this).index();        
			var v = $(this).val();
			v = v.replace(/[^\d]/g,'');
			$(this).val(v);
		}).on('keyup','input.timeinput',function(e){
			var i = $(this).index();
			var v = $(this).val();    
			var max = 23;
			if(i>1){
				max = 59;
			}

			if(v > max){
				v = max;
			}

			$(this).val(v);

			v = v.toString();
			if(v.length >= 2){
				$(this).val(v.substring(0,2));

				var keycode = e.keyCode;
				if(keycode != 9){
					$(this).next().next().focus();
				}
			}
		}).on('focus','input.timeinput',function(){
			$(this).select();
		}).on('blur','input.timeinput',function(){
			var v = $(this).val();
			v = v.toString();

			if(v == ''){
				v = '00';
			}else if(v.length == 1){
				v = '0' + v;
			}

			$(this).val(v);
		});
		_initSize();
		document.pageForm.se.value = window.parent.document.frm.se.value;
		editid = document.pageForm.a.value;
		//设置复选框的事件
		//////console.log('loadNormalInfo'+document.pageForm.a.value);
		$("#HostName").attr('disabled', $("#a").val() != '0');

		//设置时、分、秒输入框的文本格式
		// $("#t_hour,#t_minute,#t_second").on("blur", add_zero);
		// $("#t_hour").on("keyup", { min: 0, max: 23 }, dataCheck);
		// $("#t_minute").on("keyup", { min: 0, max: 59 }, dataCheck);
		// $("#t_second").on("keyup", { min: 0, max: 59 }, dataCheck);

		// $("#server_select").on('change', function () {
		// 	if (this.value == '0') {
		// 		$("#server_text").hide();
		// 	} else {
		// 		$("#server_text").show();
		// 	}
		// })
		// 	.trigger("change");
		//"重复周期"输入框只能输入数字
		$("#periodValue").on("blur", function () {
			$(this).trigger("keyup");
			var v = this.value.trim();
			if (v == '') {
				$(this).val('1');
			}
		});
		$('#Execution').on('ifChecked',function () {
			$('#t_date').parents('div.form-item').hide();
			$('#periodValue').parents('div.form-item').hide();
		}).on('ifUnchecked',function () {
			$('#t_date').parents('div.form-item').show();
			$('#periodValue').parents('div.form-item').show();
		})
		$("#periodValue,#t_hour,#t_minute,#t_second").on("keypress", function (e) {
			DigitInput(e);
		})
			.on("input propertychange", function () {				//防止在输入法开启的情况下输入非数字
				this.value = this.value.replace(/\D/g, "").trim();
			});
		//重复周期类型 onchange事件处理函数
		$("#periodValue").on("keyup", function (e) {
			var d = { min: 1 };
			d.max = $('#periodType').val() == '1' ? 365 : 1440;
			e.data = d;
			dataCheck(e)
		}).on("change", function () {
			$("#periodValue").trigger("keyup");
		})
		.trigger("change");
		loadNormalInfo(document.pageForm.a.value);
		document.pageForm.se.value = window.parent.document.frm.se.value;
		usercode = window.parent.document.frm.us.value;
		server_find_json.loginusercode = usercode;
		
		_initList();
		$('#userTree,#hostTree').on('change','span.authtype input',function(){
			var checked = $(this).prop('checked');
			_authTypeTheme($(this));
			if(checked){
				var $input1 = $(this).parent().parent().siblings('ul').find('span.authtype input');
				var $input2 = $(this).parent().parent().siblings('ul').find('input.zcheck');
				var $input3 = $(this).parent().parent().siblings('input.zcheck');
				//
				$input2.attr("data-loadlast",2);
				$input3.attr("data-loadlast",2);
				$(this).attr('data-ifselect',true);
				$input1.prop('disabled',true);
				_authTypeTheme($input1);
				$input2.prop('checked',true).prop('disabled',true);
				$(this).parent().parent().siblings('input.zcheck').prop('checked',true).next('span.checkbox').attr('class','checkbox checked');
				$.each($input2,function(){
					$(this).next('span.checkbox').attr('class','checkbox checked disabled');
				});

				_checkEvent($(this).parent().parent().siblings('input.zcheck'));
			}else{
				var $input1 = $(this).parent().parent().siblings('ul').children('li').find('span.authtype').find('input');
				var $input2 = $(this).parent().parent().siblings('ul').children('li').find('input.zcheck');
				$(this).attr('data-ifselect',false);
				$input1.prop('disabled',false);
				//_authTypeTheme($input1);
				_checkEvent1($(this));
				authtype_click = 1;
			}
		});	
	});
	$(window).resize(function () {
		_initSize();//加载长度
	});
	//加载长度
	function _initSize() {
		var w = $(window).width();
		var h = $('.h-content2').eq(1).height();
		//////console.log(h);
		$('.h-content2').eq(1).height(h-150);
		// if ((w - 156) < 990) {
		// 	$('.h-top').width(990);
		// } else {
		// 	$('.h-top').width(w - 156);
		// }
	}
	var first_find_index_s=null;
	var data_array_Path=null;
	var ajax_find_host_doing_s=false;
	var find_host_arry_s=null;
	var search_typeall_new = '';
	var flag_loading_host=false;
	//加载树
	function _initList(){
		
		//获取host
		get_hostdirectory(0,editid);
		_viewHTML(h_data,'#hostTree',0);
		flag_loading_host = true;
		
		$('#hostTree').on('click','i.h-aicon',function(){
			// var $item = $(this);
			// var id = $item.data('id').split('-')[1];
			// var uorh = $item.data('id').split('-')[0]; 
			// var $u = $item.parent().children('ul');
			var id = $(this).data('id').split('-')[1];
			var uorh = $(this).data('id').split('-')[0]; 
			var $u = $(this).parent().children('ul');
				if($u.is(':hidden')){
					//$item.addClass('h-aicon-d');
					$(this).addClass('h-aicon-d');
					$u.show();
					if($u.children('li').length == 0){
						var v = 2,d;
						var $input = $(this).siblings('span.checkbox');
						//d = $(this).siblings('span.authtype').find('input[type=radio]:checked').val();
						if($(this).siblings('span.authtype').find('input').is(':checked')){
							d = 0;
						}else{
						d = 1;
					}
					if ($input.attr('class').indexOf('disabled')>0){
						d = 0;
					}
			    	var c = $input.attr('class');
			    	if(c.indexOf('checked')>0){
			    		v=1;
			    	}else if(c == 'checkbox'){
			    		v=0;
			    	}
						_initHTML($u,id,v,d,uorh);
					}
				}else{
					//$item.removeClass('h-aicon-d');
					$(this).removeClass('h-aicon-d');
					$u.hide();
				}
			}).on('dblclick','i.h-eicon,span.h-name',function(){
		var i_class_arr=$(this).siblings('i.h-aicon');
		if(i_class_arr.length==0){
			return false;
		}
		var id = i_class_arr.data('id').split('-')[1];
		var uorh = i_class_arr.data('id').split('-')[0]; 
			var $u = i_class_arr.parent().children('ul');
			if($u.is(':hidden')){
			i_class_arr.addClass('h-aicon-d');
				$u.show();
				if($u.children('li').length == 0){
					var v = 2,d;
					var $input = $(this).siblings('span.checkbox');
					if($(this).siblings('span.authtype').find('input').is(':checked')){
						d = 0;
					}else{
					d = 1;
				}
				if ($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
					var c = $input.attr('class');
					if(c.indexOf('checked')>0){
						v=1;
					}else if(c == 'checkbox'){
						v=0;
					}
					_initHTML($u,id,v,d,uorh);
				}
			}else{
				i_class_arr.removeClass('h-aicon-d');
				$u.hide();
			}
		});
	}
	/* 
		* 处理过长的字符串，截取并添加省略号 
		* 注：半角长度为1，全角长度为2 
		*  
		* pStr:字符串 
		* pLen:截取长度 
		*  
		* return: 截取后的字符串 
	*/
	function autoAddEllipsis(pStr, pLen) {

		var _ret = cutString(pStr, pLen);
		var _cutFlag = _ret.cutflag;
		var _cutStringn = _ret.cutstring;

		if ("1" == _cutFlag) {
			return _cutStringn + "...";
		} else {
			return _cutStringn;
		}
	}
	/* 
		* 取得指定长度的字符串 
		* 注：半角长度为1，全角长度为2 
		*  
		* pStr:字符串 
		* pLen:截取长度 
		*  
		* return: 截取后的字符串 
	*/
	function cutString(pStr, pLen) {

		// 原字符串长度
		var _strLen = pStr.length;

		var _tmpCode;

		var _cutString;

		// 默认情况下，返回的字符串是原字符串的一部分  
		var _cutFlag = "1";

		var _lenCount = 0;

		var _ret = false;

		if (_strLen <= pLen / 2) {
			_cutString = pStr;
			_ret = true;
		}

		if (!_ret) {
			for (var i = 0; i < _strLen; i++) {
				if (isFull(pStr.charAt(i))) {
					_lenCount += 2;
				} else {
					_lenCount += 1;
				}

				if (_lenCount > pLen) {
					_cutString = pStr.substring(0, i);
					_ret = true;
					break;
				} else if (_lenCount == pLen) {
					_cutString = pStr.substring(0, i + 1);
					_ret = true;
					break;
				}
			}
		}

		if (!_ret) {
			_cutString = pStr;
			_ret = true;
		}

		if (_cutString.length == _strLen) {
			_cutFlag = "0";
		}

		return { "cutstring": _cutString, "cutflag": _cutFlag };
	}

	/* 
		* 判断是否为全角 
		*  
		* pChar:长度为1的字符串 
		* return: true:全角 
		*          false:半角 
	*/
	function isFull(pChar) {
		if ((pChar.charCodeAt(0) > 128)) {
			return true;
		} else {
			return false;
		}
	}
	//---------------------10.9----------------------//
	//获取host
	var push_hgid = [];
	var push_hid = [];
	var push_hid_len = 0;
	var count_ajax = 0;
	var count_ajax_MAX=10;
	var _initHTML_MAX=1;

	function get_hostdirectory(id,editid){
		$.ajax({
			url:'/bhost/get_hostdirectory_zw',
			type:'post',
			async:false,
			data:{a0: $("input[name=se]").val(),z1:id,z2:editid},
			success:function(result){
				h_data = JSON.parse(result);
				count_ajax = count_ajax + 1;
				if(editid > 0 ){
					$(h_data.data.HGroup).each(function(i,item){
						if(push_hgid.indexOf(item.HGId) <0){
							push_hgid.push(item.HGId + ":false");
						}
					})
				}
				
			}
		})
	}
	//
	function _authTypeTheme(obj){
	    $.each(obj,function(i,item){
	        var $_item = $(item);

	        if($_item.parent().children('span').length == 0){
	            $_item.after('<span class="checkbox"></span>');
	        }

	        var $s = $_item.next('span');
	        var checked = $_item.prop('checked');
	        var disabled = $_item.prop('disabled');

	        if(checked){
	            $s.addClass('checked');
	        }else{
	            $s.removeClass('checked');
	        }

	        if(disabled){
	            $s.addClass('disabled');
	        }else{
	            $s.removeClass('disabled');
	        }
	    })
	}
	var atr = null;
	var atr_flag = 0;
	// 绑定 主机组状态
	function select_checkbox(select_flag,pid,_ajax_find_host_doing){
		if(select_flag == "HGroup"){ //主机组 
			var i = 0;
			var index_w = 0;
			var indx = 0;
			var c_count = 1;
			var index_a = 0;
			function _doselect(){
				index_a+=1;
				for(i = index_w; i< index_w + 200;i+=1){ //每次只加载一个 根据情况定
					if(i >= push_hgid.length){
						if (push_hgid.length == 0){
							clearInterval(if_select);
							return false;
						}else{	
							index_w = 0;
							return false;
						}
					}
					var PGetHNodeSelected_json={
						"type":8,
						"id":editid,
						"ishost": false,
						"hnodeset": new Array()
					}
					for(var m=i;m<i+100;m++){
						if(m>=push_hgid.length){
							break;
						}
						var hg_id = push_hgid[m].split(":")[0];
						var falg_sec = push_hgid[m].split(":")[1];
						var $hg_pinput = $("#nodehg-"+hg_id).parent().parent().siblings('input');
						var hg_pid = 0;
						if ($hg_pinput.length != 0){
							hg_pid = $hg_pinput.attr('id').split('-')[1];
							if(push_hgid.indexOf(hg_id + ':true')>=0){
								continue;
							}
							if(push_hgid.indexOf(hg_pid + ':false')>=0){
								continue;
							}
							if(push_hgid.indexOf(hg_pid + ':true')>=0){
								continue;
							}
						}
						if(falg_sec == 'false'){
							PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": null,"hid": '+hg_id+'}'));
							push_hgid[m] = hg_id + ":" + "true";
						}
					}
					if(PGetHNodeSelected_json.hnodeset.length>0){
						$.ajax({
							url:'/bhost/PGetHNodeSelected',
							type:'post',
							async:true,
							cache:false,
							data:{a0: $("input[name=se]").val(),z1:JSON.stringify(PGetHNodeSelected_json)},//hg_id
							success:function(result){
								var result = JSON.parse(result);
								var data=result.info;
								$.each(data,function (i,item) {
									var _currentId = $("#nodehg-" + item.hid);
									var _span_authtype = _currentId.siblings('span.authtype');
									var mode = parseInt(_span_authtype.find('input').attr("data-mode"));
									var p_id;
									if(_currentId.parent().parent().siblings("input").length>0)
										p_id = _currentId.parent().parent().siblings("input").attr('id').split('-')[1];
									else p_id = 0;
									var if_change_parent = false; //主机组是否改变
									var loadlast = 0;
									var _p_loadfirst = $('#nodehg-' +p_id ).attr("data-loadfirst");
									var _p_loadlast = $('#nodehg-' +p_id ).attr("data-loadlast");
									
									if(_p_loadfirst == _p_loadlast){ //没改变
									}else{
										if_change_parent = true;
										loadlast = _p_loadlast;
									}
									var gl_selected = false;
									if(item.selected == 0){
										_currentId.next('span').attr("class","checkbox");
										_currentId.prop('checked',false);
										_currentId.attr('data-loadfirst',item.selected);
										if(if_change_parent == false) {_currentId.attr('data-loadlast',item.selected);}
										else _currentId.attr('data-loadlast',loadlast);							
										
									}else if(item.selected == 1){
										_currentId.next('span').attr("class","checkbox half");
										_currentId.prop('checked',false);
										_currentId.attr('data-loadfirst',item.selected);
										if(if_change_parent == false) _currentId.attr('data-loadlast',item.selected);
										else _currentId.attr('data-loadlast',loadlast);
									}else{
										_currentId.next('span').attr("class","checkbox checked");
										_currentId.prop('checked',true);
										_currentId.attr('data-loadfirst',item.selected);
										if(if_change_parent == false) _currentId.attr('data-loadlast',item.selected);
										else _currentId.attr('data-loadlast',loadlast);
										
										//判断该主机组是否是 按组授权
										$.each(planInfo.HostSet,function(i1,item1){
											if(item1.HGId == item.hid && item1.HostId == null){
												gl_selected = true;
												return false;
											}
										})
										//
									}

									if(gl_selected){
										_span_authtype.find('input').attr('data-ifselect',true);
										_currentId.attr('data-ifselect',true);
									}else{
										_span_authtype.find('input').attr('data-ifselect',false);
										_currentId.attr('data-ifselect',false);
									}
									//判断是否隐藏按组授权
									
									if(mode == 0 && item.selected == 0 ){ //隐藏按组授权
										_span_authtype.children('label').hide();
									}else if(mode == 0 && item.selected == 1){ //隐藏按组授权
										_span_authtype.children('label').hide();
									}else if(mode == 0 && item.selected == 2){
										if(gl_selected) _span_authtype.children('label').show();
										else _span_authtype.children('label').hide();
									}else if(mode == 2){
										_span_authtype.children('label').show();
									}
									
									//如果父节点的状态改变了
									if(if_change_parent == true){
										if(_p_loadlast == 0){ //1-0 2-0
											_currentId.next('span').attr("class","checkbox");
											_currentId.prop('checked',false);
											
											_span_authtype.find('span').attr("class","checkbox");
											_span_authtype.find('input').prop("checked",false);
											
											if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false ){
												_span_authtype.find('input').prop("disabled",false);
												_currentId.prop('disabled',false);
											}
											
											_currentId.attr('data-loadfirst',item.selected);
											//
											if(_p_loadfirst == 2) _currentId.attr('data-loadfirst',2);
											
										}else if(_p_loadlast == 2){	 // 0-2	 1-2							
											_currentId.prop('checked',true);
											
											//父节点 按组授权
											if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true ){
												_currentId.prop('disabled',true);//input
												_currentId.next('span').attr("class","checkbox checked disabled");
												//<<<< 
												_currentId.attr("data-loadlast","2");
												_span_authtype.find('span').attr('class',"checkbox disabled");
												_span_authtype.find('input').prop('disabled',true);
												
											}else{ // 1-0 1-2
												_currentId.prop('disabled',false);//input
												_currentId.next('span').attr("class","checkbox checked");
												_currentId.attr("data-loadlast","2");
												if(gl_selected){
													_span_authtype.find('span').attr('class',"checkbox checked");
													_span_authtype.find('input').prop('checked',true).prop('disabled',false);
												}else{
													_span_authtype.find('input').prop('disabled',false);
													_span_authtype.find('span').attr('class','checkbox');
												}
											}
										}
									}else{
										//父节点 按组授权
										if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
											_currentId.prop('disabled',true);//input
											_currentId.prop('checked',true);
											_currentId.next('span').attr("class","checkbox checked disabled");
											
											if(_p_loadlast == 2){
												_currentId.attr("data-loadlast","2");
											}
											
											if(gl_selected){
												_span_authtype.find('span').attr('class',"checkbox checked disabled");
												_currentId.siblings('span.authtype').find('input').prop('checked',true).prop('disabled',true);
											}else{
												_span_authtype.find('input').prop('disabled',true);
												_span_authtype.find('span').attr('class','checkbox disabled');
											}
										}else{
											_currentId.attr('disabled',false);//input
											_currentId.next('span').removeClass("disabled");

											if(_p_loadlast == 2){
												_currentId.prop('checked',true);
												_currentId.attr("data-loadlast","2");
												_currentId.attr("data-loadfirst", "2");
												_currentId.next('span').attr("class","checkbox checked");
											}
											if(gl_selected){
												_span_authtype.find('span').attr('class',"checkbox checked");
												_span_authtype.find('input').prop('checked',true).prop('disabled',false);
											}else{
												_span_authtype.find('input').prop('disabled',false);
												_span_authtype.find('span').attr('class','checkbox');
											}
										}
									}
									if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')){
										_currentId.prop('checked',true);
										_currentId.prop('disabled',true);//input
										_currentId.next('span').attr("class","checkbox checked disabled");
										//<<<< 
										_span_authtype.find('span').addClass("disabled");
										_span_authtype.find('input').prop('disabled',true);
									}
									//触发change
									
									var ind = push_hgid.indexOf(item.hid + ":" + "true");
									if (ind != -1){
										push_hgid.splice(ind,1);
										i = 0;
									}
								})
							},
							error:function(XmlHttpRequest,textStatus, errorThrown){
								// var ind = push_hgid.indexOf(hg_id + ":" + "true");
								// if(ind >=0){
								// 	push_hgid.splice(ind,1);
								// 	push_hgid.push(hg_id + ":" + "false");
								// }
								return false;
							}
						})
					}
				}
				index_w = i;
				
			}
			var if_select = setInterval(function(){
				if (push_hgid.length == 0){  //
					clearInterval(if_select);
					return false;
				}
				var f = false;
				$.each(push_hgid,function(i1,item1){
					if(item1.split(':')[1] == "false"){
						f = true;
					}	
				})
				if(f ==false){
					clearInterval(if_select);
					return false;
					
				}
				_doselect();	
				if(Date.parse(new Date())/1000 - global_time >=1)
					setTimeout("get_msg()", 100);	
			},10);
			
		}
		else if(select_flag == "Host"){ //主机
			var i = 0;
			var index_w = 0;
			var indx = 0;
			var c_count = 700; 
			function _doselect1(){
					for(i = index_w; i< index_w + 20;i+=1){ //每次只加载一个 根据情况定
						if(i >= push_hid.length){
							if (push_hid.length == 0){
								clearInterval(if_select1);
								return false;
							}else{	
								index_w = 0;
								i = 0;
								return false;
							}
						}
						
						var PGetHNodeSelected_json={
							"type":8,
							"id":editid,
							"ishost": true,
							"hnodeset": new Array()
						}
						for(var m=i;m<i+5;m++){
							if(m>=push_hid.length){
								break;
							}
							var pid_h = push_hid[m].split(":")[0];
							var h_id = push_hid[m].split(":")[1];
							var falg_sec = push_hid[m].split(":")[2];
							if(push_hid.indexOf(pid_h + ':' + h_id + ":" + "true")>=0){
								continue;
							}
							if(push_hgid.indexOf(pid_h + ':false')>=0){
								continue;
							}
							if(push_hgid.indexOf(pid_h + ':true')>=0){
								continue;
							}
							if(falg_sec == 'false'){
								PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": '+pid_h+',"hid": '+h_id+'}'));
								push_hid[m] = pid_h + ':' + h_id + ":" + "true";
							}
						}
						if(PGetHNodeSelected_json.hnodeset.length>0){
							atr = $.ajax({
								url:'/bhost/PGetHNodeSelected',
								type:'post',
								async:true,
								cache:false,
								data:{a0: $("input[name=se]").val(),z1:JSON.stringify(PGetHNodeSelected_json)},//hg_id
								success:function(result){
									var result = JSON.parse(result);
									data = result.info;
									$.each(data,function (i,item) {
										var p_id = item.parentid;//当前组所在的父组id
										_currentId = $("#nodeh-"+p_id+'-' + item.hid);//当前id
										atr_flag = 1;
										if (_currentId.length == 0){
											return false;
										}
										var _span_authtype = _currentId.siblings('span.authtype');//当前按组授权
										var li_currentId = _currentId.parent();
										var mode = parseInt(_span_authtype.find('input').attr("data-mode"));
										var if_change_parent = false; //主机组是否改变
										var loadlast = 0;
										var _p_loadfirst = $('#nodehg-' +p_id ).attr("data-loadfirst");
										var _p_loadlast = $('#nodehg-' +p_id ).attr("data-loadlast");
										if(_p_loadfirst == _p_loadlast){ //没改变
										}else{
											if_change_parent = true;
											loadlast = _p_loadlast;
										}
										
										//绑定 data-loadfirst状态 和 data-loadlast
										var gl_selected = false;
										if(item.selected == 0){
											_currentId.next('span').attr("class","checkbox");
											_currentId.prop('checked',false);
											_currentId.attr('data-loadfirst',item.selected);
											
											if(if_change_parent == false) _currentId.attr('data-loadlast',item.selected);
											else _currentId.attr('data-loadlast',loadlast);
										}else if(item.selected == 1){
											_currentId.next('span').attr("class","checkbox half");
											_currentId.prop('checked',false);
											_currentId.attr('data-loadfirst',item.selected);
											
											if(if_change_parent == false) _currentId.attr('data-loadlast',item.selected);
											else _currentId.attr('data-loadlast',loadlast);
											
										}else{
											_currentId.next('span').attr("class","checkbox checked");
											_currentId.prop('checked',true);
											_currentId.attr('data-loadfirst',item.selected);
											
											if(if_change_parent == false) _currentId.attr('data-loadlast',item.selected);
											else _currentId.attr('data-loadlast',loadlast);
											//
											$.each(planInfo.HostSet,function(i1,item1){
												if(item1.HGId == p_id && item1.HostId == item.hid){
													gl_selected = true;
													return false;
												}
											})
										}
										//绑定是否按组授权状态
										if(gl_selected){
											_span_authtype.find('input').attr('data-ifselect',true);
											_currentId.attr('data-ifselect',true);
										}else{
											_span_authtype.find('input').attr('data-ifselect',false);
											_currentId.attr('data-ifselect',false);
										}
										//判断是否隐藏主机 因为存在 当前用户的管理权限 加了这个
										if(_ajax_find_host_doing==false && tmp_list==null){
											if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
												_currentId.attr('data-mode','2');
												li_currentId.show();
											}else{
												if(mode == 0 && item.selected == 0 ){ //隐藏主机
													li_currentId.hide();
												}else if(mode == 0 && item.selected == 1){ //隐藏主机
													_currentId.attr('data-mode','2');
													li_currentId.show();
												}else if(mode == 0 && item.selected == 2){
													_currentId.attr('data-mode','2');
													li_currentId.show();
												}else if(mode == 2){
													li_currentId.show();
												}
											}
										}else if(_ajax_find_host_doing==true){
											li_currentId.hide();
											if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
												if(mode != 0 || item.selected != 0){
													_currentId.attr('data-mode','2');
													if(_currentId.hasClass("show_input")){
														li_currentId.show();
														_currentId.removeClass('show_input');
													}
												}else{
													_currentId.attr('data-mode','0');
													_currentId.removeClass('show_input');
												}
											}
											else{
												if(mode == 0 && item.selected == 0 ){ //隐藏主机
													_currentId.removeClass('show_input');
												}else if(mode == 0 && item.selected == 1){ //隐藏主机
													_currentId.attr('data-mode','2');
													if(_currentId.hasClass("show_input")){
														li_currentId.show();
														_currentId.removeClass('show_input');
													}
												}else if(mode == 0 && item.selected == 2){
													_currentId.attr('data-mode','2');
													if(_currentId.hasClass("show_input")){
														li_currentId.show();
														_currentId.removeClass('show_input');
													}
												}else if(mode == 2){
													_currentId.attr('data-mode','2');
													if(_currentId.hasClass("show_input")){
														li_currentId.show();
														_currentId.removeClass('show_input');
													}
												}
											}
										}else{
											li_currentId.hide();
											if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
												
												if(mode!=0 || item.selected!=0){
													_currentId.attr('data-mode','2');
													li_currentId.show();
													_currentId.removeClass('show_input');
												}else{
													_currentId.removeClass('show_input');
													li_currentId.hide();
													_currentId.attr('data-mode','0');
												}
												
											}else{
												if(mode == 0 && item.selected == 0 ){ //隐藏主机
													_currentId.removeClass('show_input');
													li_currentId.hide();
												}else if(mode == 0 && item.selected == 1){ //隐藏主机
													_currentId.attr('data-mode','2');
														li_currentId.show();
														_currentId.removeClass('show_input');
													//}
												}else if(mode == 0 && item.selected == 2){
													_currentId.attr('data-mode','2');
														li_currentId.show();
														_currentId.removeClass('show_input');
													//}
												}else if(mode == 2){
														li_currentId.show();
														_currentId.removeClass('show_input');
													//}
												}
											}
										}
										
										//查看 父节点 是否是 1、全选还是空 2、是否按组授权 勾选 / disabled
										if(if_change_parent){
											if(_p_loadlast == 0){
												_currentId.next('span').attr("class","checkbox");
												_currentId.prop('checked',false);
												_span_authtype.find('span').attr("class","checkbox");
												_span_authtype.find('input').prop("checked",false);
												if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false ){
													_span_authtype.find('input').prop("disabled",false);
													_currentId.prop('disabled',false);
												}
												//
												if(_p_loadfirst == 2) _currentId.attr('data-loadfirst',2);
												
											}else if(_p_loadlast == 2){									
												_currentId.prop('checked',true);
												
												//父节点 按组授权
												if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
													_currentId.prop('disabled',true);//input
													_currentId.next('span').attr("class","checkbox checked disabled");
													_currentId.attr("data-loadlast","2");
													_span_authtype.find('input').prop('disabled',true);
													_span_authtype.find('span').attr('class','checkbox disabled');
													
												}else{
													_currentId.prop('disabled',false);//input
													_currentId.next('span').attr("class","checkbox checked");
													_currentId.attr("data-loadlast","2");
													if(gl_selected){
														_span_authtype.find('span').attr('class',"checkbox checked");
														_span_authtype.find('input').prop('checked',true).prop('disabled',false);
													}else{
														_span_authtype.find('input').prop('disabled',false);
														_span_authtype.find('span').attr('class','checkbox');
													}
												}
											}
										}else{
											//父节点 按组授权
											if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true){
												_currentId.prop('disabled',true);//input
												_currentId.next('span').attr("class","checkbox checked disabled");
												if(_p_loadlast == 2){
													_currentId.prop('checked',true);
													_currentId.attr("data-loadlast","2");
												}
												if(gl_selected){
													_span_authtype.find('span').attr('class',"checkbox checked disabled");
													_span_authtype.find('input').prop('checked',true).prop('disabled',true);
												}else{
													_span_authtype.find('input').prop('disabled',true);
													_span_authtype.find('span').attr('class','checkbox disabled');
												}
												
											}else{
												_currentId.prop('disabled',false);//input
												_currentId.next('span').removeClass("disabled");
												if(_p_loadlast == 2){
													_currentId.prop('checked',true);
													_currentId.next('span').attr("class","checkbox checked");
													_currentId.attr("data-loadlast","2");
													_currentId.attr("data-loadfirst", "2");
												}
												if(gl_selected){
													_span_authtype.find('span').attr('class',"checkbox checked");
													_span_authtype.find('input').prop('checked',true).prop('disabled',false);
												}else{
													_span_authtype.find('input').prop('disabled',false);
													_span_authtype.find('span').attr('class','checkbox');
												}
													
											}
										}
										//发现父主机组是disabled
										if(_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')){
											_currentId.prop('checked',true);
											_currentId.prop('disabled',true);//input
											_currentId.next('span').attr("class","checkbox checked disabled");
											_span_authtype.find('span').addClass("disabled");
											_span_authtype.find('input').prop('disabled',true);
										}
										
										var ind = push_hid.indexOf(p_id + ':' + item.hid + ":" + "true");
										if (ind != -1){
											push_hid.splice(ind,1);
											i = 0;
										}
									});
								},
								error:function(XmlHttpRequest,textStatus, errorThrown){
									return false;
								}
							});
						}
					}
					index_w = i;
			}
			var if_select1 = setInterval(function(){
				if (push_hid.length == 0) {  //
					clearInterval(if_select1);
					return false;
				}
				var ff = false;
				$.each(push_hid,function(i1,item1){
					if(item1.split(':')[2] == "false"){
						ff = true;
					}	
				})
				if(ff ==false){
					clearInterval(if_select1);
					return false;
					
				}
				if (push_hid.length == 0){  //
					clearInterval(if_select1);
					return false;
				}
				_doselect1();	
				setTimeout("get_msg()", 100);	
			},10);
		}
	}

	var tmp_list=null;
	var tmp_list_path_strarray=null;
	var ajax_find_host_doing=false;
	var first_find_index=null;
	function  coverString(subStr,str){
		subStr=subStr.replace(/\?/g, "\\?").replace(/\|/g, "\\|").replace(/\\/g, "\\\\").replace(/\$/g, "\\$").replace(/\(/g, "\\(").replace(/\)/g, "\\)").replace(/\*/g, "\\*").replace(/\./g, "\\.").replace(/\[/g, "\\[").replace(/\^/g, "\\^").replace(/\{/g, "\\{");
		var reg = eval("/"+subStr+"/ig");
		return reg.test(str);
	}
	function red_to_no_red_and_open_to_red(obj,num){
		for(var i=0;i<tmp_list.length;i++){
			var item=tmp_list[i];
			var pass=true;
			for(var jm=0;jm<find_host_arry.length;jm++){
				var pass_one=false;
				// var search_arr=find_host_arry[jm].split(' ');
				var jm_index_=find_host_arry[jm].indexOf('-');
				var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
				$.each(search_arr,function(i1,item1){
					if(item1!=''){
						if(find_host_arry[jm].substr(0,jm_index_)=='hostname'){
							var Name=item.Name.split('\t')[0];
							if (item.Type!=2){
								return false;
							}
						}else if(find_host_arry[jm].substr(0,jm_index_)=='ip'){
							var Name=item.Name.split('\t')[1];
							if (item.Type!=2){
								return false;
							}
						}else if(find_host_arry[jm].substr(0,jm_index_)=='hgname'){
							var Name=item.Name;
							if (item.Type!=1){
								return false;
							}
						}else if(find_host_arry[jm].substr(0,jm_index_)=='hostservicename'){
							var Name=item.Name.split('\t')[0];
							if (item.Type!=3){
								return false;
							}
						}else if(find_host_arry[jm].substr(0,jm_index_)=='accountname'){
							var Name=item.Name;
							if (item.Type!=4){
								return false;
							}
						}else{
							var Name=item.Name;
						}
						if(coverString(item1,Name)){
							pass_one=true;
							return false;
						}
					}
				});
				if(pass_one==false){
					pass=false;
				}
			}
			if(pass==true){
				open_and_make_red(item);
			}else{
			}
		}
		li_red_to_no_red($('#hostTree'));
		//非红隐藏
		setTimeout(function () {
			li_hide_while_no_red($('#hostTree'),0);
		},1);
		//定位
		top_to_move($('#hostTree'));
	}
	var _jScrollBar_array = [];
	function _jScrollBar(scid) {
		var myBar = new MyScrollBar({
			selId:scid,
			hasX:true,
			hasY:false,
			width:6,
			// enterShow:false,
		})
	}
	function open_and_make_red(item){
		var Path_array=item.Path.split('/');
		var len=Path_array.length;
		if (len == 2){//主机层
			//show
			$('#nodehg-'+item.Id).parent('li').show();
			$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
		}else{
			if (item.Type == 3 || item.Type == 4){ //服务/账号
				var s=0;
				for (var j = 1; j < len; j++){
					var id=Path_array[j].split(',')[1];
					if (j == len-1){ //主机层
						//show
						$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).parent('li').show();

						$i_item=$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).prev('i');
						if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
							$i_item.trigger('click');
						}
					}
					else{ //主机组层
						//show
						$('#nodehg-'+id).parent('li').show();
						$i_item=$('#nodehg-'+id).prev('i');
						if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
							filter_flag_append = true;
							$i_item.trigger('click');
						}
						//}
					}
				}
				if(s){
					return false;
				}
				if (item.Type == 4){
					$i_item.siblings('ul').find('input').each(function(i1,item1){
						var checkbox_id = $(item1).attr('id');
						if(checkbox_id==undefined){
							return true;
						}
						if (checkbox_id.indexOf('-') != -1){
							var all_id = checkbox_id.split('-');
							if (all_id.length == 5){
								var hg_id = all_id[1];
								var h_id = all_id[2];
								var a_id = all_id[3];
								var s_id = all_id[4];
								if (a_id == item.Id){
									//show
									$("#nodes-"+hg_id+'-'+h_id+'-'+s_id).parent('li').show();
									var $i_item = $("#nodes-"+hg_id+'-'+h_id+'-'+s_id).prev('i');
									if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
										filter_flag_append = true;
										$i_item.trigger('click');
									}
									//show
									$(item1).parent('li').show();
									$(item1).siblings('span.h-name').addClass('h-name-red');
								}
							}
						}
					})
				}
				else{
					var all_id = $i_item.siblings('input').attr('id').split('-');
					//show
					$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+item.Id).parent('li').show();
					$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+item.Id).siblings('span.h-name').addClass('h-name-red');
				}
					
			}else{
				for(var j=1;j<len-1;j++){
					var id=Path_array[j].split(',')[1];
					//show
					$('#nodehg-'+id).parent('li').show();
					$i_item=$('#nodehg-'+id).prev('i');
						if(($i_item.attr('class').indexOf('h-aicon-d')) == -1){
							filter_flag_append = true;
							$i_item.trigger('click');
						}		
					//}
				}
				if(item.Type==1){
					//show
					$('#nodehg-'+item.Id).parent('li').show();
					$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
				}else{
					//show
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).parent('li').show();
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).siblings('span.h-name').addClass('h-name-red');
				}
			}
		}
	}

	function top_to_move(obj){
		var top_arr=$(obj).find('span.h-name-red');
		if(top_arr.length!=0){
			$('.c-cont').scrollTop(top_arr.eq(0).offset().top-200);
			_waitDone($(".waitTip"));
		}else{
			$("#server_text1").blur();
			_alert(0,'搜索','无搜索结果',$("#server_text1"));
			_waitDone($(".waitTip"));
		}
	}


	var h_data="";
	var host_path_all =[];
	var old_path_all = [];
	var flag_loading = false;
	var index_f = 0;

	var ajax_flag = false;

	var get_initHTML_id=new Array();
	var get_initHTML_v=new Array();
	var get_initHTML_d=new Array();
	var global_time=Date.parse(new Date())/1000;
	function get_msg(){
		var n=0;
		$.ajax({
			url: '/bhost/get_msg',
			type: "post",
			async:false,
			data: {a0: $("input[name=se]").val()},
			success: function(result) {
				var result=JSON.parse(result);
				//////console.log('get_msg');
				global_time = Date.parse(new Date())/1000;	
				if(result.Result == false){
					if(result.info.indexOf('系统异常')>=0 || result.info.indexOf('非法访问')>=0 || result.info.indexOf('系统超时') >=0 ){
						_alert(2,'系统',result.info);
					}else{
						_alert(2,'系统',result.info);
					}
				}
				else{
				}
			}
		})
		if(n) return false;	
	}
	function red_to_font(obj){
		////console.log($(obj));
		var item=$(obj).siblings('span.h-name');
		var item_name = item.siblings('input').attr('data-name');
		var Type = item.siblings('input').attr('id');
		var $span_son_font=$('.h-name-son',item).find('font');
		////console.log(Type);
		if(Type.indexOf('nodeh')<0){
			var span_son_name=item_name.toLowerCase();
		}else{
			var host_span_arr=item_name.split('\t');
			var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
		}
		for (var jm = 0; jm < find_host_arry.length; jm++) {
			var pass_one = false;
			var jm_index_ = find_host_arry[jm].indexOf('-');
			var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
			$.each(search_arr, function (i1, item1) {
					if(item1==''){
						return true;
					}
					if (find_host_arry[jm].substr(0, jm_index_) == 'hgname'){
						var Name = item_name;
						if(Type.indexOf('nodehg')<0){
							return true;
						}
					}else if (find_host_arry[jm].substr(0, jm_index_) == 'hostname') {
						var Name = item_name.split('\t')[0];
						if(Type.indexOf('nodeh')<0){
							return true;
						}
					} else if (find_host_arry[jm].substr(0, jm_index_) == 'ip'){
						var Name = item_name.split('\t')[1];
						if(Type.indexOf('nodeh')<0){
							return true;
						}
					}else if (find_host_arry[jm].substr(0, jm_index_) == 'hostservicename'){
						var Name = item_name;
						if(Type.indexOf('nodes')<0){
							return true;
						}
					}else if (find_host_arry[jm].substr(0, jm_index_) == 'accountname'){
						var Name = item_name;
						if(Type.indexOf('nodea')<0){
							return true;
						}
					}else{
						var Name = item_name;
					}
				if (coverString(item1, Name)) {
					item1=item1.toLowerCase();
					if(find_host_arry[jm].substr(0, jm_index_) == 'ip'){
						var index_start=span_son_name.indexOf('(');
						var index_true=span_son_name.indexOf(item1,index_start);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}else{
						var index_true=span_son_name.indexOf(item1);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}
				}
			});
		}
	}
	function find_append(){
		ajax_data = [];
		ajax_flag = false;
		var i = 0;
		var t_do1;
		index_f =0;
		function _do1(){
			clearTimeout(t_do1);
			//////console.log('_do1');
			for(i=index_f;i< index_f+50;i++){
				if(ajax_flag == true) {
					t_do1=setTimeout(function () {_do1();},1);
					return false;
				}
				if(flag_ajax_true == true)  {
					t_do1=setTimeout(function () {_do1();},1);
					return false;
				}
				if (i >= host_path_all.length){    //
					if(flag_ajax_true == true)  {
						t_do1=setTimeout(function () {_do1();},1);
						return false;
					}
					if (host_path_all.length == 0){
						scrollTop_check_server1();
						return false;
					}else{
						if(ajax_data.length > 0) ajax_host(); //300个检索叫条件里面的主机 都没达到50 也去执行ajax——host
						index_f = 0;
						t_do1=setTimeout(function () {_do1();},1);
						return false;
					}
				}
				//////console.log(JSON.stringify(host_path_all));
				//////console.log(Path_array);
				var Path_array=host_path_all[i].Path.split('/');
				var len=Path_array.length;
				if (len == 2){//主机层
					if($('#nodehg-'+host_path_all[i].Id).length == 0) {
						continue;
					}//
					//show
					$('#nodehg-'+host_path_all[i].Id).parent('li').show();
					$('#nodehg-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
					red_to_font($('#nodehg-'+host_path_all[i].Id));
					$('#nodehg-'+host_path_all[i].Id).siblings('ul').find('li').show();
				}
				else{
					if (host_path_all[i].Type == 3 || host_path_all[i].Type == 4){ //服务/账号
						for (var j = 1; j < len; j++){
							var id=Path_array[j].split(',')[1];
							s = 0;
							if (j == len-1){ //主机层
								//数据正在展开 留在 host_path_all，下次继续执行
								
								if(flag_loading == true){
									s = 1;
									break;
								}
								//数据未完全展开 留在 host_path_all，下次继续执行
								if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).length == 0){
									continue;
								}
								//show
								$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).parent('li').show();
								red_to_font($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id));
								$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).addClass('show_input');
								$i_item=$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).prev('i');
								if($i_item.attr('class') == "h-blank"){ //
									host_path_all.splice(i,1);	
									//i--;
									s = 1;
									break;
								}
								if (push_hid.indexOf((Path_array[j-1].split(',')[1]+':'+id+':true')) != -1){
									s = 1;
									break;
								}
								if (push_hid.indexOf((Path_array[j-1].split(',')[1]+':'+id+':false')) != -1){
									s = 1;
									break;
								}
								if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).siblings('ul').children('li').length == 0){
									filter_flag_append = true;
									if(ajax_data.length >= MAX_AJAX){
										ajax_host();
										t_do1=setTimeout(function () {_do1();},1);
										return false;
									}else{
										hg_id = Path_array[j-1].split(',')[1];
										inv = ajax_data.indexOf(hg_id + ":" + id);
										if(inv < 0 ) ajax_data.push(hg_id + ":" + id); //没展开的主机 放入ajax_data			
										if(ajax_data.length >= MAX_AJAX){
											//去调用 展开的主机
											ajax_host();
											t_do1=setTimeout(function () {_do1();},1);
											return false;
										}else{
											// if(host_path_all.length <= MAX_AJAX){
											// 	ajax_host();
											// 	return false;
											// }
										}
									}
								}else{
									if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
										$i_item.trigger('click');
									}
								}	
															
								
							}
							else{ //主机组层	
								if($('#nodehg-'+id).length == 0) {
									s = 1
									break;//
								}
								if(flag_loading == true){
									s = 1;
									break;
								}

								$('#nodehg-'+id).parent('li').show();
								red_to_font($('#nodehg-'+id));
								$i_item=$('#nodehg-'+id).prev('i');
								//发现主机或者组 其实下面没数据，跳过该条数据
								if($i_item.attr('class') == "h-blank"){ //
									host_path_all.splice(i,1);	
									//i--;
									s = 1;
									break;
								}
								if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
									filter_flag_append = true;
									$i_item.trigger('click');
								}
								
							}
						}
						if(s) continue;
						var s = 0;
						if (host_path_all[i].Type == 4){
							if(flag_loading == true) {continue;}
							var hg_id=Path_array[j-2].split(',')[1];
							var h_id=Path_array[j-1].split(',')[1];
							//////console.log('hg_id:'+hg_id+'|h_id:'+h_id+'|');
							if ($("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent).length == 0){
								continue;
							}
							//show
							$("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent).parent('li').show();
							red_to_font($("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent));
							var $i_item = $("#nodes-"+hg_id+'-'+h_id+'-'+host_path_all[i].Parent).prev('i');
							
							if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
								filter_flag_append = true;
								$i_item.trigger('click');
							}
							//show
							$("#nodea-"+hg_id+'-'+h_id+'-'+host_path_all[i].Id+'-'+host_path_all[i].Parent).parent('li').show();
							$("#nodea-"+hg_id+'-'+h_id+'-'+host_path_all[i].Id+'-'+host_path_all[i].Parent).siblings('span.h-name').addClass('h-name-red');
							red_to_font($("#nodea-"+hg_id+'-'+h_id+'-'+host_path_all[i].Id+'-'+host_path_all[i].Parent));
							$("#nodea-"+hg_id+'-'+h_id+'-'+host_path_all[i].Id+'-'+host_path_all[i].Parent).siblings('ul').find('li').show();
						}
						else{
							var all_id = $i_item.siblings('input').attr('id').split('-');
							if ($("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id).length == 0){
								continue;
							}
							//show
							$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id).parent('li').show();
							red_to_font($("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id));
							$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
							$("#nodes-"+all_id[1]+'-'+all_id[2]+'-'+host_path_all[i].Id).siblings('ul').find('li').show();
						}
							
					}
					else{
						s = 0;
						for(var j=1;j<len-1;j++){
							var id=Path_array[j].split(',')[1];
							if($('#nodehg-'+id).length == 0) {
								s = 1;
								break;//
							}
							if(flag_loading == true) {
								s = 1;
								break;
							}
							//show
							$('#nodehg-'+id).parent('li').show();
							$i_item=$('#nodehg-'+id).prev('i');
							
							if($i_item.attr('class') == "h-blank"){ //
								host_path_all.splice(i,1);	
								//i--;
								s = 1;
								break;//
							}
							if (push_hgid.indexOf(Path_array[j-1].split(',')[1]+':true') != -1){
								continue;
							}
							if (push_hgid.indexOf(Path_array[j-1].split(',')[1]+':false') != -1){
								continue;
							}
							if($('#nodehg-'+id).length >0){
								red_to_font($('#nodehg-'+id));
								if(($i_item.attr('class').indexOf('h-aicon-d')) == -1){
									filter_flag_append = true;
									$i_item.trigger('click');
								}		
							}
						}
						if(s) continue;
						if(host_path_all[i].Type==1){
							if($('#nodehg-'+host_path_all[i].Id).length == 0) continue;//
							//show
							$('#nodehg-'+host_path_all[i].Id).parent('li').show();
							$('#nodehg-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
							red_to_font($('#nodehg-'+host_path_all[i].Id));
							$('#nodehg-'+host_path_all[i].Id).siblings('ul').find('li').show();
						}else{
							if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).length == 0){
								continue;
							}//
							//show
							$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).parent('li').show();
							$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).addClass('show_input');
							$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
							red_to_font($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id));
							$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).siblings('ul').find('li').show();
						}
					}
				}
				//数据展开后 从host_path_all删除掉，并且放在old_path_all，为标红和定位准备
				push_filter_wait.push(host_path_all[i]);
				old_path_all.push(host_path_all[i]);
				host_path_all.splice(i,1);
			}
			index_f = i;
			get_msg();	
			t_do1=setTimeout(function () {_do1();},1);
		}
		_do1();
	}


	var s_h_array = [];
	var s_s_array = [];
	function click_s_h(){
		$.each(s_h_array,function(i,item){
			if(($(item).attr('class').indexOf('h-aicon-d')) === -1){
				filter_flag_append = true;
				$i_item.trigger('click');
			}
		});
		$.each(s_s_array,function(i,item){
			if(($(item).attr('class').indexOf('h-aicon-d')) === -1){
				filter_flag_append = true;
				$(item).trigger('click');
			}
		});
	}
	function get_hostdirectory1(obj,id,v,d){
		flag_loading = true;
		var loading_hgid;

		$.ajax({
			url:'/bhost/get_hostdirectory_zw',
			type:'post',
			async:true,
			cache:false,
			data:{a0: $("input[name=se]").val(),z1:id,z2:editid,z3:ajax_find_host_doing?'true':'false'},
			success:function(result){

				var hdata = JSON.parse(result);
				loading_hgid = id;
				if(editid >0 && ajax_find_host_doing==false) 
					disabled_flag = "disabled";
				else 
					disabled_flag = "";
				var loadfirst = 0;
				var loadlast = 0;
				var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
				var _p_loadfirst = $(obj).siblings('input').attr('data-loadfirst');
				var _p_loadlast = $(obj).siblings('input').attr('data-loadlast');
				var auth_type_checked = false;
				
				if ($(obj).siblings('span.authtype').find('input').length != 0){
					auth_type_checked = $(obj).siblings('span.authtype').find('input').prop('checked');
				}
				if ((_p_loadfirst == 0) && (_p_loadlast == 0)){
				}
				if (auth_type_checked){
					disabled_flag = "";
				}
				
				if (_p_loadfirst == _p_loadlast){ 
					if (_p_loadlast == 2){
						loadfirst = 2
						loadlast = 2;
					}
				}else{
					if (_p_loadlast == 2){
						loadlast = 2;
					}
					if (_p_loadfirst == 2){
						loadfirst = 2;
					}
					
				}
				if(hdata.data.HGroup == null) hdata.data.HGroup = new Array();
				$.each(hdata.data.HGroup,function(i,item){
					if(item.Mode == 2) var $auth = '<label><input type="checkbox" name="check'+item.HGId+'" data-ifselect=false '+disabled_flag+' data-mode="'+item.Mode+'" >组授权</label>';
					else var $auth = '<label style="display:none;"><input type="checkbox" name="check'+item.HGId+'" data-ifselect=false '+disabled_flag+' data-mode="'+item.Mode+'" >组授权</label>';

					if(ajax_find_host_doing==true && $(obj).siblings('span.h-name-red').length==0){
						var $H = $('<li style="display: none;"></li>');
					}else{
						var $H = $('<li></li>');
					}
					if((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
					else i_class = "h-aicon";
					//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
					//data-loadlast(最后保存的状态)
					if(v==1 && d == 0){
						if(item.Mode == 2) $auth = '<label><input type="checkbox" name="check'+item.HGId+'" data-ifselect=false disabled data-mode="'+item.Mode+'" >组授权</label>';
						else $auth = '<label style="display:none;"><input type="checkbox" name="check'+item.HGId+'" data-ifselect=false '+disabled_flag+' data-mode="'+item.Mode+'" disabled>组授权</label>';
						$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
						'<input type="checkbox" checked="checked" id="nodehg-'+item.HGId+'" data-check="1" class="zcheck zcheck-g" disabled data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-mode="2" data-name="'+item.HGName+'">'+
						'<i class="h-eicon h-eicon-g"></i>'+
						'<span class="h-name" title="'+item.HGName+'" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
								'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
							'<ul style="display:none">Loading...</ul>');
					}else if(v==1){ //v == 1 d ==1
						$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
						'<input type="checkbox" checked="checked" id="nodehg-'+item.HGId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-mode="2" data-name="'+item.HGName+'">'+
						'<i class="h-eicon h-eicon-g"></i>'+
						'<span class="h-name" title="'+item.HGName+'" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
								'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
							'<ul style="display:none">Loading...</ul>');
					}else if(v==0){
						$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
						'<input type="checkbox" id="nodehg-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-mode="2" data-name="'+item.HGName+'">'+
						'<i class="h-eicon h-eicon-g"></i>'+
						'<span class="h-name" title="'+item.HGName+'" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
								'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
							'<ul style="display:none">Loading...</ul>');
					}else{
						$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
						'<input type="checkbox" id="nodehg-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" '+disabled_flag+' data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="2" data-name="'+item.HGName+'">'+
						'<i class="h-eicon h-eicon-g"></i>'+
						'<span class="h-name" title="'+item.HGName+'" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
								'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
							'<ul style="display:none">Loading...</ul>');
						
					}
					if(editid > 0 ){
						if (auth_type_checked){
							
						}else{
							if(push_hgid.indexOf(item.HGId + ":false") <0){
								push_hgid.push(item.HGId + ":false");
							}
						}
						
					}
					$(obj).append($H);
				})
				_checkView_host(obj);
				if(editid > 0){
					var _ajax_find_host_doing=ajax_find_host_doing;
					select_checkbox("HGroup",parent_id,_ajax_find_host_doing);	 //只有编辑情况下 才需要判断 select 
				}
							
				if(hdata.data.Host == null) {
					hdata.data.Host = [];
					flag_loading = false;
					_closeLoading();
					return false;
				}
				
				var i = 0;
				var index = 0;
				html_str = "";
				$.each(hdata.data.Host,function (i,item) {
					if((hdata.data.Host[i].Selected==0 && hdata.data.Host[i].Mode==0 && ajax_find_host_doing==true) || (editid<=0 && hdata.data.Host[i].Mode==0)){
						return true;
					}
					var $auth = '<label><input type="checkbox" name="check'+hdata.data.Host[i].HostId+'"  '+disabled_flag+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" >主机授权</label>';
					if(ajax_find_host_doing==true && $(obj).siblings('span.h-name-red').length==0){
						var $H = $('<li style="display: none;"></li>');
					}else{
						var $H = $('<li></li>');
					}
					var HostName_h = hdata.data.Host[i].HostName;
					// var HostName_h = autoAddEllipsis(hdata.data.Host[i].HostName,'12');
					if(hdata.data.Host[i].AccountNum == 0) i_class = "h-blank";
					else i_class = "h-aicon";
					
					if(v==1 && d == 0){
							$auth = '<label><input type="checkbox" name="check'+hdata.data.Host[i].HostId+'" disabled data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" >主机授权</label>';
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
						'<input type="checkbox" checked="checked" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+'  disabled  data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
						'<i class="h-eicon h-eicon-u"></i>'+
						'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
								'<span class="h-name-son" style="">' + 
							(HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
							'<ul style="display:none">Loading...</ul>');
						
					}else if(v==1){
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
						'<input type="checkbox" checked="checked" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
						'<i class="h-eicon h-eicon-u"></i>'+
						'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
								'<span class="h-name-son" style="">' + 
							(HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
							'<ul style="display:none">Loading...</ul>');
					}else if(v==0){
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
						'<input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
						'<i class="h-eicon h-eicon-u"></i>'+
						'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
								'<span class="h-name-son" style="">' + 
							(HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
							'<ul style="display:none">Loading...</ul>');
					}else{
						$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
						'<input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=0 data-loadlast='+loadlast+' '+disabled_flag+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
						'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
						'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
								'<span class="h-name-son" style="">' + 
							(HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						if(ajax_find_host_doing==false){
							$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
							'<input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=0 data-loadlast='+loadlast+' '+disabled_flag+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
							'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
							'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
								'<span class="h-name-son" style="">' + 
								(HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
								'</span>'+
								'</span>'+
								'<span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						
						}
						else{
							switch(hdata.data.Host[i].Selected){
								case 0:
									$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
									'<input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=0 data-loadlast='+hdata.data.Host[i].Selected+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
									'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
									'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
									'<span class="h-name-son" style="">' + 
										(HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
											return '<font>'+params+'</font>'    
										}).join('') + 
										'</span>'+
										'</span>'+
										'<span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
									break;
								case 1:
									$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
									'<input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="2" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=1 data-loadlast='+hdata.data.Host[i].Selected+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
									'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
									'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
									'<span class="h-name-son" style="">' + 
										(HostName_h+'('+hdata.data.Host[i].HostIP+')').split('').map(function (params) {
											return '<font>'+params+'</font>'    
										}).join('') + 
										'</span>'+
										'</span>'+
										'<span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
									break;
								case 2:
									$.each(planInfo.HostSet,function(i1,item1){
										if((item1.HostId == hdata.data.Host[i].HostId) && (item1.HGId == parseInt(parent_id)) && (item1.AccountId == null) && (item1.HostServiceId == null)){
											$auth = '<label><input type="checkbox" name="check'+hdata.data.Host[i].HostId+'" checked="checked" data-ifselect=true data-mode="'+hdata.data.Host[i].Mode+'" >主机授权</label>';
											return false;
										}
									})
									$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" />'+
									'<input type="checkbox" checked="checked" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=2 data-loadlast='+hdata.data.Host[i].Selected+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostName+'\t'+hdata.data.Host[i].HostIP+'">'+
									'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
									'<span class="h-name" style="width: 16em;" title="'+HostName_h+'('+hdata.data.Host[i].HostIP+')'+'" id="spanHG-' + parent_id+'-'+hdata.data.Host[i].HostId + '">'+
									'<span class="h-name-son" style="">' + 
										HostName_h+'('+hdata.data.Host[i].HostIP+')'.split('').map(function (params) {
											return '<font>'+params+'</font>'    
										}).join('') + 
										'</span>'+
										'</span>'+
										'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
										'<ul style="display:none">Loading...</ul>');
									break;
							}
						}
						
					}
					if(editid > 0){
					
						if (auth_type_checked){
						
						}else{
							if(push_hid.indexOf(parent_id + ':' + hdata.data.Host[i].HostId + ":false") <0){
								if(ajax_find_host_doing==false){
									push_hid.push(parent_id + ':' + hdata.data.Host[i].HostId + ":false");
								}
								
							}
						}
					}
					$(obj).append($H);
					_checkView1($('#nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId));
				});
				_closeLoading();
				var _ajax_find_host_doing=ajax_find_host_doing;

				select_checkbox("Host",parent_id,_ajax_find_host_doing);
				flag_loading = false;
			}
		});
	}

	function _checkView_host(obj){
		_authTypeTheme($('span.authtype input',obj));

		$('input.zcheck',obj).each(function(){
			var $s = $('<span class="checkbox"></span>');
			$(this).after($s);
			var v = $(this).prop('checked');
			if(v){
				$s.addClass('checked');
			}else{
				var c = $(this).data('check');
				if(c && c==2){
					$s.addClass('half');
				}
			}

			var d = $(this).prop('disabled');
			if(d){
				$s.addClass('disabled');
			}
			var span_id = $(this).siblings('span.h-name').attr('id');
			setTimeout(function () {
				if (_jScrollBar_array.indexOf(span_id) === -1) {
					_jScrollBar_array.push(span_id);
					_jScrollBar(span_id);
				}
			}, 100);
		}).on('change',function(){
			var v = $(this).prop('checked');
			var $s = $(this).next('span.checkbox');
			var $u = $(this).parent().children('ul').find('li');
			var $authInput = $(this).siblings('span.authtype').find('input');

			if(v){
				$s.attr('class','checkbox checked');
				$('input.zcheck',$u).prop('checked',true);
				$('span.checkbox:first',$u).attr('class','checkbox checked');
				//$u.find('span.authtype').show();
				$(this).attr("data-loadlast",2);
				$('input.zcheck',$u).attr("data-loadlast",2);	
				$u.each(function(){
					if ($(this).children('span.authtype').find('input').prop('checked')){
							var $u_li = $(this).children('ul').find('li');
							$('input.zcheck',$u_li).prop('disabled',true);
							$('span.checkbox:first',$u_li).addClass('disabled');
					};
				});
			}else{
				$s.attr('class','checkbox');
				$('input',$u).prop('checked',false).prop('disabled',false);
					$('span.checkbox',$u).attr('class','checkbox');
				$(this).attr("data-loadlast",0);
				$('input.zcheck',$u).attr("data-loadlast",0);
				$authInput.prop('checked',false).trigger('change');
				$(this).siblings('span.authtype').find('span').attr('class','checkbox');		
			}
			_checkEvent(this);
		});
	}
	function _checkView1(obj){
		_authTypeTheme($(obj).parent().find('span.authtype input'));
		$(obj).each(function(){
			var $s = $('<span class="checkbox"></span>');
			$(this).after($s);
			var v = $(this).prop('checked');
			if(v){
				$s.addClass('checked');
			}else{
				var c = $(this).data('check');
				if(c && c==2){
					$s.addClass('half');
				}
			}

			var d = $(this).prop('disabled');
			if(d){
				$s.addClass('disabled');
			}
			var span_id = $(this).siblings('span.h-name').attr('id');
			setTimeout(function () {
				if (_jScrollBar_array.indexOf(span_id) === -1) {
					_jScrollBar_array.push(span_id);
					_jScrollBar(span_id);
				}
			}, 100);
		}).on('change',function(){
			var v = $(this).prop('checked');
			var $s = $(this).next('span.checkbox');
			var $u = $(this).parent().children('ul');
			var d;
			if($(this).siblings('span.authtype').find('input').is(':checked')){
				d = 0;
			}else{
				d = 1;
			}
		
			if(v){
				$s.attr('class','checkbox checked');
		  	$('input.zcheck',$u).prop('checked',true);
		  	$('span.checkbox',$u).attr('class','checkbox checked');			
				$(this).attr("data-loadlast","2");	
				$(this).find('input.zcheck').attr('data-loadlast',2);
			}else{
				$s.attr('class','checkbox');
				$('input.zcheck',$u).prop('checked',false).prop('disabled',false);
				$('span.checkbox',$u).attr('class','checkbox');
				$(this).siblings('span.authtype').find('input').prop('checked',false);
				$(this).siblings('span.authtype').find('span').attr('class','checkbox');
				$(this).siblings('span.authtype').find('span').trigger('change');
				//$u.find('span.authtype').find('input').iCheck('uncheck');	
				$(this).attr("data-loadlast","0");
				$(this).siblings('ul').find('input.zcheck').attr('data-loadlast',0);
			}
			// if(d==0){
			// 	$('span.checkbox',$u).addClass('disabled');
			// }

			_checkEvent(this);
		});
	}
	//-----------------------------------------------//

	//加载下拉树
	function _initHTML1(obj, id, v, d) {
		$.ajax({
			url: '/bhost/get_hostdirectory',
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val(), a1: usercode, a2: id, a5:serverId, a6: "1" },
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					var host_data = result.info;
					var total_all = host_data.totalrow;
					
					$(obj).empty();
					$.each(host_data.data.HGroup, function (i, item) {
						var $H = $('<li></li>');
						var d = 1;
						var $auth = '<label><input type="checkbox" name="check' + item.HGId + '">组测试</label>';
						if (server_edit != null) {
							$.each(server_edit.HostList, function (i1, item1) {
								if (item1.HGId == item.HGId && item1.HostId == null) {
									$auth = '<label><input type="checkbox" name="check' + item.HGId + '" checked="checked">组测试</label>';
									d = 0;
									return false;
								}
							});
						}
						if (v == 1 && d == 0) {
							if (item.MemberNum + item.HostNum) {
								$H.html('<i class="h-aicon" data-id="arr-' + item.HGId + '" /><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
							} else {
								$H.html('<i class="h-blank"/><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
							}
							$(obj).append($H);
						} else if (v == 1) {
							if (item.MemberNum + item.HostNum) {
								$H.html('<i class="h-aicon" data-id="arr-' + item.HGId + '" /><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
							} else {
								$H.html('<i class="h-blank"/><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
							}
							$(obj).append($H);
						} else if (v == 0) {
							if (item.MemberNum + item.HostNum) {
								$H.html('<i class="h-aicon" data-id="arr-' + item.HGId + '" /><input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
							} else {
								$H.html('<i class="h-blank"/><input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
							}
							$(obj).append($H);
						} else {
							switch (item.Selected) {
								case 0:
									if (item.MemberNum + item.HostNum) {
										$H.html('<i class="h-aicon" data-id="arr-' + item.HGId + '" /><input type="checkbox" id="HGId-' + item.HGId + '" data-check="' + item.Selected + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
									} else {
										$H.html('<i class="h-blank"/><input type="checkbox" id="HGId-' + item.HGId + '" data-check="' + item.Selected + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
									}
									$(obj).append($H);
									break;
								case 1:
									item.Selected = 2;
									if (item.MemberNum + item.HostNum) {
										$H.html('<i class="h-aicon" data-id="arr-' + item.HGId + '" /><input type="checkbox" id="HGId-' + item.HGId + '" data-check="' + item.Selected + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
									} else {
										$H.html('<i class="h-blank" /><input type="checkbox" id="HGId-' + item.HGId + '" data-check="' + item.Selected + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
									}
									$(obj).append($H);
									$u = $(obj).find('li').find('input[type=checkbox][id=HGId-' + item.HGId + ']').siblings('ul');
									_initHTML1($u, item.HGId, 2, 1);
									break;
								case 2:
									item.Selected = 1;
									if (item.MemberNum + item.HostNum) {
										$H.html('<i class="h-aicon" data-id="arr-' + item.HGId + '" /><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="' + item.Selected + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
									} else {
										$H.html('<i class="h-blank" /><input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="' + item.Selected + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-g"></i><span class="h-name">' + item.HGName + '</span><span class="authtype" style="display:inline-block">' + $auth + '</span><ul style="display:none">Loading...</ul>');
									}
									$(obj).append($H);
									if (d == 1) {
										$u = $(obj).find('li').find('input[type=checkbox][id=HGId-' + item.HGId + ']').siblings('ul');
										_initHTML1($u, item.HGId, 1, 1);
									}
									$(obj).append($H);
									break;
							}
							$(obj).append($H);
						}
					});
					$.each(host_data.data.Host, function (i, item) {
						item.HostName = autoAddEllipsis(item.HostName, 12);
						if (v == 1 && d == 0) {
							$(obj).append('<li><i class="h-blank" /><input type="checkbox" checked="checked" id="HostId-' + item.HostId + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;">' + item.HostName+'('+item.HostIP+')' + '</span></li>');
						} else if (v == 1) {
							$(obj).append('<li><i class="h-blank" /><input type="checkbox" checked="checked" id="HostId-' + item.HostId + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;">' + item.HostName+'('+item.HostIP+')' + '</span></li>');
						} else if (v == 0) {
							$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="HostId-' + item.HostId + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;">' + item.HostName +'('+item.HostIP+')'+ '</span></li>');
						} else {
							if (item.Selected == 2) {
								$H = $('<li><i class="h-blank" /><input type="checkbox"  checked="checked" id="HostId-' + item.HostId + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name">' + item.HostName+'('+item.HostIP+')' + '</span></li>');
							} else {
								var $H = $('<li><i class="h-blank" /><input type="checkbox" id="HostId-' + item.HostId + '" class="zcheck zcheck-g"><i class="h-eicon h-eicon-u"></i><span class="h-name">' + item.HostName+'('+item.HostIP+')' + '</span></li>');
							}
						}
						$(obj).append($H);
					});
				}
			}
		});
		if (d == 0) {
			$(obj).find('input').prop('disabled', true);
		}
		_checkView(obj);
	}
	var filter_flag_append = false;
	//加载下拉树
	var ajax_data = [];
	var MAX_AJAX = 50;
	function _initHTML(obj,id,v,d,uorh){
		
		$(obj).empty();
		if (uorh == "arrHG" || uorh == "arrH"){
			if (uorh == "arrHG"){
				//过滤中 不需要 showloading
				if(filter_flag_append == true) filter_flag_append=false;
				else _showLoading();
				get_hostdirectory1(obj,id,v,d);
				return true;
			}else{
				if(filter_flag_append == true) filter_flag_append=false;
				else _showLoading();
				$.ajax({
					url:'/bhost/get_host_pwd',
					type:'post',
					cache:false,
					async:true,
					data:{a0: $("input[name=se]").val(),z1:id},
					beforeSend :function(xmlHttp){ 
						xmlHttp.setRequestHeader("If-Modified-Since","0"); 
						xmlHttp.setRequestHeader("Cache-Control","no-cache");
					},
					success:function(result){
						var adata = JSON.parse(result);
						////data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
						//data-loadlast(最后保存的状态) 
						//data-ifselect(组或者主机 是否是按组授权或者 按主机授权
						var flag_change = false;
						var _loadfirst = $(obj).siblings('input.zcheck').attr("data-loadfirst");
						var _loadlast = $(obj).siblings('input.zcheck').attr("data-loadlast");
						var parents_aid = $(obj).siblings('input.zcheck').attr('id').split('-');
						var parents_id = parents_aid[2];
						var parentss_id = parents_aid[1];
						//判断 父节点是否状态改变
						var loadfirst = 0;
						var loadlast = 0;
						//////console.log(_loadfirst+"==" +_loadlast);
						if(_loadfirst == _loadlast){
							if (_loadlast == 2){
								loadfirst = 2;
								loadlast = 2;
							}else if (_loadlast == 1){
								flag_change = true;
							}
						}else{
							if (_loadlast == 2){
								loadlast = 2;
							}
							if (_loadfirst == 2){
								loadfirst = 2;
							}
						}
						//////console.log(loadlast);
						$.each(adata.ServiceSet,function(i,item){
							if(item.ProtocolId == null){
								return true;
							}
							$.each(SUP_PROTOCOL,function(i_p,item_p){
								if(item.ProtocolName == item_p){
									var $a='';
									var class_flag = 0;
									$.each(adata.AccountSet,function(i2,item2){
										if(item2.HostAccount.AccountId == null){
											return true;
										}
										$.each(item2.HostServiceSet,function(i1,item1){
											if (item.HostServiceId == item1.HostServiceId){
												class_flag = 1;
												if (loadlast == 2){
													$a = $a + '<li><i class="h-blank" />'+
														'<input type="checkbox" id="nodea-'+parentss_id+'-'+parents_id+'-'+item2.HostAccount.AccountId+'-'+item1.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' checked="checked" data-name="'+item2.HostAccount.AccountName+'">'+
														'<i class="h-eicon h-eicon-a2"></i>'+
														'<span class="h-name h-name2" style="margin-top:-6px;width: 12em;" id="spana-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '">'+
																'<span class="h-name-son" style="">' + 
															item2.HostAccount.AccountName.split('').map(function (params) {
                                                        return '<font>'+params+'</font>'    
                                                    }).join('') + 
															'</span>'+
															'</span>'+
															'</li>'
												}else{
													$a = $a + '<li><i class="h-blank" />'+
														'<input type="checkbox" id="nodea-'+parentss_id+'-'+parents_id+'-'+item2.HostAccount.AccountId+'-'+item1.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+item2.HostAccount.AccountName+'">'+
														'<i class="h-eicon h-eicon-a2"></i>'+
														'<span class="h-name h-name2" style="margin-top:-6px;width: 12em;" id="spana-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '">'+
																'<span class="h-name-son" style="">' + 
															item2.HostAccount.AccountName.split('').map(function (params) {
                                                        return '<font>'+params+'</font>'    
                                                    }).join('') + 
															'</span>'+
															'</span>'+
															'</li>'
												}
												return false;
											}
										})
									});
									if (class_flag == 0){
										A_class = "h-blank";
									}else{
										A_class = "h-aicon";
									}
									if (loadlast == 2){
										$(obj).append('<li><i class="'+A_class+'" data-id="arrS-'+item.HostServiceId+'"/>'+
											'<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' checked="checked" data-name="'+item.HostServiceName+'">'+
											// '<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' checked="checked" data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'">'+
											'<i class="h-eicon h-eicon-s2"></i>'+
											'<span class="h-name h-name2" id="spans-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" style="width: 12em;">'+
																'<span class="h-name-son" style="">' + 
												item.HostServiceName.split('').map(function (params) {
                                                        return '<font>'+params+'</font>'    
                                                    }).join('') + 
												'</span>'+
												'</span>'+
												'<ul style="display:none">'+$a+'</ul></li>');
									}else{
										$(obj).append('<li><i class="'+A_class+'" data-id="arrS-'+item.HostServiceId+'"/>'+
											'<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+item.HostServiceName+'">'+
											// '<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'">'+
											'<i class="h-eicon h-eicon-s2"></i>'+
											'<span class="h-name h-name2">'+
																'<span class="h-name-son" style="">' + 
												item.HostServiceName.split('').map(function (params) {
                                                        return '<font>'+params+'</font>'    
                                                    }).join('') + 
												'</span>'+
												'</span>'+
												'<ul style="display:none">'+$a+'</ul></li>');
									}
								}
							})
						});
						if (flag_change){
							if (planInfo.AccountSet != null && planInfo != "None"){
								var ser_flag = 0;
								var serid_flag = 0;
								var first_serid = 1;
								if (v != 0){
									$.each(planInfo.AccountSet,function(i1,item1){
										if (item1.HostId == parents_id){
											$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('checked',true);				
											$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).next('span').attr("class","checkbox checked");
											$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('data-loadfirst',2);
											$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('data-loadlast',2);
											
											if ($("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).siblings('ul').find('input:checked').length == $("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).siblings('ul').find('input').length){
												$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('checked',true);
												$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).next('span').attr("class","checkbox checked");
												$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadfirst',2);
												$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadlast',2);
											}else{
												$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr("data-check","2");
												$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadfirst',1);
												$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadlast',1);
											}
										}
									})
								}
							}
						}
						
						
						if(d==0){
							$(obj).find('input').prop('disabled',true);
							if ($(obj).siblings('span.authtype').find('input').length > 0){
								if ($(obj).siblings('span.authtype').find('input').next('span').attr('class').indexOf('checked') != -1 || $(obj).siblings('input').prop('disabled')){
									
								}else{
									$(obj).find('input').each(function(){
										$(this).attr('disabled',false);
										$(this).next('span.checkbox').removeClass('disabled');
									});
								}
							}
						}
						_checkView_host(obj);
						_closeLoading();	
					},
					error:function(XmlHttpRequest,textStatus, errorThrown){
					}
				});
			}
				
		}else if(uorh == "arru"){
			get_userdirectory(id,editid);
			$(obj).empty();
			$.each(udata.data.UGroup,function(i,item){
				var $H = $('<li></li>');
				var $auth =  '<label><input type="checkbox" name="check'+item.UGId+'">组授权</label>';
				$.each(planInfo.AccountSet,function(i1,item1){
					if (item1.Id == item.UGId && item1.Type == 2){
						$auth = '<label><input type="checkbox" name="check'+item.UGId+'" checked="checked">组授权</label>';
					}
				})
				if (v == 1 && d == 0){
					if (item.MemberNum == 0 && item.UserNum == 0){
						$H.html('<i class="h-blank" data-id="arru-'+item.UGId+'" /><input type="checkbox" checked="checked" id="nodeug-'+item.UGId+'" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}else{
						$H.html('<i class="h-aicon" data-id="arru-'+item.UGId+'" /><input type="checkbox" checked="checked" id="nodeug-'+item.UGId+'" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}
				}else if (v == 1){
					if (item.MemberNum == 0 && item.UserNum == 0){
						$H.html('<i class="h-blank" data-id="arru-'+item.UGId+'" /><input type="checkbox" checked="checked" id="nodeug-'+item.UGId+'" data-check="2" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}else{
						$H.html('<i class="h-aicon" data-id="arru-'+item.UGId+'" /><input type="checkbox" checked="checked" id="nodeug-'+item.UGId+'" data-check="2" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}
				}else if (v == 0){
					if (item.MemberNum == 0 && item.UserNum == 0){
						$H.html('<i class="h-blank" data-id="arru-'+item.UGId+'" /><input type="checkbox" id="nodeug-'+item.UGId+'" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" >'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}else{
						$H.html('<i class="h-aicon" data-id="arru-'+item.UGId+'" /><input type="checkbox" id="nodeug-'+item.UGId+'" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" >'+$auth+'</span><ul style="display:none">Loading...</ul>');
					}
				}else{
					if (item.Selected == 0){
						if (item.MemberNum == 0 && item.UserNum == 0){
							$H.html('<i class="h-blank" data-id="arru-'+item.UGId+'" /><input type="checkbox" id="nodeug-'+item.UGId+'" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						}else{
							$H.html('<i class="h-aicon" data-id="arru-'+item.UGId+'" /><input type="checkbox" id="nodeug-'+item.UGId+'" data-check="0" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						}
					}else if(item.Selected == 1){
						if (item.MemberNum == 0 && item.UserNum == 0){
							$H.html('<i class="h-blank" data-id="arru-'+item.UGId+'" /><input type="checkbox" id="nodeug-'+item.UGId+'" data-check="2" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						}else{
							$H.html('<i class="h-aicon" data-id="arru-'+item.UGId+'" /><input type="checkbox" id="nodeug-'+item.UGId+'" data-check="2" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						}
					}else{
						if (item.MemberNum == 0 && item.UserNum == 0){
							$H.html('<i class="h-blank" data-id="arru-'+item.UGId+'" /><input type="checkbox" checked="checked" id="nodeug-'+item.UGId+'" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						}else{
							$H.html('<i class="h-aicon" data-id="arru-'+item.UGId+'" /><input type="checkbox" checked="checked" id="nodeug-'+item.UGId+'" data-check="1" class="zcheck zcheck-g"><i class="h-eicon h-eicon-s"></i><span class="h-name">'+item.UGName+'</span><span class="authtype" style="display:inline-block">'+$auth+'</span><ul style="display:none">Loading...</ul>');
						}
					}		
				}
				$(obj).append($H);
			});
			$.each(udata.data.User,function(i,item){
				if (v == 1 && d == 0){
					$(obj).append('<li><i class="h-blank" /><input type="checkbox" checked="checked" id="nodeu-'+item.UserId+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-r"></i><span class="h-name">'+item.UserCode+'</span></li>');
				}else if (v == 1){
					$(obj).append('<li><i class="h-blank" /><input type="checkbox" checked="checked" id="nodeu-'+item.UserId+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-r"></i><span class="h-name">'+item.UserCode+'</span></li>');
				}else if (v == 0){
					$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="nodeu-'+item.UserId+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-r"></i><span class="h-name">'+item.UserCode+'</span></li>');
				}else{
					if (item.Selected == 0){
						$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="nodeu-'+item.UserId+'" class="zcheck zcheck-g"><i class="h-eicon h-eicon-r"></i><span class="h-name">'+item.UserCode+'</li>');
					}else{
						$(obj).append('<li><i class="h-blank" /><input type="checkbox" id="nodeu-'+item.UserId+'" class="zcheck zcheck-g" checked="checked"><i class="h-eicon h-eicon-r"></i><span class="h-name">'+item.UserCode+'</li>');
					}
				}
			});
			if(d==0){
				$(obj).find('input').prop('disabled',true);
			}
			_checkView_user(obj);
		}else{
			;
		}
	}
	//回显下拉树
	function _viewHTML(data,obj,type){
		$(obj).empty();
		if (type == 0){	
			disabled_flag = "";
			if(editid > 0 ) disabled_flag = "disabled";
			$.each(data.data.HGroup,function(i,item){
				if(item.Mode == 2) var $auth = '<label><input type="checkbox" name="check'+item.HGId+'" data-ifselect=false '+disabled_flag+' data-mode="'+item.Mode+' " >组测试</label>';
				else var $auth = '<label style="display:none;"><input type="checkbox" name="check'+item.HGId+'" data-ifselect=false '+disabled_flag+' data-mode="'+item.Mode+'">组测试</label>';
				if (item.HGId == 1){
					$auth = '';
				}
				var $H = $('<li></li>');
				//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
				//data-loadlast(最后保存的状态) 
				//data-ifselect(组或者主机 是否是按组测试或者 按主机测试)
				if((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
				else i_class = "h-aicon";
				$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" />'+
				'<input type="checkbox" id="nodehg-'+item.HGId+'" data-check="0" class="zcheck zcheck-g" '+disabled_flag+' data-loadfirst=0 data-loadlast=0 data-ifselect=false data-mode="2" data-name="'+item.HGName+'">'+
				'<i class="h-eicon h-eicon-g" ></i>'+
				'<span class="h-name" title="'+item.HGName+'" id="spanHG-' + item.HGId + '" style="width: 12em;">'+
					'<span class="h-name-son" style="">' + 
					item.HGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
					'</span>'+
					'<span class="authtype" style="display:inline-block">'+$auth+'</span>'+
					'<ul style="display:none">Loading...</ul>');
				$(obj).append($H);
			});	
			_checkView_host(obj);
			if(editid > 0 ){
				var _ajax_find_host_doing=ajax_find_host_doing;
				select_checkbox("HGroup",0,_ajax_find_host_doing);			//只有编辑情况下 才需要判断 select 
			}	
		}
	}
	//选中回显
	function _checkView(obj){
		_authTypeTheme($('span.authtype input',obj));

		$('input.zcheck',obj).each(function(){
			var $s = $('<span class="checkbox"></span>');
			$(this).after($s);
			var v = $(this).prop('checked');
			if(v){
				$s.addClass('checked');
			}else{
				var c = $(this).data('check');
				if(c && c==2){
					$s.addClass('half');
				}
			}

			var d = $(this).prop('disabled');
			if(d){
				$s.addClass('disabled');
			}
			var span_id = $(this).siblings('span.h-name').attr('id');
			setTimeout(function () {
				if (_jScrollBar_array.indexOf(span_id) === -1) {
					_jScrollBar_array.push(span_id);
					_jScrollBar(span_id);
				}
			}, 100);
		}).on('change',function(){
			var v = $(this).prop('checked');
			var $s = $(this).next('span.checkbox');
			var $u = $(this).parent().children('ul').find('li');
			var $authInput = $(this).siblings('span.authtype').find('input');

			if(v){
				$s.attr('class','checkbox checked');
		  	$('input.zcheck',$u).prop('checked',true);
		  	$('span.checkbox:first',$u).attr('class','checkbox checked');
		  	//$u.find('span.authtype').show();
			$(this).attr("data-loadlast",2);
			$('input.zcheck',$u).attr("data-loadlast",2);			
			}else{
				$s.attr('class','checkbox');
		  	$('input.zcheck',$u).prop('checked',false);
		  	$('span.checkbox:first',$u).attr('class','checkbox');
		  	//$u.find('span.authtype').hide();	
			$(this).attr("data-loadlast",0);
			$('input.zcheck',$u).attr("data-loadlast",0);
			
			$authInput.prop('checked',false).trigger('change');
			$(this).siblings('span.authtype').find('span').attr('class','checkbox');			
			}
			_checkEvent(this);
		});
	}
	//选中后树的input check变化
	function _checkEvent(obj){
		var _run = function(){
			var $li = $(obj).parent().parent().parent();
			var tagname = $li[0].tagName.toLowerCase();
			var v = $(obj).prop('checked');
			if(tagname == 'li'){
				var c1=0,c2=0;
				var len = $(obj).parent().parent().children('li').length;
				$(obj).parent().parent().children('li').each(function(){
					var c = $(this).children('span.checkbox').attr('class');
					if(c.indexOf('checked')>0){
						c1++;
					}else if(c.indexOf('half')>0){
						c2++;
					}
					if(c1 == len){
						var span_class = $li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class');
						//////console.log("span_class:"+span_class);
						var d_class = "";
						if (span_class.indexOf('disabled') != -1){
							d_class = 'disabled';
						}
						var attr_class = 'checkbox checked ' + d_class;
						$li.children('input.zcheck').prop('checked',true).siblings('span.checkbox').attr('class',attr_class);
						$li.children('input.zcheck').attr("data-loadlast",2);
					}else if(c1==0 && c2==0){
						$li.children('input.zcheck').prop('checked',false).prop('disabled',false).siblings('span.checkbox').attr('class','checkbox').removeClass('disabled');
						$li.children('input.zcheck').attr("data-loadlast",0);
						$li.children('input.zcheck').siblings('span.authtype').children('input').prop('checked',false).siblings('span.checkbox').attr('class','checkbox');
					}else{
						var span_class = $li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class');
						var d_class = "";
						if (span_class.indexOf('disabled') != -1){
							d_class = 'disabled';
						}
						var attr_class = 'checkbox half ' + d_class;
						$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class',attr_class);
						$li.children('input.zcheck').attr("data-loadlast",1);
					}
				});
				_checkEvent($li.children('input.zcheck'));
			}else{
				return;
			}
		}
		_run();
	}
	function _checkEvent1(obj){
		if($(obj).length == 0) return false;
		var _run1 = function(){
			_input = $(obj).parent().parent().siblings('input.zcheck');
			//////console.log(obj)
			_ul = _input.siblings('ul');
			if(_input.length>0 && (_ul.children('li').length >0)){
				$inp = _ul.children('li').children('input.zcheck');
				$($inp).each(function(i,item){	
					$parent = $(item).parent().parent().siblings('span.authtype').find('input');
					v = $($parent).prop("checked");
					$spanp = $(item).siblings('span.authtype');
					//如果发现父节点还是disabled
					if($($parent).prop("disabled") == true) v = true;
					//////console.log($(item));
					//////console.log(v);
					if(v == false){
						$(item).prop("disabled",false);
						$(item).siblings('span.checkbox').removeClass("disabled");
						$spanp.find('input').prop("disabled",false);
						$spanp.find('span').removeClass("disabled");
						if($spanp.length == 0) {
							_checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
						}
						else {
							if($(item).prop('checked') == false) $spanp.find('input').prop('checked',false).next('span').removeClass('checked');
							_checkEvent1($spanp.find('input'));
						}
					}else{
						$(item).prop("checked",true).prop("disabled",true);
						$(item).siblings('span.checkbox').addClass("disabled");
						$spanp.find('input').prop("disabled",true);
						$spanp.find('span').addClass("disabled");
						if($spanp.length == 0) _checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
						else _checkEvent1($spanp.find('input'));
						
					}
				})
					
				
			}else{
				
				return;
			}	
		}

		_run1();
	}
	function _checkEvent2(obj){
		if(obj.length == 0) return false;
		var _run2 = function(){
			_input = $(obj).parent().parent().siblings('input.zcheck');;
			if($(_input).prop('disabled') == true){
				$(obj).prop("checked",true).prop("disabled",true);
				$(obj).siblings('span.checkbox').addClass("disabled");
			}else{
				$(obj).prop("disabled",false);
				$(obj).siblings('span.checkbox').removeClass("disabled");
			}
			_checkEvent2($(obj).siblings('ul').children('li').children('input.zcheck'));
		}

		_run2();
	}
	var find_host_arry=[];
	var find_host_flag = 0;
	function _addFilter(obj,type){
		if(find_host_group_loading){
			_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
			return false;
		}
		top1 = 9007199254740991;
		var id = $(obj).parent().children('select').children('option:selected').val();
		var v1 = $(obj).parent().children('select').children('option:selected').text();		
		var v2 = $(obj).parent().children('input[type=text]').val().trim();
		var filter_flag = 0;
		if(id=='0'){
			v1='';
		}else{
			v1=v1+'-';
		}
		if(v2 == ''){
			if(find_host_arry.length >0){
				$("#server_text1").blur();
				_alert(2,"搜索","请输入关键字",$("#server_text1"));
				return false;
			}
			click_h1();
			find_host_arry = [];
			search_typeall_r=[];
			search_typeall_new='';
			return false;
		}else{
			switch (id) {
				case 'hostname':
				case 'hgname':
				case 'hostname':
				case 'hostservicename':
					var Reg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.\s]+$/;
					break;
				case 'accountname':
					var Reg = /^[a-zA-Z\d_\-\.\s]+$/;
					break;
				case 'ip':
					var Reg = /^[0-9\.\s]+$/;
					break;
			}
			if (id!='0' && !Reg.test(v2) ) {
				$(obj).parent().children('input[type=text]').blur();
				_alert(1, '搜索', '关键字格式不正确', $(obj).parent().children('input[type=text]'));
				return false;
			}
			if ($.inArray(id + '-' + v2,search_typeall_r) >= 0) {
				$(obj).parent().children('input[type=text]').blur();
				_alert(2, '搜索', '相同的关键字已存在', $(obj).parent().children('input[type=text]'));
				return false;
			}
			if (type){
				$("#filterWW2").children('ul').children('li').each(function(i,item){
					if ($(this).children('span').text() == v2){
						filter_flag = 1;
						return false;
					}
				});
				$("#server_text").val("");
				$('#server_text_check').hide();
				if (filter_flag == 0){
					if (find_host_flag == 1){
						// find_host_arry.splice(-1,1);
						find_host_flag = 0;
					}
					// find_host_arry.push(v2);
					var type_value=false;
					if(search_typeall_r.length>0){
						type_value=(search_typeall_r[search_typeall_r.length-1]==(id + '-' + v2));
					}
					search_typeall_r.push(id + '-' + v2);
					$('#filterWW2>ul').append('<li style="height: 18px;"><span style = "display:none;">'+id+'-' + v2 + '</span><span class="ww"  style="width:120px;" title="' + v1+v2 + '">' + v1+v2 + '</span><i class="del" style="margin-top: -20px;" onclick="_delFilter(this);"></i></li>')
					search_typeall_new = '';
					// $('#filterWW2>ul').append('<li style="height: 18px;"><span class="ww" style="width:9em">'+v2+'</span><i class="del" style="margin-top: -17px;" onclick="_delFilter(this)"></i></li>')
					selView(type_value);
				}
				
			}else{
				if (find_host_flag != 0){
					// find_host_arry.splice(-1,1);
				}
				find_host_flag = 1;
				if(search_typeall_new ==id + '-'+ v2){
					return false;
				}
				// find_host_arry.push(v2);
				search_typeall_new =id + '-'+ v2;
				selView();
			}
		}	
	}
	function _clearFilter(obj,num){
		if(find_host_group_loading){
			_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
			return false;
		}
		if(num==1){
			top1 = 9007199254740991;
			$("#server_text").val('');
			$('#server_text_check').hide();
			search_typeall_new = '';
			selView();
			return;
		}
		top1 = 9007199254740991;
		$("#filterWW2").children('ul').empty();
		$("#filterWW2").hide();
		$("#clearFilter2").hide();
		$("#server_text").val('');
		$('#server_text_check').hide();
		find_host_arry=[];
		search_typeall_r=[];
		search_typeall_new = '';
		selView();
	}

	function _delFilter(obj){
		if(find_host_group_loading){
			_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
			return false;
		}
		top1 = 9007199254740991;
		var v = $(obj).parent().children('span').eq(0).text();
		find_host_arry.splice($.inArray(v,find_host_arry),1);
		search_typeall_r.splice($.inArray(v,search_typeall_r),1);
		$(obj).parent().remove();
		selView();
	}

	function selView(type_value){
		var $sel = $('#filterWW2');
		var len = $('li',$sel).length;

		if(len == 0){
			$sel.hide();
			$("#clearFilter2").hide();
		}else if(len == 1){
			$("#filterWW2").show();
			$("#clearFilter2").show();
			$('>span.ww',$sel).show();
			$sel.addClass('selector-multiple');
		}else{
			$("#filterWW2").show();
			$("#clearFilter2").show();
			$('>span.ww',$sel).show();
			$sel.addClass('selector-multiple');
		}
		if(!type_value)find_host_group();
	}

	function _getWait(obj){
		if(typeof waitDonelayer != 'undefined'){
			layer.close(waitDonelayer);
		}
		
		$(obj).removeClass('done').show().unbind().on('mouseover',function(){
			waitlayer = layer.tips('搜索中',this,{
				tips:1,
				time:0,
				skin: 'waitlayer'
			});
		}).on('mouseout',function(){
			if(typeof waitlayer != 'undefined'){
				layer.close(waitlayer);
			}
		});

		// //完成
		// setTimeout(function(){
		// 	_waitDone();
		// },3000)
	}
	function _waitDone(obj){
		if(typeof waitlayer != 'undefined'){
			layer.close(waitlayer);
		}
		$(obj).fadeOut(3000);
		if(typeof waitDonelayer != 'undefined'){
			layer.close(waitDonelayer);
		}
	}
	var find_host_group_loading=false;
	function find_host_group(){
		find_host_group_loading=true;
		_getWait($(".waitTip"));
		find_host_arry=JSON.parse(JSON.stringify(search_typeall_r));
		if(search_typeall_new!=''){
			find_host_arry.push(search_typeall_new);
		}
		_getWait($(".waitTip"));
		//先清空之前的过滤信息
		click_h1();
	}

	var mtr = null;
	var flag_ajax_true = false;
	String.prototype.ResetBlank=function(){
		var regEx = /\s+/g; 
		return this.replace(regEx, ' '); 
	};
	function click_h0(){
		//////console.log("h0");
		if(mtr!=null){
			mtr.abort();
			mtr=null;
		}
		flag_ajax_true = true;
		//条件没有的情况 直接返回
		if (JSON.stringify(find_host_arry) == "[]"){
			_waitDone($(".waitTip"));
			$('.c-cont').scrollTop(0);
			tmp_list=null;
			first_find_index=null;
			$('#hostTree').find('li').show();
			$("#hostTree").find('i.h-aicon.h-aicon-d').trigger('click');
			$('#hostTree').find('.font-red').removeClass('font-red');
			$("#hostTree").find('span.h-name-red').removeClass('h-name-red');
			find_host_group_loading=false;
			return false;
		}
		var a=new Array();
		$.each(find_host_arry,function (i,item) {
			var index_a=item.indexOf('-');
			switch (item.substring(0,index_a)) {
				case '0':
					a.push(('所有-'+item.substring(index_a+1)).ResetBlank());
					break;
				case 'hgname':
					a.push(('组名-'+item.substring(index_a+1)).ResetBlank());
					break;
				case 'hostname':
					a.push(('主机名-'+item.substring(index_a+1)).ResetBlank());
					break;
				case 'ip':
					a.push(('IP-'+item.substring(index_a+1)).ResetBlank());
					break;
				case 'hostservicename':
					a.push(('服务-'+item.substring(index_a+1)).ResetBlank());
					break;
				case 'accountname':
					a.push(('账号-'+item.substring(index_a+1)).ResetBlank());
					break;
			}
		});
		_getWait($(".waitTip"));
		mtr = $.ajax({
			url: '/bhost/PFindHostDirectory_z',
			type: "POST",
			async: true,
			data: {a0: $("input[name=se]").val(),z1:JSON.stringify(a),z2:8,z3:editid},
			success: function(result){
				_getWait($(".waitTip"));
				mtr=null;
				tmp_list=null;
				flag_ajax_true = false;
				$('#hostTree').find('li').show();
				$('#hostTree').children('li').hide();
				if (result == "None"){
					$("#server_text1").blur();
					_alert(0,'搜索','无搜索结果',$("#server_text1"));
					_waitDone($(".waitTip"));
					find_host_group_loading=false;
					return false;
				}
				tmp_list = JSON.parse(result);
				ajax_find_host_doing=true;
				//把 过滤信息放入 host_path_all 全局变量
				if (tmp_list.length != 0){
					host_path_all=JSON.parse(JSON.stringify(tmp_list));
					flag_ajax_true = false;
					//开始过滤
					find_append();
				}else{
					ajax_find_host_doing=false;
					$("#server_text1").blur();
					_alert(0,'搜索','无搜索结果',$("#server_text1"));
					_waitDone($(".waitTip"));
					find_host_group_loading=false;
				}
			}
		});
	}

	function click_h1(){
		//清空数据
		var i = 0;
		index = 0;
		flag_ajax_true = true;
		$("#hostTree").find('i.h-aicon.h-aicon-d').trigger('click');
		$('#hostTree').find('.font-red').removeClass('font-red');
		$("#hostTree").find('span.h-name-red').removeClass('h-name-red');
		host_path_all = [];
		old_path_all = [];
		push_filter_wait = [];
		click_h0();
	}
	var t_li_hide_while_no_red;
	function li_hide_while_no_red(obj,num){
		var li_visible=$(obj).children('li');
		for(var i=num;i<num+100;i++){
			if(i>=li_visible.length){
				break;
			}
			var item=li_visible.eq(i);
			var span_red_time=$(item).find('span.h-name-red').length;
			if(span_red_time==0){
				$(item).hide();
				$(item).find('font.font-red').removeClass('font-red');
			}else if(span_red_time>0){
				$(item).show();
				var children_red_time=$(item).children('span.h-name-red').length;
				if(children_red_time>0 && span_red_time==1){
					$(item).children('i.h-aicon-d').removeClass('h-aicon-d');
					$(item).children('ul').hide();
				}
				else if(children_red_time>0 && span_red_time>1){
					$(item).find('li').show();
				}
				else if (children_red_time==0) {
					var $children_ul=$(item).children('ul');
					li_hide_while_no_red($children_ul,0);
				}
			}
		}
		if(i<li_visible.length){
			setTimeout(function () {li_hide_while_no_red(obj,i);},1);
		}
	}
	function li_red_to_no_red(obj){
		var red_input=$(obj).find('span.h-name-red');
		for(var im=0;im<red_input.length;im++){
			var item=red_input.eq(im);
			var Type=item.siblings('input').attr('id');
			var pass=true;
			var item_name=item.siblings('input').attr('data-name');
			var $span_son_font=$('.h-name-son',item).find('font');
			if(Type.indexOf('nodeh')<0){
				var span_son_name=item_name.toLowerCase();
			}else{
				var host_span_arr=item_name.split('\t');
				var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
			}
			for(var jm=0;jm<find_host_arry.length;jm++){
				if (find_host_arry[jm] == '' || find_host_arry[jm] == undefined || find_host_arry[jm] == null) {
					continue;
				}
				var pass_one=false;
				// var search_arr=find_host_arry[jm].split(' ');
				var jm_index_=find_host_arry[jm].indexOf('-');
				var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
				$.each(search_arr,function(i1,item1){
					if(find_host_arry[jm].substr(0,jm_index_)=='hostname'){
						var Name=item_name.split('\t')[0];
						if (Type.indexOf('nodeh')<0){
							return false;
						}
					}else if(find_host_arry[jm].substr(0,jm_index_)=='ip'){
						var Name=item_name.split('\t')[1];
						if (Type.indexOf('nodeh')<0){
							return false;
						}
					}else if(find_host_arry[jm].substr(0,jm_index_)=='hgname'){
						var Name=item_name;
						if (Type.indexOf('nodehg')<0){
							return false;
						}
					}else if(find_host_arry[jm].substr(0,jm_index_)=='hostservicename'){
						var Name=item_name.split('\t')[0];
						if (Type.indexOf('nodes')<0){
							return false;
						}
					}else if(find_host_arry[jm].substr(0,jm_index_)=='accountname'){
						var Name=item_name;
						if (Type.indexOf('nodea')<0){
							return false;
						}
					}else{
						var Name=item_name;
					}
					if(coverString(item1,Name)){
						item1=item1.toLowerCase();
						if(find_host_arry[jm].substr(0, jm_index_) == 'IP'){
							var index_start=span_son_name.indexOf('(');
							var index_true=span_son_name.indexOf(item1,index_start);
							if(index_true>=0){
								for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
									$span_son_font.eq(i_red_span).addClass('font-red');
								}
							}
						}else{
							var index_true=span_son_name.indexOf(item1);
							if(index_true>=0){
								for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
									$span_son_font.eq(i_red_span).addClass('font-red');
								}
							}
						}
						pass_one=true;
						return false;
					}
				});
				if(pass_one==false){
					pass=false;
				}
			}
			if(pass==false){
				item.removeClass('h-name-red');
				$span_son_font.removeClass('font-red');
			}else{
			}
		}
	}

	var push_filter_wait = [];
	var top1=9007199254740991;
	function scrollTop_check_server1(){
		var i = 0;
		var index_i = 0;
		//if(find_host_arry.length>1){
			// li_red_to_no_red($('#hostTree'));
			//////console.log('li_hide_while_no_red');
			li_hide_while_no_red($('#hostTree'),0);
			//////console.log('end');
		//}
		if($('#hostTree').find('span.h-name-red').length==0){
			$("#server_text1").blur();
			_alert(0,'搜索','无搜索结果',$("#server_text1"));
			_waitDone($(".waitTip"));
			flag_ajax_true = true;
			ajax_find_host_doing=false;
			find_host_group_loading=false;
			return false;
		}
		$('.c-cont').scrollTop($('#hostTree').find('span.h-name-red').eq(0).offset().top-200);
		ajax_find_host_doing=false;
		flag_ajax_true = true;
		_waitDone($(".waitTip"));
		old_path_all=new Array();
		find_host_group_loading=false;
	}

	function AscSort(a,b){
		a = parseInt(a.split(':')[1]);
		b = parseInt(b.split(':')[1]);
		return a - b;
	}

	function ajax_host(){
		ajax_flag = true;
		if(ajax_data.length == 0) return ;

		$.ajax({
			url:'/bhost/get_hosts',
			type:'post',
			cache:false,
			async:true,
			data:{a0: $("input[name=se]").val(),z1:ajax_data.join(",")},
			beforeSend :function(xmlHttp){ 
				xmlHttp.setRequestHeader("If-Modified-Since","0"); 
				xmlHttp.setRequestHeader("Cache-Control","no-cache");
			 },
			success:function(result){

				if(ajax_data.length == 0) return ;
				results = JSON.parse(result);
				//ajax_data 排序
				ajax_data.sort(AscSort);
				$(results.info).each(function(i,item){
					var adata = item;
					var hgid = ajax_data[i].split(':')[0];
					//改变样式
					$('#nodeh-'+hgid+'-'+adata.HostId).prev('i').addClass('h-aicon-d');
					obj = $('#nodeh-'+hgid+'-'+adata.HostId).siblings('ul');
					$(obj).empty().show();
					var v = 2,d;
	    			var $input = $('#nodeh-'+hgid+'-'+adata.HostId).siblings('span.checkbox');
					if($input.length  ==0) return true;
	    			if($('#nodeh-'+hgid+'-'+adata.HostId).siblings('span.authtype').find('input').is(':checked')){
	    				d = 0;
	    			}else{
						d = 1;
					}
					if ($input.attr('class').indexOf('disabled')>0){
						d = 0;
					}
			    	var c = $input.attr('class');
			    	if(c.indexOf('checked')>0){
			    		v=1;
			    	}else if(c == 'checkbox'){
			    		v=0;
			    	}
					var flag_change = false;
					var _loadfirst = $(obj).siblings('input.zcheck').attr("data-loadfirst");
					var _loadlast = $(obj).siblings('input.zcheck').attr("data-loadlast");
					var parents_aid = $(obj).siblings('input.zcheck').attr('id').split('-');
					var parents_id = parents_aid[2];
					var parentss_id = parents_aid[1];
					//判断 父节点是否状态改变
					var loadfirst = 0;
					var loadlast = 0;
					if(_loadfirst == _loadlast){
						if (_loadlast == 2){
							loadfirst = 2;
							loadlast = 2;
						}else if (_loadlast == 1){
							flag_change = true;
						}
					}else{
						if (_loadlast == 2){
							loadlast = 2;
						}
						if (_loadfirst == 2){
							loadfirst = 2;
						}
					}

					$.each(adata.ServiceSet,function(i,item){
						var $a='';
						var class_flag = 0;
						if(ajax_find_host_doing==true && $(obj).siblings('span.h-name-red').length==0){
							var li_class_item = 'style="display: none;"';
						}else{
							var li_class_item = '';
						}
						$.each(adata.AccountSet,function(i2,item2){
							$.each(item2.HostServiceSet,function(i1,item1){
								if (item.HostServiceId == item1.HostServiceId){
									class_flag = 1;
									if (loadlast == 2){
										$a = $a + '<li '+li_class_item+'>'+
											'<i class="h-blank" />'+
											'<input type="checkbox" id="nodea-'+parentss_id+'-'+parents_id+'-'+item2.HostAccount.AccountId+'-'+item1.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' checked="checked" data-name="'+item2.HostAccount.AccountName+'">'+
											'<i class="h-eicon h-eicon-a2"></i>'+
											'<span class="h-name h-name2" style="margin-top:-6px;width: 12em;" id="spana-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '">'+
													'<span class="h-name-son" style="">' + 
												item2.HostAccount.AccountName.split('').map(function (params) {
                                                    return '<font>'+params+'</font>'    
                                                }).join('') + 
												'</span>'+
												'</span>'+
												'</li>'
									}else{
										$a = $a + '<li '+li_class_item+'><i class="h-blank" />'+
											'<input type="checkbox" id="nodea-'+parentss_id+'-'+parents_id+'-'+item2.HostAccount.AccountId+'-'+item1.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+item2.HostAccount.AccountName+'">'+
											'<i class="h-eicon h-eicon-a2"></i>'+
											'<span class="h-name h-name2" style="margin-top:-6px;width: 12em;" id="spana-' + parentss_id + '-' + parents_id + '-' + item2.HostAccount.AccountId + '-' + item1.HostServiceId + '">'+
													'<span class="h-name-son" style="">' + 
												item2.HostAccount.AccountName.split('').map(function (params) {
                                                    return '<font>'+params+'</font>'    
                                                }).join('') + 
												'</span>'+
												'</span>'+
												'</li>'
									}
									
									return false;
								}
							})
						});
						if (class_flag == 0){
							A_class = "h-blank";
						}else{
							A_class = "h-aicon";
						}
						if (loadlast == 2){
							$(obj).append('<li '+li_class_item+'>'+
								'<i class="'+A_class+'" data-id="arrS-'+item.HostServiceId+'"/>'+
								'<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' checked="checked" data-name="'+item.HostServiceName+'">'+
								// '<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' checked="checked" data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'">'+
								'<i class="h-eicon h-eicon-s2"></i>'+
								'<span class="h-name h-name2" id="spans-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" style="width: 12em;">'+
													'<span class="h-name-son" style="">' + 
									item.HostServiceName.split('').map(function (params) {
                                                    return '<font>'+params+'</font>'    
                                                }).join('') + 
									'</span>'+
									'</span>'+
									'<ul style="display:none">'+$a+'</ul></li>');
							
						}else{
							$(obj).append('<li '+li_class_item+'>'+
								'<i class="'+A_class+'" data-id="arrS-'+item.HostServiceId+'"/>'+
								'<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+item.HostServiceName+'">'+
								// '<input type="checkbox" id="nodes-'+parentss_id+'-'+parents_id+'-'+item.HostServiceId+'" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-name="'+item.HostServiceName+'\t'+item.ProtocolName+'">'+
								'<i class="h-eicon h-eicon-s2"></i>'+
								'<span class="h-name h-name2" id="spans-' + parentss_id + '-' + parents_id + '-' + item.HostServiceId + '" style="width: 12em;">'+
													'<span class="h-name-son" style="">' + 
									item.HostServiceName.split('').map(function (params) {
                                                    return '<font>'+params+'</font>'    
                                                }).join('') + 
									'</span>'+
									'</span>'+
									'<ul style="display:none">'+$a+'</ul></li>');
							
						}
					});

					if (flag_change){
						if (WorkOrder.AuthObject != null && edit != "None"){
							var ser_flag = 0;
							var serid_flag = 0;
							var first_serid = 1;
							if (v != 0){
								$.each(WorkOrder.AuthObject,function(i1,item1){
									if (item1.HGId == parentss_id && item1.HostId == parents_id){
										$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('checked',true);				
										$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).next('span').attr("class","checkbox checked");
										$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('data-loadfirst',2);
										$("#nodea-"+parentss_id+'-'+parents_id+'-'+item1.AccountId+'-'+item1.HostServiceId).attr('data-loadlast',2);
										
										if ($("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).siblings('ul').find('input:checked').length == $("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).siblings('ul').find('input').length){
											$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('checked',true);
											$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).next('span').attr("class","checkbox checked");
							   				$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadfirst',2);
											$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadlast',2);
										}else{
											$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr("data-check","2");
											$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadfirst',1);
											$("#nodes-"+parentss_id+'-'+parents_id+'-'+item1.HostServiceId).attr('data-loadlast',1);
										}
										return false;
									}
								})
							}
						}
					}
					
					
					if(d==0){
						$(obj).find('input').prop('disabled',true);
						if ($(obj).siblings('span.authtype').find('input').length > 0){
							if ($(obj).siblings('span.authtype').find('input').next('span').attr('class').indexOf('checked') != -1 || $(obj).siblings('input').prop('disabled')){
								
							}else{
								$(obj).find('input').each(function(){
									$(this).attr('disabled',false);
									$(this).next('span.checkbox').removeClass('disabled');
								});
							}
						}
					}
					_checkView_host(obj);
				});
				get_msg();
				//50个结束 继续调用 过滤信息
				if(host_path_all.length == 0){
					scrollTop_check_server1();
				}else{
				}
				ajax_flag = false;
				ajax_data = [];		
				return true;
			}
		})
	}

	function renderCheckBox() {
		$('.form-checkbox,.form-radio,.ss input').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
	}

	function back(num,id) {
		if(num==1){
			$.ajax({
				url: '/bhost/PGetRecordRownum',
				type: "POST",
				async: false,
				data: { a0: $("input[name=se]").val(), a1: id,a2:8 },
				success: function (result) {
					var result = JSON.parse(result);
					if (result.Result == true) {
						if(result.info%MAX_PAGE==0){
							document.pageForm.c.value=parseInt(result.info/MAX_PAGE);
						}else{
							document.pageForm.c.value=parseInt(result.info/MAX_PAGE)+1;
						}
					}
				}
			});
			document.pageForm.d.value = '';
			document.pageForm.e.value = ':';
		}
		document.pageForm.tasktype.value = 3;
		document.pageForm.action = '/bhost/host_test_trust';
		document.pageForm.submit();
	}

	function savedata() {
		if(planInfo.BatchConnectPlanId == 0){
			//检查计划名，如果计划名合法，则
			if (planName_check() == false) {
				return false;
			}
		}

		//////console.log(push_hgid.length+" && "+push_hid.length);
		if (($("#hostTree").find('span.checkbox.half,span.checkbox.checked').length == 0) && ( push_hgid.length == 0 && push_hid.length== 0)){
			//////console.log("first");
			//////console.log(push_hgid.length+" && "+push_hid.length);
			_alert(2,"连接测试","请选择主机");
			return false;
		}
		//根据planId的值生成相应的计划信息数据
		//		planInfo.BatchConnectPlanId = parseInt($("#planId").val());
		planInfo.BatchConnectPlanName = $("#HostName").val();
		planInfo.Execution = $("#Execution").prop('checked');
		planInfo.LoginUserCode = window.parent.document.frm.us.value;
		if($("#Execution").prop('checked')){
			planInfo.StartTime = null;
			planInfo.PeriodType = null;
			planInfo.PeriodValue = null;
		}else{
			planInfo.StartTime = createTimeStr();
			//用当前时间给年、月、日文本框赋值
			var date = new Date();		//获取当前时间
			var year = date.getFullYear();
			var month = ("0" + (date.getMonth() + 1)).slice(-2);
			var day = ("0" + date.getDate()).slice(-2);
			var hour = ("0" + (date.getHours())).slice(-2);
			var second = ("0" + (date.getSeconds())).slice(-2);
			var minute = ("0" + (date.getMinutes())).slice(-2);

			if(planInfo.StartTime<(year+'-'+month+'-'+day+' '+hour+':'+minute+':'+second)){
				_alert(2,'连接测试','开始时间不能小于当前时间');
				return false;
			}
			planInfo.PeriodType = parseInt($("#periodType").val());
			planInfo.PeriodValue = parseInt($("#periodValue").val());
		}
		planInfo.HostSet=new Array();
		planInfo.AccountSet=new Array();
		save_user($("#hostTree"));

		planInfo.Enabled=true;								//是否启用
		planInfo.Status=0;
		_showLoading();
		//之后保存
		msstr = aceg(JSON.stringify(planInfo),$("input[name=se]").val());
		$.ajax({
			url: "/bhost/save_conn_plan",
			type: 'POST',
			async: true,
			data: { a0: $("input[name=se]").val(), a1: JSON.stringify(planInfo),m1: msstr},
			success: function (result) {
				result = JSON.parse(result);
				_closeLoading();
				if (result.Result == true) {
					$('.btn').blur();
					parent.layer.open({
						type: 1,
						title: '连接测试',
						content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							parent.layer.close(i);
							back(1,result.BatchConnectPlanId);
						}
					});
				} else {
					_alert(1,'连接测试',result.ErrMsg);
					return false;
				}
			}
		});
	}
	function save_user(obj){
		$(obj).find('span.checkbox').each(function(i,item){
			if ($(item).parent()[0].tagName == "LABEL") return true;
			var state = $(item).attr('class');
			var $u = $(item).next().next().next().next();
			var $i = $(item).parent().find('ul:first').children('li');
			var $_authtype = $(item).siblings('span.authtype');
			
			var $_input = $(item).prev('input');
			var _id = $_input.attr("id").split('-');
			var loadfirst = $_input.attr('data-loadfirst');
			var loadlast = $_input.attr('data-loadlast');
			
			if($_input.prop("disabled")) return true;
			if(loadfirst != loadlast){
				if ((loadfirst == 0 && loadlast == 2) || (loadfirst == 1 && loadlast == 2)){ //add
					if ($_authtype.length != 0){
						if ($_authtype.find('input').length != 0){
							if ($_authtype.find('input').prop('checked')){ //按组授权
								if (_id[0] == "nodehg"){
									if (loadfirst == 1 && loadlast == 2){
										var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":true,"IsDelOld":true}';
									}else{
										var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":true}';
									}
									var object_str = JSON.stringify(planInfo.HostSet);
									if (object_str.indexOf(set) === -1){
										planInfo.HostSet.push(JSON.parse(set));
									}
								}else{
									var HGroupId = _id[1]
									var HostId = _id[2];
									if (loadfirst == 1 && loadlast == 2){
										var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth":true,"IsDelOld":true}';
									}else{
										var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth":true}';
									}
									var object_str = JSON.stringify(planInfo.HostSet);
									if (object_str.indexOf(set) === -1){
										planInfo.HostSet.push(JSON.parse(set));
									}
								}
							}else{
								if ($(item).parent().parent().siblings('span.checkbox').length != 0){
									if ($(item).parent().parent().siblings('span.checkbox').attr('class').indexOf('checked') != -1){
										return true;
									}
								}
								if (_id[0] == "nodehg"){
									var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":false}';
									var object_str = JSON.stringify(planInfo.HostSet);
									if (object_str.indexOf(set) === -1){
										planInfo.HostSet.push(JSON.parse(set));
									}
								}else{
									var HGroupId = _id[1]
									var HostId = _id[2];
									var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth":false}';
									var object_str = JSON.stringify(planInfo.HostSet);
									if (object_str.indexOf(set) === -1){
										planInfo.HostSet.push(JSON.parse(set));
									}
								}
							}
						}else{//未分组
							if (_id[0] == "nodehg"){
								var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":false}';
								var object_str = JSON.stringify(planInfo.HostSet);
								if (object_str.indexOf(set) === -1){
									planInfo.HostSet.push(JSON.parse(set));
								}
							}
						}
					}else{ //服务账号
						//////console.log(_id);
						//////console.log($(item));
						//////console.log($(item).parent().parent().siblings('span.checkbox').length);
						//////console.log($(item).parent().parent().siblings('span.checkbox').attr('class'));
						if ($(item).parent().parent().siblings('span.checkbox').length != 0){
							if ($(item).parent().parent().siblings('span.checkbox').attr('class').indexOf('checked') != -1){
								//////console.log("out");
								return true;
							}
						}
						if (_id[0] == "nodes"){
							//////console.log("nodes");
							var HGroupId = _id[1];
							var HostId = _id[2];
							var HostServiceId = _id[3];
							$(item).siblings('ul').children('li').each(function(i1,item1){
								var AccountId = $(item1).children('input').attr('id').split('-')[3];
								var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+'}';
								var object_str = JSON.stringify(planInfo.AccountSet);
								if (object_str.indexOf(set) === -1){
									//////console.log("pushed");
									planInfo.AccountSet.push(JSON.parse(set));
								}
							})
						}else{
							//////console.log("else");
							var HGroupId = _id[1];
							var HostId = _id[2];
							var AccountId = _id[3];
							var HostServiceId = _id[4];
							var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+'}';
							var object_str = JSON.stringify(planInfo.AccountSet);
							if (object_str.indexOf(set) === -1){
								//////console.log("pushed");
								planInfo.AccountSet.push(JSON.parse(set));
							}
						}
					}
				}else if ((loadfirst == 2 && loadlast == 0) || (loadfirst == 1 && loadlast == 0)){
					//////console.log("2---0");
					var $p_input = $(item).parent().parent().siblings('input');
					if ($p_input.length != 0){
						var p_loadfirst = $p_input.attr('data-loadfirst');
						var p_loadlast = $p_input.attr('data-loadlast');
						if (p_loadfirst == 2 && p_loadlast == 0){
							return true;
						} 
					}
					if (_id[0] == "nodehg"){
						var set = '{"HGId":'+_id[1]+',"HostId":null}';
						var object_str = JSON.stringify(planInfo.DeleteAuthObject);
						if (object_str.indexOf(set) === -1){
							planInfo.DeleteAuthObject.push(JSON.parse(set));
						}
					}else if (_id[0] == "nodeh"){
						var HGroupId = _id[1];
						var HostId = _id[2];
						var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+'}';
						var object_str = JSON.stringify(planInfo.DeleteAuthObject);
						if (object_str.indexOf(set) === -1){
							planInfo.DeleteAuthObject.push(JSON.parse(set));
						}
					}else if (_id[0] == "nodes"){
						var HGroupId = _id[1];
						var HostId = _id[2];
						var HostServiceId = _id[3];
						$(item).siblings('ul').children('li').each(function(i1,item1){
							var AccountId = $(item1).children('input').attr('id').split('-')[3];
							var set = '{"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+'}';
							var object_str = JSON.stringify(planInfo.DeleteAuthObject);
							if (object_str.indexOf(set) === -1){
								planInfo.DeleteAuthObject.push(JSON.parse(set));
							}
						});
					}else if (_id[0] == "nodea"){
						var HGroupId = _id[1];
						var HostId = _id[2];
						var AccountId = _id[3];
						var HostServiceId = _id[4];
						var set = '{"HostServiceId":'+HostServiceId+',"AccountId":'+AccountId+',"HGId":'+HGroupId+',"HostId":'+HostId+'}';
						var object_str = JSON.stringify(planInfo.DeleteAuthObject);
						if (object_str.indexOf(set) === -1){
							planInfo.DeleteAuthObject.push(JSON.parse(set));
						}
					}
				}else if (loadfirst == 2 && loadlast == 1){
					if ($_input.attr('data-ifselect') == 'true'){
						if (_id[0] == "nodehg"){
							var set = '{"HGId":'+_id[1]+',"HostId":null,"IsGroupAuth":false,"IsDelOld":true}';
							var object_str = JSON.stringify(planInfo.HostSet);
							if (object_str.indexOf(set) === -1){
								planInfo.HostSet.push(JSON.parse(set));
							}
						}else if (_id[0] == "nodeh"){
							var HGroupId = _id[1];
							var HostId = _id[2];
							var set = '{"HGId":'+HGroupId+',"HostId":'+HostId+',"IsGroupAuth": false,"IsDelOld":true}';
							var object_str = JSON.stringify(planInfo.HostSet);
							if (object_str.indexOf(set) === -1){
								planInfo.HostSet.push(JSON.parse(set));
							}
						}
					}
				}
			}else{
				if ($_authtype.length != 0){
					if ($_authtype.find('input').length != 0){
						if (($_authtype.find('input').prop('checked')) && ($_input.attr('data-ifselect') == 'false')){ //未按组——>按组授权
							if(_id[0] == 'nodehg') planInfo.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": null,"IsGroupAuth": true,"IsDelOld":true}'));
							else planInfo.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": '+_id[2]+',"IsGroupAuth": true,"IsDelOld":true}'));
						}else if (($_authtype.find('input').prop('checked') == false) && ($_input.attr('data-ifselect') == 'true')){
							if(_id[0] == 'nodehg') {
								planInfo.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": null,"IsGroupAuth": false,"IsDelOld":true}'));
							}
							else{
								planInfo.HostSet.push(JSON.parse('{"HGId": '+_id[1]+',"HostId": '+_id[2]+',"IsGroupAuth": false,"IsDelOld":true}'));
							}
						}
					}
				}
			}
		});
	}

	function loadNormalInfo(planId) {
		$('#t_date').jeDate({
			format:"YYYY-MM-DD",
			isTime:true,
			// maxDate:9999 + "-" + 99 + "-" + 99
		});
		if (planId == '0') {
			//////console.log('createNewPlan');			//新建的
			planInfo = createNewPlan();
			//用当前时间给年、月、日文本框赋值
			var date = new Date();		//获取当前时间
			var setDate = {
				year: date.getFullYear(),
				month: date.getMonth() + 1,
				day: date.getDate()
			}
			var year = date.getFullYear();
			var month = ("0" + (date.getMonth() + 1)).slice(-2);
			var day = ("0" + date.getDate()).slice(-2);
			var hour = ("0" + (date.getHours())).slice(-2);
			var second = ("0" + (date.getSeconds())).slice(-2);
			var minute = ("0" + (date.getMinutes())).slice(-2);
			$("#t_date").val(year + '-' + month + '-' + day);
			$("#t_hour").val(hour);
			$("#t_minute").val(minute);
			$("#t_second").val(second);
			
			
		} else {
			//////console.log('getOldPlan');
			getOldPlan();
			if (planInfo == '') { return false; }

			//名字
			$("#HostName").val(planInfo.BatchConnectPlanName);
			//时间
			if(planInfo.StartTime!=null){
				var time = planInfo.StartTime.split(" ");
				$("#t_date").val(time[0]);
				$("#t_hour").val(time[1].slice(0, 2));
				$("#t_minute").val(time[1].slice(3, 5));
				$("#t_second").val(time[1].slice(6, 8));
			}else{
				var date = new Date();		//获取当前时间
				var year = date.getFullYear();
				var month = ("0" + (date.getMonth() + 1)).slice(-2);
				var day = ("0" + date.getDate()).slice(-2);
				var hour = ("0" + (date.getHours())).slice(-2);
				var second = ("0" + (date.getSeconds())).slice(-2);
				var minute = ("0" + (date.getMinutes())).slice(-2);
				$("#t_date").val(year + '-' + month + '-' + day);
				$("#t_hour").val(hour);
				$("#t_minute").val(minute);
				$("#t_second").val(second);
			}
			//周期
			$("#periodValue").val(planInfo.PeriodValue==null?'30':planInfo.PeriodValue);
			$("#periodType").val(planInfo.PeriodType==null?1:planInfo.PeriodType);
			//立即执行?
			$("#Execution").iCheck(planInfo.Execution ? 'check' : 'uncheck');
		}
	}

	function createNewPlan() {
		return {
			"LoginUserCode": "",
			"BatchConnectPlanId": 0,							//计划id
			"BatchConnectPlanName": $("#HostName").val(),		//计划名
			"StartTime": createTimeStr(),						//开始时间
			"PeriodType": parseInt($("#periodType").val()),	//周期类型
			"PeriodValue": parseInt($("#periodValue").val()),	//周期数值
			"Execution": $("#Execution").prop("checked"),		//是否立即执行
			"Enabled": true,									//是否启用
			"Status": 0,										//执行结果
			"AccountSet": null,
			"HostSet": null,
			"DeleteAuthObject": null
		};
	}
	var planInfo;
	//获取计划信息
	function getOldPlan() {
		//从数据库中读取信息
		$.ajax({
			url:'/bhost/PUpdateHNodeSelectedForQuick',
			type:'post',
			async:false,
			data:{a0:$("input[name=se]").val(),z1:$("#a").val(),z2:8},
			success:function(result){
				var data = JSON.parse(result)
				if(data.Result != true){
					_alert(1, "连接测试", "数据刷新失败");
					return false;
				}
			}
		});
		$.ajax({
			url: "/bhost/get_connect_plan",
			data: { a0: $("input[name=se]").val(), a1: $("#a").val()},
			async: false,
			type: 'POST',
			success: function (result) {
				result = JSON.parse(result);
				if (result.Result == true) {
					planInfo = result.info.data[0];
					delete planInfo.LastExecuteTime;
					planInfo.DeleteAuthObject = [];
				} else {
					_alert(1, "连接测试", result.ErrMsg, null);
				}
			}
		});
	}

	function planName_check() {
		var arg = $("#HostName").val();
		var errorMsg = '';
		var title_value='';
		//////console.log('arg.length'+arg.length);
		//检查输入是否合法(现在只检查是否为空)
		if (arg == '') {
			errorMsg = "请输入名称";
			title_value=2;
		}else if (!nameReg.test(arg)) {
			errorMsg = "名称格式不正确";
			title_value=1;
		}

		if (errorMsg != '') {
			_alert(title_value,'连接测试',errorMsg);
			return false;
		}
		return true;
	}
	//显示创建页面
	function host_test_add() {
		location.reload();
	}
	/*
		时、分、秒文本框的onblur（失去焦点）事件处理函数。
		作用是如果文本框中的数字小于10，则补上0变为两位,
		如数字"0"会变为"00"数字"1"会变为"01"
	*/
	function add_zero() {
		$(this).trigger("keyup");
		this.value = ('00' + this.value.trim()).slice(-2);
	}

	/*
		时、分、秒文本框的onkeyup事件处理函数
		检查数字大小是否在范围内，如果超出范围
		则将文本框数字大小设置为最大值或最小值
	*/
	function dataCheck(event) {//min can not bigger than 1
		var target = event.target;
		target.value = target.value.replace(/\D/g, "");
		var v = parseInt(target.value);
		if (v < event.data.min) { target.value = event.data.min; }
		else if (v > event.data.max) { target.value = event.data.max; }

	}

	/*
		将"系统时间"输入框中的日期、时、分、秒组合成一个字符串
		字符串格式为"年-月-日 时:分:秒"
	*/
	function createTimeStr() {
		return $("#t_date").val() + " "
			+ $("#t_hour").val() + ":"
			+ $("#t_minute").val() + ":"
			+ $("#t_second").val();
	}

</script>
{% endblock %}
