<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>manager</title>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/G-style.css" type="text/css" />
	<!--script-->
	<script src="/manage/js/jquery.min.js"></script>
	<script src="/manage/js/jquery.easing.js"></script>
	<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/layer.js"></script>
	<script src="/manage/js/common_e.js"></script>
	<!--icheck-->
	<script src="/manage/js/icheck.min.js"></script>
	<!--select2-->
	<script src="/manage/js/select2.full.min.js"></script>
	<script src="/manage/js/my_scrollbar.js"></script>
	<style>
		.c-form-host span.ss {
			float: left;
			width: 171px;
			line-height: 28px;
			position: relative;
		}
		.form-text2 {
			padding-right: 8px;
		}
		.ani_dot {
			font-family: simsun;
		}
		:root .ani_dot {
			display: inline-block;
			width: 1.5em;
			vertical-align: bottom;
			overflow: hidden;
		}

		@-webkit-keyframes dot {
			0% {
				width: 0;
				margin-right: 1.5em;
			}
			33% {
				width: .5em;
				margin-right: 1em;
			}
			66% {
				width: 1em;
				margin-right: .5em;
			}
			100% {
				width: 1.5em;
				margin-right: 0;
			}
		}

		.ani_dot {
			-webkit-animation: dot 3s infinite step-start;
		}

		.h-content2 span.checkbox:not(.disabled) {
			cursor: pointer;
		}

		.h-content2 span.disabled {
			cursor: default;
		}

		@keyframes dot {
			0% {
				width: 0;
				margin-right: 1.5em;
			}
			33% {
				width: .5em;
				margin-right: 1em;
			}
			66% {
				width: 1em;
				margin-right: .5em;
			}
			100% {
				width: 1.5em;
				margin-right: 0;
			}
		}

		.ani_dot {
			animation: dot 3s infinite step-start;
		}

		.h-name-son{
			display: inline-block;
		}
	</style>
</head>

<body style="overflow:hidden;display:none;" class="bg-white">
	<!--服务器集合添加或编辑-->
	<div class="rwrap">
		<div class="c-top">
			<div class="c-title">
				<!--<h3 onclick="parent.reload();">服务器集合</h3>-->
				<div class="manual-head" style="float:left;width:100px">
					<div class="manual-title">
						<span id="host_group" style="cursor: pointer;">服务器集合</span>
						<i class="host_group_icon"></i>
					</div>
				</div>

				<div class="ctr">
					<a href="javascript:;" class="ret" onclick="parent._closePage(this)">
						<i></i>
					</a>
				</div>
			</div>
		</div>

		<div class="mainer">
			<div class="container">
				<div class="c-cont">
					<div class="c-wrap" style="padding: 10px 0 0">
						<div class="c-exp">

							<div class="h-explorer">
								<div class="h-top">
									<div class="form-item" style="padding: 0 0 0 21px;float:left;width:auto;margin:3px;">
										<span class="form-tag" style="float:left;width:auto;">
											<em class="imp">*</em>名称：</span>
										<div class="form-c" style="float:left;padding-left:0px;">
											<input type="text" class="form-text" id="d_n" name="d_n" style="width:160px;" maxlength="128" onblur="regCheck(this,nameReg);">
											<i class="v-check" style="    margin: 7px 0 0 -26px;"></i>
											<!-- <p class="form-tip">仅支持中文、字母、数字、下划线、横杠、小数点</p> -->
											<span>特殊字符仅支持下划线、横杠、小数点</span>
										</div>
									</div>
								</div>

								<div class="h-catelog h-catelog2" style="width: 420px; padding: 0;">
									<div class="h-top" style="background-color: #f5f5f5;">
										<span class="form-tag" style="float:left;width:auto;padding: 4px 0px 0px 15px;">IP限制：</span>
										<input type="checkbox" class="form-checkbox" name="" id="part1" value="" style="margin-top: 9px; float: right;position: relative;" checked="checked" >
										<h2 style="font-size: 13px;padding: 10px 6px 0px 0px;font-weight: 100;float: right;">启用</h2>
									</div>
									<h5 style="font-size: 14px;padding: 12px 0 0 14px;">IP地址：</h5>
									<div id="ip_n1" name="ip_n1" class="form-c c-form-host" style="padding-left:22px;width:343px;max-width:375px;min-width: 375px;"
									 value="0">
										<span class="ss ss-add" id="ip_span1" value="0" style="float:left;position:static;">
											<input type="text" class="form-text form-text2" style="width:122px;">
											<i class="ctr ctr-add" onclick="_addIp1(this)" style="margin-left: 5px;"></i>
										</span>
									</div>
									<h5 style="font-size: 14px;padding:0px 0 0 14px;float:left;width:96%;">IP区间：</h5>
									<div id="ip_n" name="ip_n" class="form-c c-form-host" style="float:left;padding-left:22px;width:375px;max-width:375px;min-width: 375px;"
									 value="0">
										<span class="ss ss-add" id="ip_span" value="0" style="float:left;width: 312px;position:static;padding: 0 0 10px 0;">
											<input type="text" class="form-text form-text2" placeholder="起始IP地址" style="width:122px;">
											<span style="vertical-align:middle;">-</span>
											<input type="text" class="form-text form-text2" placeholder="结束IP地址" style="width:122px;">
											<i class="ctr ctr-add" onclick="_addIp(this);" style="margin-left: 5px;"></i>
										</span>
									</div>
								</div>

								<div class="h-content2" style="padding-top: 0px;    overflow: hidden;">
									<div class="h-top" style="background-color: #fff;">
										<div class="filter" style="float:right;min-width: auto;">
											<div id="waitTip" class="" style="float: right;margin-top: 7px;margin-left: -20px;"></div>
											<div class="search">
												<select name="server_select" id="server_select" class="filter-select">
													<option value="all" selected>所有</option>
													<option value="hgname">组名</option>
													<option value="hostname">主机名</option>
													<option value="ip">IP</option>
												</select>

												<input type="text" class="filter-text" placeholder="输入关键字" 
												name="server_text" id="server_text" maxlength="128" 
												style="/*display:none;*/padding-right: 22px;" 
												onchange="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
												onkeyup="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();}"
												onblur="if($('#server_text').val()=='' && search_typeall_new!=''){search_typeall_new='';find_hostgroup();}"
												onkeydown="if($('#server_text').val()==''){$('#server_text_check').hide();}else{$('#server_text_check').show();};if (event.keyCode == 13){_addFilter(this,false);return false;} else return; ">
												 <i class="v-check v-wrong" id="server_text_check" 
												 onclick="_clearFilter(this,1)" 
												 style="display:none;cursor: pointer;float: left;position: static;"></i>
												<button class="btn filter-btn" onclick="_addFilter(this,false)">
													<i class="add-filter"></i>
												</button>
												<button class="btn filter-btn" onclick="_addFilter(this,true)">
													<i class="append-filter"></i>
												</button>
											</div>
											<div class="search" id="clearFilter" style="margin: 0px 15px 0px -16px;display:none;">
												<button class="filter-btn" onclick="_clearFilter(this)">
													<i class="clear-filter"></i>
												</button>
											</div>
											<div class="selector selector-multiple" id="filterWW" style="display: none;width: 210px;">
												<span class="ww">搜索条件</span>
												<ul style="padding-left: 0px;"></ul>
											</div>
										</div>
									</div>
									<div style="overflow: auto;width:100%;height:90%;" id="hosttree_div">
										<h2 style="font-size: 14px;    padding-top: 10px;">主机：</h2>
										<ul id="userTree" class="hosttree" style="padding: 10px 0 0 56px;float: none;"></ul>
									</div>

								</div>
							</div>
						</div>

						<div class="clearfix "></div>
						<div class="btns perm_disabled">
							<a href="javascript:;" class="btn btn-normal" onclick="server_add();">保&nbsp;&nbsp;存</a>
							<!--
							<a href="javascript:;" class="btn btn-normal" onclick="server_list(0);">取&nbsp;&nbsp;消</a>
							-->
						</div>
					</div>
				</div>
			</div>
			<div id="bBtn" style="position: fixed;z-index: 5;">
				<a href="javascript:;" class="btn" style="float: right;" onclick="server_list(0);"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
			</div>
		</div>
	</div>
	</div>
	<form action="/bhost/server_handle" method="POST" name="frm_server_add" id="frm_server_add">
		<input type="hidden" name="tasktype" id="tasktype" value="{{ tasktype }}" />
		<!--创建 编辑 列表-->
		<input type="hidden" name="serverId" id="serverId" value="{{ serverId }}" />
		<!--serverId-->
		<input type="hidden" name="paging" id="paging" value="{{paging}}" />
		<!--页码-->
		<input type="hidden" name="search_typeall" id="search_typeall" value="{{search_typeall}}" />
		<!--search_typeall-->
		<input type="hidden" name="e" id="e" value="{{e}}" />
		<!--e-->
		<input type="hidden" name="se" id="se" value="{{se}}" />
		<!--se-->
		<input type="hidden" name="a10" id="a10" value="{{module_name}}" />
		<!-- module_name -->
	</form>

	<script>
		var perm={{perm}};
		var perm_client={{perm_client}};
		if (perm==0) parent.parent.$('#nav-s1 a.active').click();
		else{
			$('.bg-white').show();
			if(perm==1){
				$('.perm_disabled').remove();
			}
		}
		$('.filter-select').select2({ minimumResultsForSearch: -1 });
		$('.form-checkbox,.form-radio').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
	</script>
	<script>
		var server = {
			"ServerScopeId": 0,
			"ServerScopeName": "",
			"IsApplyToClientScope": false,
			"HostList": [],
			"EnableIPLimit":1,
			"IPList": {
				"IPSetId": 0,
				"Set": []
			}
		};
		var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		var ipReg=/(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
		var usercode = "";
		var server_edit = null;
		var type = 1;
		var search_typeall_r = '';
		var search_typeall_new = '';
		var server_find_json = {
			"loginusercode": null,
			"hgid": 0,
			"type": 1,
			"id": null,
			"istree": true,
			"hgname": "",
			"hostname": "",
			"hostip": "",
			"searchstring":'',
			"limitrow": null,
			"offsetrow": null
		}
		var last_object = null;
		var edit_id = parseInt(document.frm_server_add.serverId.value);
		var top1 = 9007199254740991;
		var data_array_Path = null;
		var host_path_all = [];
		var index_f = 0;
		var push_hgid = [];
		var push_hid = [];
		var filter_flag_append = false;
		var flag_loading = false;
		var old_path_all = [];
		$(function () {
			document.frm_server_add.se.value = window.parent.document.frm.se.value;
			server_find_json.id = edit_id;
			$("#server_text").val("");
			$("#server_select").change(function () {
				var type = $(this).val();
				if (type == 0) {
					$("#server_text").hide();
					$('#filterWW').hide();
					$('#clearFilter').hide();
				} else {
					$("#server_text").show();
					if ($('#filterWW ul li').length) {
						$('#filterWW').show();
						$('#clearFilter').show();
					}
				}
			});
			$("#server_select").val('all').trigger('change');
			$("#part1").on('ifChecked',function(){
				$("#ip_n1").find("input").attr("disabled",false);
				$("#ip_n").find("input").attr("disabled",false);
				$("#ip_n1").find(".ctr.ctr-add").attr("onclick","_addIp1(this,2)");
				$("#ip_n").find(".ctr.ctr-add").attr("onclick","_addIp(this,2)");
			}).on('ifUnchecked',function(){
				$("#ip_n1").find("input").attr("disabled",true);
				$("#ip_n").find("input").attr("disabled",true);
				$("#ip_n1").find(".ctr.ctr-add").attr("onclick","");
				$("#ip_n").find(".ctr.ctr-add").attr("onclick","");
			})
			$("#part1").parent().attr("style","float: right; margin-top: 9px; position: relative;");			
			//编辑页面
			var tasktype = document.frm_server_add.tasktype.value;
			if (tasktype == "2") {
				$.ajax({
					url:'/bhost/PUpdateHNodeSelectedForQuick',
					type:'post',
					async:false,
					data:{a0:$("input[name=se]").val(),z1:edit_id,z2:1},
					success:function(result){
						var data = JSON.parse(result)
						if(data.Result != true){
							_alert(1, "服务器集合", "数据刷新失败");
							return false;
						}
					}
				});
				$.ajax({
					url: "/bhost/get_server_list",
					type: "POST",
					async: false,
					data: { a0: $("input[name=se]").val(), a1: edit_id },
					success: function (result) {
						var server_result = JSON.parse(result);
						if (server_result.Result == true) {
							var server_data = server_result.info.data[0];
							server_edit = server_data;
							last_object = server_data.HostList;
							$("#d_n").val(server_data.ServerScopeName);
							$("#d_n").attr("disabled", true);
							if (server.IPList != null) {
								server.IPList.IPSetId = server_data.IPList.IPSetId;
								if (server_data.IPList.Set != null) {
									var IPset_group = server_data.IPList.Set.filter(function (params) {
										return params.StartIP != params.EndIP
									});
									var IP_group = server_data.IPList.Set.filter(function (params) {
										return params.StartIP == params.EndIP
									});
									for (var i = 0; i < IPset_group.length - 1; i++) {
										var $c = $('<span class="ss" value="' + IPset_group[i].IPSetMemberId + '" style="float: left;width: 312px;position: static;padding: 0 0 10px 0;"/>');
										$c.html('<input type="text" class="form-text form-text2" value="' + IPset_group[i].StartIP + '"  style="width:122px;">'
											+ '<span style="vertical-align:middle;padding-left: 4px;padding-right: 4px;">-</span>'
											+ '<input type="text" class="form-text form-text2" value="' + IPset_group[i].EndIP + '"  style="width:122px;">'
											+ '<i class="ctr ctr-del" style="    margin-top: 5px;margin-left: -3px;" onclick="_delIp(this)"></i>');
										$("#ip_n").find("span[class='ss ss-add']").after($c);
									}
									if (IPset_group.length != 0) {
										$('#ip_n').find("span[class='ss ss-add']").attr('value', IPset_group[i].IPSetMemberId);
										var $ip_input = $('#ip_n').find("span[class='ss ss-add']").find('input');
										$ip_input.first().val(IPset_group[i].StartIP);
										$ip_input.last().val(IPset_group[i].EndIP);
									}
									for (var i = 0; i < IP_group.length - 1; i++) {
										var $c = $('<span class="ss" value="' + IP_group[i].IPSetMemberId + '" style="float: left;position: static;padding: 0 0 10px 0;"/>');
										$c.html('<input type="text" class="form-text form-text2" style="width:122px;" value="' + IP_group[i].StartIP + '" >'
											+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="    margin-top: 4px;    margin-left: -3px;"></i>');
										$('#ip_n1').find("span[class='ss ss-add']").after($c);
									}
									if (IP_group.length != 0) {
										$('#ip_n1').find("span[class='ss ss-add']").attr('value', IP_group[i].IPSetMemberId);
										$('#ip_n1').find("span[class='ss ss-add']").find('input').val(IP_group[i].StartIP);
									}
								}
							}
							if(server_data.EnableIPLimit == 0){
								$('#part1').iCheck('uncheck');
							}
						} else {
							_alert(1, '服务器集合', server_result.ErrMsg);
							return false;
						}
					}
				});
			}
			usercode = window.parent.document.frm.us.value;
			server_find_json.loginusercode = usercode;
			_initSize();
			_initList();
			$('#userTree').on('change', 'span.authtype input', function () {
				var checked = $(this).prop('checked');
				_authTypeTheme($(this));
				if (checked) {
					var $input1 = $(this).parent().parent().siblings('ul').find('span.authtype input');
					var $input2 = $(this).parent().parent().siblings('ul').find('input.zcheck');
					var $input3 = $(this).parent().parent().siblings('input.zcheck');
					$input2.attr("data-loadlast", 2);
					$input3.attr("data-loadlast", 2);
					$(this).attr('data-ifselect', true);
					$input1.prop('disabled', true);
					_authTypeTheme($input1);
					$input2.prop('checked', true).prop('disabled', true);
					$(this).parent().parent().siblings('input.zcheck').prop('checked', true).next('span.checkbox').attr('class', 'checkbox checked');
					$.each($input2, function () {
						$(this).next('span.checkbox').attr('class', 'checkbox checked disabled');
					});

					_checkEvent($(this).parent().parent().siblings('input.zcheck'));
				} else {
					var $input1 = $(this).parent().parent().siblings('ul').children('li').find('span.authtype').find('input');
					var $input2 = $(this).parent().parent().siblings('ul').children('li').find('input.zcheck');
					$(this).attr('data-ifselect', false);
					$input1.prop('disabled', false);
					_checkEvent1($(this));
					authtype_click = 1;
				}
			}).on('click', 'i.h-aicon', function () {
				var $item = $(this);
				var id = $item.data('id').split('-')[1];
				var $u = $item.parent().children('ul');
				if ($u.is(':hidden')) {
					$item.addClass('h-aicon-d');
					$u.show();
					if ($u.text() == "Loading...") {
						var v = 2, d;
						var $input = $(this).siblings('span.checkbox');
						if ($(this).siblings('span.authtype').find('input').is(':checked')) {
							d = 0;
						} else {
							d = 1;
						}

						if ($input.attr('class').indexOf('disabled') > 0) {
							d = 0;
						}
						var c = $input.attr('class');
						if (c.indexOf('checked') > 0) {
							v = 1;
						} else if (c == 'checkbox') {
							v = 0;
						}
						_initHTML($u, id, v, d);
					}
				} else {
					$item.removeClass('h-aicon-d');
					$u.hide();
				}
			}).on('dblclick', 'i.h-eicon,span.h-name', function () {
				var i_class_arr = $(this).siblings('i.h-aicon');
				if (i_class_arr.length == 0) {
					return false;
				}
				var $item = i_class_arr;
				var id = $item.data('id').split('-')[1];
				var $u = $item.parent().children('ul');
				if ($u.is(':hidden')) {
					$item.addClass('h-aicon-d');
					$u.show();
					if ($u.text() == "Loading...") {
						var v = 2, d;
						var $input = $(this).siblings('span.checkbox');
						if ($(this).siblings('span.authtype').find('input').is(':checked')) {
							d = 0;
						} else {
							d = 1;
						}

						if ($input.attr('class').indexOf('disabled') > 0) {
							d = 0;
						}
						var c = $input.attr('class');
						if (c.indexOf('checked') > 0) {
							v = 1;
						} else if (c == 'checkbox') {
							v = 0;
						}
						_initHTML($u, id, v, d);
					}
				} else {
					$item.removeClass('h-aicon-d');
					$u.hide();
				}
			});
			parent._switchBtn(0);//隐藏按钮
		});
		$(window).resize(function () {
			_initSize();//加载长度
		});
		function _checkEvent1(obj) {
			if ($(obj).length == 0) return false;
			var _run1 = function () {
				_input = $(obj).parent().parent().siblings('input.zcheck');

				_ul = _input.siblings('ul');
				if (_input.length > 0 && (_ul.children('li').length > 0)) {
					$inp = _ul.children('li').children('input.zcheck');
					$($inp).each(function (i, item) {
						$parent = $(item).parent().parent().siblings('span.authtype').find('input');
						v = $($parent).prop("checked");
						$spanp = $(item).siblings('span.authtype');
						//如果发现父节点还是disabled
						if ($($parent).prop("disabled") == true) v = true;
						if (v == false) {
							$(item).prop("disabled", false);
							$(item).siblings('span.checkbox').removeClass("disabled");
							$spanp.find('input').prop("disabled", false);
							$spanp.find('span').removeClass("disabled");
							if ($spanp.length == 0) {
								_checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
							}
							else {
								if ($(item).prop('checked') == false) $spanp.find('input').prop('checked', false).next('span').removeClass('checked');
								_checkEvent1($spanp.find('input'));
							}
						} else {
							$(item).prop("checked", true).prop("disabled", true);
							$(item).siblings('span.checkbox').addClass("disabled");
							$spanp.find('input').prop("disabled", true);
							$spanp.find('span').addClass("disabled");
							if ($spanp.length == 0) _checkEvent2($(item).siblings('ul').children('li').children('input.zcheck'));
							else _checkEvent1($spanp.find('input'));

						}
					})


				} else {

					return;
				}
			}

			_run1();
		}
		function _checkEvent2(obj) {
			if (obj.length == 0) return false;
			var _run2 = function () {
				_input = $(obj).parent().parent().siblings('input.zcheck');;
				if ($(_input).prop('disabled') == true) {
					$(obj).prop("checked", true).prop("disabled", true);
					$(obj).siblings('span.checkbox').addClass("disabled");
				} else {
					$(obj).prop("disabled", false);
					$(obj).siblings('span.checkbox').removeClass("disabled");
				}
				_checkEvent2($(obj).siblings('ul').children('li').children('input.zcheck'));
			}

			_run2();
		}
		//加载长度
		function _initSize() {
			var h = $(window).height();
			$('.h-catelog').height(h - 195);
			$('.h-content2').height(h - 195);
			$('#hosttree_div').height(h - 195 - 35);
		}
		var tmp_list = null;
		var ajax_find_host_doing = false;
		var first_find_index = null;
		function coverString(subStr, str) {
			var reg = eval("/" + subStr + "/ig");
			return reg.test(str);
		}
		function red_to_no_red_and_open_to_red(obj, num) {
			for (var i = 0; i < tmp_list.length; i++) {
				var item = tmp_list[i];
				var pass = true;
				find_host_arry = (search_typeall_r + search_typeall_new).split('\t');
				for (var jm = 0; jm < find_host_arry.length; jm++) {
					if (find_host_arry[jm] == '' || find_host_arry[jm] == undefined || find_host_arry[jm] == null) {
						continue;
					}
					var pass_one = false;
					var jm_index_=find_host_arry[jm].indexOf('-');
					var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
					$.each(search_arr, function (i1, item1) {
						if (item1 != '') {
							if(find_host_arry[jm].substr(0,jm_index_)=='hostname'){
								var Name=item.Name.split('\t')[0];
								if(item.Type!=2){
									return false;
								}
							}else if(find_host_arry[jm].substr(0,jm_index_)=='ip'){
								var Name=item.Name.split('\t')[1];
								if(item.Type!=2){
									return false;
								}
							}else if(find_host_arry[jm].substr(0,jm_index_)=='hgname'){
								var Name=item.Name;
								if(item.Type!=1){
									return false;
								}
							}else{
								var Name=item.Name;
							}
							if (coverString(item1, Name)) {
								pass_one = true;
								return false;
							}
						}
					});
					if (pass_one == false) {
						pass = false;
						break;
					}
				}
				if (pass == true) {
					open_and_make_red(item);
				} else {
				}
			}
			li_red_to_no_red($('#userTree'));
			//定位
			top_to_move($('#userTree'));
		}

		function open_and_make_red(item) {
			var Path_array = item.Path.split('/');
			var len = Path_array.length;
			if (len == 2) {//主机层
				//show
				$('#HGId-' + item.Id).parent('li').show();
				$('#HGId-' + item.Id).siblings('span.h-name').addClass('h-name-red');
			} else {
				if (item.Type == 3 || item.Type == 4) { //服务/账号

				} else {
					for (var j = 1; j < len - 1; j++) {
						var id = Path_array[j].split(',')[1];
						//show
						$('#HGId-' + id).parent('li').show();
						$i_item = $('#HGId-' + id).prev('i');
						if (($i_item.attr('class').indexOf('h-aicon-d')) == -1) {
							filter_flag_append = true;
							$i_item.trigger('click');
						}
					}
					if (item.Type == 1) {
						//show
						$('#HGId-' + item.Id).parent('li').show();
						$('#HGId-' + item.Id).siblings('span.h-name').addClass('h-name-red');
					} else {
						//show

						$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + item.Id).parent('li').show();

						$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + item.Id).siblings('span.h-name').addClass('h-name-red');
					}
				}
			}
		}

		function top_to_move(obj) {
			var top_arr = $(obj).find('span.h-name-red');
			if (top_arr.length != 0) {
				//非红隐藏
				li_hide_while_no_red(obj, 0);
				$('#hosttree_div').scrollTop(top_arr.eq(0).offset().top - 200);
				_waitDone();
			} else {
				$('#userTree').children('li').hide();
				$("#server_text").blur();
				////console.log('无搜索结果');
				_alert(0, '搜索', '无搜索结果', $("#server_text"));
				_waitDone();
			}
		}
		var find_host_arry = new Array();
		var find_host_group_loading=false;
		function find_hostgroup() {
			find_host_group_loading=true;
			var search_typeall_all = search_typeall_r + search_typeall_new;
			find_host_arry = search_typeall_all.split('\t');
			for (var i = 0; i < find_host_arry.length; i++) {
				if (find_host_arry[i] == '') {
					find_host_arry.splice(i, 1);
					i--;
				}
			}
			_getWait();
			//先清空之前的过滤信息 
			click_h1();
		}
		function scrollTop_check_server1() {
			////console.log('scrollTop_check_server1');
			var i = 0;
			var index_i = 0;
			// li_red_to_no_red($('#userTree'));
			li_hide_while_no_red($('#userTree'), 0);
			if ($('#userTree').find('span.h-name-red').length == 0) {
				$("#server_text").blur();
				_alert(0, '搜索', '无搜索结果', $("#server_text"));
				_waitDone(0);
				flag_ajax_true = true;
				ajax_find_host_doing = false;
				find_host_group_loading=false;
				return false;
			} else {
				ajax_find_host_doing = false;
				flag_ajax_true = true;
				old_path_all = new Array();
				find_host_group_loading=false;
				$('#hosttree_div').scrollTop($('#userTree').find('span.h-name-red').eq(0).offset().top - 200);
				_waitDone(3000);
				return false;

			}
		}
		function red_to_font(obj){
			////console.log($(obj));
			var item=$(obj).siblings('span.h-name');
			var item_name = item.siblings('input').attr('data-name');
			var Type = item.siblings('input').attr('id');
			var $span_son_font=$('.h-name-son',item).find('font');
			////console.log(Type);
			if(Type.indexOf('HostId')<0){
				var span_son_name=item_name.toLowerCase();
			}else{
				var host_span_arr=item_name.split('\t');
				var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
			}
			for (var jm = 0; jm < find_host_arry.length; jm++) {
				var pass_one = false;
				var jm_index_ = find_host_arry[jm].indexOf('-');
				var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
				$.each(search_arr, function (i1, item1) {
					if(item1==''){
						return true;
					}
						if (find_host_arry[jm].substr(0, jm_index_) == 'hgname'){
							var Name = item_name;
							if(Type.indexOf('HGId')<0){
								return true;
							}
						}else if (find_host_arry[jm].substr(0, jm_index_) == 'hostname') {
							var Name = item_name.split('\t')[1];
							if(Type.indexOf('HostId')<0){
								return true;
							}
						} else if (find_host_arry[jm].substr(0, jm_index_) == 'ip'){
							var Name = item_name.split('\t')[0];
							if(Type.indexOf('HostId')<0){
								return true;
							}
						}else if (find_host_arry[jm].substr(0, jm_index_) == '服务'){
							var Name = item_name;
							if(Type.indexOf('nodes')<0){
								return true;
							}
						}else if (find_host_arry[jm].substr(0, jm_index_) == '账号'){
							var Name = item_name;
							if(Type.indexOf('nodea')<0){
								return true;
							}
						}else{
							var Name = item_name;
						}
					if (coverString(item1, Name)) {
						item1=item1.toLowerCase();
						if(find_host_arry[jm].substr(0, jm_index_) == 'hostname'){
							var index_start=span_son_name.indexOf('(');
							var index_true=span_son_name.indexOf(item1,index_start);
							if(index_true>=0){
								for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
									$span_son_font.eq(i_red_span).addClass('font-red');
								}
							}
						}else{
							var index_true=span_son_name.indexOf(item1);
							if(index_true>=0){
								for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
									$span_son_font.eq(i_red_span).addClass('font-red');
								}
							}
						}
					}
				});
			}
		}
		function find_append() {
			var i = 0;
			var t_do1;
			index_f = 0;
			function _do1() {
				clearTimeout(t_do1);
				for (i = index_f; i < index_f + 50; i++) {
					// if (flag_ajax_true == true) {
					// 	return false;
					// }
					if (i >= host_path_all.length) {    //
						if (host_path_all.length == 0) {
							//过滤结束 开始标红
							scrollTop_check_server1();
							return false;
						} else {
							index_f = 0;
							t_do1 = setTimeout(function () { _do1(); }, 1);
							return false;
						}
					}
					if (host_path_all[i].Type != 1 && host_path_all[i].Type != 2) {
						host_path_all.splice(i, 1);
						continue;
					}
					var Path_array = host_path_all[i].Path.split('/');
					var len = Path_array.length;
					if (len == 2) {//主机层
						//数据未完全展开 留在 host_path_all，下次继续执行
						if ($('#HGId-' + host_path_all[i].Id).length == 0) continue;//
						//show
						$('#HGId-' + host_path_all[i].Id).parent('li').show();
						$('#HGId-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
						red_to_font($('#HGId-' + host_path_all[i].Id));
						$('#HGId-' + host_path_all[i].Id).siblings('ul').find('li').show();
					} else {
						s = 0;
						for (var j = 1; j < len - 1; j++) {
							var id = Path_array[j].split(',')[1];
							if ($('#HGId-' + id).length == 0) {
								s = 1;
								break;//
							}
							if (flag_loading == true) {
								s = 1;
								break;
							}
							//show
							$('#HGId-' + id).parent('li').show();
							$i_item = $('#HGId-' + id).prev('i');

							if ($i_item.attr('class') == "h-blank") { //
								host_path_all.splice(i, 1);
								s = 1;
								break;//
							}
							if (push_hgid.indexOf(Path_array[j - 1].split(',')[1] + ':true') != -1) {
								continue;
							}
							if (push_hgid.indexOf(Path_array[j - 1].split(',')[1] + ':false') != -1) {
								continue;
							}
							if ($('#HGId-' + id).length > 0) {
								red_to_font($('#HGId-' + id));
								if (($i_item.attr('class').indexOf('h-aicon-d')) == -1) {
									filter_flag_append = true;
									$i_item.trigger('click');
								}
							}
						}
						if (s) continue;
						if (host_path_all[i].Type == 1) {
							if ($('#HGId-' + host_path_all[i].Id).length == 0) continue;//
							//show
							$('#HGId-' + host_path_all[i].Id).parent('li').show();
							$('#HGId-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
							red_to_font($('#HGId-' + host_path_all[i].Id));
							$('#HGId-' + host_path_all[i].Id).siblings('ul').find('li').show();
						} else {
							if ($('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).length == 0) continue;//
							//show
							$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).parent('li').show();
							$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
							red_to_font($('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id));
							$('#HostId-' + Path_array[j - 1].split(',')[1] + '-' + host_path_all[i].Id).siblings('ul').find('li').show();
						}
					}
					//数据展开后 从host_path_all删除掉，并且放在old_path_all，为标红和定位准备
					old_path_all.push(host_path_all[i]);
					host_path_all.splice(i, 1);

				}
				index_f = i;
				get_msg();
				t_do1 = setTimeout(function () { _do1(); }, 1);
			}
			_do1();
		}
		var global_time = Date.parse(new Date()) / 1000;
		function get_msg() {
			var n = 0;
			$.ajax({
				url: '/bhost/get_msg',
				type: "post",
				async: false,
				data: { a0: $("input[name=se]").val() },
				success: function (result) {
					var result = JSON.parse(result);
					global_time = Date.parse(new Date()) / 1000;
					if (result.Result == false) {
						if (result.info.indexOf('系统异常') >= 0 || result.info.indexOf('非法访问') >= 0 || result.info.indexOf('系统超时') >= 0) {
							_alert(2, '系统', result.info);
						} else {
							_alert(2, '系统', result.info);
						}
					}
					else {
					}
				}
			})
			if (n) return false;
		}
		function click_h1() {
			//清空数据
			var i = 0;
			index = 0;
			flag_ajax_true = true;
			$('#userTree').find('i.h-aicon-d').removeClass('h-aicon-d');
			$('#userTree').find('ul').hide();
			$('#userTree').find('li').hide();
			$("#userTree").find('.font-red').removeClass('font-red');
			$("#userTree").find('span.h-name-red').removeClass('h-name-red');
			host_path_all = [];
			old_path_all = [];
			click_h0();
		}
		function li_hide_while_no_red(obj, num) {
			var li_visible = $(obj).children('li');
			for (var i = num; i < num + 100; i++) {
				if (i >= li_visible.length) {
					break;
				}
				var item = li_visible.eq(i);
				var span_red_time = $(item).find('span.h-name-red').length;
				if (span_red_time == 0) {
					$(item).hide();
					$(item).find('font.font-red').removeClass('font-red');
				} else if (span_red_time > 0) {
					$(item).show();
					var children_red_time = $(item).children('span.h-name-red').length;
					if (children_red_time > 0 && span_red_time == 1) {
						$(item).find('i.h-aicon-d').removeClass('h-aicon-d');
						$(item).find('ul').hide();
						$(item).find('li').show();
					}
					else if (children_red_time > 0 && span_red_time > 1) {
						$(item).find('li').show();
					}
					else if (children_red_time == 0) {
						var $children_ul = $(item).children('ul');
						li_hide_while_no_red($children_ul, 0);
					}
				}
			}
			if (i < li_visible.length) {
				setTimeout(function () { li_hide_while_no_red(obj, i); }, 1);
			}
		}
		function li_red_to_no_red(obj) {
			var red_input = $(obj).find('span.h-name-red');
			for (var im = 0; im < red_input.length; im++) {
				var item = red_input.eq(im);
				var pass = true;
				var item_name = item.siblings('input').attr('data-name');
				var Type = item.siblings('input').attr('id');
				var $span_son_font=$('.h-name-son',item).find('font');
                if(Type.indexOf('HostId')<0){
                    var span_son_name=item_name.toLowerCase();
                }else{
                    var host_span_arr=item_name.split('\t');
                    var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
                }
				find_host_arry = (search_typeall_r + search_typeall_new).split('\t');
				for (var jm = 0; jm < find_host_arry.length; jm++) {
					if (find_host_arry[jm] == '' || find_host_arry[jm] == undefined || find_host_arry[jm] == null) {
						continue;
					}
					var pass_one = false;
					var jm_index_=find_host_arry[jm].indexOf('-');
					var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
					$.each(search_arr, function (i1, item1) {
						if(find_host_arry[jm].substr(0,jm_index_)=='hostname'){
							var Name=item_name.split('\t')[1];
							if(Type.indexOf('HostId')<0){
								return false;
							}
						}else if(find_host_arry[jm].substr(0,jm_index_)=='ip'){
							var Name=item_name.split('\t')[0];
							if(Type.indexOf('HostId')<0){
							// if(item.Type!=2){
								return false;
							}
						}else if(find_host_arry[jm].substr(0,jm_index_)=='hgname'){
							var Name=item_name;
							if(Type.indexOf('HGId')<0){
							// if(item.Type!=2){
								return false;
							}
						}else{
							var Name=item_name;
						}
						if (coverString(item1, Name)) {
							item1=item1.toLowerCase();
                            if(find_host_arry[jm].substr(0, jm_index_) == 'hostname'){
                                var index_start=span_son_name.indexOf('(');
                                var index_true=span_son_name.indexOf(item1,index_start);
                                if(index_true>=0){
                                    for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
                                        $span_son_font.eq(i_red_span).addClass('font-red');
                                    }
                                }
                            }else{
                                var index_true=span_son_name.indexOf(item1);
                                if(index_true>=0){
                                    for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
                                        $span_son_font.eq(i_red_span).addClass('font-red');
                                    }
                                }
                            }
							pass_one = true;
							return false;
						}
					});
					if (pass_one == false) {
						pass = false;
						break;
					}
				}
				if (pass == false) {
					item.removeClass('h-name-red');
					$span_son_font.removeClass('font-red');
				} else {
				}
			}
		}
		var mtr = null;
		var flag_ajax_true = false;
		var _jScrollBar_array = [];
		function _jScrollBar(scid) {
			var myBar = new MyScrollBar({
				selId: scid,
				hasX: true,
				hasY: false,
				width: 6
			})
		}
		String.prototype.ResetBlank=function(){
			var regEx = /\s+/g; 
			return this.replace(regEx, ' '); 
		};
		function click_h0() {
			if (mtr != null) {
				mtr.abort();
				mtr = null;
			}
			flag_ajax_true = true;
			//条件没有的情况 直接返回
			var search_typeall_all = search_typeall_r + search_typeall_new;
			find_host_arry = search_typeall_all.split('\t');
			for (var i = 0; i < find_host_arry.length; i++) {
				if (find_host_arry[i] == '') {
					find_host_arry.splice(i, 1);
					i--;
				}
			}
			if (search_typeall_all == "") {
				_waitDone(0);
				$('#hosttree_div').scrollTop(0);
				tmp_list = null;
				first_find_index = null;
				$('#userTree').find('li').show();
				$("#userTree").find('i.h-aicon-d').removeClass('h-aicon-d');
				$("#userTree").find('ul').hide();
				$("#userTree").find('.font-red').removeClass('font-red');
				$("#userTree").find('span.h-name-red').removeClass('h-name-red');
				find_host_group_loading=false;
				return false;
			}
			_getWait();
			var hgname_str = '';
			var hostname_str = '';
			var hostip_str = '';
			var searchstring_str='';
			$.each(find_host_arry,function(i,item){
				var item_id = item.indexOf('-');
				switch (item.substr(0, item_id)) {
					case 'hgname':
						hgname_str += (item.substr(item_id + 1, item.length) + '\n');
						break;
					case 'hostname':
						hostname_str += (item.substr(item_id + 1, item.length) + '\n');
						break;
					case 'ip':
						hostip_str += (item.substr(item_id + 1, item.length) + '\n');
					case 'all':
						searchstring_str += (item.substr(item_id + 1, item.length) + '\n');
						break;
				}
			});
			// if (hgname_str!=''){
			// 	if(hostname_str=='' && hostip_str==''){
			// 		searchstring_str+=hgname_str;
			// 	}else{
			// 		if(hostname_str!=''){
			// 			searchstring_str+=hostname_str;
			// 		}
			// 		if(hostip_str!=''){
			// 			searchstring_str+=hostip_str;
			// 		}
			// 	}
			// }else{
			// 	if(hostname_str=='' && hostip_str==''){
			// 	}else{
			// 		if(hostname_str!=''){
			// 			searchstring_str+=hostname_str;
			// 		}
			// 		if(hostip_str!=''){
			// 			searchstring_str+=hostip_str;
			// 		}
			// 	}
			// }
			hgname_str = hgname_str.substr(0, hgname_str.length - 1).ResetBlank();
			hostname_str = hostname_str.substr(0, hostname_str.length - 1).ResetBlank();
			hostip_str = hostip_str.substr(0, hostip_str.length - 1).ResetBlank();
			searchstring_str = searchstring_str.substr(0, searchstring_str.length - 1).ResetBlank();

			server_find_json.hgname = hgname_str;
			server_find_json.hostname = hostname_str;
			server_find_json.hostip = hostip_str;
			server_find_json.searchstring = searchstring_str;
			mtr = $.ajax({
				url: '/bhost/find_hostgroup',
				type: "POST",
				async: true,
				data: { a0: $("input[name=se]").val(), a1: JSON.stringify(server_find_json) },
				success: function (result) {
					ajax_find_host_doing = true;
					_getWait();
					mtr = null;
					tmp_list = null;
					var result = JSON.parse(result);
					flag_ajax_true = false;
					$('#userTree').find('li').show();
					$('#userTree').children('li').hide();
					if (result.Result) {
						tmp_list = result.info;
						if (tmp_list.length != 0) {
							host_path_all = JSON.parse(JSON.stringify(tmp_list));
							flag_ajax_true = false;
							//开始过滤
							find_append();
						} else {
							flag_ajax_true = true;
							ajax_find_host_doing = false;
							find_host_group_loading=false;
							$("#server_text").blur();
							_alert(0, '搜索', '无搜索结果', $("#server_text"));
							_waitDone(0);//延迟5秒退出
							return false;
						}
					} else {
						flag_ajax_true = true;
						ajax_find_host_doing = false;
						find_host_group_loading=false;
						_alert(1, '服务器集合', result.ErrMsg);
						_waitDone(0);
						return false;
					}
				}
			});
		}
		//加载树+
		function _initList() {
			_viewHTML('#userTree');
		}
		var count_ajax = 0;
		//加载下拉树
		function _initHTML(obj, id, v, d) {
			//过滤中 不需要 showloading
			if (filter_flag_append == true) filter_flag_append = false;
			else _showLoading();
			flag_loading = true;
			var loading_hgid;
			$.ajax({
				url: '/bhost/get_hostdirectory',
				type: 'post',
				async: true,
				cache: false,
				data: { a0: $("input[name=se]").val(), a2: id, a5: edit_id, a6: type, a7: ajax_find_host_doing ? 'true' : 'false' },
				success: function (result) {
					$(obj).empty();
					var hdata = JSON.parse(result).info.data;
					loading_hgid = id;
					if (edit_id > 0 && ajax_find_host_doing == false) disabled_flag = "disabled";
					else disabled_flag = "";
					var loadfirst = 0;
					var loadlast = 0;
					var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
					var _p_loadfirst = $(obj).siblings('input').attr('data-loadfirst');
					var _p_loadlast = $(obj).siblings('input').attr('data-loadlast');
					var auth_type_checked = false;
					if ($(obj).siblings('span.authtype').find('input').length != 0) {
						auth_type_checked = $(obj).siblings('span.authtype').find('input').prop('checked');
					}
					if ((_p_loadfirst == 0) && (_p_loadlast == 0)) {
					}
					if (auth_type_checked) {
						disabled_flag = "";
					}
					if (_p_loadfirst == _p_loadlast) {
						if (_p_loadlast == 2) {
							loadfirst = 2
							loadlast = 2;
						}
					} else {
						if (_p_loadlast == 2) {
							loadlast = 2;
						}
						if (_p_loadfirst == 2) {
							loadfirst = 2;
						}

					}
					if (hdata.HGroup == null) hdata.HGroup = [];
					$.each(hdata.HGroup, function (i, item) {
						item.Mode=2;
						if (item.Mode == 2) var $auth = '<label><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" >组授权</label>';
						else var $auth = '<label style="display:none"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" >组授权</label>';
						if (ajax_find_host_doing == true && $(obj).siblings('span.h-name-red').length == 0) {
							var $H = $('<li style="display: none;"></li>');
						} else {
							var $H = $('<li></li>');
						}
						if ((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
						else i_class = "h-aicon";
						if (v == 1 && d == 0) {
							disabled_flag = "disabled";
							if (item.Mode == 2) $auth = '<label><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" >组授权</label>';
							else $auth = '<label style="display:none;"><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + '" >组授权</label>';
							$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" />'+
							'<input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g" ' + disabled_flag + ' data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="' + item.Mode + ' " data-name="' + item.HGName + '">'+
							'<i class="h-eicon h-eicon-g"></i>'+
							'<span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + 
								'<span class="h-name-son" style="">' + 
								item.HGName.split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +  
								'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">' + $auth + '</span>'+
							'<ul style="display:none">Loading...</ul>');
						} else if (v == 1) { //v == 1 d ==1
							$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" />'+
							'<input type="checkbox" checked="checked" id="HGId-' + item.HGId + '" data-check="1" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="' + item.Mode + ' " data-name="' + item.HGName + '">'+
							'<i class="h-eicon h-eicon-g"></i>'+
							'<span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + 
								'<span class="h-name-son" style="">' + 
								item.HGName.split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +  
								'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">' + $auth + '</span>'+
							'<ul style="display:none">Loading...</ul>');
						} else if (v == 0) {
							$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" />'+
							'<input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-mode="' + item.Mode + ' " data-name="' + item.HGName + '">'+
							'<i class="h-eicon h-eicon-g"></i>'+
							'<span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + 
								'<span class="h-name-son" style="">' + 
								item.HGName.split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +  
								'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">' + $auth + '</span>'+
							'<ul style="display:none">Loading...</ul>');
						} else {
							$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" />'+
							'<input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" ' + disabled_flag + ' data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false data-mode="' + item.Mode + ' " data-name="' + item.HGName + '">'+
							'<i class="h-eicon h-eicon-g"></i>'+
							'<span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + 
								'<span class="h-name-son" style="">' + 
								item.HGName.split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +  
								'</span>'+
							'</span>'+
							'<span class="authtype" style="display:inline-block">' + $auth + '</span>'+
							'<ul style="display:none">Loading...</ul>');

						}

						if (edit_id > 0) {
							if (auth_type_checked) {

							} else {
								if (push_hgid.indexOf(item.HGId + ":false") < 0) {
									push_hgid.push(item.HGId + ":false");
								}
							}
						}
						$(obj).append($H);
					});
					_checkView_host(obj);
					if (edit_id > 0) {
						select_checkbox("HGroup", parent_id);	 //只有编辑情况下 才需要判断 select 
					}
					if (hdata.Host == null) {
						hdata.Host = [];
						flag_loading = false;
						_closeLoading();
						return false;
					}
					var i = 0;
					var index = 0;
					$.each(hdata.Host, function (i, item) {
						item.Mode=2;
						if ((item.Selected == 0 && item.Mode == 0 && ajax_find_host_doing == true) || (edit_id <= 0 && item.Mode == 0)) {
							return true;
						}
						if ((ajax_find_host_doing == true && $(obj).siblings('span.h-name-red').length == 0)) {
							var $H = $('<li style="display: none;"></li>');
						} else {
							var $H = $('<li></li>');
						}
						i_class = "h-blank";
						// var HostName_h = autoAddEllipsis(item.HostName, '12');
						var HostName_h = item.HostName;
						if (v == 1 && d == 0) {
							$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" />'+
							'<input type="checkbox" checked="checked" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="1" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false disabled data-mode="' + item.Mode + '" data-name="' +  item.HostIP+ '\t' + item.HostName + '">'+
							'<i class="h-eicon h-eicon-u"></i>'+
							'<span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+item.HostId+'">' + 
								'<span class="h-name-son" style="">' + 
								( item.HostIP+ '(' + HostName_h + ')').split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +
								'</span>'+
							'</span>'+
							'<ul style="display:none">Loading...</ul>');
						} else if (v == 1) {
							$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" />'+
							'<input type="checkbox" checked="checked" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="1" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false data-mode="' + item.Mode + '" data-name="' + item.HostIP + '\t' + item.HostName + '">'+
							'<i class="h-eicon h-eicon-u"></i>'+
							'<span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+item.HostId+'">' + 
								'<span class="h-name-son" style="">' + 
								( item.HostIP+ '(' + HostName_h + ')').split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +
								'</span>'+
							'</span>'+
							'<ul style="display:none">Loading...</ul>');
						} else if (v == 0) {
							$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" />'+
							'<input type="checkbox" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="0" class="zcheck zcheck-g" data-loadfirst=' + loadfirst + ' data-loadlast=' + loadlast + ' data-ifselect=false data-mode="' + item.Mode + '" data-name="' + item.HostIP + '\t' + item.HostName + '">'+
							'<i class="h-eicon h-eicon-u"></i>'+
							'<span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+item.HostId+'">' + 
								'<span class="h-name-son" style="">' + 
								( item.HostIP+ '(' + HostName_h + ')').split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +
								'</span>'+
							'</span>'+
							'<ul style="display:none">Loading...</ul>');
						} else {
							if (ajax_find_host_doing == false) {
								$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" />'+
								'<input type="checkbox" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="0" class="zcheck zcheck-g" data-loadfirst=0  data-loadlast=' + loadlast + ' ' + disabled_flag + ' data-ifselect=false data-mode="' + item.Mode + '" data-name="' + item.HostIP + '\t' + item.HostName + '">'+
								'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
								'<span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+item.HostId+'">' + 
								'<span class="h-name-son" style="">' + 
									( item.HostIP+ '(' + HostName_h + ')').split('').map(function (params) {
										return '<font>'+params+'</font>'    
									}).join('') +
								'</span>'+
								'</span>'+
								'<ul style="display:none">Loading...</ul>');
							}
							else {
								switch (item.Selected) {
									case 0:
										$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" />'+
										'<input type="checkbox" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="0" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=0 data-loadlast=' + item.Selected + ' data-mode="' + item.Mode + '" data-name="' + item.HostIP + '\t' + item.HostName + '">'+
										'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
										'<span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+item.HostId+'">' + 
										'<span class="h-name-son" style="">' + 
											( item.HostIP+ '(' + HostName_h + ')').split('').map(function (params) {
												return '<font>'+params+'</font>'    
											}).join('') +
										'</span>'+
										'</span>'+
										'<ul style="display:none">Loading...</ul>');
										break;
									case 1:
										$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" />'+
										'<input type="checkbox" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="2" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=1 data-loadlast=' + item.Selected + ' data-mode="' + item.Mode + '" data-name="' + item.HostIP + '\t' + item.HostName + '">'+
										'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
										'<span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+item.HostId+'">' + 
										'<span class="h-name-son" style="">' + 
											( item.HostIP+ '(' + HostName_h + ')').split('').map(function (params) {
												return '<font>'+params+'</font>'    
											}).join('') +
											'</span>'+
										'</span>'+
										'<ul style="display:none">Loading...</ul>');
										break;
									case 2:
										$H.html('<i class="' + i_class + '" data-id="arrH-' + item.HostId + '" />'+
										'<input type="checkbox" checked="checked" id="HostId-' + parent_id + '-' + item.HostId + '" data-check="1" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=2 data-loadlast=' + item.Selected + ' data-mode="' + item.Mode + '" data-name="' + item.HostIP + '\t' + item.HostName + '">'+
										'<i class="h-eicon h-eicon-u" class="zcheck"></i>'+
										'<span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+item.HostId+'">' + 
										'<span class="h-name-son" style="">' + 
											( item.HostIP+ '(' + HostName_h + ')').split('').map(function (params) {
												return '<font>'+params+'</font>'    
											}).join('') +
										'</span>'+
										'</span>'+
										'<ul style="display:none">Loading...</ul>');
										break;
								}
							}
						}
						if (edit_id > 0) {
							if (auth_type_checked) {

							} else {
								if (push_hid.indexOf(parent_id + ':' + item.HostId) < 0) {
									if (ajax_find_host_doing == false) {
										push_hid.push(parent_id + ':' + item.HostId + ":false");
									}
								}
							}
						}
						$(obj).append($H);
						_checkView1($('#HostId-' + parent_id + '-' + item.HostId));
					});
					_closeLoading();
					if (ajax_find_host_doing == false) {
						select_checkbox("Host", parent_id);
					}
					flag_loading = false;
				}
			});
		}
		function _checkView1(obj) {
			_authTypeTheme($(obj).parent().find('span.authtype input'));
			$(obj).each(function () {
				var $s = $('<span class="checkbox"></span>');
				$(this).after($s);
				var v = $(this).prop('checked');
				if (v) {
					$s.addClass('checked');
				} else {
					var c = $(this).data('check');
					if (c && c == 2) {
						$s.addClass('half');
					}
				}

				var d = $(this).prop('disabled');
				if (d) {
					$s.addClass('disabled');
				}
				var span_id = $(this).siblings('span.h-name').attr('id');
				setTimeout(function () {
					if (_jScrollBar_array.indexOf(span_id) === -1) {
						_jScrollBar_array.push(span_id);
						_jScrollBar(span_id);
					}
				}, 100);
			}).on('change', function () {
				var v = $(this).prop('checked');
				var $s = $(this).next('span.checkbox');
				var $u = $(this).parent().children('ul');
				var d;
				if ($(this).siblings('span.authtype').find('input').is(':checked')) {
					d = 0;
				} else {
					d = 1;
				}

				if (v) {
					$s.attr('class', 'checkbox checked');
					$('input.zcheck', $u).prop('checked', true);
					$('span.checkbox', $u).attr('class', 'checkbox checked');
					$(this).attr("data-loadlast", "2");
					$(this).find('input.zcheck').attr('data-loadlast', 2);
				} else {
					$s.attr('class', 'checkbox');
					$('input.zcheck', $u).prop('checked', false).prop('disabled', false);
					$('span.checkbox', $u).attr('class', 'checkbox');
					$(this).siblings('span.authtype').find('input').prop('checked', false);
					$(this).siblings('span.authtype').find('span').attr('class', 'checkbox');
					$(this).siblings('span.authtype').find('span').trigger('change');
					$(this).attr("data-loadlast", "0");
				}

				_checkEvent(this);
			});
		}

		//回显下拉树
		function _viewHTML(obj) {
			$.ajax({
				url: '/bhost/get_hostdirectory',
				type: 'POST',
				async: true,
				cache: false,
				data: { a0: $("input[name=se]").val(), a2: "0", a5: edit_id, a6: type },
				success: function (result) {
					var hdata = JSON.parse(result).info.data;
					$(obj).empty();
					disabled_flag = "";
					if (edit_id > 0) disabled_flag = "disabled";
					$.each(hdata.HGroup, function (i, item) {
						item.Mode=2;
						if (item.Mode == 2)
							var $auth = '<label><input type="checkbox" name="check' + item.HGId + '" data-ifselect=false ' + disabled_flag + ' data-mode="' + item.Mode + ' " >组授权</label>';
						else
							var $auth = '';
						if (item.HGId == 1)
							var $auth = '';
						var $H = $('<li></li>');
						if ((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
						else i_class = "h-aicon";
						$H.html('<i class="' + i_class + '" data-id="arrHG-' + item.HGId + '" />'+
						'<input type="checkbox" id="HGId-' + item.HGId + '" data-check="0" class="zcheck zcheck-g" ' + disabled_flag + ' data-loadfirst=0 data-loadlast=0 data-ifselect=false data-mode="' + item.Mode + ' " data-name="' + item.HGName + '">'+
						'<i class="h-eicon h-eicon-g" ></i>'+
						'<span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">' + 
							'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+
						'</span>'+
						'<span class="authtype" style="display:inline-block">' + $auth + '</span>'+
						'<ul style="display:none">Loading...</ul>');
						$(obj).append($H);
						if (edit_id > 0) {
							if (push_hgid.indexOf(item.HGId) < 0) {
								push_hgid.push(item.HGId + ":false");
							}
						}
					});
					_checkView_host(obj);
					if (edit_id > 0) {
						select_checkbox("HGroup", 0);	 //只有编辑情况下 才需要判断 select 
					}
				}
			})

		}
		var atr = null;
		var atr_flag = 0;
		///// 绑定 主机组状态
		function select_checkbox(select_flag, pid) {
			if (select_flag == "HGroup") { //主机组 
				var i = 0;
				var index_w = 0;
				var indx = 0;
				var t_doselect;
				var c_count = 1;
				var index_a = 0;
				function _doselect() {
					index_a += 1;
					// clearTimeout(t_doselect);
					for (i = index_w; i < index_w + 200; i += 1) { //每次只加载一个 根据情况定
						if (i >= push_hgid.length) {
							if (push_hgid.length == 0) {
								clearInterval(if_select);
								return false;
							} else {
								index_w = 0;
								// t_doselect = setTimeout(function () { _doselect(); }, 1);
								return false;
							}
						}
						var PGetHNodeSelected_json = {
							"type": 1,
							"id": edit_id,
							"ishost": false,
							"hnodeset": new Array()
						}
						for (var m = i; m < i + 100; m++) {
							if (m >= push_hgid.length) {
								break;
							}
							var hg_id = push_hgid[m].split(":")[0];
							var falg_sec = push_hgid[m].split(":")[1];
							var $hg_pinput = $("#nodehg-" + hg_id).parent().parent().siblings('input');
							var hg_pid = 0;
							if ($hg_pinput.length != 0) {
								hg_pid = $hg_pinput.attr('id').split('-')[1];
								if (push_hgid.indexOf(hg_id + ':true') >= 0) {
									continue;
								}
								if (push_hgid.indexOf(hg_pid + ':false') >= 0) {
									continue;
								}
								if (push_hgid.indexOf(hg_pid + ':true') >= 0) {
									continue;
								}
							}
							if (falg_sec == 'false') {
								PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": null,"hid": ' + hg_id + '}'));
								push_hgid[m] = hg_id + ":" + "true";
							}
						}
						if (PGetHNodeSelected_json.hnodeset.length > 0) {
							$.ajax({
								url: '/bhost/PGetHNodeSelected',
								type: 'post',
								async: true,
								cache: false,
								data: { a0: $("input[name=se]").val(), z1: JSON.stringify(PGetHNodeSelected_json) },//hg_id
								success: function (result) {
									var result = JSON.parse(result);
									var data = result.info;
									$.each(data, function (i, item) {
										var _currentId = $("#HGId-" + item.hid);
										var _span_authtype = _currentId.siblings('span.authtype');
										var mode = parseInt(_currentId.attr("data-mode"));
										var p_id;
										if (_currentId.parent().parent().siblings("input").length > 0)
											p_id = _currentId.parent().parent().siblings("input").attr('id').split('-')[1];
										else p_id = 0;
										var if_change_parent = false; //主机组是否改变
										var loadlast = 0;
										var _p_loadfirst = $('#HGId-' + p_id).attr("data-loadfirst");
										var _p_loadlast = $('#HGId-' + p_id).attr("data-loadlast");
										if (_p_loadfirst == _p_loadlast) { //没改变		
										} else {
											if_change_parent = true;
											loadlast = _p_loadlast;
										}
										var gl_selected = false;
										if (item.selected == 0) {
											_currentId.next('span').attr("class", "checkbox");
											_currentId.prop('checked', false);
											_currentId.attr('data-loadfirst', item.selected);
											if (if_change_parent == false) { _currentId.attr('data-loadlast', item.selected); }
											else _currentId.attr('data-loadlast', loadlast);
										} else if (item.selected == 1) {
											_currentId.next('span').attr("class", "checkbox half");
											_currentId.prop('checked', false);
											_currentId.attr('data-loadfirst', item.selected);
											if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
											else _currentId.attr('data-loadlast', loadlast);
										} else {
											_currentId.next('span').attr("class", "checkbox checked");
											_currentId.prop('checked', true);
											_currentId.attr('data-loadfirst', item.selected);
											if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
											else _currentId.attr('data-loadlast', loadlast);

											//判断该主机组是否是 按组授权
											$.each(last_object, function (i1, item1) {
												if (item1.HGId == item.hid) {
													if (item1.HostId == null) {
														gl_selected = true;
														return false;
													}
												}
											})
										}
										if (gl_selected) {
											_span_authtype.find('input').attr('data-ifselect', true);
											_currentId.attr('data-ifselect', true);
										} else {
											_span_authtype.find('input').attr('data-ifselect', false);
											_currentId.attr('data-ifselect', false);
										}
										//判断是否隐藏按组授权

										if (mode == 0 && item.selected == 0) { //隐藏按组授权
											_span_authtype.children('label').remove();
										} else if (mode == 0 && item.selected == 1) { //隐藏按组授权
											_span_authtype.children('label').remove();
										} else if (mode == 0 && item.selected == 2) {
											if (gl_selected) _span_authtype.children('label').show();
											else _span_authtype.children('label').remove();
										} else if (mode == 2) {
											_span_authtype.children('label').show();
										}
										//如果父节点的状态改变了
										if (if_change_parent == true) {
											if (_p_loadlast == 0) { //1-0 2-0
												_currentId.next('span').attr("class", "checkbox");
												_currentId.prop('checked', false);
												_span_authtype.find('span').attr("class", "checkbox");
												_span_authtype.find('input').prop("checked", false);

												if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false) {
													_span_authtype.find('input').prop("disabled", false);
													_currentId.prop('disabled', false);
												}
												_currentId.attr('data-loadfirst', item.selected);

												if (_p_loadfirst == 2) _currentId.attr('data-loadfirst', 2);
											} else if (_p_loadlast == 2) {	 // 0-2	 1-2							
												_currentId.prop('checked', true);

												//父节点 按组授权
												if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
													_currentId.prop('disabled', true);//input
													_currentId.next('span').attr("class", "checkbox checked disabled");
													//<<<< 
													_currentId.attr("data-loadlast", "2");
													_span_authtype.find('span').attr('class', "checkbox disabled");
													_span_authtype.find('input').prop('disabled', true);

												} else { // 1-0 1-2
													_currentId.prop('disabled', false);//input
													_currentId.next('span').attr("class", "checkbox checked");
													_currentId.attr("data-loadlast", "2");
													if (gl_selected) {
														_span_authtype.find('span').attr('class', "checkbox checked");
														_span_authtype.find('input').prop('checked', true).prop('disabled', false);
													} else {
														_span_authtype.find('input').prop('disabled', false);
														_span_authtype.find('span').attr('class', 'checkbox');
													}
												}
											}
										} else {
											//父节点 按组授权
											if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
												_currentId.prop('disabled', true);//input
												_currentId.prop('checked', true);
												_currentId.next('span').attr("class", "checkbox checked disabled");

												if (_p_loadlast == 2) {
													_currentId.attr("data-loadlast", "2");
												}
												if (gl_selected) {
													_span_authtype.find('span').attr('class', "checkbox checked disabled");
													_currentId.siblings('span.authtype').find('input').prop('checked', true).prop('disabled', true);
												} else {
													_span_authtype.find('input').prop('disabled', true);
													_span_authtype.find('span').attr('class', 'checkbox disabled');
												}
											} else {
												_currentId.attr('disabled', false);//input
												_currentId.next('span').removeClass("disabled");
												if (_p_loadlast == 2) {
													_currentId.prop('checked', true);
													_currentId.attr("data-loadlast", "2");
													_currentId.attr("data-loadfirst", "2");
													_currentId.next('span').attr("class", "checkbox checked");
												}
												if (gl_selected) {
													_span_authtype.find('span').attr('class', "checkbox checked");
													_span_authtype.find('input').prop('checked', true).prop('disabled', false);
												} else {
													_span_authtype.find('input').prop('disabled', false);
													_span_authtype.find('span').attr('class', 'checkbox');
												}
											}
										}
										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')) {
											_currentId.prop('checked', true);
											_currentId.prop('disabled', true);//input
											_currentId.next('span').attr("class", "checkbox checked disabled");
											//<<<< 
											_span_authtype.find('span').addClass("disabled");
											_span_authtype.find('input').prop('disabled', true);
										}
										var ind = push_hgid.indexOf(item.hid + ":" + "true");
										if (ind != -1) {
											push_hgid.splice(ind, 1);
											i = 0;
										}
									});
									// index_w = i;
									// t_doselect = setTimeout(function () { _doselect(); }, 1);
								},
								error: function (XmlHttpRequest, textStatus, errorThrown) {
									// var ind = push_hgid.indexOf(hg_id + ":" + "true");
									// if (ind >= 0) {
									// 	push_hgid.splice(ind, 1);
									// 	push_hgid.push(hg_id + ":" + "false");
									// }
									// t_doselect = setTimeout(function () { _doselect(); }, 1);
									return false;
								}
							});
						}
						// else {
						// 	index_w = i;
						// 	t_doselect = setTimeout(function () { _doselect(); }, 1);
						// }
					}
					index_w = i;
				}
				var if_select = setInterval(function () {
					if (push_hgid.length == 0) {  //
						clearInterval(if_select);
						return false;
					}
					var f = false;
					$.each(push_hgid, function (i1, item1) {
						if (item1.split(':')[1] == "false") {
							f = true;
							return false;
						}
					})
					if (f == false) {
						clearInterval(if_select);
						return false;

					}
					_doselect();
					if (Date.parse(new Date()) / 1000 - global_time >= 1)
						setTimeout("get_msg()", 100);
				}, 10);
			}
			else if (select_flag == "Host") { //主机
				var i = 0;
				var index_w = 0;
				var indx = 0;
				var t_doselect1;
				var c_count = 700;
				function _doselect1() {
					// clearTimeout(t_doselect1);
					for (i = index_w; i < index_w + 20; i += 1) { //每次只加载一个 根据情况定
						if (i >= push_hid.length) {
							if (push_hid.length == 0) {
								clearInterval(if_select1);
								return false;
							} else {
								index_w = 0;
								i = 0;
								// t_doselect1 = setTimeout(function () { _doselect1(); }, 1);
								return false;
							}
						}
						var PGetHNodeSelected_json = {
							"type": 1,
							"id": edit_id,
							"ishost": true,
							"hnodeset": new Array()
						}
						for (var m = i; m < i + 5; m++) {
							if (m >= push_hid.length) {
								break;
							}
							var pid_h = push_hid[m].split(":")[0];
							var h_id = push_hid[m].split(":")[1];
							var falg_sec = push_hid[m].split(":")[2];
							if (push_hid.indexOf(pid_h + ':' + h_id + ":" + "true") >= 0) {
								continue;
							}
							if (push_hgid.indexOf(pid_h + ':false') >= 0) {
								continue;
							}
							if (push_hgid.indexOf(pid_h + ':true') >= 0) {
								continue;
							}
							if (falg_sec == 'false') {
								PGetHNodeSelected_json.hnodeset.push(JSON.parse('{"parentid": ' + pid_h + ',"hid": ' + h_id + '}'));
								push_hid[m] = pid_h + ':' + h_id + ":" + "true";
							}
						}

						if (PGetHNodeSelected_json.hnodeset.length > 0) {
							atr = $.ajax({
								url: '/bhost/PGetHNodeSelected',
								type: 'post',
								async: true,
								data: { a0: $("input[name=se]").val(), z1: JSON.stringify(PGetHNodeSelected_json) },//hg_id
								success: function (result) {
									var result = JSON.parse(result);
									var data = result.info;
									$.each(data, function (i, item) {
										var p_id = item.parentid;//当前组所在的父组id
										_currentId = $("#HostId-" + p_id + '-' + item.hid);//当前id
										atr_flag = 1;
										if (_currentId.length == 0) {
											return false;
										}
										var _span_authtype = _currentId.siblings('span.authtype');//当前按组授权
										var li_currentId = _currentId.parent();
										var mode = parseInt(_currentId.attr("data-mode"));
										var if_change_parent = false; //主机组是否改变
										var loadlast = 0;
										var _p_loadfirst = $('#HGId-' + p_id).attr("data-loadfirst");
										var _p_loadlast = $('#HGId-' + p_id).attr("data-loadlast");
										if (_p_loadfirst == _p_loadlast) { //没改变		
										} else {
											if_change_parent = true;
											loadlast = _p_loadlast;
										}

										//绑定 data-loadfirst状态 和 data-loadlast
										var gl_selected = false;
										if (item.selected == 0) {
											_currentId.next('span').attr("class", "checkbox");
											_currentId.prop('checked', false);
											_currentId.attr('data-loadfirst', item.selected);

											if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
											else _currentId.attr('data-loadlast', loadlast);
										} else if (item.selected == 1) {
											_currentId.next('span').attr("class", "checkbox half");
											_currentId.prop('checked', false);
											_currentId.attr('data-loadfirst', item.selected);

											if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
											else _currentId.attr('data-loadlast', loadlast);

										} else {
											_currentId.next('span').attr("class", "checkbox checked");
											_currentId.prop('checked', true);
											_currentId.attr('data-loadfirst', item.selected);

											if (if_change_parent == false) _currentId.attr('data-loadlast', item.selected);
											else _currentId.attr('data-loadlast', loadlast);
											$.each(last_object, function (i1, item1) {
												if (item1.HostId == item.hid && item1.HGId == p_id) {
													gl_selected = true;
													return false;
												}
											})
										}
										//绑定是否按组授权状态
										if (gl_selected) {
											_span_authtype.find('input').attr('data-ifselect', true);
											_currentId.attr('data-ifselect', true);
										} else {
											_span_authtype.find('input').attr('data-ifselect', false);
											_currentId.attr('data-ifselect', false);
										}
										//判断是否隐藏主机 因为存在 当前用户的管理权限 加了这个

										if (tmp_list == null) {
											if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
												if (mode != 0 || item.selected != 0) {
													_currentId.attr('data-mode', '2');
													li_currentId.show();
												} else {
													li_currentId.remove();
												}

											} else {
												if (mode == 0 && item.selected == 0) { //隐藏主机
													li_currentId.remove();
												} else if (mode == 0 && item.selected == 1) { //隐藏主机
													_currentId.attr('data-mode', '2');
													li_currentId.show();
												} else if (mode == 0 && item.selected == 2) {
													_currentId.attr('data-mode', '2');
													li_currentId.show();
												} else if (mode == 2) {
													li_currentId.show();
												}
											}
										} else {
											li_currentId.hide();
											if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
												if (mode != 0 || item.selected != 0) {
													_currentId.attr('data-mode', '2');
													li_currentId.show();
												} else {
													li_currentId.remove();
												}

											} else {
												if (mode == 0 && item.selected == 0) { //隐藏主机
													li_currentId.remove();
												} else if (mode == 0 && item.selected == 1) { //隐藏主机
													_currentId.attr('data-mode', '2');
													li_currentId.show();
												} else if (mode == 0 && item.selected == 2) {
													_currentId.attr('data-mode', '2');
													li_currentId.show();
												} else if (mode == 2) {
													li_currentId.show();
												}
											}
										}
										//查看 父节点 是否是 1、全选还是空 2、是否按组授权 勾选 / disabled
										if (if_change_parent) {
											if (_p_loadlast == 0) {
												_currentId.next('span').attr("class", "checkbox");
												_currentId.prop('checked', false);
												_span_authtype.find('span').attr("class", "checkbox");
												_span_authtype.find('input').prop("checked", false);
												if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == false) {
													_span_authtype.find('input').prop("disabled", false);
													_currentId.prop('disabled', false);
												}
												if (_p_loadfirst == 2) _currentId.attr('data-loadfirst', 2);

											} else if (_p_loadlast == 2) {
												_currentId.prop('checked', true);

												//父节点 按组授权
												if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
													_currentId.prop('disabled', true);//input
													_currentId.next('span').attr("class", "checkbox checked disabled");
													_currentId.attr("data-loadlast", "2");
													_span_authtype.find('input').prop('disabled', true);
													_span_authtype.find('span').attr('class', 'checkbox disabled');

												} else {
													_currentId.prop('disabled', false);//input
													_currentId.next('span').attr("class", "checkbox checked");
													_currentId.attr("data-loadlast", "2");
													if (gl_selected) {
														_span_authtype.find('span').attr('class', "checkbox checked");
														_span_authtype.find('input').prop('checked', true).prop('disabled', false);
													} else {
														_span_authtype.find('input').prop('disabled', false);
														_span_authtype.find('span').attr('class', 'checkbox');
													}
												}
											}
										} else {
											//父节点 按组授权
											if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('checked') == true) {
												_currentId.prop('disabled', true);//input
												_currentId.next('span').attr("class", "checkbox checked disabled");
												if (_p_loadlast == 2) {
													_currentId.prop('checked', true);
													_currentId.attr("data-loadlast", "2");
												}
												if (gl_selected) {
													_span_authtype.find('span').attr('class', "checkbox checked disabled");
													_span_authtype.find('input').prop('checked', true).prop('disabled', true);
												} else {
													_span_authtype.find('input').prop('disabled', true);
													_span_authtype.find('span').attr('class', 'checkbox disabled');
												}

											} else {
												_currentId.prop('disabled', false);//input
												_currentId.next('span').removeClass("disabled");
												if (_p_loadlast == 2) {
													_currentId.prop('checked', true);
													_currentId.next('span').attr("class", "checkbox checked");
													_currentId.attr("data-loadlast", "2");
													_currentId.attr("data-loadfirst", "2");
												}
												if (gl_selected) {
													_span_authtype.find('span').attr('class', "checkbox checked");
													_span_authtype.find('input').prop('checked', true).prop('disabled', false);
												} else {
													_span_authtype.find('input').prop('disabled', false);
													_span_authtype.find('span').attr('class', 'checkbox');
												}

											}
										}
										//发现父主机组是disabled
										if (_currentId.parent().parent().siblings('span.authtype').find('input').prop('disabled')) {
											_currentId.prop('checked', true);
											_currentId.prop('disabled', true);//input
											_currentId.next('span').attr("class", "checkbox checked disabled");
											//<<<< 
											_span_authtype.find('span').addClass("disabled");
											_span_authtype.find('input').prop('disabled', true);
										}
										var ind = push_hid.indexOf(p_id + ':' + item.hid + ":" + "true");
										if (ind != -1) {
											push_hid.splice(ind, 1);
											i = 0;
										}
									});
									// index_w = i;
									// t_doselect1 = setTimeout(function () { _doselect1(); }, 1);
								},
								error: function (XmlHttpRequest, textStatus, errorThrown) {
									// t_doselect1 = setTimeout(function () { _doselect1(); }, 1);
									return false;
								}
							});

						}
						// else {
						// 	index_w = i;
						// 	t_doselect1 = setTimeout(function () { _doselect1(); }, 1);
						// }
					}
					index_w = i;
				}
				// _doselect1();
				var if_select1 = setInterval(function () {
					if (push_hid.length == 0) {  //
						clearInterval(if_select1);
						return false;
					}
					var ff = false;
					$.each(push_hid, function (i1, item1) {
						if (item1.split(':')[2] == "false") {
							ff = true;
						}
					})
					if (ff == false) {
						clearInterval(if_select1);
						return false;

					}

					_doselect1();
					setTimeout("get_msg()", 100);
				}, 10);
			}
		}


		//
		function _authTypeTheme(obj) {
			$.each(obj, function (i, item) {
				var $_item = $(item);

				if ($_item.parent().children('span').length == 0) {
					$_item.after('<span class="checkbox"></span>');
				}
				var $s = $_item.next('span');
				var checked = $_item.prop('checked');
				var disabled = $_item.prop('disabled');
				if (checked) {
					$s.addClass('checked');
				} else {
					$s.removeClass('checked');
				}
				if (disabled) {
					$s.addClass('disabled');
				} else {
					$s.removeClass('disabled');
				}
			})
		}
		function _checkView_host(obj) {
			_authTypeTheme($('span.authtype input', obj));
			$('input.zcheck', obj).each(function () {
				var $s = $('<span class="checkbox"></span>');
				$(this).after($s);
				var v = $(this).prop('checked');
				if (v) {
					$s.addClass('checked');
				} else {
					var c = $(this).data('check');
					if (c && c == 2) {
						$s.addClass('half');
					}
				}

				var d = $(this).prop('disabled');
				if (d) {
					$s.addClass('disabled');
				}
				var span_id = $(this).siblings('span.h-name').attr('id');
				setTimeout(function () {
					if (_jScrollBar_array.indexOf(span_id) === -1) {
						_jScrollBar_array.push(span_id);
						_jScrollBar(span_id);
					}
				}, 100);
			}).on('change', function () {
				var v = $(this).prop('checked');
				var $s = $(this).next('span.checkbox');
				var $u = $(this).parent().children('ul').find('li');
				var $authInput = $(this).siblings('span.authtype').find('input');

				if (v) {
					$s.attr('class', 'checkbox checked');
					$('input.zcheck', $u).prop('checked', true);
					$('span.checkbox:first', $u).attr('class', 'checkbox checked');
					$(this).attr("data-loadlast", 2);
					$('input.zcheck', $u).attr("data-loadlast", 2);
					$u.each(function () {
						if ($(this).children('span.authtype').find('input').prop('checked')) {
							var $u_li = $(this).children('ul').find('li');
							$('input.zcheck', $u_li).prop('disabled', true);
							$('span.checkbox:first', $u_li).addClass('disabled');
						};
					});
				} else {
					$s.attr('class', 'checkbox');
					$('input', $u).prop('checked', false).prop('disabled', false);
					$('span.checkbox', $u).attr('class', 'checkbox');
					$(this).attr("data-loadlast", 0);
					$('input.zcheck', $u).attr("data-loadlast", 0);

					$authInput.prop('checked', false).trigger('change');
					$(this).siblings('span.authtype').find('span').attr('class', 'checkbox');
				}
				_checkEvent(this);
			});
		}

		//选中后树的input check变化
		function _checkEvent(obj) {
			var _run = function () {
				var $li = $(obj).parent().parent().parent();
				var tagname = $li[0].tagName.toLowerCase();
				var v = $(obj).prop('checked');
				if (tagname == 'li') {
					var c1 = 0, c2 = 0;
					var len = $(obj).parent().parent().children('li').length;
					$(obj).parent().parent().children('li').each(function () {
						var c = $(this).children('span.checkbox').attr('class');
						if (c.indexOf('checked') > 0) {
							c1++;
						} else if (c.indexOf('half') > 0) {
							c2++;
						}

						if (c1 == len) {
							var span_class = $li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class');
							var d_class = "";
							if (span_class.indexOf('disabled') != -1) {
								d_class = 'disabled';
							}
							var attr_class = 'checkbox checked ' + d_class;
							$li.children('input.zcheck').prop('checked', true).siblings('span.checkbox').attr('class', attr_class);
							$li.children('input.zcheck').attr("data-loadlast", 2);
						} else if (c1 == 0 && c2 == 0) {
							$li.children('input.zcheck').prop('checked', false).prop('disabled', false).siblings('span.checkbox').attr('class', 'checkbox').removeClass('disabled');
							$li.children('input.zcheck').attr("data-loadlast", 0);
							$li.children('input.zcheck').siblings('span.authtype').children('input').prop('checked', false).siblings('span.checkbox').attr('class', 'checkbox');
						} else {
							var span_class = $li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class');
							var d_class = "";
							if (span_class.indexOf('disabled') != -1) {
								d_class = 'disabled';
							}
							var attr_class = 'checkbox half ' + d_class;
							$li.children('input.zcheck').prop('checked', false).siblings('span.checkbox').attr('class', attr_class);
							$li.children('input.zcheck').attr("data-loadlast", 1);
						}
					});
					_checkEvent($li.children('input.zcheck'));
				} else {
					return;
				}
			}
			_run();
		}

		function _getWait() {
			if (typeof waitDonelayer != 'undefined') {
				layer.close(waitDonelayer);
			}

			$('#waitTip').removeClass('done').show().unbind().on('mouseover', function () {
				waitlayer = layer.tips('搜索中', this, {
					tips: 1,
					time: 0,
					skin: 'waitlayer'
				});
			}).on('mouseout', function () {
				if (typeof waitlayer != 'undefined') {
					layer.close(waitlayer);
				}
			});
			// //完成
			// setTimeout(function(){
			// 	_waitDone();
			// },3000)
		}
		function _waitDone(num) {
			if (typeof waitlayer != 'undefined') {
				layer.close(waitlayer);
			}
			if (num == 0) {
				$('#waitTip').stop();
				$('#waitTip').hide();
			} else {
				$('#waitTip').fadeOut(num);
			}
			if (typeof waitDonelayer != 'undefined') {
				layer.close(waitDonelayer);
			}
		}
		//加入搜索
		function _addFilter(obj, type) {
			if(find_host_group_loading){
				_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
				return false;
			}
			var id = $(obj).parent().children('select').children('option:selected').val();
			var v1 = $(obj).parent().children('select').children('option:selected').text();
			var v2 = $(obj).parent().children('input[type=text]').val().trim();
			if(id=='all'){
				v1='';
			}else{
				v1=v1+'-';
			}
			if (v2 == '') {
				$(obj).parent().children('input[type=text]').blur();
				_alert(2, '搜索', '请输入关键字', $(obj).parent().children('input[type=text]'));
				return false;
			} else {
				switch (id) {
					case 'hgname':
						var Reg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.\s]+$/;
						break;
					case 'hostname':
						var Reg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.\s]+$/;
						break;
					case 'ip':
						var Reg = /^[0-9\.\s]+$/;
						break;
				}
				if (id!='all' && !Reg.test(v2) ) {
					$(obj).parent().children('input[type=text]').blur();
					_alert(1, '搜索', '关键字格式不正确', $(obj).parent().children('input[type=text]'));
					return false;
				}
				if (search_typeall_r.indexOf(id + '-' + v2 + '\t') >= 0) {
					$(obj).parent().children('input[type=text]').blur();
					_alert(2, '搜索', '相同的关键字已存在', $(obj).parent().children('input[type=text]'));
					return false;
				}
				if (type) {
					var type_value=(search_typeall_new==id + '-' + v2 + '\t');
					search_typeall_r = search_typeall_r + id + '-' + v2 + '\t';
					search_typeall_new = '';
					$('#filterWW>ul').append('<li style="height: 18px;"><span style = "display:none;">' + id + '-' + v2 + '</span><span class="ww" title="' + v1+ v2 + '">' + v1+ v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter(this);"></i></li>')
					$("#server_text").val("");
					$('#server_text_check').hide();
					selView(type_value);
				} else {
					if(search_typeall_new == id + '-' + v2 + '\t'){
						return false;
					}
					search_typeall_new = id + '-' + v2 + '\t';
					find_hostgroup();
				}

			}
		}
		//删除搜索
		function _delFilter(obj) {
			if(find_host_group_loading){
				_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
				return false;
			}
			var id = $(obj).parent().find("span");
			var ids = $(id).eq(0).text();
			search_typeall_r = search_typeall_r.replace(ids + '\t', '');
			var server_text = $('#server_text').val().trim();
			$(obj).parent().remove();
			selView();
		}
		function _clearFilter(obj,num) {
			if(find_host_group_loading){
				_alert(2, "搜索", "正在搜索中，请先等待搜索完成");
				return false;
			}
			if(num==1){
			$('#server_text').val('');
			$('#server_text_check').hide();
			search_typeall_new = '';
			selView();
			return;
			}
			$('#clearFilter').next().children('ul').empty();
			$('#server_text').val('');
			$('#server_text_check').hide();
			$('#clearFilter').hide();
			search_typeall_new = '';
			search_typeall_r = '';
			selView();
		}
		//显示搜索条件
		function selView(type_value) {
			var $sel = $('#filterWW');
			var len = $('li', $sel).length;
			if (len == 0) {
				$sel.hide();
				$('#clearFilter').hide();
			} else {
				$("#filterWW").show();
				$('#clearFilter').show();
				$('>span.ww', $sel).show();
				$sel.addClass('selector-multiple');
			}
			if(!type_value){
				find_hostgroup();
			}
		}
		//删除ip
		function _delIp(obj) {
			var $c = $(obj).parent();
			$c.fadeOut(function () {
				$c.remove();
			});
		}
		//加入ip
		function _addIp(obj) {
			var pass = 1;
			var v1 = $(obj).prev().val().trim();
			var v = $(obj).prev().prev().prev().val().trim();

			if (v == '') {
				_alert(2, '服务器集合', '请输入起始IP地址', $(obj).prev().prev().prev());
				return false;
			} else if (!ipReg.test(v)) {
				_alert(1, '服务器集合', '起始IP地址格式不正确', $(obj).prev().prev().prev());
				return false;
			}
			if (v1 == '') {
				_alert(2, '服务器集合', '请输入结束IP地址', $(obj).prev());
				return false;
			} else if (!ipReg.test(v1)) {
				_alert(1, '服务器集合', '结束IP地址格式不正确', $(obj).prev());
				return false;
			}
			if (v == v1) {
				_alert(1, '服务器集合', '起始IP地址不能大于等于结束IP地址', $(obj).prev().prev().prev());
				return false;
			}
			$('>span[class=ss]', '#ip_n').each(function () {
				var input1 = $(this).find('input').eq(0).val();
				var input2 = $(this).find('input').eq(1).val();
				if (input1 == v && input2 == v1) {
					_alert(2, '服务器集合', '相同的IP区间已存在', $(obj).prev().prev().prev());
					pass = 0;
					return false;
				}
			});
			//add zero
			var v_str = v.split(".");
			var v1_str = v1.split(".");
			for (var i = 0; i < 4; i++) {
				if (parseInt(v_str[i]) > parseInt(v1_str[i])) {
					_alert(1, '服务器集合', '起始IP地址不能大于等于结束IP地址', $(obj).prev().prev().prev());
					return false;
				} else if (parseInt(v_str[i]) < parseInt(v1_str[i])) {
					break;
				}
			}
			if (pass == 1) {
				var ip_id = $("#ip_span").attr("value");
				var $c = $('<span class="ss" value="' + ip_id + '" style="float: left;width: 312px;position: static;padding: 0 0 10px 0;"/>');
				$c.html('<input type="text" class="form-text form-text2" value="' + v + '"  style="width:122px;">'
					+ '<span style="vertical-align:middle;padding-left: 4px;padding-right: 4px;">-</span>'
					+ '<input type="text" class="form-text form-text2" value="' + v1 + '"  style="width:122px;">'
					+ '<i class="ctr ctr-del" style="    margin-top: 5px;margin-left: -3px;" onclick="_delIp(this)"></i>');
				$(obj).parent().after($c);
				$(obj).prev().val("");
				$(obj).prev().prev().prev().val("");
				$(obj).prev().prev().prev().focus();
				$("#ip_span").attr("value", "0");
			}
		}
		//加入ip
		function _addIp1(obj) {
			var pass = 1;
			var v = $(obj).prev('input').val().trim();

			if (v == '') {
				_alert(2, '服务器集合', '请输入IP地址', $(obj).prev('input'));
				return false;
			} else if (!ipReg.test(v)) {
				_alert(1, '服务器集合', 'IP地址格式不正确', $(obj).prev('input'));
				return false;
			} else {
				$(">span[class='ss']", "#ip_n1").each(function () {
					ip_str = $(this).find("input").val();
					if (ip_str == v) {
						_alert(2, '服务器集合', '相同的IP地址已存在', $(obj).prev('input'));
						pass = 0;
						return false;
					}
				});
			}
			var ip_id = $("#ip_span1").attr("value");
			if (pass == 1) {
				var $c = $('<span class="ss" value="' + ip_id + '" style="float: left;position: static;padding: 0 0 10px 0;"/>');
				$c.html('<input type="text" class="form-text form-text2" style="width:122px;" value="' + v + '" >'
					+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="    margin-top: 4px;    margin-left: -3px;"></i>');
				$(obj).parent().after($c);
				$(obj).prev('input').val("");
				$(obj).prev('input').focus();
				$("#ip_span1").attr("value", "0");
			}
		}
		function save_server_hg_host(obj, id) {
			$(">li", obj).children('input').each(function () {
				var input_id = $(this).attr('id');
				var input_str = input_id.split('-');
				var input_state = $(this).next('span.checkbox').attr('class');
				var radio_value = $(this).siblings('span.authtype').find('input');
				var $u = $(this).parent().children('ul');
				if (input_state.indexOf('checked') > 0) {
					if (radio_value.is(':checked') && input_str[1] != '1' && input_str[0] == "HGId") {
						var json_a = '{"HGId":' + input_str[1] + ',"HostId":null,"IsGroupAuth": true}';
						server.HostList.push(JSON.parse(json_a));
					} else {
						if (input_str[0] == "HGId") {
							var json_a = '{"HGId":' + input_str[1] + ',"HostId":null,"IsGroupAuth": false}';
							server.HostList.push(JSON.parse(json_a));
							if ($u.text() != "Loading..." && $u.text() != "") {
								save_server_hg_host($u, input_str[1]);
							}
						} else {
							var json_a = '{"HGId":' + id + ',"HostId":' + input_str[2] + '}';
							server.HostList.push(JSON.parse(json_a));
						}
					}
				} else if (input_state.indexOf('half') > 0) {
					if ($u.text() != "Loading..." && $u.text() != "") {
						save_server_hg_host($u, input_str[1]);
					} else {
						$.ajax({
							url: '/bhost/get_all_hg',
							type: "POST",
							async: false,
							data: { a0: $("input[name=se]").val(), a1: input_str[1] },
							success: function (result) {
								var result = JSON.parse(result.replace(/L/g,''));
								if (result.Result == true) {
									$.each(server_edit.HostList, function (i, item) {
										if ($.inArray(item.HGId,result.info)>=0){
											if(item.HostId != null) {
												var json_a = '{"HGId":' + item.HGId + ',"HostId":' + item.HostId + '}';
												server.HostList.push(JSON.parse(json_a));
											}else{
												var json_a = '{"HGId":' + item.HGId + ',"HostId":null,"IsGroupAuth": true}';
												server.HostList.push(JSON.parse(json_a));
											}
										}
									});
								}else{
									_alert(2,'服务器集合',result.ErrMsg);
								}
							}
						});
						
					}
				}
			});
		}
		//创建
		function server_add() {
			var ip_section = 1;
			var ip_num = 1;
			var host_group = 1;
			var pass = 1;
			var d_n = $('#d_n').val();
			if (d_n == "") {
				_alert(2, '服务器集合', '请输入名称', $('#d_n'));
				return false;
			} else if (!nameReg.test(d_n)) {
				_alert(1, '服务器集合', '名称格式不正确', $('#d_n'));
				return false;
			}
			var $all = $('#ip_n1').find('span.ss');
			////console.log($all.length);
			for (var i = 0; i < $all.length; i++) {
				var ip_str = $all.eq(i).find("input").val().trim();
				////console.log(i + ':' + ip_str + ':' + $all.length);
				if (i == 0 && ip_str == '' && $all.length == 1) {
					ip_num = 0;
				} else if (i != 0 && ip_str == '') {
					_alert(2, '服务器集合', '请输入IP地址', $all.eq(i).find("input"));
					return false;
				} else if (ip_str != '' && (!ipReg.test(ip_str) || ip_str == '0.0.0.0' || ip_str == '255.255.255.255')) {
					_alert(1, '服务器集合', 'IP地址格式不正确', $all.eq(i).find("input"));
					return false;
				}
				for (var j = i + 1; j < $all.length; j++) {
					var ip_str_2 = $all.eq(j).find("input").val().trim();
					if (ip_str_2 != '' && ip_str == ip_str_2) {
						_alert(2, '服务器集合', '相同的IP地址已存在', $all.eq(i).find("input"));
						return false;
					}
				}
			}
			var v = $("#ip_n").find("span[class='ss ss-add']").children("input").first().val().trim();
			var v1 = $("#ip_n").find("span[class='ss ss-add']").children('input').last().val().trim();
			var $all = $('#ip_n').find('span.ss');
			////console.log($all.length);
			for (var i = 0; i < $all.length; i++) {
				var input1 = $all.eq(i).find('input').first().val().trim();
				var input2 = $all.eq(i).find('input').last().val().trim();
				////console.log(i + ':' + input1 + ':' + input2 + ':' + $all.length);
				if (i == 0 && input1 == "" && input2 == "" && $all.length == 1) {
					ip_section = 0;
				} else if (i != 0 && input1 == "") {
					_alert(2, '服务器集合', '请输入起始IP地址', $all.eq(i).find('input').first());
					return false;
				} else if (input1 != '' && (!ipReg.test(input1) || input1 == '0.0.0.0' || input1 == '255.255.255.255')) {
					_alert(1, '服务器集合', '起始IP格式不正确', $all.eq(i).find('input').first());
					return false;
				} else if (i != 0 && input2 == "") {
					_alert(2, '服务器集合', '请输入结束IP地址', $all.eq(i).find('input').last());
					return false;
				} else if (input2 != '' && (!ipReg.test(input2) || input2 == '0.0.0.0' || input2 == '255.255.255.255')) {
					_alert(1, '服务器集合', '结束IP格式不正确', $all.eq(i).find('input').last());
					return false;
				} else if (input1 != '' && input2 != '' && input1 == input2) {
					_alert(1, '服务器集合', '起始IP地址不能大于等于结束IP地址', $all.eq(i).find('input').first());
					return false;
				} else if (input1 != '' && input2 != '') {
					var v_str = input1.split(".");
					var v1_str = input2.split(".");
					for (var m = 0; m < 4; m++) {
						if (parseInt(v_str[m]) > parseInt(v1_str[m])) {
							_alert(1, '服务器集合', '起始IP地址不能大于等于结束IP地址', $all.eq(i).find('input').first());
							return false;
						} else if (parseInt(v_str[m]) < parseInt(v1_str[m])) {
							break;
						}
					}
				}
				for (var j = i + 1; j < $all.length; j++) {
					var input1_j = $all.eq(j).find('input').first().val().trim();
					var input2_j = $all.eq(j).find('input').last().val().trim();
					if (input1 != '' && input2 != '' && input1 == input1_j && input2 == input2_j) {
						_alert(2, '服务器集合', '相同的IP区间已存在', $all.eq(i).find("input").first());
						return false;
					}
				}
			}
			server.HostList = new Array();
			////console.log(server_edit);
			save_server_hg_host($("#userTree"), 0);
			////console.log(server);
			if (server.HostList.length == 0) {
				host_group = 0;
			}
			if (host_group == 0 && ip_section == 0 && ip_num == 0 && $("#part1").prop('checked') == true) {
				_alert(2, '服务器集合', '请输入IP或选择主机', $("#ip_n1").find("span[class='ss ss-add']").children("input"));
				return false;
			}else if($("#part1").prop('checked') == false && host_group == 0){
				_alert(2, '服务器集合', '请输入IP或选择主机');
				return false;
			}
			if (pass == 1) {
				server.ServerScopeId = edit_id;
				server.ServerScopeName = d_n;
				server.IPList.Set = new Array();
				var i = 1;
				var $all = $('#ip_n').find('span.ss');
				var len = $all.length;
				for (var j = len - 1; j >= 0; j--) {
					var ip_id = $all.eq(j).attr("value");
					var $v = $all.eq(j).find('input');
					var input_0 = $v.eq(0).val();
					var input_1 = $v.eq(1).val();
					if (input_0 == '' || input_1 == '') {
						continue;
					}
					var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + input_0 + '","EndIP":"' + input_1 + '"}';
					server.IPList.Set.push(JSON.parse(json_a));
					i++;
				}

				var $all = $('#ip_n1').find('span.ss');
				var len = $all.length;
				for (var j = len - 1; j >= 0; j--) {
					var ip_id = $all.eq(j).attr("value");
					var ip_str = $all.eq(j).find("input").val();
					if (ip_str == '') {
						continue;
					}
					var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + ip_str + '","EndIP":"' + ip_str + '"}';
					server.IPList.Set.push(JSON.parse(json_a));
					i++;
				}
				if($("#part1").prop('checked') == false){
					server.EnableIPLimit = 0;
				}else{
					server.EnableIPLimit = 1;
				}
				server.IsApplyToClientScope = false;
				save_server(server);
			}
		}
		function save_server(server) {
			_showLoading();
			msstr = aceg(JSON.stringify(server),$("input[name=se]").val());
			$.ajax({
				url: '/bhost/add_server',
				type: "POST",
				async: true,
				data: { a0: $("input[name=se]").val(), a1: JSON.stringify(server),a4:'{{module_name}}',m1:msstr },
				success: function (result) {
					var result = JSON.parse(result);
					_closeLoading();
					if (result.Result == true) {
						$('.btn').blur(); parent.layer.open({
							type: 1,
							title: '服务器集合',
							content: '<div class="layer-alert"><i class="alert succ"></i>操作成功</div>',
							btn: ['确&nbsp;&nbsp;定'],
							btnAlign: 'c',
							closeBtn: false,
							skin: 'layer-custom',
							area: ['380px', '310px'],
							move: false,
							resize: false,
							yes: function (i) {
								parent.layer.close(i);
								server_list(1, result.ServerScopeId);
							}
						});
					} else {
						_alert(1, '服务器集合', result.ErrMsg, $("#d_n"));
						return false;
					}
				}
			});
		}
		//显示列表页面
		function server_list(num, id) {
			if (num == 1) {
				$.ajax({
					url: '/bhost/PGetRecordRownum',
					type: "POST",
					async: false,
					data: { a0: $("input[name=se]").val(), a1: id, a2: 19 },
					success: function (result) {
						var result = JSON.parse(result);
						if (result.Result == true) {
							if (result.info % MAX_PAGE == 0) {
								document.frm_server_add.paging.value = parseInt(result.info / MAX_PAGE);
							} else {
								document.frm_server_add.paging.value = parseInt(result.info / MAX_PAGE) + 1;
							}
						}
					}
				});
				document.frm_server_add.search_typeall.value = '';
				document.frm_server_add.e.value = ':';
			}
			document.frm_server_add.tasktype.value = 3;
			document.frm_server_add.action = '/bhost/server_handle'
			document.frm_server_add.submit();

		}
		/* 
		* 处理过长的字符串，截取并添加省略号 
		* 注：半角长度为1，全角长度为2 
		*  
		* pStr:字符串 
		* pLen:截取长度 
		*  
		* return: 截取后的字符串 
		*/
		function autoAddEllipsis(pStr, pLen) {
			var _ret = cutString(pStr, pLen);
			var _cutFlag = _ret.cutflag;
			var _cutStringn = _ret.cutstring;

			if ("1" == _cutFlag) {
				return _cutStringn + "...";
			} else {
				return _cutStringn;
			}
		}
		/* 
		* 取得指定长度的字符串 
		* 注：半角长度为1，全角长度为2 
		*  
		* pStr:字符串 
		* pLen:截取长度 
		*  
		* return: 截取后的字符串 
		*/
		function cutString(pStr, pLen) {
			// 原字符串长度  
			var _strLen = pStr.length;

			var _tmpCode;

			var _cutString;

			// 默认情况下，返回的字符串是原字符串的一部分  
			var _cutFlag = "1";

			var _lenCount = 0;

			var _ret = false;

			if (_strLen <= pLen / 2) {
				_cutString = pStr;
				_ret = true;
			}

			if (!_ret) {
				for (var i = 0; i < _strLen; i++) {
					if (isFull(pStr.charAt(i))) {
						_lenCount += 2;
					} else {
						_lenCount += 1;
					}

					if (_lenCount > pLen) {
						_cutString = pStr.substring(0, i);
						_ret = true;
						break;
					} else if (_lenCount == pLen) {
						_cutString = pStr.substring(0, i + 1);
						_ret = true;
						break;
					}
				}
			}

			if (!_ret) {
				_cutString = pStr;
				_ret = true;
			}

			if (_cutString.length == _strLen) {
				_cutFlag = "0";
			}

			return { "cutstring": _cutString, "cutflag": _cutFlag };
		}

		/* 
		* 判断是否为全角 
		*  
		* pChar:长度为1的字符串 
		* return: true:全角 
		*          false:半角 
		*/
		function isFull(pChar) {
			if ((pChar.charCodeAt(0) > 128)) {
				return true;
			} else {
				return false;
			}
		}
		$(function () {

			$("#host_group").on("click", function () {
				location.reload();
			});
		});

	</script>
</body>

</html>
