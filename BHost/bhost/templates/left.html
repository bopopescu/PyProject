{% extends "index.html" %}
{% block head %}
<script src="/manage/js/xSelect.js"></script>
<script src="/manage/js/jquery.jedate.min.js"></script>
<script src="/manage/js/underscore-1.8.2.min.js"></script>
<script src="/manage/js/base64.js"></script>

<link rel="stylesheet" href="/manage/css/jedate.css">
<link rel="stylesheet" href="/manage/css/G-style.css">
{% endblock %}
{% block main %}
<!--left-->
<div class="sider">
	<div class="top-logo">
		<img src="/manage/images/logo-top.png" alt="">
	</div>

	<nav class="nav-s nav-s1" id="nav-s1" style="display: none">
		<ul>
			<li data-modeid="1"><a class="active" href="javascript:;" onclick="reheight(1);JumpToMonitor();"><i class="icon1"></i></a></li>
			<li data-modeid="2"><a href="javascript:;" onclick="reheight()" data-url="/bhost/_search_index1?tasktype=0&a0={{se}}" target="mainFrame"><i class="icon2"></i></a></li>
			<li data-modeid="3"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=2&us={{us}}&se={{se}}" target="mainFrame"><i class="icon3"></i></a></li>
			<li data-modeid="4"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=3&us={{us}}&se={{se}}" target="mainFrame"><i class="icon4"></i></a></li>
			<li data-modeid="5"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=4&us={{us}}&se={{se}}" target="mainFrame"><i class="icon5"></i></a></li>
			<li data-modeid="6"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=5&us={{us}}&se={{se}}" target="mainFrame"><i class="icon6"></i></a></li>
			<li data-modeid="7"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=6&us={{us}}&se={{se}}" target="mainFrame"><i class="icon7"></i></a></li>
		</ul>
	</nav>
	<nav class="nav-s nav-s2" id="nav-s2" style="display: none">
		<ul>
			<!-- <li data-modeid="8"><a class="active" href="javascript:;" data-url="/bhost/index?tasktype=7&us={{us}}&se={{se}}" target="mainFrame"><i class="icon8"></i></a></li> -->
			<li data-modeid="15"><a class="active" href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=9&us={{us}}&se={{se}}" target="mainFrame"><i class="icon10"></i></a></li>
			<li data-modeid="12"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=15&us={{us}}&se={{se}}" target="mainFrame"><i class="icon15"></i></a></li>
			<li data-modeid="10"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=11&us={{us}}&se={{se}}" target="mainFrame"><i class="icon12"></i></a></li>
			<li data-modeid="9"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=8&us={{us}}&se={{se}}" target="mainFrame"><i class="icon9"></i></a></li>
			<li data-modeid="13"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=14&us={{us}}&se={{se}}" target="mainFrame"><i class="icon13"></i></a></li>
			<li data-modeid="11"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=10&us={{us}}&se={{se}}" target="mainFrame"><i class="icon11"></i></a></li>
			<li data-modeid="14"><a href="javascript:;" onclick="reheight()" data-url="/bhost/index?tasktype=20&us={{us}}&se={{se}}" target="mainFrame"><i class="icon14"></i></a></li>
		</ul>
	</nav>
</div>

<div class="rwrap1">
	<!---->
	<div class="header-s">
		<!-- this is logout -->
		<a class="header-lock" href="javascript:;" onclick="logout();" title="退出"><i></i>退出</a>
		<!-- this is down -->
		<a class="header-down" href="javascript:;" id="" onclick="related_downloads_show();" title="相关下载"><i></i>相关下载</a>
		<!--this is 测试工具 -->
		<a class="header-terminal" href="javascript:;" id="" onclick="terminal_show();" title="测试工具"><i></i>测试工具</a>
		
		<!-- this is lock -->
		<a class="header-logout" href="javascript:;" id="lockPage" onclick="lock_page(0);" title="锁定"><i></i>锁定</a>

		<div class="bell" onclick="show_msg_list()" title="系统邮箱"><a href="javascript:;"><span class="i"><sup id="msg_num"
					 style="display: none;">0</sup></span></a></div>

		<div class="user-i">
			<a class="s" href="javascript:;" id="u_i" onClick="user_info('{{us}}')"></a>
			<a class="s" href="javascript:;" id="MonitorStyle" value="1" style="display: none;"></a>
		</div>
		<div class="user-switch" style="display: none">
			<span class="tit" id="switchPage">管理</span>
			<div class="dropdown" id="switchPage_button">
				<ul>
					<li><a href="javascript:;" onclick="manage_page(this)"><i class="s0"></i>管理</a></li>
					<li><a href="javascript:;" onclick="operation_page(this)"><i class="s1"></i>运维</a></li>
				</ul>
			</div>
		</div>
	</div>
	<!---->
	<div class="mainer" id="detail">
		<iframe src="/bhost/index?tasktype=1&us={{us}}&se={{se}}" frameborder="0" width="100%" height="100%" name="mainFrame" id="mainFrame"></iframe>
	</div>

	<!--锁定浮层-->
	<div class="dialog-cont" id="scDCTab2" style="display:none;">
		<div class="container">
			<div class="c-cont1" style="min-height:200px;max-height:200px;overflow:auto;">
				<div class="c-form c-form-host" style="padding: 0 0 90px; min-width: auto;">
					<div class="clearfix"></div>
					<div class="c-table">
						<div class="form">
							<div class="form-item" style="position: absolute;left: 33%;top: 42%;width: 75%;height:100px;margin-left:-100px;margin-top:-50px;">
								<span class="form-tag" style=""><em class="imp">*</em>解锁码：</span>
								<div class="form-c" style="">
									<input type="password" class="form-text" id="unlockCode" maxlength="64" style="width: 70%;" tabindex="1"
									 onkeydown=" if (event.keyCode == 13){unlock();return false;} else return; ">
								</div>
							</div>
						</div>
						<div class="btns" style="padding: 10px 0 10px;">
							<a href="javascript:;" class="btn btn-normal btn-submit1">确&nbsp;&nbsp;定</a>
							<a href="javascript:;" class="btn btn-normal btn-cancel1">重&nbsp;&nbsp;置</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--相关下载-->
	<div class="c-cont" id="related_downloads_show" style="display: none">
		<div class="rwrap" style="overflow:auto;">

			<div class="container">
				<div class="c-top">
					<div class="c-title">
						<div class="manual-head" style="float:left;width:100px">
							<div class="manual-title">
								<span id="related_downloads_group" style="cursor: pointer;">相关下载</span>
								<i class="related_downloads_group_icon"></i>
							</div>
						</div>
					</div>
				</div>
				<div class="jq-w" style="width: 95%;">
					<div class="jq-title">
						<h3>下载</h3>
					</div>
					<div class="jq-cont jq-hardware" >
						<div class="contain_top" style="height: auto;">
							<div class="topcontent" style="height: auto;">
								<ul style="height: auto;">
									<li class="content_item first" style="display:none;">
										<a href="" class="imgbox"></a>
									</li>
									<li class="content_item second" style="display: none;">
										<a href="" class="imgbox"></a>
									</li>
									<li class="content_item thrid" style="display: none;">
										<a href="" class="imgbox"></a>
									</li>
									<li class="content_item fourth" style="display: none;">
										<a onclick="download_jre_exe();" class="imgbox" style="cursor: pointer;"></a>
									</li>
									<li class="content_item fifth" style="display: none;">
										<a href="" class="imgbox"></a>
									</li>
									<li class="content_item sixth" style="display: none;">
										<a onclick="download_python_exe();" class="imgbox" style="cursor: pointer;"></a>										
									</li>
									<li class="content_item ninth">
										<a onclick="download_BHostReplay_exe();" class="imgbox" style="cursor: pointer;"></a>
										
									</li>
									<li class="content_item seventh">
										<a onclick="download_ShowPasswd_exe();" class="imgbox" style="cursor: pointer;"></a>
									</li>
									<li class="content_item eighth">
										<a onclick="download_BHostClient_exe();" class="imgbox" style="cursor: pointer;"></a>
									</li>
								</ul>
								
							</div>
						</div>
					</div>
				</div>
				<div class="clearfix"></div>
				<div id="bBtn" style="position: fixed;z-index:5;width:100%">
					<div class="bottomCon_item first" onclick="download_crt();" style="margin-left: 44%;float: left; ">证书下载
						<a onclick="download_crt();" class="bottom_img" style="margin-left: 9px;"></a>
						<!--<a href="/bhost/download_crt" class="bottom_img" ></a>-->
					</div>
					<a href="javascript:;" class="btn btn-cancel" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
				</div>
			</div>
		</div>
	</div>
	
	<!--测试工具-->
	<div class="c-cont" id="terminal_show" style="display: none">
		<div class="rwrap" style="overflow:auto;">

			<div class="container">
				<div class="c-top">
					<div class="c-title">
						<div class="manual-head" style="float:left;width:100px">
							<div class="manual-title">
								<span id="terminal_group_icon" style="cursor: pointer;">测试工具</span>
								<i class="terminal_group_icon" style="border-radius:0px"></i>
							</div>
						</div>
					</div>
				</div>
				<div id="panel-shell">
					<!--<div class="output-view">
						Welcome to terminal
					</div><br />-->

					<div class="shell-view">
						<span class="prompt">&gt; </span><span class="input"><span class="left"></span><span class="cursor blink">&nbsp;</span><span class="right"></span></span>
					</div>
					
				</div>
				<div class="clearfix"></div>
				<div id="bBtn" style="position: fixed;z-index:5;width:100%">
					<a href="javascript:;" class="btn btn-cancel" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
				</div>
			</div>
		</div>
	</div>
	
	<!--基本信息-->
	<div class="mainer" id="info" style="display: none">
		<div class="container">
			<div class="c-top">
				<div class="c-title">
					<div class="manual-head" style="float:left;width:100px">
						<div class="manual-title">
							<span id="user_top_btn" onclick="reload(1)" style="cursor: pointer;">基本信息</span>
							<i class="userm_icon"></i>
						</div>
					</div>
				</div>
			</div>

			<div class="c-cont">
				<div class="c-wrap" style="padding: 10px 0 0;min-width:1177px;">
					<div class="c-exp" style="margin: -1px auto;">

						<div class="h-explorer">
							<div class="G-top">
								<div class="G-box1"></div><strong>&nbsp;基本信息</strong>
							</div>

							<div class="h-content2" style="min-height:210px;height:auto;width: 100%;overflow: hidden;padding: 14px 0 0;">

								<div class="form-item for-avatar" style="width: 180px;">
									<div id="tAvatar" onclick="_getAvatarList(this)"><img src="/manage/images/avatar1.jpg"></div>
								</div>

								<div class="col3">
									<div class="form-item">
										<span class="form-tag" style=""><em class="imp">*</em>账&nbsp;&nbsp;号：</span>
										<div class="form-c" style="">
											<input type="text" class="form-text" id="sys_u_name" maxlength="31" style="" onblur="IDCheck(this)" tabindex="1"><i
											 class="v-check"></i>
											<p class="form-tip">仅支持英文、数字、下划线、横杠、小数点</p>
										</div>
										<div class="tab-t" style=" width: 9%; position: absolute; margin-left: 290px; margin-top: -27px">
											<div class="ctr">
												<a href="javascript:;" id="changePwd" class="btn btn-default btn-normal" onclick="change_Pwd();">修改密码</a>
											</div>
										</div>
									</div>
									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em>姓&nbsp;&nbsp;名：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="user_name" maxlength="127" onblur="nameCheck(this)" tabindex="2"><i
											 class="v-check"></i>
											<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
										</div>
									</div>

									<!-- <div class="form-item" style="display:none;">
											<span class="form-tag"><em class="imp">*</em>认证方式：</span>
											<div class="form-c">
												<select class="form-select" name="" id="sys_u_authtype" style="width:234px" >
													<option value="null" >默认</option>
												</select>
											</div>
										</div> -->

									<div class="form-item">
										<span class="form-tag"><em class="imp" id="phone_em">*</em>手&nbsp;&nbsp;机：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="sys_u_phone" onblur="phoneCheck(this)" maxlength="11" tabindex="3"><i
											 class="v-check"></i>
										</div>
									</div>

									<div class="form-item" id="pwd1" style="display:none;">
										<span class="form-tag"><em class="imp">*</em>当前密码：</span>
										<div class="form-c">
											<input type="password" class="form-text" id="sys_u_pwd_old" maxlength="64" tabindex="7"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item" id="pwd2" style="display:none;">
										<span class="form-tag"><em class="imp">*</em>新密码：</span>
										<div class="form-c">
											<input type="password" class="form-text" id="sys_u_pwd_new" maxlength="64" tabindex="8"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item" id="pwd3" style="display:none;">
										<span class="form-tag"><em class="imp">*</em>确认密码：</span>
										<div class="form-c">
											<input type="password" class="form-text" id="sys_u_pwd_tr" maxlength="64" tabindex="9"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">描&nbsp;&nbsp;述：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="sys_u_descr" maxlength="2047" tabindex="4"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag"><em class="imp" id="mail_em">*</em>邮&nbsp;&nbsp;箱：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="sys_u_email" onblur="emailCheck(this)" maxlength="127" tabindex="5"><i
											 class="v-check"></i>
										</div>
									</div>

									<div class="form-item" style="width: 33.3%;">
										<span class="form-tag">工&nbsp;&nbsp;号：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "UserNumber" maxlength="127" onblur="regCheck(this,/^[a-zA-Z\d_]+$/)" tabindex=""><i class="v-check"></i>
											<p class="form-tip">仅支持英文、数字、下划线</p>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">部&nbsp;&nbsp;门：</span>
										<div class="form-c">
											<input type="text" class="form-text" id="sys_u_depart" maxlength="127" tabindex="6"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item" style="width:100%;display:none;">
										<span class="form-tag" style=""><em class="imp">*</em>角色：</span>
										<div class="h-content3" id="select_r" style="margin-top: -19px; width:80%;padding: 10px 20px 0px 19px;">

										</div>
									</div>

									<div class="form-item" style="width: 100%;margin-bottom: 15px;display:none;">
										<span class="form-tag" style=""><em class="imp">*</em>管理员：</span>
										<div class="h-content3" id="select_u" style="margin-top: -19px; width:80%;padding: 10px 20px 0px 19px;">

										</div>
									</div>
									<div class="form-item" style="width: 33.3%; height: 35px;display:none;">
										<span class="form-tag">认证方式：</span>
										<!--<div class="form-c" style="width: 20%; position: absolute;margin-left: 80px">
											<select class="form-select" name="" id="sys_u_authtype" style="width:202px" tabindex="4">
												<option value="null" >默认</option>
											</select>
										</div>-->
										<div class="g-cont">
											<div class="sel-type1" id="authtype_list_select" style="width:330px">
												<div class="xSelect xSelect_aythtypeList" id="sys_u_authtype"></div>
											</div>
										</div>																			
									</div>
									
									<div class="form-item" style="width: 33.3%;height: 37px;display:none;" id="totp_div">
										<span class="form-tag" style="width: 112px;margin-left: -32px;">TOTP：</span>
										<div class="form-c" style="">
											<label class="tab-t" style="position: absolute;width: 60px;">
												<div class="ctr">
													<a href="javascript:;" class="btn btn-default btn-normal" onclick="qr_code_show();">重置</a>
												</div>
											</label>
										</div>
									</div>
									<div class="form-item" id="usbkey_div" style="width: 33.3%;display:none;">
										<span class="form-tag">USBKEY：</span>
										<div class="form-c">
											<a href="javascript:;" id="changePIN" class="btn btn-default btn-normal" onclick="change_PIN()">修改pin码</a>
										</div>
									</div>
									<div class="form-item" id="tokenid_div" style="width:33.3%; display: none;">
										<span class="form-tag">令牌：</span>
										<div class="h-content3" id="TokenID" style="padding: 0; margin-left: -16px">
										</div>
									</div>
									<div class="form-item" id="CertCn_div" style="width: 33.3%;display:none;">
										<span class="form-tag" style="    width: 105px;margin-left: -24px;"><em class="imp">*</em>认证唯一标识：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "CertCn" maxlength="127" tabindex="10"></i>
										</div>
									</div>
									<div class="form-item" id="fprint_div" style="width: 100%;display:none;">
										<span class="form-tag">指纹：</span>
										<div class="h-content3" id="auth_divs" style="margin-top: -19px;width:90%;padding: 10px 0;">
											<div class="item" style="width: 15%;">
												<a href="javascript:;" id="setFinP" class="btn btn-default btn-normal" onclick="setFinP()">录入指纹</a>
											</div>
										</div>
									</div>
									<div class="dialog-cont s-hide" id="qr_code" style="display:none;max-height:500px">
										<span style="margin-left: 68px;">请使用您的 TOTP 应用扫描二维码</span>
										<div style="text-align:center;">
											<img src="">
										</div>
										<div style="text-align: center;height: 34px;">
											<span>请在下方输入应用中的验证码进行测试。
											</span>
										</div>
										<div style="float:left;margin-left: 57px">
											<input type="text" class="form-text" id="totp_v" style="width:133px;" placeholder="输入验证码" onkeydown="if (event.keyCode == 13){submit_totp();return false;} else return;">
										</div>
										<div class="tab-t">
											<div class="ctr">
												<a class="btn" href="javascript:;" style="margin-left:16px;" onclick="submit_totp();">验证</a>
											</div>
										</div>
										<!--
											<div class="ctr">
												<a class="btn" href="javascript:;" style="float:left;margin-left:13px;;padding: 0 15px;line-height: 24px;color: #8D808A;border: 1px solid #8D808A;border-radius: 5px;transition: all 0.4s;" onclick="submit_totp();">验证</a>
											</div>
											-->
									</div>


								</div>

							</div>
						</div>
					</div>
					<div class="c-exp" style="margin: -1px auto;display: none;" id="append_div">
						<div class="h-explorer">
							<div class="G-top">
								<div class="G-box1"></div><strong>&nbsp扩展选项</strong>	
							</div>
							<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 14px 0 0 0px;">
								<div class="form-item" style="margin-left: 70px; width: 93%;">
									<span class="form-tag" style="width: 113px;">客户端登录限制：</span>
									<div class="form-c">
										<div class="sel-type2" style="padding-left: 113px;">
											<div class="set-view set-view1" id="Temp4" style="margin-top: -18px;">
												<div class="sitem" style=" width: 510px;float: left; margin-left: -10px;height:40px" _auth_data="">
													<i class="ctrl add" id="add2" onclick="_addSet4(this)" style="margin-left: 128px;height: 28px; display: none;"></i>
													<select name="" id="IPorMAC" class="select2 " style="width: 120px" onchange="change_limit(this)">
														<option value="1">IP地址</option>
														<option value="2">IP区间</option>
														<option value="3">MAC地址</option>
														<option value="4">MAC地址区间</option>
														<option value="5">客户端集合</option>
													</select>	
													<!-- ################################客户端集合下拉框及添加界面-->
													<div class="g-cont">
														<div class="sel-type1" style="display: none;" id="client_list" style="margin-top: -10px;width:360px">
															<div class="xSelect xSelect_clientList" id="accset"></div>
														</div>
													</div>
													<!-- ######################################## -->
													
													<div class="set-view set-view4" style="display:none; margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width: 302px;" type="text" class="form-text" id="ip_input">
													</div>
													
													<div class="set-view set-view2" id="Temp2" style="display:none; margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width:139px;" type="text" class="form-text" id="start_ip"><span class="fix">-</span>
														<input style="width: 139px;" type="text" class="form-text" id="end_ip">
													</div>
													<div class="set-view set-view3" id="Temp3" style="display:none;margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width: 316px;" type="text" class="form-text" id="mac_input">
													</div>

													<div class="set-view set-view5" style="display:none;margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width:135px;padding: 0px 10px;" type="text" class="form-text" id="start_mac"><span class="fix" style="margin-left: 7px;margin-right: 3px;">-</span>
														<input style="width: 135px;padding: 0px 10px;" type="text" class="form-text" id="end_mac">
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<!-- 添加 -->
								<div class="dialog-cont" id="client_suspend" style="display:none;max-height:500px">
									<div class="container" style="padding: 0px 20px 20px 20px;">
										<div class="c-cont2" style="overflow-x: hidden;">
											<div class="c-form c-form2" style="padding: 0;">
												<div class="h-top" style="width:958px;border-top: 1px solid rgb(204, 204, 204);border-right:1px solid rgb(204, 204, 204);border-left: 1px solid rgb(204, 204, 204);border-bottom: 0px;">
													<div class="form-item" style="padding: 0 0 0 19px;float:left;margin:3px;width:68%">
														<span class="form-tag" style="float:left;width:auto;"><em class="imp">*</em>名称：</span>
														<div class="form-c" style="float:left;padding-left:0px;">
															<input type="text" class="form-text" id="c_n" name="c_n" style="width:160px;" maxlength="128" onblur="regCheck(this,nameReg);">
															<i class="v-check" style=" margin: 7px 0 0 -26px;"></i>
															<span>特殊字符仅支持下划线、横杠、小数点</span>
														</div>
													</div>
												</div>
												<div class="form form1" style="width:469px; border: 1px solid #ccc; max-height: 300px;overflow: auto;min-height:300px">
													<div class="c-form c-form-host" style="width: 420px;min-width: 420px;padding-top:0px;">
														<div class="form" style="width: auto;">
															<div class="form-item form-item-100 " style="width: 460px;font-size:16px;padding-left: 8px;padding-right: 0px;margin-left: -25px;">
																<span class="form-tag" style="width: 63px;float: left;">IP地址：</span>
																<div id="ip_n_c1" name="ip_n_c1" class="form-c" style="padding-left: 0px;width:380px;float: left;" value="0">
																	<span class="ss ss-add" id="ip_span1" value="0" style="float:left;position:static;width:180px;">
																		<input type="text" class="form-text" style="width:123px;padding-right: 8px;">
																		<i class="ctr ctr-add" onclick="_addIp_c1(this);" style="margin-left: 5px;"></i>
																	</span>
																</div>
																<span class="form-tag" style="width: 63px;padding-top: 10px;float: left;">IP区间：</span>
																<div id="ip_n_c" name="ip_n_c" class="form-c" style="padding-left: 0px;width: 380px;float: left;padding-top: 10px;" value="0">
																	<span class="ss ss-add" id="ip_span" value="0" style="float:left;position:static;padding: 0 0 10px 0;width: 340px;">
																		<input type="text" class="form-text"placeholder="起始IP地址" style="width:123px;padding-right: 8px;">
																		<span style="vertical-align:middle;">-</span>
																	<input type="text" class="form-text" placeholder="结束IP地址" style="width:123px;padding-right: 8px;margin-left: -1px;">
																	<i class="ctr ctr-add" onclick="_addIp_c(this);" style="margin-left: 5px;"></i>
																	</span>
																</div>
															</div>
														</div>
													</div>
												</div>
												<div class="form form3" style="width:488px;border: 1px solid #ccc;max-height: 300px;overflow-x: hidden;border-left: 0px;">
													<div class="c-form c-form-host" style="width:450px;min-width:450px;padding-top:0px;">
														<div class="form">
															<div class="form-item form-item-100 " style="width: 472px;font-size:16px;margin-left: -12px;">
																<span class="form-tag" style="width: 83px;float: left;">MAC地址：</span>
																<div id="MACAddress" name="MACAddress" class="form-c" style="padding-left: 0px;width: 380px;float:left;;" value="0">
																	<span class="ss ss-add" value="0" style="float:left;position:static;width: 190px;">
																		<input type="text" class="form-text" maxlength="17" style="width:138px;padding-right: 8px;">
																		<i class="ctr ctr-add" onclick="_addMAC(this)" style=" margin-left: 5px;"></i>
																	</span>
																</div>
																<span class="form-tag" style=" width: 85px;float: left;padding-top: 10px;">MAC区间：</span>
																<div id="MACAddress1" name="MACAddress1" class="form-c" style="padding-left: 0px;width: 380px;float:left;padding-top: 10px;" value="0">
																	<span class="ss ss-add" value="0" style="float:left;position:static;padding: 0 0 10px 0;width: 350px;">
																		<input type="text" class="form-text" maxlength="17" placeholder="起始MAC地址" style="width:138px;padding-right: 8px;">
																		<span style="vertical-align:middle;">-</span>
																	<input type="text" class="form-text" maxlength="17" placeholder="结束MAC地址" style="width:138px;padding-right: 8px;">
																	<i class="ctr ctr-add" onclick="_addMAC1(this)" style=" margin-left: 5px;"></i>
																	</span>
																</div>
															</div>
														</div>
													</div>
												</div>

												<div class="clearfix"></div>
											</div>
										</div>
									</div>
									<div class="btns">
										<a href="javascript:;" class="btn btn-normal btn-submit s-hide">保&nbsp;&nbsp;存</a>
										<a href="javascript:;" class="btn btn-normal btn-cancel s-hide">重&nbsp;&nbsp;置</a>
									</div>
								</div>	
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					<div class="btns">
						<a href="javascript:;" class="btn btn-normal btn-submit" onclick="">保&nbsp;&nbsp;存</a>
						<!-- <a href="javascript:;" class="btn btn-normal btn-cancel" onclick="">返&nbsp;&nbsp;回</a> -->
					</div>
					<div id="bBtn" style="z-index: 5; position: fixed;">
						<a href="javascript:;" class="btn btn-cancel"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!--收件箱-->
	<div class="mainer" id="msg_manage_1" style="display: none">
		<div class="container1">
			<div class="c-top">
				<div class="manual-head">
					<div class="manual-title title-item" id="frist">
						<span onclick="switch_page(1);">收件箱</span>
						<i class="msg_2_icon"></i>
					</div>
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(2);">发件箱</span>
						<i style="display: none;"></i>
					</div>
					<!--<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(3);">新建消息</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(4);">系统全部消息</span>
							<i style="display: none;"></i>
						</div> -->
					<!-- <div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(5);">备份消息</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(6);">消息归档</span>
							<i style="display: none;"></i>
						</div> -->
				</div>
			</div>

			<div class="c-cont">
				<div class="c-wrap">
					<div class="c-table">
						<div class="tab-t">
							<div class="ctr">
								<a href="javascript:;" class="btn btn-default perm_disabled" onclick="delete_manage();">删除</a>
								<a href="javascript:;" class="btn btn-default perm_disabled" onclick="click_all_list();">全选</a>
								<a href="javascript:;" class="btn btn-default" onclick="clear_all();">刷新</a>
							</div>
							<div class="ctr" style="height: 26px; float: right; width: 120px">
								<select id="filter_select" class="filter-select" onchange="msg_filter(this);" style="width: 120px;">
									<option value="-1" selected>所有</option>
									<option value="2">仅显示未读</option>
									<option value="1">仅显示未处理</option>
								</select>
							</div>
						</div>
						<div class="box-table">
							<table cellpadding="0" cellspacing="0" id="m_list">
								<thead>
									<tr>
										<th class="perm_disabled" width="50"><input type="checkbox" class="form-checkbox" id="check_one_page" /></th>
										<th style="width: 150px;">发送时间</th>
										<th style="width: 76px;">类型</th>
										<th>概要</th>
										<th style="width: 14%;">发送者</th>
										<th style="width: 44px;">结果</th>
										<th style="width: 44px;">状态</th>
										<th style="width: 126px"></th>
									<tr>
								</thead>

								<tbody name="msg_list" id="msg_list">
								</tbody>
							</table>
						</div>
						<div class="tab-i">
							<div class="il">每页显示10条 总数：
								<span id="msg_total"></span>
							</div>

							<div class="ipage">
								<a href="javascript:;" class="nav2 begin" id="begin" onclick="msg_page(0.1)"><i></i></a>
								<a href="javascript:;" class="nav prev" id="prev" onclick="msg_page(-1)"><i></i></a>
								<input type="text" value="1" id="msg_page" onkeyup="datacheck(this);" onblur="datacheck(this)" onchange="showMsg()">/
								<span id="totalpage">25</span>
								<a href="javascript:;" class="nav next" id="next" onclick="msg_page(1)"><i></i></a>
								<a href="javascript:;" class="nav2 end" id="end" onclick="msg_page(0.9)"><i></i></a>
							</div>
						</div>
					</div>
				</div>
				<div class="clearfix"></div>
				<div id="bBtn" style="position: fixed;z-index:5;">
					<a href="javascript:;" class="btn btn-cancle1 btn-normal" onclick="msg_back()" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
				</div>
			</div>
		</div>
	</div>
	<!--发件箱-->
	<div class="mainer" id="msg_manage_2" style="display: none">
		<div class="container1">
			<div class="c-top">
				<div class="manual-head">
					<div class="manual-title title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(1);">收件箱</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" id="frist">
						<span onclick="switch_page(2);">发件箱</span>
						<i class="msg_1_icon"></i>
					</div>
					<!-- <div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(3);">新建消息</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(4);">系统全部消息</span>
							<i style="display: none;"></i>
						</div> -->
					<!-- <div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(5);">备份消息</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(6);">消息归档</span>
							<i style="display: none;"></i>
						</div> -->
				</div>
			</div>
			<div class="c-cont">
				<div class="c-wrap">
					<div class="c-table">
						<div class="tab-t">
							<div class="ctr">
								<a href="javascript:;" class="btn btn-default btn-normal" id="createMsg" onclick="createMsg()">新建消息</a>
								<a href="javascript:;" class="btn btn-default perm_disabled" onclick="delete_manage2();">删除</a>
								<a href="javascript:;" class="btn btn-default perm_disabled" onclick="click_all_list2();">全选</a>
								<a href="javascript:;" class="btn btn-default" onclick="clear_all2();">刷新</a>
							</div>
						</div>
						<div class="box-table">
							<table cellpadding="0" cellspacing="0" id="m_list2">
								<thead>
									<tr>
										<th class="perm_disabled" width="50">
											<input type="checkbox" class="form-checkbox" id="check_page2" style="">
										</th>
										<th style="width: 150px;">发送时间</th>
										<th style="width: 76px;">类型</th>
										<th style="">概要</th>
										<th style="width: 14%;">接收者</th>
										<th style="width: 44px;">结果</th>
										<th style="width: 44px;">状态</th>
										<th style="width: 77px"></th>
									<tr>
								</thead>

								<tbody name="msg_list2" id="msg_list2">
								</tbody>
							</table>
						</div>
						<div class="tab-i">
							<div class="il">每页显示10条 总数：
								<span id="msg_total2"></span>
							</div>

							<div class="ipage">
								<a href="javascript:;" class="nav2 begin" id="begin2" onclick="msg_page2(0.1)"><i></i></a>
								<a href="javascript:;" class="nav prev" id="prev2" onclick="msg_page2(-1)"><i></i></a>
								<input type="text" value="1" onkeyup="datacheck(this)" onblur="datacheck(this)" id="msg_page2" onchange="showMsg2()">/
								<span id="totalpage2">25</span>
								<a href="javascript:;" class="nav next" id="next2" onclick="msg_page2(1)"><i></i></a>
								<a href="javascript:;" class="nav2 end" id="end2" onclick="msg_page2(0.9)"><i></i></a>
							</div>
						</div>
					</div>
				</div>
				<div class="clearfix"></div>
				<div id="bBtn" style="position: fixed;z-index:5;">
					<a href="javascript:;" class="btn btn-cancle1 btn-normal" onclick="msg_back()" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
				</div>
			</div>
		</div>
	</div>

	<!--新建消息-->
	<div class="dialog-cont" id="scDCTab1" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:400px;max-height:400px;overflow:auto;">
				<div class="c-form c-form-host" style="padding: 0px 0 0px;min-width: auto;">
					<div class="clearfix"></div>
					<div class="c-table">
						<div class="form">
							<div class="form-item" style="width: 30%;">
								<span class="form-tag">消息类型：</span>
								<div class="form-c">
									<select class="form-select" name="" id="msg_type" style="width:120px">
										<option value="4">下发工作任务</option>
										<option value="5">通知</option>
										<option value="10">申请</option>
									</select>
								</div>
							</div>
							<div class="form-item" style="width: 36%;">
								<span class="form-tag" style=""><em class="imp">*</em>标&nbsp;&nbsp;题：</span>
								<div class="form-c" style="">
									<input type="text" class="form-text" id="title" maxlength="31" style="width: 100%;" onblur="IDCheck(this)"
									 tabindex="1">
								</div>
							</div>
							<div class="form-item" style="width: 100%;">
								<div class="h-catelog h-catelog2" style="background-color: rgb(255, 255, 255); width: 100%; height: 100%;">
									<span class="form-tag" style="margin-left: -17px;"><em class="imp">*</em>接收者：</span>
									<div class="form-c">
										<ul id="receiver_all">
											<li style="width:25%; margin-top: -4px; margin-left: -16px;">
												<select class="filter-select" name="" id="receiverSelect" style="width:120px" onchange="change_receiver(this);">
												</select>
												<i class="ctrl add" onclick="_add_re(this)"></i>
											</li>
										</ul>
									</div>
								</div>
							</div>
							<div class="form-item" style="width: 75%;">
								<span class="form-tag"><em class="imp">*</em>详&nbsp;&nbsp;情：</span>
								<div class="form-c">
									<textarea type="textarea" class="form-text" id="content" style="width: 430px; height: 150px; resize: none"></textarea>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="btns" style="padding: 10px 0 10px; position: relative;">
				<a href="javascript:;" class="btn btn-normal btn-submit">确&nbsp;&nbsp;定</a>
				<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
			</div>
		</div>
	</div>
	<!--系统全部消息-->
	<div class="mainer" id="msg_manage_4" style="display: none">
		<div class="container1">
			<div class="c-top">
				<div class="manual-head">
					<div class="manual-title title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(1);">收件箱</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(2);">发件箱</span>
						<i style="display: none;"></i>
					</div>
					<!-- <div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(3);">新建消息</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" id="frist">
							<span onclick="switch_page(4);">系统全部消息</span>
							<i class="msg_4_icon"></i>
						</div> -->
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(5);">备份消息</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(6);">消息归档</span>
						<i style="display: none;"></i>
					</div>
				</div>
			</div>

			<div class="c-cont">
				<div class="c-wrap">
					<div class="c-table">
						<div class="tab-t">
							<div class="ctr">
								<a href="javascript:;" class="btn btn-default btn-normal" onclick="select_all()">全选</a>

							</div>
						</div>
						<div class="box-table">
							<table cellpadding="0" cellspacing="0" id="m_list">
								<thead>
									<tr>
										<th width="50"><input type="checkbox" class="form-checkbox" id="check_page" /></th>
										<th style="width: 150px;">发送时间</th>
										<th style="width: 76px;">消息类型</th>
										<th>概要</th>
										<th style="width: 14%;">发送者</th>
										<th style="width: 44px;">消息状态</th>
										<th style="width: 44px;">状态</th>
										<th style="width: 76px"></th>
									<tr>
								</thead>

								<tbody name="msg_list" id="msg_list">
								</tbody>
							</table>
						</div>
						<div class="tab-i">
							<div class="il">每页显示10条 总数：
								<span id="msg_total">25</span> 选中：
								<span id="select_total">0</span>
							</div>

							<div class="ipage">
								<a href="javascript:;" class="nav2 begin" id="begin" onclick="msg_page(0.1)"><i></i></a>
								<a href="javascript:;" class="nav prev" id="prev" onclick="msg_page(-1)"><i></i></a>
								<input type="text" value="1" onchange="showMsg()">/<span id="totalpage">25</span>
								<a href="javascript:;" class="nav next" id="next" onclick="msg_page(1)"><i></i></a>
								<a href="javascript:;" class="nav2 end" id="end" onclick="msg_page(0.9)"><i></i></a>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					<div class="btns">
						<a href="javascript:;" class="btn btn-cancel" onclick="msg_back()">返&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--备份消息-->
	<div class="mainer" id="msg_manage_5" style="display: none">
		<div class="container1">
			<div class="c-top">
				<div class="manual-head">
					<div class="manual-title title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(1);">收件箱</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(2);">发件箱</span>
						<i style="display: none;"></i>
					</div>
					<!-- <div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(3);">新建消息</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(4);">系统全部消息</span>
							<i style="display: none;"></i>
						</div> -->
					<div class="manual-title-other title-item" id="frist">
						<span onclick="switch_page(5);">备份消息</span>
						<i class="msg_5_icon"></i>
					</div>
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(6);">消息归档</span>
						<i style="display: none;"></i>
					</div>
				</div>
			</div>

			<div class="c-cont">
				<div class="c-wrap">
					<div class="c-table">
						<div class="tab-t">
							<div class="ctr">
								<a href="javascript:;" class="btn btn-default btn-normal" onclick="select_all()">全选</a>
							</div>
						</div>
						<div class="box-table">
							<table cellpadding="0" cellspacing="0" id="m_list">
								<thead>
									<tr>
										<th width="50"><input type="checkbox" class="form-checkbox" id="check_page" /></th>
										<th style="width: 150px;">发送时间</th>
										<th style="width: 76px;">消息类型</th>
										<th>概要</th>
										<th style="width: 14%;">发送者</th>
										<th style="width: 44px;">消息状态</th>
										<th style="width: 44px;">状态</th>
										<th style="width: 76px"></th>
									<tr>
								</thead>

								<tbody name="msg_list" id="msg_list">
								</tbody>
							</table>
						</div>
						<div class="tab-i">
							<div class="il">每页显示10条 总数：
								<span id="msg_total">25</span> 选中：
								<span id="select_total">0</span>
							</div>

							<div class="ipage">
								<a href="javascript:;" class="nav2 begin" id="begin" onclick="msg_page(0.1)"><i></i></a>
								<a href="javascript:;" class="nav prev" id="prev" onclick="msg_page(-1)"><i></i></a>
								<input type="text" value="1" onchange="showMsg()">/<span id="totalpage">25</span>
								<a href="javascript:;" class="nav next" id="next" onclick="msg_page(1)"><i></i></a>
								<a href="javascript:;" class="nav2 end" id="end" onclick="msg_page(0.9)"><i></i></a>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					<div class="btns">
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn btn-cancle1 btn-normal" onclick="msg_back()" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--消息归档-->
	<div class="mainer" id="msg_manage_6" style="display: none">
		<div class="container1">
			<div class="c-top">
				<div class="manual-head">
					<div class="manual-title title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(1);">收件箱</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(2);">发件箱</span>
						<i style="display: none;"></i>
					</div>
					<!-- <div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(3);">新建消息</span>
							<i style="display: none;"></i>
						</div>
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="switch_page(4);">系统全部消息</span>
							<i style="display: none;"></i>
						</div> -->
					<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
						<span onclick="switch_page(5);">备份消息</span>
						<i style="display: none;"></i>
					</div>
					<div class="manual-title-other title-item" id="frist">
						<span onclick="switch_page(6);">消息归档</span>
						<i class="msg_6_icon"></i>
					</div>
				</div>
			</div>

			<div class="c-cont">
				<div class="c-wrap">
					<div class="c-table">
						<div class="tab-t">
							<div class="ctr">
								<a href="javascript:;" class="btn btn-default btn-normal" onclick="select_all()">全选</a>
							</div>
						</div>
						<div class="box-table">
							<table cellpadding="0" cellspacing="0" id="m_list">
								<thead>
									<tr>
										<th width="50"><input type="checkbox" class="form-checkbox" id="check_page" /></th>
										<th style="width: 150px;">发送时间</th>
										<th style="width: 76px;">消息类型</th>
										<th>概要</th>
										<th style="width: 14%;">发送者</th>
										<th style="width: 44px;">结果</th>
										<th style="width: 44px;">状态</th>
										<th style="width: 76px"></th>
									<tr>
								</thead>

								<tbody name="msg_list" id="msg_list">
								</tbody>
							</table>
						</div>
						<div class="tab-i">
							<div class="il">每页显示10条 总数：
								<span id="msg_total">25</span> 选中：
								<span id="select_total">0</span>
							</div>

							<div class="ipage">
								<a href="javascript:;" class="nav2 begin" id="begin" onclick="msg_page(0.1)"><i></i></a>
								<a href="javascript:;" class="nav prev" id="prev" onclick="msg_page(-1)"><i></i></a>
								<input type="text" value="1" onchange="showMsg()">/<span id="totalpage">25</span>
								<a href="javascript:;" class="nav next" id="next" onclick="msg_page(1)"><i></i></a>
								<a href="javascript:;" class="nav2 end" id="end" onclick="msg_page(0.9)"><i></i></a>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					<div class="btns">
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn btn-cancle1 btn-normal" onclick="msg_back()" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- -->
<div id="avatars" class="avatars">
	<ul>
		<li><a href="javascript:;" class="active" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar1.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar2.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar3.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar4.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar5.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar6.jpg"></a></li>
	</ul>
</div>
<!--验证码-->
<div class="dialog-cont" id="code_suspend" style="display:none;">
	<div class="container" style="">
		<div class="c-cont" style="min-height: 200px; max-height: 200px; overflow: auto; height: 332px;">
			<div class="c-form " style="width: auto;">
				<div class="form" sytle="width: auto;">
					<div class="form-item" style="padding: 10px 0;" id="code_form" name="code_form">
						<span class="form-tag" style="width: 170px;">
							<em class="imp">*</em>验证码：</span>
						<div class="form-c" style="padding-left: 178px;">
							<input style="width:135px;padding-right: 8px;" type="text" class="form-text" id="code_name" name="code_name"
							 onkeydown=" if (event.keyCode == 13){$('#code_suspend .btn-submit').click;return false;} else return; ">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="clearfix"></div>
	<div class="btns" style="padding: 10px 0 10px;/*margin-bottom: -20px;margin-left:-20px;width:840px;*/">
		<a href="javascript:;" class="btn btn-normal btn-submit perm_1_disabled">确&nbsp;&nbsp;定</a>
		<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
	</div>
</div>
<!-- 修改PIN浮层 -->
<div class="dialog-cont" id="PINDialog" style="display:none;">
	<div class="container">
		<div class="c-cont" style="min-height:250px;max-height:200px;overflow:auto;">
			<div class="c-form c-form-host" style="padding: 0 0 90px;min-width: 800px;">
				<div class="clearfix"></div>
				<div class="c-table">
					<div class="form" style="width: 300px;margin-left: 200px;">
						<div class="form-item" style="width: 100%;">
							<span class="form-tag" style="width: 8em;"><em class="imp">*</em>原pin码：</span>
							<div class="form-c" style="">
								<input type="password" class="form-text" id="pin_input1_old" style="width: 100%;" tabindex="1">
							</div>
						</div>
						<div class="form-item" style="width: 100%;">
							<span class="form-tag" style="width: 8em;"><em class="imp">*</em>新pin码：</span>
							<div class="form-c" style="">
								<input type="password" class="form-text" id="pin_input1" style="width: 100%;" tabindex="1">
							</div>
						</div>
						<div class="form-item" style="width: 100%;">
							<span class="form-tag" style="width: 8em;"><em class="imp">*</em>确认pin码：</span>
							<div class="form-c" style="">
								<input type="password" class="form-text" id="pin_input2" style="width: 100%;" tabindex="1">
							</div>
						</div>
					</div>
					<div class="btns" style="padding: 10px 0 10px;">
						<a href="javascript:;" class="btn btn-normal btn-submit">保&nbsp;&nbsp;存</a>
						<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 认证方式浮层 -->
<div class="dialog-cont" id="authtype_suspend" style="display:none;max-height:500px;min-height:500px;scrolling:yes">
<iframe src="" width="100%" height="100%" frameborder="0" name="mframe1" id="mframe1" style="height: 521px;margin-top: -21px;"></iframe>
<div class="clearfix"></div>
</div>
</body>
<style>
	#panel-shell {
		display: block;
		width: 96%;
		height: 100%;
		background-color: #26292C;
		opacity: 0.9;
		color: #00fe00;
		position: relative;
		padding: 20px;
		top: 0;
		left: 0;
		font-family: 'Source Code Pro', sans-serif;
		font-size: 14px;
		overflow: auto;
		margin: 10px;
	}
	.blink {
		background-color: #00fe00;
		color: #000;
	}
	.output.error {
		color: white;
	}

	.contain_top{
		width: 100%;
		height: 400px;
		border-bottom: 1px solid #dedede;
		position: relative;
	}
	.topcontent{
		width: auto;
		height: 360px;
		top: 0;
		left: 0;
		bottom: 0;
		right: 0;
		/*margin: auto;*/
	}
	.topcontent ul{
		width: auto;
		height: 360px;
	}
	.content_item{
		width: 200px;
		height: 140px;
		float: left;
		padding-left: 90px;
		padding-bottom: 10px;
	}
	.imgbox{
		width: 180px;
		height: 140px;
		display: inline-block;
	}
	.contain_bottom{
		width: 100%;
	}
	.bottomCon{
		width: 600px;
		margin: 30px auto;
		/* padding-left: 260px; */
		padding-left: 442px;
	}
	.bottomCon_item{
		width: 160px;
		height: 36px;
		border: 1px solid #8d808a;
		border-radius: 18px;
		margin-right: 20px;
		display: block;
		float: left;
		text-align: center;
		line-height: 34px;
		color: #8d808a;
		font-size: 16px;
		position: relative;
		padding: 0 0px 0 40px;
		box-sizing: border-box;
		cursor: pointer;
	}
	.bottomCon_item:hover{
		background-color: #8D808A;
		color: #fff;
	}
	.default{
		height: 140px;
	}
	.default a{
		height: 100px;
		margin-bottom: 9px;
	}
	span.default_span{
		position: relative;
		width: 180px;
		text-align: center;
		word-wrap: break-word;
		font-size: 13px;
		display: block;
	}

	.c-table table tr:hover .last_td,
	.xTable table tr:hover .last_td {
		background-color: #63c3d9
	}
	.progress{
		height: 15px;
		/*background: #262626;*/
		padding: 5px;
		overflow: visible;
		border-radius: 20px;
		border-top: 1px solid #7992a8;
		border-bottom: 1px solid #7992a8;
		margin-top: 50px;
	}
	.progress .progress-bar{
		border-radius: 20px;
		position: relative;
		animation: animate-positive 2s;
	}
	.progress .progress-value{
		display: block;
		padding: 3px 7px;
		font-size: 13px;
		color: #fff;
		border-radius: 4px;
		background: #191919;
		border: 1px solid #000;
		position: absolute;
		top: -40px;
		right: -10px;
	}
	.progress .progress-value:after{
		content: "";
		border-top: 10px solid #191919;
		border-left: 10px solid transparent;
		border-right: 10px solid transparent;
		position: absolute;
		bottom: -6px;
		left: 26%;
	}
	.progress-bar.active{
		animation: reverse progress-bar-stripes 0.40s linear infinite, animate-positive 2s;
	}
	@-webkit-keyframes animate-positive{
		0% { width: 0; }
	}
	@keyframes animate-positive{
		0% { width: 0; }
	}

	#changePwd:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}
	#changePwd{
		float: left;
		padding: 0px 5px;
		line-height: 24px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
	}
	#lockPage {
		outline: none;
	}
	#createMsg {
		outline: none;
	}	
	.h-catelog2 ul {
		padding-left: 0;
		margin-top: 0px;
	}
	.h-catelog {
		float: left;
		overflow: auto;
		background-color: #f5f5f5;
		border-right: 0px solid #CCC;
		padding: 0 16px;
	}

	.h-content2 .form-item {
		height: auto;
		padding: 20px 0 10px;
		min-height: 38px;
		padding: 5px;
		width: 380px;
		float: left;
	}
	.h-content2 .form-tag {
		float: left;
		width: 80px;
		text-align: right;
		color: #000;
		line-height: 28px;
	}
	.h-content2 .form-c {
		padding-left: 0px;
		position: relative;
	}
	.h-content2 .form-text {
	    width: 170px;
	}
	.h-content2 .rzj {
		float: right;
		margin-right: 40px;
		color: #000;
	}
	.h-content2 .form-tip {
		padding-left: 48px;
	}
	a.btn-normal1{
		display: inline-block;
		width: 90px;
		height: 30px;
		border: 1px solid #DDD;
		text-align: center;
		line-height: 32px;
		border-radius: 18px;
		margin: 0 10px;
		background-color: #fff;
		transition: background-color 0.4s;
		color: #7c7c7c;
	}
	a.btn-normal1:hover{
		background-color: #8d808a;
		color: #fff;
	}
	.for-avatar {
		margin-top: -13px;
		margin-left: 5px;
	}
	.col3{
		padding-left: 108px;
		height: auto;
		overflow: hidden;
	}
	.col3 .form-item{
		width: 33.3%;
		padding: 16px 0px 0px 0px;
	}
	.h-content2 .form-tip{
		padding-left: 80px;
	}
	.input-group{
		display: inline-block;
		width: 200px;
		border: 1px solid #b2b2b2;
		border-radius: 5px;
		overflow: hidden;
		vertical-align: middle;
	}

	.input-group input {
		border: 0;
		text-align: center;
		background: transparent;
	}

	.input-group input:first-child {
		border-right: 1px solid #CCC;
	}

	.h-blank {
		width: 12px;
	}

	.c-table table th,
	.xTable table th {
		text-align: center;
		background: #EAEAEB;
		color: #979799;
		font-weight: normal;
	}

	.c-table table tr {
		text-align: center;
	}

	.ui-dialog-body {
		padding: 20px 0 0 0;
		text-align: center;
	}

	#changePIN {
		outline: none;
	}

	#changePIN:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}

	#changePIN {
		float: left;
		padding: 0px 2px;
		line-height: 24px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
		width: 80px;
		text-align: center;
	}
	#setFinP {
		outline: none;
	}

	#setFinP:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}

	#setFinP {
		float: left;
		padding: 0px 2px;
		line-height: 24px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
		width: 80px;
		text-align: center;
	}
</style>
{% endblock  %}


{% block script %}
<script>
	$(window).resize(function () {
		_initSize();
	});
	function _initSize(){
		var h = $(window).height();
		$(".c-cont:first").height(h-164);
	}
	var _power = {{ _power| safe}};
	var client_ip = "{{client_ip}}";
	var u_id = "";
	var user_ugroup = "";
	var default_str = {{default_str|safe}}
	function logout() {
		document.frm.action = '/bhost/logout';
		document.frm.submit();
	}
	function download_crt() {
		$.ajax({
			url: "/bhost/exist_download_crt",
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val() },
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					if(window.parent.parent.document.frm.use_BH.value=='0'){
						location.href = '/bhost/download_crt';
						return 0;
					}
					var sesstimet = (new Date()).valueOf();
					var referrer_arr=document.referrer.toString().split('/');
					referrer_arr.pop();
					var referrer=referrer_arr.join('/');
					var json_download = {
							"Type": "Download",
							"Url": referrer,
							"Path": '/usr/ssl/certs/',
							"Filename": 'ca.crt',
							"Session": $("input[name=se]").val(),
							"sesstimet":sesstimet
					}
					var if_html_client = false;
					var base64_str = '';
					$.ajax({
							url: "/bhost/get_base64",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
							success:function(result){
									var result=JSON.parse(result);
									if(result.Result){
											if_html_client = result.info;
											base64_str = result.b64;
									}else{
											_alert(1,"相关下载",result.ErrMsg); 
									}
							}
					})
					if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
					else{
						get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
						$('#YuFrame1').remove();
						$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
						$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
					}
				} else {
					_alert(2, '相关下载', result.ErrMsg);
					return false;
				}
			}
		})
	}
	function download_jre_exe() {
		$.ajax({
			url: "/bhost/exist_download_jre_exe",
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val() },
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					location.href = '/bhost/download_jre_exe';
				} else {
					_alert(2, '相关下载', result.ErrMsg);
					return false;
				}
			}
		})
	}
	function download_python_exe() {

		$.ajax({
			url: "/bhost/exist_download_python_exe",
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val() },
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					location.href = '/bhost/download_python_exe';
				} else {
					_alert(2, '相关下载', result.ErrMsg);
					return false;
				}
			}
		})
	}
	function download_ShowPasswd_exe() {
		$.ajax({
			url: "/bhost/exist_download_ShowPasswd_exe",
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val() },
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					if(window.parent.parent.document.frm.use_BH.value=='0'){
						location.href = '/bhost/download_ShowPasswd_exe';
						return 0;
					}
					var sesstimet = (new Date()).valueOf();
					var referrer_arr=document.referrer.toString().split('/');
					referrer_arr.pop();
					var referrer=referrer_arr.join('/');
					var json_download = {
							"Type": "Download",
							"Url": referrer,
							"Path": '/usr/storage/.system/software/',
							"Filename": 'ShowPasswd.exe',
							"Session": $("input[name=se]").val(),
							"sesstimet":sesstimet
					}
					var if_html_client = false;
					var base64_str = '';
					$.ajax({
							url: "/bhost/get_base64",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
							success:function(result){
									var result=JSON.parse(result);
									if(result.Result){
											if_html_client = result.info;
											base64_str = result.b64;
									}else{
											_alert(1,"相关下载",result.ErrMsg); 
									}
							}
					})
					if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
					else{
						get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
						$('#YuFrame1').remove();
						$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
						$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
					}
				} else {
					_alert(2, '相关下载', result.ErrMsg);
					return false;
				}
			}
		})
	}
	function download_BHostClient_exe() {
		$.ajax({
			url: "/bhost/exist_download_BHostClient_exe",
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val() },
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					if(window.parent.parent.document.frm.use_BH.value=='0'){
						location.href = '/bhost/download_BHostClient_exe';
						return 0;
					}
					var sesstimet = (new Date()).valueOf();
					var referrer_arr=document.referrer.toString().split('/');
					referrer_arr.pop();
					var referrer=referrer_arr.join('/');
					var json_download = {
							"Type": "Download",
							"Url": referrer,
							"Path": '/usr/storage/.system/software/',
							"Filename": 'BHostClient.exe',
							"Session": $("input[name=se]").val(),
							"sesstimet":sesstimet
					}
					var if_html_client = false;
					var base64_str = '';
					$.ajax({
							url: "/bhost/get_base64",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
							success:function(result){
									var result=JSON.parse(result);
									if(result.Result){
											if_html_client = result.info;
											base64_str = result.b64;
									}else{
											_alert(1,"相关下载",result.ErrMsg); 
									}
							}
					})
					if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
					else{
						get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
						$('#YuFrame1').remove();
						$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
						$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
					}
				} else {
					_alert(2, '相关下载', result.ErrMsg);
					return false;
				}
			}
		})
	}
	function download_BHostReplay_exe() {
		$.ajax({
			url: "/bhost/exist_download_BHostReplay_exe",
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val() },
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result) {
					if(window.parent.parent.document.frm.use_BH.value=='0'){
						location.href = '/bhost/download_BHostReplay_exe';
						return 0;
					}
					var sesstimet = (new Date()).valueOf();
					var referrer_arr=document.referrer.toString().split('/');
					referrer_arr.pop();
					var referrer=referrer_arr.join('/');
					var json_download = {
							"Type": "Download",
							"Url": referrer,
							"Path": '/usr/storage/.system/software/',
							"Filename": 'BHostReplay.exe',
							"Session": $("input[name=se]").val(),
							"sesstimet":sesstimet
					}
					var if_html_client = false;
					var base64_str = '';
					$.ajax({
							url: "/bhost/get_base64",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
							success:function(result){
									var result=JSON.parse(result);
									if(result.Result){
											if_html_client = result.info;
											base64_str = result.b64;
									}else{
											_alert(1,"相关下载",result.ErrMsg); 
									}
							}
					})
					if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
					else{
						get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
						$('#YuFrame1').remove();
						$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
						$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
					}
				} else {
					_alert(2, '相关下载', result.ErrMsg);
					return false;
				}
			}
		})
	}
	function lock_page(type) {
		if (type == 0) {
			screen();
		}
		$("#unlockCode").val("");
		var $dialogCont = $("#scDCTab2").show();
		var title = '锁定';
		var d = dialog({
			title:title,
			content:$dialogCont,
			id:"scDCTab2",
			width:"450px"
		});

		var obj1 = $("#scDCTab2").parents('tr').prev().children().find('button');
		$(obj1).on("click",function(){
			logout();
		});
		d.showModal();
		$("a.btn-cancel1",$dialogCont).unbind().bind("click",function(){
			$("#unlockCode").val("");
		});
		$("a.btn-submit1",$dialogCont).unbind().bind("click",function(){
			unlock();
		});
	}
	function unlock(){
		var pW = $("#unlockCode").val();
		var uCode = "{{us}}";
		$.ajax({
			url:"/bhost/unlock_page",
			async:false,
			type:"POST",
			data:{a0:$("input[name=se]").val(),a1:uCode,a2:pW},
			success:function(Result){
				var Result = JSON.parse(Result);
				if(Result.result == false){ //解锁失败
					$("#unlockCode").blur();
					_alert(1,"解锁",Result.info);
				}else{
					$("#lockPage").blur();
					$("#scDCTab2").appendTo("body").hide();
					var d = dialog({
						title:title,
						content:$("#scDCTab2"),
						id:"scDCTab2",
						width:"450px"
					});					
					d.close().remove();
				}
			}
		})
	}
	function screen(){
		var flags = 0;
		$.ajax({
			url: '/bhost/sess_check',
			type: "post",
			async:false,
			data: {a0:$("input[name=se]").val()},
			success: function(result) {
				var result = JSON.parse(result);
			}
		})
	}

	function user_info(){
		$("#info").show();
		$("#detail").hide();
		$('#msg_manage_1').hide();
		$('#msg_manage_2').hide();
		$('#related_downloads_show').hide();
		$('#terminal_show').hide();
		$('#msg_manage_4').hide();
		$('#msg_manage_5').hide();
		$('#msg_manage_6').hide();
		show_list();
		getPwdStrategy();
		// _get_userid(obj);	
	}
	function get_authtype_list(){
		$.ajax({
			url: "/bhost/get_authtype_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val()},
			success:function(result){
				var authtype_result = JSON.parse(result);
				if (authtype_result.Result==true){
					authtype_list = authtype_result.info.data;
					$('#sys_u_authtype').empty();
					$('#sys_u_authtype').append('<option value="0">请选择</option>');
					$(authtype_list).each(function(i,item){
						$('#sys_u_authtype').append('<option value="'+item.AuthTypeId+'">'+item.AuthTypeName+'</option>');
					})
					
					$('#sys_u_authtype').select2({minimumResultsForSearch: -1});
				}
			}
		})
	}
	var t_get_msg;
	var LastLoginTime="{{LastLoginTime}}";
	function alert_download() {
		/*
		layer.open({
			type: 1,
			title: "下载控件",
			content: '<div class="layer-alert"><i class="alert warning"></i>是否下载BHostClient.exe</div>',
			btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
			btnAlign: 'c',
			closeBtn: false,
			skin: 'layer-custom',
			area: ['380px', '310px'],
			move: false,
			resize: false,
			btn1: function (i) {
				layer.close(i);
				download_BHostClient_exe();
			},
			btn2: function (i) {
				layer.close(i);
			}
		})
		*/
		document.frm.action = '/bhost/guide_yunwei';
		document.frm.submit();
	}
	var height_old = 0;
	var uMode = 2;
	$(function(){
		_initSize();
		$("#code_name").bind('keydown', function (e) {
			DigitInput(e);
		}).on("input propertychange", function () {				//防止在输入法开启的情况下输入非数字
			this.value = this.value.replace(/\D/g, "").trim();
		});
		//判断是否有运维权限
		var Operation_flag = 0;
		var Manage_flag = 0;
		uMode=2;
		height_old = $("#mainFrame").height();
		$.each(_power,function(i,item){
			if(item.SystemMenuName == "运维访问"){
				if(item.Mode > 0){
					Operation_flag = 1;
				}
				uMode = item.Mode;
				$.ajax({
					url:'/bhost/Get_AuthObjectByLevel',
					type:'post',
					async:true,
					cache:false,
					data:{a0:$("input[name=se]").val(),z1:-1},
					success:function(result){
					}
				})

			}else{
				if(item.Mode > 0){
					Manage_flag = 1;
				}
			}
			if(Operation_flag == 1 && Manage_flag == 1){
				return false;
			}
		})
		$("#nav-s2").attr('_if_disable',uMode);
		
		//运维用户：bhrdpdr.exe, BHTunnelDaemon.exe, UsbKeyLogin.exe, parse.exe,httptransfile.exe
		//管理员额外增加ReplayClient.exe, ReplayClientModule.exe, RdpsReplay.jar, CharReplay.jar
		client_str='bhrdpdr.exe,BHTunnelDaemon.exe,UsbKeyLogin.exe,parse.exe,httptransfile.exe,launch.exe,library.zip'
		if(Operation_flag == 1 && Manage_flag == 1){
			$("#switchPage").parent().show();
			$("#switchPage_button").prev().text("运维")
			$("#nav-s2").show();
			/*if(LastLoginTime=='None'){
				alert_download();
				return 0;
			}*/
			client_str += ",ReplayClient.exe,ReplayClientModule.exe,RdpsReplay.jar,CharReplay.jar" 
		}
		else if(Operation_flag == 1 && Manage_flag == 0){
			$("#switchPage_button").prev().text("运维")
			$("#nav-s2").show();
			/*if(LastLoginTime=='None'){
				alert_download();
				return 0;
			}*/
		}
		else if(Operation_flag == 0 && Manage_flag == 1){
			$("#switchPage_button").prev().text("管理")
			$("#nav-s1").show();	
			if( IEVersion() < 10 && IEVersion() >0){
				os_type = detectOS();			
				layer.open({
					type:1,
					title:"下载浏览器",
					content:'<div class="layer-alert"><i class="alert warning"></i>当前浏览器版本太低，请安装chrome浏览器访问</div>',
					btn:['下&nbsp;&nbsp;载', '取&nbsp;&nbsp;消'],
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						//根据 系统下载对应的浏览器
						if(os_type.indexOf('Win7') > -1 || os_type.indexOf('Win8') > -1 || os_type.indexOf('Win10') > -1 ){
							location.href='/bhost/download_chrome_exe?t1=Win7';
						}else if(os_type.indexOf('WinXP') > -1){
							location.href='/bhost/download_chrome_exe?t1=WinXP';
						}
						
					},
					btn2:function(i){
						layer.close(i);
					}
				});
				return true;
				
			}
			client_str = "UsbKeyLogin.exe,parse.exe,httptransfile.exe,ReplayClient.exe,ReplayClientModule.exe,RdpsReplay.jar,CharReplay.jar" 
		}
		/*
		var sesstimet = (new Date()).valueOf();
		get_regedit('bhostupdate', $("input[name=se]").val(),'',sesstimet);
		//自动升级 插件下载
		cmd_json = {"UrlIp":document.domain+ (location.port!=''?':'+location.port:''), "session":$("input[name=se]").val(),"UpdateExe":client_str,"sesstimet":sesstimet};
		base64_cmd_str = '';
		$.ajax({
			url: '/bhost/base64_encode',
			type: 'post',
			async: false,
			data: { a0: $("input[name=se]").val() ,a1:JSON.stringify(cmd_json)},
			success: function (result) {
				base64_cmd_str = result;
			}
		})
		$('#YuFrame1').remove();
		$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
		$('#YuFrame1').attr('src','/bhost/test_html?t1=bhostupdate&z1='+base64_cmd_str);
		*/
		
		$('.nav-s a').on('click',function(event){
			$('#info').hide();
			$('#msg_manage_1').hide();
			$('#msg_manage_2').hide();
			$('#related_downloads_show').hide();
			$('#terminal_show').hide();
			$('#msg_manage_4').hide();
			$('#msg_manage_5').hide();
			$('#msg_manage_6').hide();
			$('#detail').show();
		})
		$("input.datepicker").datepick();
		$('.form-checkbox,.form-radio').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
		    radioClass: 'iradio_minimal-blue',
		    increaseArea: '0' // optional
		});
		//check 是否是锁定页面
		var flags = 0
		$.ajax({
			url: '/bhost/get_lock_stat',
			type: "post",
			async: false,
			data: {a0:$("input[name=se]").val()},
			success: function(result) {
				var result=JSON.parse(result);
				flags = result.info;
			}
		})
		$.ajax({
			url: '/bhost/Get_MonitorStyle',
			type: "post",
			async: false,
			data: {a0:$("input[name=se]").val()},
			success: function(result) {
				var result=JSON.parse(result);
				$("#MonitorStyle").attr("value",result.info);
				reheight(1);
				if(result.info == 1){
					//$("#nav-s1").children('ul').children().eq(0).children().attr("data-url","/bhost/index?tasktype=1_1&us={{us}}&se={{se}}");
					$("#detail").children().attr("src","/bhost/index?tasktype=1_1&us={{us}}&se={{se}}");
				}else if(result.info == 2){
					//$("#nav-s1").children('ul').children().eq(0).children().attr("data-url","/bhost/index?tasktype=1&us={{us}}&se={{se}}");
					$("#detail").children().attr("src","/bhost/index?tasktype=1&us={{us}}&se={{se}}");
				}


			}
		})		
		if(flags == 2){
			lock_page(1);
		}
		$('.topcontent>ul>li.default').remove();
		$(default_str).each(function(i,item){
			$('.topcontent>ul').append('<li class="content_item default '+item.img_class+' "><a onclick="download_default_file('+item.id+',this);" class="imgbox" style="cursor: pointer;"></a><span class="default_span">'+item.software_name+'</span></li>');
		})
		$('.topcontent>ul').append('<div style="clear:both"></div>');
		
		
		//getPwdStrategy();

		$('.form-select').select2({minimumResultsForSearch: -1});
		//get_AuthType();
		$("a.btn-submit").unbind().bind("click",function(){
			savedata();
		});
		$("a.btn-cancel").unbind().bind("click",function(){
			$("#info").hide();
			$('#related_downloads_show').hide();
			$('#terminal_show').hide();
			$("#detail").show();
		});
		$("a.btn-next").unbind().bind("click",function(){
			var IDReg = /^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/;
			var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
			var phoneReg = /^[0-9]{11}$/;
			var emailReg = /^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/;
			var sys_u_name = $("#sys_u_name").val();
			var user_name = $("#user_name").val();
			var thirduser = $("#thirduser").val();
			var sys_u_depart = $("#sys_u_depart").val();
			var sys_u_phone = $("#sys_u_phone").val();
			var sys_u_email = $("#sys_u_email").val();
			var sys_u_descr = $("#sys_u_descr").val();
			var sys_u_authtype = $("#sys_u_authtype").val();
			var timeSet = $("#timeSet").val();
			var date = $("#datepicker").val();
			var hour = $("#shour").val();
			var min = $("#smin").val();
			var sec = $("#ssec").val();
			var bdiusr = $("#bdiusr").val();
			var manaip = $("#manaip").val();
			var iplimited = $("#iplimited").val();
			var pwdApproveUserId = $("#pu_id").val();
			var sys_u_pwd_new = $("#sys_u_pwd_new").val();
			var sys_u_pwd_tr = $("#sys_u_pwd_tr").val();			
			if(sys_u_pwd_new ==  sys_u_pwd_tr && sys_u_pwd_new == ""){
				sys_u_pwd_new = user_item.Password;
			}				
			else if(sys_u_pwd_new != "" && sys_u_pwd_tr!= "" && sys_u_pwd_new == sys_u_pwd_tr)
			{
				sys_u_pwd_new = $("#sys_u_pwd_new").val();
			}
			else{
				_alert(1,"系统用户","两次密码不匹配");
				return false;
			}				 	
			if(sys_u_name == ""){
				_alert(1,"系统用户","请输入账号");
				return false;
			}
			if(!nameReg.test(user_name)){
				_alert(1,"系统用户","姓名格式不正确");
				return false;
			}
			if(!IDReg.test(sys_u_name) || sys_u_name.length == 1){
				_alert(1,"系统用户","账号格式不正确");
				return false;
			}
			if(!phoneReg.test(sys_u_phone) && sys_u_phone != ""){
				_alert(1,"系统用户","手机格式不正确");
				return false;
			}
			if(!emailReg.test(sys_u_email) && sys_u_email != ""){
				_alert(1,"系统用户","EMAIL格式不正确");
				return false;
			}
			if(user_name == ""){
				_alert(1,"系统用户","请输入姓名");
				return false;
			}
			if(sys_u_pwd_new == "" && flag == 0){
				_alert(1,"系统用户","请输入密码");
				return false;
			}
			if(thirduser != "" ){
				if(!IDReg.test(thirduser) || thirduser.length == 1){
					_alert(1,"系统用户","第三方认证账号格式错误");
					return false;
				}
			}
			time = date+" "+hour+":"+min+":"+sec;
			if(date==""||hour==""||min==""||sec=="") time = "";
			if (time == "" && $("#timeSet").prop("checked")){
				_alert(1,"系统用户","请输入完整时间");
				return false;
			}
		});
		$('#timeSet').on('ifChecked', function(event){
		  $('#timeSetSpan').show();
		}).on('ifUnchecked', function(event){
		  $('#timeSetSpan').hide();
		});
		$('.form-time').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
		get_msg();
		get_bhclient();
		get_msg_alert();
		$('.nav-s li').hide();
		$('#nav-s2').children().find('li').show();
		/*var _power_SystemMenuId_arr=_power.map(function (params) {
			return params.SystemMenuId;
		});*/
		var _power_SystemMenuId_arr=[];	
		for(var i=0;i<_power.length;i++){
			_power_SystemMenuId_arr.push(_power[i].SystemMenuId);
		}
		/*var _power_SubMenuId=_power.map(function (params) {
			return params.SubMenuId
		});*/
		var _power_SubMenuId=[];
		for(var i=0;i<_power.length;i++){
		  _power_SubMenuId.push(_power[i].SubMenuId);
		}
		if($.inArray(1,_power_SystemMenuId_arr)>=0){
			$('li[data-modeid=1]').show();
		}
		// 三权分立 8->运维操作(操作、会话) 9->运维管理(系统日志-运维部分) 11->系统日志(系统日志-非运维用户部分) 12->报表管理 
		if($.inArray(8,_power_SubMenuId)>=0 || $.inArray(9,_power_SubMenuId)>=0 || $.inArray(11,_power_SubMenuId)>=0){
			$('li[data-modeid=2]').show();
			dia = [0,0,0];
			$(_power).each(function(i,item){
				if(item.SubMenuId == 8) dia[0] = item.Mode;
				if(item.SubMenuId == 9) dia[1] = item.Mode;
				if(item.SubMenuId == 11) dia[2] = item.Mode;
			})	
			$('li[data-modeid=2]').attr('_if_disable',dia.join('-'));
			
		}
		if($.inArray(8,_power_SubMenuId)>=0 || $.inArray(9,_power_SubMenuId)>=0 || $.inArray(11,_power_SubMenuId)>=0 || $.inArray(12,_power_SubMenuId)>=0){
			dia = [1,1,1,1];
			$('li[data-modeid=3]').show();
			$(_power).each(function(i,item){
				if(item.SubMenuId == 8) dia[0] = item.Mode;
				if(item.SubMenuId == 9) dia[1] = item.Mode;
				if(item.SubMenuId == 11) dia[2] = item.Mode;
				if(item.SubMenuId == 12) dia[3] = item.Mode;
			})	
			$('li[data-modeid=3]').attr('_if_disable',dia.join('-'));
		}
		if($.inArray(3,_power_SystemMenuId_arr)>=0){
			$('li[data-modeid=4]').show();		
			dia = [1,1,1,1,1,1,1];
			$(_power).each(function(i,item){
				if(item.SubMenuId == 13) dia[0] = item.Mode;
				if(item.SubMenuId == 14) dia[1] = item.Mode;
				if(item.SubMenuId == 15) dia[2] = item.Mode;
				if(item.SubMenuId == 16) dia[3] = item.Mode;
				if(item.SubMenuId == 17) dia[4] = item.Mode;
				if(item.SubMenuId == 18) dia[5] = item.Mode;
				if(item.SubMenuId == 32) dia[6] = item.Mode;
			})
			$('li[data-modeid=4]').attr('_if_disable',dia.join('-'));
		}
		if($.inArray(4,_power_SystemMenuId_arr)>=0){
			$('li[data-modeid=5]').show();
		}
		if($.inArray(5,_power_SystemMenuId_arr)>=0){
			$('li[data-modeid=6]').show();
		}
		if($.inArray(6,_power_SystemMenuId_arr)>=0){
			$('li[data-modeid=7]').show();
			$(_power).each(function(i,item){
				if(item.SystemMenuId == 6){
					$('li[data-modeid=7]').attr('_if_disable',item.Mode);
					return false;
				}
			})			
		}
		
		if($('li[data-modeid=1]').is(':hidden')){
			var li_visible=$('.nav-s li:visible');
			li_visible.eq(0).children('a').trigger('click');
		}
		$('#IPorMAC').select2({minimumResultsForSearch: -1});
		var user = "{{us}}";
		_get_userid(user);
	})
	
	function reheight(type){
		var height1 = $("#mainFrame").height();
		if(type == 1){
			if(height1 == ($("#detail").height()-60)){
				height1 = height1+6;
			}
		}else{
			if(height1 != ($("#detail").height()-60)){
				height1 = ($("#detail").height()-60);
			}
		}
		
		$("#mainFrame").height(height1);
	}

	function reload(type){
		if(type == 1){
			user_info('{{us}}');
		}
	}
	function _get_userid(obj){
		var _un = obj;
		$.ajax({
			url:'/bhost/_get_userid',
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:_un},
			success: function(Result) {
				data = JSON.parse(Result);
				u_id = data.info;
			}
		})
		show_list();
	}
	var t_get_bh;
	function get_bhclient(){
		//return false;
		BH_ok();
		//循环获取 数据库状态
	};
	function detectOS() {
		var sUserAgent = navigator.userAgent;
		
		var isWin = (navigator.platform == "Win32") || (navigator.platform == "Windows");
		var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");
		if (isMac) return "Mac";
		var isUnix = (navigator.platform == "X11") && !isWin && !isMac;
		if (isUnix) return "Unix";
		var isLinux = (String(navigator.platform).indexOf("Linux") > -1);
		var bIsAndroid = sUserAgent.toLowerCase().match(/android/i) == "android";
		if (isLinux) {
		if(bIsAndroid) return "Android";
		else return "Linux";
		}
		if (isWin) {
			var isWin2K = sUserAgent.indexOf("Windows NT 5.0") > -1 || sUserAgent.indexOf("Windows 2000") > -1;
			if (isWin2K) return "Win2000";
			var isWinXP = sUserAgent.indexOf("Windows NT 5.1") > -1 ||
			sUserAgent.indexOf("Windows XP") > -1;
			if (isWinXP) return "WinXP";
			var isWin2003 = sUserAgent.indexOf("Windows NT 5.2") > -1 || sUserAgent.indexOf("Windows 2003") > -1;
			if (isWin2003) return "Win2003";
			var isWinVista= sUserAgent.indexOf("Windows NT 6.0") > -1 || sUserAgent.indexOf("Windows Vista") > -1;
			if (isWinVista) return "WinVista";
			var isWin7 = sUserAgent.indexOf("Windows NT 6.1") > -1 || sUserAgent.indexOf("Windows 7") > -1;
			if (isWin7) return "Win7";
			return 'Win';
		}
		return "other";
	}
	var if_ok_down_BH;
	function BH_ok(){
        var c = 0;
		clearTimeout(if_ok_down_BH);
		var detectOS_value= detectOS();
		if(detectOS_value=='other' || detectOS_value=='Mac'){
			window.parent.document.frm.use_BH.value='0';
		}else{
			var sesstimet = (new Date()).valueOf();
			//插入数据库数据
			$.ajax({
					url: "/bhost/insert_usbkeys",
					type:"POST",
					async:false,
					data:{a0:$("input[name=se]").val(),z1:sesstimet,t1:"IfUpdate",u1:' ',c1:' ',a10:""},
					success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								var referrer_arr=document.referrer.toString().split('/');
								referrer_arr.pop();
								var referrer=referrer_arr.join('/');
								var json_download = {
										"Url": referrer,
										"Session": $("input[name=se]").val(),
										"sesstimet":sesstimet
								}
								var if_html_client = false;
								var base64_str = '';
								$.ajax({
										url: "/bhost/get_base64",
										type:"POST",
										async:false,
										data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
										success:function(result){
												var result=JSON.parse(result);
												if(result.Result){
														if_html_client = result.info;
														base64_str = result.b64;
												}else{
														_alert(1,"相关下载",result.ErrMsg); 
												}
										}
								})
								if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
								else{
									$('#YuFrame1').remove();
									$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
									$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
								}
							}else{
								return false;
							}
					}
			});
			
			var if_ok_down_BH_i=setInterval(function(){
				ret = repeat_get_path_other(sesstimet,$("input[name=se]").val());
				if(ret[0] == 1 && ret[1].toLowerCase() =='true' ){
						window.parent.document.frm.use_BH.value='1';
						clearInterval(if_ok_down_BH_i);
						//if_ok_down_BH=setTimeout(function(){
						//	BH_ok();
						//},60000);
						return 0;
				}
				else{
					window.parent.document.frm.use_BH.value='0';
				}
				if(c >=10){
					clearInterval(if_ok_down_BH_i);
					//if_ok_down_BH=setTimeout(function(){
					//	BH_ok();
					//},60000);
					return 0;
				}
				c = c + 1;
			},500);
			
		}
	}
	var t_get_msg_a;
	function get_msg_alert(){
		clearTimeout(t_get_msg_a);
		var n=0;
		$.ajax({
			url: "/bhost/get_msg_list",
			type:"POST",
			async:true,
			data:{a0:$("input[name=se]").val(),a1:'null',a2:USERACCOUNT,a3:2,a4:'null',a5:'null',a6:'null'},
			success:function(result){
				var msg_result = JSON.parse(result);
				if(result.Result == false){
					if(result.info.indexOf('系统异常')>=0 || result.info.indexOf('非法访问')>=0 || result.info.indexOf('系统超时') >=0 ){
						_alert(2,'系统',result.info);
					}else{
						_alert(2,'系统',result.info);
					}
				}
				else{
					msg_result = msg_result.info;
					if(msg_result.totalrow == 0){
						$("#msg_num").hide();
					}else{
						$("#msg_num").show();
						$("#msg_num").text(msg_result.totalrow);
					}
					t_get_msg_a=setTimeout(function(){get_msg_alert();},5000);
				}
				return false;
			},
			error:function(){
				t_get_msg_a=setTimeout(function(){get_msg_alert();},5000);
			}
		})
	}

	var PwdStrategy;
	function getPwdStrategy(){
		$.ajax({
			url:'/bhost/get_pwdstrategy',
			type:"POST",
			async:true,
			data:{a0:$("input[name=se]").val()},
			success: function(Result) {
				data = JSON.parse(Result);
				PwdStrategy = data.info;
			}
		})
	}
	//令牌
	function _get_tokenid(current_name){
		$("#TokenID").empty().html('<div class="item" style="float: left;margin-top: -10px;width: 100%"><select class="filter-select" name="ti" id="ti" style="width: 203px;" tabindex="-1" aria-hidden="false"></select></div>');
		var s = {
			"TokenId":"",
			"Key":"",
			"UserSet":"",
			"searchstring":""
		}
		$.ajax({
			url:"/bhost/get_toten_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a5:JSON.stringify(s)},
			success:function(result){
				token_result = JSON.parse(result);
				if(token_result.Result){
					token_result = token_result.info;
					$("#ti").empty().append('<option value=\"-1\">选择令牌</option>');
					$.each(token_result.data,function(i,item){
						if((item.UserSet == null || item.UserSet == current_name) && item.Memo == '已检测'){
							$("#ti").append('<option value="'+item.TokenId+'" title="'+item.TokenId+'">'+item.TokenId+'</option>');
						}
					})
				}else{
					_alert(1,"系统用户",'获取令牌失败');
				}
			}
		});
		$('#TokenID .filter-select').select2();
	}
	//显示列表
	var authDefault_flag=0;
	var global_maid = 0;
	function show_list(){
		//表单清空
		$("#sys_u_name").val("");
		$("#user_name").val("");
		$("#sys_u_pwd_old").val("");		
		$("#sys_u_pwd_new").val("");
		$("#sys_u_pwd_tr").val("");
		$("#thirduser").val("");
		$("#sys_u_depart").val("");
		$("#sys_u_phone").val("");
		$("#sys_u_email").val("");
		$("#sys_u_descr").val("");
		$("#sys_u_authtype").val(1).trigger("change");
		$("#datepicker").val("");
		$("#shour").val("");
		$("#smin").val("");
		$("#ssec").val("");
		$(".v-check").hide();
		$("#un").empty();
		$("#rn").empty();
		$("#pu_id").empty();
		$("#pwd1").hide();
		$("#pwd2").hide();
		$("#pwd3").hide();
		$("#change_Pwd").show();
		$("#auth_divs").children("li").remove();
		$("#Temp4 .sitem").not(":first").remove();
		$("#Temp4 .sitem:first").children("select").val("5").trigger("change");
		IPList = {"IPSetId":0,"Set":[]};
		MACList = {"MACSetId":0,"Set":[]};
		local_check = false;
		local_check_default = false;
		new_pin = "";	
		FP_TMP = "";
		List1 = {
		  "ClientScopeId": 0,
		  "Type": 1, 
		  "IPList": null,
		  "MACList": null
		};
		List2 = {
			"ClientScopeId": 0,
			"Type": 2, 
			"IPList": {},
			"MACList": {}
		};
		CScopeSet =[];
		$("#pu_id").val(0).trigger("change");
		$('#tAvatar>img').attr('src','/manage/images/avatar1.jpg');
		if(u_id == 1){
			d1_tmp = false;
		}else{
			d1_tmp = true;
		}
		$.ajax({
			url:'/bhost/make_cache',
			type:"POST",
			async:false,
			success: function(Result) {
				data = JSON.parse(Result);
				start_time = data['start_time'];
				cnone = data['cnone'];
				sign = data['sign'];
			}
		})
		
		$.ajax({
			url:"/bhost/get_user_list1",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:u_id,d1:d1_tmp,s1:start_time,c1:cnone,sign:sign},
			success:function(result){
				user_item = JSON.parse(result);
				if(user_item.Result == false){
					//_alert(1,"系统用户","获取信息失败");
					//logout();
					return false;
				}
				user_item = user_item.info;
			}
		})
		_get_un(user_item);
		//get_authtype_list();
		getPwdStrategy();
		
		//_get_rn(user_item);
		if(user_item.PwdApproveUserId == null){
			user_item.PwdApproveUserId = 1;
		}
		if(user_item.PhotoIcon == null){
			user_item.PhotoIcon = "avatar1.jpg";
		}
		user_ugroup = user_item.UGroupSet;
		$("#sys_u_name").val(user_item.UserCode);
		$("#user_name").val(user_item.UserName);
		$("#UserNumber").val(user_item.UserNumber);
		$("#sys_u_pwd_new").val("");
		$("#sys_u_pwd_tr").val("");
		$("#thirduser").val(user_item.ThirdUserCode);
		$("#sys_u_depart").val(user_item.Department);
		$("#sys_u_phone").val(user_item.MobilePhone);
		$("#sys_u_email").val(user_item.Email);
		$("#sys_u_descr").val(user_item.Description);
		$("#u_i").val(user_item.UserId);
		$("#sys_u_authtype").val(user_item.AuthTypeId).trigger("change");
		$("#u_i").text(user_item.UserCode);
		$("#u_i").append('<img src="/manage/images/'+user_item.PhotoIcon+'" alt="">');
		// <span class="s">split118<img src="/manage/images/avatar3.jpg" alt=""></span>
		if(user_item.ExpireTime != null){
			var date = user_item.ExpireTime.split('T')[0];
			var time = user_item.ExpireTime.split('T')[1];
			var hour = time.split(':')[0];
			var min = time.split(':')[1];
			var sec = time.split(':')[2];
			$("#datepicker").val(date);
			$("#shour").val(hour);
			$("#smin").val(min);
			$("#ssec").val(sec);
		}
		var ph = user_item.PhotoIcon;
		ph = "/manage/images/" +ph;
		$('#tAvatar>img').attr('src' ,ph);
		if(user_item.SrcIPUnlimited == true){
			$("#iplimited").iCheck('check');
		}
		if(user_item.ManageIPUnlimited == true){
			$("#manaip").iCheck('check');
		}
		if(user_item.ExpireTimeEnabled == true){
			$("#timeSet").iCheck('check');
		}
		
		$("#sys_u_name").attr("disabled",true);
		if(user_item.UserStatus == 1) $('#status').iCheck('check')
		else $('#status').iCheck('uncheck')
		
		//{"Result":true,"info":{"totalrow": 1, "data": [{"Set": [{"PwdLen": 6, "AuthModuleId": 6, "AuthMode": 6, "Order": 1, "AuthModuleName": "\u4ee4\u724c"}, {"PwdLen": 5, "AuthModuleId": 8, "AuthMode": 8, "Order": 2, "AuthModuleName": "Logbase usbkey"}], "MustAllModulesSucc": true, "AuthTypeId": 1002, "AuthTypeName": "pin-usb", "Separator": null, "IsDefault": false}]}}
		if(user_item.UserCode =='admin'){
			$('#authtype_list_select').parent().parent().show();
		}
		
		_get_tokenid(user_item.UserCode);
				
		AuthTypeId = user_item.AuthTypeId;
		
		bind_authtype_xSelect();
		authDefault_flag = 0;		
		$.each(authtype_data,function(i,item){
			if(item.IsDefault == true){
				$.each(item.Set,function(i1,item1){
					if(item1.AuthMode == 6){ //令牌
						authDefault_flag += 1;
					}else if(item1.AuthMode == 8){ //logbase key
						authDefault_flag += 2;
					}else if(item1.AuthMode == 10){ // totp
						authDefault_flag += 4;
					}else if(item1.AuthMode == 1){
						local_check_default = true;
					}
				})
			}	
		})
		
		flag_pin = 0;
		$(authtype_list).each(function(i,item){
			if(user_item.AuthTypeId == item.AuthTypeId){
				$(item.Set).each(function(i1,item1){
					if(item1.AuthMode == 8){
						flag_pin = 1;
					} 
				})
			}
		})		
		//$("#sys_u_authtype").val((user_item.AuthTypeId==null?'null':user_item.AuthTypeId)).trigger("change");
		$("#sys_u_authtype").find('span').text(user_item.AuthTypeId==null?'默认':user_item.AuthTypeName);
		$('#sys_u_authtype').data('value',user_item.AuthTypeId==null?'-1':user_item.AuthTypeId);
		$('.xSelect-authtype li').each(function(){
			if($(this).children('span').data('value') == (user_item.AuthTypeId==null?'-1':user_item.AuthTypeId)){
				change_authtype_scope(this);
				$(this).attr('class','active');
			}
		})
		if(user_item.TokenId != null){
			$("#ti").val(user_item.TokenId).trigger('change');
		}
		$('#CertCn').val(user_item.CertCn);

		$.ajax({//获取用户认证配置
			url:"/bhost/get_authConfig",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:u_id},
			success:function(result){
				auth_item = JSON.parse(result.replace(/\n/g,"\\n").replace(/\t/g,"\\t"));
				if(auth_item.Result == false){
					_alert(1,"系统用户","获取认证配置信息失败："+user_item.ErrMsg);
					return false;
				}
				if(auth_item.fFlag == true){
					FP_SET = true;
					auth_item.fContent.replace(/\\n/g,"\n").replace(/\\t/g,"\t");
					$.each(auth_item.fContent.split('\n'),function (i,item) {
						var fp_name = item.split('\t')[0];
						if(FP_TMP == ""){
							FP_TMP = fp_name + '\t' + item.split('\t')[1];
						}else{
							FP_TMP = FP_TMP + '\n' + fp_name + '\t' + item.split('\t')[1];
						}
						var html_str1 = '<li class="item" id="fp_index'+i+'" index="'+i+'" style="width: 15%;"><input type="text" class="form-text" id="fp_conf'+i+'" maxlength="31" style="width: 66px;" onblur="change_fpName(this)"><i class="ctrl del" onclick="_delFp(this)"></i></li>';
						$("#auth_divs").append(html_str1);
						$("#auth_divs").children('li:last').children('input').val(fp_name);
					})
				}
				//.replace(/\\n/g,"\n").replace(/\\t/g,"\t");
			}
		})

		if(user_item.UserCode == 'admin'){
			bind_client_xSelect();
			$("#append_div").show();
			var CScopeSet =[];
			//绑定 客户端地址
			var MScopeSet = []; // 先把原来数据中的服务器管理取出来
			flag_client_all = 1;
			if(user_item.ManageAuthSet == null ) {
				CScopeSet=[];
				user_item.ManageAuthSet = [];
			}else{
				var maid = user_item.ManageAuthSet;
				global_maid = maid[0].ManageAuthId;
				CScopeSet1 = user_item.ManageAuthSet;
				var cslist = [];
				$(CScopeSet1).each(function(i,item){
					if(item.CScopeSet == null) return true;
					$(item.CScopeSet).each(function(i1,item1){
						if (item1.Type == 1){
							if(cslist.indexOf(item1.ClientScopeId) >= 0) return true;
							cslist.push(item1.ClientScopeId);
							$("#add2").next('select').val(5).trigger('change');
							$("#accset").find('span').text(item1.ClientScopeName);
							$('#accset').data('value',item1.ClientScopeId);
							if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" && $("#accset").find('span').text() != "请选择"){
								$("#add2").click();
							}
							if(item.ManageAuthName.indexOf('#') <0 ){
								$("#add2").parent('div').next().children('i.del').remove(); //##公有的 不能删除
								$("#add2").parent('div').next().attr('auth_id',item.ManageAuthId);
							}
							
						}else{
							if(item1.IPList == null) item1.IPList == [];
							if(item1.MACList == null) item1.MACList == [];
							
							$.each(item1.IPList.Set,function(i2,item2){
								if(item2.StartIP == item2.EndIP){
									$("#add2").next().val(1).trigger('change');
									$("#Temp4 .sitem:first").find('.set-view.set-view4').children().val(item2.StartIP);
									//if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" && $("#accset").find('span').text() != "请选择"){
									if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" && $("#Temp4").children('.sitem:first').find('input:visible').val() != undefined){
										$("#add2").click();
									}
								}else{
									$("#add2").next().val(2).trigger('change');
									$("#Temp4 .sitem:first").find('.set-view.set-view2').children().eq(0).val(item2.StartIP);
									$("#Temp4 .sitem:first").find('.set-view.set-view2').children().eq(2).val(item2.EndIP);
									
									if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" && $("#Temp4").children('.sitem:first').find('input:visible').val() != undefined){
										$("#add2").click();
									}
								}
							});
							$.each(item1.MACList.Set,function(i2,item2){
								if(item2.StartMACAddress == item2.EndMACAddress){
									$("#add2").next().val(3).trigger('change');
									$("#Temp4 .sitem:first").find('.set-view.set-view3').children().val(item2.StartMACAddress);
									if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" ){
										$("#add2").click();
									}
									//$("#add2").click();
								}else{
									$("#add2").next().val(4).trigger('change');
									$("#Temp4 .sitem:first").find('.set-view.set-view5').children().eq(0).val(item2.StartMACAddress);
									$("#Temp4 .sitem:first").find('.set-view.set-view5').children().eq(2).val(item2.EndMACAddress);
									if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" ){
										$("#add2").click();
									}								
									//$("#add2").click();
								}
							});			
						}	
					})			
				})
			}
		}else{
			$("#append_div").hide();
		}
	}
	

	var accdata;
	var c_index_all;
	function binding_clientset() {
		$.ajax({
			url:'/bhost/get_clientset_z',
			type:'post',
			async:false,
			data:{a0: $("input[name=se]").val()},
			success:function(result){
				accdata = JSON.parse(result);
			}
		});
	}

	//绑定客户端集合
	function bind_client_xSelect(){
		$('#accset').empty().data('xSelect','');
		$("div[data-id=xSelect-client]").remove();
		binding_clientset();
		var client_array = [];
		c_index_all = [];
		
		if(uMode =='1'){
			type_str ='check';
		}else{
			type_str ='edit';
		}
		
		//type_str ='edit';
		$.each(accdata.data,function(i,item){
			if ($("#accset").data('value') == item.ClientScopeId){
				 
			}else{
				if (client_list.indexOf(item.ClientScopeId) > -1){
					return true;
				}
			}
			
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':type_str
			};
			select_data_json.value = item.ClientScopeId;
			select_data_json.name = item.ClientScopeName;
			client_array.push(select_data_json);
			c_index_all.push(item.ClientScopeId);
		});
		
		if(uMode =='1'){
			$('#accset').xSelect({
				width: 334,
				defaultText: '请选择',
				items:client_array,
				module_type:'client',
				edit: function(item,obj){
					$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
					_editNode2(obj,1)
				},
				check: function(item,obj){
					$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
					_editNode2(obj,1)
				},
				setval:function(item,obj){
					//change_client_scope(obj);
				}
			});
		}else{
			$('#accset').xSelect({
				width: 334,
				defaultText: '请选择',
				items:client_array,
				module_type:'client',
				edit: function(item,obj){
					$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
					_editNode2(obj,1)
				},
				check: function(item,obj){
					$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
					_editNode2(obj,1)
				},
				btn:[
					{
						'name':'新增',
						'event': function(items,obj){
							_editNode2(obj,2);
						}
					}
				],
				setval:function(item,obj){
					//change_client_scope(obj);
				}
			});
		}
	}
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var ipReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
	//创建
	function client_add(d) {
		var ip_section = 1;
		var mac_address = 1;
		var ip_section1 = 1;
		var mac_address1 = 1;
		var pass = 1;
		var no_pass = "";
		var val = $("#c_n").val();
		var $i = $("#c_n").next('i.v-check');
		if (val == "") {
			_alert(2, '客户端集合操作', '名称不能为空',$("#c_n"));
			return false;

		} else if (!nameReg.test(val)) {
			_alert(2, '客户端集合操作', '名称不符合要求',$("#c_n"));
			return false;
		}
		var v2 = $("#ip_n_c1").find("span[class='ss ss-add']").children("input").val().trim();
		if (v2=='' && !$(">span[class='ss']", "#ip_n_c1").length) {
			ip_section1 = 0;
		}
		var ip_n_c1_len = $('#ip_n_c1').children('span').length;
		$('#ip_n_c1').children('span').each(function(i,item){
			if (ip_section1 == 0){
				return true;
			}
			var input1 = $(item).find('input').val();
			if (i == 0 && input1 == "" && ip_n_c1_len != 1){
				return true;
			}
			if (input1 == ""){
				pass = 0;
				_alert(2, '客户端集合操作', 'IP地址不能为空', $(item).find('input'));
				return false;
			}
			if (!ipReg.test(input1)) {
				pass = 0;
				_alert(2, '客户端集合操作', 'IP地址格式错误', $(item).find('input'));
				return false;
			}
			$('#ip_n_c1').children('span').not($(item)).each(function(i1,item1){
				if (i1 < i){
					return true;
				}
				var input2 = $(item1).find('input').val();
				if (input2 == ""){
					pass = 0;
					_alert(2, '客户端集合操作', 'IP地址不能为空', $(item1).find('input'));
					return false;
				}
				if (!ipReg.test(input2)) {
					pass = 0;
					_alert(2, '客户端集合操作', 'IP地址格式错误', $(item1).find('input'));
					return false;
				}
				if (input1 == input2){
					pass = 0;
					_alert(2,"客户端集合操作","IP地址重复",$(item).find('input'));
					return false;
				}
			});
			if (pass == 0){
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
		var v = $("#ip_n_c").find("span[class='ss ss-add']").children("input").first().val().trim();
		var v1 = $("#ip_n_c").find("span[class='ss ss-add']").children("input").last().val().trim();

		if (v=="" && v1 == "" && !$(">span[class='ss']", "#ip_n_c").length) {
			ip_section = 0;
		}
		var ip_n_c_len = $("#ip_n_c").children('span').length;
		$("#ip_n_c").children('span').each(function(i,item){
			if (ip_section == 0){
				return true;
			}
			var ip_input1 = $(item).find('input:eq(0)').val();
			var ip_input2 = $(item).find('input:eq(1)').val();
			if (i == 0 && ip_input1 == "" && ip_input2 == "" && ip_n_c_len != 1){
				return true;
			}
			if (ip_input1 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '起始IP为空', $(item).find('input:eq(0)'));
				return false;
			} else if (!ipReg.test(ip_input1)) {
				pass = 0;
				_alert(2, '客户端集合操作', '起始IP格式错误', $(item).find('input:eq(0)'));
				return false;
			}
			if (ip_input2 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '结束IP为空',$(item).find('input:eq(1)'));
				return false;
			} else if (!ipReg.test(ip_input2)) {
				pass = 0;
				_alert(2, '客户端集合操作', '结束IP格式错误', $(item).find('input:eq(1)'));
				return false;
			}
			var r_v = _compare_ip(ip_input1,ip_input2);
			if (r_v != 3){
				pass = 0;
				_alert(2, '客户端集合操作', '起始IP不能大于等于结束IP', $(item).find('input:eq(0)'));
				return false;
			}
			$("#ip_n_c").children('span').not($(item)).each(function(i1,item1){
				if (i1 < i){
					return true;
				}
				var ip1_input1 = $(item1).find('input:eq(0)').val();
				var ip1_input2 = $(item1).find('input:eq(1)').val();
				if (ip1_input1 == '') {
					pass = 0;
					_alert(2, '客户端集合操作', '起始IP为空', $(item1).find('input:eq(0)'));
					return false;
				} else if (!ipReg.test(ip1_input1)) {
					pass = 0;
					_alert(2, '客户端集合操作', '起始IP格式错误', $(item1).find('input:eq(0)'));
					return false;
				}
				if (ip1_input2 == '') {
					pass = 0;
					_alert(2, '客户端集合操作', '结束IP为空',$(item1).find('input:eq(1)'));
					return false;
				} else if (!ipReg.test(ip1_input2)) {
					pass = 0;
					_alert(2, '客户端集合操作', '结束IP格式错误', $(item1).find('input:eq(1)'));
					return false;
				}
				var r_v = _compare_ip(ip1_input1,ip1_input2);
				if (r_v != 3){
					pass = 0;
					_alert(2, '客户端集合操作', '起始IP不能大于等于结束IP', $(item1).find('input:eq(0)'));
					return false;
				}
				if (ip1_input1 == ip_input1 && ip_input2 == ip1_input2){
					pass = 0;
					_alert(2,"客户端集合操作","IP区间重复",$(item).find('input:eq(1)'));
					return false;
				}
			});
			if (pass == 0){
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
		
		var input_str = $("#MACAddress").find("span[class='ss ss-add']").children("input").val();
		if (input_str=='' && !$(">span[class='ss']", "#MACAddress").length) {
			mac_address = 0;
		}
		var mac_len = $('#MACAddress').children('span').length;
		$('#MACAddress').children('span').each(function(i,item){
			if (mac_address == 0){
				return false;
			}
			var input1 = $(item).find('input').val();
			if (i == 0 && input1 == "" &&  mac_len != 1){
				return true;
			}
			
			if (input1 == ""){
				pass = 0;
				_alert(2,"客户端集合操作","MAC地址不能为空",$(item).find('input'));
				return false;
			}
			if (!MACReg.test(input1)){
				pass = 0;
				_alert(2, '客户端集合操作', 'MAC地址格式错误',$(item).find('input'));
				return false;
			}
			$('#MACAddress').children('span').not($(item)).each(function(i1,item1){
				if (i1 < i){
					return true;
				}
				var input2 = $(item1).find('input').val();
				if (input2 == ""){
					pass = 0;
					_alert(2,"客户端集合操作","MAC地址不能为空",$(item1).find('input'));
					return false;
				}
				if (!MACReg.test(input2)){
					pass = 0;
					_alert(2, '客户端集合操作', 'MAC地址格式错误',$(item1).find('input'));
					return false;
				}
				if (input1 == input2){
					pass = 0;
					_alert(2,"客户端集合操作","MAC地址重复",$(item).find('input'));
					return false;
				}
			});
			if (pass == 0){
				return false;
			}
		});
		
		if (pass == 0){
			return false;
		}
		
		var input_str1 = $("#MACAddress1").find("span[class='ss ss-add']").children("input").first().val().trim();
		var input_str2 = $("#MACAddress1").find("span[class='ss ss-add']").children('input').last().val().trim();
			
		if (input_str1 == "" && input_str2 == "" && !$(">span[class='ss']", "#MACAddress1").length) {
			mac_address1 = 0;
		}
		var mac1_len = $("#MACAddress1").children('span').length;
		$("#MACAddress1").children('span').each(function(i,item){
			if (mac_address1 == 0){
				return true;
			}
			var mac_input1 = $(item).find('input:eq(0)').val();
			var mac_input2 = $(item).find('input:eq(1)').val();
			if (i == 0 && mac_input1 == "" && mac_input2 == "" && mac1_len != 1){
				return true;
			}
			if (mac_input1 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '起始MAC地址为空',$(item).find('input:eq(0)'));
				return false;
			} else if (!MACReg.test(mac_input1)) {
				pass = 0;
				_alert(2, '客户端集合操作', '起始MAC地址格式错误',$(item).find('input:eq(0)'));
				return false;
			}
			if (mac_input2 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '结束MAC地址为空',$(item).find('input:eq(1)'));
				return false;
			} else if (!MACReg.test(mac_input2)) {
				pass = 0;
				_alert(2, '客户端集合操作', '结束MAC地址格式错误',$(item).find('input:eq(1)'));
				return false;
			}
			var r_v = _compare_mac(mac_input1,mac_input2);
			if (r_v != 3){
				pass = 0;
				_alert(2, '客户端集合操作', '开始MAC地址不能大于等于结束MAC地址',$(item).find('input:eq(0)'));
				return false;
			}
			
			$("#MACAddress1").children('span').not($(item)).each(function(i1,item1){
				if (i1 < i){
					return true;
				}
				var mac1_input1 = $(item1).find('input:eq(0)').val();
				var mac1_input2 = $(item1).find('input:eq(1)').val();
				if (mac1_input1 == '') {
					pass = 0;
					_alert(2, '客户端集合操作', '起始MAC地址为空',$(item1).find('input:eq(0)'));
					return false;
				} else if (!MACReg.test(mac1_input1)) {
					pass = 0;
					_alert(2, '客户端集合操作', '起始MAC地址格式错误',$(item1).find('input:eq(0)'));
					return false;
				}
				if (mac1_input2 == '') {
					pass = 0;
					_alert(2, '客户端集合操作', '结束MAC地址为空',$(item1).find('input:eq(1)'));
					return false;
				} else if (!MACReg.test(mac1_input2)) {
					pass = 0;
					_alert(2, '客户端集合操作', '结束MAC地址格式错误',$(item1).find('input:eq(1)'));
					return false;
				}
				var r_v = _compare_mac(mac1_input1,mac1_input2);
				if (r_v != 3){
					pass = 0;
					_alert(2, '客户端集合操作', '开始MAC地址不能大于等于结束MAC地址',$(item1).find('input:eq(0)'));
					return false;
				}
				if (mac1_input1 == mac_input1 && mac1_input2 == mac_input2){
					pass = 0;
					_alert(2,"客户端集合操作","MAC地址区间重复",$(item).find('input:eq(1)'));
					return false;
				}
			});
			if (pass == 0){
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
		
		if (mac_address == 0 && ip_section == 0 && mac_address1==0 && ip_section1==0) {
			_alert(2, "客户端集合操作", "IP地址/区间、MAC地址/区间不能同时为空", $("#ip_n_c1").find("span[class='ss ss-add']").children("input"));
			return false;
		}

		if (pass == 1) {
			//var clientId = document.frm_client_add.clientId.value;
			client_set.ClientScopeId = clientId;
			client_set.ClientScopeName = val;
			client_set.IPList.Set = new Array();
			client_set.MACList.Set = new Array();
			var i = 1;
			var $all=$('#ip_n_c').find('span[class=ss]');
			var len=$all.length;
			for(j=len-1;j>=0;j--){
				var ip_id =$all.eq(j).attr("value");
				var input1 = $all.eq(j).find("input").eq(0).val();
				var input2 = $all.eq(j).find("input").eq(1).val();
				var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + input1 + '","EndIP":"' + input2 + '"}';
				client_set.IPList.Set.push(JSON.parse(json_a));
				i++;
			}

			if (v != "" && v1 != "") {
				ip_id = $("#ip_span").attr("value");
				var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + v + '","EndIP":"' + v1 + '"}';
				client_set.IPList.Set.push(JSON.parse(json_a));
				i++;
			}
			var $all=$('#ip_n_c1').find('span[class=ss]');
			var len=$all.length;
			for(var j=len-1;j>=0;j--){
				var ip_id = $all.eq(j).attr("value");
				var ip_str =  $all.eq(j).find("input").val();
				var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + ip_str + '","EndIP":"' + ip_str + '"}';
				client_set.IPList.Set.push(JSON.parse(json_a));
				i++;
			}

			if (v2 != "") {
				ip_id = $("#ip_span1").attr("value");
				var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + v2 + '","EndIP":"' + v2 + '"}';
				client_set.IPList.Set.push(JSON.parse(json_a));
				i++;
			}
			var i = 1;
			var $all=$("#MACAddress").find('span[class=ss]');
			var len=$all.length;
			for(var j=len-1;j>=0;j--){
				var mac_id = $all.eq(j).attr("value");
				var mac_str = $all.eq(j).find("input").val();
				var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + mac_str + '","EndMACAddress":"' + mac_str + '"}';
				client_set.MACList.Set.push(JSON.parse(json_a));
				i++;
			}

			if (input_str != "") {
				var mac_id = $("#MACAddress").find('.ss-add').attr("value");
				var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + input_str + '","EndMACAddress":"' + input_str + '"}';
				client_set.MACList.Set.push(JSON.parse(json_a));
				i++
			}
			var $all=$('#MACAddress1').find('span[class=ss]');
			var len=$all.length;
			for(var j=len-1;j>=0;j--){
				var mac_id = $all.eq(j).attr("value");
				var mac_0 = $all.eq(j).find("input").eq(0).val();
				var mac_1 = $all.eq(j).find("input").eq(1).val();
				var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' +mac_0 + '","EndMACAddress":"' +mac_1 + '"}';
				client_set.MACList.Set.push(JSON.parse(json_a));
				i++;
			}

			if(input_str1!="" && input_str2!=''){
				var mac_id = $("#MACAddress1").find('.ss-add').attr("value");
				var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + input_str1 + '","EndMACAddress":"' + input_str2 + '"}';
				client_set.MACList.Set.push(JSON.parse(json_a));
				i++;
			}
			client_set.IsApplyToServerScope = false;
			save_client(client_set,d);
		}
	}

	//加入ip
	function _addIp_c1(obj) {
		var pass = 1;
		var v = $(obj).prev('input').val().trim();
		if (v == '') {
			_alert(1,"客户端集合", 'IP不能为空',$(obj).prev('input'));
			//$(obj).prev('input').val("");
			return false;
		} else if (!ipReg.test(v)) {
			_alert(1,"客户端集合", 'IP格式错误',$(obj).prev('input'));
			//$(obj).prev('input').val("");
			return false;
		} else {
			$(">span[class='ss']", "#ip_n_c1").each(function () {
				ip_str = $(this).find("input").val();
				if (ip_str == v) {
					_alert(1,"客户端集合", 'IP重复',$(obj).prev('input'));
					//$(obj).prev('input').val("");
					pass = 0;
					return false;
				}
			});
		}
		var ip_id = $("#ip_span1").attr("value");
		if (pass == 1) {
			var $c = $('<span class="ss" style="float:left;position:static;padding: 0 0 10px 0;width:195px;" value=' +ip_id + '/>');
			$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + v+ '">'
			+'<i class="ctr ctr-del" onclick="_delIp(this)"  style="margin-top: 5px;margin-left: -3px;"></i>');
			$(obj).parent().after($c);
			$(obj).prev('input').val("");
			$(obj).prev('input').focus();
			$("#ip_span1").attr("value", "0");
		}
		initformlist();
	}

	//加入ip
	function _addIp_c(obj) {
		var pass =1;
		var v1 = $(obj).prev().val().trim();
		var v = $(obj).prev().prev().prev().val().trim();
		
		if (v == '') {
			_alert(1,"客户端集合", '起始IP不能为空', $(obj).prev().prev().prev());
			//$(obj).prev().prev().prev().val("");
			return false;
		} else if (!ipReg.test(v)) {
			_alert(1,"客户端集合", '起始IP格式错误', $(obj).prev().prev().prev());
			//$(obj).prev().prev().prev().val("");
			return false;
		}
		if (v1 == '') {
			_alert(1,"客户端集合", '结束IP不能为空',$(obj).prev());
			//$(obj).prev().val("");
			return false;
		} else if (!ipReg.test(v1)) {
			_alert(1,"客户端集合", '结束IP格式错误',$(obj).prev());
			//$(obj).prev().val("");
			return false;
		}
		if(v==v1){
			_alert(1,"客户端集合", '起始IP不能大于等于结束IP',$(obj).prev().prev().prev());
			//$(obj).prev().prev().prev().val("");
			return false;
		}
		//add zero
		var v_str = v.split(".");
		var v1_str = v1.split(".");
		for (var i = 0; i < 4; i++) {
			if (parseInt(v_str[i]) > parseInt(v1_str[i])) {
				_alert(1,"客户端集合", '起始IP不能大于等于结束IP',$(obj).prev().prev().prev());
				return false;
			}else if (parseInt(v_str[i]) < parseInt(v1_str[i])) {
				break;
			}
		}
		$('>span[class=ss]','#ip_n_c').each(function(){
			var input1=$(this).find('input').eq(0).val();
			var input2=$(this).find('input').eq(1).val();
			if(input1==v && input2==v1){
				_alert(1,"客户端集合",'IP区间重复', $(obj).prev().prev().prev())
				pass=0;
				return false;
			}
		});
		if(pass==1){
			var ip_id = $("#ip_span").attr("value");
			var $c = $('<span class="ss" value="' + ip_id + '" style="float:left;width: 340px;position:static;padding: 0 0 10px 0;"/>');
			$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;"value="'+v+'">'
			+'<span style="vertical-align:middle;padding-left: 5px;    padding-right: 4px;">-</span>'
			+'<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="'+v1+'">'
			+'<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
			$(obj).parent().after($c);
			$(obj).prev().val("");
			$(obj).prev().prev().prev().val("");
			 $(obj).prev().prev().prev().focus();
			$("#ip_span").attr("value", "0");
		}
		initformlist();
	}

	function _addMAC(obj) {
		var pass = 1;
		var v = $(obj).prev('input').val().trim();

		if (v == '') {
			_alert(2,"客户端集合", "MAC地址不能为空",$(obj).prev('input'))
			//$(obj).prev('input').val("");
			return false;
		} else if (!MACReg.test(v)) {
			_alert(2,"客户端集合", "MAC地址格式错误",$(obj).prev('input'))
			//$(obj).prev('input').val("");
			return false;
		} else {
			$(">span[class='ss']", "#MACAddress").each(function () {
				mac_str = $(this).find("input").val();
				if (mac_str == v) {
					_alert(2,"客户端集合", "MAC地址重复",$(obj).prev('input'))
					//layer.alert('MAC重复！',{icon: 2});
					//$(obj).prev('input').val("");
					pass = 0;
					return false;
				}
			});
		}
		var mac_id = $(obj).parent().attr("value");
		if (pass == 1) {
			var $c = $('<span class="ss" value="' +  mac_id + '" style="float:left;position:static;width: 190px;padding: 0 0 10px 0;"/>');
			$c.html('<input type="text" class="form-text" style="width:138px;padding-right: 8px;" value="' + v + '">'
			+'<i class="ctr ctr-del" style="    margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
			$(obj).parent().after($c);
			$(obj).prev('input').val("");
			$(obj).prev('input').focus();
		}
		initformlist();
	}

	function _addMAC1(obj) {
		var pass = 1;
		var v1 = $(obj).prev('input').val().trim();
		var v = $(obj).prev('input').prev().prev('input').val().trim();
		
		if (v == '') {
			_alert(2,"客户端集合", "起始MAC地址不能为空",$(obj).prev('input').prev().prev('input'))
			//$(obj).prev('input').val("");
			return false;
		} else if (!MACReg.test(v)) {
			_alert(2,"客户端集合", "起始MAC地址格式错误",$(obj).prev('input').prev().prev('input'))
			//$(obj).prev('input').val("");
			return false;
		}
		if (v1 == '') {
			_alert(2,"客户端集合", "结束MAC地址不能为空",$(obj).prev('input'))
			//$(obj).prev('input').val("");
			return false;
		} else if (!MACReg.test(v1)) {
			_alert(2,"客户端集合", "结束MAC地址格式错误",$(obj).prev('input'))
			//$(obj).prev('input').val("");
			return false;
		}
		if (v == v1) {
			_alert(1,"客户端集合", '起始MAC地址不能大于等于结束MAC地址',$(obj).prev('input').prev().prev('input'));
			return false;
		}
		var v_str = v.split(':');
		var v1_str = v1.split(':');
		for (var i = 0; i < 6; i++) {
			if (parseInt(v_str[i], 16) > parseInt(v1_str[i], 16)) {
				_alert(1,"客户端集合", '起始MAC地址不能大于等于结束MAC地址',$(obj).prev('input').prev().prev('input'));
				return false;
			}else if (parseInt(v_str[i], 16) < parseInt(v1_str[i], 16)) {
				break;
			}
		}
		$('>span[class=ss]','#MACAddress1').each(function(){
			var input1=$(this).find('input').eq(0).val();
			var input2=$(this).find('input').eq(1).val();
			if(input1==v && input2==v1){
				_alert(1,"客户端集合",'MAC区间重复', $(obj).prev().prev().prev())
				pass=0;
				return false;
			}
		});
		
		if (pass == 1) {
			var mac_id = $(obj).parent().attr("value");
			var $c = $('<span class="ss" value="' + mac_id  + '" style="float:left;width: 350px;position: static;padding: 0 0 10px 0;"/>');
			$c.html('<input type="text" class="form-text" value="' + v + '" style="width:138px;padding-right: 8px;;">'
			+'<span style="vertical-align:middle;padding-left: 5px;padding-right: 5px;">-</span>'
			+'<input type="text" class="form-text" value="' + v1 + '" style="width:138px;padding-right: 8px;;">'
			+'<i class="ctr ctr-del" style="margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
			$(obj).parent().after($c);
			$(obj).prev('input').val("");
			$(obj).prev('input').prev().prev('input').val("");
			$(obj).prev('input').prev().prev('input').focus();
		}
		initformlist();
	}

	function _delMAC(obj) {
		var $c = $(obj).parent();
		$c.remove();
	}

	//删除ip
	function _delIp(obj) {
		var $c = $(obj).parent();
		$c.remove();
	}

	function save_client(client_set,d) {
		var msstr = aceg(JSON.stringify(client_set),$("input[name=se]").val());
		$.ajax({
			url: '/bhost/add_client',
			type: "POST",
			async: false,
			data: { a0: $("input[name=se]").val(), a1: JSON.stringify(client_set), a2: "0", a3: "null" ,m1:msstr},
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result == true) {
					parent.layer.open({
						type: 1,
						title: '客户端集合',
						content: '<div class="layer-alert"><i class="alert succ"></i>操作成功</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							parent.layer.close(i);
							var client_text = $('#accset').find('span').text();
							$("div[data-id=xSelect-client]").remove();
							$('#accset').empty().data('xSelect','');
							bind_client_xSelect();
							if ($("#accset").data('value') == "-1" || $("#accset").data('value') == undefined){
								$("#accset").data('value',result.ClientScopeId);
								$("#accset").find('span').text(client_set.ClientScopeName);
								client_list.splice(0,1,result.ClientScopeId);
							}else{
								$('#accset').find('span').text(client_text);
							}
							d.close().remove();
						}
					});
				} else {
					_alert(1,"客户端集合", "客户端集合操作失败:"+result.ErrMsg,$("#c_n"));
					return false;
				}
			}
		});
	}
	function clear_client(){
		client_set = {
			"ClientScopeId": 0,
			"ClientScopeName": "",
			"IsApplyToServerScope": false,
			"IPList":{
				"IPSetId": 0,
				"Set": new Array()
			},
			"MACList":{
				"MACSetId": 0,
				"Set": new Array()
			}
		};
		$("#ip_n_c1").children('span').not('span:first').remove();
		$("#ip_n_c").children('span').not('span:first').remove();
		$("#MACAddress").children('span').not('span:first').remove();
		$("#MACAddress1").children('span').not('span:first').remove();
		$("#ip_n_c1").children('span:first').find('input').val('');
		$("#ip_n_c").children('span:first').find('input').val('');
		$("#MACAddress").children('span:first').find('input').val('');
		$("#MACAddress1").children('span:first').find('input').val('');
		$("#c_n").val('');
		$("#c_n").attr("disabled",false);
		$("#c_n").next('i').attr('class','v-check');
		$('#client_suspend a.s-hide').show();
	}
	function initformlist(){
		var h1 = $('.form1').height();
		var h2 = $('.form3').height();
		if (h1 > h2){
			$('.form3').height(h1);
		}else{
			$('.form1').height(h2);
		}
	}
	function client_main(type){
		if (type == 1) {
			$("#c_n").val(client_data.ClientScopeName);
			$("#c_n").attr("disabled", true);
			
			if (client_data.IPList != null) {
				client_set.IPList.IPSetId = client_data.IPList.IPSetId;
				if(client_data.IPList.Set!=null){
					var IPset_group=client_data.IPList.Set.filter(function (params) {
						return params.StartIP != params.EndIP
					});
					var IP_group=client_data.IPList.Set.filter(function (params) {
						return params.StartIP == params.EndIP
					});
					for(var i=0;i<IPset_group.length-1;i++){
						var $c = $('<span class="ss" value="' + IPset_group[i].IPSetMemberId + '" style="float:left;width: 340px;position:static;padding: 0 0 10px 0;"/>');
						$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;"value="' + IPset_group[i].StartIP + '">'
							+ '<span style="vertical-align:middle;padding-left: 5px;padding-right: 4px;">-</span>' + '<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + IPset_group[i].EndIP + '">'
							+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
						$("#ip_n_c").find("span[class='ss ss-add']").after($c);
					}
					if(IPset_group.length!=0){
						$('#ip_n_c').attr('value',IPset_group[i].IPSetMemberId);
						$('#ip_n_c').find('input:eq(0)').val(IPset_group[i].StartIP);
						$('#ip_n_c').find('input:eq(1)').val(IPset_group[i].EndIP);
					}
					for(var i=0;i<IP_group.length-1;i++){
						var $c = $('<span class="ss" style="float:left;position:static;padding: 0 0 10px 0;" value=' + IP_group[i].IPSetMemberId + '/>');
						$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + IP_group[i].StartIP + '">'
							+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
						$("#ip_n_c1").find("span[class='ss ss-add']").after($c);
					}
					if(IP_group.length!=0){
						$('#ip_n_c1').attr('value',IP_group[i].IPSetMemberId);
						$('#ip_n_c1').find('input:eq(0)').val(IP_group[i].StartIP);
					}
				}
			}
			if (client_data.MACList != null) {
				client_set.MACList.MACSetId = client_data.MACList.MACSetId;
				if(client_data.MACList.Set!=null){
					var MACset_group=client_data.MACList.Set.filter(function (params) {
						return params.StartMACAddress != params.EndMACAddress
					});
					var MAC_group=client_data.MACList.Set.filter(function (params) {
						return params.StartMACAddress == params.EndMACAddress
					});
					for(var i=0;i<MACset_group.length-1;i++){
						var $c = $('<span class="ss" value="' + MACset_group[i].MACSetMemberId + '" style="float:left;width: 350px;position: static;padding: 0 0 10px 0;"/>');
						$c.html('<input type="text" class="form-text" value="' + MACset_group[i].StartMACAddress + '" style="width:138px;padding-right: 8px;;">'
							+ '<span style="vertical-align:middle;padding-left: 5px;padding-right: 5px;">-</span>'
							+ '<input type="text" class="form-text" value="' + MACset_group[i].EndMACAddress + '" style="width:138px;padding-right: 8px;;">'
							+ '<i class="ctr ctr-del" style="margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
						$("#MACAddress1").find("span[class='ss ss-add']").after($c);
					}
					if(MACset_group.length!=0){
						$("#MACAddress1").find("span[class='ss ss-add']").attr('value',MACset_group[i].MACSetMemberId);
						var $mac_input=$("#MACAddress1").find("span[class='ss ss-add']").find('input');
						$mac_input.first().val(MACset_group[i].StartMACAddress);
						$mac_input.last().val(MACset_group[i].EndMACAddress);
					}
					for(var i=0;i<MAC_group.length-1;i++){
						var $c = $('<span class="ss" value="' + MAC_group[i].MACSetMemberId + '" style="float:left;position:static;width: 190px;padding: 0 0 10px 0;"/>');
						$c.html('<input type="text" class="form-text" style="width:138px;padding-right: 8px;" value="' + MAC_group[i].StartMACAddress + '">'
							+ '<i class="ctr ctr-del" style="    margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
						$("#MACAddress").find("span[class='ss ss-add']").after($c);
					}
					if(MAC_group.length!=0){
						$("#MACAddress").find("span[class='ss ss-add']").attr('value',MAC_group[i].MACSetMemberId);
						$("#MACAddress").find("span[class='ss ss-add']").find('input').val(MAC_group[i].StartMACAddress);
					}
				}
			}
		}
	}
	var MACReg = /([A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2}/;
	function _autoHeight(){
		var arr = new Array();
		$('div.g-sort:first>div.g-items').each(function(){
			var h = $(this).children('div.g-cont').height();
			arr.push(h);
		});

		var maxh = Math.max.apply( Math, arr);
		$('div.g-sort:first>div.g-items').height(maxh + 45);
	}

	function _compare_mac(x,y){
		var start_mac1_arry = x.split(':');
		var start_mac2_arry = y.split(':');
		var start_mac1_num = "";
		var start_mac2_num = "";
		for (var mac_i = 0; mac_i < 6; mac_i++){
			start_mac1_num = start_mac1_num + start_mac1_arry[mac_i];
		}
		for (var mac_i = 0; mac_i < 6; mac_i++){
			start_mac2_num = start_mac2_num + start_mac2_arry[mac_i];
		}
		var start_mac1_d = parseInt(start_mac1_num,16);
		var start_mac2_d = parseInt(start_mac2_num,16);
		if (start_mac1_d == start_mac2_d){
			return 1;
		}else if (start_mac1_d > start_mac2_d){
			return 2;
		}else{
			return 3;
		}
	}	
	var clientId1;
	var clientId2;
	function reload_client(){
		_editNode2(clientId1,clientId2);
	}
	var client_data;
	function _editNode2(obj,type){
		clientId1 = obj;
		clientId2 = type;
		clear_client();
		var title;
		if (type == 1){//编辑客户端集合
			clientId = $(obj).children('span').data('value');
			$.ajax({
				url: "/bhost/get_client_list",
				type: "POST",
				async: false,
				data: { a0: $("input[name=se]").val(), a1: clientId },
				success: function (result) {
					var client_result = JSON.parse(result);
					if (client_result.Result == true) {
						client_data = client_result.info.data[0];
						title = "客户端集合";
					}
				}
			})
		}else if(type == 2){
			client_data = null;
			clientId = 0;
			title = "客户端集合";
		}
		var $dialogCont = $("#client_suspend").show();
		
		var d = dialog({
			title:title,
			content:$dialogCont,
			id:"client_suspend",
			width:"1000px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		initformlist();
		$(".ui-dialog-title").css("width","140px");
		client_main(type);
		
		$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
			reload_client();
		});
		
		$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
			client_add(d);
		})	
	}

	function change_client_scope(obj){
		var t = $(obj).find('span').data('value');
		if (client_list.indexOf(t) === -1 && t != undefined) {
			client_list.splice(0, 1, t);
		}
		if ($(obj).parent('ul').children('li').length == 2 && t != '-1') {
			$('#accset').next('i.add').click();
			$('#accset').hide();
		}
	}
	var client_tmp = [];

	function check_client(obj){
		var pass = 1;
		var v=$(obj).children("option:selected").val();
		if(client_tmp.indexOf(v) >=0){
			pass=0;
			_alert(1,"用户管理",'已存在相同客户端集合');
		}
		if(pass==1){
			client_tmp=[];
			$('#Temp4>div>div.set-view4').each(function(i,item){
				var v_tmp=$(item).children("select").val();
				client_tmp.push(v_tmp)
			});
		}else{
			$('#Temp4>div>div.set-view4').each(function(i,item){
				var new_mo=$(item).children("select").val();
				if(client_tmp[i] != new_mo){				
					if(client_tmp[i])$(item).children("select").val(client_tmp[i]);
					else $(item).children("select").val("");
					return false;
				}
			});
			// $('#Temp4 .select2').select2({minimumResultsForSearch: -1}); //----------------------------8.8-----------------------------
		}
	}

	function change_limit(obj){
		var type = $(obj).find('option:selected').val();
		var v = $(obj).val();
		var $c = $(obj).siblings('div.g-cont');
		var $c1 = $c.children('div.sel-type1'),
				$c2 = $(".set-view").not(":first");
		if (type == 1){
			$c1.hide();
			// $c2.show();
			$("#add2").show();
			$(obj).parent().find('.set-view.set-view4').show();
			$(obj).parent().find('.set-view.set-view2').hide();
			$(obj).parent().find('.set-view.set-view3').hide();
			$(obj).parent().find('.set-view.set-view5').hide();
		}else if (type == 2){
			$c1.hide();
			// $c2.show();
			$("#add2").show();
			$(obj).parent().find('.set-view.set-view2').show();
			$(obj).parent().find('.set-view.set-view3').hide();
			$(obj).parent().find('.set-view.set-view4').hide();
			$(obj).parent().find('.set-view.set-view5').hide();
		}else if (type == 3){
			$c1.hide();
			// $c2.show();
			$("#add2").show();
			$(obj).parent().find('.set-view.set-view3').show();
			$(obj).parent().find('.set-view.set-view2').hide();
			$(obj).parent().find('.set-view.set-view4').hide();
			$(obj).parent().find('.set-view.set-view5').hide();
		}else if (type == 4){
			$c1.hide();
			// $c2.show();
			$("#add2").show();
			$(obj).parent().find('.set-view.set-view5').show();
			$(obj).parent().find('.set-view.set-view2').hide();
			$(obj).parent().find('.set-view.set-view3').hide();
			$(obj).parent().find('.set-view.set-view4').hide();
		}else if (type == -1){
			$c1.hide();
			// $c2.hide();
			$("#add2").hide();
			$(obj).parent().find('.set-view.set-view5').hide();
			$(obj).parent().find('.set-view.set-view2').hide();
			$(obj).parent().find('.set-view.set-view3').hide();
			$(obj).parent().find('.set-view.set-view4').hide();
		}else{//客户端集合
			$c1.show();
			// $c2.hide();
			$("#add2").show();
			$(obj).parent().find('.set-view.set-view5').hide();
			$(obj).parent().find('.set-view.set-view2').hide();
			$(obj).parent().find('.set-view.set-view3').hide();
			$(obj).parent().find('.set-view.set-view4').hide();
			// $("#client_list").show();
		}
	}
	var ipcheck_route=/(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/
	var MACReg = /([A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2}/;
	var client_list = ['-1'];
	var client_id;
	var IPList = {"IPSetId":0,"Set":[]};
	var MACList = {"MACSetId":0,"Set":[]};
	var List1 = {
	  "ClientScopeId": 0,
	  "Type": 1, 
	  "IPList": null,
	  "MACList": null
	};
	var List2 = {
	  "ClientScopeId": 0,
	  "Type": 2, 
	  "IPList": {},
	  "MACList": {}
	};
	var CScopeSet=[];
	var temp4 = $('#Temp4>.sitem:last').clone();
	function _addSet4(obj){
		var type = $(obj).parent().children('select').find('option:selected').val();
		var add = 0;
		if (type == 1 || type == 2){
			if (type == 2){
				var start_ip = $(obj).parent().find('input').not('input:hidden').eq(0).val();
				var end_ip = $(obj).parent().find('input').not('input:hidden').eq(1).val();
				if (start_ip == ""){
					_alert(2,"用户管理","请输入起始IP地址",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
				if (end_ip == ""){
					_alert(2,"用户管理","请输入终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
					return false;
				}
				if (!ipcheck_route.test(start_ip)){
					_alert(1,"用户管理","起始IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
				if (!ipcheck_route.test(end_ip)){
					_alert(1,"用户管理","终止IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
					return false;
				}
				var a = _compare_ip(start_ip,end_ip);
				if (a != 3){
					_alert(1,"用户管理","起始IP地址不能大于或等于终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
					return false;
				}
				$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view2').not('.set-view.set-view2:hidden').each(function(i,item){
					if ($(item).find('input').not('input:hidden').eq(0).val() == start_ip && $(item).find('input').not('input:hidden').eq(1).val() == end_ip){
						add = 1;
						_alert(1,"用户管理","已存在相同IP区间",$(obj).parent().find('input').not('input:hidden').eq(0));
						return false;
					}
				});
				if (add == 1){
					return false;
				}
				// save_mana_set(1,start_ip,end_ip);
			}else{
				var start_ip = $(obj).parent().find('input').not('input:hidden').val();
				var end_ip = start_ip;
				if (start_ip == ""){
					_alert(2,"用户管理","请输入IP地址",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
				if (!ipcheck_route.test(start_ip)){
					_alert(1,"用户管理","IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
				$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view4').not('.set-view.set-view4:hidden').each(function(i,item){
					if ($(item).find('input').not('input:hidden').val() == start_ip){
						add = 1;
						_alert(1,"用户管理","已存在相同IP地址",$(obj).parent().find('input').not('input:hidden'));
						return false;
					}
				});
				if (add == 1){
					return false;
				}
				// save_mana_set(1,start_ip,end_ip);
			}
		}else{
			if (type == 3){
				var mac_input = $(obj).parent().find('input').not('input:hidden').val().trim();
				if (mac_input == ""){
					_alert(2,"用户管理","请输入MAC地址",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
				if (!MACReg.test(mac_input)){
					_alert(1,"用户管理","MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
				$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view3').not('.set-view.set-view3:hidden').each(function(i,item){
					if (mac_input == $(item).find('input').not('input:hidden').val().trim()){
						add = 1;
						_alert(1,"用户管理","该MAC地址已存在",$(obj).parent().find('input').not('input:hidden'));
						return false;
					}
				});
				if (add == 1){
					return false;
				}
				// save_mana_set(2,mac_input,mac_input);
			}else if(type == 4){
				var start_mac = $(obj).parent().find('input').not('input:hidden').eq(0).val().trim();
				var end_mac = $(obj).parent().find('input').not('input:hidden').eq(1).val().trim();
				if (start_mac == ""){
					add = 1;
					_alert(2,"用户管理","请输入起始MAC地址",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
				if (end_mac == ""){
					add = 1;
					_alert(2,"用户管理","请输入终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
					return false;
				}
				if (!MACReg.test(start_mac)){
					add = 1;
					_alert(1,"用户管理","起始MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
				if (!MACReg.test(end_mac)){
					add = 1;
					_alert(1,"用户管理","终止MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
					return false;
				}
				var a = _compare_mac(start_mac,end_mac);
				if (a != 3){
					add = 1;
					_alert(1,"用户管理","起始MAC地址不能大于或等于终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
					return false;
				}
				if (add == 1){
					return false;
				}
				$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view5').not('.set-view.set-view5:hidden').each(function(i,item){
					if (start_mac == $(item).find('input').not('input:hidden').eq(0).val().trim() && end_mac == $(item).find('input').not('input:hidden').eq(1).val().trim()){
						add = 1;
						_alert(1,"用户管理","该MAC地址区间已存在",$(obj).parent().find('input').not('input:hidden').eq(0));
						return false;
					}
				});
				if (add == 1){
					return false;
				}
				// save_mana_set(2,start_mac,end_mac);
			}else if(type == 5){
				var accset = $('#accset').find('span').text();
				clientId = $('#accset').data('value');
				if (clientId == "-1" || clientId == undefined){
					_alert(2,"系统用户","请选择客户端集合");
					return false;
				}
			}
		}
		if(type == 5){
			var cid = $("#accset").data('value');
			var $H = '<div class="sitem" id="'+cid+'" style=" width: 510px;float: left; margin-left: -10px;height:40px" _auth_data="">'+
				'<i class="ctrl del" onclick="_del(this)" style="bottom: 30px;margin-left: 130px"></i>'+
					'<select name="" id="Clone" class="select2 " style="width: 120px" disabled="disabled">'+
						'<option value="5" selected>客户端集合</option></select>'+
					'<input id="accset" style="width: 302px;" type="text" class="form-text" value="'+accset+'" disabled="disabled">'+
				'</div>';
			$(obj).parent().after($H);
			$('#Clone').select2({minimumResultsForSearch: -1});
			if (client_list.indexOf(cid) === -1) {
				client_list.push(cid);
			}
			client_list.splice(0, 0, '-1');
			c_index_all.splice($.inArray(parseInt(cid), c_index_all), 1);
			$("#accset").find('span').text('请选择');
			$("#accset").data('value','-1');
			$("div[data-id=xSelect-client]").children('input').val('');
			$("div[data-id=xSelect-client]").find('span[data-value='+cid+']').parent('li').remove();
			$(obj).prev('div').data('value','-1');
		}else{
			var $H = temp4.clone().wrap();
			var select_type = $("#Temp4").children('.sitem:first').children('select:first').val();
			var input1_str = null;
			var input2_str = null;
			if($("#Temp4").children('.sitem:first').find('input:visible').length == 1){
				input1_str = $("#Temp4").children('.sitem:first').find('input:visible').val();
			}else{
				input1_str = $("#Temp4").children('.sitem:first').find('input:visible').eq(0).val();
				input2_str = $("#Temp4").children('.sitem:first').find('input:visible').eq(1).val();
			}
			$('.select2',$H).select2({minimumResultsForSearch: -1});
			$("#Temp4").children('.sitem:first').after($H);
			$("#Temp4").children('.sitem').eq(1).children('select:first').val(select_type).trigger('change');
			if($("#Temp4").children('.sitem').eq(1).find('input:visible').length == 1){
				$("#Temp4").children('.sitem').eq(1).find('input:visible').val(input1_str);
			}else{
				$("#Temp4").children('.sitem').eq(1).find('input:visible').eq(0).val(input1_str);
				$("#Temp4").children('.sitem').eq(1).find('input:visible').eq(1).val(input2_str);
			}	
			$("#Temp4").children('.sitem').eq(1).find('select').attr("disabled",true);
			$("#Temp4").children('.sitem:first').find('input').val('');
			$("#Temp4").children('.sitem:first').children('select:first').val('5').trigger('change');
			$("#Temp4").children('.sitem').eq(1).children('i.add').remove();
			$("#Temp4").children('.sitem').eq(1).append('<i class="ctrl del" onclick="_del(this)" style="bottom: 30px;margin-left: 130px"></i>');
		}
		_autoHeight();
	}

	//保存客户端登陆限制  type :  1-->ip   2-->mac  3-->scope

	var ip_order = 1;
	var mac_order = 1;
	function save_mana_set(type,start,end){
		var IPSet = {
			"IPSetMemberId": 0,
			"Order": 0,
			"StartIP": "",
			"EndIP": ""                            
		};
		var MACSet = {
			"MACSetMemberId": 0,
			"Order": 0,
			"StartMACAddress": "",
			"EndMACAddress": ""
		};
		var scope = {
			"ClientScopeId": 1,
			"Type": 1, 
			"IPList": null,
			"MACList": null
		}
		if(type == 1){
			IPSet.Order = ip_order;
			ip_order++;
			IPSet.StartIP = start;
			IPSet.EndIP = end;
			// IPSet = JSON.parse(IPSet);
			IPList.Set.push(IPSet);
		}
		if(type == 2){
			MACSet.Order = mac_order;
			mac_order++;
			MACSet.StartMACAddress = start;
			MACSet.EndMACAddress = end;
			// MACSet = JSON.parse(MACSet);
			MACList.Set.push(MACSet);
		}	
		if(type == 3){
			scope.ClientScopeId = start;
			// scope = JSON.parse(scope);
			CScopeSet.push(scope);
		}
	}

	function _del(obj){
		var type = $(obj).parent().children("select").val();
		var value0 = $(obj).parent().find("input").not('input:hidden').eq(0).val();
		var value1 = $(obj).parent().find("input").not('input:hidden').eq(1).val();
		var value3 = $(obj).parent().attr("_auth_data");
		if (type == 1){
			$(IPList.Set).each(function(a1,item1){
				if(item1.StartIP == value0 && item1.EndIP == value0){
					IPList.Set.splice(a1,1);
				}
			})
		}
		if (type == 2){
			$(IPList.Set).each(function(a1,item1){
				if(item1.StartIP == value0 && item1.EndIP == value1){
					IPList.Set.splice(a1,1);
				}
			})
		}
		if (type == 3){
			$(MACList.Set).each(function(a1,item1){
				if(item1.StartMACAddress == value0 && item1.EndMACAddress == value0){
					MACList.Set.splice(a1,1);
				}
			})
		}
		if (type == 4){
			$(MACList.Set).each(function(a1,item1){
				if(item1.StartMACAddress == value0 && item1.EndMACAddress == value1){
					MACList.Set.splice(a1,1);
				}
			})
		}
		if (type == 5){
			var $c = $(obj).parent();
			var id = $c.attr('id');
			var t = $(obj).siblings('input').val();
			var v, data, max;
			var min = 0;
			max = c_index_all.length - 1;
			data = c_index_all;
			$("#accset").show();
			client_list.splice($.inArray(id, client_list), 1);
			var $p = $("div[data-id=xSelect-client]").children('ul');
			if (max < 0){
				var index_1 = -1;
			}else{
				var index_1 = search_i(min, max, parseInt(id), data);
			}
			index_1 = parseInt(index_1);
			if (index_1 == -1) {
				index_1 = max;
				$p.append('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
			} else if (index_1 == -2) {
				index_1 = 0;
				$p.children('li').eq(0).before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
			} else {
				$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
			}
			data.splice(index_1, 0, parseInt(id));
		}
		var $c = $(obj).parent();
		$c.remove();
	}

	function _compare_ip(x,y){
		var ip1 = x.split('.');
		var ip2 = y.split('.');
		var i1 = 0;
		var ip1_str = "";
		var ip2_str = "";
		for (var i1 = 0; i1 < 4; i1++){
			if (ip1[i1] < 10){
				ip1[i1] = "00"+ip1[i1];
			}else if (ip1[i1] < 100){
				ip1[i1] = "0"+ip1[i1];
			}else{
				
			}
			ip1_str = ip1_str + ip1[i1];
			if (ip2[i1] < 10){
				ip2[i1] = "00"+ip2[i1];
			}else if (ip2[i1] < 100){
				ip2[i1] = "0"+ip2[i1];
			}else{
				
			}
			ip2_str = ip2_str + ip2[i1];
		}
		if (ip1_str == ip2_str){
			return 3;
		}else if (ip1_str > ip2_str){
			return 2
		}else{
			return 3;
		}
	}

	/*
	*/
	var authtype_data;
	//var flag_pwd_default = 0;
	function get_authtype_list(){
		$.ajax({
			url: "/bhost/get_authtype_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val()},
			success:function(result){
				var authtype_result = JSON.parse(result);
				if (authtype_result.Result==true){
					authtype_list = authtype_result.info.data;
					authtype_data = authtype_list;
					//$('#sys_u_authtype').empty();
					//$('#sys_u_authtype').append('<option value="null" selected>默认</option>');
					var default_authtype = {};
					var flag_pwd_default=0;
					var flag_usbkeylen_default=-1;
					$(authtype_data).each(function(i,item){
						//查看是否存在 本地认证		0->包含本地认证  不包含usbkey    1->不包含本地认证 但是 包含 TOTP    3->包含usbkey 不包含本地认证   4  包含usbkey  包含本地认证    2-> 不包含 0 1 3 4的情况
						var flag_pwd = 0; 					
						var tmplist = [];
						var usbkeylen = -1; //不是usbkey认证
						$(item.Set).each(function(i1,item1){
							tmplist.push(item1.AuthMode);	
							if(item1.AuthMode == 8) {
								if(item1.PwdLen !=null) usbkeylen =  item1.PwdLen;
								else usbkeylen = 0; //没有配置长度
							}
						})
						if(tmplist.indexOf(1) >=0){
							flag_pwd = 0;
							if(tmplist.length == 1) flag_pwd = 5;
							if(tmplist.indexOf(8) >=0) flag_pwd = 4;
						}else if(tmplist.indexOf(10) >=0){
							flag_pwd = 1;
						}else if( tmplist.indexOf(8) >=0 ){
							flag_pwd = 3;
						}else{
							flag_pwd = 2;
						}
						if(item.IsDefault == true){
							flag_pwd_default = flag_pwd;
							flag_usbkeylen_default=usbkeylen;
						}
						if(tmplist.indexOf(9) >=0){
							flag_pwd = flag_pwd+',9';
						}
						authtype_data[i].flag_pwd = flag_pwd;
						authtype_data[i].usbkeylen = usbkeylen;
						//$('#sys_u_authtype').append('<option flag_pwd='+flag_pwd+' value="'+item.AuthTypeId+'">'+item.AuthTypeName+'</option>');
					})
					 default_authtype = {
						"Set": [

						],
						"IsDefault": true,
						"Separator": null,
						"AuthTypeId":-1,
						"AuthTypeName": "默认",
						"MustAllModulesSucc": true
					}
					default_authtype.flag_pwd=flag_pwd_default;
					default_authtype.usbkeylen=flag_usbkeylen_default;
					authtype_data.unshift(default_authtype);
					//$('#sys_u_authtype option').eq(0).attr('flag_pwd',flag_pwd_default);
					//$('#sys_u_authtype').select2().trigger('change');
				}
			}
		})

	}
	var AuthType_role = 0;
	function get_AuthType_role(){ // 0 只能选  1 能看到 2 能编辑
		$.ajax({
			url: "/bhost/get_AuthType_role",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val()},
			success:function(result){
				var results = JSON.parse(result);
				if (results.Result==true){
					AuthType_role = results.info
				}
			}
		})
	} 
	var c_index_all_authtype = [];
	var authtype_list_tmp =[];
	//绑定客户端集合
	function bind_authtype_xSelect(){

		tmp_authtype_id = $('#sys_u_authtype').data('value');
		tmp_authtype_txt = $("#sys_u_authtype").find('span').text();
		$("div[data-id=xSelect-authtype]").remove();
		get_authtype_list();
		$('#sys_u_authtype').empty().data('xSelect','');
		var authtype_array = [];
		c_index_all_authtype = [];
		$.each(authtype_data,function(i,item){
			if ($("#sys_u_authtype").data('value') == item.AuthTypeId){
				
			}else{
				if (authtype_list_tmp.indexOf(item.AuthTypeId) > -1){
					return true;
				}
			}
			if(AuthType_role == 0){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':''
				};
			}else if (AuthType_role == 1){
				if(item.AuthTypeId == -1){
					var select_data_json = {
						'value':1,
						'name':'admin2',
						'flag_pwd':0,
						'usbkeylen':0,
						'type':''
					};
				}else{
					var select_data_json = {
						'value':1,
						'name':'admin2',
						'flag_pwd':0,
						'usbkeylen':0,
						'type':'check'
					};
				}
			}else{
				if(item.AuthTypeId == -1){
					var select_data_json = {
						'value':1,
						'name':'admin2',
						'flag_pwd':0,
						'usbkeylen':0,
						'type':''
					};
				}else{
					var select_data_json = {
						'value':1,
						'name':'admin2',
						'flag_pwd':0,
						'usbkeylen':0,
						'type':'edit'
					};
				}
			}
			select_data_json.value = item.AuthTypeId;
			select_data_json.name = item.AuthTypeName;
			select_data_json.flag_pwd = item.flag_pwd;
			select_data_json.usbkeylen = item.usbkeylen;
			authtype_array.push(select_data_json);
			c_index_all_authtype.push(item.AuthTypeId);
		});
		if(AuthType_role ==2){
			$('#sys_u_authtype').xSelect({
				width: 200,
				defaultText: '默认',
				items:authtype_array,
				module_type:'authtype',
				edit: function(item,obj){
					$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
					_editNode3(obj,2);
				},
				check: function(item,obj){
					$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
					_editNode3(obj,2);
				},
				btn:[
					{
						'name':'新增',
						'event': function(items,obj){
							_editNode3(obj,1);
						}
					}
				],
				setval:function(item,obj){
					change_authtype_scope(obj);
				}
			});
		}else{
			$('#sys_u_authtype').xSelect({
				width: 200,
				defaultText: '默认',
				items:authtype_array,
				module_type:'authtype',
				edit: function(item,obj){
					$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
					_editNode3(obj,2);
				},
				check: function(item,obj){
					$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
					_editNode3(obj,2);
				},
				setval:function(item,obj){
					change_authtype_scope(obj);
				}
			});
		}

		if(tmp_authtype_id != undefined){
			$('#sys_u_authtype').data('value',tmp_authtype_id);
			$("#sys_u_authtype").find('span').text(tmp_authtype_txt);
			if(tmp_authtype_id != -1){
				$('.xSelect-authtype li').each(function(){
					if($(this).children('span').data('value') == tmp_authtype_id){
						change_authtype_scope(this);
					}
				})
			}	
		}else{
			$("#sys_u_authtype").find('span').text("默认");
			$('#sys_u_authtype').data('value','-1');
			change_authtype_scope($(".xSelect-authtype li").eq(0));
			$(".xSelect-authtype li").eq(0).attr('class','active');
		}
		//$('#mframe1').attr('src','/bhost/authtype_handle?tasktype=1&authtypeId=1&paging=1&search_typeall=&e=all-&se='+$("input[name=se]").val()+'&i1=1');
	}
	var global_auth = -1;
	var global_flag_pwd = 0;
	var local_check = false;
	var local_check_default = false;
	function change_authtype_scope(obj){
		var auth_type = $(obj).children('span').data('value');
		global_auth = parseInt(auth_type);
		auth_class = 0;

		flag_pwd = $(obj).children('span').attr('flag_pwd');
		//yt 2018-05-10
		ts = $(obj).children('span').attr('flag_pwd').split(',');
		flag_pwd = ts[0];
		global_flag_pwd = flag_pwd;
		$("#changepin_div1").hide();
		$("#changepin_local").hide();
		if(auth_type == "-1"){
			auth_class = authDefault_flag;
			local_check = local_check_default;
		}else{
			$.each(authtype_data,function(i,item){
				if(auth_type == item.AuthTypeId){
					$.each(item.Set,function(i1,item1){
						if(item1.AuthMode == 6){ // 令牌
							auth_class += 1;
						}else if(item1.AuthMode == 8){  // logobase key
							auth_class += 2;
						}else if(item1.AuthMode == 10){ //编辑 totp
							auth_class += 4;
						}else if(item1.AuthMode == 13){ //指纹
							auth_class += 8;
						}else if(item1.AuthMode == 1){//本地
							local_check = true;
						}
					})
					if(local_check == true){
						$("#changePwd").show();
					}else{
						$("#changePwd").hide();
					}
					return false;
				}
			})
		}
		if(local_check == true){
			$("#changePwd").show();
		}else{
			$("#changePwd").hide();
		}
		if(auth_class == 2){
			$("#totp_div").hide();
			$('#usbkey_div').show();
			$('#tokenid_div').hide();
			$('#fprint_div').hide();
		}else if(auth_class == 1){
			$("#totp_div").hide();
			$('#usbkey_div').hide();
			$('#tokenid_div').show();
			$('#fprint_div').hide();
		}else if(auth_class == 3){
			$("#totp_div").hide();
			$('#usbkey_div').show();
			$('#tokenid_div').show();
			$('#fprint_div').hide();
		}else if(auth_class == 4){
			$("#totp_div").show();
			$('#usbkey_div').hide();
			$('#tokenid_div').hide();
			$('#fprint_div').hide();
		}else if(auth_class == 5){
			$("#totp_div").show();
			$('#usbkey_div').hide();
			$('#tokenid_div').show();
			$('#fprint_div').hide();
		}else if(auth_class == 6){
			$("#totp_div").show();
			$('#usbkey_div').show();
			$('#tokenid_div').hide();
			$('#fprint_div').hide();
		}else if(auth_class == 7){
			$("#totp_div").show();
			$('#usbkey_div').show();
			$('#tokenid_div').show();
			$('#fprint_div').hide();
		}else if(auth_class == 8){
			$("#totp_div").hide();
			$('#usbkey_div').hide();
			$('#tokenid_div').hide();
			$('#fprint_div').show();
		}else if(auth_class == 9){
			$("#totp_div").hide();
			$('#usbkey_div').hide();
			$('#tokenid_div').show();
			$('#fprint_div').show();
		}else if(auth_class == 10){
			$("#totp_div").hide();
			$('#usbkey_div').show();
			$('#tokenid_div').hide();
			$('#fprint_div').show();
		}else if(auth_class == 11){
			$("#tokenid_div").show();
			$("#usbkey_div").show();
			$('#totp_div').hide();
			$('#fprint_div').show();
		}else if(auth_class == 12){
			$("#totp_div").show();
			$('#usbkey_div').hide();
			$('#tokenid_div').hide();
			$('#fprint_div').show();
		}else if(auth_class == 15){
			$("#totp_div").show();
			$('#usbkey_div').show();
			$('#tokenid_div').show();
			$('#fprint_div').show();
		}else{
			$("#totp_div").hide();
			$('#usbkey_div').hide();
			$('#tokenid_div').hide();
			$('#fprint_div').hide();
		}
		//
		
		//查看是否存在 本地认证		0->包含本地认证 1->不包含本地认证 但是 包含 TOTP Logbase usbkey	2-> 不包含 0 1 的情况
		if(flag_pwd == '0'){
			//$('#span_pwd').html("密&nbsp;&nbsp;码");
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_old').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
		}else if(flag_pwd == '1') {
			$('#sys_u_pwd_new').attr('disabled',true);
			$('#sys_u_pwd_old').attr('disabled',true);
			$('#sys_u_pwd_tr').attr('disabled',true);
		}else if(flag_pwd == '3'){	
			$('#sys_u_pwd_new').attr('disabled',true);
			$('#sys_u_pwd_old').attr('disabled',true);
			$('#sys_u_pwd_tr').attr('disabled',true);
		}else if(flag_pwd == '4'){
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_old').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
		}else if(flag_pwd == '5'){
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_old').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
		}else{
			$('#sys_u_pwd_new').attr('disabled',true);
			$('#sys_u_pwd_old').attr('disabled',true);
			$('#sys_u_pwd_tr').attr('disabled',true)
		}
		
		
		////短信 手机必填
		var flag_phone= false;
		var flag_email = false;
		if(auth_type == '-1'){
			$.each(authtype_data,function(i,item){
				if(item.IsDefault == true){
					$.each(item.Set,function(i1,item1){
						if(item1.AuthMode == 11){
							flag_phone = true;
						}
						if(item1.AuthMode == 12){
							flag_email = true;
						}
					})
					return false;
				}
			})
		}else{
			$.each(authtype_data,function(i,item){
				if(auth_type == item.AuthTypeId){
					$.each(item.Set,function(i1,item1){
						if(item1.AuthMode == 11){
							flag_phone = true;
						}
						if(item1.AuthMode == 12){
							flag_email = true;
						}
					})
					return false;
				}
			})
		}
		if(flag_phone == true){
			$('#phone_em').show();
		}else{
			$('#phone_em').hide();
		}

		if(flag_email == true){
			$('#mail_em').show();
		}else{
			$('#mail_em').hide();
		}

		//
		usbkeylen = flag_pwd = $(obj).children('span').attr('usbkeylen');
		if(usbkeylen == '-1' || usbkeylen == '0'){
			$('#pin_input1').removeAttr('maxlength');
			$('#pin_input2').removeAttr('maxlength');
		}else{
			$('#pin_input1').attr('maxlength',usbkeylen);
			$('#pin_input2').attr('maxlength',usbkeylen);
		}
		//

		//
		if( ts.length > 1){
			$('#CertCn_div').show();
		}
		else $('#CertCn_div').hide();
	}

	var client_data;
	var d_authtype ;
	function _editNode3(obj,type){
		title = "认证方式";
		var $dialogCont = $("#authtype_suspend").show();

		d_authtype = dialog({
			title:title,
			content:$dialogCont,
			id:"authtype_suspend",
			width:"1200px"
		});
		if(type == 1){
			authtypeId = 0;
		}else{		
			authtypeId = $(obj).children('span').data('value')
		}
		$('#mframe1').attr('src','/bhost/authtype_handle?tasktype='+type+'&authtypeId='+authtypeId+'&paging=1&search_typeall=&e=all-&se='+$("input[name=se]").val()+'&i1=1')
		d_authtype.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d_authtype.showModal();
		//initformlist();
		$(".ui-dialog-title").css("width","140px");
		//client_main(type);

		$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
			//reload(1);
		});

		$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
			//client_add(d);	
		})	
	}

	var FP_SET = false;		//是否配置指纹
	var FP_TMP = "";
	var KEY_SET = false;	//是否配置Pin
	var fp_index = 1;
	function IfSaveSuccess(sesstime){
		$.ajax({
			url: "/bhost/get_fpResult",
			type:"POST",
			async: true,
			data:{a0:window.parent.document.frm.us.value,a1:sesstime},
			success:function(result){
				//{\"Result\":true,\"status\":\"%s\",\"finger\":\"%s\"}
				var result=JSON.parse(result);
				if(result.Result){
					if(result.status == 1){
						_closeLoading();
						clearInterval(if_ok);
						_alert(0,'系统用户','录入成功');
						$("#FinP_reset_div").find('text').text("已录入");
						FP_SET = true;
						name_index = 1;
						fp_index = getRamdomIndex(1);
						name_index = getNameIndex(1);
						var fp_name = "指纹"+name_index;
						if(FP_TMP == ""){
							FP_TMP = fp_name + '\t' + result.finger;
						}else{
							FP_TMP = FP_TMP + '\n' + fp_name + '\t' + result.finger;
						}
						var html_str1 = '<li class="item" id="fp_index'+fp_index+'" index="'+fp_index+'" style="width: 15%;"><input type="text" class="form-text" id="fp_conf'+fp_index+'" maxlength="31" style="width: 66px;" onblur="change_fpName(this)"><i class="ctrl del" onclick="_delFp(this)"></i></li>';
						$("#auth_divs").append(html_str1);
						$("#auth_divs").children('li:last').children('input').val(fp_name);
					}else if(result.status == 3){
						_closeLoading();
						clearInterval(if_ok);
					}
				}else{
					_alert(1,"系统用户",result.ErrMsg);
					return false;
				}
			}
		})
	}
	function getRamdomIndex(fp_index) {
		var flag4 = true;
		function innerFunc1(){
			flag4 = true;
			$.each($("#auth_div").find('li'),function(i,item){
				if($(item).children('input').val().substring(0, 2) == "指纹" && fp_index == $(item).attr('index')){
					fp_index++;
					flag4 = false;
					innerFunc1(fp_index);
					return false;
				}
			})
		}
		innerFunc1(fp_index);
		if(flag4 == true){
			return fp_index;
		}
	}
	function getNameIndex(name_index) {
		var flag4 = true;
		function innerFunc1() {
			flag4 = true;
			$.each($("#auth_divs").find('li'),function(i,item){
				if($(item).children('input').val() == "指纹"+name_index){
					name_index++;
					flag4 = false;
					innerFunc1(name_index);
					return false;
				}
			})
		}	
		innerFunc1(name_index);
		if(flag4 == true){
			return name_index;
		}
	}
	function _delFp(obj) {
		var $c = $(obj).parent();
		var fname = $(obj).prev().val();
		$c.remove();
		var fp_list = FP_TMP.split('\n');
		$.each(fp_list,function (i,item) {
			if(item.split('\t')[0] == fname){
				fp_list.splice(i,1);
				return false;
			}
		})
		FP_TMP = fp_list.join('\n');
		if(FP_TMP == ""){
			$("#FinP_reset_div").find('text').text("未录入");
		}
	}
	function change_fpName(obj) {
		var index = $(obj).parent().index() - $("#auth_divs").children('div').length;
		var fname = $(obj).val();
		if(fname == ""){
			_alert(1, "系统用户", "指纹配置名称不能为空");
		}
		var fp_list = FP_TMP.split('\n');
		var flag3 = false;
		$.each(fp_list,function (i,item) {
			if(item.split('\t')[0] == fname && index != i){
				flag3 = true;
				$(obj).val("");
				_alert(1, "系统用户", "已存在相同指纹配置名称");
				return false;
			}
			if(index == i){
				var fname_tmp = item.split('\t')[1];
				fp_list[i] = fname + '\t' + fname_tmp;
			}
		})
		if(flag3 == false){
			FP_TMP = fp_list.join('\n');
		}
	}
	//指纹
	var re_5;
	function setFinP() {
		if(FP_TMP.split('\n').length >= 10){
			_alert(1,"系统用户","指纹配置不能超过十个");
			return false;
		}		
		var sesstime = new Date().getTime();
		//type -> 录入 Register    验证 Verify
		json_data = {
			"type": "Register",
			"UrlIp": document.domain+ (location.port!=''?':'+location.port:''), 
			"sesstimet": sesstime, 
			"User": window.parent.document.frm.us.value, 
			"Id": "",
			"Ifzkfp": 1
		}
		_showLoading();
		$.ajax({
			url: "/bhost/insert_fp",
			type:"POST",
			async: true,
			data:{a0:window.parent.document.frm.us.value,a1:sesstime},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
					$.ajax({
						url: "/bhost/get_base64",
						type:"POST",
						async: true,
						data:{z1:JSON.stringify(json_data)},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								base64_str = result.b64;
								$('#YuFrame1').remove();
								$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
								$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+ base64_str);
								//每5秒刷新录入结果
								var c = 0;
								var if_ok_down_other = setInterval(function(){
									var se = se || ' ';
									var ret = repeat_get_path_other(sesstime,se);
									if(ret[0] == 1 && ret[1].toLowerCase() == 'true' ){
										if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='1';
										clearInterval(if_ok_down_other);
										re_5 = function(){
											if_ok = setInterval(function(){
												IfSaveSuccess(sesstime);
											},1000)}
										re_5();
										return 0;
									}
									if(c >= 10){
										if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='0';
										clearInterval(if_ok_down_other);
										alertError('bhost',se,window.parent.document.frm.us.value);
										_closeLoading();
										return 0;
									}
									c = c + 1;
								},500)
							}else{
								_alert(1,"系统用户",result.ErrMsg);
								return false;
							}
						}
					})
				}else{
					_alert(1,"系统用户",result.ErrMsg);
					return false;
				}
			}
		})
	}

	

	function _get_rn(user_item){
		var userid = null;
		$.ajax({
			url:"/bhost/_get_rn",
			type:"POST",
			//async:false,
			data:{a0:$("input[name=se]").val(),a1:userid},
			success:function(result){
				var msg_result = JSON.parse(result);
				if(msg_result){
					msg_data = msg_result.info;
					$.each(msg_data.data,function(i,item){
						$("#rn").append("<label class=\"form-label\"  title=\""+item.msgName+"\"style=\"width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 10px;\"><input class=\"form-checkbox\" type=\"checkbox\" name=\""+item.msgName+"\" id=\"msg_"+item.msgId+"\">"+item.msgName+"</label>"); 
					})
				}else{
					_alert(1,"系统用户",'用户名获取失败，失败原因：'+data.info);
				}
				$('#rn .form-checkbox,.form-radio').iCheck({
					checkboxClass: 'icheckbox_minimal-blue',
					radioClass: 'iradio_minimal-blue',
					increaseArea: '0' // optional
				});
				msgSet = user_item.msgSet;
				$.each(msgSet,function(i,item){
					$("#msg_" +item.msgId).iCheck('check');
					$("#msg_" +item.msgId).iCheck('disable');
					// $("#select_r select").eq(i).val(item.msgId).trigger("change");
					// $("#select_r").children().children().last().trigger('click')
				})
			}
		})
	}

	function _get_un(user_item){
		//var userid = null;
		$("#pu_id").append("<option value=\"0\">请选择</option>");
		$.ajax({
			url:"/bhost/_get_un",
			type:"POST",
			//async:false,
			data:{a0:$("input[name=se]").val(),a1:user_item.UserId},
			success:function(result){
				var user_result = JSON.parse(result);
				if(user_result){
					user_data = user_result.info;
					$.each(user_data,function(i,item){
						$("#pu_id").append("<option value=\""+item.UserId+"\">"+item.UserCode+"</option>");
						if(item.Selected == true){
							$("#un").append("<label class=\"form-label\"  title=\""+item.UserCode+"\"style=\"width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 10px;\"><input class=\"form-checkbox\" type=\"checkbox\" name=\""+item.UserCode+"\" id=\""+item.UserId+"\" disabled=\"disabled\">"+item.UserCode+"</label>"); 
							$("#un_g").append("<label class=\"form-label\"  title=\""+item.UserCode+"\"style=\"width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 10px;\"><input class=\"form-checkbox\" type=\"checkbox\" name=\""+item.UserCode+"\" id=\"g"+item.UserId+"\"  disabled=\"disabled\">"+item.UserCode+"</label>");
							//$("#" +item.UserId).iCheck('check');
							//$("#g" +item.UserId).iCheck('check');
						}
						else
						{
							$("#un").append("<label class=\"form-label\"  title=\""+item.UserCode+"\"style=\"width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 10px;\"><input class=\"form-checkbox\" type=\"checkbox\" name=\""+item.UserCode+"\" id=\""+item.UserId+"\">"+item.UserCode+"</label>"); 
							$("#un_g").append("<label class=\"form-label\"  title=\""+item.UserCode+"\"style=\"width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 10px;\"><input class=\"form-checkbox\" type=\"checkbox\" name=\""+item.UserCode+"\" id=\"g"+item.UserId+"\">"+item.UserCode+"</label>"); 
						}

					})
				}else{
					_alert(1,"系统用户",'角色名获取失败，失败原因：'+data.info);
				}
				$('#un .form-checkbox,.form-radio').iCheck({
					checkboxClass: 'icheckbox_minimal-blue',
					radioClass: 'iradio_minimal-blue',
					increaseArea: '0' // optional
				});
				$('#un_g .form-checkbox,.form-radio').iCheck({
					checkboxClass: 'icheckbox_minimal-blue',
					radioClass: 'iradio_minimal-blue',
					increaseArea: '0' // optional
				});
				AdminSet = user_item.AdminSet;
				$.each(AdminSet,function(i,item){
					$("#" +item.AdminId).iCheck('check');
					$("#" +item.AdminId).iCheck('disable');
				})
				$("#pu_id").val(user_item.PwdApproveUserId).trigger("change");
			}
		})
	}

	//获取头像列表
	function _getAvatarList(obj){
		var offset = $(obj).offset();
		$('#avatars').css({
			top:offset.top -5,
			left:offset.left -5
		}).show();

		document.onclick = null;

		$('#avatars').hover(function(){
			document.onclick = null;
		},function(){
			document.onclick = function(){
				$('#avatars').fadeOut();
			}
		})
	}

	//设置头像
	function _setAvatar(obj){
		var src = $(obj).children('img').attr('src');
		$(obj).addClass('active').parent().siblings('li').children('a').removeClass('active');
		$('#tAvatar>img').attr('src',src);
		$('#avatars').fadeOut();
		photo = src.split('/')[3];
	}

	$(window).resize(function(){
		if($('#avatars').is(':visible')){
			var offset = $('#tAvatar').offset();
			$('#avatars').css({
				top:offset.top -5,
				left:offset.left -5
			});
		}
	})

	function change_Pwd(){
		$("#pwd1").show();
		$("#pwd2").show();
		$("#pwd3").show();
		$("#change_Pwd").hide();
	}

	var user = {
		"UserId": 0,
		"UserCode": "",
		"UserName": "",
		"Password": "", 
		"Department": null, 
		"MobilePhone": null,
		"Email": null,
		"Description": null,
		"ExpireTimeEnabled": false,
		"ExpireTime": "", 
		"UserStatus": 1,
		"PhotoIcon": null,
		"CreatorId": 1,
		"ThirdUserCode": "",
		"ManageIPUnlimited": false,
		"SrcIPUnlimited": false,
		"AuthTypeId": 1003,
		//"TokenId": "",
		"LanCode": 0,
		"PwdApproveUserId": 0,
		"AdminSet": [
		],
		"UGroupSet": [
		],
		"msgSet": [
		],
		"ManageAuthSet": [
		],
		"CScopeSet": [
		] 
	};
	var photo = "avatar1.jpg";

	function dataCheck(obj, min, max){
		obj.value = obj.value.replace(/\D/g, "");
		if(min){
			if(parseInt(obj.value, 10) < parseInt(min, 10)) obj.value = min;
		}
		if(max){
			if(parseInt(obj.value, 10) > parseInt(max, 10)) obj.value = max;
		}
	}
	function IDCheck(obj){
		var IDReg = /^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/;
		var val = $(obj).val();
		var $i = $(obj).next('i.v-check');

		if(IDReg.test(val) && val.length > 1){
			$i.show().attr('class','v-check v-right');
		}else{
			$i.show().attr('class','v-check v-wrong');
		}
	}
	function nameCheck(obj){
		var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		var val = $(obj).val();
		var $i = $(obj).next('i.v-check');

		if(nameReg.test(val)){
			$i.show().attr('class','v-check v-right');
		}else{
			$i.show().attr('class','v-check v-wrong');
		}
	}
	function phoneCheck(obj){
		var phoneReg = /^[0-9]{11}$/;
		var val = $(obj).val();
		var $i = $(obj).next('i.v-check')

		if(phoneReg.test(val) || val == ""){
			$i.show().attr('class','v-check v-right');
		}else{
			$i.show().attr('class','v-check v-wrong');
		}
	}
	function emailCheck(obj){
		var emailReg = /^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/;
		var val = $(obj).val();
		var $i = $(obj).next('i.v-check')

		if(emailReg.test(val) || val == ""){
			$i.show().attr('class','v-check v-right');
		}else{
			$i.show().attr('class','v-check v-wrong');
		}
	}
	var oldPwd_check;
	function savedata(){
		var old_psd = user_item.Password;
		var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		var phoneReg = /^[0-9]{11}$/;
		var emailReg = /^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/;
		var UserNumberReg = /^[a-zA-Z\d_]+$/;
		var sys_u_name = $("#sys_u_name").val();
		var UserNumber = $("#UserNumber").val();
		var user_name = $("#user_name").val();
		var thirduser = $("#thirduser").val();
		var sys_u_depart = $("#sys_u_depart").val();
		var sys_u_phone = $("#sys_u_phone").val();
		var sys_u_email = $("#sys_u_email").val();
		var sys_u_descr = $("#sys_u_descr").val();
		var sys_u_authtype = $("#sys_u_authtype").val();
		var timeSet = $("#timeSet").val();
		var date = $("#datepicker").val();
		var hour = $("#shour").val();
		var min = $("#smin").val();
		var sec = $("#ssec").val();
		var bdiusr = $("#bdiusr").val();
		var manaip = $("#manaip").val();
		var iplimited = $("#iplimited").val();
		var pwdApproveUserId = $("#pu_id").val();
		var msgSet = [];
		var AdminSet = [];
		UGroupSet = user_ugroup;
		user_item.UserId = parseInt(u_id);
		var sys_u_pwd_old = $("#sys_u_pwd_old").val();
		var sys_u_pwd_new = $("#sys_u_pwd_new").val();
		var sys_u_pwd_tr = $("#sys_u_pwd_tr").val();
		/*
		if(sys_u_pwd_new == "" && flag == 0){
			_alert(1,"系统用户","请输入密码",$('#sys_u_pwd_new'));
			return false;
		}		*/
		oldPwd_check = "";
		var flag1 = false;	
		if(sys_u_pwd_new == sys_u_pwd_tr && sys_u_pwd_new == ""){
			sys_u_pwd_new = user_item.Password;
			flag1 = true;
		}else if(sys_u_pwd_new != "" && sys_u_pwd_tr!= "" && sys_u_pwd_new == sys_u_pwd_tr){
			if($("#sys_u_pwd_old").is(":visible")){
				oldPwd_check = $("#sys_u_pwd_old").val();
				if(oldPwd_check == ""){
					_alert(1,"系统用户","操作失败，失败原因：当前密码错误");
					return false;
				}
			}			
			sys_u_pwd_new = $("#sys_u_pwd_new").val();
		}else{
			_alert(1,"系统用户","两次密码不匹配");
			return false;
		}
		if(local_check == true){
			if (!PwdStrategy.PwdMinLen) PwdStrategy.PwdMinLen = 6;
			if(sys_u_pwd_new.length<PwdStrategy.PwdMinLen){
				_alert(1,"系统用户","密码长度必须大于或等于"+PwdStrategy.PwdMinLen+"位",$('#sys_u_pwd_new'));
				return false;
			}
			if(sys_u_pwd_new.length > 64 && flag1 != true){
				_alert(2, "系统用户", "密码不能超过系统限定64位", $("#sys_u_pwd_new"));
				return false;
			}
			if(PwdStrategy.IfPwdComplex){
				if(PwdStrategy.IfPwdIncLowerApha){
					var now=sys_u_pwd_new.search(/[a-z]/);
					if(now==-1){_alert(1,"系统用户","密码中请包含小写字母",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncUpperApha){
					var now=sys_u_pwd_new.search(/[A-Z]/);
					if(now==-1){_alert(1,"系统用户","密码中请包含大写字母",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncNumber){
					var now=sys_u_pwd_new.search(/[0-9]/);
					if(now==-1){_alert(1,"系统用户","密码中请包含数字",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncSpecialChar){
					var now=sys_u_pwd_new.search(/[^A-Za-z0-9]/);
					if(now==-1){_alert(1,"系统用户","密码中请包特殊字符",$('#sys_u_pwd_new'));return false;}
				}
			}
		}
		if(sys_u_name == ""){
			_alert(1,"系统用户","请输入账号",$('#sys_u_name'));
			return false;
		}
		if(!nameReg.test(sys_u_name)){
			_alert(1,"系统用户","账号格式不正确",$('#sys_u_name'));
			return false;
		}
		if(user_name == ""){
			_alert(1,"系统用户","请输入姓名",$('#user_name'));
			return false;
		}
		var len = 0;
		for (var i = 0; i < user_name.length; i++) {
			if (user_name.charAt(i).match(/[\u4E00-\u9FA5]/ig) != null) //全角 
				len += 2; 
			else
				len += 1; 
		}
		if(len >= 128){
			_alert(1,'系统用户',"输入的姓名过长",$('#user_name'));
			return false;
		}
		if(UserNumber != "" && !UserNumberReg.test(UserNumber)){
			_alert(1,"系统用户","工号不正确",$('#UserNumber'));
			return false;
		}
		if(UserNumber==''){
			UserNumber=null;
		}
		if(!phoneReg.test(sys_u_phone) && sys_u_phone != ""){
			_alert(1,"系统用户","手机格式不正确",$('#sys_u_phone'));
			return false;
		}
		if(!emailReg.test(sys_u_email) && sys_u_email != ""){
			_alert(1,"系统用户","EMAIL格式不正确",$('#sys_u_email'));
			return false;
		}
		if($("#ti").is(':visible') == true && $("#ti").val() == -1){
			_alert(1,"系统用户","请选择令牌");
			return false;		
		}
		/*
		if (new_pin == "" && $("#usbkey_div").is(':visible') == true ){
			_alert(2,"系统用户","请输入PIN码");
			return false;
		}
		*/
		user_item.UserCode = sys_u_name;
		user_item.UserName = user_name;
		user_item.UserNumber=UserNumber;
		user_item.Password = sys_u_pwd_new;
		user_item.Department = sys_u_depart;
		user_item.MobilePhone = sys_u_phone;
		user_item.Email = sys_u_email;
		user_item.Description = sys_u_descr;
		user_item.PhotoIcon = photo;
		//user_item.AdminSet = AdminSet;
		//user_item.msgSet = msgSet;

		if(user_item.UserCode == "admin"){
			var ManageAuthSet = [
				{
					"ManageAuthId": global_maid,
					"ManageScopeMode": 2,
					"UserSet": [
						{
							"Id": 1,
							"Type": 1
						}
					],
					"MScopeSet": [],
					"CScopeSet": [],
				}
			];
			IPList = {"IPSetId":0,"Set":[]};
			MACList = {"MACSetId":0,"Set":[]};
			CScopeSet =[];
			var flag_ip_mac = 0;
			$.each($("#Temp4").find('i'),function(i,item){
				var m = $(item).parent().find('input').not('input:hidden').val();
				if(i == 0 && m == ""){
					return true;		
				}else{
					var obj = $(item);
					var type = $(obj).parent().children('select').find('option:selected').val();
					
					var add = 0;
					if (type == 1 || type == 2){
						if (type == 2){
							var start_ip = $(obj).parent().find('input').not('input:hidden').eq(0).val();
							var end_ip = $(obj).parent().find('input').not('input:hidden').eq(1).val();
							if (start_ip == "" && i != 0 && end_ip != ""){
								_alert(2,"用户管理","请输入起始IP地址",$(obj).parent().find('input').not('input:hidden').eq(0));
								flag_ip_mac = 1;
								return false;
							}
							if (end_ip == "" && start_ip != ""){
								_alert(2,"用户管理","请输入终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
								flag_ip_mac = 1;
								return false;
							}
							if (!ipcheck_route.test(start_ip)){
								_alert(1,"用户管理","起始IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
								flag_ip_mac = 1;
								return false;
							}
							if (!ipcheck_route.test(end_ip)){
								_alert(1,"用户管理","终止IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
								flag_ip_mac = 1;
								return false;
							}
							var a = _compare_ip(start_ip,end_ip);
							if (a != 3){
								_alert(2,"用户管理","起始IP地址不能大于或等于终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
								flag_ip_mac = 1;
								return false;
							}
							$(obj).parent().siblings().find('.set-view.set-view2').not('.set-view.set-view2:hidden').each(function(i,item){
								if ($(item).find('input').not('input:hidden').eq(0).val() == start_ip && $(item).find('input').not('input:hidden').eq(1).val() == end_ip){
									add = 1;
									_alert(1,"用户管理","已存在相同IP区间",$(obj).parent().find('input').not('input:hidden').eq(0));
									flag_ip_mac = 1;
									return false;
								}
							});
							if (add == 1){
								flag_ip_mac = 1;
								return false;
							}
							save_mana_set(1,start_ip,end_ip);
						}else{
							var start_ip = $(obj).parent().find('input').not('input:hidden').val();
							var end_ip = start_ip;
							if (start_ip == "" && i != 0){
								_alert(2,"用户管理","请输入IP地址",$(obj).parent().find('input').not('input:hidden'));
								flag_ip_mac = 1;
								return false;
							}
							if (!ipcheck_route.test(start_ip)){
								_alert(1,"用户管理","IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden'));
								flag_ip_mac = 1;
								return false;
							}
							$(obj).parent().siblings().find('.set-view.set-view4').not('.set-view.set-view4:hidden').each(function(i,item){
								if ($(item).find('input').not('input:hidden').val() == start_ip){
									add = 1;
									_alert(1,"用户管理","已存在相同IP地址",$(obj).parent().find('input').not('input:hidden'));
									flag_ip_mac = 1;
									return false;
								}
							});
							if (add == 1){
								flag_ip_mac = 1;
								return false;
							}
							save_mana_set(1,start_ip,end_ip);
						}
					}else{
						if (type == 3 ){
							var mac_input = $(obj).parent().find('input').not('input:hidden').val().trim();
							if (mac_input == "" && i != 0){
								_alert(2,"用户管理","请输入MAC地址",$(obj).parent().find('input').not('input:hidden'));
								flag_ip_mac = 1;
								return false;
							}
							if (!MACReg.test(mac_input)){
								_alert(1,"用户管理","MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden'));
								flag_ip_mac = 1;
								return false;
							}
							$(obj).parent().siblings().find('.set-view.set-view3').not('.set-view.set-view3:hidden').each(function(i,item){
								if (mac_input == $(item).find('input').not('input:hidden').val().trim()){
									add = 1;
									_alert(1,"用户管理","该MAC地址已存在",$(obj).parent().find('input').not('input:hidden'));
									flag_ip_mac = 1;
									return false;
								}
							});
							if (add == 1){
								flag_ip_mac = 1;
								return false;
							}
							save_mana_set(2,mac_input,mac_input);
						}else if(type == 4){
							var start_mac = $(obj).parent().find('input').not('input:hidden').eq(0).val().trim();
							var end_mac = $(obj).parent().find('input').not('input:hidden').eq(1).val().trim();
							if (start_mac == "" && i != 0 && end_mac != ""){
								add = 1;
								_alert(2,"用户管理","请输入起始MAC地址",$(obj).parent().find('input').not('input:hidden').eq(0));
								flag_ip_mac = 1;
								return false;
							}
							if (end_mac == "" && i != 0 && start_mac != ""){
								add = 1;
								_alert(2,"用户管理","请输入终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
								flag_ip_mac = 1;
								return false;
							}
							if (!MACReg.test(start_mac)){
								add = 1;
								_alert(1,"用户管理","起始MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
								flag_ip_mac = 1;
								return false;
							}
							if (!MACReg.test(end_mac)){
								add = 1;
								_alert(1,"用户管理","终止MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
								flag_ip_mac = 1;
								return false;
							}
							var a = _compare_mac(start_mac,end_mac);
							if (a != 3){
								add = 1;
								_alert(1,"用户管理","起始MAC地址不能大于或等于终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
								flag_ip_mac = 1;
								return false;
							}
							if (add == 1){
								flag_ip_mac = 1;
								return false;
							}
							$(obj).parent().siblings().find('.set-view.set-view5').not('.set-view.set-view5:hidden').each(function(i,item){
								if (start_mac == $(item).find('input').not('input:hidden').eq(0).val().trim() && end_mac == $(item).find('input').not('input:hidden').eq(1).val().trim()){
									add = 1;
									_alert(1,"用户管理","该MAC地址区间已存在",$(obj).parent().find('input').not('input:hidden').eq(0));
									flag_ip_mac = 1;
									return false;
								}
							});
							if (add == 1){
								flag_ip_mac = 1;
								return false;
							}
							save_mana_set(2,start_mac,end_mac);
						}else if(type == 5){
							var accset;
							if(i == 0){
								if($("#client_list").is(":visible")){
									if($("#accset").data('value') == undefined || $("#accset").data('value') == '-1'){
										return true;
									}else{
										accset = $("#accset").data('value');
									}
								}
							}else{
								if($(obj).parent().attr('auth_id') !=undefined) return true;
								accset = $(obj).parent().attr('id');						
							}
							if (client_list.indexOf(accset) == -1){
								client_list.push(accset);
							}
							save_mana_set(3,accset,accset); 
						}
					}
				}	
			})
			if(flag_ip_mac != 0){
				return false;
			}
			List2 = {
			  "ClientScopeId": 0,
			  "Type": 2, 
			  "IPList": {},
			  "MACList": {}
			};
			if(!$.isEmptyObject(IPList.Set)){
				List2.IPList = IPList;
			}
			if(!$.isEmptyObject(MACList.Set)){
				List2.MACList = MACList;
			}
			
			ManageAuthSet[0].CScopeSet = CScopeSet;
			user_item.ManageAuthSet = ManageAuthSet;
			if($.inArray(List2,CScopeSet) == -1){
				if(List2.ClientScopeId != 0 || !$.isEmptyObject(List2.IPList) || !$.isEmptyObject(List2.MACList)){
					CScopeSet.push(List2);
					ManageAuthSet[0].CScopeSet = CScopeSet;
					user_item.ManageAuthSet = ManageAuthSet;
				}
			}
			if(user_item.ManageAuthSet[0].MScopeSet == "" && user_item.ManageAuthSet[0].CScopeSet == ""){
				user_item.ManageAuthSet = null;
			}
		};
		//return false;
		var AccessSet = {
			"UserId": 0, 
			"AccessAuthSet": [

			]
		}
		//AccessSet.UserId = UGroupSet[0].UGId;
		var repeat = 0;
		if(PwdStrategy.IfPwdUnRepeat){
			repeat = PwdStrategy.PwdUnRepeat;
		}else{
			repeat = 0;
		}
		user_item.AuthTypeId = global_auth == -1 ? null:global_auth;
		//
		if($("#CertCn").is(':visible') == true) {
			if($('#CertCn').val() == ''){
				_alert(1,"系统用户","请输入认证唯一标识",$('#CertCn'));
				return false;
			}
			user_item.CertCn = $('#CertCn').val();
			
		}
		else user_item.CertCn = '';
		
		if($("#ti").is(':visible') == true){
			user_item.TokenId = $("#ti").val();
		}else{
			user_item.TokenId = null;
		}
		
		msstr = aceg(JSON.stringify(user_item),$("input[name=se]").val());
		msstr1 = aceg(JSON.stringify(AccessSet),$("input[name=se]").val());
		
		if (new_pin == "" && $("#usbkey_div").is(':visible') == true ){
			layer.open({
				type:1,
				title:"系统用户",
				content:'<div class="layer-alert"><i class="alert warning"></i>PIN码未修改，可能导致用户登陆失败，是否保存</div>',
				btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					layer.close(i);
						$.ajax({
							url:'/bhost/make_cache',
							type:"POST",
							async:false,
							success: function(Result) {
								data = JSON.parse(Result);
								user_item['start_time'] = data['start_time'];
								user_item['cnone'] = data['cnone'];
								user_item['sign'] = data['sign'];
							}
						})
					
					msstr = aceg(JSON.stringify(user_item),$("input[name=se]").val());
					msstr1 = aceg(JSON.stringify(AccessSet),$("input[name=se]").val());
					$.ajax({
						url:'/bhost/add_sys_user1',
						type:"POST",
						async:false,
						data:{a0:$("input[name=se]").val(),a1:JSON.stringify(user_item),a2:JSON.stringify(AccessSet),a3:old_psd,a4:repeat,a5:new_pin,a6:oldPwd_check,a7:FP_TMP,a10:"基本信息",m1:msstr,m2:msstr1},
						//contentType: 'application/json',
						success: function(Result) {
							data = JSON.parse(Result);
							if (data.Result){
								layer.open({
									type:1,
									title:"系统用户",
									content:'<div class="layer-alert"><i class="alert succ"></i>修改成功</div>',
									btn:'确&nbsp;&nbsp;定',
									btnAlign:'c',
									closeBtn: false,
									skin:'layer-custom',
									area:['380px','310px'],
									move: false,
									resize: false,
									btn1:function(i){
										layer.close(i);
										$("#pwd1").hide();
										$("#pwd2").hide();
										$("#pwd3").hide();
										$("#change_Pwd").show();
										$("#info").hide();
										$('#related_downloads_show').hide();
										$('#terminal_show').hide();
										$("#detail").show();
										$("#u_i").text(user_item.UserCode);
										$("#u_i").append('<img src="/manage/images/'+user_item.PhotoIcon+'" alt="">');
									}
								});		
							}
							else{
								user_item.Password = old_psd;
								_alert(1,"系统用户",'操作失败，失败原因：'+data.ErrMsg);
							}
						}
					})
				},btn2:function(i){
					layer.close(i);
					change_PIN();
				}
			});
			return 0;
		}
		$.ajax({
			url:'/bhost/make_cache',
			type:"POST",
			async:false,
			success: function(Result) {
				data = JSON.parse(Result);
				user_item['start_time'] = data['start_time'];
				user_item['cnone'] = data['cnone'];
				user_item['sign'] = data['sign'];
			}
		})
		msstr = aceg(JSON.stringify(user_item),$("input[name=se]").val());
		msstr1 = aceg(JSON.stringify(AccessSet),$("input[name=se]").val());
		$.ajax({
			url:'/bhost/add_sys_user1',
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:JSON.stringify(user_item),a2:JSON.stringify(AccessSet),a3:old_psd,a4:repeat,a5:new_pin,a6:oldPwd_check,a7:FP_TMP,a10:"基本信息",m1:msstr,m2:msstr1},
			//contentType: 'application/json',
			success: function(Result) {
				data = JSON.parse(Result);
				if (data.Result){
					if(new_pin !=''){
						var Content = '';
						var UserId =0;
						$.ajax({
							url:"/bhost/get_usbkey_cert",
							async:false,
							type:"POST",
							data:{a0:$("#sys_u_name").val(),a1:'',a2:0,a4:1},
							success:function(Result){
								Result = JSON.parse(Result);
								if(Result.result == false){ //获取失败
									_alert(2,"系统用户",Result.ErrMsg);
									return false;
								}else{
									Content = Result.Content;
									UserId = Result.UserId;
								}
							}
						})
					
						sesstime = new Date().getTime()-1;
						cmd_json ={
							"type":"SetUser",
							"sesstime": sesstime,//毫秒
							"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
							"IfUsbkey":true,
							"certInfo":'',
							"crlInfo":'',
							"bhuser":$('#sys_u_name').val(),
							"password":$("#pin_input1").val()
						}
						client_request(cmd_json,'SetUser',UserId,sesstime,Content);
					}else{
					
						layer.open({
							type:1,
							title:"系统用户",
							content:'<div class="layer-alert"><i class="alert succ"></i>修改成功</div>',
							btn:'确&nbsp;&nbsp;定',
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							btn1:function(i){
								layer.close(i);
								$("#pwd1").hide();
								$("#pwd2").hide();
								$("#pwd3").hide();
								$("#change_Pwd").show();
								$("#info").hide();
								$('#related_downloads_show').hide();
								$('#terminal_show').hide();
								$("#detail").show();
								$("#u_i").text(user_item.UserCode);
								$("#u_i").append('<img src="/manage/images/'+user_item.PhotoIcon+'" alt="">');
							}
						});
					}				
				}
				else{
					user_item.Password = old_psd;
					_alert(1,"系统用户",'操作失败，失败原因：'+data.ErrMsg);
				}
			}
		})
	}

	function get_msg(){
		clearTimeout(t_get_msg);
		var n=0;
		$.ajax({
			url: '/bhost/get_msg',
			type: "post",
			async: true,
			data: {a0:$("input[name=se]").val()},
			success: function(result) {
				var result=JSON.parse(result);
				////////console.log('get_msg---------------------------------------------------------');
				if(result.Result == false){
					n = 1;
					if(result.info.indexOf('系统异常')>=0 || result.info.indexOf('非法访问')>=0 || result.info.indexOf('系统超时') >=0 ){
						_alert(2,'系统',result.info);
					}else{
						_alert(2,'系统',result.info);
					}
				}
				else{
					t_get_msg=setTimeout(function(){get_msg();},8000);
				}
				return false;
			},
			error:function(){
				t_get_msg=setTimeout(function(){get_msg();},8000);
			}
		})	
	}
	function manage_page(obj){
		if( IEVersion() < 10 && IEVersion() >0){
			os_type = detectOS();			
			layer.open({
				type:1,
				title:"下载浏览器",
				content:'<div class="layer-alert"><i class="alert warning"></i>当前浏览器版本太低，请安装chrome浏览器访问</div>',
				btn:['下&nbsp;&nbsp;载', '取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					layer.close(i);
					//根据 系统下载对应的浏览器
					if(os_type.indexOf('Win7') > -1 || os_type.indexOf('Win8') > -1 || os_type.indexOf('Win10') > -1 ){
						location.href='/bhost/download_chrome_exe?t1=Win7';
					}else if(os_type.indexOf('WinXP') > -1){
						location.href='/bhost/download_chrome_exe?t1=WinXP';
					}
					
				},
				btn2:function(i){
					layer.close(i);
				}
			});
			return true;
			
		}
	
	
		//$("#switchPage_button").children('ul').hide();
		$("#switchPage_button").prev().text("管理")
		reheight(1);
		if($("#MonitorStyle").attr('value') == 1){
			$("#mainFrame").attr("src","/bhost/index?tasktype=1_1&us={{us}}&se={{se}}");
		}else if($("#MonitorStyle").attr('value') == 2){			
			$("#mainFrame").attr("src","/bhost/index?tasktype=1&us={{us}}&se={{se}}");
		}
		$("#nav-s1").children().find('li').children('.active').attr('class','');
		$("#nav-s1").children().find('li').eq(0).children().attr('class','active');
		$("#nav-s1").show();
		$("#nav-s2").hide();
		//$(obj).attr("onclick","");
		//$(obj).parent('li').next().children('a').attr("onclick","operation_page(this)");
		$('#info').hide();
		$('#related_downloads_show').hide();
		$('#terminal_show').hide();
		$('#msg_manage_1').hide();
		$('#msg_manage_2').hide();
		$('#msg_manage_4').hide();
		$('#msg_manage_5').hide();
		$('#msg_manage_6').hide();
		$('#detail').show();
		
		if($('li[data-modeid=1]').is(':hidden')){
			var li_visible=$('.nav-s1 li:visible');
			li_visible.eq(0).children('a').trigger('click');
		}
		
	}
	function operation_page(obj){
		//$("#switchPage_button").children('ul').hide();
		$("#switchPage_button").prev().text("运维");
		reheight();
		$("#mainFrame").attr("src","/bhost/index?tasktype=9&us={{us}}&se={{se}}");
		$("#nav-s2").children().find('li').children('.active').attr('class','');
		$("#nav-s2").children().find('li').eq(0).children().attr('class','active');
		$("#nav-s1").hide();
		$("#nav-s2").show();
		//$(obj).attr("onclick","");
		//$(obj).parents('li').prev().children('a').attr("onclick","manage_page(this)");
		$('#info').hide();
		$('#related_downloads_show').hide();
		$('#terminal_show').hide();
		$('#msg_manage_1').hide();
		$('#msg_manage_2').hide();
		$('#msg_manage_4').hide();
		$('#msg_manage_5').hide();
		$('#msg_manage_6').hide();
		$('#detail').show();		
	}
	function JumpToMonitor(){
		if($("#MonitorStyle").attr('value') == 1){
			$("#mainFrame").attr("src","/bhost/index?tasktype=1_1&us={{us}}&se={{se}}");
		}else if($("#MonitorStyle").attr('value') == 2){
			$("#mainFrame").attr("src","/bhost/index?tasktype=1&us={{us}}&se={{se}}");
		}
	}
</script>
<!-- msg1 -->
<script>
	var USERACCOUNT = "{{us}}";	//登录账号（接收信息者账号）
	var page_num;								//每页显示数
	var paging;									//页数
	var Total_all;
	var msg_sender;
	var msg_processtatus;
	var msg_status;
	var fenye;
	var select_str = "";
	var check_num = 0;
	var msg_array=new Array();

	function datacheck(obj){
		obj.value = obj.value.replace(/\D/g, "");
	}

	function related_downloads_show(){
		//$("#mainFrame").attr("src","/bhost/related_downloads_show?tasktype=2&a0={{se}}");
		$("#info").hide();
		$("#detail").hide();
		$('#msg_manage_1').hide();
		$('#msg_manage_2').hide();
		$('#related_downloads_show').show();
		$('#terminal_show').hide();
		$('#msg_manage_4').hide();
		$('#msg_manage_5').hide();
		$('#msg_manage_6').hide();
	}
	function switch_page(tasktype){
		switch(tasktype){
			case 1:
				$('#msg_manage_1').show();
				$('#msg_manage_2').hide();

				$('#msg_manage_4').hide();
				$('#msg_manage_5').hide();
				$('#msg_manage_6').hide();
				show_msg_list();
				break;
			case 2:
				$('#msg_manage_1').hide();
				$('#msg_manage_2').show();

				$('#msg_manage_4').hide();
				$('#msg_manage_5').hide();
				$('#msg_manage_6').hide();
				show_msg_list2();
				break;
			case 3:
				$('#msg_manage_1').hide();
				$('#msg_manage_2').hide();

				$('#msg_manage_4').hide();
				$('#msg_manage_5').hide();
				$('#msg_manage_6').hide();
				//show_msg_list3();				
				break;
			case 4:
				$('#msg_manage_1').hide();
				$('#msg_manage_2').hide();

				$('#msg_manage_4').show();
				$('#msg_manage_5').hide();
				$('#msg_manage_6').hide();
				//show_msg_list4();
				break;
			case 5:
				$('#msg_manage_1').hide();
				$('#msg_manage_2').hide();

				$('#msg_manage_4').hide();
				$('#msg_manage_5').show();
				$('#msg_manage_6').hide();
				//show_msg_list5();
				break;
			case 6:
				$('#msg_manage_1').hide();
				$('#msg_manage_2').hide();

				$('#msg_manage_4').hide();
				$('#msg_manage_5').hide();
				$('#msg_manage_6').show();
				//show_msg_list6();
				break;
		}
	}

	function show_msg_list(){
		$("#detail").hide();
		$("#info").hide();
		$('#related_downloads_show').hide();
		$('#terminal_show').hide();
		$('#msg_manage_1').show();
		$('#msg_manage_2').hide();

		$('#msg_manage_4').hide();
		$('#msg_manage_5').hide();
		$('#msg_manage_6').hide();
		msg_sender = 'null';
		msg_status = 'null';
		msg_processtatus = 'null';
		paging = 1;
		page_num = MAX_PAGE;
		// load_list();
		$("#msg_page").bind('keydown', function(e){
			DigitInput(e);
		});
		$("#msg_page").bind('keyup', function(e){
			DigitInput(e);
		});
		$('#check_one_page').unbind('ifClicked').on('ifClicked',function(e){
			if(!$('#check_one_page').prop('checked')){
				$("#m_list tbody input:enabled").iCheck('check');
			}else{
				$("#m_list tbody input:enabled").iCheck('uncheck');
			}
		})
		$("#msg_list").unbind('ifChecked').on("ifChecked",function(e){
			check_num++;
			$("#select_total").text(check_num);	
			if($("table tbody tr input:checked:enabled").length==$("#msg_list tr input:enabled").length){
				$('#check_one_page').iCheck('check');
			}
		}).on("ifUnchecked",function(e){
			check_num--;
			$("#select_total").text(check_num);	
			$('#check_one_page').iCheck('uncheck');	
		});
		$("#filter_select").select2({minimumResultsForSearch: -1});
		$("#filter_select").val('-1').trigger('change');	
		//parent._switchBtn(1);//显示按钮
	}

	function getNowFormatDate(){
		var date = new Date();  
		var seperator1 = "/";  
		var seperator2 = ":";  
		var month = date.getMonth() + 1;  
		 
		var strDate = date.getDate();  
		if (month >= 1 && month <= 9) {  
				month = "0" + month;  
		}  
		if (strDate >= 0 && strDate <= 9) {  
				strDate = "0" + strDate;  
		}
	
		var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate  
			+ " " + date.getHours() + seperator2 + date.getMinutes()  
			+ seperator2 + date.getSeconds();  
		return currentdate;  
	}
	function down_pwdfile(filename){
		$.ajax({
			url:"/bhost/exist_download_pwdfile",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:filename},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
					if(window.parent.parent.document.frm.use_BH.value=='0'){
						var form = $("<form></form>").attr("action", '/bhost/download_pwdfile').attr("method", "post").attr('enctype', 'multipart/form-data');
						form.append($("<input></input>").attr("type", "hidden").attr("name", "a1").attr("value", filename));
						form.append($("<input></input>").attr("type", "hidden").attr("name", "a0").attr("value", $("input[name=se]").val()));
						form.appendTo('body').submit().remove();
						return 0;
					}
					var sesstimet = (new Date()).valueOf();
					var referrer_arr=document.referrer.toString().split('/');
					referrer_arr.pop();
					var referrer=referrer_arr.join('/');
					var path_arr=filename.split('/');
					var file_name=path_arr[path_arr.length-1];
					var file_name_arr=file_name.split('_');
					var json_download = {
						"Type": "Download",
						"Url": referrer,
						"Path": '/usr/storage/.system/passwd/',
						"Filename": path_arr[path_arr.length-1],
						"Session": $("input[name=se]").val(),
						"sesstimet":sesstimet,
						"Filenewname": file_name_arr[0]+'_'+ window.parent.document.frm.us.value+'.pwd',
					}
					var if_html_client = false;
					var base64_str = '';
					$.ajax({
						url: "/bhost/get_base64",
						type:"POST",
						async:false,
						data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								if_html_client = result.info;
								base64_str = result.b64;
							}else{
								_alert(1,"相关下载",result.ErrMsg); 
							}
						}
					})
					if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
					else{
						get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
						$('#YuFrame1').remove();
						$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
						$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
					}
				}else{
					_alert(2,'收件箱','文件生成中，请稍等');
					return false;
				}
			}
		})
	}
	var delete_id=new Array();
	function clear_all(){
		delete_id=new Array();
		load_list();
	}
	var delete_id2=new Array();
	function clear_all2(){
		delete_id2=new Array();
		load_list2();
	}
	function delect_save(){
		$(">tr","#msg_list").each(function(){
			var input  = $(this).find("input[type='checkbox']:enabled");
			var delect_item=$(this).attr('id');
			var index=$.inArray(delect_item,delete_id);
			if($(input).is(':checked')){
				if(index<0){
					delete_id.push(delect_item);
				}
			}else{
				if(index>=0){
					delete_id.splice(index,1);
				}
			}
		});
	}
	function delect_save2(){
		$(">tr","#msg_list2").each(function(){
			var input  = $(this).find("input[type='checkbox']:enabled");
			var delect_item=$(this).attr('id').slice(4);
			var index=$.inArray(delect_item,delete_id2);
			if($(input).is(':checked')){
				if(index<0){
					delete_id2.push(delect_item);
				}
			}else{
				if(index>=0){
					delete_id2.splice(index,1);
				}
			}
		});
	}
	function delete_manage(){
		delect_save();
		if(delete_id.length == 0){
			_alert(2,"收件箱","请选择要删除的数据");
			return false;
		}
		var del_id=new Array();
		$.each(msg_array_arr,function(i,item){
			if ($.inArray(item.MessageId+'',delete_id)<0){
				return true;
			}
			if((item.MessageType==7 || item.MessageType==12) && item.ProcessStatus==0){
				del_id.push(item.MessageId);
			}
		});
		if(del_id.length>0){
			$('.btn').blur();parent.layer.open({
				type:1,
				title: '收件箱',
				content: '<div class="layer-alert"><i class="alert warning"></i>是否确认接收</div>',
				btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				yes:function(i){
					var del_i=0;
					var del_t=setInterval(function(){
						if(del_id.length>del_i){
							var jsondata={};
							jsondata.MessageId = del_id[del_i];
							jsondata.ProcessStatus = 2;
							jsondata.Status = 3;
							msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
							$.ajax({
								url: "/bhost/save_receive_msg",
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
								success:function(result){
									var result = JSON.parse(result);
									if(result.Result == true){
									}else{
										_alert("收件箱","改变消息状态失败");
										load_list();
										clearInterval(del_t);
									}
								}
							})
						}else{
							parent.layer.close(i);
							//利用对话框返回的值 （true 或者 false）
							$('.btn').blur();parent.layer.open({
								type:1,
								title: '收件箱',
								content: '<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
								btn:['删&nbsp;&nbsp;除','取&nbsp;&nbsp;消'],
								btnAlign:'c',
								closeBtn: false,
								skin:'layer-custom',
								area:['380px','310px'],
								move: false,
								resize: false,
								yes:function(i){
									$.ajax({
										url:'/bhost/del_manager_more',
										type:'post',
										async:false,
										data:{a0:$("input[name=se]").val(),a1:delete_id.join(','),a2:'Receiver'},
										success:function(result){
											var result=JSON.parse(result);
											if(result.Result){
												_alert(0,'收件箱','删除成功');
												delete_id=new Array();
												$('input[id=check_page]').iCheck('uncheck');
												load_list();
											}else{
												_alert(1,title_value,result.ErrMsg);
											}
										}
									});
									parent.layer.close(i);
								}
							});
						}
						del_i++;
					},100);
					
				}
			});
			return true;
		}
		//利用对话框返回的值 （true 或者 false）
		$('.btn').blur();parent.layer.open({
			type:1,
			title: '收件箱',
			content: '<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
			btn:['删&nbsp;&nbsp;除','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			yes:function(i){
				$.ajax({
					url:'/bhost/del_manager_more',
					type:'post',
					async:false,
					data:{a0:$("input[name=se]").val(),a1:delete_id.join(','),a2:'Receiver'},
					success:function(result){
						var result=JSON.parse(result);
						if(result.Result){
							_alert(0,'收件箱','删除成功');
							delete_id=new Array();
							$('input[id=check_page]').iCheck('uncheck');
							load_list();
						}else{
							_alert(1,title_value,result.ErrMsg);
						}
					}
				});
				parent.layer.close(i);
			}
		});
	}
	function delete_manage2(){
		delect_save2();
		if(delete_id2.length == 0){
			_alert(2,"发件箱","请选择要删除的数据");
			return false;
		}
		//利用对话框返回的值 （true 或者 false）
		$('.btn').blur();parent.layer.open({
			type:1,
			title: '发件箱',
			content: '<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
			btn:['删&nbsp;&nbsp;除','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			yes:function(i){
				$.ajax({
					url:'/bhost/del_manager_more',
					type:'post',
					async:false,
					data:{a0:$("input[name=se]").val(),a1:delete_id2.join(','),a2:'Sender'},
					success:function(result){
						var result=JSON.parse(result);
						if(result.Result){
							_alert(0,'发件箱','删除成功');
							$('#check_page2').iCheck('uncheck');
							delete_id2=new Array();
							load_list2();
						}else{
							_alert(1,title_value,result.ErrMsg);
						}
					}
				});
				parent.layer.close(i);
			}
		});
	}
	//全选按钮
	function click_all_list(){
		delect_save();
		if(msg_array.length==delete_id.length){
			delete_id=new Array();
		}else{
			delete_id=msg_array;
		}
		load_list();
	}
	//全选按钮
	function click_all_list2(){
		delect_save2();
		if(msg_array2.length==delete_id2.length){
			delete_id2=new Array();
		}else{
			delete_id2=msg_array2;
		}
		load_list2();
	}
	function load_list(){
		update_array();
		$.ajax({
			url: "/bhost/get_msg_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:msg_sender,a2:USERACCOUNT,a3:msg_status,a4:msg_processtatus,a5:page_num,a6:paging},
			success:function(result){
				var msg_result = JSON.parse(result);
				if (msg_result.Result==true){
					var msg_data = msg_result.info;
					var total_all = msg_data.totalrow;
					if(msg_data.data=="" && paging!="1"){
						msg_page(-1);
					}else{
						total = 0;
						Total_all = total_all;
						if(Total_all){
							$("#msg_list").empty();
								$.each(msg_data.data,function(i,item){
									if (total<page_num){
										total++;
										var str_tmp = "";
										var flag_unread = 0;
										switch(item.MessageType){
											case 1:
												item.MessageType = "访问审批";
												break;
											case 2:
												item.MessageType = "指令审批";
												break;
											case 3:
												item.MessageType = "协同邀请";
												break;
											case 4:
												item.MessageType = "工作下发";
												break;
											case 5:
												item.MessageType = "通知";
												break;
											case 6:
												item.MessageType = "批处理审批";
												break;
											case 7:
												item.MessageType = "自动改密";
												break;
											case 8:
												item.MessageType = "改密审批";
												break;
											case 9:
												item.MessageType = "工单下发";
												break;
											case 10:
												item.MessageType = "申请";
												break;
											case 11:
												item.MessageType = "工单申请";
												break;
											case 12:
												item.MessageType = "自动改密";
												break;
											case 13:
												item.MessageType = "下载审批";
												break;												
										}
										if(item.SessionId == ""){
											item.SessionId = null;
										}
										var del_str='';
										switch(item.Status){
											case 0:
												item.Status = "";
												//del_str="<a href=\"javascript:;\" title = \"删除\" class=\"del disabled\" id=\"del\"></a>";
												break;	//0-->未处理
											case 1:
												item.Status = "未发送";
												del_str="<a href=\"javascript:;\" title = \"删除\" class=\"del disabled\" id=\"del\"></a>";
												break;
											case 2:
												item.Status = "";
												flag_unread = 1;
												//del_str="<a href=\"javascript:;\" title = \"删除\" class=\"del disabled\" id=\"del\"></a>";
												break;	//2-->未读
											case 3:
												item.Status = "确认";
												break;
											// case 4:
											// 	item.Status = "已过期";
											// 	break;
											case 5:
												item.Status = "同意";
												break;
											case 6:
												item.Status = "拒绝";
												break;
										}
										switch(item.ProcessStatus){
											case 0:
												item.ProcessStatus = "未处理";
												del_str="<a href=\"javascript:;\" title = \"删除\" class=\"del disabled\" id=\"del\"></a>";
												break;
											// case 1:
											// 	item.ProcessStatus = "已读";
											// 	break;
											case 2:
												item.ProcessStatus = "已处理";
												break;
											case 3:
												item.ProcessStatus = "已过期";
												break;
											case 4:
												item.ProcessStatus = "已确认";
												break;
											case 5:
												item.ProcessStatus = "已协同"
										}
										if (item.MobilePhone!='' && item.MobilePhone!=null){
											item.MobilePhone=item.MobilePhone;
										}else{
											item.MobilePhone='';
										}
										if (item.Email!='' && item.Email!=null){
											item.Email=item.Email;
										}else{
											item.Email='';
										}
										var MobilePhone_Email='<p>&nbsp;&nbsp;&nbsp;&nbsp;联系方式：'
										if(item.MobilePhone!=''){
											MobilePhone_Email=MobilePhone_Email+item.MobilePhone;
											if(item.Email!=''){
												MobilePhone_Email=MobilePhone_Email+'，'+item.Email;
											}
										}else{
											if(item.Email!=''){
												MobilePhone_Email=MobilePhone_Email+item.Email;
											}
										}
										var input_checkbox='';
										if (del_str=='' || item.Sender==null || item.Sender==''){
											del_str="<a href=\"javascript:;\" title = \"删除\" class=\"del \" id=\"del\" onclick=\"del_manager("+item.MessageId+",'"+item.PwdFileName+"','Receiver',this)\"></a>";
											input_checkbox="<td><input type=\"checkbox\" class=\"input_checkbox\" /></td>";
										}else{
											input_checkbox="<td><input type=\"checkbox\" class=\"input_checkbox\" disabled/></td>";
										}
										//del_str="<a href=\"javascript:;\" title = \"删除\" class=\"del \" id=\"del\" onclick=\"del_manager("+item.MessageId+",'"+item.PwdFileName+"','Receiver',this)\"></a>";
										//input_checkbox="<td><input type=\"checkbox\" class=\"input_checkbox\" /></td>";
										item.Title = item.Title.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&apos;");
										item.Content = item.Content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&apos;").replace(/\r\n/g, "<p>&nbsp;&nbsp;&nbsp;&nbsp;");										
										var float_str= "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content+MobilePhone_Email;
										if(item.MessageType=='自动改密'){
											float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
										}else if(item.MessageType=='通知'){
											if(item.Title=='告警通知' && item.SenderId==1 && item.Sender.split('(')[0]=='admin'){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('改密计划')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('指令授权')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('工单授权')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('访问授权')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
										}else{
											float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content+MobilePhone_Email;
										}
										if(flag_unread == 1 && (item.ProcessStatus == "未处理" || item.ProcessStatus == "已过期")){
											if(item.ProcessStatus == "已过期"){//	加粗	1,2,3	disabled
												$("#msg_list").append("<tr id="+item.MessageId+" onclick=\"change_status1(0,"+item.MessageId+");\">"+
													input_checkbox+
													"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.CreateTime+"</td>"+
													"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.MessageType+"</td>"+
													"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Title+"</td>"+
													"<td title="+item.Sender+"><span title=\""+item.Sender+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Sender+"</td>"+
													"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Status+"</td>"+
													"<td title="+item.ProcessStatus+"><span title=\""+item.ProcessStatus+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.ProcessStatus+"</td>"+	
													"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\">"+
													"<a href=\"javascript:;\" title = \"确认\" class=\"msg1 disabled\" id=\"Confirm\" onclick=\"\"></a>"+
													"<a href=\"javascript:;\" title = \"同意\" class=\"msg2 disabled\" id=\"Agree\"></a>"+
													"<a href=\"javascript:;\" title = \"拒绝\" class=\"msg3 disabled\" id=\"Refuse\"></a>"+
													((item.PwdFileName!=null && item.PwdFileName!='' && (item.MessageType == "自动改密" || item.MessageType == "自动改密"))?"<a href=\"javascript:;\" title = \"下载\" class=\"icon6\" id=\"\" onclick=\"down_pwdfile('"+item.PwdFileName+"');\"></a>":"<a href=\"javascript:;\" title = \"下载\" class=\"icon6 disabled\" id=\"\" onclick=\"\"></a>")+
													del_str+
													"</div><a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a><div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
											}else if(item.MessageType == "工作下发" || item.MessageType == "通知" || item.MessageType == "自动改密" || item.MessageType == "下发工单任务" || item.MessageType == "自动改密"|| item.MessageType == "工单下发"){//	加粗	2,3	disabled
												$("#msg_list").append("<tr id="+item.MessageId+" onclick=\"change_status1(0,"+item.MessageId+");\">"+
													input_checkbox+
													"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.CreateTime+"</td>"+
													"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.MessageType+"</td>"+
													"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Title+"</td>"+
													"<td title="+item.Sender+"><span title=\""+item.Sender+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Sender+"</td>"+
													"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Status+"</td>"+
													"<td title="+item.ProcessStatus+"><span title=\""+item.ProcessStatus+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.ProcessStatus+"</td>"+	
													"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\">"+
													"<a href=\"javascript:;\" title = \"确认\" class=\"msg1\" id=\"Confirm\" onclick=\"change_status(1,"+item.MessageId+")\"></a>"+
													"<a href=\"javascript:;\" title = \"同意\" class=\"msg2 disabled\" id=\"Agree\"></a>"+
													"<a href=\"javascript:;\" title = \"拒绝\" class=\"msg3 disabled\" id=\"Refuse\"></a>"+
													((item.PwdFileName!=null && item.PwdFileName!='' && (item.MessageType == "自动改密" || item.MessageType == "自动改密"))?"<a href=\"javascript:;\" title = \"下载\" class=\"icon6\" id=\"\" onclick=\"down_pwdfile('"+item.PwdFileName+"');\"></a>":"<a href=\"javascript:;\" title = \"下载\" class=\"icon6 disabled\" id=\"\" onclick=\"\"></a>")+
													del_str+
													"</div><a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a><div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
											}else{//	加粗	1 disabled
												$("#msg_list").append("<tr id="+item.MessageId+" onclick=\"change_status1(0,"+item.MessageId+");\">"+
													input_checkbox+
													"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.CreateTime+"</td>"+
													"<td title="+item.MessageType+"><spantitle=\""+item.MessageType+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.MessageType+"</td>"+
													"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Title+"</td>"+
													"<td title="+item.Sender+"><span title=\""+item.Sender+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Sender+"</td>"+
													"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Status+"</td>"+
													"<td title="+item.ProcessStatus+"><span title=\""+item.ProcessStatus+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.ProcessStatus+"</td>"+	
													"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\"><a href=\"javascript:;\" title = \"确认\" class=\"msg1 disabled\" id=\"Confirm\"></a><a href=\"javascript:;\" title = \"同意\" class=\"msg2\" id=\"Agree\" onclick=\"change_status(2,"+item.MessageId+",'"+item.SessionId+"','"+item.MessageType+"','"+item.SenderId+"')\"></a><a href=\"javascript:;\" title = \"拒绝\" class=\"msg3\" id=\"Refuse\" onclick=\"change_status(3,"+item.MessageId+")\"></a>"+
													((item.PwdFileName!=null && item.PwdFileName!='' && (item.MessageType == "自动改密" || item.MessageType == "自动改密"))?"<a href=\"javascript:;\" title = \"下载\" class=\"icon6\" id=\"\" onclick=\"down_pwdfile('"+item.PwdFileName+"');\"></a>":"<a href=\"javascript:;\" title = \"下载\" class=\"icon6 disabled\" id=\"\" onclick=\"\"></a>")+
													del_str+
													"</div><a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a><div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
											}
										}else{
											if(item.ProcessStatus == "已过期" || item.Status == "同意" || item.Status == "拒绝" || item.ProcessStatus == "已确认" || item.ProcessStatus == "已处理"){// 1,2,3 diaabled
												$("#msg_list").append("<tr id="+item.MessageId+">"+
														input_checkbox+
														"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px;\">"+item.CreateTime+"</td>"+
														"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px;\">"+item.MessageType+"</td>"+
														"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px;\">"+item.Title+"</td>"+
														"<td title="+item.Sender+"><span title=\""+item.Sender+"\" style=\"width:200px;\">"+item.Sender+"</td>"+
														"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px;\">"+item.Status+"</td>"+
														"<td title="+item.ProcessStatus+"><span title=\""+item.ProcessStatus+"\" style=\"width:200px;\">"+item.ProcessStatus+"</td>"+	
														"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\"><a href=\"javascript:;\" title = \"确认\" class=\"msg1 disabled\" id=\"Confirm\"></a><a href=\"javascript:;\" title = \"同意\" class=\"msg2 disabled\" id=\"Agree\"></a><a href=\"javascript:;\" title = \"拒绝\" class=\"msg3 disabled\" id=\"Refuse\"></a>"+
													((item.PwdFileName!=null && item.PwdFileName!='' && (item.MessageType == "自动改密" || item.MessageType == "自动改密"))?"<a href=\"javascript:;\" title = \"下载\" class=\"icon6\" id=\"\" onclick=\"down_pwdfile('"+item.PwdFileName+"');\"></a>":"<a href=\"javascript:;\" title = \"下载\" class=\"icon6 disabled\" id=\"\" onclick=\"\"></a>")+
													del_str+
														"</div><a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a><div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
											}else{
												if(item.MessageType == "下发工作内容" || item.MessageType == "通知" || item.MessageType == "自动改密" || item.MessageType == "下发工单任务" || item.MessageType == "自动改密" || item.MessageType == "工单下发"){	//2,3 disabled
													$("#msg_list").append("<tr id="+item.MessageId+">"+
														input_checkbox+
														"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px;\">"+item.CreateTime+"</td>"+
														"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px;\">"+item.MessageType+"</td>"+
														"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px;\">"+item.Title+"</td>"+
														"<td title="+item.Sender+"><span title=\""+item.Sender+"\" style=\"width:200px;\">"+item.Sender+"</td>"+
														"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px;\">"+item.Status+"</td>"+
														"<td title="+item.ProcessStatus+"><title=\""+item.ProcessStatus+"\" style=\"width:200px;\">"+item.ProcessStatus+"</td>"+
														"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\">"+
														"<a href=\"javascript:;\" title = \"确认\" class=\"msg1\" id=\"Confirm\" onclick=\"change_status(1,"+item.MessageId+")\"></a>"+
														"<a href=\"javascript:;\" title = \"同意\" class=\"msg2 disabled\" id=\"Agree\"></a>"+
														"<a href=\"javascript:;\" title = \"拒绝\" class=\"msg3 disabled\" id=\"Refuse\"></a>"+
													((item.PwdFileName!=null && item.PwdFileName!='' && (item.MessageType == "自动改密" || item.MessageType == "自动改密"))?"<a href=\"javascript:;\" title = \"下载\" class=\"icon6\" id=\"\" onclick=\"down_pwdfile('"+item.PwdFileName+"');\"></a>":"<a href=\"javascript:;\" title = \"下载\" class=\"icon6 disabled\" id=\"\" onclick=\"\"></a>")+
													del_str+
														"</div><a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a><div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
												}else{		// 1:disabled
													$("#msg_list").append("<tr id="+item.MessageId+">"+
														input_checkbox+
														"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px;\">"+item.CreateTime+"</td>"+
														"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px;\">"+item.MessageType+"</td>"+
														"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px;\">"+item.Title+"</td>"+
														"<td title="+item.Sender+"><span title=\""+item.Sender+"\" style=\"width:200px;\">"+item.Sender+"</td>"+
														"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px;\">"+item.Status+"</td>"+
														"<td title="+item.ProcessStatus+"><title=\""+item.ProcessStatus+"\" style=\"width:200px;\">"+item.ProcessStatus+"</td>"+	
														"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\"><a href=\"javascript:;\" title = \"确认\" class=\"msg1 disabled\" id=\"Confirm\"></a>"+
														"<a href=\"javascript:;\" title = \"同意\" class=\"msg2\" id=\"Agree\" onclick=\"change_status(2,"+item.MessageId+",'"+item.SessionId+"','"+item.MessageType+"','"+item.SenderId+"')\"></a>"+
														"<a href=\"javascript:;\" title = \"拒绝\" class=\"msg3\" id=\"Refuse\" onclick=\"change_status(3,"+item.MessageId+")\"></a>"+
													((item.PwdFileName!=null && item.PwdFileName!='' && (item.MessageType == "自动改密" || item.MessageType == "自动改密"))?"<a href=\"javascript:;\" title = \"下载\" class=\"icon6\" id=\"\" onclick=\"down_pwdfile('"+item.PwdFileName+"');\"></a>":"<a href=\"javascript:;\" title = \"下载\" class=\"icon6 disabled\" id=\"\" onclick=\"\"></a>")+
													del_str+
														"</div><a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a><div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
												}
											}
											// if(item.ProcessStatus == "未处理"){
											// 	$("#"+item.MessageId).find('td').css('color','red');
											// }
										}
									}
								})
							tabArr();
							$(".input_checkbox","#msg_list").iCheck({
								checkboxClass: 'icheckbox_minimal-blue',
								radioClass: 'iradio_minimal-blue',
								increaseArea: '0' // optional
							});
							$("#msg_total").text(total_all);
							if(Total_all % page_num == 0){
								fenye = parseInt(Total_all/page_num);
							}else{
								fenye = parseInt(Total_all/page_num+1);
							}
							if(paging >= fenye){
								paging = fenye;
							}
							$("#msg_page").val(paging);
							$("#totalpage").text(fenye);
							$('#check_one_page').iCheck('uncheck');
							$("table tbody tr input").iCheck('uncheck');
							check_show();
							var select_str_s=select_str.split(",");
							check_num=select_str_s.length-1;
							$("#select_total")[0].textContent = check_num;
						}
						else{
							$("table").next("div.tab-i").children("div.il").find("span.select_total").text(0);
							$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
							$("#msg_list").empty();
							$("#msg_total").text(total_all);
							$("#totalpage").text(1);
							document.getElementById("msg_page").value=1;
						}	
					}
				}else{
					_alert(1,"消息查询",user_result.info);
					$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
					$("table").next("div.tab-i").children("div.il").find("span.select_total").text(0);
					$("#msg_total").text(0);
					$("#totalpage").text(1);
					document.getElementById("msg_page").value=1;
					return false;
				}
			}
		});
		//update_array();
	}
	function del_manager(id,filename,type,obj){
		if(type=='Receiver'){
			title_value='收件箱';
		}else{
			title_value='发件箱';
		}
		var manage_title=$(obj).parents('tr').children('td').eq(2).text();
		if ((manage_title=='自动改密' || manage_title=='自动改密') && title_value=='收件箱'){
			var manage_result=$(obj).parents('tr').children('td').eq(6).text();;
			if(manage_result=='未处理'){
				$('.btn').blur();parent.layer.open({
					type:1,
					title: title_value,
					content: '<div class="layer-alert"><i class="alert warning"></i>是否确认接收</div>',
					btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					yes:function(i){
						var jsondata={};
						jsondata.MessageId = id;
						jsondata.ProcessStatus = 2;
						jsondata.Status = 3;
						msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
						$.ajax({
							url: "/bhost/save_receive_msg",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
							success:function(result){
								var result = JSON.parse(result);
								if(result.Result == true){
									$("#"+id).children('td').eq(5).text("确认");
									$("#"+id).children('td').eq(6).text("已处理");
									$.each($("#"+id).children().find('.tab-ctr').children(),function(i,item){
										if(i==3 || i==4){
											return true;	
										}
										var oldClass = $(item).attr('class');
										$(item).attr('class',oldClass+' disabled');
										$(item).attr('onclick','');
									})
								}else{
									_alert("收件箱","改变消息状态失败");
								}
							}
						})
						$.ajax({
							url:'/bhost/del_manager',
							type:'post',
							async:false,
							data:{a0:$("input[name=se]").val(),a1:id,a2:filename,a3:type},
							success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
									_alert(0,title_value,'删除成功');
								}else{
									_alert(1,title_value,result.ErrMsg);
								}
								if(type=='Receiver'){
									load_list();
								}else{
									load_list2();
								}
							}
						});
						parent.layer.close(i);
					}
				});
			}
			else{
				$('.btn').blur();parent.layer.open({
					type:1,
					title: title_value,
					content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
					btn:['删&nbsp;&nbsp;除','取&nbsp;&nbsp;消'],
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					yes:function(i){
						
						$.ajax({
							url:'/bhost/del_manager',
							type:'post',
							async:false,
							data:{a0:$("input[name=se]").val(),a1:id,a2:filename,a3:type},
							success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
									_alert(0,title_value,'删除成功');
								}else{
									_alert(1,title_value,result.ErrMsg);
								}
								if(type=='Receiver'){
									load_list();
								}else{
									load_list2();
								}
							}
						});
						parent.layer.close(i);
					}
				});
			}
		}
		else{
			$('.btn').blur();parent.layer.open({
				type:1,
				title: title_value,
				content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
				btn:['删&nbsp;&nbsp;除','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				yes:function(i){
					$.ajax({
						url:'/bhost/del_manager',
						type:'post',
						async:false,
						data:{a0:$("input[name=se]").val(),a1:id,a2:filename,a3:type},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								_alert(0,title_value,'删除成功');
							}else{
								_alert(1,title_value,result.ErrMsg);
							}
							if(type=='Receiver'){
								load_list();
							}else{
								load_list2();
							}
						}
					});
					parent.layer.close(i);
				}
			});
		}
		
	}
	var url_str = "https://"+document.domain+':8443';
	function _cowork(bhname,pid,protoname,ip,port1,port2,sername,ifacc,se_old,ip_domain) {
		if(ip_domain!=''){
			url_str = "https://"+ip_domain+':8443';
		}
		var timestamp = new Date().getTime();
		var username1 = $("input[name=se]").val() + '@' + timestamp;
		var param_host = '{"name":"hostname","value":"127.0.0.1"}';
		var username;
		$.ajax({
			url:'/bhost/get_user_name',
			type:'post',
			async:false,
			data:{a0:$("input[name=se]").val()},
			success:function(result){
				var re_result = JSON.parse(result);
				username = re_result.info;
			}
		});	
		$.ajax({
			url:'/bhost/module_app_set_list',
			type:'post',
			async:false,
			data:{a0:$("input[name=se]").val()},
			success:function(result){
				var re_result = JSON.parse(result);
				$.each(re_result.data,function(i,item){
					if (item.ApplicationName == 'TELNET'){
						param_port = '{"name":"port","value":"'+item.ServicePort+'"}';
						ServerPort1 = item.ServicePort;
						return false;
					}else if(item.ApplicationName == 'RDP|VNC|X11'){
						param_port1 = '{"name":"port","value":"'+item.ServicePort+'"}';
						ServerPort2 = item.ServicePort;
					}
				});
			}
		});
		//获取 连接参数
		var paramStr = '';
		$.ajax({
			url:'/bhost/get_Param',
			type:'post',
			async:false,
			data:{a0:$("input[name=se]").val(),a1:bhname,a2:ip,a3:protoname,a4:sername},
			success:function(result){
				var re_result = JSON.parse(result);
				if(IEVersion() >=8  && IEVersion() <= 9){
					paramStr = '	'+re_result.ServiceName+'	'+re_result.ConnMode+'	'+re_result.ConnParam+'	'+re_result.ClientName+"	";
				}else{
					paramStr = '\\t'+re_result.ServiceName+'\\t'+re_result.ConnMode+'\\t'+re_result.ConnParam+'\\t'+re_result.ClientName;
				}
			}
		});
		if(IEVersion() >=8  && IEVersion() <= 9){
		
			$.ajax({
				url: '/bhost/get_globalstrategy',
				type: 'post',
				async: false,
				data: { a0: $("input[name=se]").val() },
				success: function (result) {
					global_data = JSON.parse(result);
					IsTunnel = global_data.IsTunnel + "";
					MapPort = global_data.MapPort;
				}
			})
			
			if(ifacc ) var  AccAPP = 'true';
			else var  AccAPP = 'false';
			var ServerPassword = parent.client_ip+':0@'+'d106f6959747';
			var rc4_ServerPassword='';
			$.ajax({
				url: '/bhost/get_rc4encode',
				type: 'post',
				async: false,
				data: { a0: $("input[name=se]").val() ,a1:ServerPassword},
				success: function (result) {
					rc4_ServerPassword = result;
				}
			})
			
			var ClientPath='';
			var ClientName = '';
			//start "" "C:\Program Files (x86)\NetSarang\Xshell 5\Xshell.exe" telnet://"b64>>K3pkcDFAemRwMUAxODE4Mzc1OlNTSEBhZA==":"1537322258882"@192.168.0.186:23
			if(protoname == "RDP" || ifacc || protoname == "VNC" || protoname == "X11"){
				var ServerPort = ServerPort2;
				cprotoname = protoname;
			}else{
				var ServerPort = ServerPort1;
				$.ajax({
					url: '/bhost/get_ClientPath',
					type: 'post',
					async: false,
					data: { a0: $("input[name=se]").val() ,a1:"SSH"},
					success: function (result) {
						result = JSON.parse(result);
						//\"ClientProgram\":\"%s\",\"ClientName\":\"%s\"
						ClientPath = result.ClientProgram;
						ClientName =  result.ClientName;
					}
				})	
				cprotoname = "TELNET";
				rc4_ServerPassword = ""+$("input[name=se]").val();
			}
			
			cmd_str = {"BHUser":bhname,"ServerUser":sername,"ServerPassword":rc4_ServerPassword,"BHIP":document.domain+ (location.port!=''?':'+location.port:''),"ServerIP":ip,"ServerPort":ServerPort,"ClientPath":ClientPath,"ClientName":ClientName,"Protocol":cprotoname,"ServerName":"","ServerNameType":"","ConnMode":"NORMAL","title":"","IsTunnel":IsTunnel,"MapPort":MapPort,"Port":port1,"screensize":"","fullscreen":"true","clip":"false","diskmap":"false","mapdisks":"","AccAPP":AccAPP,"RemoteApp":"false","SshKeyName":"","UrlIp":document.domain+ (location.port!=''?':'+location.port:''),"Sessid":$("input[name=se]").val(),"IfHiddenHostIP":"false","ifcowork":true,"LogSessionId":se_old,"MonitorPort":port2,"UserCode":'{{us}}',"UserName":username,"Ifacc":ifacc,"Pid":pid,"Param":paramStr,"CurrProtocol":protoname}
			var base64_cmd_str ='';
			
			$.ajax({
				url: '/bhost/base64_encode',
				type: 'post',
				async: false,
				data: { a0: $("input[name=se]").val() ,a1:JSON.stringify(cmd_str)},
				success: function (result) {
					base64_cmd_str = result;
				}
			})
			sesstime = new Date().getTime()
			//插入数据库数据
			$.ajax({
				url: "/bhost/insert_usbkeys",
				type:"POST",
				async:false,		
				data:{z1:sesstime,t1:"client",u1:'{{us}}',c1:base64_cmd_str,a10:"系统用户"},
				success:function(result){
					var result=JSON.parse(result);
					if(result.Result){
					}else{
						_alert(1,"系统用户",result.ErrMsg);
						return false;
					}
				}
			})
			var sesstimet = (new Date()).valueOf();
			var Url_str = 'https://'+ document.domain+ (location.port!=''?':'+location.port:'')+'/bhost';
			cmd_str = {"IEClient":true,"Sessid":$("input[name=se]").val(),"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),"sesstime":sesstime,"sesstimet":sesstimet,"Url":Url_str};
			$.ajax({
				url: '/bhost/base64_encode',
				type: 'post',
				async: false,
				data: { a0: $("input[name=se]").val() ,a1:JSON.stringify(cmd_str)},
				success: function (result) {
					base64_cmd_str = result;
				}
			})
			
			get_regedit('bhost', $("input[name=se]").val(),'',sesstimet);
			//window.location.href = 'bhost://cmd&' + base64_cmd_str;
			$('#YuFrame1').remove();
			$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
			$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_cmd_str);
			return 0;
		}
		
		
		var username0 = "";
		var Type1 = 0;
		var param_array = [];
		if(protoname == "RDP" || ifacc || protoname == "VNC" || protoname == "X11"){
			Type1 = 1;
			username0 = bhname+'@'+sername+'@'+ip+':'+port1+':'+protoname+':'+port2+'@h5:0:'+se_old+':'+'{{us}}'+':'+username;
			if(ifacc == true){
			  username0 += ':1';
			}else{
			  username0 += ':0';
			}
			param_array.push(JSON.parse(param_port1));
			var pwd_str = parent.client_ip+':0@'+'d106f6959747';
			param_password = '{"name":"password","value":"'+pwd_str+'"}';
		}else{
			username0 = '{{us}}'+'@'+username+'@'+pid+':'+protoname+'@ad';
			param_array.push(JSON.parse(param_port));
			param_password = '{"name":"password","value":"'+$("input[name=se]").val()+'"}';
		}
		
		if(protoname == "SSH" || protoname == "TELNET" || protoname == "RLOGIN"){
		}else{
			username0 += paramStr;
		}
		var param_username = '{"name":"username","value":"'+username0+'"}';
		param_array.push(JSON.parse(param_host));
		param_array.push(JSON.parse(param_username));
		param_array.push(JSON.parse(param_password));
		var pwd = $("input[name=se]").val();
		$.ajax({
			url: "/bhost/get_token_remote_Monitor",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:url_str,a2:bhname,a3:pid,a4:protoname,a5:username1,a6:pwd,a7:JSON.stringify(param_array),a8:1,a9:Type1},
			success:function(result){
				var result=JSON.parse(result);
				$.ajax({
					url: "/bhost/RealIPGet",
					type: "POST",
					async: false,
					data: { a0: $("input[name=se]").val(), a1: document.domain},
					success: function (result) {
						var result = JSON.parse(result);
						if(result.result == true){
							if(result.dev_type == "gluster"){
								document_domain = result.info;
							}else{
								document_domain = document.domain;
							}
						}else{
							document_domain = document.domain;
						}
					}
				})
				var url_addr = 'https://'+(ip_domain==''?document_domain:ip_domain)+':8443/bhremote/?token='+result.authToken;
				window.open(url_addr);
			}
		});
	}
	//  1-->接收;  2-->同意；  3-->拒绝；
	function change_status(type,id,sesId,msgtype,senderid){
		// jsondata = {
		// 	"MessageId": 0,
		// 	"MessageType": 12,
		// 	"Title": "改密计划[改密计划4]邮件查收确认通知",
		// 	"SenderId": 30,
		// 	"Sender": admin,
		// 	"ReceiverId": 1,
		// 	"Receiver": admin1,
		// 	"Content": "改密计划[改密计划4]已生成预备改密文件并发送邮件给密码管理员[administrator,test3],请查收邮件并在此进行确认",
		// 	"CreateTime": "2017-05-27 15:13:35.693532",
		// 	"ReceiveTime": "2017-05-27 15:18:35.693532",
		// 	"Status": 2,
		// 	"ProcessStatus": 0,
		// 	"SessionId": 123
		// }
		var _onclick = function(){
			_run = setTimeout(function(){
				var jsondata = {};
					switch(type){
						case 0:
							jsondata.MessageId = id;
							jsondata.ProcessStatus = 0;
							jsondata.Status = 0;
							jsondata.ReceiveTime = getNowFormatDate();
							msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
							$.ajax({
								url: "/bhost/save_receive_msg",
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
								success:function(result){
									var result = JSON.parse(result);
									if(result.Result == true){
									/*	$.each($("#"+id).children('td'),function(i,item){
											$(item).children().attr('style',"width:200px;");
										})
										$("#"+id).children('td').eq(4).text("");*/
										$("#"+id).attr('onclick',"");
									}else{
										_alert("收件箱","改变消息状态失败");
									}
								}
							})
							break;
						case 1:
							jsondata.MessageId = id;
							jsondata.ProcessStatus = 2;
							jsondata.Status = 3;
							var massage_type_title=$("#"+id).children('td').eq(2).attr('title');
							var massage_success=1;
							if (massage_type_title=='自动改密'){
								var massage_value=$("#"+id).children('td').eq(3).attr('title');
								if(massage_value.indexOf('失败')>=0){
									massage_success=0;
								}
							}
							msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
							$.ajax({
								url: "/bhost/save_receive_msg",
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr,a10:massage_success},
								success:function(result){
									var result = JSON.parse(result);
									if(result.Result == true){
										$("#"+id).children('td').eq(5).text("确认");
										$("#"+id).children('td').eq(6).text("已处理");
										$.each($("#"+id).children().find('.tab-ctr').children(),function(i,item){
											if(i==3 || i==4){
												return true;	
											}
											var oldClass = $(item).attr('class');
											$(item).attr('class',oldClass+' disabled');
											$(item).attr('onclick','');
										})
									}else{
										_alert("收件箱","改变消息状态失败");
									}
								}
							})
							break;
						case 2:
							jsondata.MessageId = id;
							jsondata.ProcessStatus = 2;
							jsondata.Status = 5;
							jsondata.SessionId = sesId
							msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
							$.ajax({
								url: "/bhost/save_receive_msg",
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
								success:function(result){
									var result = JSON.parse(result);
									if(result.Result == true){
										$("#"+id).children('td').eq(5).text("同意");
										$("#"+id).children('td').eq(6).text("已处理");
										$.each($("#"+id).children().find('.tab-ctr').children(),function(i,item){
											if(i==3||i==4){
												return true;
											}
											var oldClass = $(item).attr('class');
											$(item).attr('class',oldClass+' disabled');
											$(item).attr('onclick','');
										})
									}else{
										_alert("收件箱","改变消息状态失败");
									}
								}
							})
							if(msgtype == "协同邀请"){
								var ip_domain='';
								$.ajax({
									url: "/bhost/getSesMsg",
									type:"POST",
									async:false,
									data:{a0:$("input[name=se]").val(),a1:sesId},
									success:function(result){
										var result = JSON.parse(result);
										if(result.Result == true){
											result_tmp = result.info;
											ifacc = false;
											if(result_tmp.str32_28.indexOf('acc') != -1){
												ifacc = true;
											}
											var getdomainpass=true;
											$.ajax({
												url: "/bhost/getdomain",
												type:"POST",
												async:false,
												data:{a0:$("input[name=se]").val(),a1:result_tmp.int32_15},
												success:function(result){
													var result = JSON.parse(result);
													if(result.Result == true){
														if(result.ip!=''){
															ip_domain=result.ip
														}
													}else{
														_alert(1,"协同邀请",result.ErrMsg);
														getdomainpass=false;
														return false;
													}
												}
											});
											if (!getdomainpass){
												return false;
											}
											_cowork(result_tmp.str32_22,result_tmp.int32_14,result_tmp.int32_01,result_tmp.ip_01,result_tmp.int16_01,result_tmp.int16_02,result_tmp.str32_00,ifacc,result_tmp.xtime_03,ip_domain);
										}else{
											_alert(1,"收件箱","获取会话状态失败");
										}
									}
								})
							}
							else if(msgtype == "下载审批"){
								$.ajax({
									url: "/bhost/pwdChange_time",
									type:"POST",
									async:false,
									data:{a0:$("input[name=se]").val(),a1:senderid,a2:id},
									success:function(result){
										
									}
								})

							}
							break;
						case 3:
							jsondata.MessageId = id;
							jsondata.ProcessStatus = 2;
							jsondata.Status = 6;
							msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
							$.ajax({
								url: "/bhost/save_receive_msg",
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
								success:function(result){
									var result = JSON.parse(result);
									if(result.Result == true){
										$("#"+id).children('td').eq(6).text("拒绝");
										$("#"+id).children('td').eq(5).text("已处理");
										$.each($("#"+id).children().find('.tab-ctr').children(),function(i,item){
											if(i==3 || i==4){
												return true;
											}
											var oldClass = $(item).attr('class');
											$(item).attr('class',oldClass+' disabled');
											$(item).attr('onclick','');
										})
									}else{
										_alert("收件箱","改变消息状态失败");
									}
								}
							})
							break;
					}
				load_list();
				$(".tab-moreinfo.tab-moreinfo-on").remove();
			},10);	
		}
		_onclick();
	}
	//0-->已读;
	function change_status1(type,id){
		var _onclick = function(){
			_run = setTimeout(function(){
				var jsondata = {};
					switch(type){
						case 0:
							jsondata.MessageId = id;
							jsondata.ProcessStatus = 0;
							jsondata.Status = 0;
							jsondata.ReceiveTime = getNowFormatDate();
							msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
							$.ajax({
								url: "/bhost/save_receive_msg",
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
								success:function(result){
									var result = JSON.parse(result);
									if(result.Result == true){
										$.each($("#"+id).children('td'),function(i,item){
											if(i == 0 || i == 7){
												return true;
											}
											$(item).children().attr('style',"width:200px;");
										})
										/*$("#"+id).children('td').eq(4).text("");*/
										$("#"+id).attr('onclick',"");
										load_list();
									}else{
										_alert("收件箱","改变消息状态失败");
									}
								}
							})
							break;
					}
				$(".tab-moreinfo.tab-moreinfo-on").remove();
			},1);	
		}
		_onclick();
	}


	function msg_filter(obj){
		var type = $("#filter_select").val();
		if(type == '-1'){
			msg_status = 'null';
			msg_processtatus = 'null';
		}else if(type == '1'){//未处理
			msg_status = 'null';
			msg_processtatus = '0';
		}else if(type == '2'){//未读
			msg_status = '2';
			msg_processtatus = 'null';			
		}
		load_list();
	}

	//check显示
	function check_show(){
		$(">tr","#msg_list").each(function(){
			var input = $(this).find("input[type='checkbox']:enabled");
			var check_id = $(this).attr('id');
			if ($.inArray(check_id,delete_id)>=0){
				$(input).iCheck('check');
			}
		});
	}
	function check_show2(){
		$(">tr","#msg_list2").each(function(){
			var input = $(this).find("input[type='checkbox']:enabled");
			var check_id = $(this).attr('id').slice(4);
			if ($.inArray(check_id,delete_id2)>=0){
				$(input).iCheck('check');
			}
		});
	}
	//input回车触发事件
	function showMsg(){
		delect_save();
		var cur = $("#msg_page").val();
		var totalpage = $("#totalpage")[0].textContent;
		if (parseInt(cur) < 1 || cur == ""){
			$("#msg_page").val(1);
			paging = 1;
		}else if(parseInt(cur) > parseInt(totalpage)){
			paging = totalpage;
		}else{
			paging = cur;
		}
		load_list();
	}
	var msg_array_arr=null;
	function update_array(){
		// var paging = 1;
		$.ajax({
			url:'/bhost/get_msg_list',
			type:'post',
			async:false,
			data:{a0:$("input[name=se]").val(),a1:'null',a2:USERACCOUNT,a3:'null',a4:'null',a5:'null',a6:'null',},
			success:function(result){
				var msg_result = JSON.parse(result);
				if (msg_result.Result){
					var msg_data = msg_result.info;
					msg_array = msg_data.data;
					msg_array_arr=msg_data.data;
					var delete_id_old=delete_id;
					delete_id=new Array();
					var msg_array_new=new Array();
					$.each(msg_array,function (i,item) {
						if($.inArray(item.MessageId+'',delete_id_old)>=0){
							delete_id.push(item.MessageId+'');
						}
						if(item.Status==1|| item.ProcessStatus==0){
							
						}else
							msg_array_new.push(item.MessageId+'');
						
						//msg_array_new.push(item.MessageId+'');
					});
					msg_array=msg_array_new;
				}
			}
		})
	}
	function msg_back(){
		$("#detail").show();
		$("#msg_manage_1").hide();
		$('#msg_manage_2').hide();

		$('#msg_manage_4').hide();
		$('#msg_manage_5').hide();
		$('#msg_manage_6').hide();		
	}
	//选中字段存储
	function select_save(){
		$(">tr","#msg_list").each(function(){
			var input  = $(this).find("input[type='checkbox']");
			var select_item_pass =1;
			var select_str_s=select_str.split(",");
			if($(input).is(':checked')){
				var select_item=$(">td",this).eq(1).text();
				$.each(select_str_s,function(i,item){
					if(item==select_item){
						select_item_pass=0;
						return false;
					}
				});
				if(select_item_pass==1){
					select_str=select_str+select_item+",";
				}
			}else{
				var select_item=$(">td",this).eq(1).text();
				select_str="";
				$.each(select_str_s,function(i,item){
					if(item!=select_item && item!=""){
						select_str=select_str+item+",";
					}
				});
			}
		});
	}
	/*
	//check显示
	function check_show(){
		$(">tr","#msg_list").each(function(){
			var input=$(this).find("input[type='checkbox']");
			var select_str_s=select_str.split(",");
			var check_id=$(">td",this).eq(1).text();
			$.each(select_str_s,function(i,item){
				if(item==check_id){
					$(input).iCheck('check');
					return false;
				}
			});
		});
	}
	*/
	//分页刷新
	function msg_page(num){
		delect_save();
		var paging_n = parseInt(paging) + num;
		if(paging_n == 0 || paging_n == fenye+1){
			return false;
		}

		select_save();
		var msg_list_s = [];
		if (num == 0.1){
			paging_n = 1;
		}else if(num == 0.9){
			paging_n = fenye;
		}
		document.getElementById("msg_page").value=paging_n;
		paging = paging_n;
		load_list();
	}
	//全选按钮
	function select_all(){
		var select_array = select_str.split(',');
		if(select_array[select_array.length-1] == ""){
			select_array.splice(select_array.length-1,1);
		}
		if(select_array.length == msg_array.length){
			select_str = '';
		}else{
			$.each(msg_array,function(i,item){
				select_str=select_str+item.MessageId+',';
			});
		}
		load_list();
	}
	//刷新
	function refresh(){
		msg_page(0);
		$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
		$("#check_page").iCheck('uncheck');
		select_str="";
		check_num=0;
		$("#select_total")[0].textContent = 0;
	}
</script>
<!-- msg2 -->
<script>
	// var USERACCOUNT = "{{us}}";	//登录账号（接收信息者账号）
	// var page_num;								//每页显示数
	// var paging;									//页数
	// var Total_all;
	// var msg_processtatus;
	// var msg_status;
	// var fenye;
	// var select_str = "";
	// var check_num = 0;
	// var msg_array = null;
	var msg_receiver;
	function show_msg_list2(){
		msg_receiver = 'null';
		msg_status = 'null';
		msg_processtatus = 'null';
		paging = 1;
		page_num = MAX_PAGE;
		load_list2();
		$("#msg_page2").bind('keydown', function(e){
			DigitInput(e);
		});
		$('#msg_type').select2({minimumResultsForSearch: -1});
		$('#receiverSelect').select2({minimumResultsForSearch: -1});
		getReceiver();
		delete_id2=new Array();
		 $('#check_page2').on('ifClicked',function(e){
		 	if(!$('#check_page2').prop('checked')){
		 		$("#m_list2").children('tbody').find('input[type=checkbox]:enabled').iCheck('check');
		 	}else{
		 		$("#m_list2").children('tbody').find('input[type=checkbox]:enabled').iCheck('uncheck');
		 	}
		 });
		 $("#msg_list2").on("ifChecked",function(e){
		 	check_num++;
		 	$("#select_total2").text(check_num);	
		 	if($("#msg_list2").find("input:checked:enabled").length==$("#msg_list2 tr").find("input.input_checkbox:enabled").length){
		 		$('#check_page2').iCheck('check');
		 	}
		 }).on("ifUnchecked",function(e){
		 	check_num--;
		 	$("#select_total2").text(check_num);	
		 	$('#check_page2').iCheck('uncheck');	
		 });
		parent._switchBtn(1);//显示按钮
	}
	function clear_code_suspend(){
		$('#code_name').val('');
	}
	function get_code_dialog(item_id){
		clear_code_suspend();
		title='验证码';
		var $dialogCont = $("#code_suspend").show();

		var d = dialog({
			title: title,
			content: $dialogCont,
			id: "code_suspend",
			width: "450px"
		});
		function addEventListener(ele,event,fn){
			if(ele.addEventListener){
				ele.addEventListener(event,fn,false);
			}else{
				ele.attachEvent('on'+event,fn.bind(ele));
			}
		}
		addEventListener(d,'close',function () {
		   $dialogCont.appendTo("body").hide();
		});
		d.showModal();	
		$("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
			clear_code_suspend();
		});
		$("a.btn-submit", $dialogCont).unbind().bind("click", function () {
			var code_value=$('#code_name').val().trim();
			if(code_value==''){
				_alert(2,'验证码','请输入验证码',$('#code_name'));
				return false;
			}else{
				code_value_num=code_value.replace(/\D/g, "").trim();
				if(code_value_num.length!=code_value.length){
					_alert(2,'验证码','验证码格式不正确',$('#code_name'));
					return false;
				}else if(code_value.length!=6){
					_alert(2,'验证码','验证码长度为6',$('#code_name'));
					return false;	
				}
			}
			if(judge_code(item_id,code_value)){
				$('.btn').blur(); parent.layer.open({
					type: 1,
					title: title,
					content: '<div class="layer-alert"><i class="alert succ"></i>验证成功</div>',
					btn: ['确&nbsp;&nbsp;定'],
					btnAlign: 'c',
					closeBtn: false,
					skin: 'layer-custom',
					area: ['380px', '310px'],
					move: false,
					resize: false,
					yes: function (i) {
						load_list2();
						parent.layer.close(i);
						d.close().remove();
					}
				});			
			}
		});
	}
	function judge_code(item_id,code_value){
		var pass;
		$.ajax({
			url: "/bhost/judge_code",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:item_id,a2:code_value},
			success:function(result){
				var result=JSON.parse(result);
				if(!result.Result){
					if(result.ErrMsg=='验证码错误'){
						_alert(1,'验证码',result.ErrMsg,$('#code_name'));
					}else{
						_alert(1,'验证码',result.ErrMsg);
					}
					pass=false;
					return false;	
				}else{
					pass=true;
					return true;
				}
			}
		});
		return pass;		
	}
	function load_list2(){
		update_array2();
		$.ajax({
			url: "/bhost/get_msg_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),a1:USERACCOUNT,a2:msg_receiver,a3:msg_status,a4:msg_processtatus,a5:page_num,a6:paging},
			success:function(result){
				var msg_result = JSON.parse(result);
				if (msg_result.Result==true){
					var msg_data = msg_result.info;
					var total_all = msg_data.totalrow;
					if(msg_data.data=="" && paging!="1"){
						msg_page(-1);
					}else{
						total = 0;
						Total_all = total_all;
						if(Total_all){
							$("#msg_list2").empty();
								$.each(msg_data.data,function(i,item){
									if (total<page_num){
										total++;
										var str_tmp = "";
										var flag_unread = 0;
										var verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
										switch(item.MessageType){
											case 1:
												item.MessageType = "访问审批";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2" id="" onclick="get_code_dialog('+item.MessageId+');"></a>';
												break;
											case 2:
												item.MessageType = "指令审批";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2" id="" onclick="get_code_dialog('+item.MessageId+');"></a>';
												break;
											case 3:
												item.MessageType = "协同邀请";
												break;
											case 4:
												item.MessageType = "工作下发";
												break;
											case 5:
												item.MessageType = "通知";
												break;
											case 6:
												item.MessageType = "批处理审批";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2" id="" onclick="get_code_dialog('+item.MessageId+');"></a>';
												break;
											case 7:
												item.MessageType = "自动改密";
												break;
											case 8:
												item.MessageType = "改密审批";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2" id="" onclick="get_code_dialog('+item.MessageId+');"></a>';
												break;
											case 9:
												item.MessageType = "工单下发";
												break;
											case 10:
												item.MessageType = "申请";
												break;
											case 11:
												item.MessageType = "工单申请";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2" id="" onclick="get_code_dialog('+item.MessageId+');"></a>';
												break;
											case 12:
												item.MessageType = "自动改密";
												break;
											case 13:
												item.MessageType = "下载审批";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2" id="" onclick="get_code_dialog('+item.MessageId+');"></a>';
												break;												
										}
										var del_str='';
										switch(item.Status){
											case 0:
												item.Status = "";
												//del_str='<a href=\"javascript:;\" title=\"删除\" class=\"del disabled\" id=\"\" onclick=\"\"></a>';
												break;	//0-->未处理
											case 1:
												item.Status = "未发送";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
												break;
											case 2:
												item.Status = "";
												flag_unread = 1;
												//del_str='<a href=\"javascript:;\" title=\"删除\" class=\"del disabled\" id=\"\" onclick=\"\"></a>';
												break;	//2-->未读
											case 3:
												item.Status = "确认";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
												break;
											// case 4:
											// 	item.Status = "已过期";
											// 	break;
											case 5:
												item.Status = "同意";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
												break;
											case 6:
												item.Status = "拒绝";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
												break;												
										}
										switch(item.ProcessStatus){
											case 0:
												item.ProcessStatus = "未处理";
												del_str='<a href=\"javascript:;\" title=\"删除\" class=\"del disabled\" id=\"\" onclick=\"\"></a>';
												break;
											// case 1:
											// 	item.ProcessStatus = "";
											// 	break;
											case 2:
												item.ProcessStatus = "未确认";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
												del_str='<a href=\"javascript:;\" title=\"删除\" class=\"del disabled\" id=\"\" onclick=\"\"></a>';
												break;
											case 3:
												item.ProcessStatus = "已过期";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
												break;												
											case 4:
												item.ProcessStatus = "已确认";
												verification_str='<a href="javascript:;" title = "验证码" class="msg2 disabled" id=""></a>';
												break;																							
										}
										if (item.MobilePhone!='' && item.MobilePhone!=null){
											item.MobilePhone=item.MobilePhone;
										}else{
											item.MobilePhone='';
										}
										if (item.Email!='' && item.Email!=null){
											item.Email=item.Email;
										}else{
											item.Email='';
										}
										var MobilePhone_Email='<p>&nbsp;&nbsp;&nbsp;&nbsp;联系方式：'
										if(item.MobilePhone!=''){
											MobilePhone_Email=MobilePhone_Email+item.MobilePhone;
											if(item.Email!=''){
												MobilePhone_Email=MobilePhone_Email+'，'+item.Email;
											}
										}else{
											if(item.Email!=''){
												MobilePhone_Email=MobilePhone_Email+item.Email;
											}
										}
										var input_checkbox='';
										if (del_str=='' || item.Receiver==null || item.Receiver=='') {
											del_str="<a href=\"javascript:;\" title=\"删除\" class=\"del\" id=\"del\" onclick=\"del_manager("+item.MessageId+",'"+item.PwdFileName+"','Sender',this)\"></a>";
											input_checkbox='<td><input type=\"checkbox\" class=\"input_checkbox\" /></td>';
										}else{
											input_checkbox='<td><input type=\"checkbox\" class=\"input_checkbox\" disabled /></td>';
										}
										if(item.MessageType=='工作下发' || item.MessageType=='通知' || item.MessageType=='申请'){
											input_checkbox='<td><input type=\"checkbox\" class=\"input_checkbox\" /></td>';
											del_str="<a href=\"javascript:;\" title=\"删除\" class=\"del\" id=\"del\" onclick=\"del_manager("+item.MessageId+",'"+item.PwdFileName+"','Sender',this)\"></a>";
										}
										item.Title = item.Title.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&apos;");
										item.Content = item.Content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&apos;").replace(/\r\n/g, "<p>&nbsp;&nbsp;&nbsp;&nbsp;");
										var float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content+MobilePhone_Email;
										if(item.MessageType=='自动改密'){
											float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
										}else if(item.MessageType=='通知'){
											if(item.Title=='告警通知' && item.SenderId==1 && item.Sender.split('(')[0]=='admin'){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('改密计划')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('指令授权')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('工单授权')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
											if(item.Title.indexOf('访问授权')==0){
												float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content;
											}
										}else{
											float_str = "<p style=\"font-weight:bold;\">详情："+"<p>&nbsp;&nbsp;&nbsp;&nbsp;"+item.Content+MobilePhone_Email;
										}
										
										if(flag_unread == 1 || item.ProcessStatus == "未处理" && item.ProcessStatus != "已过期"){//加黑  1-->disabled
											$("#msg_list2").append("<tr id=msg2"+item.MessageId+">"+
												input_checkbox+
												"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.CreateTime+"</td>"+
												"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.MessageType+"</td>"+
												"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Title+"</td>"+
												"<td title="+(item.Receiver||'')+"><span title=\""+(item.Receiver||'')+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+(item.Receiver||'')+"</td>"+
												"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.Status+"</td>"+
												"<td title="+item.ProcessStatus+"><span title=\""+item.ProcessStatus+"\" style=\"width:200px; color: black; font-weight: bolder;\">"+item.ProcessStatus+"</td>"+	
												"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\">"+
												"<a href=\"javascript:;\" title = \"标记为已确认\" class=\"msg1 disabled\" id=\"Mark\"></a>"+
												verification_str+
												del_str+
												"</div>"+
												"<a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a>"+
												"<div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
										}else{
											if(item.ProcessStatus != "已过期" && item.ProcessStatus == "未确认"){
												$("#msg_list2").append("<tr id=msg2"+item.MessageId+">"+
													//"<td style = \"display:none\">"+item.MessageId+"</td>"+
													input_checkbox+
													"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px;\">"+item.CreateTime+"</td>"+
													"<td style = \"display:none\">"+item.MessageId+"</td>"+
													"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px;\">"+item.MessageType+"</td>"+
													"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px;\">"+item.Title+"</td>"+
													"<td title="+(item.Receiver||'')+"><span title=\""+(item.Receiver||'')+"\" style=\"width:200px;\">"+(item.Receiver||'')+"</td>"+
													"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px;\">"+item.Status+"</td>"+
													"<td title="+item.ProcessStatus+"><span title=\""+item.ProcessStatus+"\" style=\"width:200px;\">"+item.ProcessStatus+"</td>"+	
													"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\">"+
													"<a href=\"javascript:;\" title = \"标记为已确认\" class=\"msg1\" id=\"Mark\" onclick=\"mark("+item.MessageId+")\"></a>"+
													verification_str+
													del_str+
													"</div>"+
													"<a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a>"+
													"<div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
											}else{//按钮disabled
												$("#msg_list2").append("<tr id=msg2"+item.MessageId+">"+
													input_checkbox+
													//"<td style = \"display:none\">"+item.MessageId+"</td>"+
													"<td title="+item.CreateTime+"><span title=\""+item.CreateTime+"\" style=\"width:200px;\">"+item.CreateTime+"</td>"+
													"<td style = \"display:none\">"+item.MessageId+"</td>"+
													"<td title="+item.MessageType+"><span title=\""+item.MessageType+"\" style=\"width:200px;\">"+item.MessageType+"</td>"+
													"<td title="+item.Title+"><span title=\""+item.Title+"\" style=\"width:200px;\">"+item.Title+"</td>"+
													"<td title="+(item.Receiver||'')+"><span title=\""+(item.Receiver||'')+"\" style=\"width:200px;\">"+(item.Receiver||'')+"</td>"+
													"<td title="+item.Status+"><span title=\""+item.Status+"\" style=\"width:200px;\">"+item.Status+"</td>"+
													"<td title="+item.ProcessStatus+"><span title=\""+item.ProcessStatus+"\" style=\"width:200px;\">"+item.ProcessStatus+"</td>"+	
													"<td id=\"on\" class=\"last_td\"><div class=\"tab-ctr\" id=\"tab\">"+
													"<a href=\"javascript:;\" title = \"标记为已确认\" class=\"msg1 disabled\" id=\"Mark\"></a>"+
													verification_str+
													del_str+
													"</div>"+
													"<a style=\"display:none;\" href=\"javascript:;\" class=\"arr tab-arr\"></a>"+
													"<div class=\"tab-moreinfo\">" + float_str + "</div></td></tr>");
											}
										}
									}
								})
							tabArr();
							$(".input_checkbox","#msg_list2").iCheck({
								checkboxClass: 'icheckbox_minimal-blue',
								radioClass: 'iradio_minimal-blue',
								increaseArea: '0' // optional
							});
							
							$("#msg_total2").text(total_all);
							if(Total_all % page_num == 0){
								fenye = parseInt(Total_all/page_num);
							}else{
								fenye = parseInt(Total_all/page_num+1);
							}
							if(paging >= fenye){
								paging = fenye;
							}
							$("#msg_page2").val(paging);
							$("#totalpage2").text(fenye);
							$('#check_page2').iCheck('uncheck');
							$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
							var select_str_s=select_str.split(",");
							check_num=select_str_s.length-1;
							check_show2();
						}
						else{
							$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
							$("#msg_list2").empty();
							$("#msg_total2").text(total_all);
							$("#totalpage2").text(1);
							document.getElementById("msg_page2").value=1;
						}	
					}
				}else{
					_alert(1,"消息查询",user_result.info);
					$("table tbody tr").children("td.in").children("div").children("input").iCheck('uncheck');
					$("#msg_total2").text(0);
					$("#totalpage2").text(1);
					document.getElementById("msg_page2").value=1;
					return false;
				}
			}
		});
		
	}

	function mark(id){
		// jsondata = {
		// 	"MessageId": 0,
		// 	"MessageType": 12,
		// 	"Title": "改密计划[改密计划4]邮件查收确认通知",
		// 	"SenderId": 30,
		// 	"Sender": admin,
		// 	"ReceiverId": 1,
		// 	"Receiver": admin1,
		// 	"Content": "改密计划[改密计划4]已生成预备改密文件并发送邮件给密码管理员[administrator,test3],请查收邮件并在此进行确认",
		// 	"CreateTime": "2017-05-27 15:13:35.693532",
		// 	"ReceiveTime": "2017-05-27 15:18:35.693532",
		// 	"Status": 2,
		// 	"ProcessStatus": 0,
		// 	"SessionId": 123
		// }
		var _onclick = function(){
			_run = setTimeout(function(){
				var jsondata = {};
				jsondata.MessageId = id;
				// jsondata.ProcessStatus = 1;
				jsondata.ProcessStatus = 4;
				msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
				$.ajax({
					url: "/bhost/save_receive_msg",
					type:"POST",
					async:false,
					data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
					success:function(result){
						var result = JSON.parse(result);
						if(result.Result == true){
						/*	$.each($("#msg2"+id).children('td'),function(i,item){
								$(item).children().attr('style',"width:200px;");
							})*/
							$("#msg2"+id).children('td').eq(6).text("已确认");
							$.each($("#msg2"+id).children().find('.tab-ctr').children(),function(i,item){
								var oldClass = $(item).attr('class');
								$(item).attr('class',oldClass+' disabled');
								$(item).attr('onclick','');
							})
							msg_page2(0);
						}else{
							_alert(1,"收件箱","改变消息状态失败");
						}
					}
				})
				$(".tab-moreinfo.tab-moreinfo-on").remove();
			},0);
		}
		_onclick();
	}
	//input回车触发事件
	function showMsg2(){
		delect_save2();
		var cur = $("#msg_page2").val();
		var totalpage = $("#totalpage2")[0].textContent;
		if (parseInt(cur) < 1 || cur == ""){
			$("#msg_page2").val(1);
			paging = 1;
		}else if(parseInt(cur) > parseInt(totalpage)){
			paging = totalpage;
		}else{
			paging = cur;
		}
		load_list2();
	}
	var msg_array2=null;
	var msg_array_arr2=null;
	function update_array2(){
		var paging = 1;
		$.ajax({
			url:'/bhost/get_msg_list',
			type:'post',
			async:false,
			data:{a0:$("input[name=se]").val(),a1:USERACCOUNT,a2:'null',a3:'null',a4:'null',a5:'null',a6:'null',},
			success:function(result){
				var msg_result = JSON.parse(result);
				if (msg_result.Result){
					var msg_data = msg_result.info;
					msg_array2 = msg_data.data;
					msg_array_arr2=msg_data.data;
					var delete_id_old2=delete_id2;
					delete_id2=new Array();
					var msg_array_new=new Array();
					$.each(msg_array2,function (i,item) {
						if($.inArray(item.MessageId+'',delete_id_old2)>=0){
							delete_id2.push(item.MessageId+'');
						}
						if((item.ProcessStatus==0 || item.ProcessStatus==2) && (item.MessageType!=4 && item.MessageType!=5 && item.MessageType!=10)){
						
						}else
							msg_array_new.push(item.MessageId+'');
					});
					msg_array2=msg_array_new;
				}
			}
		})
	}
	//分页刷新
	function msg_page2(num){
		delect_save2();
		var paging_n = parseInt(paging) + num;
		if(paging_n == 0 || paging_n == fenye+1){
			return false;
		}
		var msg_list_s = [];
		if (num == 0.1){
			paging_n = 1;
		}else if(num == 0.9){
			paging_n = fenye;
		}
		document.getElementById("msg_page2").value=paging_n;
		paging = paging_n;
		load_list2();
	}
	//刷新
	function refresh2(){
		msg_page2(0);
		select_str="";
		check_num=0;
		//$("#select_total2")[0].textContent = 0;
	}
	function createMsg(){
		var $dialogCont = $("#scDCTab1").show();
		clear_createMsg();
		var title = '新建消息';
		var d = dialog({
			title:title,
			content:$dialogCont,
			id:"scDCTab1",
			width:"850px"
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d.showModal();
		$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
			clear_createMsg();
		});
		$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
			save_msg(d);
		});
	}
	function clear_createMsg(){
		$("#msg_type").val('4').trigger('change');
		$("#title").val("");
		$("#receiverSelect").val('-1').trigger('change');
		$("#receiver_all").find('.item').remove();
		$("#content").val("");
	}

	var Title;
	var Content;
	var Receivers = [];
	var MessageType;
	var Title;
	var SenderId;
	var Sender;
	var ReceiverId;
	var Receiver;
	var Content;
	var ProcessStatus;
	function save_msg(d){
		Receivers = [];
		Title = $("#title").val();
		if(Title == ""){
			_alert(2,"新建消息","请输入概要")
			return false;
		}
		$.each($("#receiver_all").children('li'),function(i,item){
			if(i == 0){
				if($("#receiverSelect").val() == '-1'){
					return true;
				}else{
					Receivers.push($("#receiverSelect").val());
				}
			}else{
				var re_id = $(item).attr('id');
				Receivers.push(re_id);
			}
		})
		if(Receivers.length == 0){
			_alert(2,"新建消息","请加入接收者")
			return false;
		}		
		MessageType = $("#msg_type").val();
		Content = $("#content").val();
		if(Content == ""){
			_alert(2,"新建消息","请输入内容")
			return false;
		}
		SenderId = u_id;
		Sender = USERACCOUNT;
		save_msg_function(d);
	}
	var finishNum;
	var time;
	function save_msg_function(d){
		finishNum = 0;
		var ReceiverId;
		_do = function () {
			if(finishNum < Receivers.length){
				ReceiverId = Receivers[finishNum];
				$.each(all_receiver_data,function(i,item){
					if(item.UserId == ReceiverId){
						Receiver = item.UserCode;
						return false;
					}
				})
			}else{	//发送结束
				_alert(0,"新建消息","发送成功");
				d.close().remove();
				switch_page(2);
				clearTimeout(time);
				return false;
			}
			var jsondata = {};
			jsondata.MessageId = 0;
			jsondata.MessageType = MessageType;
			jsondata.Title = Title;
			jsondata.SenderId = SenderId;
			jsondata.Sender = Sender;
			jsondata.ReceiverId = ReceiverId;
			jsondata.Receiver = Receiver;
			jsondata.Content = Content.replace(/\n/g, "\r\n");
			jsondata.Status = 2;
			jsondata.ProcessStatus = 0;
			msstr = aceg(JSON.stringify(jsondata),$("input[name=se]").val());
			$.ajax({
				url: "/bhost/save_receive_msg",
				type:"POST",
				async:false,
				data:{a0:$("input[name=se]").val(),a1:JSON.stringify(jsondata),m1:msstr},
				success:function(result){
					clearTimeout(time);
					var ugroup_result = JSON.parse(result);
					finishNum++;
					time = setTimeout(function(){_do();},1);
					if(ugroup_result.Result == false){
						//_alert(1,"新建消息","消息发送失败");
					}else{
						//_alert(0,"新建消息","消息发送成功");
					}
				}
			})
		}
		_do();
	}

	var re_data;
	var r_data_all = [];
	var re_arry = ['-1'];
	var all_receiver_data;
	function getReceiver(){
		$.ajax({
			url: "/bhost/get_user_list",
			type:"POST",
			async:false,
			data:{a0:$("input[name=se]").val(),d1:true},
			success:function(result){
				var re_data = JSON.parse(result);
				all_receiver_data = re_data.info;
				if(re_data.Result == true){
					$("#receiverSelect").empty().append('<option value="-1">请选择</option>');
					$.each(re_data.info, function (i, item) {
						if(item.UserId != u_id && item.UserCode != 'admin'){
							$("#receiverSelect").append('<option value="' + item.UserId + '">' + item.UserCode + '</option>');
							r_data_all.push(item.UserId);
						}
					});
				}else{
					_alert(1,'发件箱','获取接收用户失败');
				}
			}
		})
		$('#receiverSelect').select2();
	}
	function _del_re(obj, type) {
		var $c = $(obj).parent();
		var id = $c.attr('id');
		var t = $(obj).siblings('input').val();
		var v, data, max;
		var min = 0;

		max = r_data_all.length - 1;
		data = r_data_all;
		$("#receiverSelect").parent().show();
		re_arry.splice($.inArray(id, re_arry), 1);
		$p = $("#receiverSelect");

		$c.remove();
		//var index = search_index(min,max,id,data);
		if (max < 0){
			var index_1 = -1;
		}else{
			var index_1 = search_i(min, max, parseInt(id), data);
		}	
		//var index_1 = search_i(min, max,id, data);
		index_1 = parseInt(index_1);
		if (index_1 == -1) {
			index_1 = max;
			$p.append('<option value="' + id + '">' + t + '</option>');
		} else if (index_1 == -2) {
			index_1 = 0;
			$p.children('option').eq(0).after('<option value="' + id + '">' + t + '</option>');
		} else {
			$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '">' + t + '</option>');
		}
		r_data_all.splice(index_1, 0, parseInt(id));
	}

	function search_i(min, max, id, data) {
		var mid, res;
		if (data[max] < id) {
			return -1;
		}
		if (data[min] > id) {
			return -2;
		}
		while (min <= max) {
			mid = parseInt((min + max) / 2);
			if (data[mid] > id) {
				max = mid - 1;
				res = mid;
			} else {
				min = mid + 1;
			}
		}
		return res;
	}
	function _add_re(obj) {
		var add = 0;
		var name2 = $(obj).parent().children('select').children('option:selected').val();
		if (name2 == undefined) {
			$(obj).parent().children('select').val('-1').trigger('change');
			return false;
		}

		var t = $(obj).parent().children('select').children('option[value=' + name2 + ']').text();
		if (name2 == -1) {
			_alert(2, "新建消息", "请选择接收用户");
			return false;
		}
		re_arry.splice(0, 0, '-1');
		r_data_all.splice($.inArray(parseInt(name2), r_data_all), 1);
		var $c = $(obj).parent();
		var d = $('select>option:first', $c).val();
		var $s = $('<li class="item" id="' + name2 + '" style="margin-top: -4px; margin-left: -16px; width:25%"><input type="text" class="form-text" id="' + name2 + '" value="' + t + '" style="width:88px;" disabled="true"><i class="ctrl del" onclick="_del_re(this,1)" style="margin-left:9px;"></i></li>');
		$c.children('select').val(d);
		$c.children('select').find('option[value=' + name2 + ']').remove();
		$c.after($s);
	}

	function change_receiver(obj){
		if (!Array.prototype.indexOf){
				Array.prototype.indexOf = function(elt /*, from*/){
				var len = this.length >>> 0;
				var from = Number(arguments[1]) || 0;
				from = (from < 0)
							? Math.ceil(from)
							: Math.floor(from);
				if (from < 0)
					from += len;
				for (; from < len; from++)
				{
					if (from in this &&
							this[from] === elt)
						return from;
				}
				return -1;
			};
		}
		var t = $(obj).children('option:selected').val();
		if (re_arry.indexOf(t) === -1 && t != undefined) {
			re_arry.splice(0, 1, t);
		}
		if ($(obj).children('option').length == 2 && t != '-1') {
			$(obj).parent().children('i.add').click();
			$(obj).parent().hide();
		}
	}
	///totp
	function submit_totp(){
		var totp_v = $("#totp_v").val();
		if (totp_v == ""){
			$(".btn").blur();
			_alert(1,"系统用户","验证码不正确",$("#totp_v"));
			return false;
		}
		$.ajax({
			url: "/bhost/test_qrcode",
			type: "POST",
			async: false,
			data: {a0:$("input[name=se]").val(),z1:totp_v,z2:secret},
			success: function (result) {
				if (result == "true"){
					$(".btn").blur();
					//_alert(0,"系统用户","验证成功");
					//$("#totp_checkbox").attr("checked",true);
					//$("#totp_checkbox").next('span').attr('class',"checkbox checked");
					repeat = 0;
					if(PwdStrategy.IfPwdUnRepeat){
						repeat = PwdStrategy.PwdUnRepeat;
					}else{
						repeat = 0;
					}
					AccessSet = {
						"UserId": 0, 
						"AccessAuthSet": [
						]
					}
					layer.open({
						type:1,
						title:"系统用户",
						content:'<div class="layer-alert"><i class="alert succ"></i>验证成功</div>',
						btn:'确&nbsp;&nbsp;定',
						btnAlign:'c',
						closeBtn: false,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						btn1:function(i){
							d_qrcode.close().remove();
							layer.close(i);
							
							$.ajax({
								url:'/bhost/update_totp_key',
								type:"POST",
								async:false,
								data:{a0:$("input[name=se]").val(),a1:user_item.UserCode,a2:secret,a10:"系统用户"},
								//contentType: 'application/json',
								success: function(Result) {								
									data = JSON.parse(Result);
									if (data.Result){								
										user_item.SecretKey = secret;
										return false;
									}
									else{
										_alert(1,"系统用户",'TOTP重置失败：'+data.ErrMsg);
									}
								}
							})
							//savedata();
						}
					});
					return false;
				}else{
					$(".btn").blur();
					_alert(1,"系统用户","验证失败",$("#totp_v"));
					return false;
				}
			}
		});
	}

	var secret;
	var d_qrcode;
	function qr_code_show(){
		var account_name = $("#sys_u_name").val();
		$.ajax({
			url: "/bhost/get_qrcode_img",
			type: "POST",
			async: true,
			data: {a0:$("input[name=se]").val(),z1:account_name},
			success: function (result) {
				var result = JSON.parse(result);
				secret = result.secret;
				$("#qr_code").find('img').attr('src',result.img+"?m="+Math.random());
			}
		});
		var $dialogCont = $("#qr_code").show();
		
		d_qrcode = dialog({
			title:"TOTP",
			content:$dialogCont,
			id:"qr_code",
			width:"368px",
		}); 
		d_qrcode.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d_qrcode.showModal();
		$("#qr_code").parents(".ui-dialog-body").css("padding","20px 0px 20px 0px");
		$("#totp_v").val('');
		//$('.ui-popup.ui-popup-modal.ui-popup-show.ui-popup-focus').css("top","65px");
	}
	
	
	var actnu = 0;
	var new_pin = "";
	var pin_success = 0;//0--not saved 1--saved success!
	function change_PIN(){
		
		$("#pin_input1").val('');
		$("#pin_input2").val('');
		$("#pin_input1_old").val('');
		
		//if(user_item.SecretKey == null) $('#pin_input1_old').parent().parent().hide();
		//else $('#pin_input1_old').parent().parent().show();
		$('#pin_input1_old').parent().parent().hide();
		var $dialogCont = $("#PINDialog").show();
		var title = 'pin设置';
		var d_change_PIN = dialog({
			title:title,
			content:$dialogCont,
			id:"PINDialog",
			width:"850px"
		});
		d_change_PIN.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		d_change_PIN.showModal();
		$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
			$("#pin_input1").val('');
			$("#pin_input2").val('');
			$("#pin_input1_old").val('');
		});
		$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
	
			if($("#pin_input1_old").val() == "" && $("#pin_input1_old").is(':visible') == true){
				_alert(1,"系统用户","请输入原pin码",$("#pin_input1_old"));
				return false;
			}
			if($("#pin_input1").val() == ""){
				_alert(1,"系统用户","请输入新pin码",$("#pin_input1"));
				return false;
			}
			if($("#pin_input1").val() != $("#pin_input2").val()){
				_alert(1,"系统用户","两次pin码不匹配",$("#pin_input1"));
				return false;			
			}
			if($("#pin_input1").attr('maxlength') > 0){
				if($("#pin_input1").val().length != parseInt($("#pin_input1").attr('maxlength'))){
					_alert(1,"系统用户","pin码长度不正确("+$("#pin_input1").attr('maxlength')+"位)",$("#pin_input1"));
					return false;
				}		
			}
			user_item.SecretKey = $("#pin_input1").val();
			new_pin = $("#pin_input1").val();
			d_change_PIN.close().remove();
		});
	}
	function client_request(cmd_json,type,UserId,sesstime,Content){
		var if_html_client = false;
		var sesstimet = (new Date()).valueOf();
		cmd_json['sesstimet']= sesstimet;
		var base64_str = '';
		$.ajax({
			url: "/bhost/get_base64",
			type:"POST",
			async:false,		
			data:{a0:$("input[name=se]").val(),z1:JSON.stringify(cmd_json)},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
					if_html_client = result.info;
					base64_str = result.b64;
				}else{
					_alert(1,"系统用户",result.ErrMsg);
				}
			}
		})
		//插入数据库数据
		$.ajax({
			url: "/bhost/insert_usbkeys",
			type:"POST",
			async:false,		
			data:{a0:$("input[name=se]").val(),z1:sesstime,t1:type,u1:$('#sys_u_name').val(),c1:Content,a10:"系统用户"},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
				}else{
					_alert(1,"系统用户",result.ErrMsg);
					return false;
				}
			}
		})
		//location.href = 'bhost://cmd&'+base64_str;
		get_regedit('bhost', $("input[name=se]").val(),'',sesstimet);
		$('#YuFrame1').remove();
		$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
		$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
		
		//循环获取 数据库状态
		_showLoading("正在设置PIN码......");
		
		
		var c = 0;
		
		if_ok_down = setInterval(function(){
			ret = repeat_get_usb_status(sesstime);
			if(ret == 1){
				clearInterval(if_ok_down);
				_closeLoading();
				layer.open({
					type:1,
					title:"系统用户",
					content:'<div class="layer-alert"><i class="alert succ"></i>修改成功</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						$("#pwd1").hide();
						$("#pwd2").hide();
						$("#pwd3").hide();
						$("#change_Pwd").show();
						$("#info").hide();
						$('#related_downloads_show').hide();
						$('#terminal_show').hide();
						$("#detail").show();
						$("#u_i").text(user_item.UserCode);
						$("#u_i").append('<img src="/manage/images/'+user_item.PhotoIcon+'" alt="">');
					}
				});
				
				
				return 0;				
			}
			if(ret == 2){
				clearInterval(if_ok_down);
				_closeLoading();
				_alert(1,"系统用户",'设置PIN码失败');
				return 0;				
			}
			if(c >=20){
				clearInterval(if_ok_down);
				_closeLoading();
				_alert(1,"系统用户",'设置PIN码超时');
				return 0;
			}		
			c = c + 1;				
		},1000)
	}
	function repeat_get_usb_status(sesstime){
		var st = 0;
		$.ajax({
			url: "/bhost/repeat_get_usb_status",
			type:"POST",
			async:false,		
			data:{a0:$("input[name=se]").val(),z1:sesstime},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
					st = result.info;
				}else{
					_alert(1,"系统用户",result.ErrMsg);
					return false;
				}
			}
		})
		return st;
	}
	var loadLayer =0;
	function _showLoading(text){
		var st = text || "请稍后......";
		loadLayer = layer.open({
			title:false,
			closeBtn:false,
			content:'<div id="Loading">'+st+'</div>',
			btn:false,
			skin:'loadingbar',
			area:['150px','180px'],
			move:false,
			resize:false,
			isOutAnim: false,
			shade:[0.1,'#000']
		})
	}

	function _closeLoading(){
	layer.close(loadLayer);
	}
	function download_default_file(id,obj){
	$.ajax({
		url: "/bhost/download_default_file",
		type: "POST",
		async: false,
		data: { a0: $("input[name=se]").val(),a1:id },
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result) {
				var sesstimet = (new Date()).valueOf();
				var referrer_arr=document.referrer.toString().split('/');
				referrer_arr.pop();
				var referrer=referrer_arr.join('/');
				var json_download = {
						"Type": "Download",
						"Url": referrer,
						"Path": '/usr/storage/.system/software/upload/',
						"Filename": result.software_name,
						"Session": $("input[name=se]").val(),
						"sesstimet":sesstimet
				}
				var if_html_client = false;
				var base64_str = '';
				$.ajax({
						url: "/bhost/get_base64",
						type:"POST",
						async:false,
						data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
						success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
										if_html_client = result.info;
										base64_str = result.b64;
								}else{
										_alert(1,"相关下载",result.ErrMsg); 
								}
						}
				})
				if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
				else{
					get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
					$('#YuFrame1').remove();
					$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
					$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
				}
			} else {
				_alert(2, '相关下载', result.ErrMsg);
				return false;
			}
		}
	})
}
</script>

<script type="text/javascript">
	var flag = false;
	var reloadOut =0;
	var xhr=0;
	var template_output = _.template('<div class="output-view"><span class="prompt"><%= separate %></span>&nbsp;<span class="output<%= error %>"><%= value %></span></div>');
	var template_output1 = _.template('<div class="output-view"><span class="prompt"><%= separate %></span><span class="output<%= error %>"><%= value %></span></div>');
	
	var cmd_cache = [];
	var cmd_pos = 0;

	var $left = $('.left');
	var $right = $('.right');
	var $cursor = $('.cursor');
	var $shell = $('.shell-view');
	var $input = $('.input');

	var str_left = '';
	var str_cursor = '';
	var str_right = '';
	var str_tmp_cursor = '';
	var flag_end = false;
	var setv = 0;
	var is_print = true;
	
	$(document.body).bind({
		paste: function(e) {//paste事件
			if($('#panel-shell').is(":hidden") == true) return 0;
			var eve = e.originalEvent
			var cp = eve.clipboardData;
			var data = null;
			var clipboardData = window.clipboardData; // IE
			if (!clipboardData) { //chrome
				clipboardData = e.originalEvent.clipboardData
			}
			data = clipboardData.getData('Text');
			$left.append(data);
		},copy: function(e) {//paste事件
			if($('#panel-shell').is(":hidden") == true) return 0;
			if(xhr) xhr.abort();
			if(flag ==true){
				clearTimeout(reloadOut);
				flag = false;
				$left.text('');
				$cursor.html('&nbsp;');
				$right.text('');
				$shell.show();
				return true;
			}
		}
	})
	
	
	// keypress 按下字符键时触发
	// keydown 按下任意键触发
	// 获取键盘输入 (keydown 与 keypress 获取的 keyCode 值不一样, 其中keydown不区分大小写)
	$(document).keypress(function(e) {
		if($('#panel-shell').is(":hidden") == true) return 0;
		// jQuery 标准化了 event.keyCode(IE) event.which(W3C) event.charCode(事件为keypress下除IE)
		if (e.which === 32) {       // space
			$left.append('&nbsp;');
			//$left.append(String.fromCharCode(e.which));
		} else if(e.which !== 13) { // enter
			if (e.which === 86 && e.ctrlKey) {   // Ctrl + v
				
			}else if(e.which === 67 && e.ctrlKey){  // Ctrl + c
				
			}else $left.append(String.fromCharCode(e.which));
		}

	});
	
	// 功能键
	$(document).keydown(function(e) {
		if($('#panel-shell').is(":hidden") == true) return 0;
		if (e.which === 13) {           // enter
			if(flag == true) return ;
			var cmd = $.trim(decodeURI(encodeURI($input.text()).replace(/%C2%A0/g,'%20')));
			var val_ouput = '';
			var err_class = ' error';
			is_print = true;

			if (cmd !== '') {
				cmd_cache.push(cmd);
				cmd_cache = _.uniq(cmd_cache);
			}else{
				return ;
			}
			if (cmd_cache.length > 0) {
				cmd_pos = cmd_cache.length - 1;
			}
			if(cmd === 'help'){
				$left.text('');
				$cursor.html('&nbsp;');
				$right.text('');
				$shell.before(template_output({separate:'&gt; ', value:cmd, error: ''}));
				var help_str =	"支持的命令: ping、telnet、traceroute、clear、help</br>" 
						+"	ctrl + v-------------粘贴</br>"
						+"	ctrl + c-------------阻断</br>"
						+"	Home键-------------回到顶部</br>"
						+"	End键&nbsp;-------------回到底部<br>"
						+"	上下方向键--------------命令上下切换";
				$shell.before(template_output1({separate:'', value:help_str, error: err_class}) + '<br />');
				var div = document.getElementById('panel-shell');
				div.scrollTop = div.scrollHeight;
				
			}else if (cmd === 'clear') {
				$shell.siblings().remove();
				is_print = false;
				$left.text('');
				$cursor.html('&nbsp;');
				$right.text('');
			} else {
										
				if(flag == false) {
					flag = true;									
				}
				count = 0;
				var first=true;
				 var _do = function(){
					
					xhr = $.ajax({
						  type:"POST",
						  url:'/bhost/terminal',
						  async:true,
						  cache:false,
						  data:{c1: encode64(cmd), m1:aceg(encode64(cmd),$("input[name=se]").val()),a0:$("input[name=se]").val(),co:count},
						  success:function(val_ouput)
						  {
							result = JSON.parse(val_ouput);
							if(result.Result == true){
								if(result.info =='end'){
									clearTimeout(reloadOut);
									flag = false;
									$left.text('');
									$cursor.html('&nbsp;');
									$right.text('');														
									if(result.error_msg != ''){
										$('.shell-view').prev().prev().find('.output').last().after("<span class=\"output error\">"+decode64(result.error_msg).replace(/\r\n/g,"</br>").replace(/\n/g,"</br>")+"</span>")
									}
									$shell.show();
										//$('.shell-view').eq(0).remove();
									is_print = true;
									var div = document.getElementById('panel-shell');
									div.scrollTop = div.scrollHeight;
									return true;
								}
							}else{
								$shell.before(template_output({separate:'&gt; ', value:cmd, error: ''}));												
								$left.text('');
								$cursor.html('&nbsp;');
								$right.text('');	
								$shell.show();
								clearTimeout(reloadOut);
								_alert2(1,"测试工具",result.error_msg);							
								is_print = true;
								flag = false;
								var div = document.getElementById('panel-shell');
								div.scrollTop = div.scrollHeight;
								return 0;
							}
							if(first == true){
								count = result.count;
							}else{
							}
							$shell_clone = $('.shell-view').clone();
							if(is_print) {
								$shell.hide();
								//$shell.before($shell_clone);
								$shell.before(template_output({separate:'&gt; ', value:cmd, error: ''}));
								$shell.before(template_output1({separate:'', value:decode64(result.info).replace(/\r\n/g,"</br>").replace(/\n/g,"</br>"), error: err_class}) + '<br />');
								first = false;
								is_print = false;
							}
							else $('.shell-view').prev().prev().find('.output').last().after("<span class=\"output error\">"+decode64(result.info).replace(/\r\n/g,"</br>").replace(/\n/g,"</br>")+"</span>")
							
							
							var div = document.getElementById('panel-shell');
							
							div.scrollTop = div.scrollHeight;
							
							reloadOut = setTimeout(_do,1000);
						  },
						  error:function(){}
					  }); 
				};
				clearTimeout(reloadOut);
				_do();
				
			}					

		} else if (e.which === 8) {     // backspace
			if(flag == true) return ;
			e.preventDefault();
			
			str_left = $left.text();
			if (str_left.length === 0) {
				return;
			}
			str_left = str_left.substring(0, str_left.length - 1);
			$left.text(str_left);

		} else if (e.which === 37) {    // 向左方向键
			
			str_left = $left.text();
			str_right = $right.text();
			str_cursor = $cursor.text();
			str_tmp_cursor = '';

			if (str_left.length === 0) {
				return;
			}
			str_tmp_cursor = str_left.substring(str_left.length - 1, str_left.length);
			str_left = str_left.substring(0, str_left.length - 1);
			if (!($cursor.html() === '&nbsp;' && str_right.length === 0 && $.trim(str_tmp_cursor) !== '')) {
				str_right = str_cursor + str_right;
			}

			$left.text(str_left);
			$cursor.text(str_tmp_cursor);
			$right.text(str_right);

		} else if (e.which === 39) {    // 向右方向键
			str_left = $left.text();
			str_right = $right.text();
			str_cursor = $cursor.text();
			flag_end = false;

			if (str_right.length === 0) {
				if ($cursor.html() === '&nbsp;') {
					return;
				}
				flag_end = true;
			}
			str_left += str_cursor;
			if (flag_end) {
				$cursor.html('&nbsp;');
				str_right = '';
			} else {
				$cursor.text(str_right.substring(0,1));
				str_right = str_right.substring(1);
			}

			$left.text(str_left);
			$right.text(str_right);

		} else if (e.which === 38) {    // 向上方向键
			if (cmd_pos < 0) {
				return;
			}
			e.preventDefault();
			$left.text(cmd_cache[cmd_pos]);
			cmd_pos--;
			$cursor.html('&nbsp;');
			$right.text('');
		} else if (e.which === 40) {    // 向下方向键
			e.preventDefault();
			if (cmd_pos >= cmd_cache.length - 1) {
				$left.text('');
			} else {
				cmd_pos++;
				$left.text(cmd_cache[cmd_pos]);
			}
			
			$cursor.html('&nbsp;');
			$right.text('');
		} else if (e.which === 46) {    // delete
			str_right = $right.text();

			if (str_right.length === 0) {
				if ($cursor.html() === '&nbsp;') {
					return;
				}
				flag_end = true;
			}

			if (flag_end) {
				$cursor.html('&nbsp;');
			} else {
				$cursor.text(str_right.substring(0, 1));
				$right.text(str_right.substring(1));
			}
		} else if (e.which === 35) {    // end
			str_right = $right.text();
			str_cursor = $cursor.text();
			var str_all = $input.text();

			if (str_right.length === 0 && $.trim(str_cursor).length === 0) {
				return;
			}
			$left.text(str_all);
			$cursor.html('&nbsp;');
			$right.text('');

		} else if (e.which === 36) {    // home
			str_left = $left.text();
			var str_all = $input.text();

			if (str_left.length === 0) {
				return;
			}
			$left.text('');
			$cursor.text(str_all.substring(0, 1));
			$right.text(str_all.substring(1, str_all.length));

		} else if (e.which === 85 && e.ctrlKey) {   // Ctrl + U
			e.preventDefault();

			$left.text('');
		} else if (e.which === 76 && e.ctrlKey) {   // Ctrl + L
			e.preventDefault();

			$shell.siblings().remove();
		}else if (e.which === 86 && e.ctrlKey) {   // Ctrl + v
			var pastedText = undefined;
			if (window.clipboardData && window.clipboardData.getData) { // IE
				pastedText = window.clipboardData.getData('Text');
			} else {
				//pastedText = e.originalEvent.clipboardData.getData('Text');//e.clipboardData.getData('text/plain');
			}
			$left.append(pastedText);
		}else if (e.which === 67 && e.ctrlKey) {   // Ctrl + c
			if(flag == true){
				clearTimeout(reloadOut);
				flag = false;
				$left.text('');
				$cursor.html('&nbsp;');
				$right.text('');
				$shell.show();
				if(xhr) xhr.abort();
				//$shell.before(template_output({separate:'&gt; ', value:cmd, error: ''}));
				return true;
			}
		}
		
	});
	
	$(function(){
		$(window).resize(function () {
			var height1=$('.c-cont').height();
			$('#panel-shell').css('height',height1-80 + 23);
		})
		var height1=$('.c-cont').height()
		$('#panel-shell').css('height',height1-80 + 23);
	});
	
	function terminal_show(){
		//$("#mainFrame").attr("src","/bhost/related_downloads_show?tasktype=2&a0={{se}}");
		$("#info").hide();
		$("#detail").hide();
		$('#msg_manage_1').hide();
		$('#msg_manage_2').hide();
		$('#related_downloads_show').hide();
		$('#terminal_show').show();
		$('#msg_manage_4').hide();
		$('#msg_manage_5').hide();
		$('#msg_manage_6').hide();
		$('.output-view').remove();
		$('#panel-shell br').remove();
		clearInterval(setv);
		// 光标闪烁效果
		setv = setInterval(function(){
			$cursor.toggleClass('blink');
		}, 1000);
		$left.text('');
		$cursor.html('&nbsp;');
		$right.text('');
		$shell.before(template_output({separate:'&gt; ', value:"help", error: ''}));
		var help_str =	"支持的命令: ping、telnet、traceroute、clear、help</br>" 
						+"	ctrl + v-------------粘贴</br>"
						+"	ctrl + c-------------阻断</br>"
						+"	Home键-------------回到顶部</br>"
						+"	End键&nbsp;-------------回到底部<br>"
						+"	上下方向键--------------命令上下切换";
		$shell.before(template_output1({separate:'', value:help_str, error: ' error'}) + '<br />');
	}


</script>

{% endblock  %}
