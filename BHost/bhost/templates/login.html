<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" http-equiv="X-UA-Compatible" content="IE=11;IE=10;IE=9; IE=8; IE=EDGE,chrome=1" />
	<title>Logbase运维安全管理系统</title>
	<!--<script type="text/javascript" src="/manage/js/jquery.min.js"></script>-->
	<script>
		var userAgent = navigator.userAgent;
		var ie8 = userAgent.indexOf('Trident/4.0');

		if(ie8 != -1){
			document.write('<script src="/manage/js/jquery-IE8.js"></' + 'script>');
		}else{
			document.write('<script src="/manage/js/jquery.min.js"></' + 'script>');
		}
	</script>
	<link rel="stylesheet" href="/manage/css/login.css" type="text/css">
	<script src="/manage/js/jquery.easing.js"></script>
	<script src="/manage/js/layer.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/common_e.js"></script>
	<script src="/manage/js/select2.full.min.js"></script>
	<script src="/manage/js/icheck.min.js"></script>
	<script src="/manage/js/jquery.plugin.js"></script>
	<script src="/manage/js/base64.js"></script>
	<script src="/manage/js/md5.js"></script>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	
	<link rel="stylesheet" href="/manage/css/G-style.css">
</head>
<body>
	<div class="login-wrap">
		<div class="login-box">
			<form action="/bhost/login_link" method="POST" name="frm">
			<input type="hidden" name="a0" value = ""/> 
			<input type="hidden" name="a1" value = ""/> 
				<input type="hidden" name="a10" value = ""/> 
				<input type="hidden" name="ha" value = "{{hash}}"/> 
				<input type="hidden" name="ht" value = "" /> 
				<input type="hidden" name="mm" value = "" /> 
				<input type="hidden" name="mc" value = "" /> 
				
			<div class="logo"><img src="/manage/images/login-logo.png" alt=""></div>
			<div class="form" id="loginForm">
				<div class="item item1">
					<i class="icon-u"></i><input type="text" name="uCode" id="uCode" autocomplete="off" tabindex="1" onkeydown="return Query(event)" onkeyup ="check_sms();"  placeholder="账号" />
					<div class="btn" style="float:left;display:none;margin-left: 253px;    margin-top: -41px;padding: 0px;" id="div_sms">
						<button type="button" class="" id="send_id" onclick="send_sms();" title="发送短信" class="login">发&emsp;送</button>
					</div>
				</div>

				<div class="item item2">
					<i class="icon-pwd"></i><input type="password" id="pW"  onkeydown="return Query(event)" tabindex="2" placeholder="密码" />
				</div>
				<div class="item item3" id="checkItem" style="display:none;">
					<i class="icon-ver"></i><input class="vcode" type="text" name="vdcode" id="vdcode"  onkeydown="return Query(event)" placeholder="请输入验证码" onchange="_checkCode(this)"/>
					<em class="check"></em>
					<img id="icode_img" class="code" src="" alt="" onclick="_getNewCode(this)">
				</div>
			</div>

			<div class="item" id="findPwd" style="font-size: 13px; padding-top: 10px;">
				<div class="item" onclick="ForgetPwd(0);" style="text-align: center; width: 75px; cursor: pointer; margin-left: 67%; text-decoration: underline;">找回密码
				</div>
			</div>

			<div id="verificationFrom" class="verificationFrom" style="display: none">
				<div class="verification-code">
					<i class="icon-verification"></i>
					<input id="qr_code" class="code" placeholder="验证码" maxlength="6" onkeydown="if (event.keyCode == 13){test_qrcode();return false;} else return;"/>
				</div>
				<p class="message" style="margin-top: 10px;">从您设备上的两步验证应用获取验证码</p>
			</div>
			</form>


			<div class="form fp1" id="loginForm" style="display: none; margin-top: 5px;">
				<div class="item item1">
					<i class="icon-u"></i><input type="text" id="newAcc" placeholder="账号" onblur="getType();"/>
				</div>
				<div class="item item2">
					<div class="select">
						<div class="select-result">请选择找回方式</div>
						<div class="selects" id="select_content">
							<!-- <div class="select-item">邮箱</div>
							<div class="select-item">短信</div> -->
						</div>
					</div>
				</div>				
				<div class="item item3">
					<i class="icon-ver"></i><input type="text" id="uCode1" placeholder="请输入验证码" style="width: 50%;">
					<div class="btn fp1" style="float: left;margin-left: 253px;margin-top: -42px;padding: 0px;" id="div_sms">
						<button type="button" class="" onclick="sendUcode(this);" id="senducode" title="获取验证码">发&emsp;送</button>
					</div>
					<!-- <button class="fp1" style="margin-left: 65%; transform: translateY(-123%); color: #3399ea; background-color: transparent; border-color: transparent; cursor: pointer; width: 110px; text-align: center;" onclick="sendUcode(this);">获取验证码</button> -->
				</div>
				<div class="item item4" style="border-top: 1px solid #cbcbcb;">
					<i class="icon-pwd"></i><input type="password" id="newPwd" placeholder="新密码" />
				</div>
				<div class="item item4" style="border-top: 1px solid #cbcbcb;">
					<i class="icon-pwd"></i><input type="password" id="newPwd1" placeholder="确认密码" />
				</div>
			</div>
			
			<div class="progress1" id="progress1" style="margin-top: 20px;margin-bottom: 0px;height: 50px;border-radius: 5px;border: none;display:none;"><div class="progress-bar progress-bar-info progress-bar-striped active" id="progress_width" style="width: 0%;border-radius: 5px;    height: 30px;margin-top: 10px;"></div><div class="progress-value" id="progress_value" style="display:none;"><span>登录中...</span></div></div>
			<div class="btn" id="login_btn">
				<button type="button" onclick="_login()" class="login">登&emsp;录</button>
				<button type="button" id="submit_btn" class="verification buttom-list" onclick="test_qrcode();">确&emsp;定</button>
				<button type="button" class="cancle buttom-list">取&emsp;消</button>
				<button type="button" class="verification buttom-list fp1" style="width: 48%;" onclick="fpSubmit()">确&emsp;定</button>
				<button type="button" class="verification buttom-list fp1" style="width: 48%;float: right;" onclick="fpCancle()">取&emsp;消</button>
			</div>
						
		</div>
	</div>
	<div class="copyright">
		<p>Copyright &copy; 2005-2019 思福迪</p>
	</div>
	
	<div class="dialog-cont s-hide" id="pwd_code_div" style="display:none;max-height:300px">
		<div style="float:left;margin-left: 72px">
			<div class="form-item" style="width: 150px;">
				<span class="form-tag" style="width: 113px;" >将初始密码作为本地密码：</span>
				<div class="form-c" style="" >
					<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="used_init_pwd" checked id="used_init_pwd"></label>
				</div>
			</div>	
			<div id="div_pwd" style="display:none;">
				<div class="form-item">
					<span class="form-tag"><em class="imp">*</em><span id="span_pwd">密&nbsp;&nbsp;码</span>：</span>
					<div class="form-c" style="width: 33.3%; position: absolute;">
						<input type="password" class="form-text" id = "sys_u_pwd_new"  maxlength="64" tabindex="5" style="margin-left: 80px;"><i class="v-check"></i>
					</div>
				</div>
				<div class="form-item">
					<span class="form-tag"><em class="imp">*</em>确认密码：</span>
					<div class="form-c">
						<input type="password" class="form-text" id = "sys_u_pwd_tr" maxlength="64" tabindex="6"><i class="v-check"></i>
					</div>
				</div>
			</div>
		</div>
		<div class="tab-t">
			<div class="ctr">
				<a class="btn" href="javascript:;" style="margin-left:16px;" onclick="submit_pwd();">验证</a>
			</div>
		</div>
		<!--
		<div class="ctr">
			<a class="btn" href="javascript:;" style="float:left;margin-left:13px;;padding: 0 15px;line-height: 24px;color: #8D808A;border: 1px solid #8D808A;border-radius: 5px;transition: all 0.4s;" onclick="submit_totp();">验证</a>
		</div>
		-->
	</div>
	
	<div class="dialog-cont s-hide" id="qr_code_div" style="display:none;max-height:500px">
		<span style="margin-left: 72px;">请使用您的两步验证应用扫描二维码</span>
		<div style="text-align:center;">
			<img src="">
		</div>
		<div style="text-align: center;height: 34px;">
			<span>请在下方输入应用中的验证码进行测试。
			</span>
		</div>
		<div style="float:left;margin-left: 72px">
			<input type="text" class="form-text" id="totp_v" style="width:133px;" placeholder="输入验证码" onkeydown="if (event.keyCode == 13){submit_totp();return false;} else return;">
		</div>
		<div class="tab-t">
			<div class="ctr">
				<a class="btn" href="javascript:;" style="margin-left:16px;" onclick="submit_totp();">验证</a>
			</div>
		</div>
		<!--
		<div class="ctr">
			<a class="btn" href="javascript:;" style="float:left;margin-left:13px;;padding: 0 15px;line-height: 24px;color: #8D808A;border: 1px solid #8D808A;border-radius: 5px;transition: all 0.4s;" onclick="submit_totp();">验证</a>
		</div>
		-->
	</div>
	
	<div class="dialog-cont s-hide" id="token_code_div" style="display:none;max-height:300px">
		<span style="margin-left: 72px;">请使用您的令牌码登录</span>
		<div style="text-align:center;">
			<img src="">
		</div>
		<div style="float:left;margin-left: 72px">
			<input type="text" class="form-text" id="token_v" style="width:133px;" placeholder="输入令牌码" onkeydown="if (event.keyCode == 13){submit_token();return false;} else return;">
		</div>
		<div class="tab-t">
			<div class="ctr">
				<a class="btn" href="javascript:;" style="margin-left:16px;" onclick="submit_token();">验证</a>
			</div>
		</div>
		<!--
		<div class="ctr">
			<a class="btn" href="javascript:;" style="float:left;margin-left:13px;;padding: 0 15px;line-height: 24px;color: #8D808A;border: 1px solid #8D808A;border-radius: 5px;transition: all 0.4s;" onclick="submit_totp();">验证</a>
		</div>
		-->
	</div>
	
	<div class="dialog-cont s-hide" id="pin_code_div" style="display:none;max-height:300px">
		<span style="margin-left: 72px;">请使用您的PIN码登录</span>
		<div style="text-align:center;">
			<img src="">
		</div>
		<div style="float:left;margin-left: 72px">
			<input type="text" class="form-text" id="pin_v" style="width:133px;" placeholder="输入PIN码" onkeydown="if (event.keyCode == 13){submit_pin();return false;} else return;">
		</div>
		<div class="tab-t">
			<div class="ctr">
				<a class="btn" href="javascript:;" style="margin-left:16px;" onclick="submit_pin();">验证</a>
			</div>
		</div>
		<!--
		<div class="ctr">
			<a class="btn" href="javascript:;" style="float:left;margin-left:13px;;padding: 0 15px;line-height: 24px;color: #8D808A;border: 1px solid #8D808A;border-radius: 5px;transition: all 0.4s;" onclick="submit_totp();">验证</a>
		</div>
		-->
	</div>
	
	
	<div class="dialog-cont s-hide" id="change_pwd_div" style="display:none;min-height:250px">
		<div style="float:left;margin-left: 72px">
			
			<div id="div_pwd" style="">
				<div class="form-item">
					<span class="form-tag"><em class="imp">*</em><span id="span_pwd">密&nbsp;&nbsp;码</span>：</span>
					<div class="form-c" style="width: 33.3%; position: absolute;">
						<input type="password" class="form-text" id="change_sys_u_pwd_new"  maxlength="64" tabindex="5"><i class="v-check"></i>
					</div>
				</div>
				<div class="form-item">
					<span class="form-tag"><em class="imp">*</em>确认密码：</span>
					<div class="form-c">
						<input type="password" class="form-text" id = "change_sys_u_pwd_tr" maxlength="64" tabindex="6"><i class="v-check"></i>
					</div>
				</div>
			</div>
		</div>
		<div class="btns" style="position:fixed;">
			<a href="javascript:;" class="btn btn-normal btn-submit" style="padding-top:0px" >确&nbsp;&nbsp;定</a>
			<a href="javascript:;" class="btn btn-normal btn-cancel" style="padding-top:0px">重&nbsp;&nbsp;置</a>
		</div>
		<!--
		<div class="ctr">
			<a class="btn" href="javascript:;" style="float:left;margin-left:13px;;padding: 0 15px;line-height: 24px;color: #8D808A;border: 1px solid #8D808A;border-radius: 5px;transition: all 0.4s;" onclick="submit_totp();">验证</a>
		</div>
		-->
	</div>
<style>
	.progress{
		height: 15px;
		/*background: #262626;*/
		padding: 5px;
		overflow: visible;
		border-radius: 20px;
		border-top: 1px solid #7992a8;
		border-bottom: 1px solid #7992a8;
		margin-top: 50px;
	}
	.progress1 .progress-bar{
		border-radius: 20px;
		position: relative;
		animation: animate-positive 2s;
	}
	.progress1 .progress-value{
		display: block;
		padding: 3px 7px;
		font-size: 13px;
		color: #fff;
		border-radius: 4px;
		background: #191919;
		border: 1px solid #000;
		position: absolute;
		width: 51px;
		height: 20px;
		/*position: relative;*/
		top: 339px;
		right: 259px;
	}
	
	.progress1 .progress-value:after{
		content: "";
		border-top: 10px solid #191919;
		border-left: 10px solid transparent;
		border-right: 10px solid transparent;
		position: absolute;
		bottom: -6px;
		left: 26%;
	}
	.progress-bar.active{
		animation: reverse progress-bar-stripes 0.40s linear infinite, animate-positive 2s;
	}
	@-webkit-keyframes animate-positive{
		0% { width: 0; }
	}
	@keyframes animate-positive{
		0% { width: 0; }
	}
</style>
<style>
	.bar {
	  position: relative;
	  height: 2px;
	  width: 500px;
	  margin: 0 auto;
	  background: #fff;
	  margin-top: 150px;
	}

	.circle {
	  position: absolute;
	  top: -30px;
	  margin-left: -30px;
	  height: 60px;
	  width: 60px;
	  left: 0;
	  background: #fff;
	  border-radius: 30%;
	  -webkit-animation: move 5s infinite;
	}

	.pp {
	  position: absolute;
	  top: -35px;
	  right: -85px;
	  text-transform: uppercase;
	  color: #347fc3;
	  font-family: helvetica, sans-serif;
	  font-weight: bold;
	}

	@-webkit-keyframes move {
	  0% {left: 0;}
	  50% {left: 100%; -webkit-transform: rotate(450deg); width: 150px; height: 150px;}
	  75% {left: 100%; -webkit-transform: rotate(450deg); width: 150px; height: 150px;}
	  100 {right: 100%;}
	} 
</style>	
	
<style>
	.form .item .select{
		display: block;
		width: 260px;
		height: 100%;
		border: 0;
		background: url(../manage/images/select-bg.png) no-repeat 220px 0 transparent;
		margin-left: 50px;
		font-size: 14px;
		line-height: 46px;
		height: 46px \9;
		appearance:none;
		-moz-appearance:none;
		-webkit-appearance:none;
	}
	.selects{
		width: 324px;
		position: absolute;
		top: 48px;left: -1px;
		background: white;
		z-index: 10;
		background: #e5e5e5;
		display: none;
	}
	.select-item{
		height: 40px;
		border-bottom: 1px solid #cbcbcb;
		text-align: center;
		line-height: 40px;
		cursor: pointer;
		border-left: 1px solid #cbcbcb;
		border-right: 1px solid #cbcbcb;
	}
	.select-result{
		height: 48px;
		position: absolute;
		width: 200px;
		line-height: 47px;
		font-size: 14px;
		top: 0px;left: 50px;
	}
	select::-ms-expand { 
		display: none; 
	}
	.ui-popup.ui-popup-modal.ui-popup-show.ui-popup-focus{
		position:fixed;
		left:50%;
		top:50%;
		margin-left:width/2;
		margin-top:height/2
	}
	.layui-layer-content{
		height: 170px;
	}
	.layui-layer{
		margin-top: -24px;
	}
</style>	
<script>
var IfNeedCode ='{{IfNeedCode}}';
var error="{{error}}";
var gl_icode="";
var if_mac_limit =0;
var jumpcluster ='{{jumpcluster}}';
$(function(){
	if(jumpcluster == '1') {
                if(location.port) location.href = 'https://' + location.host +':' + location.port+'/bhost/cluster';
                else location.href = 'https://' + location.host +'/bhost/cluster';
        }
	//下拉框js
	$('.select').click(function (e) {
		if($("#newAcc").val() == ""){
			_alert(2,"修改密码","请先输入账号");
			return false;
		}
		if($('.selects').is(':visible') == true){
			$('.selects').css('display','none');
			$('.form .item .select').css('background','url(../manage/images/select-bg.png) no-repeat 220px 0 transparent');
		}else{
			$('.selects').css('display','block');
			$('.form .item .select').css('background','url(../manage/images/select-bg1.png) no-repeat 230px 0 transparent');
			e.stopPropagation();
		}
	})
	$('.select-item').click(function (e) {
		var value=$(this).html();
		$('.selects').css('display','none');
		$('.form .item .select').css('background','url(../manage/images/select-bg.png) no-repeat 220px 0 transparent');
		$('.select-result').html(value);
		e.stopPropagation();
	})
	$(document).click(function () {
		$('.selects').css('display','none');
		$('.form .item .select').css('background','url(../manage/images/select-bg.png) no-repeat 220px 0 transparent');
	})
	
	//

	getPwdStrategy();
	$('#vdcode').bind('input propertychange', function() {_checkCode("#vdcode")});
	$("#qr_code").on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	
	if(error !=""){
		_alert(1,'登录界面',error);
		return false;
	}
	
	if(IfNeedCode =='1'){
		get_icode();
		$("#checkItem").show();
		n= Math.floor(1000*Math.random());
		$("#icode_img").attr('src',"/manage/images/icode.png?n="+n+".png");
		//_checkCode("#vdcode");
	}
	
	$("input[name=used_init_pwd]").on('ifChanged',function(){
		if($('#used_init_pwd').prop('checked')==true){
			$('#div_pwd').hide();
		}else{
			$('#div_pwd').show();
		}
	})
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass:'icheckbox_minimal-blue',
		radioClass:'iradio_minimal-blue',
		increaseArea:'0'
	});
	
	if_mac_limit =0;
	var if_manager = false;
	var if_operation = false;
	client_str='bhrdpdr.exe,BHTunnelDaemon.exe,UsbKeyLogin.exe,parse.exe,httptransfile.exe,library.zip,ReplayClient.exe,ReplayClientModule.exe,zkfp.exe,RdpsReplay.jar,CharReplay.jar,cygcrypto-1.0.0.dll,cygiconv-2.dll,cygssl-1.0.0.dll,cygwin1.dll,cygz.dll,BHostAlive.exe,ReplayClientModule.exe';
	var sesstime = (new Date()).valueOf();
	cmd_json ={
		"type":"bhostupdate",
		"sesstime": sesstime,//毫秒
		"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
		"sesstimet":'',
		"UpdateExe":client_str,
		"session":sesstime,
		"BHUser":''
	}	
	client_request_update(cmd_json,sesstime);
	
})
//

//更新验证码
function _getNewCode(obj){
	get_icode();
	_checkCode($('#vdcode'));
}
//
function _checkCode(obj){
	var code = $.trim($(obj).val());
	var check = $(obj).next('.check');

	if(code == '' || code.toUpperCase() != gl_icode.toUpperCase()){
		check.attr('class','check w');
	}else{
		check.attr('class','check r');
	}
}
//获取验证码
function get_icode(){
	$.ajax({
		url:"/bhost/_getIcode",
		async:false,
		type:"POST",
		data:{},
		success:function(result){
			result = JSON.parse(result);
			if(result.result == false){
				_alert(2,"用户登录",result.info);
				return false;
			}else{
				gl_icode = result.info;
				$("#checkItem").show();
				n=Math.floor(1000*Math.random());
				$("#icode_img").attr('src',"/manage/images/icode.png?n="+n+".png");
				if($('#vdcode').val() !=""){
					_checkCode("#vdcode");
				}
			}
		}
	})
}
function Query(evt){
	evt=(evt)?evt:((window.event)?window.event:""); 
	var key=evt.keyCode?evt.keyCode:evt.which;
	if(key==13 && $(".login").is(":visible")){
		_login()
	}
}

var index_authtype = 0;
var uCode = '';
var pW ='';
var auth_type = [];
var flag_local = -1;
var tmpplist = [];
var UpdateNoAlert = 1;
var cip='{{cip}}';
var if_ok;
var flag_3usbkey = false;//第三方key
var fingerprint = false; //中控指纹
function _login(){
	uCode = $("#uCode").val().toLowerCase();
	pW = $("#pW").val();
	
	$("#pW").blur();
	$("#uCode").blur();
	$('.btn button').blur();
	$('input').blur();
	if(uCode == ""){
		_alert(2,"用户登录","请输入账号");
		return false;
	}
	
	for(var i = 0;i < pW.length; i++){
		if(pW.charCodeAt(i) > 255){ //如果是汉字
			_alert(2,"用户登录","账号或密码错误");
			return false;
		}
	}
	if($("#checkItem").is(":visible")){
		if(document.frm.vdcode.value==""){
			$("#vdcode").blur();
			_alert(2,"用户登录",'验证码不能为空',$("#vdcode"));
			get_icode();
			return;
		}else if(gl_icode.toUpperCase()!=document.frm.vdcode.value.toUpperCase()){
			$("#vdcode").blur();
			_alert(2,"用户登录",'验证码错误',$("#vdcode"));
			get_icode();
			_checkCode($('#vdcode'));
			return;
		}
	}
	fingerprint = false;
	//查看用户的认证方式 是否存在 0   1->pin码 2->totp
	$.ajax({
		url:"/bhost/get_user_authtype",
		async:false,
		type:"POST",
		data:{a0:uCode},
		success:function(Result){
			Result = JSON.parse(Result);
			if(Result.result == false){ //获取失败
				_alert(2,"用户登录",Result.ErrMsg);
			}else{
				// 判断 用户是否有 mac登陆限制 并且  是管理员还是 运维用户
				if_mac_limit =0;
				var if_manager = false;
				var if_operation = false;
				//client_str='bhrdpdr.exe,BHTunnelDaemon.exe,UsbKeyLogin.exe,parse.exe,httptransfile.exe,library.zip';
				$.ajax({
					url: "/bhost/iai",
					type:"POST",
					async:false,		
					data:{c1:uCode},
					success:function(result){
						var result=JSON.parse(result);
						if(result.Result){
							if_mac_limit = result.imi;
						}else{
							_alert(1,"用户登录",result.ErrMsg);
						}
					}
				})

				//是否提示 下载客户端
				UpdateNoAlert = Result.UpdateNoAlert;
				
				//是否存在 本地认证
				auth_type = Result.info;
				tmpplist=auth_type;
				if(auth_type.length == 0){
					_alert(2,"用户登录","账号或密码错误");	
					return false;
				}
				
				var flag_init_pwd = false;
				flag_local = -1;
				var local_list = '';
				var flag_totp = false;
				var flag_usbkey = false;//logbase usbkey

				var UserObject = '';
				var CSP = '';
				var CN = '';
				var Value = '';
				
				var usbkey_order = 0;
				var usbkey3_order = 0;
				var tmp_list = [];
				$(auth_type).each(function(i,item){
					if(item.AuthMode == 1){ //本地
						flag_local = i;
						local_list = item;
					}else{
						if(item.AuthMode == 10) flag_totp = true; //totp
						if(item.AuthMode == 8) { //logbase key
							flag_usbkey = true;
							usbkey_order = item.Order;
						}
						if(item.AuthMode == 9) {
							flag_3usbkey = true;
							usbkey3_order = item.Order;
							UserObject = item.UserObject;
							CSP = item.CSP;
							CN = item.CN;
							Value = item.CertCn;
						}
						if(item.AuthMode == 13){
							fingerprint = true;
						}
						tmp_list.push(item);
					}
				})				
				if(local_list !='') tmp_list.unshift(local_list)
				auth_type = tmp_list;
				
				if(pW == ""){
					if(tmpplist.length == 1 && flag_3usbkey == true){//只有第三方KEY
						
					}else if(tmpplist.length == 1 && fingerprint == true){//只有指纹
						
					}else if(tmpplist.length == 2 && fingerprint == true && flag_3usbkey == true){//只有指纹,第三方KEY
						
					}else{
						_alert(2,"用户登录","请输入密码");
						return false;
					}
				}
				
				for(var i = 0;i < pW.length; i++){
					if(pW.charCodeAt(i) > 255){ //如果是汉字
						_alert(2,"用户登录","账号或密码错误");
						return false;
					}
				}
				
				
				/*//判断是否没安装 exe控件
				var f = false;
				if(flag_usbkey == true || fingerprint == true){
					//获取 首次登陆时间
					$.ajax({
						url:"/bhost/get_first_time",
						type:"POST",
						async:false,
						data:{a0:uCode},
						success:function(result){
							if(result == 'true'){
								layer.open({
									type: 1,
									title: '安装运维客户端',
									content: '<div class="layer-alert"><i class="alert warning"></i>首次运维主机前，请先安装运维客户端</div>',
									btn: ['确&nbsp;&nbsp;定'],
									btnAlign: 'c',
									area: ['380px'],
									yes: function(i) {
										$.ajax({
											url:"/bhost/exist_download_BHostClient_exe",
											type:"POST",
											async:false,
											data:{a1:uCode},
											success:function(result){
												var result=JSON.parse(result);
												if(result.Result){
													location.href='/bhost/download_BHostClient_exe';
													layer.close(i);
													return false;
												}else{
													_alert(2,'用户登录',result.ErrMsg);
													return false;
												}
											}
										})
									},
									skin:'layer-custom'
									
								});
								f = true;
								return false;
							}
							
						}
					})
				}
				if(f == true) return false;*/
				
				if(flag_local >=0 && Result.initpwd == true && uCode != "admin" ) {
					check_init_pwd();
					return false;
				}else{
					
					if((flag_totp == true || flag_usbkey == true || fingerprint == true) && Result.initpwd == true && uCode != "admin"){
						check_init_pwd();
						return false;
					}
				}
			}
			
			// 先 分隔 logbase usbkey的密码 认证usbkey后继续认证
			//AuthUsbkey bhuser password certca crl
			if(flag_usbkey == true){
				//分隔usbkey的密码 以及获取 证书信息
				$.ajax({
					url:"/bhost/get_usbkey_cert",
					async:false,
					type:"POST",
					data:{a0:uCode,a1:encode64(pW),a2:usbkey_order,a3:1},
					success:function(Result){
						Result = JSON.parse(Result);
						if(Result.result == false){ //获取失败
							_alert(2,"用户登录",Result.ErrMsg);
							return false;
						}else{
							Content = Result.Content;
							usbkey = Result.usbkey;
							UserId = Result.UserId;
						}
					}
				})
				sesstime = new Date().getTime()-1;
				cmd_json ={
					"type":"AuthUsbkey",
					"sesstime": sesstime,//毫秒
					"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
					"IfUsbkey":true,
					"certInfo":'',
					"crlInfo":'',
					"bhuser":uCode,
					"password":usbkey,
					//"UpdateExe":client_str,
					"session":sesstime
				}
				if(if_mac_limit) {
					cmd_json['login'] =1;
					cmd_json['cip'] = cip;
				}
				client_request(cmd_json,'AuthUsbkey',UserId,sesstime,Content);
					
			}else if(flag_3usbkey == true){
				// 先 认证第三方usbkey后继续认证
				//{"sesstimet":"", "type":"", "CSP":"", "CA":"", "CN":"", "Value":"", "UrlIp":"", "IfUsbkey":""}
				sesstime = (new Date()).valueOf();
				cmd_json ={
					"type":"ThirdPartyUsbkey",
					"sesstime": sesstime,//毫秒
					"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
					"IfUsbkey":true,
					"CSP":CSP,
					"CA":'',
					"CN":CN,
					"Name":UserObject,
					"Value":Value,
					"sesstimet":'',
					//"UpdateExe":client_str,
					"session":sesstime,
				}
				if(if_mac_limit) {
					cmd_json['login'] =1;
					cmd_json['cip'] = cip;
				}
				client_request_usb3key(cmd_json,sesstime);
			}else if(fingerprint == true){	//指纹认证
				_showLoading("正在验证指纹......");
				var sesstime = new Date().getTime();
				//type -> 录入 Register    验证 Verify
				json_data = {
					"type": "Verify",
					"UrlIp": document.domain+ (location.port!=''?':'+location.port:''), 
					"sesstimet": sesstime, 
					"User": uCode, 
					"Id": "",
					"Ifzkfp": 1
				}
				$.ajax({
					url: "/bhost/insert_fp",
					type:"POST",
					async: true,
					data:{a0:uCode,a1:sesstime},
					success:function(result){
						var result=JSON.parse(result);
						if(result.Result){
							$.ajax({
								url: "/bhost/get_base64",
								type:"POST",
								async: true,
								data:{z1:JSON.stringify(json_data)},
								success:function(result){
									var result=JSON.parse(result);
									if(result.Result){
										base64_str = result.b64;
										$('#YuFrame1').remove();
										$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
										$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+ base64_str);
										//每5秒刷新录入结果
										var c = 0;
										var if_ok_down_other = setInterval(function(){
											var se = se || ' ';
											var ret = repeat_get_path_other(sesstime,se);
											if(ret[0] == 1 && ret[1].toLowerCase() == 'true' ){
												if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='1';
												clearInterval(if_ok_down_other);
												re_5 = function(){
													if_ok = setInterval(function(){
														IfSaveSuccess(sesstime);
													},1000)}
												re_5();
												return 0;
											}
											if(c >= 10){
												if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='0';
												clearInterval(if_ok_down_other);
												alertError('bhost',se,uCode);
												_closeLoading();
												return 0;
											}
											c = c + 1;
										},500)
									}else{
										_alert(1,"用户登录",result.ErrMsg);
										return false;
									}
								}
							})
						}else{
							_alert(1,"用户登录",result.ErrMsg);
							return false;
						}
					}
				})
			}else{
				sesstime = (new Date()).valueOf();
				cmd_json ={
					"type":"bhostupdate",
					"sesstime": sesstime,//毫秒
					"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
					"sesstimet":'',
					//"UpdateExe":client_str,
					"session":sesstime,
					"BHUser":''
				}					
				if(if_mac_limit){
					cmd_json['login'] =1;
					cmd_json['cip'] = cip;
					client_request_mac(cmd_json,sesstime);
					return 0;
				}
				login_check();
			}	
		}
	})
}

function IfSaveSuccess(sesstime,uCode){
	$.ajax({
		url: "/bhost/get_fpResult",
		type:"POST",
		async: true,
		data:{a0:uCode,a1:sesstime},
		success:function(result){
			//{\"Result\":true,\"status\":\"%s\",\"finger\":\"%s\"}
			var result=JSON.parse(result);
			if(result.Result){
				if(result.status == 1){
					_closeLoading();
					clearInterval(if_ok);
					login_check(1,pW,result.Separator,result.finger);
				}else if(result.status == 3){
					_closeLoading();
					clearInterval(if_ok);
				}
			}else{
				_alert(1,"用户登录",result.ErrMsg);
				return false;
			}
		}
	})
}

function client_request(cmd_json,type,UserId,sesstime,Content){
	var if_html_client = false;
	var base64_str = '';
	var sesstimet = (new Date()).valueOf() +1;
	cmd_json['sesstimet'] = sesstimet;
	$.ajax({
		url: "/bhost/get_base64",
		type:"POST",
		async:false,		
		data:{z1:JSON.stringify(cmd_json)},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				if_html_client = result.info;
				base64_str = result.b64;
			}else{
				_alert(1,"用户登录",result.ErrMsg);
			}
		}
	})
	
	//window.location.href = 'bhost://cmd&'+base64_str;
	get_regedit_mac('bhost','',uCode,sesstimet);
	$('#YuFrame1').remove();
	$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
	$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);	
	
	//插入数据库数据
	$.ajax({
		url: "/bhost/insert_usbkeys",
		type:"POST",
		async:false,		
		data:{z1:sesstime,t1:type,u1:uCode,c1:Content,a10:"用户登录"},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
			}else{
				_alert(1,"用户登录",result.ErrMsg);
				return false;
			}
		}
	})
	
	//循环获取 数据库状态
	_showLoading("正在验证PIN码......");
	var c = 0;
	
	if_ok_down = setInterval(function(){
		ret = repeat_get_usb_status(sesstime);
		if(ret == 1){
			clearInterval(if_ok_down);
			_closeLoading();
			layer.open({
				type:1,
				title:"用户登录",
				content:'<div class="layer-alert"><i class="alert succ"></i>PIN码验证成功</div>',
				btn:['确&nbsp;&nbsp;定'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					layer.close(i);
					console.log(fingerprint);
					if(fingerprint != true){
						login_check();
					}else{
						_showLoading("正在验证指纹......");
						var sesstime = new Date().getTime();
						//type -> 录入 Register    验证 Verify
						json_data = {
							"type": "Verify",
							"UrlIp": document.domain+ (location.port!=''?':'+location.port:''), 
							"sesstimet": sesstime, 
							"User": uCode, 
							"Id": "",
							"Ifzkfp": 1
						}
						$.ajax({
							url: "/bhost/insert_fp",
							type:"POST",
							async: true,
							data:{a0:uCode,a1:sesstime},
							success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
									$.ajax({
										url: "/bhost/get_base64",
										type:"POST",
										async: true,
										data:{z1:JSON.stringify(json_data)},
										success:function(result){
											var result=JSON.parse(result);
											if(result.Result){
												base64_str = result.b64;
												$('#YuFrame1').remove();
												$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
												$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+ base64_str);
												//每5秒刷新录入结果
												var c = 0;
												var if_ok_down_other = setInterval(function(){
													var se = se || ' ';
													var ret = repeat_get_path_other(sesstime,se);
													if(ret[0] == 1 && ret[1].toLowerCase() == 'true' ){
														if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='1';
														clearInterval(if_ok_down_other);
														re_5 = function(){
															if_ok = setInterval(function(){
																IfSaveSuccess(sesstime);
															},1000)}
														re_5();
														return 0;
													}
													if(c >= 10){
														if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='0';
														clearInterval(if_ok_down_other);
														alertError('bhost',se,uCode);
														_closeLoading();
														return 0;
													}
													c = c + 1;
												},500)
											}else{
												_alert(1,"用户登录",result.ErrMsg);
												return false;
											}
										}
									})
								}else{
									_alert(1,"用户登录",result.ErrMsg);
									return false;
								}
							}
						})
					}
					return 0;
				}
			})
		}
		if(ret == 2){
			clearInterval(if_ok_down);
			_closeLoading();
			_alert(1,"用户登录",'验证PIN码失败');
			return 0;				
		}
		if(c >=20){
			clearInterval(if_ok_down);
			_closeLoading();
			_alert(1,"用户登录",'验证PIN码超时');
			return false;
		}			
		c = c + 1;				
	},1000)
}

function client_request_usb3key(cmd_json,sesstime){
	var base64_str = '';
	var sesstimet = (new Date()).valueOf() +1;
	cmd_json['sesstimet'] = sesstimet;
	$.ajax({
		url: "/bhost/get_base64",
		type:"POST",
		async:false,		
		data:{z1:JSON.stringify(cmd_json)},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				base64_str = result.b64;
			}else{
				_alert(1,"用户登录",result.ErrMsg);
			}
		}
	})
	
	
	//window.location.href = 'bhost://cmd&'+base64_str;
	get_regedit_mac('bhost','',uCode,sesstimet);
	$('#YuFrame1').remove();
	$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
	$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);	
	
	
	//插入数据库数据
	$.ajax({
		url: "/bhost/insert_usbkeys",
		type:"POST",
		async:false,		
		data:{z1:sesstime,t1:'ThirdPartyUsbkey',u1:uCode,c1:'',a10:"用户登录"},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
			}else{
				_alert(1,"用户登录",result.ErrMsg);
				return false;
			}
		}
	})
	
	//循环获取 数据库状态
	_showLoading();
	var c = 0;
	
	if_ok_down = setInterval(function(){
		ret = repeat_get_usb_status(sesstime);
		if(ret == 1){
			clearInterval(if_ok_down);
			_closeLoading();
			if(tmpplist.length == 1) pW='safetybase';
			login_check();
			//组合 密码
			return 0;				
		}
		if(ret == 2){
			clearInterval(if_ok_down);
			_closeLoading();
			_alert(1,"用户登录",'验证PIN码失败');
			return 0;				
		}			
	},2000)
}

var mac ='';
var cc =0;
function _showProgress(){
	$('#progress1').show();
	var co = 1;
	cc = setInterval(function() {
		if(co >100) clearInterval(cc);
		$('#progress_width').css('width',co+'%');
		co = co +10;
	}, 500);
	$('#login_btn').hide();
	$('#uCode').attr('readonly',true);
	$('#pW').attr('readonly',true);
	$('#vdcode').attr('readonly',true);
	
}
function _closeProgress(){
	$('#progress1').hide();
	$('#login_btn').show();
	$('#uCode').removeAttr('readonly');
	$('#pW').removeAttr('readonly');
	$('#vdcode').removeAttr('readonly');
	clearInterval(cc);
	$('#progress_width').css('width','0%');
}

function client_request_update(cmd_json,sesstime){
	var base64_str = '';
	var sesstimet = (new Date()).valueOf() +1;
	cmd_json['sesstimet'] = sesstimet;
	$.ajax({
		url: "/bhost/get_base64",
		type:"POST",
		async:false,		
		data:{z1:JSON.stringify(cmd_json)},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				base64_str = result.b64;
			}else{
				_alert(1,"用户登录",result.ErrMsg);
			}
		}
	})	
	//return 0;
	//window.location.href = 'bhost://cmd&'+base64_str;
	get_regedit('bhost','','',sesstimet);
	$('#YuFrame1').remove();
	$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
	$('#YuFrame1').attr('src','/bhost/test_html?t1=bhostupdate&z1='+base64_str);
}

function client_request_mac(cmd_json,sesstime){
	if(loadLayer) {
		_closeLoading();
	}
	//_showLoading("正在登录中请稍后......");
	_showProgress();
	var base64_str = '';
	var sesstimet = (new Date()).valueOf() +1;
	cmd_json['sesstimet'] = sesstimet;
	$.ajax({
		url: "/bhost/get_base64",
		type:"POST",
		async:false,		
		data:{z1:JSON.stringify(cmd_json)},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				base64_str = result.b64;
			}else{
				_alert(1,"用户登录",result.ErrMsg);
			}
		}
	})	
	//return 0;
	//window.location.href = 'bhost://cmd&'+base64_str;
	get_regedit_mac('bhostupdate','',uCode,sesstimet);
	$('#YuFrame1').remove();
	$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
	$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);	
}
function get_regedit_mac(typ,se,uCode,sesstimet){
		se = se || ' ';
		uCode = uCode || ' ';
		//插入数据库数据
		$.ajax({
			url: "/bhost/insert_usbkeys",
			type:"POST",
			async:false,
			data:{a0:se,z1:sesstimet,t1:"IfUpdate",u1:' ',c1:' ',a10:""},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
				}else{
					_alert(1,"检查客户端",result.ErrMsg);
					return false;
				}
			}
		})
		//循环获取 数据库状态
		var c = 0;
		var if_ok_down_other = setInterval(function(){
			var  ret = repeat_get_path_other(sesstimet,se);
			var rrrt = ret[1].split(',');
			if(ret[0] == 1 && rrrt[0].toLowerCase() =='true' ){
				//rrrt[1] ='38:D5:47:D8:A2:76';
				if(rrrt.length >1 && rrrt[1] !='') mac = encode64(rrrt[1]);
				else mac = '';
				document.frm.ma.value=mac;
				clearInterval(if_ok_down_other);
				if(typ =='bhostupdate') {
					_closeLoading();
					login_check();
				}
				_closeProgress();
				return 0;
			}
			if(c >=10){
				clearInterval(if_ok_down_other);
				alertError1(typ,se,uCode);
				if(typ =='bhostupdate') _closeLoading();
				_closeProgress();
				return 0;
			}
			c = c + 1;
        },500)
}
function alertError1(type,se,uCode){
	if(UpdateNoAlert == 0) return true;
	type = type || "bhost";
	se = se || '';
	uCode = uCode || '';
	var checkg = false;
	$.ajax({
		url: '/bhost/GetNoAlert',
		type: 'post',
		async: false,
		data: { a0: se,a1:uCode},
		success: function (result) {
			var result=JSON.parse(result);
			
			if(result.Result){
				result = result.info;
				if(result == '1'){
					checkg = true;
				}
			}else{
				_alert(2,"更新客户端",result.ErrMsg);
				return false;
			}
		}
	})
	var title = '检测到当前用户没有安装最新的客户端，建议安装';
	var content ='<div class="layer-alert"><i class="alert warning"></i><span>'+title+'</span><div style="margin-top: 5px;"><input type="checkbox" class="form-checkbox" name="" id="layer_div" value="" >不再提示</div></div>';
	
	if(checkg){
		 parent.parent.layer.open({
			type:1,
			title:"运维客户端",
			content:content,
			btn:['下&nbsp;&nbsp;载', '取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
				parent.parent.layer.close(i);
				location.href='/bhost/download_BHostClient_exe';	
				NoAlert(se,uCode);
			},
			btn2:function(i){
				parent.parent.layer.close(i);
				NoAlert(se,uCode);
				login_check();
			},success: function(i){
				if(type.toLowerCase() =='bhost') $('#layer_div').parent().remove();
				else{
					$('#layer_div').iCheck({
						checkboxClass: 'icheckbox_minimal-blue',
						radioClass: 'iradio_minimal-blue',
						increaseArea: '0' // optional
					});
					$('.layer-alert .warning').css('height',"110px");
				}
			}
		});
	}else{
		login_check();
	}
}

function repeat_get_usb_status(sesstime){
	var st = 0;
	$.ajax({
		url: "/bhost/repeat_get_usb_status",
		type:"POST",
		async:false,		
		data:{z1:sesstime},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				st = result.info;
			}else{
				_alert(1,"系统用户",result.ErrMsg);
				return false;
			}
		}
	})
	return st;
}
var loadLayer =0;
function _showLoading(text){
	var st = text || "";
	loadLayer = layer.open({
		title:false,
		closeBtn:false,
		content:'<div id="Loading">'+st+'</div>',
		btn:false,
		skin:'loadingbar',
		area:['150px','180px'],
		move:false,
		resize:false,
		isOutAnim: false,
		shade:[0.1,'#000']
	})
}

function _closeLoading(){
layer.close(loadLayer);
}

function check_init_pwd(){
	$.ajax({
		url:"/bhost/check_init_pwd",
		async:false,
		type:"POST",
		data:{a0:uCode,a1:encode64(pW)},
		success:function(Result){	
			mm = $.md5(Result);
			Result = JSON.parse(Result);
			document.frm.ht.value = Result.htime;
			document.frm.mm.value = mm;
			
			if(Result.result == false){
				_alert(2,"用户登录",Result.ErrMsg);			
			}else{
				document.frm.a0.value=uCode;
				document.frm.a1.value=encode64(pW);
				document.frm.action = '/bhost/init_auth';
				document.frm.submit();
				return false
			}
		}
	})
}
function login_check(type,pW1,Separator,finger){
	/*if(type == 1){
		if(pW1 != ""){
			if(Separator == undefined){
				Separator = "";
			}
			pW1 += Separator;
			pW = pW1 + finger;
		}else{
			pW = finger;
		}
		//console.log(pW);
	}*/
	if(finger == undefined){
		finger = "";
	}
	if(pW != ""){
		pW = encode64(pW);
	}
	
	$.ajax({
		url:'/bhost/make_cache',
		type:"POST",
		async:false,
		success: function(Result) {
			data = JSON.parse(Result);
			start_time = data['start_time'];
			cnone = data['cnone'];
			sign = data['sign'];
		}
	})
	

	$.ajax({
		url:"/bhost/logincheck",
		async:true,
		type:"POST",
		data:{a0:uCode,a1:pW,m1:mac,i1:if_mac_limit,f1:finger,s1:start_time,c1:cnone,si:sign},
		success:function(Result){
			mm = $.md5(Result);
			Result = JSON.parse(Result);
			document.frm.ht.value = Result.htime;
			document.frm.mm.value = mm;
			//console.log(Result);
			//return false;
			if(Result.result == false){ //登陆失败
				$("#pW").blur();
				var index = layer.open({
					type: 1,
					title: '用户登录',
					content: '<div class="layer-alert"><i class="alert warning"></i>'+Result.info+'</div>',
					btn: ['确&nbsp;&nbsp;定'],
					btnAlign: 'c',
					area: ['380px'],
					yes: function(i) {
						if(Result.if_icode == true){ //失败后2次  显示验证码
							get_icode();				
						}
						if(Result.if_change_pwd == true){
							//修改密码
							_getDialog_change_pwd();
							
						}
						layer.close(i);
					},
					skin:'layer-custom',
					success: function(i){
						$(document).unbind('keydown').bind('keydown', function(e) {
							e = e || window.event;
							if(e.keyCode == 13) {
								var target = e.target || e.srcElment;
								if(target.id ==''){
									if($(".layui-layer-close").is(":visible")==true){
										layer.close(index);
									}
								}
							}
						});
					}
				});
			}else{
				// Result.end=0;
				if(Result.if_icode == true){ //显示验证码
					$('#verificationFrom').show();
					$('.buttom-list').show();
					$('#loginForm').hide();
					$(".login").hide();
					showHide();
					//document.frm.a0.value=Result.info;
				}else{		
					//document.frm.a0.value=Result.info;
					if(Result.auth_alert !=''){
						var index = layer.open({
							type: 1,
							title: '用户登录',
							content: '<div class="layer-alert"><i class="alert warning"></i>'+Result.auth_alert+'</div>',
							btn: ['确&nbsp;&nbsp;定'],
							btnAlign: 'c',
							area: ['380px'],
							yes:function(i){
								layer.close(i);
								//修改密码
								if(Result.auth_alert == '密码已过期，请修改密码' ) _getDialog_change_pwd();
								else{
									if(Result.end==1){
										//if(Result.ifChangeTotp == true){
										//	_getDialog2();							
									//	}else{
											document.frm.a10.value=Result.LastLoginTime;
											document.frm.submit();
										//}
									}else{					
										
                                                                                                document.frm.a10.value = Result.LastLoginTime;
										document.frm.action='/bhost/licensing_import'
										document.frm.submit();
									}
								}
							},
							skin:'layer-custom',
							success: function(i){
								$(document).unbind('keydown').bind('keydown', function(e) {
									e = e || window.event;
									if(e.keyCode == 13) {
										var target = e.target || e.srcElment;
										if(target.id ==''){
											if($(".layui-layer-close").is(":visible")==true){
												layer.close(index);
											}
										}
									}
								});
							}
						});					
					}else{				
						if(Result.end==1){
							//if(Result.ifChangeTotp == true){
							//	_getDialog2();							
						//	}else{
								
								document.frm.a10.value=Result.LastLoginTime;
								document.frm.submit();
							//}
						}else{					
							
                                                                        document.frm.a10.value = Result.LastLoginTime;
							document.frm.action='/bhost/licensing_import'
							document.frm.submit();
						}
					}
					
				}
			}
		}
	})
}

function showHide() {
	$(".cancle").on('click',function () {
        $('#verificationFrom').hide();
		$("#qr_code").val("");
        $('.buttom-list').hide();
        $('#loginForm').show();
        $(".login").show();
    })
}

function test_qrcode(){
	var uCode = $("#uCode").val().toLowerCase();
	var qr_code = $("#qr_code").val();
	if (qr_code == ""){
		$("#qr_code").blur();
		_alert(2,"用户登录","请输入验证码",$("#qr_code"));
		return false;
	}
	$.ajax({
		url: "/bhost/test_qr",
		type: "POST",
		async: false,
		data: {z1:uCode,z2:qr_code},
		success: function (result) {
			//console.log(result);
			var test_result = JSON.parse(result)
			if (test_result.Result){

				document.frm.submit();
				return false;
			}else{
				if (test_result.info == 2){
					$("#qr_code").blur();
					_alert(2,"用户登录","验证失败",$("#qr_code"));
					return false;
				}else{
					$("#uCode").blur();
					$('.btn').blur();		
					parent.layer.open({
						type:1,
						title:"用户登录",
						content:'<div class="layer-alert"><i class="alert fail"></i>验证失败，请重新登录</div>',
						btn:['确&nbsp;&nbsp;定'],
						btnAlign:'c',
						closeBtn: true,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						btn1:function(i){
							parent.layer.close(i);
							$("#uCode").val('');
							$("#pW").val('');
							$("#checkItem").hide();
							$("#vdcode").val('');
							$(".cancle").click();
							$("#uCode").focus();
						}
					});	
				}
			}
			/*
			if (result == "true"){
				document.frm.submit();
				return false;
			}else{
				alert("验证失败");
				return false;
			}
			*/
		}
	});
}

var secret='';
function _getDialog2(){
	
	var account_name =$("#uCode").val().toLowerCase();
	$.ajax({
		url: "/bhost/get_qrcode_img",
		type: "POST",
		async: true,
		data: {z1:account_name},
		success: function (result) {
			var result = JSON.parse(result);
			secret = result.secret;
			$("#qr_code_div").find('img').attr('src',result.img +'?m='+Math.floor(1000*Math.random()));
		}
	});
	var $dialogCont = $("#qr_code_div").show();
	
	d_qrcode = dialog({
		title:"TOTP",
		content:$dialogCont,
		id:"qr_code_div",
		width:"390px",
	}); 
	function addEventListener(ele,event,fn){
		if(ele.addEventListener){
			ele.addEventListener(event,fn,false);
		}else{
			ele.attachEvent('on'+event,fn.bind(ele));
		}
	}
	addEventListener(d_qrcode,'close',function () {
		$dialogCont.appendTo("body").hide();
	});
	/*
	d_qrcode.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});*/
	d_qrcode.showModal();
	$("#qr_code_div").parents(".ui-dialog-body").css("padding","20px 0px 20px 0px");
	$("#totp_v").val('');
	var iWidth=390; //弹出窗口的宽度;
	var iHeight=367; //弹出窗口的高度;
	var iTop = (document.documentElement.clientHeight-iHeight)/2; //获得窗口的垂直位置;
	var iLeft = (document.documentElement.clientWidth-iWidth)/2; //获得窗口的水平位置;
	$(".ui-popup.ui-popup-modal.ui-popup-show.ui-popup-focus").css("top",iTop).css("left",iLeft)
	//$('.ui-popup.ui-popup-modal.ui-popup-show.ui-popup-focus').css("top","216px").css("left","526px");
}
function submit_totp(){
	var totp_v = $("#totp_v").val();
	if (totp_v == ""){
		$(".btn").blur();
		_alert(1,"用户登录","请输入验证码",$("#totp_v"));
		return false;
	}
	$.ajax({
		url: "/bhost/test_qrcode",
		type: "POST",
		async: true,
		data: {z1:totp_v,z2:secret},
		success: function (result) {
			if (result == "true"){
				$(".btn").blur();
				d_qrcode.close().remove();
				init_totp = secret;
				next_auth();
				return false;
			}else{
				$(".btn").blur();
				_alert(1,"用户登录","TOTP验证失败",$("#totp_v"));
				return false;
			}
		}
	});
}

function change_sys_user_secret(){
	$.ajax({
		url:'/bhost/change_sys_user_secret',
		type:"POST",
		async:true,
		data:{a1:$("#uCode").val().toLowerCase(),a2:secret},
		//contentType: 'application/json',
		success: function(Result) {
			data = JSON.parse(Result);
			if (data.result){

				document.frm.submit();
			}
			else{
				_alert(1,"用户登录",'失败：'+data.ErrMsg);
			}
		}
	})
}

</script>
<script>

function send_sms(){
	if($('#send_id').attr('class').indexOf('disabled') >=0){
		return false;
	}
	var account_name =$("#uCode").val().toLowerCase();
	$.ajax({
		url: "/bhost/send_sms",
		type: "POST",
		async:true,
		data: {z1:account_name,f1:flag_sec},
		success: function (result) {
			var result = JSON.parse(result);
			if(result.Result == true){
				countdown = 30;
				settime();
			}else{
				_alert(1,"发送",'失败：'+result.ErrMsg);
			}
		}
	});
	
	
	
}
var findPwd_flag = false;
var flag_sec = 0;
function check_sms(){
	if(countdown != 0){
		return false;
	}
	findPwd_flag = false;
	if($("#uCode").val() == "" ){
		$('#div_sms').hide();
		$('#uCode').css("width","260px");
		return false;
	}
	$.ajax({
		url:"/bhost/check_sms",
		type:"POST",
		data:{a0:$("#uCode").val().toLowerCase()},
		success:function(result){
			result = JSON.parse(result);
			if(result.result == false){
				_alert(2,"用户登录",result.ErrMsg);
				return false;
			}else{
				if (result.info.is_sms == true && result.info.is_mail == true) flag_sec = 3;
				else if(result.info.is_mail == true) flag_sec = 2;
				else if(result.info.is_sms == true) flag_sec = 1;			
				else flag_sec = 0;
				if(result.info.is_sms == true || result.info.is_mail == true){ //短信认证 和 邮箱认证
					t = parseInt(new Date().getTime()/1000);
					////console.log(t);
					s = 30-(t -parseInt(result.info.VcodeCreateTime)) ;
					////console.log(s);
					if (s <=0 || s >= 30){
						countdown = 0;
					}else{
						countdown = s;
						settime();
					}
					$('#div_sms').show();
					$('#uCode').css("width","200px");
				}else{
					$('#div_sms').hide();
					$('#uCode').css("width","260px");
				}
				if(result.info.is_local == true){
					findPwd_flag = true;
					// t = parseInt(new Date().getTime()/1000);
					// s = 30-(t -parseInt(result.info.VcodeCreateTime2));
					// if (s <=0 || s >= 30){
					// 	countdown1 = 0;
					// }else{
					// 	countdown1 = s;
					// 	settime1();
					// }				
				}
			}			
		}
	})
	
}
var countdown=0;   
function settime(obj) {
    if (countdown == 0) {   
        $('#send_id').attr("class",'');      
        $('#send_id').html("发&emsp;送"); 
        return;  
    } else {   
        $('#send_id').attr("class",'disabled');  
		$('#send_id').html(countdown); 		
        countdown--;   
    }   
	setTimeout(function() {   
		settime() 
	}  
    ,1000)   
}  

function _getDialog_change_pwd(){
	$("#change_pwd_div input").val('');
	var $dialogCont = $("#change_pwd_div").show();
	
	d = dialog({
		title:"修改密码",
		content:$dialogCont,
		id:"change_pwd_div",
		width:"800px",
	}); 
	
	function addEventListener(ele,event,fn){
		   if(ele.addEventListener){
			   ele.addEventListener(event,fn,false);
		   }else{
			   ele.attachEvent('on'+event,fn.bind(ele));
		   }
	}
	addEventListener(d,'close',function () {
       location.href = '/bhost/';
   });
	d.showModal();
	
	
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		$("#change_pwd_div input").val('');
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		change_sys_u_pwd_new = $('#change_sys_u_pwd_new').val();
		change_sys_u_pwd_tr = $('#change_sys_u_pwd_tr').val();
		if(change_sys_u_pwd_new == ""){
			_alert(2,"修改密码","请输入密码",$('#change_sys_u_pwd_new'));
			return false;
		}
		if(change_sys_u_pwd_new != change_sys_u_pwd_tr){
			_alert(1,"修改密码","两次密码不匹配",$('#change_sys_u_pwd_new'));
			return false;
		}

		if (!PwdStrategy.PwdMinLen) PwdStrategy.PwdMinLen = 6;
		if(change_sys_u_pwd_new.length<PwdStrategy.PwdMinLen){
			_alert(1,"修改密码","密码长度必须大于或等于"+PwdStrategy.PwdMinLen+"位",$('#change_sys_u_pwd_new'));
			return false;
		}
		if(change_sys_u_pwd_new.length > 64){
			_alert(2, "修改密码", "密码不能超过系统限定64位", $("#change_sys_u_pwd_new"));
			return false;
		}
		if(PwdStrategy.IfPwdComplex){
			if(PwdStrategy.IfPwdIncLowerApha){
				var now=change_sys_u_pwd_new.search(/[a-z]/);
				if(now==-1){_alert(1,"修改密码","密码中请包含小写字母",$('#change_sys_u_pwd_new'));return false;}
			}
			if(PwdStrategy.IfPwdIncUpperApha){
				var now=change_sys_u_pwd_new.search(/[A-Z]/);
				if(now==-1){_alert(1,"修改密码","密码中请包含大写字母",$('#change_sys_u_pwd_new'));return false;}
			}
			if(PwdStrategy.IfPwdIncNumber){
				var now=change_sys_u_pwd_new.search(/[0-9]/);
				if(now==-1){_alert(1,"修改密码","密码中请包含数字",$('#change_sys_u_pwd_new'));return false;}
			}
			if(PwdStrategy.IfPwdIncSpecialChar){
				var now=change_sys_u_pwd_new.search(/[^A-Za-z0-9]/);
				if(now==-1){_alert(1,"修改密码","密码中请包特殊字符",$('#sys_u_pwd_new'));return false;}
			}
		}
		change_sys_u_pwd_new = $('#change_sys_u_pwd_new').val();
		//
		if(PwdStrategy.IfPwdUnRepeat == true) Repeat = PwdStrategy.PwdUnRepeat;
		else Repeat = 0;
		$.ajax({
			url: "/bhost/change_pwd",
			type: "POST",
			async:true,
			type:"POST",
			data:{a0:uCode,a1:change_sys_u_pwd_new,a2:Repeat},
			success: function (result) {
				var result = JSON.parse(result);
				if(result.Result == true){
					//_alert(0,"修改密码",'修改成功，请重新登录');
					var index = layer.open({
						type: 1,
						title: '修改密码',
						content: '<div class="layer-alert"><i class="alert succ"></i>修改成功，请重新登录</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						area: ['380px'],
						yes: function(i) {
						
							location.href='/';
						},
						skin:'layer-custom',
						success: function(i){
							$(document).unbind('keydown').bind('keydown', function(e) {
								e = e || window.event;
								if(e.keyCode == 13) {
									var target = e.target || e.srcElment;
									if(target.id ==''){
										if($(".layui-layer-close").is(":visible")==true){
											layer.close(index);
										}
									}
								}
							});
						}
					});
				}else{
					_alert(2,"修改密码",result.ErrMsg,$('#change_sys_u_pwd_new'));
					return false;
				}
			}
		});
		
		
	})
}

function getPwdStrategy(){
	$.ajax({
		url:'/bhost/get_pwdstrategy',
		type:"POST",
		async:true,
		data:{a0:''},
		success: function(Result) {
			data = JSON.parse(Result);
			PwdStrategy = data.info;
		}
	})
}

function ForgetPwd(type){
	switch(type){
		case 0:
			if(findPwd_flag == false && $("#uCode").val() != ""){
				_alert(2,"修改密码","该用户非本地认证,无法找回密码");
				return false;
			}
			$("#newAcc").val($("#uCode").val());
			$("#loginForm").hide();
			$("#findPwd").hide();
			$("button[type=button]").not("#send_id").eq(1).hide();
			$(".fp1").show();
			$("#uCode1").val("");
			$("#newPwd").val("");
			$("#newPwd1").val("");
			if($("#uCode").val() != ""){
				getType();
			}			
			break
		case 1:
			$("#loginForm").show();
			$("#findPwd").show();
			$("button[type=button]").not("#send_id").eq(1).show();
			$(".fp1").hide();
	}
}
var user_item = "";
function getType(){
	$('.btn button').blur();
	if($("#newAcc").is(":visible") == true){
		var Account = $("#newAcc").val();
		if(Account == ""){
			_alert(2,"修改密码","账号不能为空");
			return false;
		}
		$.ajax({
			url:"/bhost/check_sms",
			async:false,
			type:"POST",
			data:{a0:Account.toLowerCase()},
			success:function(result){
				result = JSON.parse(result);
				if(result.result == false){
					_alert(2,"修改密码",result.ErrMsg);
					return false;
				}else{
					if(result.info.is_local == true){
						findPwd_flag = true;
						t = parseInt(new Date().getTime()/1000);
						//console.log(t);
						s = 30-(t -parseInt(result.info.VcodeCreateTime2));
						//console.log(s);
						if (s <=0 || s >= 30){
							countdown1 = 0;
						}else{
							countdown1 = s;
							settime1($("#senducode"));
						}
					}else{
						_alert(2,"修改密码","该用户非本地认证,无法找回密码");
						return false;
					}
				}
			}
		})
		if(findPwd_flag == false) return false;
		user_item = "";
		$.ajax({
			url:"/bhost/get_userConf",
			type:"POST",
			async:false,
			data:{a1:Account},
			success:function(result){
				user_item = JSON.parse(result);
				if(user_item.Result == false){
					_alert(2,"修改密码",user_item.ErrMsg);
					$("#newAcc").val("");
					return false;
				}
				//user_item = user_item.info;
				if(user_item.Email == "" && user_item.MobilePhone == ""){
					_alert(2,"修改密码","用户未配置邮箱和手机");
					$("#select_content").html("");
					$(".select-result").text("请选择找回方式");
					return false;
				}else{
					var select_text = "";
					if(user_item.Email != ""){
						select_text = '<div class="select-item">邮箱</div>';
					}
					if(user_item.MobilePhone != ""){
						select_text += '<div class="select-item">短信</div>';
					}
					$("#select_content").html(select_text);
				}
			}
		})
		$('.select-item').unbind();
		$('.select-item').click(function (e) {
			var value=$(this).html();
			$('.selects').css('display','none');
			$('.form .item .select').css('background','url(../manage/images/select-bg.png) no-repeat 220px 0 transparent');
			$('.select-result').html(value);
			e.stopPropagation();
		})
	}
}
function fpSubmit(){
	$('.btn button').blur();
	var pwd_new1 = $("#newPwd").val();
	var pwd_new2 = $("#newPwd1").val();
	var account = $("#newAcc").val();
	var ucode = $("#uCode1").val();
	var Type1 = $(".select-result").text();
	if(account == ""){
		_alert(2,"修改密码","账号不能为空");
		return false;
	}
	if(Type1 == null || Type1 == "请选择找回方式"){
		_alert(2,"修改密码","请选择验证方式");
		return false;
	}	
	if(pwd_new1 == ""){
		_alert(2,"修改密码","请输入密码",$("#newPwd"));
		return false;
	}
	if(pwd_new1 != pwd_new2){
		_alert(1,"修改密码","两次密码不匹配",$('#newPwd'));
		return false;
	}

	if (!PwdStrategy.PwdMinLen) PwdStrategy.PwdMinLen = 6;
	if(pwd_new1.length<PwdStrategy.PwdMinLen){
		_alert(1,"修改密码","密码长度必须大于或等于"+PwdStrategy.PwdMinLen+"位",$('#newPwd'));
		return false;
	}
	if(pwd_new1.length > 64){
		_alert(2, "修改密码", "密码不能超过系统限定64位", $("#newPwd"));
		return false;
	}
	if(PwdStrategy.IfPwdComplex){
		if(PwdStrategy.IfPwdIncLowerApha){
			var now=pwd_new1.search(/[a-z]/);
			if(now==-1){_alert(1,"修改密码","密码中请包含小写字母",$('#newPwd'));return false;}
		}
		if(PwdStrategy.IfPwdIncUpperApha){
			var now=pwd_new1.search(/[A-Z]/);
			if(now==-1){_alert(1,"修改密码","密码中请包含大写字母",$('#newPwd'));return false;}
		}
		if(PwdStrategy.IfPwdIncNumber){
			var now=pwd_new1.search(/[0-9]/);
			if(now==-1){_alert(1,"修改密码","密码中请包含数字",$('#newPwd'));return false;}
		}
		if(PwdStrategy.IfPwdIncSpecialChar){
			var now=pwd_new1.search(/[^A-Za-z0-9]/);
			if(now==-1){_alert(1,"修改密码","密码中请包特殊字符",$('#newPwd'));return false;}
		}
	}
	if(PwdStrategy.IfPwdUnRepeat == true) Repeat = PwdStrategy.PwdUnRepeat;
	else Repeat = 0;
	$.ajax({
		url: "/bhost/check_ucode",
		type: "POST",
		async:false,
		type:"POST",
		data:{a0:account,a1:ucode,a2:pwd_new1,a3:Repeat},
		success: function (result) {
			result = JSON.parse(result);
			if(result.Result == true){
				var index = layer.open({
					type: 1,
					title: '修改密码',
					content: '<div class="layer-alert"><i class="alert succ"></i>修改成功，请重新登录</div>',
					btn: ['确&nbsp;&nbsp;定'],
					btnAlign: 'c',
					area: ['380px'],
					yes: function(i) {
						location.href='/';
					},
					skin:'layer-custom',
					success: function(i){
						ForgetPwd(1);
					}
				});
			}else{
				_alert(2,"修改密码",result.ErrMsg);
				return false;
			}
		}
	});
}
function fpCancle(){
	ForgetPwd(1);
}
function sendUcode(obj){
	$('.btn button').blur();
	var Account = $("#newAcc").val();
	var Type1 = $(".select-result").text();
	if(Account == ""){
		_alert(2,"修改密码","账号不能为空");
		return false;
	}
	if(Type1 == null || Type1 == "请选择找回方式"){
		_alert(2,"修改密码","请选择验证方式");
		return false;
	}
	if($(obj).attr('class').indexOf('disabled') >=0){
		return false;
	}
	var account_name = $("#newAcc").val().toLowerCase();	
	if(Type1 == "邮箱"){
		$.ajax({
			url: "/bhost/send_email",
			type: "POST",
			async:false,
			data: {z1:account_name,z2:user_item.Email},
			success: function (result) {
				var result = JSON.parse(result);
				if(result.Result == true){
					_alert(0,"修改密码","验证码发送成功,有效时间十分钟");
					countdown1 = 30;
					settime1(obj);
				}else{
					_alert(2,"修改密码","验证码发送失败");
				}
			}
		});
	}else if(Type1 == "短信"){
		$.ajax({
			url: "/bhost/send_sms1",
			type: "POST",
			async:false,
			data: {z1:account_name},
			success: function (result) {
				var result = JSON.parse(result);
				if(result.Result == true){
					_alert(0,"修改密码","验证码发送成功,有效时间十分钟");
					countdown1 = 30;
					settime1(obj);
				}else{
					_alert(2,"修改密码","验证码发送失败");
				}

			}
		});
	}
}

var countdown1=0;
function settime1(obj) {
	$('.btn button').blur();
	if (countdown1 == 0) {
		$(obj).attr("class",'');
		$(obj).html("发&emsp;送");
		return;
	} else {
		$(obj).attr("class",'disabled');
		$(obj).text(countdown1);
		countdown1--;
	}
	setTimeout(function() {
		settime1(obj)
	},1000)
}
</script>

</body>
</html>
