<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>manager</title>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<!--script-->
	<script src="/manage/js/jquery.min.js"></script>
	<script src="/manage/js/jquery.easing.js"></script>
	<script src="/manage/js/layer.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/common_e.js"></script>
	<!--icheck-->
	<script src="/manage/js/icheck.min.js"></script>
	<!--select2-->
	<script src="/manage/js/select2.full.min.js"></script>
	<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/G-style.css" type="text/css" />
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<script src="/manage/js/jquery.jedate.min.js"></script>
	<link rel="stylesheet" href="/manage/css/jedate.css">
	<script src="/manage/js/jquery.plugin.js"></script>
	<script src="/manage/js/jquery.datepick.js"></script>
	<link rel="stylesheet" href="/manage/css/jquery.datepick.css">
</head>
<body style="overflow:hidden;" class="bg-white">
	<!---->
	<div class="rwrap" style="/*padding: 0px 0px 28px;*/">
		<!---->
		<div class="mainer">
			
			<div class="container">
				<div class="c-top">
					<!--
					<div class="c-title">
						<a href="javascript:;" onclick="manage_auth();"><h3 class="unsel">访问授权</h3></a>
						<a href="javascript:;"><h3 onclick="manage_work();">工单授权</h3></a>
						<a href="javascript:;" onclick="cmd_auth();"><h3 class="unsel">指令授权</h3></a>
						<a href="javascript:;" onclick="manage_add();"><h3 class="unsel">管理授权</h3></a>
					</div>
					-->
					<div class="manual-head">
						{%if auth_flag1 != 0%}
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span id="manage_auth">访问授权</span>
							<i style="display: none;"></i>
						</div>
						{%endif%}
						<div class="manual-title-other title-item" id="frist">
							<span id="manage_work"> 工单授权</span>
							<i class="work_icon"></i>
						</div>
						{%if auth_flag3 != 0%}
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);">
							<span id="cmd_auth"> 指令授权</span>
							<i style="display: none;"></i>
						</div>
						{%endif%}
						{%if auth_flag4 != 0%}
						<div class="manual-title-other title-item" style="color: rgb(121, 121, 121);">
							<span id="manage_add"> 管理授权</span>
							<i style="display: none;"></i>
						</div>
						{%endif%}
					</div>
				</div>

				<div class="c-cont">
					<div class="c-wrap" style="padding: 0px 0px 28px;">
						<div class="c-table">
							<div class="tab-t">
								<div class="ctr" style="width: 288px;">
									{%if auth_flag2 == 1%}
									<a href="javascript:;" class="btn btn-default" onclick="creat_access();">创建</a>
									<a href="javascript:;" class="btn btn-default" onclick="delete_all();">删除</a>
									<a href="javascript:;" class="btn btn-default" onclick="select_all();">全选</a>
									{%endif%}
									<a href="javascript:;" class="btn btn-default" onclick="refresh();">刷新</a>
								</div>

								<div class="filter">
									<div class="search">
										<select name="" id="filter_select" class="filter-select" onchange="filter_change();">
											<option value="0">所有</option>
											<option value="1">名称</option>
											<option value="2">运维用户</option>
											<option value="3">用户组</option>
											<option value="4">权限配置</option>
											<option value="5">管理员</option>
											<option value="6">主机组</option>
											<option value="7">主机名</option>
											<option value="8">主机服务</option>
											<option value="9">账号</option>
											<option value="10">服务器范围</option>
											<option value="11">授权动作</option>
											<option value="12">状态</option>
											<option value="13">工单状态</option>
										</select>
										<input type="text" class="filter-text" placeholder="输入关键字" id="keyword" style="border-left:0;padding: 0 22px 0 4px;" onkeydown="if($('#keyword').val()==''){$('#text_check').hide();}else{$('#text_check').show();};if (event.keyCode == 13){_addFilter(this,false);return false;} else return;" onchange="if($('#keyword').val()==''){$('#text_check').hide();}else{$('#text_check').show();}" onkeyup="if($('#keyword').val()==''){$('#text_check').hide();}else{$('#text_check').show();}" onblur="change_input(this);">
										
										<i class="v-check v-wrong" id="text_check" onclick="_clear_keyword(this)" style="display:none;cursor: pointer;float: left;position: static;"></i>
										<button class="btn filter-btn" onclick="_addFilter(this,false)"><i class="add-filter"></i></button>
										<button class="btn filter-btn" onclick="_addFilter(this,true)"><i class="append-filter"></i></button>
									</div>
									<div class="search" id="clearFilter" style="margin: 0px 15px 0px -16px;display:none;">
										<button class="filter-btn" onclick="_clearFilter(this)"><i class="clear-filter"></i></button>
									</div>
									<div class="selector selector-multiple" id="filterWW" style="display: none;">
										<span class="ww">搜索条件</span>
										<ul></ul>
									</div>
								</div>
							</div>
							<div class="box-table">
							<table cellpadding="0" cellspacing="0" id="workorder_list">
								<thead>
									<tr><th style="width: 2px;"><input type="checkbox" class="form-checkbox" id="check_page"/></th>
										<th style="width: 42px;">优先级</th>
										<th style="width:60px">名称</th>
										<th style="width:56px">权限配置</th>
										<th id="ss_th">生效时间</th>
										<th id="gly_th" style="width:56px">管理员</th>
										<th style="width:56px">授权动作</th>
										<th style="width: 28px;">状态</th>
										<th style="width: 57px;">工单状态</th>
										{%if auth_flag2 == 1%}
										<th width="75"></th>
										{%else%}
										<th width="20"></th>
										{%endif%}
									</tr>
								</thead>

								<tbody>

								</tbody>
							</table>
							</div>
							<div class="tab-i">
								<div class="il">
									每页显示<span id="page_total">10</span>条 总数：<span id = "work_total">25</span>  选中：<span id = "select_total">0</span>
								</div>

								<div class="ipage">
									<a href="javascript:;" class="nav2 begin" onclick="firstpage()"><i></i></a>
									<a href="javascript:;" class="nav prev" onclick="prevpage()"><i></i></a>
									<input type="text" value="1" id="curpage" onchange="jumppage()">/&nbsp;<span id = "totalpage">25</span>
									<a href="javascript:;" class="nav next" onclick="nextpage()"><i></i></a>
									<a href="javascript:;" class="nav2 end" onclick="lastpage()"><i></i></a>
								</div>
							</div>
						</div>
						
						<div class="dialog-cont" id="WorkTime_suspend" style="display:none;">
							<div class="container">
								<div class="c-cont" style="max-height:145px;overflow:auto;">
									<div class="c-form c-form-host" style="min-width: auto;">
										<div class="clearfix"></div>

												<div class="form-item" style="width:100%;">
													<span class="form-tag" style="width: 10em;/*padding: 11px 8px 15px 14px;*/">工单时间生效时间：</span>
													<div class="form-c" style="float: left;width: 80px;padding-left: 0;">
														<select class="filter-select" name="" id="effective_time" style="width: 72px" onchange="change_effective_time(this);">
															<option value="1">范围</option>
															<option value="2">当前</option>
														</select>
													</div>
													<div class="bb-sel-item time-twin srItem" id="Effective_WorkOrder" style="margin-top: 0px;">
														<span class="stwrap">
															<input type="text" value="" id="sdate" placeholder="日期" class="datepicker" readonly>
															<input type="text" value="" id="shour" placeholder="时" class="timeinput" min="00" max="23" maxlength="2">
															<span class="srTip">:</span>
															<input type="text" value="" id="smin" placeholder="分" class="timeinput" min="00" max="59" maxlength="2">
															<span class="srTip">:</span>
															<input type="text" value="" id="ssec" placeholder="秒" class="timeinput" min="00" max="59" maxlength="2">
														</span>
														<span class="srTip">至</span>
														<span class="stwrap">
															<input type="text" value="" id="edate" placeholder="日期" class="datepicker" readonly>
															<input type="text" value="" id="ehour" placeholder="时" class="timeinput" min="00" max="23" maxlength="2">
															<span class="srTip">:</span>
															<input type="text" value="" id="emin" placeholder="分" class="timeinput" min="00" max="59" maxlength="2">
															<span class="srTip">:</span>
															<input type="text" value="" id="esec" placeholder="秒" class="timeinput" min="00" max="59" maxlength="2">
														</span>
													</div>
													<div class="" id="after_hour" style="display:none;">
														<span class="fix3">至</span>
														<input type="text" class="form-text" value="2" style="  width: 25px;padding: 0 8px 0 8px;text-align: center;" onblur="add_zero(this);" onfocus="this.select()" onkeyup="dataCheck(this, 0, 23);" maxlength="2">
														<span class="fix3">小时后</span>
													</div>
												</div>

											<div class="btns" style="padding: 10px 0 10px;">
												<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
												<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
											</div>
									</div>
								</div>
							</div>
						</div>
						<div class="clearfix"></div>
						<div class="btns">
							<a href="javascript:;" class="btn btn-normal s-hide" id="importUser" onclick="_import_user(1);">导&nbsp;&nbsp;入</a>
							<a href="javascript:;" class="btn btn-normal" onclick="_export_user(2);">导&nbsp;&nbsp;出</a>
						</div>
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn" style="float: right;" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
						<!--
						<div class="btns">
							<a href="javascript:;" class="btn btn-normal" onclick="back();">返&nbsp;&nbsp;回</a>
						</div>
						-->
					</div>
				</div>
			</div>
			<!--导入信息详情-->
			<div class="container6">
				<div id="importPage" style="display: none;">
					<div class="ap-top" id="">
						<div class="ctrl">
							<a href="javascript:;" class="re" onclick="_reloadDetail(2)" style="border-radius: 14px;"><i style="margin: 3px auto;margin-left: 8px;"></i></a>
							<!--<a href="javascript:;" class="close" onclick="_closeDetail(2)"><i></i></a>-->
						</div>
						<div class="types">
							<label>
								<input type="checkbox" name="" id="fail_IP_box" class="form-checkbox" >失败的授权
							</label>
						</div>
					</div>
					<div class="apWrap">
						<div class="title">
							<h2>导入详情</h2>
						</div>
						<div class="top">
							<div class="mm mm1">
								总数：<span>11</span> 成功数量：<span>11</span> 失败数量：<span>11</span>
							</div>
						</div>
						<div class="clearfix"></div>
						<div id="apArea1" style="height:auto;"></div>
						<div id="aploadTip1">正在加载</div>
					</div>
					<div id="bBtn" style="position: fixed;z-index:5;">
						<a href="javascript:;" class="btn" style="float: right;" onclick="_closeDetail(2)"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>
		
		<div class="dialog-cont" id="scDCTab2_import" style="display:none;">
			<div class="fsel" style="margin-left: 0;">
				<ul>
					<li><a class="active" href="javascript:;" id="task_import" onclick="set_tab(this,1);">授权导入</a></li>
					<li><a href="javascript:;" id="task_list_tab" onclick="set_tab(this,2);">任务列表</a></li>
				</ul>
			</div>
			<div class="container5">
				<div id="import_module" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;">
					<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
						<div class="tab-t c-form">
							<span class="form-tag">下载模板：</span>
							<div class="ctr" style="margin-left:6px;">
								<a class="btn" href="javascript:;" style="" onclick="_export_user(1);">下载</a>
							</div>
						</div>
						<div class="c-form" style="">
							<form id="uploadForm">
								<div class="form-item tab-t">
									<span class="form-tag"><em class="imp">*</em>选择文件：</span>
									<div class="form-c ctr" style="width:300px;padding:0 0 0 7px;">
										<div class="item" style="float: left;width:67%">
											<input id="file_v" name="file_v" class="form-text" type="text" style="float: left;width: 220px;">
											<input id="file_change" name="file_change" class="form-text" type="text" onclick="browes();" onchange="/*filetip(this);*/" style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;">
											<input id="file_change1" name="file_change1" class="form-text" type="file" onchange="filetip(this);" style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;display: none;">
										</div>
										<div class="item" style="float: left;width:33%">
											<a class="btn" href="javascript:;" style="margin-left: 70px;height: 26px;width:33px;" onclick="browes();">浏览</a>
										</div>
										<p class="form-tip" id="" style="margin-top: 28px;width: 243px;height: 32px;">特殊字符仅支持下划线、横杠、小数点</p>
									</div>
								</div>
							</form>
						</div>
						<div class="c-form">
							<span class="form-tag">覆盖：</span>
							<div style="width: 215px;margin-left: 200px;margin-top: 4px;">
								<input class="form-checkbox" id="cover_box1" type="checkbox"/>
								<span class="tip" style="color: #b2b2b2;">覆盖相同名称的授权</span>
							</div>
						</div>
						<div class="btns" style="">
							<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
						</div>
					</div>
				</div>
				<div id="details_module" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;display:none;">
					<div class="c-form" style="padding:0;width: auto;">
						<div class="c-wrap" style="padding:0;">
							<div class="c-table r-list" style="padding:0;">
								<div class="tab-t">
									<div class="ctr">
										<a href="javascript:;" class="btn btn-default" onclick="select_all_workorder()">全选</a>
										<a href="javascript:;" class="btn btn-default" onclick="del_hosttask_more()">删除</a>
										<a href="javascript:;" class="btn btn-default" onclick="fresh_task_list()">刷新</a>
									</div>
								</div>
								<div class="box-table" style="overflow: hidden;">
									<table cellpadding="0" cellspacing="0" id="usertask_list">
										<thead>
											<tr>
												<th width="50"><input type="checkbox" class="form-checkbox" id="check_task_page"/></th>
												<th>名称</th>
												<th width="42">成功数</th>
												<th width="42">失败数</th>
												<th width="56">状态</th>
												<th>错误信息</th>
												<th width="50"></th>
											</tr>
										</thead>
										<tbody>

										</tbody>
									</table>
								</div>
								<div class="tab-i">
									<div class="il">
										每页显示<span id="page_total_workorder">10</span>条 总数：<span id = "task_total_workorder">25</span>  选中：<span id = "select_total_workorder">0</span>
									</div>

									<div class="ipage">
										<a href="javascript:;" class="nav2 begin" onclick="turn_page(1);"><i></i></a>
										<a href="javascript:;" class="nav prev" onclick="turn_page(2)"><i></i></a>
										<input type="text" value="1" id="curpage_work" onchange="turn_page(5)">/ <span id = "totalpage_work">25</span>
										<a href="javascript:;" class="nav next" onclick="turn_page(3)"><i></i></a>
										<a href="javascript:;" class="nav2 end" onclick="turn_page(4)"><i></i></a>
									</div>
								</div>
							</div>

							<div class="clearfix"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 导出方式 浮层-->
	<div class="dialog-cont s-hide" id="export_type" style="display:none;">
		<div class="container">
			<div id="export_module" class="c-cont" style="min-height:350px;max-height:300px;overflow:hidden;">
				<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
					<span>方式：</span>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="all_check" value="all" name="exportType_radio" checked="checked"/>所有
					</label>
					<!-- <label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="resource_check" value="resource" name="exportType_radio"/>资源
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="acc_check" value="acc" name="exportType_radio"/>访问
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="work_check" value="work" name="exportType_radio"/>工单
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="cmd_check" value="cmd" name="exportType_radio"/>指令
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="manage_check" value="manage" name="exportType_radio"/>管理
					</label> -->
				</div>
				<div class="c-form" style="padding-bottom:10px;padding-left:50px;padding-top: 5px;">
					<span style="padding-right: 46px;"></span>
					<!-- <label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="all_check" value="all" name="exportType_radio" checked="checked"/>所有
					</label> -->
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="resource_check" value="resource" name="exportType_radio"/>资源
					</label>
					{%if auth_flag1 != 0%}
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="acc_check" value="acc" name="exportType_radio"/>访问
					</label>
					{%endif%}
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="work_check" value="work" name="exportType_radio"/>工单
					</label>
					{%if auth_flag3 != 0%}
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="cmd_check" value="cmd" name="exportType_radio"/>指令
					</label>
					{%endif%}
					{%if auth_flag4 != 0%}
					<label class="form-label" style="width: 60px;">
						<input type="checkbox" class="form-checkbox" id="manage_check" value="manage" name="exportType_radio"/>管理
					</label>
					{%endif%}
					</div>
				<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
					<span>格式：</span>
					<label class="form-label" style="width: 60px;">
						<input type="radio" class="form-radio" value=0 name="exportType_radio2" checked="checked"/>CSV
					</label>
					<label class="form-label" style="width: 60px;">
						<input type="radio" class="form-radio" value=1 name="exportType_radio2"/>XLS
					</label>
					<!--<label class="form-label" style="width: 60px;">
						<input type="radio" class="form-radio" value=2 name="exportType_radio2"/>XLSX
					</label>-->
				</div>
			</div>
			<div class="btns" style="/*padding: 20px 0 0px;*/">
				<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
			</div>
		</div>
	</div>
	<form action="/bhost/access_user_index" method="POST" name="frm_access">
		<input type="hidden" name="a0" id = "a0" value="" />
		<input type="hidden" name="a2" id = "a2" value="" />
		<input type="hidden" name="z1" id = "z1" value="" />
		<input type="hidden" name="z2" id = "z2" value="" />
		<input type="hidden" name="z3" id = "z3" value="" />
		<input type="hidden" name="z4" id = "z4" value="" />
		<input type="hidden" name="z5" id = "z5" value="" />
		<input type="hidden" name="z6" id = "z6" value="" />
		<input type="hidden" name="tasktype" id = "tasktype" value="" />
		<input type="hidden" name="us"  value="" />
		<input type="hidden" name="se"  value="" />
		<input type="hidden" name="user"  value="" />
		<input type="hidden" name="a99"  value="" />
	</form>
<style>
	.fsel {
                position: fixed;
                margin: -67px 0 0 -20px;
                width: 580px;
                height: 45px;
                background: #FFF;
        }
        .fsel ul li {
                float: left;
        }

        .fsel ul li a.active {
                border-top: 5px solid #4cb2d0;
                border-right: 1px solid #DDD;
                border-left: 1px solid #DDD;
                line-height: 41px;
                border-bottom: 1px solid #FFF;
        }
        .fsel ul li a {
                float: left;
                padding: 0 32px;
                line-height: 45px;
                font-size: 18px;
                color: #000;
        }
        .ui-dialog-body{
                padding: 20px 0 0 0;
        }
        #details_module table th {
                text-align:center
        }
        #details_module table td {
                text-align:center
        }
        #table_title th{
                text-align:center
        }
        #hosttask_list_detail td{
                text-align:center
        }
        #import_host_list_detail td{
                text-align:center
        }
        #importPage{
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: #f3f3f3;
			overflow: auto;
        }
        .apItem .label.succ:before{
			content: '';
			float: left;
			width: 20px;
			height: 20px;
			margin: 3px 14px 0 14px;
			background: url(/manage/images/user_succ.png) no-repeat 0 0;
        }
        .apItem .label.fail:before{
			content: '';
			float: left;
			width: 20px;
			height: 20px;
			margin: 3px 14px 0 14px;
			background: url(/manage/images/user_fail.png) no-repeat 0 0;
        }
        #filterWW_account:after{
			margin: 11px 0 0 34.5em;
        }
        .apItem {
			width: 50%;
			padding: 5px 0;
			overflow: hidden;
			transition: background-color 0.4s;
			float: left;
        }
</style>
<script>
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
</script>

<script>
$('.filter-select').select2({minimumResultsForSearch: -1});
</script>
<style>
.tab-ctr a.modify{
	cursor: pointer;
	display: inline-block;
    float: left;
    width: 16px;
    height: 16px;
    overflow: hidden;
    background: url(/manage/images/worktime.png) no-repeat 0 0;
    margin: 0 5px 0 4px;
}
.srItem .srTip{
	float: left;
	text-align: center;
	width: 24px;
	vertical-align: middle;
	padding: 0 5px 0 0;
}
.srItem input{
	height: 26px;
	background-color: #fff;
	border-radius: 5px;
}
.srItem {
	line-height: 28px;
	border-bottom:0;
	width: 436px;
    margin-top: 10px;
}
.tab-ctr a.disabled {
    opacity: 0.5;
    cursor: default;
}
.tab-ctr{
	margin-right: -15px;
    margin-left: -12px;
}
#usertask_list .tab-ctr {
	display: none !important;
}
#usertask_list tr:hover td div.tab-ctr {
	display: block !important;
}
</style>

<!---->
<script>
$(document).ready(function () {
	$("#manage_auth").on("click",function(){
		manage_auth();
	});
	$("#manage_work").on("click",function(){
		manage_work();
	});
	$("#cmd_auth").on("click",function(){
		cmd_auth();
	});
	$("#manage_add").on("click",function(){
		manage_add();
	});
})
var selectid = {{selectid|safe}};
var nameReg = /^[_\-.\n\w\u4e00-\u9fa5]*$/;
var now = "{{now}}";
var tasktype="{{tasktype}}";
var keyword_re = {{keyword|safe}};
var manage_filter_flag = {{manage_filter_flag}};
var se;
//var auth_power;
$(function(){
	
	var screenWidth = window.screen.width;
	if(screenWidth < 1440){
		$('#ss_th').removeAttr('style');
		$('#gly_th').css('width',"56px");
	}else{
		$('#ss_th').css('width',"300px");
		$('#gly_th').removeAttr('style');
	}
	
	se = window.parent.document.frm.se.value;
	var select_str = '<select name="" id="select_two" class="filter-select"></select>'
	$("#filter_select").next().after(select_str);
	$("#select_two").select2({minimumResultsForSearch:-1});
	$("#select_two").next('span').find('span.select2-selection').css({"border-bottom-left-radius":"1px","border-top-left-radius":"1px","margin-left":"-1px"});
	$("#select_two").hide();
	$("#select_two").next().hide();
	if (keyword_re != "" && keyword_re != "None"){
		var key_len = keyword_re.length;
		$.each(keyword_re,function(i,item){
			var filter = item.split('-');
			var index = item.indexOf('-');
			var key_v = item.substring(index + 1);
			filter_value = filter[0];
			if (filter_value == '0'){
				filter_v = key_v;
			}else{
				filter_name = filter_json[filter_value];
				if (filter_value == '11'){
					var select_v = key_v;
					if (key_v == "1"){
						key_v = "允许";
					}else if (key_v == "2"){
						key_v = "拒绝";
					}
				}else if (filter_value == '12'){
					var select_v = key_v;
					if (key_v == "true"){
						key_v = "启用";
					}else if (key_v == "false"){
						key_v = "停用";
					}
				}else if (filter_value == "13"){
					var select_v = key_v;
					if (key_v == "2"){
						key_v = "申请";
					}else if (key_v == "4"){
						key_v = "已过期";
					}else if (key_v == "5"){
						key_v = "同意";
					}else if (key_v == "6"){
						key_v = "拒绝";
					}
				}
				filter_v = filter_name + '-' + key_v;
			}
			if (manage_filter_flag == 1){
				if (key_len == 1){
					$("#filter_select").val(filter_value).trigger('change');
					if (filter_value == '11' || filter_value == '12' || filter_value == "13"){
						$("#select_two").show();
						$("#select_two").next().show();
						$("#select_two").val(select_v).trigger('change');
					}else{
						$("#keyword").val(key_v);
						$("#keyword").focus();
						$("#text_check").show();
					}
					keyword_v = item;
				}else{
					$("#filterWW").show();
					$("#clearFilter").show();
					if (i+1 != key_len){
						$("#filterWW ul").append("<li><span class=\"ww\">"+filter_v+"</span><i class=\"del\" onclick=\"_delFilter(this)\"></i></li>");
					}else{
						$("#filter_select").val(filter_value).trigger('change');
						if (filter_value == '11' || filter_value == '12' || filter_value == "13"){
							$("#select_two").show();
							$("#select_two").next().show();
							$("#select_two").val(select_v).trigger('change');
						}else{
							$("#keyword").val(key_v);
							$("#keyword").focus();
							$("#text_check").show();
						}
						keyword_v = item;
					}
				}
			}else{
				$("#filterWW").show();
				$("#clearFilter").show();
				$("#filterWW ul").append("<li><span class=\"ww\">"+filter_v+"</span><i class=\"del\" onclick=\"_delFilter(this)\"></i></li>");
				keyword_v = "";
			}
		});
		if (now != "" && now != "None"){
			$('#curpage').val(now);
			order_flag = (parseInt(now)-1)*10;
		}
		get_workorder_list();
	}else{
		if (now != "" && now != "None"){
			$('#curpage').val(now);
			order_flag = (parseInt(now)-1)*10;
		}
		get_workorder_list();
	}
})


/*
**
**import-->18/3/16
**
*/
/*
导入浮层
*/
function _initSize(){
	return false;
	var h = $(window).height();
	$('.h-catelog').height(h-200);
	$('.h-content').height(h-220);
	$('.h-content').width($('.h-explorer').width()-$('.h-catelog').width() - 33);
	$('div.container div.h-content').width($('div.container div.h-explorer').width()-$('.h-catelog').width() - 33);
}

function _closeDetail(type) {
	if (type == 1){
			$('#allPage').hide();
	}else{
			$('#importPage').hide();
	}
	$(".container").show();
	_import_user(1);
	$("#task_list_tab").click();
}
function _reloadDetail(type) {
	$('#apArea1').empty();
	$('#aploadTip1').html('正在加载').hide();
	page = 0;
	ppage = 0;
	append_flag = 0;
	row_len = 0;
	hostip = "";
	remain_page = 0;
	page_flag = 0;
	same_page = 0;
	_initLoadData1();
}
function get_task_data(){
	$.ajax({
		url:'/bhost/get_workordertask_data',
		type:"post",
		async:false,
		data:{a0:se,a1:'null',a2:'null'},
		success:function(result){
			var result = JSON.parse(result);
			$.each(result.data,function(i,item){
					selectid_workorder.push(item.AuthImportTaskId);
			});
		}
	});
}

//全选任务
function select_all_workorder(){
	selectid_workorder=[];
	var select_total_workorder = $("#select_total_workorder").text();
	var task_total_workorder = $("#task_total_workorder").text();
	if (parseInt(select_total_workorder) == parseInt(task_total_workorder)){
		$("#usertask_list").find('input').iCheck('uncheck');
	}else{
		get_task_data();
		$("#usertask_list tbody input[type='checkbox']").each(function(){
			if (!$(this).prop("disabled")){
				$(this).iCheck('check');
			}
		})
	}
	$("#select_total_workorder").text(selectid_workorder.length);
}
//刷新任务
function fresh_task_list(){
	get_usertask_list();
	selectid_workorder = [];
	$("#details_module input[type='checkbox']").each(function(){
		$(this).iCheck('uncheck');
	});
	$("#select_total_workorder").text(0);
}

function delete_usertask(type,id){
	$.ajax({
		url:'/bhost/del_work_task',
		type:'post',
		async:false,
		data:{a0:se,a1:id},
		success:function(result){
			del_result = JSON.parse(result);
			if (del_result.Result){
				_alert(0,"授权任务","删除成功");
				$('div.tab-moreinfo-on').hide();
				return false;
			}else{
				_alert(1,"授权任务",del_result.ErrMsg);
				return false;
			}
		}
	})
}
function del_usertask_r(id){
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"授权任务",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		yes:function(i){
			parent.layer.close(i);
			delete_usertask(0,id);
			if($.inArray(parseInt(id),selectid_workorder)>=0){
				num = $("#select_total_workorder").text();
				num = parseInt(num)-1;
				$("#select_total_workorder").text(num);
				selectid_workorder.splice($.inArray(parseInt(id),selectid_workorder),1);
			}
			get_usertask_list();
		}
	});
}
//批量删除
function del_hosttask_more(){
	if (selectid_workorder.length == 0){
		_alert(2,"授权任务","请选择要删除的数据");
		return;
	}
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"授权任务",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
		btn:['确定','取消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			selectid_str = selectid_workorder.toString();
			delete_usertask(1,selectid_str);
			selectid_workorder=[];
			get_usertask_list();
		},
		btn2:function(i){
			parent.layer.close(i);
		}
	});
}

function filetip(obj){
	var c=$(obj).val();
	c = c.split("\\");
	var b = c[c.length-1];
	$('#file_v').val(b);
}
var setinterval=null;
function browes(){
	if(use_BH=='0'){
		$("#file_change1").click();
		return 0;
	}
	var referrer_arr=document.referrer.toString().split('/');
	referrer_arr.pop();
	var referrer=referrer_arr.join('/');
	var sesstimet = (new Date()).valueOf();
	var json_download = {
			"Type": "Upload",
			"Url": referrer,
			"Path": "/usr/storage/.system/upload/",
			"Filename": sesstimet+'',
			"Session": se,
			"sesstimet":sesstimet+''
	}
	var if_html_client = false;
	var base64_str = '';
	$.ajax({
			url: "/bhost/get_base64",
			type:"POST",
			async:false,
			data:{a0:window.parent.document.frm.se.value,z1:JSON.stringify(json_download)},
			success:function(result){
					var result=JSON.parse(result);
					if(result.Result){
							if_html_client = result.info;
							base64_str = result.b64;
					}else{
							_alert(1,"授权导出",result.ErrMsg); 
					}
			}
	})
	if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
	else{
		get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
		$('#YuFrame1').remove();
		$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
		$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
	}
	clearInterval(setinterval);
	setinterval=setInterval(function(){
		$.ajax({
			url: "/bhost/find_item_sql",
			type:"POST",
			async:false,
			data:{a0:window.parent.document.frm.se.value,a1:sesstimet},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
					if(result.info==null){

					}else{
						var info_arr=result.info.split('/');
						if(info_arr.length>1){
							$('#file_v').val(info_arr.pop());
							$('#file_change').val('/usr/storage/.system/upload/'+sesstimet);
						}else{
							if(result.info=='NULL'){
								$('#file_v').val('');
								$('#file_change').val('');
							}else{
								$('#file_v').val(result.info);
								$('#file_change').val('/usr/storage/.system/upload/'+sesstimet);
							}
						}
						
						clearInterval(setinterval);
					}
				}
			}
		});
	}, 3000);
}
var task_list_detail;
function _initLoadData() {
	var h1 = $('#allPage').height();
	var h2 = $('#apArea').height();
	var add = function() {
		if (h1 - 203 > h2){
			page++;
			get_data(page,10);
			h2 = $('#apArea').height();
		}else{
			clearInterval(if_select);
			return false;
		}
	}

	var if_select = setInterval(function(){
		if (h1 - 203 <= h2 || task_list_detail.totalrow <= 10){
			clearInterval(if_select);
			return false;
		}
		add();  
	},1000);

	add();
}
//var keyword_re=[];//搜索条件
var selectid_workorder = [];
function get_usertask_list(){
	var MAX_PAGE = 5;
	var cur = $("#curpage_work").val();
	$.ajax({
		url:'/bhost/get_workordertask_data',
		type:'post',
		async:false,
		data:{a0:se,a1:cur,a2:MAX_PAGE},
		success:function(result){
			task_list = JSON.parse(result);
			$("#usertask_list tbody").empty();
			var Status = "";
			var succcount;
			var FailCount;
			var ErrorLog;
			$.each(task_list.data,function(i,item){
				if(item.Status == 0){
					Status = "正在执行";
				}else if(item.Status == 1){
					Status = "执行完成";
				}else if(item.Status == 2){
					Status = "执行失败";
				}
				if (item.SuccCount == null){
					SuccCount = "";
				}else{
					SuccCount = item.SuccCount;
				}
				if (item.FailCount == null){
					FailCount = "";
				}else{
					FailCount = item.FailCount;
				}
				if (item.ErrorLog == null){
					ErrorLog = "";
				}else{
					ErrorLog = item.ErrorLog;
				}
				var HostCount = parseInt(SuccCount) + parseInt(FailCount);
				float_str = "<p>错误信息："+ErrorLog+"</p>";
				$("#usertask_list tbody").append('<tr>'+
				'<td width="50"><input type="checkbox" class="form-checkbox" value="'+item.AuthImportTaskId+'"/></td>'+
				'<td title="'+item.AuthImportTaskName+'">'+item.AuthImportTaskName+'</td>'+
				'<td title="'+SuccCount+'">'+SuccCount+'</td>'+
				'<td title="'+FailCount+'">'+FailCount+'</td>'+
				'<td title="'+Status+'">'+Status+'</td>'+
				'<td title="'+ErrorLog+'">'+ErrorLog+'</td>'+
				'<td width="50">'+
					'<div class=\"tab-ctr\">'+
					'<a href="javascript:;" class="icon7" id="edit" title="导入详情" data="'+item.AuthImportTaskName+'" data1="'+item.Status+'"onclick="task_detail(this,'+item.AuthImportTaskId+');"></a>'+
					'<a href=\"javascript:;\" class=\"del\" id=\"del\" title="删除任务" onclick=\"del_usertask_r('+item.AuthImportTaskId+')\"></a>'+				
					'</div><div class="tab-moreinfo">'+float_str+'</div></td></tr>');
			});
			$('.form-checkbox,.form-radio').iCheck({
				checkboxClass: 'icheckbox_minimal-blue',
				radioClass: 'iradio_minimal-blue',
				increaseArea: '0' 
			});
		}
	});
	tabArr1();
	$("#task_total_workorder").text(task_list.totalrow);
	totalpage = Math.ceil(parseInt(task_list.totalrow)/MAX_PAGE);
	if (totalpage < 1){
		totalpage = 1;
	}
	$("#totalpage_work").text(totalpage.toString());
	$("#page_total_workorder").text(MAX_PAGE);
	//<tr>中选择按钮进行设置
	$('#check_task_page').iCheck('uncheck');
	var check_page_flag = 0;
	$("#usertask_list tbody input[type='checkbox']").each(function(){
		if ($.inArray(parseInt(this.value), selectid_workorder) != -1){
			$(this).iCheck('check');
			check_page_flag++;
		}
	});
	if (check_page_flag == $("#usertask_list tbody input[type='checkbox']").length && check_page_flag != 0){
		$('#check_task_page').iCheck('check');
	}
	if (parseInt(cur) > totalpage){
		$("#curpage_work").val(totalpage);
		get_usertask_list();
	}
	var flag_id = 0;
	num = selectid_workorder.length;
	$("#select_total_workorder").text(num);
	$("#usertask_list tbody input[type='checkbox']").unbind().on("ifChanged",function(){
		if ($(this).is(":checked")){
			num = $("#select_total_workorder").text();
			num++;
			if (selectid_workorder.indexOf(parseInt(this.value)) == -1){
				selectid_workorder.push(parseInt(this.value))
			}
			$("#select_total_workorder").text(num);
		}else{
			num = $("#select_total_workorder").text();
			num--;
			selectid_workorder.splice($.inArray(parseInt(this.value),selectid_workorder),1);
			$("#select_total_workorder").text(num);
		}
		var check_num = 0;
		$("#usertask_list tbody input[type='checkbox']").each(function(){
			if (!$(this).prop("disabled")){
				check_num++;
			}
		})
		if ($("#usertask_list tbody").find('input[type=checkbox]:checked').length == check_num){
			$('#check_task_page').iCheck('check');
		}else{
			$('#check_task_page').iCheck('uncheck');
		}
	});
	$('#check_task_page').unbind().on('ifClicked',function(e){
		if(!$('#check_task_page').prop('checked')){
			$("#usertask_list tbody input[type='checkbox']").each(function(){
				$(this).iCheck('check');
			})
		}else{
			$("#usertask_list").children('tbody').find('input[type=checkbox]').iCheck('uncheck');
		}
	});
}
//切换导入/任务
function set_tab(obj,type){
	if (type == 1){
		$("#import_module").show();
		$("#details_module").hide();
	}else if(type == 2){
		$("#details_module").show();
		$("#import_module").hide();
	}
	$(obj).addClass("active").parent().siblings().children().removeClass("active");
	if (type == 2){
		clearInterval(if_ok);
		get_usertask_list();
		repeat_execute = function(){
			if_ok = setInterval(function(){
				get_usertask_list();
		},5000)}
		repeat_execute();
	}else{
		clearInterval(if_ok);
	}
	var w = $(window).width();
	_initSize();
}

var d;
var if_ok;
var if_ok_down;
var host_task_id;
var MAX_PAGE_T = 5;
function task_detail(obj,id){
	var filename = $(obj).attr('data');
	status = $(obj).attr('data1');
	var host_count = $(obj).attr('data2');
	var acct_count = $(obj).attr('data3');
	$("#hosttask_list_detail tbody").empty();
	$("#cover_box").iCheck('uncheck');
	$("#import_host_list_detail tbody").empty();
	$(".tab-moreinfo.tab-moreinfo-on").remove();
	$('#apArea').empty();
	$('#apArea1').empty();
	page = 0;
	ppage = 0;
	append_flag = 0;
	row_len = 0;
	remain_page = 0;
	page_flag = 0;
	same_page = 0;
	keyword_t = null;
	if (status == 0){
		_alert(2,"授权任务","该任务正在导入中");
		return false;
	}
	if (status == 2){//导入中断
		_alert(1,"授权任务","该任务发生错误");
		return false;
	}
	d.close().remove();
	var succ_flag = $(obj).parents('tr:first').children('td:eq(2)').text();
	var fail_flag = $(obj).parents('tr:first').children('td:eq(3)').text();
	clearInterval(if_ok);
	if (status == 1){//导入完成
		$("#fail_IP_box").iCheck('uncheck');
		$(".mm.mm1").children('span').eq(0).text(parseInt(succ_flag)+parseInt(fail_flag));
		$(".mm.mm1").children('span').eq(1).text(succ_flag);
		$(".mm.mm1").children('span').eq(2).text(fail_flag);
		host_task_IP_id = id;
		_initLoadData1();
		$("#fail_IP_box").on('ifChanged',function(){//仅显示导入失败的授权信息
			if ($(this).prop("checked")){
				keyword_t = 1;
			}else{
				keyword_t = null;
			}
			$('#apArea1').empty();
			page = 0;
			ppage = 0;
			append_flag = 0;
			row_len = 0;
			remain_page = 0;
			page_flag = 0;
			same_page = 0;
			_initLoadData1();
		});
		$(".container").hide();
		$('#importPage').show();
	}
}
function _initLoadData1() {
	var h1 = $('#importPage').height();
	var h2 = $('#apArea1').height();
	var add = function() {
		if (h1 - 203 > h2) {
			page++;
			var offsetrow = (page-1)*10;
			get_import_detail_user(host_task_IP_id,10,offsetrow);
			get_data_i(0);
			h2 = $('#apArea1').height();
		}else{
			clearInterval(if_select1);
			return false;
		}
	}
	var if_select1 = setInterval(function(){
		if (row_len < 10){
			clearInterval(if_select1);
			return false;
		}
		if (row_len == 10 && import_list_detail.totalrow == 10){
			clearInterval(if_select1);
			return false;
		}
		add();  
	},1000);
	
	add();
}
function get_data_i(type_add){
	if($("#apArea1").find('.apSort').length==0){
		$("#apArea1").append('<div class="apSort"></div>');
	}
	$('#aploadTip1').show();
	var html = '';
	var Status;
	var append_a = append_flag % 10
	var npage = 0;
	
	var page_i = -1;
	var page_re = 0;
	if (import_list_detail.data.length == 0){
		$('#aploadTip1').html('已全部加载').show();
		return false;
	}
	$.each(import_list_detail.data,function(i,item){
		html='';
		if (item.Status == 0){
				if (item.ErrorLog!=null && item.ErrorLog!=''){
					Status = "成功："+item.ErrorLog;
				}else{
					Status = "成功";
				}
				html += '<div class="apItem"><div class="label worksucc" title="'+item.AuthName+'" style="width:50%;     white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">' + item.AuthName + '</div><div class="cc" style="padding-left: 50%;"><table cellpadding="0" cellspacing="0"><tbody><tr><td style="width:153px;">' + Status + '<span class="a"></span></td></tr>';
		}else if (item.Status == 1){
				Status = "失败：" + item.ErrorLog;
				html += '<div class="apItem"><div class="label workfail" title="'+item.AuthName+'" style="width:50%;     white-space: nowrap;overflow: hidden;text-overflow: ellipsis; text-overflow: ellipsis;">' + item.AuthName + '</div><div class="cc" style="padding-left: 50%;"><table cellpadding="0" cellspacing="0"><tbody><tr><td style="width:153px;">' + Status + '<span class="a"></span></td></tr>';
		}
		html += '</tbody></table></div></div>';
		$("#apArea1").find('.apSort:last').append(html);
		html = '<div class="ap-pc"> 共' + import_list_detail.totalrow + '条</div>';
		$("#apArea1").find('.ap-pc:last').remove();
		$('#apArea1').append(html);
	});
	html = '<div class="ap-pc"> 共' + import_list_detail.totalrow + '条</div>';
	$("#apArea1").find('.ap-pc:last').remove();
	$('#apArea1').append(html);
	var maxPage = Math.floor(import_list_detail.totalrow / 10);

	var task_page = page - 1,
			num = 10;
	var pnum = (task_page * num + 1) + '-' + (task_page + 1) * num;
			if((task_page + 1) * num > import_list_detail.totalrow){
			pnum = (task_page * num + 1) + '-' + import_list_detail.totalrow;
	}
			if (task_page >= maxPage) {
			$('#aploadTip1').html('已全部加载').show();
			return;
	} else if (task_page < maxPage) {
			$('#aploadTip1').hide();
	}
	if(type_add<2){
		type_add++;
		_addData1(type_add);
	}
}
var append_flag = 0;
var ppage = 0;
var row_len = 0;
var remain_page = 0;
var page_flag = 0;
var same_page = 0;

var page = 0;

$('#importPage').scroll(function() {
	var wh = $('#importPage').height(),
		vh = $('#apArea1').height(),
		st = $('#importPage').scrollTop();

	if (wh + st >= vh) {
		_addData1(0);
	}
})

function _addData1(type_add) {
	if ($('#aploadTip1').is(':visible')) {
		return;
	}
	page++;
	var offsetrow = (page-1)*10;
	get_import_detail_user(host_task_IP_id,10,offsetrow);
	get_data_i(type_add);
}
//获取导入完成的详细信息
var import_list_detail;
var keyword_t;
function get_import_detail_user(id,limitrow,offsetrow){
	$.ajax({
		url:'/bhost/get_import_detail_manage_auth',
		type:'post',
		async:false,
		data:{'a0':se,'a1':id,'a2':keyword_t,a3:limitrow,a4:offsetrow},
		success:function(result){
			import_list_detail = JSON.parse(result);
			//import_list_detail.data.sort(import_list_detail);
		}
	});
}
function _import_user(type){
	$("#file_v").val('');
	$("#file_change").val('');$("#file_change1").val('');
	$("#pending_box").iCheck('uncheck');
	$("#cover_box1").iCheck('uncheck');
	var $dialogCont = $("#scDCTab2_import").show();
	d = dialog({
		title:"授权导入",
		content:$dialogCont,
		id:"scDCTab2_import",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
		if (if_ok == null){
		}else{
			clearInterval(if_ok);
		}
	});
	d.showModal();
	if (type == 1){
		$("#import_module").show();
		$("#details_module").hide();
		$("#task_import").addClass("active").parent().siblings().children().removeClass("active");
		_initSize();
	}
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
	$('.btn').focus();
		d.close().remove();
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if ($("#details_module").is(':visible')){
			d.close().remove();
			return false;
		}
		var cover_flag = 0;
		var pending_flag = 0;
		if ($("#file_v").val() == ""){
			_alert(2,"授权导入","请选择文件");
			return false;
		}
		var file_v = $("#file_v").val();
		var fileReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		if (!fileReg.test(file_v)){
			_alert(1,"授权导入","导入文件名称格式不正确");
			return false;
		}
		var len4=file_v.substr(file_v.length-4).toLowerCase();
		var len5=file_v.substr(file_v.length-5).toLowerCase();
		if ( len4!= ".csv" && len4!='.xls' && len5!='.xlsx'){
			_alert(1,"授权导入","导入文件格式不正确，只支持.CSV、.XLS、.XLSX格式文件");
			return false;
		}
		var file_name = file_v.substring(0,file_v.length-4);

		var file_exist = 0;
		var formData_f = new FormData($("#uploadForm")[0]);
		formData_f.append('a0',se);
		$.ajax({
			url:'/bhost/isexist_import_workorder',
			type:'post',
			data:formData_f,
			async: false,
			cache: false,
			contentType: false,
			processData: false,
			success:function(result){
				var is_r = JSON.parse(result);
				if (is_r.Result){
					file_exist = 0;
				}else{
					file_exist = 1;
					_alert(2,"授权导入","该任务已存在");
					return false;
				}
			}
		});
		if (file_exist == 1){
			return false;
		}
		if ($("#cover_box1").prop('checked')){
			cover_flag = 1;
		}else{
			cover_flag = 0;
		}
		var formData = new FormData($("#uploadForm")[0]);
		formData.append('a1',cover_flag);
		formData.append('a0',se);
		formData.append('a99',use_BH);

		$.ajax({
			url:'/bhost/import_data_workorder',
			type: 'POST',
			data: formData,
			async: false,
			cache: false,
			contentType: false,
			processData: false,
			success: function (result) {
				var result=JSON.parse(result)
				if (!result.Result){
					_alert(2,'授权导入',result.ErrMsg);
					return false;
				}
				$("#file_v").val('');
				$("#file_change").val('');$("#file_change1").val('');
				$("#cover_box1").iCheck('uncheck');
				$.ajax({
					url:'/bhost/get_workordertask_data',
					type:'post',
					async:false,
					data:{a0:se,a1:1,a2:5},
					success:function(result){
						var task_list_data = JSON.parse(result);
						var totalpage = Math.ceil(parseInt(task_list_data.totalrow)/MAX_PAGE_T);
						if (totalpage < 1){
							totalpage = 1;
						}
						// $("#curpage_work").val(totalpage);
						$("#curpage_work").val(1);
						set_tab($("#task_list_tab"),2);
					}
				});
				set_tab($("#task_list_tab"),2);
			}
		});
	});
}
var format=0;
function _export_user(type){
	if (type == 1){
		_export();
	}else{
		var $dialogCont = $("#export_type").show();	
		title="导出";
		var d = dialog({
			title:title,
			content:$dialogCont,
			id:"export_type",
			width:"700px",
		});
		d.addEventListener('close', function () {
			$dialogCont.appendTo("body").hide();
		});
		$('#all_check').unbind().on('ifChecked',function(){
			resource_check=$('#resource_check').is(':checked');
			acc_check=$('#acc_check').is(':checked');
			work_check=$('#work_check').is(':checked');
			manage_check=$('#manage_check').is(':checked');
			cmd_check=$('#cmd_check').is(':checked');
			if(!resource_check || !acc_check || !work_check || !cmd_check || !manage_check){
				$('#acc_check').iCheck('check');
				$('#resource_check').iCheck('check');
				$('#work_check').iCheck('check');
				$('#cmd_check').iCheck('check');
				$('#manage_check').iCheck('check');
			}
			
		}).on('ifUnchecked',function(){
			resource_check=$('#resource_check').is(':checked');
			acc_check=$('#acc_check').is(':checked');
			work_check=$('#work_check').is(':checked');
			manage_check=$('#manage_check').is(':checked');
			cmd_check=$('#cmd_check').is(':checked');
			if(resource_check && acc_check && work_check && manage_check && cmd_check){
				$('#acc_check').iCheck('uncheck');
				$('#resource_check').iCheck('uncheck');
				$('#work_check').iCheck('uncheck');
				$('#cmd_check').iCheck('uncheck');
				$('#manage_check').iCheck('uncheck');
			}
		});
		$('#resource_check').unbind().on('ifChecked',function(){
			if ($('#resource_check').is(':checked') && $('#acc_check').is(':checked') && $('#work_check').is(':checked') && $('#cmd_check').is(':checked') && $('#manage_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		}).on('ifUnchecked',function(){
			$('#all_check').iCheck('uncheck');
		});
		$('#acc_check').unbind().on('ifChecked',function(){
			if ($('#resource_check').is(':checked') && $('#acc_check').is(':checked') && $('#work_check').is(':checked') && $('#cmd_check').is(':checked') && $('#manage_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		}).on('ifUnchecked',function(){
			$('#all_check').iCheck('uncheck');
			
		});
		$('#work_check').unbind().on('ifChecked',function(){
			if ($('#resource_check').is(':checked') && $('#acc_check').is(':checked') && $('#work_check').is(':checked') && $('#cmd_check').is(':checked') && $('#manage_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		}).on('ifUnchecked',function(){
			$('#all_check').iCheck('uncheck');
		});
		$('#cmd_check').unbind().on('ifChecked',function(){
			if ($('#resource_check').is(':checked') && $('#acc_check').is(':checked') && $('#work_check').is(':checked') && $('#cmd_check').is(':checked') && $('#manage_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		}).on('ifUnchecked',function(){
			$('#all_check').iCheck('uncheck');
		});
		$('#manage_check').unbind().on('ifChecked',function(){
			if ($('#resource_check').is(':checked') && $('#acc_check').is(':checked') && $('#work_check').is(':checked') && $('#cmd_check').is(':checked') && $('#manage_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		}).on('ifUnchecked',function(){
			$('#all_check').iCheck('uncheck');
		});
		$('#all_check').iCheck('uncheck');
		$('#acc_check').iCheck('uncheck');
		$('#resource_check').iCheck('check');
		$('#work_check').iCheck('check');
		$('#cmd_check').iCheck('uncheck');
		$('#manage_check').iCheck('uncheck');
		$('input[name=exportType_radio2][value=0]').iCheck('check');
		d.showModal();
		$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
			d.close().remove();
			parent.layer.open({
				type: 1,
				title: '工单授权',
				content: '<div class="layer-alert"><i class="alert warning"></i>是否导出</div>',
				btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					var exportType=[];
					format=$("#export_type").find("input[name=exportType_radio2]:checked").val();
					if($('#resource_check').is(':checked')){
						exportType.push('resource');
					}
					if($('#acc_check').is(':checked')){
						exportType.push('acc');
					}
					if($('#work_check').is(':checked')){
						exportType.push('work');
					}
					if($('#cmd_check').is(':checked')){
						exportType.push('cmd');
					}
					if($('#manage_check').is(':checked')){
						exportType.push('manage');
					}
					// if($('#all_check').is(':checked')){
					// 	exportType.push('all');
					// }
					exportType=exportType.join(',');
					parent.layer.close(i);
					$.ajax({
						url:'/bhost/export_data_workorder',
						type:'post',
						async:false,
						data:{a0:se,z2:exportType,z3:format},
						success:function(result){
							var result_arr=result.split(':');
							if (result.split(':')[0]=='true'){
								var file_name=result.split(':')[1]
							}else{
								var result=JSON.parse(result);
								if(!result.Result){
									_alert(1,"授权导出",result.info);
									return false;
								}
							}
							_showLoading();
							repeat_get = function(){
								if_ok_down = setInterval(function(){
									get_down_ok(file_name);
								},5000)}
							repeat_get();
						}
					});				
				},
				btn2:function(i){
					parent.layer.close(i);
				}
			})
		});
	}
}
var use_BH=window.parent.parent.document.frm.use_BH.value;
function get_down_ok(file_name){
	$.ajax({
		url:'/bhost/get_down_ok_workorder',
		type:'post',
		async:false,
		data:{a0:se,a1:format,a2:file_name},
		success:function(result){
			var down_result = JSON.parse(result);
			if (down_result.Result){
				clearInterval(if_ok_down);
				if (down_result.ErrMsg != "None"){
						_alert(1,"授权导出",down_result.ErrMsg);
						return false;
				}
				_closeLoading();
				if(use_BH=='0'){
					document.frm_access.action='/bhost/download_file_workorder';
					document.frm_access.a0.value = se;
					document.frm_access.z1.value = format;
					document.frm_access.a99.value = use_BH;
					document.frm_access.a2.value = down_result.file_name;
					document.frm_access.submit();
					return 0;
				}
				
				$.ajax({
					url:'/bhost/download_file_workorder',
					type:'post',
					async:false,
					data:{a0:se,z1:format,a99:use_BH,a2:down_result.file_name},
					success:function(result){
						var result=JSON.parse(result);
						//console.log(result);
						if(result.Result){
							var sesstimet = (new Date()).valueOf();
							//console.log(sesstimet);
							var referrer_arr=document.referrer.toString().split('/');
							referrer_arr.pop();
							var referrer=referrer_arr.join('/');
							var json_download = {
									"Type": "Download",
									"Url": referrer,
									"Path": result.path,
									"Filename": result.filename,
									"Session": se,
									"sesstimet":sesstimet,
									"Filenewname": result.filenewname
							}
							//console.log(json_download);
							var if_html_client = false;
							var base64_str = '';
							$.ajax({
									url: "/bhost/get_base64",
									type:"POST",
									async:false,
									data:{a0:se,z1:JSON.stringify(json_download)},
									success:function(result){
											var result=JSON.parse(result);
											if(result.Result){
													if_html_client = result.info;
													base64_str = result.b64;
											}else{
													_alert(1,"授权导出",result.ErrMsg); 
											}
									}
							})
							if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
							else{
								get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
								$('#YuFrame1').remove();
								$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
								$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
							}
						}
					}
				});
				/*
				$.ajax({
							url:'/bhost/del_workorder_file',
							type:'post',
							async:false,
							data:{a0:se,a1:format},
							success:function(result){
					}
				})
				*/
	                }
	        }
	});
}
//弹窗列表绑定
function tabArr1(){
	$('table').unbind();
	var tout,tin;
	var $cloneItem;
	var z = false;

	$('#usertask_list').on('mouseover','tbody>tr',function(){
		document.onclick = null;
	}).on('mouseout','tbody>tr',function(){
		document.onclick = function(){
			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
		}
	}).on('click','tbody>tr',function(e){           
		x=e.target;
		if(x.id=='del'){
			return false;
		}
		if(x.id=='edit'){
			return false;
		}
		document.onclick = null;

		var $this = $(this);
		var $tr = $this;
		var oset = $tr.offset();
		var trc = $tr.attr('class');
		if(trc && trc.indexOf('on') >=0 ){
			$('div.tab-moreinfo-on').hide();
			$('div.tab-moreinfo-on').remove();
			$('tr.on').removeClass('on');
			return;
		}

		$('div.tab-moreinfo-on').hide();
		$('tr.on').removeClass('on');
		$tr.addClass('on');

		var $box = $this.parents('div.box-table');
		var boxh = $box.outerHeight(), boxo = $box.offset();

		var $item = $this.children('td:last').children('div.tab-moreinfo');
		var ih = $item.outerHeight(),th = $tr.outerHeight();
		$cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');
		if(boxh < oset.top-boxo.top + ih + th - 40 ){
			$cloneItem.css({
				top:oset.top - ih,
				left:oset.left,
				width:$tr.outerWidth() - 1,
				opacity:0,
				display:'block'
			}).stop().animate({
				opacity:1
			});
		}else{
			$cloneItem.css({
				top:oset.top + $tr.outerHeight() + 1,
				left:oset.left,
				width:$tr.outerWidth() - 1,
				opacity:0,
				display:'block'
			}).stop().animate({
				opacity:1
			});
		}
		//$cloneItem.prev('div').remove();
		z_v = $cloneItem.prev('div').css('z-index');
		$cloneItem.css('z-index',z_v+1);
	});
	$('.box-table,body,.c-cont2,.c-cont').on('scroll',function(){
		$('div.tab-moreinfo-on').remove();
		$('tr.on').removeClass('on');
	})
	
	//var len = $('.tab-ctr:first').children('a').length;
	var len = 2;
	$('#usertask_list>thead>tr>th:last').width(len*26);
}

//任务列表翻页
function turn_page(type){
	switch (type){
		case 1: //首页
			$("#curpage_work").val(1);
			break;
		case 2://上一页
			var cur = $("#curpage_work").val();
			if (cur == '1'){
			        return false;
			}else{
			        $("#curpage_work").val((parseInt(cur)-1));   
			}
			break;
		case 3://下一页
			var cur = $("#curpage_work").val();
			var total = $("#totalpage_work").text();
			if (cur == total){
			        return false;
			}else {
			        $("#curpage_work").val((parseInt(cur)+1));
			}
			break;
		case 4:
			$("#curpage_work").val($("#totalpage_work").text());
			break;
		case 5:
			var cur = $("#curpage_work").val();
			var numReg = /\D/;
			if (numReg.test(cur) || parseInt(cur) < 1 || cur == ''){
			        $("#curpage_work").val(1);
			}
			break;
		default:
			;
	}
	get_usertask_list();
}
function _export(){
        var data = [
	// ['类型'],
	// ['协议','*协议名称','*端口','描述'],
	// ['','特殊字符仅支持下划线、横杠','0-65535之间'],
	// [''],
	// [''],
	// [''],
	// ['AD域','*AD域名称','*服务器IP'],
	// ['','特殊字符仅支持下划线、横杠、小数点','0.0.0.0-255.255.255.255之间'],
	// [''],
	// [''],
	// [''],
	// ['连接参数','*连接参数名称','*协议','配置'],
	// ['','特殊字符仅支持下划线、横杠、小数点','RDP/SSH/ORACLE/MSSQL/MYSQL/HTTP(S)/TELNET/FTP/VNC/X11/RADMIN/SYBASE/DB2/RLOGIN/PCANY/TN5250','TELNET/FTP/VNC/X11/RLOGIN/PCANY/TN5250协议，配置为空即不填'],
	// ['','','','RDP：1.访问方式：NORMAL/CONSOLE；2.格式：访问方式'],
	// ['','','','SSH：1.版本号：1/2；2.格式：版本号'],
	// ['','','','ORACLE：1.指定：SID/SERVICE_NAME；2.实例名或服务名：不能含有特殊字符；3.连接方式：未指定/NORMAL/SYSDBA/SYSOPER；4.格式：指定|实例名/服务名|连接方式'],
	// ['','','','MSSQL：1.实例名：不能含有特殊字符；2.认证方式：未指定/SQL服务器验证/Windows验证/Windows单一登录；3.格式：实例名|认证方式'],
	// ['','','','MYSQL/DB2：1.数据库名：不能含有特殊字符；2.格式：数据库名'],
	// ['','','','SYBASE：1.实例名：不能含有特殊字符；2.格式：实例名'],
	// ['','','','HTTP(S)：1.URL；2.账号元素：不能含有特殊字符；3.密码元素：不能含有特殊字符；4.提交元素；5.格式：URL|账号|密码|提交元素'],
	// ['','','','RADMIN：1.认证方式：未指定/RADMIN/Windows；2.格式：认证方式'],
	// [''],
	// [''],
	// [''],
	// ['邮件','*邮件名称','*服务器地址','*发送邮箱地址','*服务器账号','*服务器验证','*附件大小','*编码方式','*方式'],
	// ['','特殊字符仅支持下划线、横杠、小数点','0.0.0.0-255.255.255.255之间','邮箱格式','','密码/否','数字','UTF-8/GBK（默认：UTF-8）','默认/备用/其他（默认：其他）'],
	// [''],
	// [''],
	// [''],
	// ['短信网关','*短信网关名称','*数据库类型','*服务器地址','*端口','*账号','*密码','*数据库','*短信sql语句模板','*编码方式','*方式'],
	// ['','特殊字符仅支持下划线、横杠、小数点','ORACLE/MSSQL/MYSQL/SYSBASE','0.0.0.0-255.255.255.255之间','0-65535之间','','','','包含\'%phone%\'、\'%content%\'','UTF-8/GBK（默认：UTF-8）','默认/备用/其他（默认：其他）'],
	// [''],
	// [''],
	// [''],
	// ['SYSLOG','*SYSLOG名称','*服务器地址','*端口','*编码方式','*方式'],
	// ['','特殊字符仅支持下划线、横杠、小数点','0.0.0.0-255.255.255.255之间','0-65535之间','UTF-8/GBK（默认：UTF-8）','默认/备用/其他（默认：其他）'],
	// [''],
	// [''],
	// [''],
	// ['SNMP','*SNMP名称','*服务器地址','*端口','*编码方式','*方式'],
	// ['','特殊字符仅支持下划线、横杠、小数点','0.0.0.0-255.255.255.255之间','0-65535之间','UTF-8/GBK（默认：UTF-8）','默认/备用/其他（默认：其他）'],
	// [''],
	// [''],
	// [''],
	// ['事件告警','*事件告警名称','描述','*等级','*类型','*方式','默认','备用','接收者已定义','接收者自定义'],
	// ['','特殊字符仅支持下划线、横杠、小数点','方式不为空时，必填','无/低/中/高（默认：无）','无/违规操作/高危操作/登录异常（默认：无）','无/邮件/短信/SNMP/SYSLOG（默认：无）','仅限邮件、短信','仅限邮件、短信','仅限邮件、短信','仅限邮件、短信'],
	// [''],
	// [''],
	// [''],
	// ['审批策略','*审批策略名称','短信默认','短信备用','邮件默认','邮件备用','*审批者','*审批人数'],
	// ['','特殊字符仅支持下划线、横杠、小数点','','','','','','数字'],
	// [''],
	// [''],
	// [''],
	[
		// '客户端集合',
		'*客户端集合名称','IP地址','IP区间','MAC地址','MAC区间'],
	[
		// '',
		'特殊字符仅支持下划线、横杠、小数点','0.0.0.0-255.255.255.255之间','0.0.0.0-255.255.255.255','00:00:00:00:00:00-ff:ff:ff:ff:ff:ff之间','00:00:00:00:00:00-ff:ff:ff:ff:ff:ff'],
	// ['','','0.0.0.0-255.255.255.255'],
	// ['','','00:00:00:00:00:00-ff:ff:ff:ff:ff:ff之间'],
	// ['','','00:00:00:00:00:00-ff:ff:ff:ff:ff:ff'],
	// [''],
	// [''],
	// [''],
	[
		// '服务器集合',
		'*服务器集合名称','是否启用IP限制','IP地址','IP区间','主机组'],
	[
		// '',
		'特殊字符仅支持下划线、横杠、小数点','启用/不启用（默认：启用）','0.0.0.0-255.255.255.255之间','0.0.0.0-255.255.255.255','非按组授权主机组格式：/组1/组2/组3/*'],
	// ['','','0.0.0.0-255.255.255.255'],
	// ['','','非按组授权主机组格式：/组1/组2/组3/*'],
	['','','','按组授权主机组格式：/组1/组2/组3/'],
	// ['','','主机格式：/组1/组2/组3/主机a'],
	// [''],
	// [''],
	// [''],
	[
		// '工单授权',
		'*工单授权名称','启用授权','授权动作','*管理者','*用户/用户组','*对象指定/范围指定|自定义/已定义|所有/共有','*服务器','*协议','*账号','权限配置','登录审批','协同登录','访问备注','登录告警','RDP剪贴板上传','RDP剪贴板下载','RDP文件记录','磁盘映射上行、下行','键盘记录','SSH文件上传','SSH文件下载','SSH文件记录','FTP文件上传','FTP文件下载','FTP文件记录','*工单时间生效范围','客户端地址限制','客户端集合/范围','预处理命令','工单说明'],
	[
		// '',
		'特殊字符仅支持下划线、横杠、小数点','启用/不启用（默认：启用）','允许/拒绝（默认：允许）','','按组授权用户组格式：/组1/组2/组3/','对象指定格式：对象指定','范围指定时，格式：服务器集合名称','范围指定格式：协议|端口|账号','范围指定格式：账号1','','审批策略名称/否（默认：否）','是/否（默认：否）','是/否（默认：否）','事件告警名称/否（默认：否）','是/否（默认：是）','是/否（默认：是）','是/否（默认：否）',
	'0：不开启，1：开启上行，2：开启下行，3：全部开启（默认：全部开启，可填数字也可填中文）',
	'是/否（默认：是）',
	'是/否（默认：是）','是/否（默认：是）','是/否（默认：是）','是/否（默认：否）','是/否（默认：是）','是/否（默认：是）','是/否（默认：否）','范围 2018-03-06 20:40:50-2018-03-06 22:40:50','不限制/允许/例外|自定义/已定义（默认：不限制）','客户端集合名称','',''],
	[
		// '',
		'','','','','非按组授权用户组格式：/组1/组2/组3/*','范围指定格式：范围指定|已定义|所有','主机组格式：/组1/组2/组3/','范围指定时，服务所有，格式：[*]','范围指定时，账号所有，格式：[*]','','','','','','','','','','','','','','','','','当前 02 小时后','','0.0.0.0-255.255.255.255之间','',''],
	[
		// '',
		'','','','','用户名','','主机格式：192.168.0.1','对象指定时，按组、按主机，格式：*','对象指定时，按组、按主机，格式：*','','','','','','','','','','','','','','','','','','','0.0.0.0-255.255.255.255','',''],
	[
		// '',
		'','','','','','','','非按主机，格式：-','非按主机，格式：-','','','','','','','','','','','','','','','','','','','00:00:00:00:00:00-ff:ff:ff:ff:ff:ff之间','',''],
	[
		// '',
		'','','','','','','','协议1端口(连接参数名);协议2端口(连接参数名)','账号','','','','','','','','','','','','','','','','','','','00:00:00:00:00:00-ff:ff:ff:ff:ff:ff','',''],
	// [''],
	// [''],
	// [''],
        ]; 
        // var csvContent = "data:text/csv;charset=utf-8,\ufeff";
        var csvContent = "";
        // if (window.navigator.msSaveOrOpenBlob) {
        //         csvContent = "\ufeff";
        // }
        data.forEach(function(infoArray, index){
                dataString = infoArray.join(",");
                csvContent += index < data.length ? dataString+ "\n" : dataString;
        });
        if (window.navigator.msSaveOrOpenBlob) {
                // if browser is IE
                csvContent = "\ufeff"+csvContent;
				var blob = new Blob([decodeURIComponent(encodeURI(csvContent))],{
                        type: "text/csv;charset=utf-8;"
                });
                navigator.msSaveBlob(blob, '工单授权模板.csv');
        }else{
				csvContent = "data:text/csv;charset=utf-8,\ufeff"+csvContent;
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "工单授权模板.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
		}
}
/**
**
**/

function refresh_list(){
	if (keyword_re != "" && keyword_re != "None"){
		var key_len = keyword_re.length;
		$.each(keyword_re,function(i,item){
			var filter = item.substring(0,4);
			var filter_value = 0;
			if (filter == "工单名称"){
				filter_value = 1;
				$("#filterWW ul").append("<li><span class=\"ww\">"+item+"</span><i class=\"del\" onclick=\"_delFilter(this)\"></i></li>");
			}else{
				filter_value = 2;
				$("#filterWW ul").append("<li><span class=\"ww\">"+item+"</span><i class=\"del\" onclick=\"_delFilter(this)\"></i></li>");
			}
			if (i+1 == key_len){
				$("#filter_select").val(filter_value).trigger('change');
			}
		});
		
		//get_workorder_list();
		if (now != "" && now != "None"){
			$('#curpage').val(now);
			order_flag = (parseInt(now)-1)*10;
		}
		get_workorder_list();
	}else{
		if (now != "" && now != "None"){
			$('#curpage').val(now);
			order_flag = (parseInt(now)-1)*10;
		}
		get_workorder_list();
	}
}

//下一页
function nextpage(){
	var cpage = $("#curpage").val();
	var total = $("#totalpage").text();
	var npage = 0;
	if (total == cpage){
		return;
	}else{
		npage = parseInt(cpage)+1;
	}
	$("#curpage").val(npage);
	order_flag = parseInt(cpage)*10;
	get_workorder_list();
}

//上一页
function prevpage(){
	var cpage = $("#curpage").val();
	var ppage = 0;
	if (parseInt(cpage) == 1){
		return;
	}else{
		ppage = parseInt(cpage)-1;
	}
	$("#curpage").val(ppage);
	order_flag = (ppage-1)*10;
	get_workorder_list();
}
//首页
function firstpage(){
	$("#curpage").val(1);
	order_flag = 0;
	get_workorder_list();
}
//末页
function lastpage(){
	var cpage = $("#curpage").val();
	var lpage = $("#totalpage").text();
	if (cpage == lpage){
		return;
	}
	$("#curpage").val(lpage);
	order_flag = (parseInt(lpage)-1)*10;
	get_workorder_list();
}
//跳页
function jumppage(){
	var cur = $("#curpage").val();
	var numReg = /\D/;
	if (numReg.test(cur)){
		$("#curpage").val(1);
		cur = 1;
	}
	if (parseInt(cur) < 1 || cur == ""){
		$("#curpage").val(1);
		cur = 1;
	}
	order_flag = (parseInt(cur)-1)*10;
	get_workorder_list();
}

function compareTime(startDate, endDate) {   
	if (startDate.length > 0 && endDate.length > 0) {   
		var startDateTemp = startDate.split(" ");   
		var endDateTemp = endDate.split(" ");   

		var arrStartDate = startDateTemp[0].split("-");   
		var arrEndDate = endDateTemp[0].split("-");   

		var arrStartTime = startDateTemp[1].split(":");   
		var arrEndTime = endDateTemp[1].split(":");   

		var allStartDate = new Date(arrStartDate[0], arrStartDate[1], arrStartDate[2], arrStartTime[0], arrStartTime[1], arrStartTime[2	]);
		var allEndDate = new Date(arrEndDate[0], arrEndDate[1], arrEndDate[2], arrEndTime[0], arrEndTime[1], arrEndTime[2]);
		if (allStartDate.getTime() >= allEndDate.getTime()) {
			return 1;
		}else{
			return 2;
		}
	}else{
		return 0;
	}
}

var order_flag = 0;
function get_workorder_list(){
	var filter_name = $("#filter_select").val();
	var curpage = $("#curpage").val();
	$.ajax({
		url:'/bhost/get_workorder_z',
		type:'post',
		async:false,
		data:{a0:se,z1:MAX_PAGE,z2:curpage,z3:JSON.stringify(keyword_re)},
		success:function(result){
			work_list = JSON.parse(result);
			$("#workorder_list tbody").empty();
			var change_id = [];
			$.each(work_list.data,function(i,item){
				//if (item.Mode == 2){
					//运维用户
					var user = "";
					var ug = ""
					$(item.AuthUserSet).each(function(i1,item1){
						if (item1.Type == 1){
							user = user + item1.Name + ',';
						}else{
							ug = ug + item1.Name + ',';
						}
					});
					user = user.substring(0,user.length-1);
					ug = ug.substring(0,ug.length-1);
					var scope = "";
					$(item.AuthScope).each(function(i1,item1){
						if (item1.Type == '1'){
							scope = scope + item1.ServerScopeName + ',';
						}
					});
					scope = scope.substring(0,scope.length-1);
					var account = "";
					var protocol = "";
					var param = "";
					var account_array = [];
					var pro_array = [];
					var param_array = [];
					if (item.AuthAccountName == null){
						account = "";
					}else{
						var aname = item.AuthAccountName.split(',');
						$.each(aname,function(i1,item1){
							if (account_array.indexOf(item1) === -1){
								account_array.push(item1);
							}
							//account = account+item1+',';
						});
					}
					/*
					if (item.AuthServiceSet != null){
						$.each(item.AuthServiceSet,function(i1,item1){
							if (pro_array.indexOf(item1.ProtocolName) === -1){
								pro_array.push(item1.ProtocolName);
							}
							if (item1.ConnParamName != null){
								if (param_array.indexOf(item1.ConnParamName) === -1){
									param_array.push(item1.ConnParamName);
								}
							}
						});
					}
					//对象
					var obj_hg = "";//对象主机组;
					var obj_host = "";//对象主机;
					var host_array = [];
					if (item.AuthObject != null){
						$.each(item.AuthObject,function(i1,item1){
							if (item1.AccountId != null){
								if (account_array.indexOf(item1.AccountName) === -1){
									account_array.push(item1.AccountName);
								}
								if (pro_array.indexOf(item1.ProtocolName) === -1){
									pro_array.push(item1.ProtocolName);
								}
								//account = account + item1.AccountName + ',';
								//protocol = protocol + item1.ProtocolName + ',';
							}else if (item1.HostName != null){
								if (host_array.indexOf(item1.HostName + '('+item1.HostIP+')') === -1){
									host_array.push(item1.HostName + '('+item1.HostIP+')');
								}
								//obj_host = obj_host + item1.HostName + '('+item1.HostIP+')'+',';
							}else{
								obj_hg = obj_hg + item1.HGName + ',';
							}
						});
					}
					account = account_array.toString();
					protocol = pro_array.toString();
					param = param_array.toString();
					obj_hg = obj_hg.substring(0,obj_hg.length-1);
					obj_host = host_array.toString();
					*/
					var admin = "";
					$(item.AdminSet).each(function(i1,item1){
						admin = admin + item1.UserCode + ',';
					});
					admin = admin.substring(0,admin.length-1);
					
					var AccessStrategyName = "";
					var strategy_time ="";
					var end_time = "";
					if (item.AccessStrategyInfo != null){
						if (item.AccessStrategyInfo.AccessStrategyName.indexOf('#') != -1){
							AccessStrategyName = "";
						}else{
							AccessStrategyName = item.AccessStrategyInfo.AccessStrategyName;
						}
						strategy_time = strategy_time + item.AccessStrategyInfo.TimeSet[0].StartDate.substring(0,10) + ' ' + item.AccessStrategyInfo.TimeSet[0].StartTime + '至' + item.AccessStrategyInfo.TimeSet[0].EndDate.substring(0,10) + ' ' + item.AccessStrategyInfo.TimeSet[0].EndTime;
						end_time = item.AccessStrategyInfo.TimeSet[0].EndDate.substring(0,10) + ' ' + item.AccessStrategyInfo.TimeSet[0].EndTime;
					}
					
					if (item.Enabled == true){
						var enabled = "启用";
						//var e_class = "stop_use";
						var e_class = "stop_icon";
						var e_type = 2;
						var e_v = "停用";
						if (strategy_time != ""){//jixu
							var nowdate = new Date();
							var syear = nowdate.getFullYear();
							var smonth = nowdate.getMonth() + 1;
							var sday = nowdate.getDate();
							var shour = nowdate.getHours();
							var smin = nowdate.getMinutes();
							var ssec = nowdate.getSeconds();
							var now_time = syear + '-' + smonth + '-' + sday + ' ' + shour + ':' + smin + ':' + ssec;
							var re_v = compareTime(now_time,end_time);
							if (re_v == 1){
								change_id.push(item.WorkOrderId);
								enabled = "停用";
								e_class = "start_icon";
								e_type = 1;
								e_v = "启用";
							}
						}
					}else{
						var enabled = "停用";
						//var e_class = "start_use";
						var e_class = "start_icon";
						var e_type = 1;
						var e_v = "启用";
					}
					if (item.Action == 1){
						var action = "允许";
					}else{
						var action = "拒绝";
					}
					var work_status = "";
					if (item.Status == 2){
						work_status = "申请";
					}else if (item.Status == 4){
						work_status = "已过期";
					}else if (item.Status == 5){
						work_status = "同意";
					}else if (item.Status == 6){
						work_status = "拒绝";
					}
					
					var float_str = "";
					if (scope != ""){
						float_str = "<p>服务器范围："+scope+"</p>";
					}
					if (user != ""){
						float_str = float_str + "<p>运维用户："+user+"</p>";
					}
					if (ug != ""){
						float_str = float_str + "<p>运维用户组："+ug+"</p>";
					}
					var append_str = '<tr><td><input class="form-checkbox" type="checkbox" name="'+item.WorkOrderName+'" value="'+item.WorkOrderId+'"></td><td><div class="sortEdit" id="del" onclick="_editSort(this,'+item.WorkOrderId+')" style="width:40px">'+item.PrioNum+'</div></td><td title=\"'+item.WorkOrderName+'\">'+item.WorkOrderName+'</td><td title=\"'+AccessStrategyName+'\">'+AccessStrategyName+'</td><td style="width:300px;" title=\"'+strategy_time+'\">'+strategy_time+'</td><td title=\"'+admin+'\">'+admin+'</td><td title=\"'+action+'\">'+action+'</td><td title=\"'+enabled+'\">'+enabled+'</td><td title=\"'+work_status+'\">'+work_status+'</td><td style="width:97px"><div class="tab-ctr">';
					
					
					if ({{auth_flag2}} == 2){
						append_str = append_str + '<a href="javascript:;" title="查看" class="search_result" onclick="edit_work('+item.WorkOrderId+');"></a></div><div class="tab-moreinfo">'+float_str+'</div></td></tr>';
					}else{
						if (item.AccessStrategyInfo != null){
							var AccessStrategyId = item.AccessStrategyInfo.AccessStrategyId;
							var a_class = "";
						}else{
							var AccessStrategyId = 0;
							var a_class = "disabled";
						}
						
						append_str = append_str + '<a href="javascript:;" class="edit" title="编辑" onclick="edit_work('+item.WorkOrderId+');"></a><a href="javascript:;" class="'+e_class+'" title="'+e_v+'" onclick="enable_work('+e_type+','+item.WorkOrderId+')"></a><a href="javascript:;" class="modify '+a_class+'" title="延时" id="del" onclick="modify_worktime('+AccessStrategyId+','+item.WorkOrderId+');"></a><a href="javascript:;" class="del" title="删除" id="del" onclick="del_work('+item.WorkOrderId+');"></a></div><div class="tab-moreinfo">'+float_str+'</div></td></tr>';
					}
					$("#workorder_list tbody").append(append_str);
					tabArr();
					/*
					var len = $('.tab-ctr:first').children('a').length;
					$('table>thead>tr>th:last').width(len*25);
					*/
					$('#workorder_list .form-checkbox').iCheck({
						checkboxClass: 'icheckbox_minimal-blue',
						radioClass: 'iradio_minimal-blue',
						increaseArea: '0' 
					});
				//}
			})
			if (change_id.length != 0){
				$.ajax({
					url:'/bhost/update_enable',
					type:'post',
					async:true,
					data:{a0:se,z1:JSON.stringify(change_id)},
					success:function(result){
						var chang_result = JSON.parse(result);
						if (!chang_result.Result){
							_alert(1,"工单授权",chang_result.ErrMsg);
							return false;
						}
					}
				});
			}
		}
	});
	 $("#work_total").text(work_list.totalrow);
	totalpage = Math.ceil(parseInt(work_list.totalrow)/MAX_PAGE);
	if (totalpage < 1){
		totalpage = 1;
	}
	$("#totalpage").text(totalpage.toString());
	$("#page_total").text(MAX_PAGE);
	$('#check_page').iCheck('uncheck');

	var check_page_flag = 0;
	$("#workorder_list tbody input[type='checkbox']").each(function(){
		if ($.inArray(parseInt(this.value), selectid) != -1){					
			$(this).iCheck('check');
			check_page_flag++;
		}
    });
	
	if (check_page_flag == $("#workorder_list tbody input[type='checkbox']").length && check_page_flag != 0){
		$('#check_page').iCheck('check');
	}
	
	if (parseInt(curpage) > totalpage){
		$("#curpage").val(totalpage);
		order_flag = (totalpage-1)*10;
		get_workorder_list();
	}

	//绑定列表单击选中
	/*
	$("#workorder_list tbody >tr").unbind().bind("click",function(e){
		x=e.target;
		if (x.nodeName != 'A'){
			var input = $(this).find("input[type='checkbox']");
			if ($(input).prop('checked') == false && $(input).prop("disabled") == false){
				$(input).iCheck('check');
			}else{
				$(input).iCheck('uncheck');
			}
		}
	})
	*/
	$("#workorder_list tbody >tr").bind("dblclick",function(e){
		x=e.target;
		if (x.nodeName != "INPUT" && x.nodeName != "INS"){
			$(this).children('td:last').find('.edit').click();
		}
	});
	$('#check_page').on('ifClicked',function(e){
		if(!$('#check_page').prop('checked')){
			$("#workorder_list").children('tbody').find('input[type=checkbox]').iCheck('check');
		}else{
			$("#workorder_list").children('tbody').find('input[type=checkbox]').iCheck('uncheck');
		}	
	});
	var flag_id = 0;	
	num = selectid.length;
	$("#select_total").text(num);

	$("#workorder_list tbody input[type='checkbox']").on("ifChanged",function(){
		if ($(this).is(":checked")){
			num = $("#select_total").text();   
			num++;
			if (selectid.indexOf(parseInt(this.value)) == -1){
				selectid.push(parseInt(this.value))	
			}
			$("#select_total").text(num);
		}else{
			num = $("#select_total").text();
			num--;
			selectid.splice($.inArray(parseInt(this.value),selectid),1);
			$("#select_total").text(num);   
		}
		if ($("#workorder_list tbody").find('input[type=checkbox]:checked').length == $("#workorder_list tbody input[type='checkbox']").length){
			$('#check_page').iCheck('check');
		}else{
			$('#check_page').iCheck('uncheck');
		}
	});
}

function modify_worktime(id,workid){
	if (id == 0){
		return false;
	}
	//clear_approve();
	var $dialogCont = $("#WorkTime_suspend").show();
	
	var d = dialog({
		title:"生效时间",
		content:$dialogCont,
		id:"WorkTime_suspend",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	bind_date();
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		bind_date();
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
		change_time(d,id,workid);
		
	});
}
function bind_date(){
	var date = new Date();
	var syear = date.getFullYear();
	var smonth = date.getMonth() + 1;
	var sday = date.getDate();
	var shour = date.getHours();
	var smin = date.getMinutes();
	var ssec = date.getSeconds();
	var eyear = date.getFullYear();
	var emonth = date.getMonth() + 1;
	var eday = date.getDate();
	var ehour = date.getHours() + 2;
	if (sday < 10) {
		sday = "0" + sday;
	}
	if (smonth < 10) {
		smonth = "0" + smonth;
	}
	if (eday < 10) {
		eday = "0" + eday;
	}
	if (emonth < 10) {
		emonth = "0" + emonth;
	}
	
	if (parseInt(shour) < 10) {
		shour = "0" + shour;
	}
	if (parseInt(smin) < 10) {
		smin = "0" + smin;
	}
	if (parseInt(ssec) < 10) {
		ssec = "0" + ssec;
	}
	
	if (ehour >= 24) {
		date.setDate(date.getDate() + 1);
		eyear = date.getFullYear();
		emonth = date.getMonth() + 1;
		eday = date.getDate();
		ehour = ehour - 24;
	}
	if (parseInt(ehour) < 10) {
		ehour = "0" + ehour;
	}
	
	var startDate = syear + '-' + smonth + '-' + sday;
	var endDate = eyear + '-' + emonth + '-' + eday;
	$('input.datepicker',$("#Effective_WorkOrder")).each(function(){
		$(this).jeDate({
			format:"YYYY-MM-DD",
			isTime:true
		});
	});
	$('input.datepicker',$("#Effective_WorkOrder")).each(function(i,item){
		if (i == 0){
			$(item).val(startDate);
		}else{
			$(item).val(endDate);
		}
	});
	$("#shour").val(shour);
	$("#smin").val(smin);
	$("#ssec").val(ssec);
	$("#ehour").val(ehour);
	$("#emin").val(smin);
	$("#esec").val(ssec);

	/*
	var now = new Date();
	var setDate = now.getTime();
	setDate = new Date(setDate);
	
	var month = (setDate.getMonth() + 1).toString();
	var day =  setDate.getDate().toString();
	if(month.length == 1){
		month = '0' + month;
	}
	if(day.length == 1){
		day = '0' + day;
	}
	setDate = {
		year: setDate.getFullYear(),
		month: month,
		day: day
	}
	
	setDate = setDate.year + '-' + setDate.month + '-' + setDate.day;
	$('input.datepicker',$("#Effective_WorkOrder")).each(function(){
		$(this).jeDate({
			format:"YYYY-MM-DD",
			isTime:true,
			//maxDate:setDate.year + "-" + setDate.month + "-" + setDate.day
		});
	});
	$('input.datepicker',$("#Effective_WorkOrder")).each(function(i,item){
		if(i==0){
			$(item).val(setDate);
			$(item).parent().find('input.timeinput').val('00');
		}else if(i==1){
			$(item).val(setDate);
			$(item).parent().find('input.timeinput').each(function(i){
				if(i == 0){
					$(this).val('23');
				}else{
					$(this).val('59');
				}
			})
		}   
	});
	*/
}

function change_time(d,id,workid){
	var dataReg = /^\d{4}[-]\d{2}[-]\d{2}$/;
	if ($("#effective_time").val() == 1){
		var startdate = $("#sdate").val().trim();
		var enddate = $("#edate").val().trim();
		var start_time = $("#shour").val() + ':' + $("#smin").val() + ':' + $("#ssec").val();
		var end_time = $("#ehour").val() + ':' + $("#emin").val() + ':' + $("#esec").val();
		if (startdate == "") {
			_alert(2, "工单授权", "请输入起始日期", $("#sdate"));
			return;
		}
		if (!dataReg.test(startdate)) {
			_alert(1, "工单授权", "起始日期格式不正确", $("#sdate"));
			return;
		}
		if (enddate == "") {
			_alert(2, "工单授权", "请输入终止日期", $("#edate"));
			return;
		}
		if (!dataReg.test(enddate)) {
			_alert(1, "工单授权", "终止日期格式不正确", $("#edate"));
			return;
		}
		if (startdate > enddate) {
			_alert(1, "工单授权", "起始日期不能大于终止日期", $("#edate"));
			return;
		}
		if (startdate == enddate && start_time > end_time) {
			_alert(1, "工单授权", "起始时间不能大于终止时间", $("#esec"));
			return;
		}
	}else{
		var startdate;
		var enddate;
		var start_time;
		var end_time;
		
		var date = new Date();
		var syear = date.getFullYear();
		var smonth = date.getMonth() + 1;
		var sday = date.getDate();
		var shour = date.getHours();
		var smin = date.getMinutes();
		var ssec = date.getSeconds();
		
		startdate = syear + '-' + smonth + '-' + sday;
		if (smonth < 10){
			smonth = '0' + smonth;
		}
		if (sday < 10){
			sday = '0' + sday; 
		}
		if (shour < 10){
			shour = '0' + shour;
		}
		if (smin < 10){
			smin = '0' + smin;
		}
		if (ssec < 10){
			ssec = '0' + ssec;
		}
		start_time = shour + ':' + smin + ':' + ssec;
		var after_hour = $("#after_hour").find('input').val()
		if (after_hour == ""){
			_alert(2,"工单授权","请输入工单生效时间",$("#after_hour").find('input'));
			return false;
		}else if (after_hour == 0){
			_alert(2,"工单授权","工单生效时间不能为0",$("#after_hour").find('input'));
			return false;
		}
		var ehour = shour + parseInt($("#after_hour").find('input').val());
		if (ehour >= 24) {
			date.setDate(date.getDate() + 1);
			var eyear = date.getFullYear();
			var emonth = date.getMonth() + 1;
			var eday = date.getDate();
			ehour = ehour - 24;
			if (ehour < 10){
				ehour = '0' + ehour;
			}
			enddate = eyear + '-' + emonth + '-' + eday;
			end_time = ehour + ':' + emin + ':' + esec;
		}else{
			enddate = syear + '-' + smonth + '-' + sday;
			if (ehour < 10){
				ehour = '0' + ehour;
			}
			end_time = ehour + ':' + smin + ':' + ssec;
		}
	}
	msstr = aceg(startdate,se);
	$.ajax({
		url:'/bhost/change_time',
		type:'post',
		async:false,
		data:{a0:se,z1:id,z2:startdate,z3:start_time,z4:enddate,z5:end_time,z6:workid,m1:msstr},
		success:function(result){
			var result = JSON.parse(result);
			if (result.Result){
				d.close().remove();
				get_workorder_list();
				_alert(0,"工单授权","修改成功");
			}else{
				_alert(1,"工单授权","执行失败："+ result.ErrMsg);
			}
			
		}
	});
}

$(document).on('keydown','input.timeinput',function(){
	var i = $(this).index();        
	var v = $(this).val();
	v = v.replace(/[^\d]/g,'');
	$(this).val(v);
}).on('keyup','input.timeinput',function(e){
	var i = $(this).index();
	var v = $(this).val();    
	v = v.replace(/[^\d]/g,'');
	$(this).val(v);
	var max = 23;
	if(i>1){
		max = 59;
	}

	if(v > max){
		v = max;
	}

	$(this).val(v);

	v = v.toString();
	if(v.length >= 2){
		$(this).val(v.substring(0,2));

		var keycode = e.keyCode;
		if(keycode != 9){
			$(this).next().next().focus();
		}
	}
}).on('focus','input.timeinput',function(){
	$(this).select();
}).on('blur','input.timeinput',function(){
	var v = $(this).val();
	v = v.toString();

	if(v == ''){
		v = '00';
	}else if(v.length == 1){
		v = '0' + v;
	}

	$(this).val(v);
});

function dataCheck(obj, min, max) {//min can not bigger than 1
	obj.value = obj.value.replace(/\D/g, "");
	if (min) {
		if (parseInt(obj.value, 10) < parseInt(min, 10)) obj.value = min;
	}
	if (max) {
		if (parseInt(obj.value, 10) > parseInt(max, 10)) obj.value = max;
	}
}
function add_zero(obj) {
	obj.value = obj.value.replace(/\D/g, "");
	var v = obj.value.trim();
	if (v == "") {
		v = '0';
	}
	v = parseInt(v);
	obj.value = v;
}

function change_effective_time(obj){
	if ($(obj).val() == 1){
		$("#after_hour").hide();
		$("#Effective_WorkOrder").show();
	}else{
		$("#Effective_WorkOrder").hide();
		$("#after_hour").show();
	}
}

function enable_work(type,id){
	$.ajax({
		url:'/bhost/enable_workorder',
		type:'post',
		async:false,
		data:{a0:se,z1:id,z2:type},
		success:function(result){
			get_workorder_list();
		}
	});
}

//全选
function select_all(){
	var num = 0;
	selectid = [];
	var select_total = $("#select_total").text();
	var work_total = $("#work_total").text();
	if (select_total == work_total){
		$("#workorder_list").find('input').iCheck('uncheck');
	}else{
		$.ajax({
			url:'/bhost/get_workorder_z',
			type:'post',
			async:false,
			data:{a0:se,z1:"null",z2:"null",z3:JSON.stringify(keyword_re)},
			success:function(result){
				var result = JSON.parse(result);
				$.each(result.data,function(i,item){
					selectid.push(item.WorkOrderId);
				})
			}
		});
		$("#workorder_list input[type='checkbox']").each(function(){
			$(this).iCheck('check');                
		});
	}
	num = selectid.length;
	$("#select_total").text(num);
}

var filter_json = {
	"1":"授权名称",
	"2":"运维用户",
	"3":"用户组",
	"4":"权限配置",
	"5":"管理员",
	"6":"主机组",
	"7":"主机名",
	"8":"主机服务",
	"9":"账号",
	"10":"服务器范围",
	"11":"授权动作",
	"12":"状态",
	"13":"工单状态"
}

String.prototype.ResetBlank=function(){
	var regEx = /\s+/g; 
	return this.replace(regEx, ' '); 
};

//搜索
var keyword_v = "";
function _addFilter(obj,type){
	var filter_v = $("#filter_select").val();
	
	if (filter_v == '11' || filter_v == '12' || filter_v == "13"){
		var addfilter = $("#select_two").val();
		var addfilter_text = $("#select_two").children('option:selected').text();
	}else{
		var addfilter = $("#keyword").val().trim();
		var addfilter_text = "";
	}

	var add = 0;
	$("#keyword").blur();
	if (addfilter == ""){
		_alert(2,"搜索","请输入关键字",$("#keyword"));
		return false;
	}
	addfilter = addfilter.ResetBlank();
	
	var addfilter_v = "";
	
	if (filter_v == '0'){
		addfilter_v = addfilter;
	}else{
		filter_name = filter_json[filter_v];
		addfilter_v = filter_name + '-' + (addfilter_text != ""?addfilter_text:addfilter);
	}
	addfilter = filter_v + "-" + addfilter;
	
	$("#filterWW li").each(function(i,item){
		var filter = $(item).find('.ww').attr('data-value');
		var filter_array = filter.split('-');
		var index = filter.indexOf('-');
		var key_v = filter.substring(index + 1);
		if (filter_array[0] == "11" && filter_array[0] == filter_v){
			add = 1;
			_alert(2,"搜索","只能搜索一个授权动作");
			return false;
		}else if (filter_array[0] == '12' && filter_array[0] == filter_v){
			add = 1;
			_alert(2,"搜索","只能搜索一个状态");
			return false;
		}else if (filter_array[0] == '13' && filter_array[0] == filter_v){
			add = 1;
			_alert(2,"搜索","只能搜索一个工单状态");
			return false;
		}else{
			if (filter == addfilter){
				add = 1;
				_alert(2,"搜索","相同的搜索条件已存在",$("#keyword"));
				return false;
			}
		}
	});
	if (add == 1){
		return false;
	}
	
	if (type){
		if (manage_filter_flag == 1){
			keyword_re.splice(-1,1);
			manage_filter_flag = 0;
		}
		$("#filterWW").show();
		$("#clearFilter").show();
		$("#filterWW ul").append("<li><span class=\"ww\" data-value=\""+addfilter+"\">"+addfilter_v+"</span><i class=\"del\" onclick=\"_delFilter(this)\"></i></li>");
		keyword_re.push(addfilter);
		$("#text_check").hide();
		keyword_v = "";
		$("#keyword").val('');
	}else{
		if (manage_filter_flag != 0){
			keyword_re.splice(-1,1);
		}
		manage_filter_flag = 1;
		keyword_re.push(addfilter);
		keyword_v = addfilter;
	}
	
	$("#curpage").val(1);
	order_flag = 0;
	$("#keyword").focus();
	selectid=[];
	get_workorder_list();
}
function _clearFilter(obj){
	$("#filterWW").children('ul').empty();
	$("#filterWW").hide();
	$("#clearFilter").hide();
	keyword_re=[];
	$("keyword").val('');
	$("#text_check").hide();
	keyword_v = "";
	manage_filter_flag = 0;
	get_workorder_list();
}
//移除搜索条件
function _delFilter(obj){
	var filter_text = $(obj).parent().children('span').attr('data-value');
	$(obj).parent().remove();
	keyword_re.splice($.inArray(filter_text,keyword_re),1);
	order_flag = 0;
	if ($("#filterWW").children('ul').children('li').length == 0){
		$("#filterWW").hide();
		$("#clearFilter").hide();
	}
	get_workorder_list();
}

function _clear_keyword(){
	$("#keyword").val("");
	$("#text_check").hide();
	if (keyword_v != ""){
		keyword_v = "";
		keyword_re.splice(-1,1);
		manage_filter_flag = 0;
		get_workorder_list();
	}
}

function change_input(obj){
	if ($(obj).val() == "" && keyword_v != "" && $("#select_two").is(":hidden")){
		keyword_v = "";
		manage_filter_flag = 0;
		keyword_re.splice(-1,1);
		get_workorder_list();
	}
}

//批量删除
function delete_all(){
	var cur = $("#curpage").val();
	if (selectid.length == 0){
		_alert(2,"工单授权","请选择要删除的数据");
		return;
	}
	var id = JSON.stringify(selectid);
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"工单授权",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			$("#select_total").text(0);
        	delete_work(1,id);
        	selectid=[];
			order_flag = (parseInt(cur)-1)*10;
        	get_workorder_list();
		},
		btn2:function(i){
			parent.layer.close(i);
		}
	});	
}
//单个删除
function del_work(id){
	var name = $("[value="+id+"]").prop('name');
	var cur = $("#curpage").val();
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"工单授权",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			delete_work(0,id);
			for (var i = 0; i < selectid.length; i++){      
				if (selectid[i] == parseInt(id)){
					num = $("#select_total").text();
					num = parseInt(num)-1;
					$("#select_total").text(num);
					selectid.splice($.inArray(parseInt(id),selectid),1);
					break;
				}
        	}
			order_flag = (parseInt(cur)-1)*10;
			get_workorder_list();
		},
		btn2:function(i){
			 parent.layer.close(i);
		}
	});
}

function delete_work(type,id){
	$.ajax({
		url:'/bhost/delete_work',
		type:'post',
		async:false,
		data:{a0:se,z1:type,z2:id},
		success:function(results){
			data = JSON.parse(results);
			if (data.Result == "false"){
				_alert(1,"工单授权","删除失败："+data.ErrMsg);
			}else{
				_alert(0,"工单授权","删除成功");
			}
		}
	});
}
//过滤下拉框选择
function filter_change(){
	var name = $("#filter_select").val();
	if (name == "11" || name == "12" || name == "13"){
		$("#keyword").hide();
		
		if ($("#select_two").length == 0){
			if (name == "11"){
				var select_str = '<select name="" id="select_two" class="filter-select"><option value="0">所有</option><option value="1">允许</option><option value="2">拒绝</option></select>';
			}else if (name == "12"){
				var select_str = '<select name="" id="select_two" class="filter-select"><option value="0">所有</option><option value="true">启用</option><option value="false">停用</option></select>';
			}else if (name == "13"){
				var select_str = '<select name="" id="select_two" class="filter-select"><option value="0">所有</option><option value="2">申请</option><option value="4">已过期</option><option value="5">同意</option><option value="6">拒绝</option></select>';
			}
			$("#filter_select").next().after(select_str);
			$("#select_two").select2({minimumResultsForSearch:-1});
			$("#select_two").next('span').find('span.select2-selection').css({"border-bottom-left-radius":"1px","border-top-left-radius":"1px","margin-left":"-1px"});
		}else{
			if (name == "11"){
				$("#select_two").empty().append('<option value="0">所有</option><option value="1">允许</option><option value="2">拒绝</option>');
			}else if (name == "12"){
				$("#select_two").empty().append('<option value="0">所有</option><option value="true">启用</option><option value="false">停用</option>');
			}else if (name == "13"){
				$("#select_two").empty().append('<option value="0">所有</option><option value="2">申请</option><option value="4">已过期</option><option value="5">同意</option><option value="6">拒绝</option>');
			}
		}
		
		$("#select_two").show();
		$("#select_two").next().show();
	}else{
		$("#keyword").show();
		$("#select_two").hide();
		$("#select_two").next().hide();
	}
}
//刷新
function refresh(){
	selectid=[];
	var cur = $("#curpage").val();
	$("#workorder_list input[type='checkbox']").each(function(){                                 
		$(this).iCheck('uncheck');
	});
	$("#select_total").text(0);
	$("#curpage").val(cur);
	order_flag = (parseInt(cur)-1)*10;
	get_workorder_list();
}

//返回
function back(){
	document.frm_access.tasktype.value=3;
	document.frm_access.se.value=se;
	document.frm_access.us.value=window.parent.document.frm.us.value;
	document.frm_access.action = '/bhost/index';
	document.frm_access.submit();
}

//创建
function creat_access(){
	var curpage = $("#curpage").val();
	document.frm_access.z1.value=curpage;
	document.frm_access.z2.value="None";
	document.frm_access.z3.value=tasktype;
	document.frm_access.z4.value=JSON.stringify(keyword_re);
	document.frm_access.z5.value=manage_filter_flag;
	document.frm_access.z6.value=JSON.stringify(selectid);
	document.frm_access.action = '/bhost/add_workorder';
	document.frm_access.submit();
}
//编辑
function edit_work(id){
	var curpage = $("#curpage").val();
	var flag = 0;
	/*$.ajax({
		url:'/bhost/check_editwork',
		type:'post',
		async:false,
		data:{a0:se,z1:id},
		success:function(result){
			results = JSON.parse(result);
			if (results.totalrow == "0"){
				_alert(2,"工单授权","该访问授权已删除");
				flag = 1;
			}else{
				var data = JSON.stringify(results)*/
				var curpage = $("#curpage").val();
				document.frm_access.z1.value=curpage;
				document.frm_access.z2.value=id;
				document.frm_access.z3.value=tasktype;
				document.frm_access.z4.value=JSON.stringify(keyword_re);
				document.frm_access.z5.value=manage_filter_flag;
				document.frm_access.z6.value=JSON.stringify(selectid);
				document.frm_access.action = '/bhost/add_workorder';
				document.frm_access.submit();
			/*}
		}
	});*/
	if (flag == 1){
		refresh();
		return;
	}
}

var eCheck = true;
var PRI = "";
function _editSort(obj,id){
	if ({{auth_flag2}} == 2){
		return false;
	}
	if($(obj).children('input').length>0){
		return;
	}

	if(!eCheck){
		return;
	}
	var v = $(obj).text();
	var s = v.length;
	PRI = parseInt(v);

	var $i = $('<input type="text"  value="'+v+'" name="" id="del" style="width:'+(s/2+0.5)+'em" onblur="_checkNum(this,'+id+','+v+')" onkeydown="_autoWidth(this)" onkeyup="_Numcheck(this);"/>');
	$(obj).empty().html($i);
	$('input',obj).focus().select();
}

function _Numcheck(obj){
	var num = $(obj).val();
	num = num.replace(/\D/g,"");
	$(obj).val(num);
}

function _checkNum(obj,id,_v){
	var v = parseInt($(obj).val().trim());
	var numCheck = /^\d+$/;
	
	if(!numCheck.test(v)){
		$(obj).parent().empty().text(_v);
		eCheck = true;
		return;
	}else{
		var position;
		if (v == 0){
			v = 1;
		}
		if (v == PRI){
			$(obj).parent().empty().text(v);
			eCheck = true;
			return;
		}else if (v < PRI){
			position = 1;
		}else{
			position = 2;
		}
		now = $("#curpage").val();
		var modifyid = id;
		var referid = "";
		$.ajax({
			url:'/bhost/check_editwork',
			type:'post',
			async:false,
			data:{a0:se,z1:-1},
			success:function(result){
				var all_work = JSON.parse(result);
				var lastpostid = all_work.totalrow;//最后一个优先级
				if (v > lastpostid){
					referid = all_work.data[parseInt(lastpostid)-1].WorkOrderId;
				}else{
					referid = all_work.data[v-1].WorkOrderId;
				}
			}
		});
		if (referid == modifyid){
			$(obj).parent().empty().text(PRI);
			eCheck = true;
			return false;
		}
		$.ajax({
			url:'/bhost/modify_priority',
			type:'post',
			async:false,
			data:{a0:se,z1:modifyid,z2:referid,z3:position},
			success:function(result){
				if (result == true){
					$('#curpage').val(now);
					order_flag = (parseInt(now)-1)*10;
					get_workorder_list();
				}else{
					$(obj).parent().empty().text(PRI);
					eCheck = true;
				}
			}
		})
	}
}

function _autoWidth(obj){
	var v = $(obj).val();
	var len = v.length;
	$(obj).width((len/2+1) + 'em');
}

function cmd_auth(){
	document.frm_access.a0.value=se;
	document.frm_access.tasktype.value=0;
	document.frm_access.z1.value=0;
	document.frm_access.z2.value="[]";
	document.frm_access.action = '/bhost/auth_manage_xtc';
	document.frm_access.submit();
}

function manage_add(){
	document.frm_access.tasktype.value=3;
	document.frm_access.se.value = se;
	document.frm_access.user.value = window.parent.document.frm.us.value;
	document.frm_access.action = '/bhost/manage_auth_add';
	document.frm_access.submit();
}

function manage_auth(){
	document.frm_access.a0.value=se;
	document.frm_access.z3.value=2;
	document.frm_access.z4.value="[]";
	document.frm_access.z5.value=0;
	document.frm_access.z6.value="[]";
	document.frm_access.action = '/bhost/show_manage_accessauth';
	document.frm_access.submit();
}

function manage_work(){
	document.frm_access.a0.value=se;
	document.frm_access.z1.value=1;
	document.frm_access.z3.value=2;
	document.frm_access.z4.value="[]";
	document.frm_access.z5.value=0;
	document.frm_access.z6.value="[]";
	document.frm_access.action = '/bhost/show_manage_workorder';
	document.frm_access.submit();
}
</script>
</body>
</html>
