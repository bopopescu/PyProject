<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>manager</title>
	
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<link rel="stylesheet" href="/manage/css/ui-dialog.css" type="text/css" />
	<script src="/manage/js/jquery.min.js"></script>
	<script src="/manage/js/jquery.easing.js"></script>
	<script src="/manage/js/layer.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/common_e.js"></script>
	<script src="/manage/js/my_scrollbar.js"></script>
</head>
<style>
	.col-bottom .form-item{
		padding:10px 0 5px 0;
	}
	.xSelect-show{
		background-color: #fff;
	}
	.form-item{
		float: left;
	}
	.p2{
		background-position: -57px 0px;
	}
	.p4{
		background-position: -90px 0px;
	}
</style>
<body style="overflow:hidden;" class="bg-white">
	<!---->
	<div class="rwrap">
		<!---->
		<div class="mainer">
			
            <div class="container container3">
				<div class="c-top">
					<div class="c-title c-title-pc">
						<!-- <h3 class="tit" onclick="back();">
						<span>密码录入</span>
						<i class="icon-pwdchang" style="background-position: 180px 0;"></i>
						</h3> -->
						<div class="manual-head">
							<div class="manual-title">
								<span onclick="reload_pwd();">密码录入</span>
								<i class="pwd_read_icon"></i>
							</div>
						</div>
					</div>
				</div>

				<div class="c-cont">
					<div class="c-wrap" style="padding: 10px 0 0;min-width:1157px;">
						<div class="c-exp">
							<div class="h-explorer">
								<div class="h-content2" style="overflow:hidden">
									<div class="h-top" style="background-color: #fff;    margin-top: -22px;">
										<div class="filter" style="float:right;min-width:auto;">
											<div id="waitTip" class="waitTip" style="float: right;margin-top: 7px;margin-left: -26px;"></div>
											<div class="search">
												
												<select name="server_select" id="server_select1" class="filter-select">
													<option value="0" selected>所有</option>
													<option value="1">组名</option>
													<option value="2">主机名</option>
													<option value="3">IP</option>
													<option value="4">账号</option>
												</select>
												
												<input type="text" class="filter-text" placeholder="输入关键字" name="server_text" id="server_text1" maxlength="128" style="border-left:0px;padding: 0 22px 0 4px;" onkeydown="if($('#server_text1').val()==''){$('#text_check').hide();}else{$('#text_check').show();};if (event.keyCode == 13){_addFilter2(this,false);return false;} else return;" onchange="if($('#server_text1').val()==''){$('#text_check').hide();}else{$('#text_check').show();}" onkeyup="if($('#server_text1').val()==''){$('#text_check').hide();}else{$('#text_check').show();}" onblur="change_input(this);">
												
												<i class="v-check v-wrong" id="text_check" onclick="_clear_keyword(this)" style="display:none;cursor: pointer;float: left;position: static;"></i>
												<button class="btn filter-btn" onclick="_addFilter2(this,false)"><i class="add-filter"></i></button>
												<button class="btn filter-btn" onclick="_addFilter2(this,true)"><i class="append-filter"></i></button>
											</div>
											<div class="search" id="clearFilter2" style="margin: 0px 15px 0px -16px;display:none;">
												<button class="filter-btn" onclick="_clearFilter2(this)"><i class="clear-filter"></i></button>
											</div>
											<div class="selector selector-multiple" id="filterWW2" style="display: none;width: 146px;">
												<span class="ww" style="width:132px;">搜索条件</span>
												<ul style="padding-left: 0px;	width: 146px;"></ul>
											</div>
										</div>
									</div>
									<div style="overflow: auto;width:100%;height:94%;margin-top:10px;" id="hosttree_div1">
										<h2 style="margin-left: 30px;"><em class="imp" style="color: #F00;font-style: normal;">*</em>主机：</h2>
										<ul id="userTree" class="hosttree"></ul>
									</div>
								</div>
							</div>
						</div>
						<div class="clearfix"></div>
						<div class="col-bottom" style="height: 95px;">
							<div class="form" style="width: 100%;">
								<div class="form-item" style="width: 142px;">
									<div class="form-c" style="float:left;padding-top:5px;">
										<input type="checkbox" checked class="form-checkbox" name="" id="password_check" class="form-checkbox">
									</div>
									<div class="form-tag" style="width: auto;">密码</div>
								</div>
								<div class="form-item" id="password_form_item1">
									<div class="form-tag">录入密码：</div>
									<div class="form-c">
										<input type="password" class="form-text" placeholder="输入新的密码……" id="n_p">
										<input type="checkbox" class="form-checkbox" name="" id="s_p" class="form-checkbox">空密码
									</div>
								</div>

								<div class="form-item" id="password_form_item2">
									<div class="form-tag">确认密码：</div>
									<div class="form-c">
										<input type="password" class="form-text" id="c_p">
									</div>
								</div>
							</div>
							<div class="form" style="width: 100%;float: left;">
								<div class="form-item" style="width: 142px;">
									<div class="form-c" style="float:left;padding-top:5px;">
										<input type="checkbox" class="form-checkbox" name="" id="sshkey_check" class="form-checkbox">
									</div>
									<div class="form-tag" style="width: auto;">密钥</div>
								</div>
								<div class="form-item" id="sshkey_form_item1" style="display: none;">
									<div class="form-tag">选择密钥：</div>
									<div class="form-c">
										<div class="xSelect xSelect_SSHkey" id="SSHkey_s"></div>
									</div>
								</div>
							</div>
						</div>
						
						<div class="clearfix"></div>
						<div class="btns">
                            <a href="javascript:;" class="btn btn-normal" onclick="_import_user(1);">导&nbsp;&nbsp;入</a>
							<a href="javascript:;" class="btn btn-normal" onclick="save();">保&nbsp;&nbsp;存</a>

						</div>
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn" style="float: right;" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
					</div>
                </div>
            </div>
        </div>
    </div>
    <!--导入信息详情-->
    <div class="container6">
        <div id="importPage" style="display: none;">
            <div class="ap-top" id="">
                <div class="ctrl">
                    <a href="javascript:;" class="re" onclick="_reloadDetail(2)" style="border-radius: 14px;"><i
                            style="margin: 3px auto;margin-left: 8px;"></i></a>
                    <!--<a href="javascript:;" class="close" onclick="_closeDetail(2)"><i></i></a>-->
                </div>
                <div class="types">
                    <label>
                        <input type="checkbox" name="" id="fail_IP_box" class="form-checkbox">失败的密码导入</label>
                </div>
            </div>
            <div class="apWrap">
                <div class="title">
                    <h2>导入详情</h2>
                </div>
                <div class="top">
                    <div class="mm mm1">总数：<span>11</span> 改密：<span>11</span> 成功改密：<span>11</span> 失败改密：<span>11</span>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div id="apArea1" style="height:auto;">
                </div>
                <div id="aploadTip1">正在加载</div>
            </div>
            <div id="bBtn" style="position: fixed;z-index:5;">
                <a href="javascript:;" class="btn" style="float: right;" onclick="_closeDetail(2)"><i
                        class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
            </div>
        </div>
    </div>
    <!--密码导入-->
    <div class="dialog-cont" id="scDCTab2_import" style="display:none;">
        <div class="fsel" style="margin-left: 0;">
            <ul>
                <li><a class="active" href="javascript:;" id="task_import" onclick="set_tab(this,1);">密码导入</a></li>
                <li><a href="javascript:;" id="task_list_tab" onclick="set_tab(this,2);">任务列表</a></li>
            </ul>
        </div>
        <div class="container5">
            <div id="import_module" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;">
                <div class="c-form" style="padding-bottom:10px;padding-left:50px;">
                    <div class="tab-t c-form">
                        <span class="form-tag">下载模板：</span>
                        <div class="ctr" style="margin-left:6px;">
                            <a class="btn" href="javascript:;" style="" onclick="_export_user(1);">下载</a>
                        </div>
                    </div>
                    <div class="c-form" style="">
                        <form id="uploadForm">
                            <!--form action="/bhost/import_data" method="POST" name="frm1" enctype="multipart/form-data">
    									<input type="hidden" name="z1" value="" />-->
                            <div class="form-item tab-t">
                                <span class="form-tag"><em class="imp">*</em>选择文件：</span>
                                <div class="form-c ctr" style="width:300px;padding:0 0 0 7px;">
                                    <div class="item" style="float: left;width:67%">
                                        <input id="file_v" name="file_v" class="form-text" type="text"
                                            style="float: left;width: 220px;">
                                        <input id="file_change" name="file_change" class="form-text" type="text"
                                            onclick="browes();" onchange="/*filetip(this);*/"
                                            style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;">
                                        <input id="file_change1" name="file_change1" class="form-text" type="file"
                                            onchange="filetip(this);"
                                            style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;display: none;">
                                    </div>
                                    <div class="item" style="float: left;width:33%">
                                        <a class="btn" href="javascript:;"
                                            style="margin-left: 70px;height: 26px;width:33px;"
                                            onclick="browes();">浏览</a>
                                    </div>
                                    <p class="form-tip" id="" style="margin-top: 28px;width: 243px;height: 32px;">
                                        特殊字符仅支持下划线、横杠、小数点</p>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="c-form">
                        <span class="form-tag">覆盖：</span>
                        <div style="width: 215px;margin-left: 200px;margin-top: 4px;">
                            <input class="form-checkbox" id="cover_box1" type="checkbox" />
                            <span class="tip" style="color: #b2b2b2;">覆盖相同名称的密钥</span>
                        </div>
                    </div>
                    <div class="btns" style="">
                        <a href="javascript:;" class="btn btn-normal btn-submit">确&nbsp;&nbsp;定</a>
                        <!-- <a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a> -->
                    </div>
                </div>
            </div>

            <div id="details_module" class="c-cont"
                style="min-height:400px;max-height:400px;overflow:hidden;display:none;">
                <div class="c-form" style="padding:0;width: auto;">
                    <div class="c-wrap" style="padding:0;">
                        <div class="c-table r-list" style="padding:0;">
                            <div class="tab-t">
                                <div class="ctr">
                                    <a href="javascript:;" class="btn btn-default" onclick="select_all()">全选</a>
                                    <a href="javascript:;" class="btn btn-default" onclick="del_hosttask_more()">删除</a>
                                    <a href="javascript:;" class="btn btn-default" onclick="fresh_task_list()">刷新</a>
                                </div>
                            </div>
                            <div class="box-table" style="overflow: hidden;">
                                <table cellpadding="0" cellspacing="0" id="usertask_list">
                                    <thead>
                                        <tr>
                                            <th width="50"><input type="checkbox" class="form-checkbox"
                                                    id="check_task_page" /></th>
                                            <th>名称</th>
                                            <th width="45">成功数</th>
                                            <th width="45">失败数</th>
                                            <th width="80">状态</th>
                                            <th>错误信息</th>
                                            <th width="50"></th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                    </tbody>
                                </table>
                            </div>
                            <div class="tab-i">
                                <div class="il">
                                    每页显示<span id="page_total">10</span>条 总数：<span id="task_total">25</span> 选中：<span
                                        id="select_total">0</span>
                                </div>

                                <div class="ipage">
                                    <a href="javascript:;" class="nav2 begin" onclick="turn_page(1);"><i></i></a>
                                    <a href="javascript:;" class="nav prev" onclick="turn_page(2)"><i></i></a>
                                    <input type="text" value="1" id="curpage" onchange="turn_page(5)">/ <span
                                        id="totalpage">25</span>
                                    <a href="javascript:;" class="nav next" onclick="turn_page(3)"><i></i></a>
                                    <a href="javascript:;" class="nav2 end" onclick="turn_page(4)"><i></i></a>
                                </div>
                            </div>
                        </div>

                        <div class="clearfix"></div>
                        <!--
    							<div class="btns" style="/*padding: 20px 0 0px;*/">
    								<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
    								<a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a>
    							</div>
    							-->
                    </div>
                </div>
            </div>
        </div>
        <form action="/bhost/import_data" method="POST" name="frm1" enctype="multipart/form-data">
            <input type="hidden" name="z1" value="" />
            <input type="hidden" name="a0" value="" />
            <input type="hidden" name="a1" value="" />
            <input type="hidden" name="a99" value="" />
        </form>

    </div>
	<!-- 添加（编辑）密钥浮层 -->
	<div class="dialog-cont" id="SSHKeyDialog" style="display:none;">
		<div class="container">
			<div class="c-cont" style="max-height: 450px; min-height: 450px;">
				<div class="c-form" style="width:auto; padding: 0px 0 0;">
					<div class="form">
						<div class="form-item">
							<span class="form-tag"><em class="imp">*</em>名称：</span>
							<div class="form-c">
								<input type="text" class="form-text" id="d_n1" name="d_n1" onblur="regCheck(this,nameReg);" maxlength="128">
								<i class="v-check"></i>
								<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
							</div>
						</div>
						<div class="form-item">
							<span class="form-tag">类型：</span>
							<div class="form-c">
								<select class="form-select form-select2" name="Protocol1" id="Protocol1" style="width:150px;">
									<option value="1" selected>私钥</option>
									<option value="0" >公钥</option>
								</select>
							</div>
						</div>
						
						<!-- <div class="form-item">
							<span class="form-tag">状态：</span>
							<div class="form-c" style="margin-top: 3px;">
									<input type="checkbox" class="form-checkbox" id="Enable"/>
									<span style="vertical-align:middle;font-size:16px; color: #000;">启用</span>
							</div>
						</div> -->
						<div class="form-item" style="width: 380px;">
							<span class="form-tag">设置密码：</span>
							<div class="form-c">
								<input type="password" class="form-text" id="Password" name="Password" onblur="" maxlength="128" style="width: 160px;padding-right: 8px;">
									<!-- <p class="form-tip">长度为16位</p> -->
							</div>
						</div>
						<div class="form-item" style="width: 280px;">
							<span class="form-tag" style="width: 92px;">确认密码：</span>
							<div class="form-c" style="padding-left: 100px;">
								<input type="password" class="form-text" id="Password_two" name="Password_two" onblur="" maxlength="128" style="width: 160px;padding-right: 8px;">
									<!-- <p class="form-tip">长度为16位</p> -->
							</div>
						</div>
						<div class="form-item">
							<span class="form-tag"><em class="imp">*</em>内容：</span>
							<div class="form-c">
								<textarea type="textarea" class="form-text" id="content" style="width: 430px; height: 150px; resize: none"></textarea>
							</div>
						</div>
						
					</div>
				</div>

			</div>
			<div class="btns" style="padding: 10px 0 10px;">
				<a href="javascript:;" class="btn btn-normal btn-submit s-hide">保&nbsp;&nbsp;存</a>
				<a href="javascript:;" class="btn btn-normal btn-cancel" >重&nbsp;&nbsp;置</a>
			</div>
		</div>
	</div>
	<form action="/bhost/host_manage" method="POST" name="frm_pwdauth">
		<input type="hidden" name="tasktype" value="0" />
		<input type="hidden" name="se"  value="" />
		<input type="hidden" name="us"  value="zdp" />
	</form>
<!--script-->
<script src="/manage/js/jquery.min.js"></script>
<script src="/manage/js/jquery.easing.js"></script>
<script src="/manage/js/layer.js"></script>
<script src="/manage/js/common.js"></script>
<script src="/manage/js/xSelect.js"></script>
<script type="text/javascript" src="/manage/js/dialog-plus.js"></script>
<!--icheck-->
<script src="/manage/js/icheck.min.js"></script>

<script>
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
</script>

<!--select2-->
<script src="/manage/js/select2.full.min.js"></script>

<script>
$('.filter-select,.form-select').select2({minimumResultsForSearch: -1});
</script>
    <style>
        .fsel {
            position: fixed;
            margin: -67px 0 0 -20px;
            width: 580px;
            height: 45px;
            background: #FFF;
        }

        .fsel ul li {
            float: left;
        }

        .fsel ul li a.active {
            border-top: 5px solid #4cb2d0;
            border-right: 1px solid #DDD;
            border-left: 1px solid #DDD;
            line-height: 41px;
            border-bottom: 1px solid #FFF;
        }

        .fsel ul li a {
            float: left;
            padding: 0 32px;
            line-height: 45px;
            font-size: 18px;
            color: #000;
        }

        .ui-dialog-body {
            padding: 20px 0 0 0;
        }

        #importPage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f3f3;
            overflow: auto;
        }

        .apItem .label.succ:before {
            content: '';
            float: left;
            width: 20px;
            height: 20px;
            margin: 3px 14px 0 14px;
            background: url(/manage/images/user_succ.png) no-repeat 0 0;
        }

        .apItem .label.fail:before {
            content: '';
            float: left;
            width: 20px;
            height: 20px;
            margin: 3px 14px 0 14px;
            background: url(/manage/images/user_fail.png) no-repeat 0 0;
        }

        .apItem {
            width: 50%;
            padding: 5px 0;
            overflow: hidden;
            transition: background-color 0.4s;
            float: left;
        }

        #usertask_list .tab-ctr {
            display: none !important;
        }

        #usertask_list tr:hover td div.tab-ctr {
            display: block !important;
        }
	.apItem tr .label.managefail:before {
		margin: -1px 14px 0 14px;
	}
	.apItem tr .label {
		width: 58px;
	}
    </style>
<style>
.filter .selector.selector-multiple:after {
	content: '';
	display: block;
	border-color: #888 transparent transparent transparent;
	border-style: solid;
	border-width: 5px 4px 0 4px;
	height: 0;
	width: 0px;
	overflow: hidden;
	position: absolute;
	margin: 11px 0 0 9.3em;
}
.hosttree span.h-name {
	width: 16em;
}
.h-name.h-name2{
	margin-top:-6px;
}
.pwdtype{
	position: relative;
	margin: 0px 0px 0px 20px;
}
</style>

    <script>
        var use_BH = window.parent.parent.document.frm.use_BH.value;
        var setinterval = null;
        //全选任务
        var selectid = [];
        function get_task_data() {
            $.ajax({
                url: '/bhost/get_manage_auth_task_data',
                type: "post",
                async: false,
                data: { a0: se, a1: 'null', a2: 'null', a3: 5 },
                success: function (result) {
                    var result = JSON.parse(result);
                    $.each(result.data, function (i, item) {
                        selectid.push(item.AuthImportTaskId);
                    });
                }
            });
        }
        //刷新任务
        function fresh_task_list() {
            get_usertask_list();
            selectid = [];
            $("#details_module input[type='checkbox']").each(function () {
                $(this).iCheck('uncheck');
            });
            $("#select_total").text(0);
        }

        function delete_usertask(typee, id) {
            $.ajax({
                url: '/bhost/del_manage_auth_task',
                type: 'post',
                async: false,
                data: { a0: se, a1: id },
                success: function (result) {
                    del_result = JSON.parse(result);
                    if (del_result.Result) {
                        _alert(0, "密码导入", "删除成功");
                        $('div.tab-moreinfo-on').hide();
                        return false;
                    } else {
                        _alert(1, "密码导入", del_result.ErrMsg);
                        return false;
                    }
                }
            })
        }

        function del_usertask_r(id) {
            $('.btn').blur();
            parent.layer.open({
                type: 1,
                title: "密码导入",
                content: '<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
                btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
                btnAlign: 'c',
                closeBtn: false,
                skin: 'layer-custom',
                area: ['380px', '310px'],
                move: false,
                resize: false,
                btn1: function (i) {
                    parent.layer.close(i);
                    delete_usertask(0, id);
                    for (var i = 0; i < selectid.length; i++) {
                        if (selectid[i] == parseInt(id)) {
                            num = $("#select_total").text();
                            num = parseInt(num) - 1;
                            $("#select_total").text(num);
                            selectid.splice($.inArray(parseInt(id), selectid), 1);
                            break;
                        }
                    }
                    get_usertask_list();
                },
                btn2: function (i) {
                    parent.layer.close(i);
                }
            });
        }
        function _closeDetail(type) {
                if (type == 1) {
                        $('#allPage').hide();
                } else {
                        $('#importPage').hide();
                }
                $(".container3").show();
                _import_user(1);
                $("#task_list_tab").click();
	}
	function filetip(obj){
		////////////console.log("aaaaaaaaaaa");
		var c=$(obj).val();
		////////////console.log(c)
		c = c.split("\\");
		var b = c[c.length-1];
		////////////console.log(b);
		$('#file_v').val(b);
	}
        function _reloadDetail(type) {
                $('#apArea1').empty();
                $('#aploadTip1').html('正在加载').hide();
		page = 0;
		host_name_str = '';
                ppage = 0;
                append_flag = 0;
                row_len = 0;
                remain_page = 0;
                page_flag = 0;
                same_page = 0;
                _initLoadData1();
        }
        //批量删除
        function del_hosttask_more() {
            if (selectid.length == 0) {
                _alert(2, "密码导入", "请选择要删除的数据");
                return;
            }
            $('.btn').blur();
            parent.layer.open({
                type: 1,
                title: "密码导入",
                content: '<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
                btn: ['确定', '取消'],
                btnAlign: 'c',
                closeBtn: false,
                skin: 'layer-custom',
                area: ['380px', '310px'],
                move: false,
                resize: false,
                btn1: function (i) {
                    parent.layer.close(i);
                    selectid_str = selectid.toString();
                    delete_usertask(1, selectid_str);
                    selectid = [];
                    get_usertask_list();
                },
                btn2: function (i) {
                    parent.layer.close(i);
                }
            });
	}
	var MAX_PAGE_T = 5;
	var host_task_id;
	var host_task_IP_id;
        function task_detail(obj, id) {
                var filename = $(obj).attr('data');
                status = $(obj).attr('data1');
                var host_count = $(obj).attr('data2');
                var acct_count = $(obj).attr('data3');
                $("#hosttask_list_detail tbody").empty();
                $("#cover_box").iCheck('uncheck');
                $("#import_host_list_detail tbody").empty();
                $(".tab-moreinfo.tab-moreinfo-on").remove();
                $('#apArea').empty();
                $('#apArea1').empty();
		page = 0;
		host_name_str = '';
                ppage = 0;
                append_flag = 0;
                row_len = 0;
                remain_page = 0;
                page_flag = 0;
                same_page = 0;
                keyword_t = null;
                if (status == 0) {
                        _alert(2, "管理授权", "该任务正在导入中");
                        return false;
                }
                if (status == 2) {//导入中断
                        _alert(1, "管理授权", "该任务发生错误");
                        return false;
                }
                d.close().remove();
                var succ_flag = $(obj).parents('tr:first').children('td:eq(2)').text();
                var fail_flag = $(obj).parents('tr:first').children('td:eq(3)').text();
                clearInterval(if_ok);
                if (status == 1) {//导入完成
                        $("#fail_IP_box").iCheck('uncheck');
                        $(".mm.mm1").children('span').eq(0).text(parseInt(succ_flag) + parseInt(fail_flag));
                        $(".mm.mm1").children('span').eq(1).text(parseInt(succ_flag) + parseInt(fail_flag));
                        $(".mm.mm1").children('span').eq(2).text(succ_flag);
                        $(".mm.mm1").children('span').eq(3).text(fail_flag);
                        host_task_IP_id = id;
                        _initLoadData1();
                        $("#fail_IP_box").on('ifChanged', function () {//仅显示导入失败的用户信息
                                if ($(this).prop("checked")) {
                                        keyword_t = 1;
                                } else {
                                        keyword_t = null;
                                }
                                $('#apArea1').empty();
				page = 0;
				host_name_str = '';
                                ppage = 0;
                                append_flag = 0;
                                row_len = 0;
                                remain_page = 0;
                                page_flag = 0;
                                same_page = 0;
                                _initLoadData1();
                        });
                        $(".container3").hide();
                        $('#importPage').show();
                }
        }
        var append_flag = 0;
        var ppage = 0;
        var row_len = 0;
        var remain_page = 0;
        var page_flag = 0;
        var same_page = 0;

        var page = 0;
	var host_name_str = '';
	var host_name_id = '';
        function get_data_i(type_add) {
		if ($("#apArea1").find('.apSort').length == 0) {
			$("#apArea1").append('<div class="apSort"></div>');
		}
                $('#aploadTip1').show();
                var html = '';
                var Status;
                var npage = 0;

                var page_i = -1;
                var page_re = 0;
                if (import_list_detail.data.length == 0) {
		}
                $.each(import_list_detail.data, function (i, item) {
			if(item.AuthName.indexOf('主机:')>=0){
				var label_class='';
				if (item.Status == 0) {
					Status = "成功";
					label_class='label managesucc';
				} else if (item.Status == 1) {
					Status = "失败：" + item.ErrorLog;
					label_class='label managefail';
				}
				var AuthName_arr= item.AuthName.split('\t')
				if (host_name_str== AuthName_arr[0]){
					html = '<tr><td style="" title="' + AuthName_arr[1] + '"><div class="' + label_class +'"></div>' + AuthName_arr[1] + '<span class="a"></span></td><td style="width:225px;">' + Status + '<span class="a"></span></td></tr>';
					$('#'+ host_name_id+' table tbody').append(html);
				}else{
					host_name_str= AuthName_arr[0];
					host_name_id='authd-' + item.AuthImportTaskDetailId
					html = '<div class="apItem" style="width: 100%;" id="authd-'+item.AuthImportTaskDetailId+'"><div class="label" title="' + host_name_str + '" style="width:210px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">' + host_name_str + '</div><div class="cc" style="padding-left: 210px;">'+
					'<table cellpadding="0" cellspacing="0"><tbody><tr><td style="" title="'+ AuthName_arr[1]+'"><div class="'+ label_class+'"></div>' + AuthName_arr[1] + '<span class="a"></span></td><td style="width:225px;">' + Status + '<span class="a"></span></td></tr>';
					html += '</tbody></table></div></div>';
					$('#apArea1').find('.apSort:last').append(html);
				}
			}else{
				host_name_id='';
				host_name_str='';
				if (item.Status == 0) {
					Status = "成功";
					html = '<div class="apItem"><div class="label managesucc" title="' + item.AuthName + '" style="width:50%;     white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">' + item.AuthName + '</div><div class="cc" style="padding-left: 50%;"><table cellpadding="0" cellspacing="0"><tbody><tr><td style="width:153px;">' + Status + '<span class="a"></span></td></tr>';
				} else if (item.Status == 1) {
					Status = "失败：" + item.ErrorLog;
					html = '<div class="apItem"><div class="label managefail" title="' + item.AuthName + '" style="width:50%;     white-space: nowrap;overflow: hidden;text-overflow: ellipsis; text-overflow: ellipsis;">' + item.AuthName + '</div><div class="cc" style="padding-left: 50%;"><table cellpadding="0" cellspacing="0"><tbody><tr><td style="width:153px;">' + Status + '<span class="a"></span></td></tr>';
				}
				html += '</tbody></table></div></div>';
				$('#apArea1').find('.apSort:last').append(html);
			}
		});
                html = '<div class="ap-pc"> 共' + import_list_detail.totalrow + '条</div>';
		$("#apArea1").find('.ap-pc:last').remove();
		$('#apArea1').append(html);
                var maxPage = Math.floor(import_list_detail.totalrow / 10);

                var task_page = page - 1,
                        num = 10;
                var pnum = (task_page * num + 1) + '-' + (task_page + 1) * num;
                if ((task_page + 1) * num > import_list_detail.totalrow) {
                        pnum = (task_page * num + 1) + '-' + import_list_detail.totalrow;
                }
                if (task_page >= maxPage) {
                        $('#aploadTip1').html('已全部加载').show();
                        return;
                } else if (task_page < maxPage) {
                        $('#aploadTip1').hide();
                }
                if (type_add < 1) {
                        type_add++;
                        _addData1(type_add);
                }
	}
	 $('#importPage').scroll(function () {
		var wh = $('#importPage').height(),
			vh = $('#apArea1').height(),
			st = $('#importPage').scrollTop();

		if (wh + st >= vh) {
			_addData1(0);
		}
	})
        var import_list_detail;
        function _addData1(type_add) {
                if ($('#aploadTip1').is(':visible')) {
                        return;
                }
                page++;
                var offsetrow = (page - 1) * 10;
                get_import_detail_user(host_task_IP_id, 10, offsetrow);
                get_data_i(type_add);
        }
        function _initLoadData1() {
                var h1 = $('#importPage').height();
                var h2 = $('#apArea1').height();
                var add = function () {
                        if (h1 - 203 > h2) {
                                page++;
                                var offsetrow = (page - 1) * 10;
                                get_import_detail_user(host_task_IP_id, 10, offsetrow);
                                get_data_i(0);
                                h2 = $('#apArea1').height();
                        } else {
                                clearInterval(if_select1);
                                return false;
                        }
                }
                var if_select1 = setInterval(function () {
                        if (row_len < 10) {
                                clearInterval(if_select1);
                                return false;
                        }
                        if (row_len == 10 && import_list_detail.totalrow == 10) {
                                clearInterval(if_select1);
                                return false;
                        }
                        add();
                }, 1000);

                add();
        }
        function get_import_detail_user(id, limitrow, offsetrow) {
                $.ajax({
                        url: '/bhost/get_import_detail_manage_auth',
                        type: 'post',
                        async: false,
                        data: { 'a0': se, 'a1': id, 'a2': keyword_t, a3: limitrow, a4: offsetrow },
                        success: function (result) {
				import_list_detail = JSON.parse(result);
				$(".mm.mm1").children('span').eq(0).text(import_list_detail.totalrow);
                        }
                });
        }
        function select_all() {
            selectid = [];
            var select_total = $("#select_total").text();
            var task_total = $("#task_total").text();
            if (parseInt(select_total) == parseInt(task_total)) {
                $("#usertask_list").find('input').iCheck('uncheck');
            } else {
                get_task_data();
                $("#usertask_list tbody input[type='checkbox']").each(function () {
                    if (!$(this).prop("disabled")) {
                        $(this).iCheck('check');
                    }
                })
            }
            $("#select_total").text(selectid.length);
        }
        var MAX_PAGE_T = 5;
        function browes() {
            if (use_BH == '0') {
                $("#file_change1").click();
                return 0;
            }
            var referrer_arr = document.referrer.toString().split('/');
            referrer_arr.pop();
            var referrer = referrer_arr.join('/');
            var sesstimet = (new Date()).valueOf();
            var json_download = {
                "Type": "Upload",
                "Url": referrer,
                "Path": "/usr/storage/.system/upload/",
                "Filename": sesstimet + '',
                "Session": window.parent.document.frm.se.value,
                "sesstimet": sesstimet + ''
            }
            var if_html_client = false;
            var base64_str = '';
            $.ajax({
                url: "/bhost/get_base64",
                type: "POST",
                async: false,
                data: { a0: window.parent.document.frm.se.value, z1: JSON.stringify(json_download) },
                success: function (result) {
                    var result = JSON.parse(result);
                    if (result.Result) {
                        if_html_client = result.info;
                        base64_str = result.b64;
                    } else {
                        _alert(1, "密码导入", result.ErrMsg);
                    }
                }
            })
            if (if_html_client) window.open('https://' + document.domain + ':' + location.port + '/bhost/test_html?se=' + window.parent.document.frm.se.value + '&z1=' + JSON.stringify(json_download));
            else {
                get_regedit('bhost', window.parent.document.frm.se.value, '', sesstimet);
                $('#YuFrame1').remove();
                $("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
                $('#YuFrame1').attr('src', '/bhost/test_html?t1=bhost&z1=' + base64_str);
            }
            clearInterval(setinterval);
            setinterval = setInterval(function () {
                $.ajax({
                    url: "/bhost/find_item_sql",
                    type: "POST",
                    async: false,
                    data: { a0: window.parent.document.frm.se.value, a1: sesstimet },
                    success: function (result) {
                        var result = JSON.parse(result);
                        if (result.Result) {
                            if (result.info == null) {

                            } else {
                                var info_arr = result.info.split('/');
                                if (info_arr.length > 1) {
                                    $('#file_v').val(info_arr.pop());
                                    $('#file_change').val('/usr/storage/.system/upload/' + sesstimet);
                                } else {
                                    if (result.info == 'NULL') {
                                        $('#file_v').val('');
                                        $('#file_change').val('');
                                    } else {
                                        $('#file_v').val(result.info);
                                        $('#file_change').val('/usr/storage/.system/upload/' + sesstimet);
                                    }
                                }
                                clearInterval(setinterval);
                            }
                        }
                    }
                });
            }, 3000);
        }
        //切换导入/任务
        var if_ok = null;
        function set_tab(obj, type) {
            if (type == 1) {
                $("#import_module").show();
                $("#details_module").hide();
            } else if (type == 2) {
                $("#details_module").show();
                $("#import_module").hide();
            }
            $(obj).addClass("active").parent().siblings().children().removeClass("active");
            if (type == 2) {
                clearInterval(if_ok);
                get_usertask_list();
                repeat_execute = function () {
                    if_ok = setInterval(function () {
                        get_usertask_list();
                    }, 5000)
                }
                repeat_execute();
            } else {
                clearInterval(if_ok);
            }
            var w = $(window).width();

        }
        function _export_user(type) {
            if (type == 1) {
                _export();
            } else {

            }
        }
        function _export() {
            var data = [
                ['*密钥名称', '密码', '*内容'],
                ['特殊字符仅支持下划线、横杠、小数点', '密码格式', ''],
                ['只能保存为私钥', '', ''],
                ['*主机IP', '*账号详情', '密码', '密钥'],
                ['IP格式', '默认只填账号', '密码格式', '密钥-密钥名称'],
                ['', '"可单独修改某协议中的账号，例如：账号:协议(端口),协议(端口);账号:协议(端口)"', '空密码：-', ''],
                ['', '所有账号：[*]', '无密码：[-]', ''],
                ['', '所有账号：[*]', '不填为不设置密码', ''],
            ];
            var csvContent = "data:text/csv;charset=utf-8,\ufeff";
            if (window.navigator.msSaveOrOpenBlob) {
                csvContent = "\ufeff";
            }
            data.forEach(function (infoArray, index) {
                dataString = infoArray.join(",");
                csvContent += index < data.length ? dataString + "\n" : dataString;
            });
            if (window.navigator.msSaveOrOpenBlob) {
                // if browser is IE
                var blob = new Blob([decodeURIComponent(encodeURI(csvContent))], {
                    type: "text/csv;charset=utf-8;"
                });
                navigator.msSaveBlob(blob, '密码导入模板.csv');
            } else {
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "密码导入模板.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        //任务列表翻页
        function turn_page(type) {
            switch (type) {
                case 1: //首页
                    $("#curpage").val(1);
                    break;
                case 2://上一页
                    var cur = $("#curpage").val();
                    if (cur == '1') {
                        return false;
                    } else {
                        $("#curpage").val((parseInt(cur) - 1));
                    }
                    break;
                case 3://下一页
                    var cur = $("#curpage").val();
                    var total = $("#totalpage").text();
                    ////////////console.log("cur")
                    if (cur == total) {
                        return false;
                    } else {
                        $("#curpage").val((parseInt(cur) + 1));
                    }
                    break;
                case 4:
                    $("#curpage").val($("#totalpage").text());
                    break;
                case 5:
                    var cur = $("#curpage").val();
                    var numReg = /\D/;
                    if (numReg.test(cur) || parseInt(cur) < 1 || cur == '') {
                        $("#curpage").val(1);
                    }
                    break;
                default:
                    ;
            }
            get_usertask_list();
        }
        function get_usertask_list() {
            var MAX_PAGE = 5;
            var cur = $("#curpage").val();
            $.ajax({
                url: '/bhost/get_manage_auth_task_data',
                type: 'post',
                async: false,
                data: { a0: se, a1: cur, a2: MAX_PAGE, a3: 5 },
                success: function (result) {
                    task_list = JSON.parse(result);
                    $("#usertask_list tbody").empty();
                    var Status = "";
                    var succcount;
                    var FailCount;
                    var ErrorLog;
                    $.each(task_list.data, function (i, item) {
                        if (item.Type != 5) return true;
                        if (item.Status == 0) {
                            Status = "正在执行";
                        } else if (item.Status == 1) {
                            Status = "执行完成";
                        } else if (item.Status == 2) {
                            Status = "执行失败";
                        }
                        if (item.SuccCount == null) {
                            SuccCount = "";
                        } else {
                            SuccCount = item.SuccCount;
                        }
                        if (item.FailCount == null) {
                            FailCount = "";
                        } else {
                            FailCount = item.FailCount;
                        }
                        if (item.ErrorLog == null) {
                            ErrorLog = "";
                        } else {
                            ErrorLog = item.ErrorLog;
                        }
                        var HostCount = parseInt(SuccCount) + parseInt(FailCount);
                        float_str = "<p>错误信息：" + ErrorLog + "</p>";
                        $("#usertask_list tbody").append('<tr><td width="50"><input type="checkbox" class="form-checkbox" value="' + item.AuthImportTaskId + '"/></td><td title="' + item.AuthImportTaskName + '">' + item.AuthImportTaskName + '</td><td title="' + SuccCount + '">' + SuccCount + '</td><td title="' + FailCount + '">' + FailCount + '</td><td title="' + Status + '">' + Status + '</td><td title="' + ErrorLog + '">' + ErrorLog + '</td><td width="50"><div class=\"tab-ctr\"><a href="javascript:;" class="icon7" id="edit" title="导入详情" data="' + item.AuthImportTaskName + '" data1="' + item.Status + '"onclick="task_detail(this,' + item.AuthImportTaskId + ');"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" title="删除任务" onclick=\"del_usertask_r(' + item.AuthImportTaskId + ')\"></a></div><div class="tab-moreinfo">' + float_str + '</div></td></tr>');
                    });
                    $('#usertask_list .form-checkbox,.form-radio').iCheck({
                        checkboxClass: 'icheckbox_minimal-blue',
                        radioClass: 'iradio_minimal-blue',
                        increaseArea: '0'
                    });
                }
            });
            tabArr1();
            $("#task_total").text(task_list.totalrow);
            totalpage = Math.ceil(parseInt(task_list.totalrow) / MAX_PAGE);
            if (totalpage < 1) {
                totalpage = 1;
            }
            $("#totalpage").text(totalpage.toString());
            $("#page_total").text(MAX_PAGE);
            //<tr>中选择按钮进行设置
            $('#check_task_page').iCheck('uncheck');
            var check_page_flag = 0;
            $("#usertask_list tbody input[type='checkbox']").each(function () {
                if ($.inArray(parseInt(this.value), selectid) != -1) {
                    $(this).iCheck('check');
                    check_page_flag++;
                }
            });
            if (check_page_flag == $("#usertask_list tbody input[type='checkbox']").length && check_page_flag != 0) {
                $('#check_task_page').iCheck('check');
            }
            if (parseInt(cur) > totalpage) {
                $("#curpage").val(totalpage);
                get_usertask_list();
            }
            var flag_id = 0;
            num = selectid.length;
            $("#select_total").text(num);
            $("#usertask_list tbody input[type='checkbox']").unbind().on("ifChanged", function () {
                if ($(this).is(":checked")) {
                    num = $("#select_total").text();
                    num++;
                    if (selectid.indexOf(parseInt(this.value)) == -1) {
                        selectid.push(parseInt(this.value))
                    }
                    $("#select_total").text(num);
                } else {
                    num = $("#select_total").text();
                    num--;
                    selectid.splice($.inArray(parseInt(this.value), selectid), 1);
                    $("#select_total").text(num);
                }
                var check_num = 0;
                $("#usertask_list tbody input[type='checkbox']").each(function () {
                    if (!$(this).prop("disabled")) {
                        check_num++;
                    }
                })
                if ($("#usertask_list tbody").find('input[type=checkbox]:checked').length == check_num) {
                    $('#check_task_page').iCheck('check');
                } else {
                    $('#check_task_page').iCheck('uncheck');
                }
            });
            $('#check_task_page').unbind().on('ifClicked', function (e) {
                if (!$('#check_task_page').prop('checked')) {
                    $("#usertask_list tbody input[type='checkbox']").each(function () {
                        $(this).iCheck('check');
                    })
                } else {
                    $("#usertask_list").children('tbody').find('input[type=checkbox]').iCheck('uncheck');
                }
            });
        }
        //弹窗列表绑定
        function tabArr1() {
            $('table').unbind();
            var tout, tin;
            var $cloneItem;
            var z = false;

            $('#usertask_list').on('mouseover', 'tbody>tr', function () {
                document.onclick = null;
            }).on('mouseout', 'tbody>tr', function () {
                document.onclick = function () {
                    $('div.tab-moreinfo-on').hide();
                    $('tr.on').removeClass('on');
                }
            }).on('click', 'tbody>tr', function (e) {
                x = e.target;
                if (x.id == 'del') {
                    return false;
                }
                if (x.id == 'edit') {
                    return false;
                }
                document.onclick = null;

                var $this = $(this);

                var $tr = $this;

                var oset = $tr.offset();
                var trc = $tr.attr('class');
                if (trc && trc.indexOf('on') >= 0) {
                    $('div.tab-moreinfo-on').hide();
                    $('div.tab-moreinfo-on').remove();
                    $('tr.on').removeClass('on');
                    return;
                }

                $('div.tab-moreinfo-on').hide();
                $('tr.on').removeClass('on');
                $tr.addClass('on');

                var $box = $this.parents('div.box-table');
                var boxh = $box.outerHeight(), boxo = $box.offset();

                var $item = $this.children('td:last').children('div.tab-moreinfo');
                var ih = $item.outerHeight(), th = $tr.outerHeight();
                $cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');
                if (boxh < oset.top - boxo.top + ih + th - 40) {
                    $cloneItem.css({
                        top: oset.top - ih,
                        left: oset.left,
                        width: $tr.outerWidth() - 1,
                        opacity: 0,
                        display: 'block'
                    }).stop().animate({
                        opacity: 1
                    });
                } else {
                    $cloneItem.css({
                        top: oset.top + $tr.outerHeight() + 1,
                        left: oset.left,
                        width: $tr.outerWidth() - 1,
                        opacity: 0,
                        display: 'block'
                    }).stop().animate({
                        opacity: 1
                    });
                }
                //$cloneItem.prev('div').remove();
                z_v = $cloneItem.prev('div').css('z-index');
                $cloneItem.css('z-index', z_v + 1);
            });
            $('.box-table,body,.c-cont2,.c-cont').on('scroll', function () {
                $('div.tab-moreinfo-on').remove();
                $('tr.on').removeClass('on');
            })

            var len = $('#usertask_list .tab-ctr:first').children('a').length;
            $('#usertask_list>thead>tr>th:last').width(len * 26);
        }
        function _import_user(type) {
            $("#file_v").val('');
            $("#file_change").val(''); $("#file_change1").val('');
            $("#pending_box").iCheck('uncheck');
            $("#cover_box1").iCheck('uncheck');
            //$("#curpage").val(1);
            var $dialogCont = $("#scDCTab2_import").show();
            d = dialog({
                title: "密码导入",
                content: $dialogCont,
                id: "scDCTab2_import",
                width: "850px"
            });
            d.addEventListener('close', function () {
                $dialogCont.appendTo("body").hide();
                if (if_ok == null) {
                } else {
                    clearInterval(if_ok);
                }
            });
            d.showModal();
            if (type == 1) {
                $("#import_module").show();
                $("#details_module").hide();
                $("#task_import").addClass("active").parent().siblings().children().removeClass("active");

            }
            $("a.btn-cancel", $dialogCont).unbind().bind("click", function () {
                d.close().remove();
            });
            $("a.btn-submit", $dialogCont).unbind().bind("click", function () {
                if ($("#details_module").is(':visible')) {
                    d.close().remove();
                    return false;
                }
                var cover_flag = 0;
                var pending_flag = 0;
                if ($("#file_v").val() == "") {
                    _alert(2, "密码导入", "请选择文件");
                    return false;
                }
                var file_v = $("#file_v").val();
                var fileReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
                if (!fileReg.test(file_v)) {
                    _alert(1, "密码导入", "导入文件名称格式不正确");
                    return false;
                }
                var len4 = file_v.substr(file_v.length - 4).toLowerCase();
                var len5 = file_v.substr(file_v.length - 5).toLowerCase();
                if (len4 != ".csv" && len4 != '.xls' && len5 != '.xlsx') {
                    _alert(1, "密码导入", "导入文件格式不正确，只支持.CSV、.XLS格式文件");
                    return false;
                }
                var file_name = file_v.substring(0, file_v.length - 4);

                var file_exist = 0;
                var formData_f = new FormData($("#uploadForm")[0]);
                formData_f.append('a0', se);
                $.ajax({
                    url: '/bhost/isexist_import_pwd',
                    type: 'post',
                    data: formData_f,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (result) {
                        var is_r = JSON.parse(result);
                        if (is_r.Result) {
                            file_exist = 0;
                        } else {
                            file_exist = 1;
                            _alert(2, "密码导入", "该任务已存在");
                            return false;
                        }
                    }
                });
                if (file_exist == 1) {
                    return false;
                }
                if ($("#cover_box1").prop('checked')) {
                    cover_flag = 1;
                } else {
                    cover_flag = 0;
                }
                var formData = new FormData($("#uploadForm")[0]);
                formData.append('a1', cover_flag);
                formData.append('a0', se);
                formData.append('a99', use_BH);

                $.ajax({
                    url: '/bhost/import_data_pwd',
                    type: 'POST',
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (result) {
                        $("#file_v").val('');
                        $("#file_change").val(''); $("#file_change1").val('');
                        $("#cover_box1").iCheck('uncheck');
                        $.ajax({
                            url: '/bhost/get_manage_auth_task_data',
                            type: 'post',
                            async: false,
                            data: { a0: se, a1: 1, a2: 5, a3: 5 },
                            success: function (result) {
                                var task_list_data = JSON.parse(result);
                                var totalpage = Math.ceil(parseInt(task_list_data.totalrow) / MAX_PAGE_T);
                                if (totalpage < 1) {
                                    totalpage = 1;
                                }
                                $("#curpage").val(1);
                                set_tab($("#task_list_tab"), 2);
                            }
                        });
                        set_tab($("#task_list_tab"), 2);
                    }
                });
            });
        }
        var format = 0;

    </script>
<script>
var se;
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
$(function(){
	se = window.parent.document.frm.se.value;
	_initSize();
	_initList();
	$("#s_p").on("ifChanged",function(){
		if ($(this).prop("checked")){
			$("#n_p").val("");
			$("#c_p").val("");
			$("#n_p").attr("disabled",true);
			$("#c_p").attr("disabled",true);
		}else{
			$("#n_p").attr("disabled",false);
			$("#c_p").attr("disabled",false);
		}
	});
	$('#password_check').on('ifChecked',function (event) {
		$('#password_form_item1').show();
		$('#password_form_item2').show();
	}).on('ifUnchecked',function (event) {
		$('#password_form_item1').hide();
		$('#password_form_item2').hide();
	});
	$('#sshkey_check').on('ifChecked',function (event) {
		$('#sshkey_form_item1').show();
	}).on('ifUnchecked',function (event) {
		$('#sshkey_form_item1').hide();
	});
});

$(window).resize(function(){
	_initSize();
});

function _initSize(){
	var h = $(window).height();
	$('.h-content2').height(h-255);
}
//var hdata;
function _initList(){
	//var data = Data;
	bind_SSHkey_xSelect();
	get_hostdirectory(-1);
    _viewHTML(h_data,'#userTree');
	
	$('#userTree').on('click','i.h-aicon',function(){
		var $item = $(this);
		var id = $item.data('id').split('-')[1];
		var t = $item.data('id').split('-')[0];
		var $u = $item.parent().children('ul');
		if($u.is(':hidden')){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2,d = 1;
				var $input = $(this).siblings('span.checkbox');
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}
			_initHTML($u,id,v,d,t);
			}
		}else{
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	}).on('dblclick', 'i.h-eicon,span.h-name', function () {
		var i_class_arr = $(this).siblings('i.h-aicon');
		if (i_class_arr.length == 0) {
			return false;
		}
		var $item = i_class_arr;
		var id = $item.data('id').split('-')[1];
		var t = $item.data('id').split('-')[0];
		var $u = $item.parent().children('ul');
		if ($u.is(':hidden')) {
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
    			var v = 2,d = 1;
    			var $input = $(this).siblings('span.checkbox');
		    	var c = $input.attr('class');
		    	if(c.indexOf('checked')>0){
		    		v=1;
		    	}else if(c == 'checkbox'){
		    		v=0;
		    	}
				_initHTML($u,id,v,d,t);
    		}
		} else {
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	});
}

//绑定密钥
var SSHkeyData;
var SSHkey_index_all;
function binding_SSHkey() {
	$.ajax({
		url: '/bhost/get_sshkey_host',
		type: "post",
		async: false,
		cache: false,
		data: { a0: se },
		success: function (Result) {
			result = JSON.parse(Result)
			SSHkeyData = result.info.data;
		}
	});
}	

function bind_SSHkey_xSelect(){
	binding_SSHkey();
	var ssh_array = [{
		'value':-1,
		'name':'请选择'
	}];
	SSHkey_index_all = [];
	$.each(SSHkeyData,function(i,item){
		if(item.IfValid == true){
			var select_data_json = {
				'value':1,
				'name':'admin2'
			};
		}else{
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'type':'edit'
			};
		}
		select_data_json.value = item.SshKeyId;
		select_data_json.name = item.KeyName;
		ssh_array.push(select_data_json);
		SSHkey_index_all.push(item.SshKeyId);
	});
	var SSHkey_s_value=$('#SSHkey_s').data('value');
	if(SSHkey_s_value==undefined){
		SSHkey_s_value=-1;
	}
	var SSHkey_s_text=$('#SSHkey_s').children().find('span').text();
	if(SSHkey_s_text=='' || SSHkey_s_text==undefined){
		SSHkey_s_text='请选择';
	}
	$("#SSHkey_s").empty().data('xSelect','');
	$('#SSHkey_s').xSelect({
		width: 192,
		defaultText: '请选择',
		items:ssh_array,
		module_type:'SSHkey_s',
		edit: function(item,obj){
			$('.'+$('.xSelect_SSHkey .xSelect-show').data('id')).hide();
			_addNew3(obj,1);
		},
		btn:[
			{
				'name':'新增',
				'event': function(items,obj){
					_addNew3(obj,0);
				}
			}
		],
		setval:function(item,obj){
		}
	});	
	$('#SSHkey_s').data('value',SSHkey_s_value);
	$('#SSHkey_s').children().find('span').text(SSHkey_s_text);
}
function clear_sshkey(){
	$("#d_n1").val("");
	$("#d_n1").attr("disabled",false);
	$("#SSHKeyDialog .v-check").attr("class","v-check");
	$("#Protocol1").val("1").trigger('change');
	$("#Protocol1").attr('disabled','true');
	$('#Password').val('');
	$('#Password_two').val('');
	$("#Enable").iCheck('uncheck');
	$("#content").val("");
}
function editKey(id){
	$.ajax({
		url: '/bhost/get_sshkey',
		type: "POST",
		async: false,
		data: { a0: se, a1: id, a2: null},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result == true) {
				key_Data = result.info.data[0];
				$("#d_n1").val(key_Data.KeyName);
				$('#d_n1').attr('disabled',true);
				$("#content").val(key_Data.KeyContent);
				$('#Password').val(key_Data.Password);
				$('#Password_two').val(key_Data.Password);
			} else {
				_alert(1, "密钥管理", result.ErrMsg, $("#d_n1"));
				return false;
			}
		}
	});
}
function _addNew3(obj,type){
	editkey1 = obj;
	editkey2 = type;
	clear_sshkey();
	sshkey = {
		"SshKeyId": 0,
		"KeyName": null,
		"KeyType": 0,
		"KeyContent": null,
		"IfValid": false,
		"Password":null
	};	
	if(type == 0){
		SshKeyId = 0;
	}else{
		//console.log($(obj));
		SshKeyId = $(obj).children('span').attr('data-value');
		sshkey.SshKeyId = SshKeyId
		editKey(SshKeyId);
	}

	var $dialogCont = $("#SSHKeyDialog").show();
	$('.type-select').select2();
	title = "密钥";
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"SSHKeyDialog",
		width:"800px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	
	$(".ui-dialog-title").css("width","125px");
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		clear_sshkey();
		if(type == 0){
			SshKeyId = 0;
		}else{
			SshKeyId = $(obj).children('span').attr('data-value');
			sshkey.SshKeyId = SshKeyId
			editKey(SshKeyId);
		}
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		var p_id = $("#Protocol1").val();
		var val = $("#d_n1").val();
		var $i = $("#d_n1").next('i.v-check');
		//事件告警信息名
		if (val == "") {
			_alert(2, "密钥", '请输入名称', $("#d_n1"));
			return false;
		}
		if (!nameReg.test(val)) {
			_alert(1, "密钥", '名称格式不正确', $("#d_n1"));
			//$("#d_n1").val("");
			return false;
		}

		sshkey.KeyName = val;
		var Password=$('#Password').val().trim();
		var Password_two=$('#Password_two').val().trim();
		if(Password==''){
			Password=null;
		}else if(Password!=Password_two){
				_alert(2, "密钥","两次密码不匹配",$("#Password_two"));
				return false;
		}
		sshkey.Password=Password;
		var content = $("#content").val();
		var keycheck = /^[\u4e00-\u9fa5]+$/;
		if(content==""){
			_alert(2, "密钥", '请填写密钥内容', $("#content"));
			return false;
		}
		if(keycheck.test(content)){_alert(1, "密钥", '密钥格式不正确', $("#content"));return}
		if($("#d_n1").val().length>32) {
			_alert(1, "密钥", '密钥名称已达到最大值', $("#d_n1"));
			return false;
		}
		sshkey.KeyContent = content;
		sshkey.KeyType = parseInt(p_id);
		msstr = aceg(JSON.stringify(sshkey),se);
		$.ajax({
			url: '/bhost/add_sshkey_host',
			type: "POST",
			async: false,
			data: { a0: se, a1: JSON.stringify(sshkey), a10: "密码管理>密码录入",m1:msstr},
			success: function (result) {
				var result = JSON.parse(result);
				if (result.Result == true) {
					$('.btn').blur(); parent.layer.open({
						type: 1,
						title: '密钥',
						content: '<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							d.close().remove();
							parent.layer.close(i);

							var id_str = $("#SSHkey_s").data('value');
							var name_str = $("#SSHkey_s").children().find('span').text();
							if(name_str == '请选择'){
								$("#SSHkey_s").data('value',result.SshKeyId);
								$("#SSHkey_s").children().find('span').text(val);
								bind_SSHkey_xSelect();
							}else{
								$("#SSHkey_s").data('value',id_str);
								$("#SSHkey_s").children().find('span').text(name_str);
								bind_SSHkey_xSelect();
							}
						}
					});
				} else {
					_alert(1, "密钥管理", result.ErrMsg, $("#d_n1"));
					return false;
				}
			}
		});
	})
}
//获取host
var h_data;
function get_hostdirectory(id){
	$.ajax({
		url:'/bhost/get_hostdirectory_pwd',
		type:'post',
		async:false,
		data:{a0:se,z1:id},
		success:function(result){
			count_ajax = count_ajax + 1;
			h_data = JSON.parse(result);
		}
	});
}
//获取账号
function get_host(id){
	$.ajax({
		url:'/bhost/get_host_pwd',
		type:'post',
		async:false,
		data:{a0:se,z1:id},
		success:function(result){
			adata = JSON.parse(result);
		}
	});
}
var _jScrollBar_array = [];
function _jScrollBar(scid) {
	var myBar = new MyScrollBar({
		selId:scid,
		hasX:true,
		hasY:false,
		width:6,
		// enterShow:false,
	})
}

var append_hgroup_list = [];
var loading_hgid=0;
var _initHTML_time=0;
var _initHTML_id_array=new Array();
var _initHTML_MAX=10;
function get_hostdirectory1(obj,id,v,d){
	flag_loading = true;
	var loading_hgid;
	/*
	if($.inArray(id,_initHTML_id_array)<0){
		_initHTML_id_array.push(id);
	}else{
		flag_loading=false;
		return false;
	}
	*/
	$.ajax({
		url:'/bhost/get_hostdirectory_pwd',
		type:'post',
		async:true,
		cache:false,
		data:{a0:se,z1:id,z2:ajax_find_host_doing?'true':'false'},
		success:function(result){
			//_initHTML_id_array.splice($.inArray(id,_initHTML_id_array),1);
			var hdata = JSON.parse(result);
			loading_hgid = id;
			disabled_flag = "";
			var loadfirst = 0;
			var loadlast = 0;
			var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
			var _p_loadfirst = $(obj).siblings('input').attr('data-loadfirst');
			var _p_loadlast = $(obj).siblings('input').attr('data-loadlast');
			var auth_type_checked = false;
			
			if ($(obj).siblings('span.authtype').find('input').length != 0){
				auth_type_checked = $(obj).siblings('span.authtype').find('input').prop('checked');
			}
			if ((_p_loadfirst == 0) && (_p_loadlast == 0)){
				//auth_type_checked = true;
			}
			if (auth_type_checked){
				disabled_flag = "";
			}
			
			if (_p_loadfirst == _p_loadlast){ 
				if (_p_loadlast == 2){
					loadfirst = 2
					loadlast = 2;
									}
			}else{
				//loadlast = _p_loadlast;
				if (_p_loadlast == 2){
					loadlast = 2;
				}
				if (_p_loadfirst == 2){
					loadfirst = 2;
				}
				
			}
			if(hdata.data.HGroup == null) hdata.data.HGroup = [];
			$.each(hdata.data.HGroup,function(i,item){
				var $H = $('<li></li>');
				
				if((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
				else i_class = "h-aicon";
				
				//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
				//data-loadlast(最后保存的状态) 
				if(v==1 && d == 0){
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" checked="checked" id="nodehg-'+item.HGId+'" data-check="1" data-name="'+item.HGName+'" class="zcheck zcheck-g" disabled data-mode="2" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
							    return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+'</span><ul style="display:none">Loading...</ul>');
				}else if(v==1){ //v == 1 d ==1
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" checked="checked" id="nodehg-'+item.HGId+'" data-name="'+item.HGName+'" data-check="1" class="zcheck zcheck-g" data-mode="2" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
							    return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+'</span><ul style="display:none">Loading...</ul>');
				}else if(v==0){
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" id="nodehg-'+item.HGId+'" data-check="0" data-name="'+item.HGName+'" class="zcheck zcheck-g" data-mode="2" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
							    return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+'</span><ul style="display:none">Loading...</ul>');
				}else{
					$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" id="nodehg-'+item.HGId+'" data-mode="2" data-check="0" data-name="'+item.HGName+'" class="zcheck zcheck-g" '+disabled_flag+' data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false ><i class="h-eicon h-eicon-g"></i><span class="h-name" id="spanHG-' + item.HGId + '" style="width: 12em;">'+'<span class="h-name-son" style="">' + 
							item.HGName.split('').map(function (params) {
							  return '<font>'+params+'</font>'    
							}).join('') + 
							'</span>'+'</span><ul style="display:none">Loading...</ul>');
					
				}
				$(obj).append($H);
			})
			_checkView_host(obj);
			if(hdata.data.Host == null) {
				hdata.data.Host = [];
				flag_loading = false;
				_closeLoading();
				return false;
			}
			var i = 0;
			var index = 0;
			$.each(hdata.data.Host,function (i,item) {
				if (item.Mode != 2){
					return true;
				}
				/*
				if(hdata.data.Host[i].Selected==0 && hdata.data.Host[i].Mode==0 && ajax_find_host_doing==true){
					return true;
				}
				*/
				if(ajax_find_host_doing==true && $(obj).siblings('span.h-name-red').length==0){
					var $H = $('<li style="display: none;"></li>');
				}else{
					var $H = $('<li></li>');
				}
				//var HostName_h = autoAddEllipsis(hdata.data.Host[i].HostName,'12');
				var HostName_h = hdata.data.Host[i].HostName;
				if(hdata.data.Host[i].AccountNum == 0) i_class = "h-blank";
				else i_class = "h-aicon";
				
				if(v==1 && d == 0){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" checked="checked" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+'  disabled  data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
							(hdata.data.Host[i].HostIP+'('+HostName_h+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') +
							'</span></span><ul style="display:none">Loading...</ul>');
				}else if(v==1){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" checked="checked" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="1" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
							(hdata.data.Host[i].HostIP+'('+HostName_h+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') +
							'</span></span><ul style="display:none">Loading...</ul>');
				}else if(v==0){
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-loadfirst='+loadfirst+' data-loadlast='+loadlast+' data-ifselect=false data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
							(hdata.data.Host[i].HostIP+'('+HostName_h+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') +
							'</span></span><ul style="display:none">Loading...</ul>');
				}else{
					$H.html('<i class="'+i_class+'" data-id="arrH-'+hdata.data.Host[i].HostId+'" /><input type="checkbox" id="nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId+'" data-check="0" class="zcheck zcheck-g" data-ifselect=false data-loadfirst=0 data-loadlast='+loadlast+' '+disabled_flag+' data-mode="'+hdata.data.Host[i].Mode+'" data-name="'+hdata.data.Host[i].HostIP+'\t'+hdata.data.Host[i].HostName+'"><i class="h-eicon h-eicon-u" class="zcheck"></i><span class="h-name" style="width: 16em;" id="spanh-'+parent_id+'-'+hdata.data.Host[i].HostId+'">'+'<span class="h-name-son" style="">' + 
							(hdata.data.Host[i].HostIP+'('+HostName_h+')').split('').map(function (params) {
								return '<font>'+params+'</font>'    
							}).join('') +
							'</span></span><ul style="display:none">Loading...</ul>');	
				}
				$(obj).append($H);
				/*
				setTimeout(function(){
					_jScrollBar('spanh-'+parent_id+'-'+hdata.data.Host[i].HostId);
				},1000);
				*/
				_checkView1($('#nodeh-'+parent_id+'-'+hdata.data.Host[i].HostId));
			});
			_closeLoading();
			var _ajax_find_host_doing=ajax_find_host_doing;
			flag_loading = false;
		}
	});
}
function AscSort(a,b)
{
	a = parseInt(a.split(':')[1]);
	b = parseInt(b.split(':')[1]);
	return a - b;
}
var old_path_all = [];
var filter_flag_append = false;
var flag_loading = false;
var index_f = 0;
var tmp_list=null;
var tmp_list_path_strarray=null;
var ajax_find_host_doing=false;
var first_find_index=null;
//子节点0主机组1主机2账号
function _initHTML(obj,id,v,d,t){
	//var cdata = nodeData;
	$(obj).empty();
	if (t == "arrHG"){
		//get_hostdirectory(id);
		if(filter_flag_append == true) filter_flag_append=false;
		else _showLoading();			
		get_hostdirectory1(obj,id,v,d);
		return true;
	}else{
		//get_host(id);
		if(filter_flag_append == true) filter_flag_append=false;
		else _showLoading();
		$.ajax({
			url:'/bhost/get_host_pwd',
			type:'post',
			async:true,
			cache:false,
			data:{a0:se,z1:id},
			beforeSend :function(xmlHttp){ 
				xmlHttp.setRequestHeader("If-Modified-Since","0"); 
				xmlHttp.setRequestHeader("Cache-Control","no-cache");
			 },
			success:function(result){
				var adata = JSON.parse(result);
				////data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
				//data-loadlast(最后保存的状态) 
				//data-ifselect(组或者主机 是否是按组授权或者 按主机授权
				var parents_aid = $(obj).siblings('input.zcheck').attr('id').split('-');
				var parents_id = parents_aid[2];
				var parentss_id = parents_aid[1];
				$.each(adata.AccountSet,function(i,item){
					var ser = "";
					var password_icon;
					$.each(item.HostServiceSet,function(i1,item1){
						ser = ser+item1.HostServiceName+',';
					});
					if (ser != ""){
						ser = ser.substring(0,ser.length-1);
					}
					//ser = autoAddEllipsis(ser,'8');
					if (item.HostAccount == null){
						return true;
					}
					//var aname = autoAddEllipsis(item.HostAccount.AccountName,'12');
					var aname = item.HostAccount.AccountName;
					if (item.PasswordType == 0){//由用户输入密码
						//password_icon = '<i class="v-check v-right" style="margin-top: 3px;"></i>';
						//password_icon = '<i class="pwdtype p1" style="/*margin-top: 3px;margin-left:3px;*/"></i>';
						password_icon = '';
					}else if (item.PasswordType == 1){//特定非空密码
						password_icon = '<i class="pwdtype p2" style="/*margin-top: 3px;margin-left:3px;*/"></i>';
					}else if(item.PasswordType == 2){//空密码
						password_icon = '<i class="pwdtype p3" style="/*margin-top: 3px; margin-left:3px;*/"></i>';
					}else{
						password_icon = '<i class="pwdtype p4" style="/*margin-top: 3px; margin-left:3px;*/"></i>';
					}
					if(v==1 && d == 0){
						$(obj).append('<li><i class="h-blank" />'+
						'<input type="checkbox" server_name="'+ser+'" checked="checked" data="'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" pro_name="'+ser+'" id="nodea-'+item.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2"  id="spana-'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
								(aname+'('+ser+')').split('').map(function (params) {
									return '<font>'+params+'</font>'    
								}).join('') +
								'</span></span>'+password_icon+'</li>');
					}else if(v==1){
						$(obj).append('<li><i class="h-blank" />'+
							'<input type="checkbox" server_name="'+ser+'" data="'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" checked="checked" pro_name="'+ser+'" id="nodea-'+item.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2" id="spana-'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
									(aname+'('+ser+')').split('').map(function (params) {
										return '<font>'+params+'</font>'
									}).join('') +
									'</span></span>'+password_icon+'</li>');
					}else if(v==0){
						$(obj).append('<li><i class="h-blank" />'+
							'<input type="checkbox" server_name="'+ser+'" data="'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" pro_name="'+ser+'" id="nodea-'+item.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2" id="spana-'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
									(aname+'('+ser+')').split('').map(function (params) {
										return '<font>'+params+'</font>'
									}).join('') +
									'</span></span>'+password_icon+'</li>');
					}else{
						$(obj).append('<li><i class="h-blank" />'+
							'<input type="checkbox" server_name="'+ser+'" data="'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" pro_name="'+ser+'" id="nodea-'+item.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2" id="spana-'+parentss_id+'-'+parents_id+'-'+item.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
									(aname+'('+ser+')').split('').map(function (params) {
										return '<font>'+params+'</font>'
									}).join('') +
									'</span></span>'+password_icon+'</li>');
					}
				})
				if(d==0){
					$(obj).find('input').prop('disabled',true);
				}
				_checkView_host(obj);
				_closeLoading();	
			}
		});
	}
}
var count_ajax = 0;
var ajax_host_frequency=0;
var find_append_do1_time=0;
function ajax_host(){
	ajax_flag = true;
	if(ajax_data.length == 0) return ;
	$.ajax({
		url:'/bhost/get_hosts',
		type:'post',
		cache:false,
		async:true,
		data:{a0:se,z1:ajax_data.join(",")},
		beforeSend :function(xmlHttp){ 
			xmlHttp.setRequestHeader("If-Modified-Since","0"); 
			xmlHttp.setRequestHeader("Cache-Control","no-cache");
		 },
		success:function(result){
			if(ajax_data.length == 0) return ;
			
			var results = JSON.parse(result);
			//ajax_data 排序
			ajax_data.sort(AscSort);
			$(results.info).each(function(i,item){
				var adata = item;
				var hgid = ajax_data[i].split(':')[0];
				
				$('#nodeh-'+hgid+'-'+adata.HostId).prev('i').addClass('h-aicon-d');
				var obj = $('#nodeh-'+hgid+'-'+adata.HostId).siblings('ul');
				
				$(obj).empty().show();
				var v = 2,d;
    			var $input = $('#nodeh-'+hgid+'-'+adata.HostId).siblings('span.checkbox');

				if($input.length  ==0) return true;

    			if($('#nodeh-'+hgid+'-'+adata.HostId).siblings('span.authtype').find('input').is(':checked')){
    				d = 0;
    			}else{
					d = 1;
				}
				if ($input.attr('class').indexOf('disabled')>0){
					d = 0;
				}
		    	var c = $input.attr('class');
		    	if(c.indexOf('checked')>0){
		    		v=1;
		    	}else if(c == 'checkbox'){
		    		v=0;
		    	}
				var parents_aid = $(obj).siblings('input.zcheck').attr('id').split('-');
				var parents_id = parents_aid[2];
				var parentss_id = parents_aid[1];
				$.each(adata.AccountSet,function(i1,item1){
					var ser = "";
					var password_icon;
					$.each(item1.HostServiceSet,function(i2,item2){
						ser = ser+item2.HostServiceName+',';
					});
					if (ser != ""){
						ser = ser.substring(0,ser.length-1);
					}
					if (item1.PasswordType == 0){//由用户输入密码
						//password_icon = '<i class="v-check v-right" style="margin-top: 3px;"></i>';
						password_icon = '<i class="pwdtype p1" style="margin-top: 3px; /*background-position: -14px 0*/"></i>';
					}else if (item1.PasswordType == 1){//特定非空密码
						password_icon = '<i class="pwdtype p2" style="margin-top: 3px; /*background-position: 0 0*/"></i>';
					}else if(item1.PasswordType == 2){//空密码
						password_icon = '<i class="pwdtype p3" style="margin-top: 3px; /*background-position: -28px 0*/"></i>';
					}else{
						password_icon = '<i class="pwdtype p4" style="margin-top: 3px; /*background-position: -28px 0*/"></i>';
					}
					if(v==1 && d == 0){
						$(obj).append('<li><i class="h-blank" /><input type="checkbox" server_name="'+ser+'" checked="checked" data="'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" pro_name="'+ser+'" id="nodea-'+item1.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item1.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2" id="spana-'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
                            (item1.HostAccount.AccountName+'('+ser+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span>'+password_icon+'</li>');
					}else if(v==1){
						$(obj).append('<li><i class="h-blank" /><input type="checkbox" server_name="'+ser+'" data="'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" checked="checked" pro_name="'+ser+'" id="nodea-'+item1.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item1.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2" id="spana-'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
                            (item1.HostAccount.AccountName+'('+ser+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span>'+password_icon+'</li>');
					}else if(v==0){
						$(obj).append('<li><i class="h-blank" /><input type="checkbox" server_name="'+ser+'" data="'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" pro_name="'+ser+'" id="nodea-'+item1.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item1.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2" id="spana-'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
                            (item1.HostAccount.AccountName+'('+ser+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span>'+password_icon+'</li>');
					}else{
						$(obj).append('<li><i class="h-blank" /><input type="checkbox" server_name="'+ser+'" data="'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" pro_name="'+ser+'" id="nodea-'+item1.PasswordAuthId+'" class="zcheck zcheck-g" data-name="'+item1.HostAccount.AccountName+'"><i class="h-eicon h-eicon-a"></i><span class="h-name h-name2" id="spana-'+parentss_id+'-'+parents_id+'-'+item1.PasswordAuthId+'" style="width: 16em;">'+'<span class="h-name-son" style="">' + 
                            (item1.HostAccount.AccountName+'('+ser+')').split('').map(function (params) {
                                return '<font>'+params+'</font>'    
                            }).join('') +
                            '</span></span>'+password_icon+'</li>');
					}
					/*
					if (_jScrollBar_array.indexOf('spana-'+item1.PasswordAuthId) === -1){
						_jScrollBar_array.push('spana-'+item1.PasswordAuthId);
						setTimeout(function(){
							_jScrollBar('spana-'+item1.PasswordAuthId);
						},1000)
					}
					*/
				})

				if(d==0){
					$(obj).find('input').prop('disabled',true);
				}
				_checkView_host(obj);
			})
			
			//50个结束 继续调用 过滤信息
			if(host_path_all.length == 0){
				scrollTop_check_server1();
			}else{
			//	//find_append();
			}
			ajax_flag = false;
			ajax_data = [];		
			return true;
		}
	})	
}

//根目录
function _viewHTML(data,obj){
	$(obj).empty();
	disabled_flag = "";
	$.each(data.data.HGroup,function(i,item){
		var $H = $('<li></li>');
		//data-loadfirst(初始的状态) 0->未选中 1->部分选中 2->全选中 
		//data-loadlast(最后保存的状态) 
		//data-ifselect(组或者主机 是否是按组授权或者 按主机授权)
		if((item.MemberNum + item.HostNum) == 0) i_class = "h-blank";
		else i_class = "h-aicon";
		
		$H.html('<i class="'+i_class+'" data-id="arrHG-'+item.HGId+'" /><input type="checkbox" id="nodehg-'+item.HGId+'" data-check="0" data-mode="2" class="zcheck zcheck-g" '+disabled_flag+' data-loadfirst=0 data-loadlast=0 data-ifselect=false data-name="'+item.HGName+'"><i class="h-eicon h-eicon-g" ></i><span class="h-name" id="spanHG-'+item.HGId+'" style="width: 12em;">'+'<span class="h-name-son" style="">' + item.HGName.split('').map(function (params) {
                        return '<font>'+params+'</font>'    
                    }).join('') + 
                    '</span></span><ul style="display:none">Loading...</ul>');
		$(obj).append($H);
	});	
	_checkView_host(obj);
}

function _checkView1(obj){
	_authTypeTheme($(obj).parent().find('span.authtype input'));
    $(obj).each(function(){
    	var $s = $('<span class="checkbox"></span>');
    	$(this).after($s);
    	var v = $(this).prop('checked');
    	if(v){
    		$s.addClass('checked');
    	}else{
    		var c = $(this).data('check');
    		if(c && c==2){
    			$s.addClass('half');
    		}
    	}

    	var d = $(this).prop('disabled');
    	if(d){
    		$s.addClass('disabled');
    	}
		var span_id = $(this).siblings('span.h-name').attr('id');
		
		setTimeout(function () {
			if (_jScrollBar_array.indexOf(span_id) === -1){
				_jScrollBar_array.push(span_id);
				_jScrollBar(span_id);
				$(this).siblings('ul').find('span.h-name').each(function(i,item){
					var span_c_id = $(item).attr('id');
					_jScrollBar(span_c_id);
				});
			}
		},1000);
		/*
		var span_id = $(this).siblings('span.h-name').attr('id');
		if (_jScrollBar_array.indexOf(span_id) === -1){
			_jScrollBar_array.push(span_id);
			_jScrollBar(span_id);
		}else{
			if ($("#"+span_id).children('div').length == 0){
				_jScrollBar(span_id);
			}
		}
		*/
    }).on('change',function(){
    	var v = $(this).prop('checked');
    	var $s = $(this).next('span.checkbox');
    	var $u = $(this).parent().children('ul');
		var d;
		if($(this).siblings('span.authtype').find('input').is(':checked')){
    		d = 0;
    	}else{
    		d = 1;
    	}
	
    	if(v){
    		$s.attr('class','checkbox checked');
	    	$('input.zcheck',$u).prop('checked',true);
	    	$('span.checkbox',$u).attr('class','checkbox checked');			
			$(this).attr("data-loadlast","2");
			$(this).find('input.zcheck').attr('data-loadlast',2);
    	}else{
    		$s.attr('class','checkbox');
	    	$('input.zcheck',$u).prop('checked',false).prop('disabled',false);
	    	$('span.checkbox',$u).attr('class','checkbox');
			$(this).siblings('span.authtype').find('input').prop('checked',false);
			$(this).siblings('span.authtype').find('span').attr('class','checkbox');
			$(this).siblings('span.authtype').find('span').trigger('change');
			//$u.find('span.authtype').find('input').iCheck('uncheck');	
			$(this).attr("data-loadlast","0");
			$(this).siblings('ul').find('input.zcheck').attr('data-loadlast',0);
    	}
		/*
    	if(d==0){
    		$('span.checkbox',$u).addClass('disabled');
    	}*/

    	_checkEvent(this);
    });
}


function _authTypeTheme(obj){
    $.each(obj,function(i,item){
        var $_item = $(item);

        if($_item.parent().children('span').length == 0){
            $_item.after('<span class="checkbox"></span>');
        }

        var $s = $_item.next('span');
        var checked = $_item.prop('checked');
        var disabled = $_item.prop('disabled');

        if(checked){
            $s.addClass('checked');
        }else{
            $s.removeClass('checked');
        }

        if(disabled){
            $s.addClass('disabled');
        }else{
            $s.removeClass('disabled');
        }
    })
}

function _checkView_host(obj){
    _authTypeTheme($('span.authtype input',obj));
    $('input.zcheck',obj).each(function(){
    	var $s = $('<span class="checkbox"></span>');
    	$(this).after($s);
    	var v = $(this).prop('checked');
    	if(v){
    		$s.addClass('checked');
    	}else{
    		var c = $(this).data('check');
    		if(c && c==2){
    			$s.addClass('half');
    		}
    	}

    	var d = $(this).prop('disabled');
    	if(d){
    		$s.addClass('disabled');
    	}
		var span_id = $(this).siblings('span.h-name').attr('id');
		
		setTimeout(function () {
			if (_jScrollBar_array.indexOf(span_id) === -1){
				_jScrollBar_array.push(span_id);
				_jScrollBar(span_id);
			}
		},1000);
		/*
		var span_id = $(this).siblings('span.h-name').attr('id');
		if (_jScrollBar_array.indexOf(span_id) === -1){
			_jScrollBar_array.push(span_id);
			_jScrollBar(span_id);
		}else{
			if ($("#"+span_id).children('div').length == 0){
				_jScrollBar(span_id);
			}
		}
		*/
    }).on('change',function(){
    	var v = $(this).prop('checked');
    	var $s = $(this).next('span.checkbox');
    	var $u = $(this).parent().children('ul').find('li');
        /*
    	var d;
    	if($(this).siblings('span.authtype').find('input').is(':checked')){
    		d = 0;
    	}else{
    		d = 1;
    	}*/
        var $authInput = $(this).siblings('span.authtype').find('input');

    	if(v){
    		$s.attr('class','checkbox checked');
	    	$('input.zcheck',$u).prop('checked',true);
	    	$('span.checkbox:first',$u).attr('class','checkbox checked');
	    	//$u.find('span.authtype').show();
			$(this).attr("data-loadlast",2);
			$('input.zcheck',$u).attr("data-loadlast",2);			
    	}else{
    		$s.attr('class','checkbox');
	    	$('input.zcheck',$u).prop('checked',false);
	    	$('span.checkbox:first',$u).attr('class','checkbox');
	    	//$u.find('span.authtype').hide();	
			$(this).attr("data-loadlast",0);
			$('input.zcheck',$u).attr("data-loadlast",0);
			
			$authInput.prop('checked',false).trigger('change');
			$(this).siblings('span.authtype').find('span').attr('class','checkbox');			
    	}
        /*
    	if(d==0){
    		$('span.checkbox',$u).addClass('disabled');
    	}
        */
			
    	_checkEvent(this);
    });
	$(obj).find('i.pwdtype').on('mouseover',function(){
		if ($(this).attr('class').indexOf('p1') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;margin-left: 10px;">未配置密码</span>');
		}else if($(this).attr('class').indexOf('p2') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;margin-left: 10px;">已配置密码</span>');
		}else if($(this).attr('class').indexOf('p3') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;margin-left: 10px;">已配置空密码</span>');
		}else{
			$(this).parent().append('<span style="position: absolute;background-color: white;margin-left: 10px;">已配置密钥</span>');
		}
		//$(this).next('span').show();
	});
	
	$(obj).find('i.pwdtype').on('mouseout',function(){
		//$(this).next('span').hide();
		$(this).next('span').remove();
	});
	/*
	$('.pwdtype').on('mouseover',function(){
				if ($(this).attr('class').indexOf('p1') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;">未配置</span>')
		}else if($(this).attr('class').indexOf('p2') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;">已配置</span>')
		}else{
			$(this).parent().append('<span style="position: absolute;background-color: white;">空密码</span>')
		}
		//$(this).next('span').show();
	});
	
	$('.pwdtype').on('mouseout',function(){
				//$(this).next('span').hide();
		$(this).next('span').remove();
	});
	*/
}

function _checkView(obj){
	/*
	$('span.authtype input',obj).iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
	*/
    $('input.zcheck',obj).each(function(){
    	var $s = $('<span class="checkbox"></span>');
    	$(this).after($s);
    	var v = $(this).prop('checked');
    	if(v){
    		$s.addClass('checked');
    	}else{
    		var c = $(this).data('check');
    		if(c && c==2){
    			$s.addClass('half');
    		}
    	}

    	var d = $(this).prop('disabled');
    	if(d){
    		$s.addClass('disabled');
    	}
    }).on('change',function(){
    	var v = $(this).prop('checked');
    	var $s = $(this).next('span.checkbox');
    	var $u = $(this).parent().children('ul');
    	/*
		var d;		
    	if($(this).siblings('span.authtype').find('input').is(':checked')){
    		d = 0;
    	}else{
    		d = 1;
    	}
		*/
    	if(v){
    		$s.attr('class','checkbox checked');
	    	$('input.zcheck',$u).prop('checked',true);
	    	$('span.checkbox',$u).attr('class','checkbox checked');
    	}else{
    		$s.attr('class','checkbox');
	    	$('input.zcheck',$u).prop('checked',false);
	    	$('span.checkbox',$u).attr('class','checkbox');
    	}
		/*
    	if(d==0){
    		$('span.checkbox',$u).addClass('disabled');
    	}
		*/
    	_checkEvent(this);
    });
	
	$('.pwdtype').on('mouseover',function(){
		if ($(this).attr('class').indexOf('p1') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;/*border: 1px solid black;*/margin-left: 10px;">未配置</span>')
		}else if($(this).attr('class').indexOf('p2') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;/*border: 1px solid black;*/margin-left: 10px;">已配置密码</span>')
		}else if($(this).attr('class').indexOf('p3') > -1){
			$(this).parent().append('<span style="position: absolute;background-color: white;/*border: 1px solid black;*/margin-left: 10px;">空密码</span>')
		}else{
			$(this).parent().append('<span style="position: absolute;background-color: white;/*border: 1px solid black;*/margin-left: 10px;">已配置密钥</span>')
		}
		//$(this).next('span').show();
	});
	
	$('.pwdtype').on('mouseout',function(){
		//$(this).next('span').hide();
		$(this).next('span').remove();
	});
}

function _checkEvent(obj){
	var _run = function(){
		var $li = $(obj).parent().parent().parent();
		var tagname = $li[0].tagName.toLowerCase();
		var v = $(obj).prop('checked');

		if(tagname == 'li'){
			var c1=0,c2=0;
			var len = $(obj).parent().parent().children('li').length;
			$(obj).parent().parent().children('li').each(function(){
				var c = $(this).children('span.checkbox').attr('class');
				if(c.indexOf('checked')>0){
					c1++;
				}else if(c.indexOf('half')>0){
					c2++;
				}

				if(c1 == len){
					$li.children('input.zcheck').prop('checked',true).siblings('span.checkbox').attr('class','checkbox checked');
				}else if(c1==0 && c2==0){
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox');
				}else{
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox half');
				}
			});
			_checkEvent($li.children('input.zcheck'));
		}else{
			return;
		}
	}

	_run();
}

var PasswordAuth={
	"PasswordAuthSet": [],
    "HostSet": [],
    "Password": "123456", 
    "PasswordType": 1
}

function save_user(obj){
	$(obj).find('span.checkbox.half,span.checkbox.checked').each(function(i,item){
		var state = $(item).attr('class');
		var $u = $(item).parent().children('ul');
		var $i = $(item).siblings('i:first');
		var name_value=$(item).prev('input').data('name');
		if ($i.attr('data-id') != undefined && $(item).parent().children('.h-blank').length == 1){
			return true;
		}
		if (state == "checkbox checked"){
			var id = $(item).prev('input').attr('id');
			if (id != undefined){
				var _id = id.split('-');
				var $p_span = $(item).parents('ul:first').siblings('span.checkbox');
				if ($p_span.length != 0 && $p_span.attr('class') == "checkbox checked"){
					return true;
				}else{
					if (_id[0] == "nodehg"){
						var hostset = '{"HGId":'+_id[1]+',"HostId":null,"Name":"'+name_value+'"}';
						var hostset_all = JSON.stringify(PasswordAuth.HostSet);
						if (hostset_all.indexOf(hostset) === -1){
							hostset = JSON.parse(hostset);
							PasswordAuth.HostSet.push(hostset);
						}
					}else if (_id[0] == "nodeh"){
						var name_value_arr=name_value.split('\t');
						var hostset = '{"HGId":'+_id[1]+',"HostId":'+_id[2]+',"Name":"'+name_value_arr[0]+'-'+name_value_arr[1]+'"}';
						var hostset_all = JSON.stringify(PasswordAuth.HostSet);
						if (hostset_all.indexOf(hostset) === -1){
							hostset = JSON.parse(hostset);
							PasswordAuth.HostSet.push(hostset);
						}
					}else{
						var pwd = '{"PasswordAuthId":'+_id[1]+',"Name":"'+name_value.replace(/\\/g,'\\\\')+'"}';
						var pwd_str = JSON.stringify(PasswordAuth.PasswordAuthSet);
						if (pwd_str.indexOf(pwd) === -1){
							PasswordAuth.PasswordAuthSet.push(JSON.parse(pwd));
						}
					}
				}	
				/*
				if ($(item).parent().find('.h-blank').length != 0){ 
					var pwd = '{"PasswordAuthId":'+_id[1]+'}';
					var pwd_str = JSON.stringify(PasswordAuth.PasswordAuthSet);
										if (pwd_str.indexOf(pwd) === -1){
						PasswordAuth.PasswordAuthSet.push(JSON.parse(pwd));
					}
				}else{
					if (_id[0] == "nodehg"){
						var hostset = '{"HGId":'+_id[1]+',"HostId":null}';
												var hostset_all = JSON.stringify(PasswordAuth.HostSet);
						if (hostset_all.indexOf(hostset) === -1){
							hostset = JSON.parse(hostset);
							PasswordAuth.HostSet.push(hostset);
						}	
					}else{
						var hostset = '{"HGId":'+_id[2]+',"HostId":'+_id[1]+'}';
												var hostset_all = JSON.stringify(PasswordAuth.HostSet);
						if (hostset_all.indexOf(hostset) === -1){
							hostset = JSON.parse(hostset);
							PasswordAuth.HostSet.push(hostset);
						}
					}
				}
				*/
			}
		}else{
			if ($(item).parent().children('i.h-aicon').attr('class') == "h-aicon"){
				$(item).parent().children('i.h-aicon').click();
			}
			save_user($u);
		}
	});
}


function save(){
	if(!$('#password_check').prop('checked') && !$('#sshkey_check').prop('checked')){
		_alert(2,"密码录入","请选择密码方式");
		return false;
	}
	PasswordAuth={
		"LoginUserCode":"",
		"PasswordAuthSet": [],
		"HostSet": [],
		"Password": null, 
		"PasswordType": null,
		"SshKeyId":null
	}
	PasswordAuth.LoginUserCode = window.parent.document.frm.us.value;
	var pwd = $("#n_p").val();
	var c_pwd = $("#c_p").val();
	if ($('#password_check').prop('checked')){
		if ($("#s_p").prop("checked")){
			PasswordAuth.PasswordType = 2;
			PasswordAuth.Password = null;
		}else{
			if (pwd == "" && c_pwd == ""){
				PasswordAuth.PasswordType = 0;
				PasswordAuth.Password = null;
			}else{
				if (pwd == ""){
					_alert(2,"密码录入","请输入录入密码",$("#n_p"));
					return false;
				}
				if (c_pwd == ""){
					_alert(2,"密码录入","请输入确认密码",$("#c_p"));
					return false;
				}
				if(pwd.length > 64){
					_alert(1, "密码录入", "密码不能超过系统限定64位", $("#n_p"));
					return false;
				}
				if (c_pwd != pwd){
					_alert(1,"密码录入","密码不一致",$("#c_p"));
					return false;
				}
				PasswordAuth.PasswordType = 1;
				PasswordAuth.Password = pwd;
			}
		}
	}
	if($('#sshkey_check').prop('checked')){
		var SSHkey_s_value=$('#SSHkey_s').data('value');
		if(SSHkey_s_value>0){
			PasswordAuth.SshKeyId=SSHkey_s_value;
		}else{
			PasswordAuth.SshKeyId=0;
		}
	}
	
	save_user($("#userTree"));
	if (PasswordAuth.PasswordAuthSet.length == 0 && PasswordAuth.HostSet.length == 0){
		_alert(2,"密码录入","请选择账号");
		return false;
	}
	var get_account_num = {
		"hgidset":"",
		"hostidset":""
	}
	var hgidset = "{";
	var hostidset = "{";
	var flag_host = 0;
	var flag_hg = 0;
	$.each(PasswordAuth.HostSet,function(i,item){
		if (item.HostId == null){
			flag_hg = 1;
			hgidset = hgidset + item.HGId + ',';
		}else{
			flag_host = 1;
			hostidset = hostidset + item.HostId + ',';
		}
	});
	if (flag_host == 1){
		hostidset = hostidset.substring(0,hostidset.length-1) + '}';
	}else{
		hostidset = hostidset + '}';
	}
	if (flag_hg == 1){
		hgidset = hgidset.substring(0,hgidset.length-1) + '}';
	}else{
		hgidset = hgidset + '}';
	}
	get_account_num.hgidset = hgidset;
	get_account_num.hostidset = hostidset;
	var account_num = 0;
	$.ajax({
		url:'/bhost/PGet_AccountNum',
		type:'post',
		async:false,
		data:{a0:se,z1:JSON.stringify(get_account_num)},
		success:function(result){
			account_num = parseInt(result);
		}
	});
	//var change_len = PasswordAuth.PasswordAuthSet.length + PasswordAuth.HostSet.length;
	if (account_num > 1){
		//_alert(2,"密码录入","是否统一修改密码");
		parent.layer.open({
			type:1,
			title:"密码录入",
			content:'<div class="layer-alert"><i class="alert warning"></i>是否统一修改密码</div>',
			btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
				parent.layer.close(i);
				msstr = aceg(JSON.stringify(PasswordAuth),se);
				$.ajax({
					url:'/bhost/modify_pwd',
					type:'post',
					async:false,
					data:{a0:se,z1:JSON.stringify(PasswordAuth),m1:msstr},
					success:function(result){
						if (result == true){
							$('.btn').blur();
							parent.layer.open({
								type:1,
								title:"密码录入",
								content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
								btn:['确&nbsp;&nbsp;定'],
								btnAlign:'c',
								closeBtn: false,
								skin:'layer-custom',
								area:['380px','310px'],
								move: false,
								resize: false,
								btn1:function(i){
									parent.layer.close(i);
									var host_arr=new Array();
									$.each(PasswordAuth.PasswordAuthSet,function(i,item){
										$("#nodea-"+item.PasswordAuthId).prop('checked',false);
										var host_arr_value=$("#nodea-"+item.PasswordAuthId).parent('li').parent('ul').siblings('input').attr('id');
										if($.inArray(host_arr_value,host_arr)<0){
											host_arr.push(host_arr_value);
										}
									});
									$.each(PasswordAuth.HostSet,function(i,item){
										if (item.HostId != null){
											$("#nodeh-"+item.HGId+'-'+item.HostId).prop('checked',false).trigger('change');
											if($("#nodeh-"+item.HGId+'-'+item.HostId).siblings('ul').is(":visible")){
												if($.inArray("nodeh-"+item.HGId+'-'+item.HostId,host_arr)<0){
													host_arr.push("nodeh-"+item.HGId+'-'+item.HostId);
												}
											}	
										}else{
											$("#nodehg-"+item.HGId).prop('checked',false).trigger('change');
											$("#nodehg-"+item.HGId).siblings('ul').find('input').each(function(){
												var account_id = $(this).attr('id');
												if(account_id.indexOf('nodeh')<0){
													return true;
												}
												if($('#'+account_id).siblings('ul').is(":visible")){
													if($.inArray(account_id,host_arr)<0){
														host_arr.push(account_id);
													}
												}
											})
										}
									});
									$.each(host_arr,function(i,item){
										$('#'+item).siblings('ul').text('Loading...').hide();
										$('#'+item).prev('i.h-aicon-d').removeClass('h-aicon-d').trigger('click');
									});

									$("#userTree").find('span.checkbox').attr('class','checkbox');
									$('#n_p').val('');
									$('#c_p').val('');
									$('#s_p').iCheck('uncheck');
									//back();
								},
								btn2:function(i){
									parent.layer.close(i);
								}
							});
						}else{
							_alert(1,"密码录入","执行失败");
						}
					}
				})
			},
			btn2:function(i){
				parent.layer.close(i);
			}
		});	
	}else{
		msstr = aceg(JSON.stringify(PasswordAuth),se);
		$.ajax({
			url:'/bhost/modify_pwd',
			type:'post',
			async:false,
			data:{a0:se,z1:JSON.stringify(PasswordAuth),m1:msstr},
			success:function(result){
				if (result == true){
					//_alert(0,"密码录入","保存成功");
					$('.btn').blur();
					parent.layer.open({
						type:1,
						title:"密码录入",
						content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
						btn:['确&nbsp;&nbsp;定'],
						btnAlign:'c',
						closeBtn: false,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						btn1:function(i){
							parent.layer.close(i);
							var host_arr=new Array();
							$.each(PasswordAuth.PasswordAuthSet,function(i,item){
								$("#nodea-"+item.PasswordAuthId).prop('checked',false);
								var host_arr_value=$("#nodea-"+item.PasswordAuthId).parent('li').parent('ul').siblings('input').attr('id');
								if($.inArray(host_arr_value,host_arr)<0){
									host_arr.push(host_arr_value);
								}
							});
							$.each(PasswordAuth.HostSet,function(i,item){
								if (item.HostId != null){
									$("#nodeh-"+item.HGId+'-'+item.HostId).prop('checked',false).trigger('change');
									if($("#nodeh-"+item.HGId+'-'+item.HostId).siblings('ul').is(":visible")){
										if($.inArray("nodeh-"+item.HGId+'-'+item.HostId,host_arr)<0){
											host_arr.push("nodeh-"+item.HGId+'-'+item.HostId);
										}
									}	
								}else{
									$("#nodehg-"+item.HGId).prop('checked',false).trigger('change');
									$("#nodehg-"+item.HGId).siblings('ul').find('input').each(function(){
										var account_id = $(this).attr('id');
										if(account_id.indexOf('nodeh')<0){
											return true;
										}
										if($('#'+account_id).siblings('ul').is(":visible")){
											if($.inArray(account_id,host_arr)<0){
												host_arr.push(account_id);
											}
										}
									})
								}
							});
							$.each(host_arr,function(i,item){
								$('#'+item).siblings('ul').text('Loading...').hide();
								$('#'+item).prev('i.h-aicon-d').removeClass('h-aicon-d').trigger('click');
							});

							$("#userTree").find('span.checkbox').attr('class','checkbox');
							$('#n_p').val('');
							$('#c_p').val('');
							$('#s_p').iCheck('uncheck');
							//back();
						},
						btn2:function(i){
							parent.layer.close(i);
						}
					});
				}else{
					_alert(1,"密码录入","执行失败");
				}
			}
		})
	}
}

function back(){
	document.frm_pwdauth.action = '/bhost/index';
	document.frm_pwdauth.se.value = se;
	document.frm_pwdauth.us.value = window.parent.document.frm.us.value;
	document.frm_pwdauth.tasktype.value = 4;
	document.frm_pwdauth.submit();
}

var find_host_arry=[];
var find_host_flag=0;
var keyword_v = "";
var find_host_loading = false;
function _addFilter2(obj,type){
	if (find_host_loading){
		_alert(2,"搜索","正在搜索中，请先等待搜索完成");
		return false;
	}
	top1 = 9007199254740992;
	var v2 = $(obj).parent().children('input[type=text]').val().trim();
	var filtername = $("#server_select1").val();
	var filter_flag = 0;
	if (v2 == ""){
		_alert(2,"搜索","请输入关键字",$("#server_text1"));
		return false;
	}
	v2 = v2.ResetBlank();
	var addfilter_v = "";
	var addfilter = "";
	var addfilter_name = "";
	if (filtername == '0'){
		addfilter_v = v2;
		addfilter = "所有-" + v2;
		addfilter_name = "所有";
	}else if (filtername == "1"){
		addfilter = "组名-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "组名";
	}else if (filtername == "2"){
		addfilter = "主机名-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "主机名";
	}else if (filtername == "3"){
		addfilter = "IP-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "IP";
	}else if (filtername == "4"){
		addfilter = "账号-" + v2;
		addfilter_v = addfilter;
		addfilter_name = "账号";
	}
	var type_value = true;
	if (type){
		$("#filterWW2").children('ul').children('li').each(function(i,item){
			if ($(this).children('span').text() == addfilter_v){
				_alert(1,"搜索","该搜索条件已存在",$("#server_text1"));
				filter_flag = 1;
				return false;
			}
		})
		$("#server_text1").val("");
		/*
		if (addfilter_name != "所有"){
			$("#server_select1").empty().append('<option value="0">所有</option><option value="'+filtername+'">'+addfilter_name+'</option>');
			$("#server_select1").val(filtername).trigger('change');
		}
		*/
		if (filter_flag == 0){
			if (keyword_v == addfilter){
				type_value = false;
			}
			if (find_host_flag == 1){
				find_host_arry.splice(-1,1);
				find_host_flag = 0;
			}
			find_host_arry.push(addfilter);
			keyword_v = "";
			$("#text_check").hide();
			$('#filterWW2>ul').append('<li style="height: 18px;"><span class="ww" data-value="'+addfilter+'"style="width:9em">'+addfilter_v+'</span><i class="del" style="margin-top: -17px;" onclick="_delFilter2(this)"></i></li>');
			selView2(type_value);
		}
	}else{
		if (keyword_v == addfilter){
			type_value = false;
		}
		if (find_host_flag != 0){
			find_host_arry.splice(-1,1);
		}
		find_host_flag = 1;
		find_host_arry.push(addfilter);
		keyword_v = addfilter;
		selView2(type_value);
	}
}

function _clearFilter2(obj){
	if (find_host_loading){
		_alert(2,"搜索","正在搜索中，请先等待搜索完成");
		return false;
	}
	top1=9007199254740992;
	$("#filterWW2").children('ul').empty();
	$("#filterWW2").hide();
	$("#clearFilter2").hide();
	$("#userTree").find('i.h-aicon-d').click();
	find_host_arry=[];
	$("#server_text1").val('');
	$("#text_check").hide();
	find_host_flag = 0;
	keyword_v = "";
	//$("#server_select1").empty().append('<option value="0">所有</option><option value="1">组名</option><option value="2">主机名</option><option value="3">IP</option><option value="4">账号</option>');
	selView2(true);
}

function _delFilter2(obj){
	if (find_host_loading){
		_alert(2,"搜索","正在搜索中，请先等待搜索完成");
		return false;
	}
	var v = $(obj).parent().children('span').attr('data-value');
	$(obj).parent().remove();
	find_host_arry.splice($.inArray(v,find_host_arry),1);
	selView2(true);
}

function _clear_keyword(obj){
	$("#server_text1").val("");
	$("#text_check").hide();
	if (keyword_v != ""){
		if (find_host_loading){
			_alert(2,"搜索","正在搜索中，请先等待搜索完成");
			return false;
		}
		keyword_v = "";
		find_host_flag = 0;
		find_host_arry.splice(-1,1);
		selView2(true);
	}
}

function change_input(obj){
	if ($(obj).val() == "" && keyword_v != ""){
		keyword_v = "";
		find_host_flag = 0;
		find_host_arry.splice(-1,1);
		selView2(true);
	}
}

function selView2(type_value){
	var $sel = $('#filterWW2');
	var len = $('li',$sel).length;

	if(len == 0){
		$sel.hide();
		$("#clearFilter2").hide();
	}else if(len == 1){
		$("#filterWW2").show();
		$("#clearFilter2").show();
		$('>span.ww',$sel).show();
		$sel.addClass('selector-multiple');
	}else{
		$("#filterWW2").show();
		$("#clearFilter2").show();
		$('>span.ww',$sel).show();
		$sel.addClass('selector-multiple');
	}
	if (type_value){
		find_host_group();
	}
}

var host_path_all = [];
function find_host_group(){	
	find_host_loading = true;
	_getWait($(".waitTip"));
	top1=9007199254740992;
	//先清空之前的过滤信息 
	click_h1();
}

function  coverString(subStr,str){
	subStr=subStr.replace(/\?/g, "\\?").replace(/\|/g, "\\|").replace(/\\/g, "\\\\").replace(/\$/g, "\\$").replace(/\(/g, "\\(").replace(/\)/g, "\\)").replace(/\*/g, "\\*").replace(/\./g, "\\.").replace(/\[/g, "\\[").replace(/\^/g, "\\^").replace(/\{/g, "\\{");
	var reg = eval("/"+subStr+"/ig");
	return reg.test(str);
}

function red_to_no_red_and_open_to_red(obj,num){
	for(var i=0;i<tmp_list.length;i++){
		var item=tmp_list[i];
		var pass=true;
		for(var jm=0;jm<find_host_arry.length;jm++){
			var pass_one=false;
			var jm_index = find_host_arry[jm].indexOf('-');
			var search_arr = find_host_arry[jm].substr(jm_index + 1, find_host_arry[jm].length).split(' ');
			//var search_arr=find_host_arry[jm].split(' ');
			$.each(search_arr,function(i1,item1){
				if(item1!=''){
					var Name = item.Name;
					if (find_host_arry[jm].substr(0,jm_index) == "组名"){
						if (item.Type != 1){
							return false;
						}
					}else if (find_host_arry[jm].substr(0,jm_index) == "主机名"){
						Name=item.Name.split('\t')[0];
						if (item.Type != 2){
							return false;
						}
					}else if (find_host_arry[jm].substr(0,jm_index) == "IP"){
						Name=item.Name.split('\t')[1];
						if (item.Type != 2){
							return false;
						}
					}else if (find_host_arry[jm].substr(0,jm_index) == "账号"){
						if (item.Type != 4){
							return false;
						}
					}
					if(coverString(item1,Name)){
						pass_one=true;
						return false;
					}
				}
			});
			if(pass_one==false){
				pass=false;
				//break;
			}
		}
		if(pass==true){
			open_and_make_red(item);
		}else{
		}
	}
	li_red_to_no_red($('#userTree'));
	//非红隐藏
	//setTimeout(function () {
	//_jScrollBar_array = [];
	li_hide_while_no_red($('#userTree'),0);
	//},1);
	//定位
	top_to_move($('#userTree'));
}

function open_and_make_red(item){
	var Path_array=item.Path.split('/');
	var len=Path_array.length;
	if (len == 2){//主机层
		//show
		$('#nodehg-'+item.Id).parent('li').show();
		$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
	}else{
		if (item.Type == 4){ //账号
			var s=0;
			for (var j = 1; j < len; j++){
				var id=Path_array[j].split(',')[1];
				if (j == len-1){ //主机层
					//show
					$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).parent('li').show();
					$i_item=$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).prev('i');
					if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
						$i_item.trigger('click');
					}
				}
				else{ //主机组层
					//show
					$('#nodehg-'+id).parent('li').show();
					$i_item=$('#nodehg-'+id).prev('i');
					if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
						filter_flag_append = true;
						$i_item.trigger('click');
					}
					//}
				}
			}
			if(s){
				return false;
			}
			$('input[data='+item.Id+']').parent('li').show();
			$('input[data='+item.Id+']').siblings('span.h-name').addClass('h-name-red');
			//$('input[data='+host_path_all[i].Id+']').siblings('ul').find('li').show();	
		}else{
			for(var j=1;j<len-1;j++){
				var id=Path_array[j].split(',')[1];
				//show
				$('#nodehg-'+id).parent('li').show();
				$i_item=$('#nodehg-'+id).prev('i');
				if(($i_item.attr('class').indexOf('h-aicon-d')) == -1){
					filter_flag_append = true;
					$i_item.trigger('click');
				}		
				//}
			}
			if(item.Type==1){
				//show
				$('#nodehg-'+item.Id).parent('li').show();
				$('#nodehg-'+item.Id).siblings('span.h-name').addClass('h-name-red');
			}else{
				//show
				$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).parent('li').show();
				//$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).addClass('show_input');
				$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+item.Id).siblings('span.h-name').addClass('h-name-red');
			}
		}
	}
}

function top_to_move(obj){
		var top_arr=$(obj).find('span.h-name-red');
	if(top_arr.length!=0){
		$('#hosttree_div1').scrollTop(top_arr.eq(0).offset().top-200);	
		_waitDone($(".waitTip"));
	}else{
		$("#server_text1").blur();
		_alert(0,'搜索','无搜索结果',$("#server_text1"));
		_waitDone($(".waitTip"));
	}
	
}

function click_h1(){
	var i = 0;
	index = 0;
	flag_ajax_true = true;
	$("#userTree").find('i.h-aicon.h-aicon-d').trigger('click');
	$('#userTree').find('.font-red').removeClass('font-red');
	$("#userTree").find('span.h-name-red').removeClass('h-name-red');
	host_path_all = [];
	old_path_all = [];
	push_filter_wait = [];
	click_h0();
}
var time_all_=0;
var mtr;
var flag_ajax_true = false;
function click_h0(){
	time_all_=0;
	if (mtr != null) {
		mtr.abort();
		mtr = null;
	}
	flag_ajax_true = true;
	//条件没有的情况 直接返回
	
	if (JSON.stringify(find_host_arry) == "[]"){
		_waitDone($(".waitTip"));
		$('#hosttree_div1').scrollTop(0);
		tmp_list=null;
		first_find_index=null;
		$('#userTree').find('input[data-mode!=0]').parent('li').show();
		$("#userTree").find('i.h-aicon.h-aicon-d').trigger('click');
		$('#userTree').find('.font-red').removeClass('font-red');
		$("#userTree").find('span.h-name-red').removeClass('h-name-red');
		find_host_loading = false;
		return false;
	}
	//flag_ajax_true = true;
	mtr = $.ajax({
		url: '/bhost/PFindHostDirectory_z',
		type: "POST",
		async: true,
		data: {a0:se,z1:JSON.stringify(find_host_arry),z2:6,z3:0},
		success: function(result){
			//var time_item1=new Date();
			//time_all_+=(time_item1-time_item);
			//_getWait($(".waitTip"));
			mtr=null;
			tmp_list=null;
			flag_ajax_true = false;
			$('#userTree').find('li').show();
			$('#userTree').children('li').hide();
			if (result == "None"){
				$("#server_text1").blur();
				_alert(0,'搜索','无搜索结果',$("#server_text1"));
				_waitDone($(".waitTip"));
				find_host_loading = false;
				return false;
			}
			tmp_list = JSON.parse(result);
			ajax_find_host_doing=true;
			$(tmp_list).each(function(i,item){
				if (item.Type != 3){
					host_path_all.push(item);
					tmp_list = [];
				}
			});
			tmp_list = host_path_all.slice(0);
			//host_path_all = JSON.parse(result);
			//把 过滤信息放入 host_path_all 全局变量
			if (host_path_all.length != 0){
				//开始过滤
				tmp_list_path_strarray=tmp_list.map(function (params) {
					return params.Path;
				});
				flag_ajax_true = false;
				find_append();
			}else{
				ajax_find_host_doing=false;
				$("#server_text1").blur();
				_alert(0,'搜索','无搜索结果',$("#server_text1"));
				_waitDone($(".waitTip"));
				find_host_loading = false;
			}
		}
	});
}

var ajax_data = [];
var MAX_AJAX = 50;
var ajax_flag = false;
function find_append(){
	ajax_data = [];
	ajax_flag = false;
	var i = 0;
	index_f = 0;
	var t_do1
	var time_do=new Date();
	function _do1(){
		clearTimeout(t_do1);
		for(i = index_f; i< index_f + 50;i++){
			if(ajax_flag == true) {
				t_do1=setTimeout(function () {_do1();},1);
				return false;
			}
			if(flag_ajax_true == true)  {
				t_do1=setTimeout(function () {_do1();},1);
				return false;
			}
			if (i >= host_path_all.length){    //
				if(flag_ajax_true == true)  {
					t_do1=setTimeout(function () {_do1();},1);
					return false;
				}
				if (host_path_all.length == 0){
					//过滤结束 开始标红
					scrollTop_check_server1();
					return false;
				}else{
					if(ajax_data.length > 0) ajax_host(); //300个检索叫条件里面的主机 都没达到50 
					index_f = 0;
					t_do1=setTimeout(function () {_do1();},1);
					return false;
				}
			}
			if(host_path_all[i].Type == 3 || host_path_all[i].Type == 4){
				host_path_all.splice(i,1);
			}
			var Path_array=host_path_all[i].Path.split('/');
			var len=Path_array.length;
			if (len == 2){//主机层
				//数据未完全展开 留在 host_path_all，下次继续执行
				if($('#nodehg-'+host_path_all[i].Id).length == 0) continue;//
				$('#nodehg-'+host_path_all[i].Id).parent('li').show();
				$('#nodehg-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
				red_to_font($('#nodehg-'+host_path_all[i].Id));
				$('#nodehg-'+host_path_all[i].Id).siblings('ul').find('li').show();
				//$('#nodehg-'+host_path_all[i].Id).siblings('span.h-name').css({color:"red"});
			}else{
				if (host_path_all[i].Type == 5){ //账号
					for (var j = 1; j < len; j++){
						var id=Path_array[j].split(',')[1];
						s = 0;
						if (j == len-1){ //主机层
							if(flag_loading == true){
								s = 1;
								break;
							}
							//数据未完全展开 留在 host_path_all，下次继续执行
							if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).length == 0){
								continue;
							}
							//show
							$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).parent('li').show();
							red_to_font($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id));
							$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).addClass('show_input');
							$i_item=$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).prev('i');
							if($i_item.attr('class') == "h-blank"){ //
								host_path_all.splice(i,1);	
								s = 1;
								break;
							}
							if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+id).siblings('ul').children('li').length == 0){
								filter_flag_append = true;
								if(ajax_data.length >= MAX_AJAX){
									ajax_host();
									t_do1=setTimeout(function () {_do1();},1);
									return false;
								}else{
									hg_id = Path_array[j-1].split(',')[1];
									inv = ajax_data.indexOf(hg_id + ":" + id);
									if(inv < 0 ) ajax_data.push(hg_id + ":" + id); //没展开的主机 放入ajax_data			
									if(ajax_data.length >= MAX_AJAX){
										//去调用 展开的主机
										ajax_host();
										t_do1=setTimeout(function () {_do1();},1);
										return false;
									}else{
										/*
										if(host_path_all.length <= MAX_AJAX){
											ajax_host();
											return false;
										}
										*/
									}
								}
							}else{
								if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
									filter_flag_append = true;
									$i_item.trigger('click');
								}
							}
						}
						else{ //主机组层
							if($('#nodehg-'+id).length == 0) {
								s = 1
								break;//
							}
							if(flag_loading == true){
								s =1;
								break;
							}
							$('#nodehg-'+id).parent('li').show();
							red_to_font($('#nodehg-'+id));
							$i_item=$('#nodehg-'+id).prev('i');
							//发现主机或者组 其实下面没数据，跳过该条数据
							if($i_item.attr('class') == "h-blank"){ //
								host_path_all.splice(i,1);
								s = 1;
								break;
							}
							if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
								filter_flag_append = true;
								$i_item.trigger('click');
							}
						}
					}
					if (s) continue;
					var s = 0;
					if(flag_loading == true) {continue;}
					//继续
					if ($('input[data='+Path_array[len-2].split(',')[1]+'-'+Path_array[len-1].split(',')[1]+'-'+host_path_all[i].Id+']').length != 0){
						$('input[data='+Path_array[len-2].split(',')[1]+'-'+Path_array[len-1].split(',')[1]+'-'+host_path_all[i].Id+']').parent('li').show();
						$('input[data='+Path_array[len-2].split(',')[1]+'-'+Path_array[len-1].split(',')[1]+'-'+host_path_all[i].Id+']').siblings('span.h-name').addClass('h-name-red');
						red_to_font($('input[data='+Path_array[len-2].split(',')[1]+'-'+Path_array[len-1].split(',')[1]+'-'+host_path_all[i].Id+']'));
						$('input[data='+Path_array[len-2].split(',')[1]+'-'+Path_array[len-1].split(',')[1]+'-'+host_path_all[i].Id+']').siblings('ul').find('li').show();
					}
				}
				else{
					s = 0;
					for (var j = 1; j < len-1; j++){
						var id=Path_array[j].split(',')[1];
						if($('#nodehg-'+id).length == 0) {
							s = 1;
							break;//
						}
						if(flag_loading == true) {
							s = 1;
							break;
						}

						$('#nodehg-'+id).parent('li').show();
						$i_item=$('#nodehg-'+id).siblings('i.h-aicon');
						if($i_item.attr('class') == "h-blank"){ //
							host_path_all.splice(i,1);	
							//i--;
							s = 1;
							break;//
						}
						if($('#nodehg-'+id).length >0){
							red_to_font($('#nodehg-'+id));
							if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
								filter_flag_append = true;
								$i_item.trigger('click');
							}
						}
					}
					if(s) continue;
					if(host_path_all[i].Type==1){
						if($('#nodehg-'+host_path_all[i].Id).length == 0) continue;//
						$('#nodehg-'+host_path_all[i].Id).parent('li').show();
						$('#nodehg-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
						red_to_font($('#nodehg-'+host_path_all[i].Id));
						$('#nodehg-'+host_path_all[i].Id).siblings('ul').find('li').show();
					}else{
						if($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).length == 0){
							continue;
						}
						$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).parent('li').show();

						$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).addClass('show_input');
						$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).siblings('span.h-name').addClass('h-name-red');
						red_to_font($('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id));
						$('#nodeh-'+Path_array[j-1].split(',')[1]+'-'+host_path_all[i].Id).siblings('ul').find('li').show();
					}
				}
			}
			//数据展开后 从host_path_all删除掉，并且放在old_path_all，为标红和定位准备
			push_filter_wait.push(host_path_all[i]);
			old_path_all.push(host_path_all[i]);
			host_path_all.splice(i,1);
		}
		index_f = i;
		get_msg();
		t_do1=setTimeout(function () {_do1();},1);
	}
	_do1();
}
function get_msg(){
	var n=0;
	$.ajax({
		url: '/bhost/get_msg',
		type: "post",
		async:false,
		data: {a0:se},
		success: function(result) {
			var result=JSON.parse(result);
			if(result.Result == false){
				if(result.info.indexOf('系统异常')>=0 || result.info.indexOf('非法访问')>=0 || result.info.indexOf('系统超时') >=0 ){
					_alert(2,'系统',result.info);
				}else{
					_alert(2,'系统',result.info);
				}
			}
			else{
			}
		}
	})
	if(n) return false;	
}
var find_append_fun_for_time=0;
var find_append_setInterval_time=0;
var push_filter_wait = [];
var top1 = 9007199254740992;
function scrollTop_check_server1(){
	var index_i = 0;
	var i = 0;
	li_hide_while_no_red($('#userTree'),0);
	find_host_loading = false;
	if($('#userTree').find('span.h-name-red').length==0){
		$("#server_text1").blur();
		_alert(0,'搜索','无搜索结果',$("#server_text1"));
		_waitDone($(".waitTip"));
		flag_ajax_true = true;
		ajax_find_host_doing=false;
		return false;
	}
	$('#hosttree_div1').scrollTop($('#userTree').find('span.h-name-red').eq(0).offset().top-200);
	ajax_find_host_doing=false;
	flag_ajax_true = true;
	_waitDone($(".waitTip"));
	old_path_all=new Array();
}

function red_to_font(obj){
	var span_obj=$(obj).siblings('span.h-name');
	var item_name=span_obj.siblings('input').attr('data-name');
	var Type = span_obj.siblings('input').attr('id');
	var $span_son_font=$('.h-name-son',span_obj).find('font');
	
	if(Type.indexOf('nodeh')<0){
		var span_son_name=item_name.toLowerCase();
	}else{
		var host_span_arr=item_name.split('\t');
		var span_son_name=(host_span_arr[0]+'('+host_span_arr[1]+')').toLowerCase();
	}
	
	for(var jm=0;jm<find_host_arry.length;jm++){
		var jm_index_ = find_host_arry[jm].indexOf('-');
		var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
		$.each(search_arr,function(i1,item1){
			if(item1==''){
				return true;
			}
			if (find_host_arry[jm].substr(0, jm_index_) == '组名'){
				Name = item_name;
				if(Type.indexOf('nodehg')<0){
					return true;
				}
			}else if (find_host_arry[jm].substr(0, jm_index_) == '主机名') {
				Name = item_name.split('\t')[1];
				if(Type.indexOf('nodeh')<0 || Type.indexOf('nodehg')>=0){
					return true;
				}
				/*
				if(Type.indexOf('nodeh')<0){
					return false;
				}
				*/
			} else if (find_host_arry[jm].substr(0, jm_index_) == 'IP'){
				Name = item_name.split('\t')[0];
				if(Type.indexOf('nodeh')<0 || Type.indexOf('nodehg')>=0){
					return true;
				}
				/*
				if(Type.indexOf('nodeh')<0){
					return false;
				}
				*/
			}else if (find_host_arry[jm].substr(0, jm_index_) == '账号'){
				Name = item_name;
				if(Type.indexOf('nodea')<0){
					return true;
				}
			}else{
				Name = item_name;
			}
			if(coverString(item1,Name)){
				item1=item1.toLowerCase();
				if(find_host_arry[jm].substr(0, jm_index_) == '主机名'){
					var index_start=span_son_name.indexOf('(');
					var index_true=span_son_name.indexOf(item1,index_start);
					if(index_true>=0){
						for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
							$span_son_font.eq(i_red_span).addClass('font-red');
						}
					}
				}else{
					var index_true=span_son_name.indexOf(item1);
					if(index_true>=0){
						for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
							$span_son_font.eq(i_red_span).addClass('font-red');
						}
					}
				}
			}
		});
	}
}

String.prototype.ResetBlank=function(){
	var regEx = /\s+/g; 
	return this.replace(regEx, ' '); 
};

function li_red_to_no_red(obj){
	var red_input=$(obj).find('span.h-name-red');
	for(var im=0;im<red_input.length;im++){
		var item=red_input.eq(im);
		var pass=true;
		var item_name=item.siblings('input').attr('data-name');
		var Type = item.siblings('input').attr('id');
		var $span_son_font=$('.h-name-son',item).find('font');
		var span_son_name=item_name.toLowerCase();
		for(var jm=0;jm<find_host_arry.length;jm++){
			var pass_one=false;
			//var search_arr=find_host_arry[jm].split(' ');
			var jm_index_ = find_host_arry[jm].indexOf('-');
			var search_arr = find_host_arry[jm].substr(jm_index_ + 1, find_host_arry[jm].length).split(' ');
			$.each(search_arr,function(i1,item1){
				if (find_host_arry[jm].substr(0, jm_index_) == '组名'){
					Name = item_name;
					if(Type.indexOf('nodehg')<0){
						return false;
					}
				}else if (find_host_arry[jm].substr(0, jm_index_) == '主机名') {
					Name = item_name.split('\t')[0];
					if(Type.indexOf('nodeh')<0){
						return false;
					}
				} else if (find_host_arry[jm].substr(0, jm_index_) == 'IP'){
					Name = item_name.split('\t')[1];
					if(Type.indexOf('nodeh')<0){
						return false;
					}
				}else if (find_host_arry[jm].substr(0, jm_index_) == '账号'){
					Name = item_name;
					if(Type.indexOf('nodea')<0){
						return false;
					}
				}else{
					Name = item_name;
				}
				if(coverString(item1,Name)){
					item1=item1.toLowerCase();
					if(find_host_arry[jm].substr(0, jm_index_) == '主机名'){
						var index_start=span_son_name.indexOf('(');
						var index_true=span_son_name.indexOf(item1,index_start);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}else{
						var index_true=span_son_name.indexOf(item1);
						if(index_true>=0){
							for(var i_red_span=index_true;i_red_span<index_true+item1.length;i_red_span++){
								$span_son_font.eq(i_red_span).addClass('font-red');
							}
						}
					}
					pass_one=true;
					return false;
				}
			});
			if(pass_one==false){
				pass=false;
				//break;
			}
		}
		if(pass==false){
			item.removeClass('h-name-red');
			$span_son_font.removeClass('font-red');
		}else{
		}
	}
}
function li_hide_while_no_red(obj,num){
	var li_visible=$(obj).children('li');
	for(var i=num;i<num+100;i++){

		if(i>=li_visible.length){
			break;
		}
		var item=li_visible.eq(i);
		
		var span_id = $(item).children('span.h-name').attr('id');
		
		if (_jScrollBar_array.indexOf(span_id) === -1){
			_jScrollBar_array.push(span_id);
			_jScrollBar(span_id);
		}
		
		var span_red_time=$(item).find('span.h-name-red').length;
		if(span_red_time==0){
			$(item).hide();
		}else if(span_red_time>0){
			$(item).show();
			var children_red_time=$(item).children('span.h-name-red').length;
			if(children_red_time>0 && span_red_time==1){
				$(item).children('i.h-aicon-d').removeClass('h-aicon-d');
				$(item).children('ul').hide();
				$(item).find('li').show();
			}
			else if(children_red_time>0 && span_red_time>1){
				$(item).find('li').show();
			}
			else if (children_red_time==0) {
				var $children_ul=$(item).children('ul');
				li_hide_while_no_red($children_ul,0);
			}
		}
	}
    if(i<li_visible.length){
        setTimeout(function () {li_hide_while_no_red(obj,i);},1);
    }
	
}
/* 
* 处理过长的字符串，截取并添加省略号 
* 注：半角长度为1，全角长度为2 
*  
* pStr:字符串 
* pLen:截取长度 
*  
* return: 截取后的字符串 
*/
function autoAddEllipsis(pStr, pLen) {
	var _ret = cutString(pStr, pLen);
	var _cutFlag = _ret.cutflag;
	var _cutStringn = _ret.cutstring;
	
	if ("1" == _cutFlag) {
		return _cutStringn + "...";
	} else {
		return _cutStringn;
	}
}
/* 
* 取得指定长度的字符串 
* 注：半角长度为1，全角长度为2 
*  
* pStr:字符串 
* pLen:截取长度 
*  
* return: 截取后的字符串 
*/
function cutString(pStr, pLen) {
	// 原字符串长度  
	var _strLen = pStr.length;

	var _tmpCode;

	var _cutString;

	// 默认情况下，返回的字符串是原字符串的一部分  
	var _cutFlag = "1";

	var _lenCount = 0;

	var _ret = false;

	if (_strLen <= pLen / 2) {
		_cutString = pStr;
		_ret = true;
	}

	if (!_ret) {
		for (var i = 0; i < _strLen; i++) {
			if (isFull(pStr.charAt(i))) {
				_lenCount += 2;
			} else {
				_lenCount += 1;
			}

			if (_lenCount > pLen) {
				_cutString = pStr.substring(0, i);
				_ret = true;
				break;
			} else if (_lenCount == pLen) {
				_cutString = pStr.substring(0, i + 1);
				_ret = true;
				break;
			}
		}
	}

	if (!_ret) {
		_cutString = pStr;
		_ret = true;
	}

	if (_cutString.length == _strLen) {
		_cutFlag = "0";
	}

	return { "cutstring": _cutString, "cutflag": _cutFlag };
}

/* 
* 判断是否为全角 
*  
* pChar:长度为1的字符串 
* return: true:全角 
*          false:半角 
*/
function isFull(pChar) {
	if ((pChar.charCodeAt(0) > 128)) {
		return true;
	} else {
		return false;
	}
}

function _getWait(obj){
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
	
	$(obj).removeClass('done').show().unbind().on('mouseover',function(){
		waitlayer = layer.tips('搜索中',this,{
			tips:1,
			time:0,
			skin: 'waitlayer'
		});
	}).on('mouseout',function(){
		if(typeof waitlayer != 'undefined'){
			layer.close(waitlayer);
		}
	});

	// //完成
	// setTimeout(function(){
	// 	_waitDone();
	// },3000)
}
function _waitDone(obj){
	if(typeof waitlayer != 'undefined'){
		layer.close(waitlayer);
	}
	$(obj).fadeOut(3000);
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
}

function reload_pwd(){
	document.frm_pwdauth.action = '/bhost/password_entry_show';
    document.frm_pwdauth.submit(); 
}

</script>
</body>
</html>
