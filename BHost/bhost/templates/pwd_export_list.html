
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>manager</title>
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/style.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<!--script-->
	<script src="/manage/js/jquery.min.js"></script>
	<script src="/manage/js/jquery.easing.js"></script>
	<script src="/manage/js/layer.js"></script>
	<script src="/manage/js/common.js"></script>
	<script src="/manage/js/common_e.js"></script>

	<!--icheck-->
	<script src="/manage/js/icheck.min.js"></script>

	<!--select2-->
	<script src="/manage/js/select2.full.min.js"></script>

</head>
<body style="overflow:hidden;" class="bg-white">
		<div class="rwrap">
            <div class="c-top">
				<div class="c-title c-title-pc">
					<!-- <h3 class="tit" onclick="back();">
						<span>密码导出</span>
						<i class="" style="background-position: 30px 0;"></i>
					</h3> -->
					<div class="manual-head">
						<div class="manual-title">
							<span onclick="pwd_export();">密码导出</span>
							<i class="pwd_export_icon"></i>
						</div>
					</div>
				</div>
			</div>
		<div class="mainer" name="pwd_export" id="pwd_export" >
			
			<div class="container">
				<div class="c-cont">
					<div class="c-wrap">
						<div class="c-table r-list">
							<div class="tab-t">
								<div class="ctr" style="width:auto">
                                    <a href="javascript:;" class="btn btn-default" onclick="click_all_list();" style="display:none;">全选</a>
                                    
                                    <a href="javascript:;" class="btn btn-default" id="down_load_1" onclick="down_load(1);" style="display:none;">下载</a>	
									<a href="javascript:;" class="btn btn-default" id="down_load_2" onclick="down_load(2);" style="display:none;">发送</a>
									<a href="javascript:;" class="btn btn-default" id="PwdApprove_User" onclick="PwdApprove_User();" style="display:none;">审批</a>
									<a href="javascript:;" class="btn btn-default" onclick="pwd_export_page(0);clear_all();" style="display:none;">刷新</a>
								</div>
								<div class="filter">
									<div class="search">
										<select name="pwd_export_select" id="pwd_export_select" class="filter-select">
											<option value="all" selected>所有</option>
											<option value="hostname">主机名</option>
											<option value="hostip">主机IP</option>
										</select>

										<input type="text" style="/*display:none;*/padding-right: 22px;" 
										class="filter-text" placeholder="输入关键字" 
										name="pwd_export_text" id="pwd_export_text" maxlength="128" 
										onchange="if($('#pwd_export_text').val()==''){$('#pwd_export_text_check').hide();}else{$('#pwd_export_text_check').show();}"
										onkeyup="if($('#pwd_export_text').val()==''){$('#pwd_export_text_check').hide();}else{$('#pwd_export_text_check').show();}"
										onblur="if($('#pwd_export_text').val()=='' && search_typeall_new!=''){search_typeall_new='';_addFilter(this,false,1);}"
										onkeydown="if($('#pwd_export_text').val()==''){$('#pwd_export_text_check').hide();}else{$('#pwd_export_text_check').show();}; if (event.keyCode == 13){_addFilter(this,false);return false;} else return; ">
										<i class="v-check v-wrong" id="pwd_export_text_check" 
										onclick="_clearFilter(this,1)" 
										style="display:none;cursor: pointer;float: left;position: static;"></i>
										<button class="btn filter-btn" onclick="_addFilter(this,false);"><i class="add-filter"></i></button>
										<button class="btn filter-btn" onclick="_addFilter(this,true)"><i class="append-filter"></i></button>
									</div>
									<div class="search" id="clearFilter" style="margin: 0px 15px 0px -16px;display:none;">
										<button class="filter-btn" onclick="_clearFilter(this)"><i class="clear-filter"></i></button>
									</div>
									<div class="selector selector-multiple" id="filterWW" style="display:none;">
										<span class="ww">搜索条件</span>
										<ul>
										</ul>
									</div>
								</div>
							</div>
							<div class="box-table">
								<table cellpadding="0" cellspacing="0">
									<thead>
										<tr>
											<th width="50"><input type="checkbox" class="form-checkbox" id="check_one_page"/></th>
											<th>主机名</th>
                                            <th>IP</th>
                                            <th>账号数量</th>
											<th width="60"></th>
										</tr>
									</thead>

									<tbody name="pwd_export_list" id="pwd_export_list">
									</tbody>
								</table>
							</div>
							<div class="tab-i">
								<div class="il">
									每页显示<span id="page_nums">10</span>条 总数：<span id = "pwd_export_total">0</span>  选中：<span class="sum">0</span>
								</div>

								<div class="ipage">
									<a href="javascript:;" class="nav2 begin" id="pwd_export_begin" onclick="pwd_export_page(0.1);" ><i></i></a>
									<a href="javascript:;" class="nav prev" id="pwd_export_prev" onclick="pwd_export_page(-1);" ><i></i></a>
									<input type="text" id = "pwd_export_page" value="1" onchange="showMsg();" onblur="showMsg();">/&nbsp;<span id = "pwd_export_pages">1</span>
									<a href="javascript:;" class="nav next" id="pwd_export_next" onclick="pwd_export_page(1);" ><i></i></a>
									<a href="javascript:;" class="nav2 end" id="pwd_export_end" onclick="pwd_export_page(0.9);" ><i></i></a>
								</div>
							</div>
						</div>
						
						<div class="clearfix"></div>
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn" style="float: right;" onclick="back();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	</div>
	<form action="/bhost/get_pwd_export_list" method="POST" name="frm_pwd_export" id="frm_pwd_export">	
			<input type="hidden" name="tasktype" id = "tasktype" value="{{tasktype}}" />
			<!--创建 编辑 列表-->
			<input type="hidden" name="a" id = "a" value="{{a}}" />
			<!--需要查询id-->
			<input type="hidden" name="c" id = "c" value="{{c}}" />
			<!--页码-->
			<input type="hidden" name="d" id = "d" value="{{d}}" />
			<!--search_typeall-->
			<input type="hidden" name="e" id = "e" value="{{e}}" />
			<input type="hidden" name="se" id = "se" value="{{se}}" />
			<!--search_typeall_new-->
	</form>

<script>
	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
</script>

<script>
$('.filter-select').select2({minimumResultsForSearch: -1});
</script>

<script type="text/javascript">
var check_num=0;
var total_all_r=0;
var pwd_export_json_data=null;
var ip_str=[];
//总数
var fenye_r=0;
//总页码
var search_typeall_r=document.frm_pwd_export.d.value==''?new Array():document.frm_pwd_export.d.value.split('\t');
//关键字
function save_pwd_export()
{
	window.parent._closePage(null); 
}
function PwdApprove_User(item_id){
	var hostpwd_data;
	var pass=1;
	$.ajax({
		url: "/bhost/get_global_IfPwdApprove",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				IfPwdFileApprove=result.info.PwdFileApproveNum;
			}
		}
	});
	$.ajax({
		url: "/bhost/get_hostpwdstrategy",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var result_hostpwd=JSON.parse(result);
			if(result_hostpwd.Result){
				hostpwd_data=result_hostpwd.info;
				if (window.parent.document.frm.us.value!='admin' && (hostpwd_data==null ||(IfPwdFileApprove && (hostpwd_data.PwdFileApproveUserSet==null || hostpwd_data.PwdFileApproveUserSet.length==0)))){
					clearInterval(show_list_interval);
					parent.layer.open({
						type: 1,
						title: '密码导出',
						content: '<div class="layer-alert"><i class="alert warning"></i>改密设定未配置</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							parent.layer.close(i);
							hostpwdstrategy_send();
						}
					});
					clearInterval(show_list_interval);
					pass=0;
					return false;
				}else if(window.parent.document.frm.us.value!='admin' && IfPwdFileApprove && hostpwd_data.PwdFileApproveUserSet.length<IfPwdFileApprove){
					parent.layer.open({
						type: 1,
						title: '密码导出',
						content: '<div class="layer-alert"><i class="alert warning"></i>改密设定下载审批配置不正确</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							parent.layer.close(i);
							hostpwdstrategy_send();
						}
					});
					clearInterval(show_list_interval);
					pass=0;
					return false;
				}
			}
		}
	});
	if(pass==0){
		return false;
	}
	$.ajax({
		url: "/bhost/user_value",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				user_value=result.info;
				appr=result.appr;
				if(result.ip_str!=''){
					ip_str=[];
					var ip_str_t=result.ip_str.split(',');
					$.each(ip_str_t,function(i,item){
						if ($.inArray(item,ip_str)<0) ip_str.push(item);
					})
				}else{
					ip_str=[];
				}
			}else{
				clearInterval(show_list_interval);
				_alert(2,'密码导出',result.ErrMsg);
				pass=0
				return false;
			}
		}
	});
	if(pass==0){
		return false;
	}
	var time_new=Date.parse(new Date())+window.parent.document.frm.us.value;
	if(item_id==undefined){
		delect_save();
		if(delect_str.length==0){
			_alert(2,'密码导出','请选择主机');
			return false;
		}
		var id='{'+delect_str.join(',')+'}';
	}else{
		var id=item_id;
	}
	var search_typeall=search_typeall_r.join('\t');
	if(search_typeall_new!=''){
			search_typeall+=('\t'+search_typeall_new);
	}
	
	
	$.ajax({
		url: "/bhost/get_pwd_export_list",
		type:"POST",
		async:true,
		data:{a0:$("input[name=se]").val(),a2:search_typeall,a1:id,a5:false},
		success:function(result){
			var pwd_export_result = JSON.parse(result);
			if (pwd_export_result.Result){
				var pwd_export_data = pwd_export_result.info;
				pwd_export_data.data=pwd_export_data.data.filter(function (index) {
					if (index.AccountPassword==null) index.AccountNum=0;
					return ((index.AccountNum!=0 && index.AccountNum!=null) && ($.inArray(index.HostIP,ip_str)<0));
				})
				delete pwd_export_data.totalrow;
				if(pwd_export_data.data.length==0){
					_closeLoading();
					_alert(2,'密码导出','无有效账号');
					return false;
				}
				var ip_arr=new Array();
				$.each(pwd_export_data.data,function(i,item){
					if($.inArray(item.HostIP,ip_arr)<0){
						ip_arr.push(item.HostIP);
					}
				});
				var UserId_arr=new Array();
				var MessageId_arr=new Array();
				$.each(hostpwd_data.PwdFileApproveUserSet,function(i,item){
					UserId_arr.push(item.UserId);
					msg_json={
						"MessageId":0,
						"MessageType":"13",
						"Title":"申请密码文件导出",
						"SenderId":user_value,
						"Sender":window.parent.document.frm.us.value,
						"ReceiverId":item.UserId,
						"Receiver":item.UserCode,
						"Content":"主机范围："+ip_arr.join(','),
						"Status":2,
						"ProcessStatus":0,
						//"SessionId": time_new
					}
					msstr = aceg(JSON.stringify(msg_json),$("input[name=se]").val());
					$.ajax({
						url: "/bhost/save_receive_msg",
						type:"POST",
						async:false,
						data:{a0:$("input[name=se]").val(),a1:JSON.stringify(msg_json),m1:msstr},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								MessageId_arr.push(result.MessageId);
							}else{
								pass=0;
							}
						},
						error:function(){
							pass=0;
						}			
					});
					if(pass==0){
						return false;
					}
				});
				if(pass==0){
					return false;
				}
				if (hostpwd_data.PwdFileApproveType!=null && hostpwd_data.PwdFileApproveType>1){
					var approve_json={
						"ApproveStrategyId":0,
						"ApproveStrategyName":"%下载审批1%"+(new Date()).valueOf(),
						"ApproveNum":1,
						"ApproveType":hostpwd_data.PwdFileApproveType,
						"UserSet":new Array(),
						"MasterSmsMConfigId":null,
						"MasterSmsMConfig":null,
						"StandBySmsMConfigId":null,
						"StandBySmsMConfig":null,
						"MasterSmsSvrConfigId":((hostpwd_data.MasterSmsSvrConfig!=null && hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigId:0),
						"MasterSmsSvrConfig":((hostpwd_data.MasterSmsSvrConfig!=null && hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigName:"全局指定"),
						"StandBySmsSvrConfigId":((hostpwd_data.StandBySmsSvrConfig!=null && hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigId:0),
						"StandBySmsSvrConfig":((hostpwd_data.StandBySmsSvrConfig!=null && hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigName:"全局指定"),
						"MasterSmtpConfigId":((hostpwd_data.MasterSmtpConfig!=null && hostpwd_data.MasterSmtpConfig.SmtpConfigId!=0)?hostpwd_data.MasterSmtpConfig.SmtpConfigId:0),
						"MasterSmtpConfig":((hostpwd_data.MasterSmtpConfig!=null && hostpwd_data.MasterSmtpConfig.SmtpConfigId!=0)?hostpwd_data.MasterSmtpConfig.SmtpConfigName:"全局指定"),
						"StandBySmtpConfigId":((hostpwd_data.StandBySmtpConfig!=null && hostpwd_data.StandBySmtpConfig.SmtpConfigId!=0)?hostpwd_data.StandBySmtpConfig.SmtpConfigId:0),
						"StandBySmtpConfig":((hostpwd_data.StandBySmtpConfig!=null && hostpwd_data.StandBySmtpConfig.SmtpConfigId!=0)?hostpwd_data.StandBySmtpConfig.SmtpConfigName:"全局指定"),
						"UsedForPwdMod":1,
					}
					var approve_json2={
						"ApproveStrategyId":0,
						"ApproveStrategyName":"%下载审批2%"+(new Date()).valueOf(),
						"ApproveNum":1,
						"ApproveType":hostpwd_data.PwdFileApproveType,
						"UserSet":new Array(),
						"MasterSmsMConfigId":null,
						"MasterSmsMConfig":null,
						"StandBySmsMConfigId":null,
						"StandBySmsMConfig":null,
						"MasterSmsSvrConfigId":((hostpwd_data.MasterSmsSvrConfig!=null && hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigId:0),
						"MasterSmsSvrConfig":((hostpwd_data.MasterSmsSvrConfig!=null && hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.MasterSmsSvrConfig.SmsSvrConfigName:"全局指定"),
						"StandBySmsSvrConfigId":((hostpwd_data.StandBySmsSvrConfig!=null && hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigId:0),
						"StandBySmsSvrConfig":((hostpwd_data.StandBySmsSvrConfig!=null && hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigId!=0)?hostpwd_data.StandBySmsSvrConfig.SmsSvrConfigName:"全局指定"),
						"MasterSmtpConfigId":((hostpwd_data.MasterSmtpConfig!=null && hostpwd_data.MasterSmtpConfig.SmtpConfigId!=0)?hostpwd_data.MasterSmtpConfig.SmtpConfigId:0),
						"MasterSmtpConfig":((hostpwd_data.MasterSmtpConfig!=null && hostpwd_data.MasterSmtpConfig.SmtpConfigId!=0)?hostpwd_data.MasterSmtpConfig.SmtpConfigName:"全局指定"),
						"StandBySmtpConfigId":((hostpwd_data.StandBySmtpConfig!=null && hostpwd_data.StandBySmtpConfig.SmtpConfigId!=0)?hostpwd_data.StandBySmtpConfig.SmtpConfigId:0),
						"StandBySmtpConfig":((hostpwd_data.StandBySmtpConfig!=null && hostpwd_data.StandBySmtpConfig.SmtpConfigId!=0)?hostpwd_data.StandBySmtpConfig.SmtpConfigName:"全局指定"),
						"UsedForPwdMod":1,
					}
					$.each(UserId_arr,function(u_i,u_item){
						approve_json.UserSet.push({"UserId":u_item});
						approve_json2.UserSet.push({"UserId":u_item});
					});
					var ApproveStrategyId=0;
					var ApproveStrategyId2=0;
					var ApproveStrategyarr=[];
					console.log((hostpwd_data.PwdFileApproveType&4)>0);
					if((hostpwd_data.PwdFileApproveType&4)>0){
						var msstr = aceg(JSON.stringify(approve_json),$("input[name=se]").val());
						console.log(approve_json);
						$.ajax({
							url: '/bhost/add_approve',
							type: "POST",
							async: false,
							data: { a0: $("input[name=se]").val(), a1: JSON.stringify(approve_json) ,m1:msstr,a10:"密码管理>改密设定"},
							success: function (result) {
								var result = JSON.parse(result);
								if (result.Result) {
									ApproveStrategyarr.push(result.ApproveStrategyId);
								} else {
									pass=0;
									_alert(1, "审批策略", result.ErrMsg);
									return false;
								}
							},
							error:function(){
								pass=0;
							}
						});
						if (pass==0){
							return false;
						}
					}
					console.log((hostpwd_data.PwdFileApproveType&8)>0);
					if((hostpwd_data.PwdFileApproveType&8)>0){
						var msstr = aceg(JSON.stringify(approve_json2),$("input[name=se]").val());
						console.log(approve_json2);
						$.ajax({
							url: '/bhost/add_approve',
							type: "POST",
							async: false,
							data: { a0: $("input[name=se]").val(), a1: JSON.stringify(approve_json2) ,m1:msstr,a10:"密码管理>改密设定"},
							success: function (result) {
								var result = JSON.parse(result);
								if (result.Result) {
									ApproveStrategyarr.push(result.ApproveStrategyId);
								} else {
									pass=0;
									_alert(1, "审批策略", result.ErrMsg);
									return false;
								}
							},
							error:function(){
								pass=0;
							}
						});
						if (pass==0){
							return false;
						}
					}
					$.ajax({
						url: '/bhost/save_authmessage',
						type: "POST",
						async: false,
						data: { a0: $("input[name=se]").val(), a1: UserId_arr.join(','),a2:ApproveStrategyarr.join(','),a3:hostpwd_data.PwdFileApproveType,a4:("主机范围："+ip_arr.join(',')),a5:MessageId_arr.join(','),a6:ip_arr.join(','),a7:UserId_arr.length},
						success: function (result) {
							var result = JSON.parse(result);
							if (result.Result) {
							} else {
								pass=0;
								_alert(1, "密码导出", result.ErrMsg);
								return false;
							}
						}
					});
				}
				if(pass==0){
					return false;
				}
				_alert(0,'密码导出','审批已发送');
				
				
			}else{
				_alert(1,'密码导出',pwd_export_result.ErrMsg);
				return false;
			}
		}
	});
}
var IfPwdFileApprove=null;
var hostpwd_data=null;
var user_value=null;
var appr=0;
var show_list_interval=null;
$(function(){
	document.frm_pwd_export.se.value=window.parent.document.frm.se.value;
	$("#pwd_export_select").change(function(){
		var type = $(this).val();
		if(type == 0){
			$("#pwd_export_text").hide();
			$('#filterWW').hide();
			$('#clearFilter').hide();
		}else{
			$("#pwd_export_text").show();
			if($('#filterWW ul li').length){
				$('#filterWW').show();
				$('#clearFilter').show();
			}
		}
	});
	if(search_typeall_r.length!=0){
		var v1="";
		var id="";
		var str_new="";
		$.each(search_typeall_r,function(i,item){
			if(item==""){
				return false;
			}
			var str_sea=item.split("-");
			v1=$('#pwd_export_select').find('option[value='+str_sea[0]+']').text();
			id=str_sea[0];
			str_sea[0]=v1;
			str_new=str_sea.join('-');
			$('#filterWW>ul').append('<li><span style = "display:none">'+id+'</span><span class="ww">'+str_new+'</span><i class="del" onclick="_delFilter(this);"></i></li>');
		});
	}
	if(search_typeall_new!=''){
		var array=search_typeall_new.substr(0,search_typeall_new.length-1).split('-');
		$('#pwd_export_select').val(array[0]).trigger('change');
		$('#pwd_export_text').val(array[1]);
	}
	//输入数字
	$("#pwd_export_page").bind('keydown', function(e){
		DigitInput(e);
	});
	//页码显示
	$("#page_nums").val(MAX_PAGE);
	//list show
	show_list_interval=setInterval(function(){
		show_pwd_export_list();
	},60000);
	show_pwd_export_list();
	// show_pwd_export_list();
	// update_array();
	parent._switchBtn(1);//显示按钮
	//tr双击事件
	$("#pwd_export_list").on('dblclick','tr',function(e){
		x=e.target;
	}).on("click", "tr", function (e){  
		x=e.target;
		//发送
		if(x.id == 'send'){ 
			var id=$(this).find("td");
			var edit_item=$(id).eq(1).text();
			down_load_ajax('{'+edit_item+'}',2);
		}
		//下载
		if(x.id == 'download'){
			var id=$(this).find("td");
			var edit_item=$(id).eq(1).text();
			down_load_ajax('{'+edit_item+'}',1);
		}
		if (x.id=='appr'){
			var id=$(this).find("td");
			var edit_item=$(id).eq(1).text();
			PwdApprove_User('{'+edit_item+'}');
		}
	});
	$('#check_one_page').on(' ifClicked',function(e){
		if(!$('#check_one_page').is(':checked')){
			$("table tbody tr input").iCheck('check');
		}else{
			$("table tbody tr input").iCheck('uncheck');
		}
	});
	$("#pwd_export_list").on("ifChecked",function(e){
		check_num++;
		$("span.sum").text(check_num);		
		if($("table tbody tr").find("input:checked").length==$("table tbody tr").find("input").length){
			$('#check_one_page').iCheck('check');
		}
	}).on("ifUnchecked",function(e){
		check_num--;
		$("span.sum").text(check_num);	
		$('#check_one_page').iCheck('uncheck');	
	});
})
//显示创建页面
function pwd_export_add(){
	document.frm_pwd_export.tasktype.value=3;
	document.frm_pwd_export.a.value=0;
	document.frm_pwd_export.action = '/bhost/pwd_export_strategy';
	document.frm_pwd_export.d.value=search_typeall_r.join('\t');
	document.frm_pwd_export.e.value=search_typeall_new;		
	document.frm_pwd_export.submit();
}
//刷新
function clear_all(){
	$("table tbody tr").find("input").iCheck('uncheck');
	delect_str=new Array();
	check_num=0;
	$("span.sum").text(check_num);
}
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
var ipReg =/(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
String.prototype.ResetBlank=function(){
		var regEx = /\s+/g; 
		return this.replace(regEx, ' '); 
	};
function _addFilter(obj,type,type_num){
	var id = $(obj).parent().children('select').children('option:selected').val();
	var v1 = $(obj).parent().children('select').children('option:selected').text();
	var v2 = $(obj).parent().children('input[type=text]').val().trim();
	if(id=='all'){
		v1='';
	}else{
		v1=v1+'-';
	}
	v2=v2.ResetBlank();
	if(v2 == '' && type_num!=1){
		$(obj).parent().children('input[type=text]').blur();
		_alert(2,'搜索','请输入关键字', $(obj).parent().children('input[type=text]'));
		return false;
	}
	// else
	{
		switch(id){
			case 'hostname':
				var Reg=/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
				break;
			case 'hostip':
				var Reg=/^[\d\.;]+$/;
				break;
		}
		if(id!='all' && !Reg.test(v2) && type_num!=1){
			$(obj).parent().children('input[type=text]').blur();
			_alert(1,'搜索','关键字格式不正确', $(obj).parent().children('input[type=text]'));
			return false;
		}
		if($.inArray((id+'-'+v2),search_typeall_r)>=0 && type_num!=1){
			$(obj).parent().children('input[type=text]').blur();
			_alert(2,'搜索','相同的关键字已存在', $(obj).parent().children('input[type=text]'));
			return false;
		}
		if(type){
			search_typeall_r.push(id+'-'+v2);
			search_typeall_new='';
			$('#filterWW>ul').append('<li><span style = "display:none">'+id+'-'+v2+'</span><span class="ww">'+v1+v2+'</span><i class="del" onclick="_delFilter(this);"></i></li>')
			$("#pwd_export_text").val('');
			$('#pwd_export_text_check').hide();
			selView();
		}else{
			if(type_num!=1)search_typeall_new=id+'-'+v2;
		}
	}
	$("table tbody tr").find("input").iCheck('uncheck');
	delect_str=new Array();
	pwd_export_page(0.1);
	// update_array();
	check_num=0;
	$("span.sum").text(check_num);
}
var search_typeall_new=document.frm_pwd_export.e.value;
function _delFilter(obj){
	var id = $(obj).parent().find("span");
	var ids=$(id).eq(0).text();
	search_typeall_r.splice($.inArray(ids,search_typeall_r),1);
	var pwd_export_text=$('#pwd_export_text').val().trim();
	if(pwd_export_text==''){
		search_typeall_new=='';
	}else{
		search_typeall_new=$('#pwd_export_select').val()+'-' +pwd_export_text;
	}
	$(obj).parent().remove();
	selView();
	$("table tbody tr").find("input").iCheck('uncheck');	
	delect_str=new Array();
	pwd_export_page(0.1);
	// update_array();
	check_num=0;
	$("span.sum").text(check_num);
}
function _clearFilter(obj,num){
	if(num==1){
	$('#pwd_export_text').val('');
	$('#pwd_export_text_check').hide();
	search_typeall_new='';
	$("table tbody tr").find("input").iCheck('uncheck');
	delect_str=new Array();
	pwd_export_page(0.1);
	check_num=0;
	$("span.sum").text(check_num);
		return;
	}
	$('#clearFilter').next().children('ul').empty();
	$('#pwd_export_text').val('');
	$('#pwd_export_text_check').hide();
	search_typeall_new='';
	search_typeall_r=new Array();
	selView();
	$("table tbody tr").find("input").iCheck('uncheck');
	delect_str=new Array();
	pwd_export_page(0.1);
	// update_array();
	check_num=0;
	$("span.sum").text(check_num);
}
function selView(){
	var $sel = $('#filterWW');
	var len = $('li',$sel).length;
	if(len == 0){
		$sel.hide();
		$('#clearFilter').hide();
	}else{
		$("#filterWW").show();
		$('#clearFilter').show();
		$('>span.ww',$sel).show();
		$sel.addClass('selector-multiple');
	}
}
//down_load_ajax
function down_load_ajax(id,num){
	if (id==null){
		id='{'+delect_str.join(',')+'}';
	}
	var search_typeall=search_typeall_r.join('\t');
	if(search_typeall_new!=''){
		search_typeall+=('\t'+search_typeall_new);
	}
	$.ajax({
		url: "/bhost/get_pwd_export_list",
		type:"POST",
		async:true,
		data:{a0:$("input[name=se]").val(),a2:search_typeall,a1:id,a5:false},
		success:function(result){
			var pwd_export_result = JSON.parse(result);
			if (pwd_export_result.Result){
				var pwd_export_data = pwd_export_result.info;
				pwd_export_data.data=pwd_export_data.data.filter(function (index) {
					if (index.AccountPassword==null) index.AccountNum=0;
					return ((index.AccountNum!=0 && index.AccountNum!=null) && ((!$('#PwdApprove_User').is(':hidden') && $.inArray(index.HostIP,ip_str)>=0) || $('#PwdApprove_User').is(':hidden')));
				})
				delete pwd_export_data.totalrow;
				if(pwd_export_data.data.length==0){
					_closeLoading();	
					_alert(2,'密码导出','无有效账号');
					return false;
				}
				_showLoading();
				if(num==1){
					$.ajax({
						url:'/bhost/export_pwd',
						type:'post',
						async:false,
						data:{a0:$("input[name=se]").val(),a1:JSON.stringify(pwd_export_data),a2:num,a3:4},
						success:function(result){
							repeat_get = function(){
								if_ok_down = setInterval(function(){
									get_down_ok(num);
								},5000)}
							repeat_get();
						}
					});	
					
				}
				else{
					$.ajax({
						url: "/bhost/export_pwd",
						type:"POST",
						async:true,
						data:{a0:$("input[name=se]").val(),a1:JSON.stringify(pwd_export_data),a2:num,a3:4},
						success:function(result){
							repeat_get = function(){
								if_ok_down = setInterval(function(){
									get_down_ok(num);
								},5000)}
							repeat_get();
						},
						error:function(){
							_alert(1,'密码导出','发送方式配置不正确');
							_closeLoading();
							return false;
						}						
					});
				}
			}
			else{
				_alert(1,'密码导出',pwd_export_result.ErrMsg);
				_closeLoading();
				return false;
			}
		}
	});
}
var if_ok_down=null;
var use_BH=window.parent.parent.document.frm.use_BH.value;
function get_down_ok(num){
	$.ajax({
		url:'/bhost/get_down_ok_pwd',
		type:'post',
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var down_result = JSON.parse(result);
			if (down_result.Result){
				clearInterval(if_ok_down);
				_closeLoading();
				if (down_result.ErrMsg != "None"){
					if(num==2){
						if(down_result.ErrMsg.indexOf('发送成功')>=0){
							_alert(0,"密码导出",down_result.ErrMsg);
							return false;
						}
					}
					_alert(1,"密码导出",down_result.ErrMsg);
					return false;
				}
				if(num==1){

				}
				else{
					if(down_result.ErrMsg == "None"){
						_alert(0,"密码导出",'发送成功');
						return 0;
					}
				}
				if(use_BH=='0'){
					location.href = '/bhost/download_expt?a0='+$("input[name=se]").val();
					return 0;
				}
				var sesstimet = (new Date()).valueOf();
				var referrer_arr=document.referrer.toString().split('/');
				referrer_arr.pop();
				var referrer=referrer_arr.join('/');
				var json_download = {
						"Type": "Download",
						"Url": referrer,
						"Path": '/usr/storage/.system/passwd/',
						"Filename": 'expt_'+window.parent.document.frm.us.value+'.'+window.parent.document.frm.se.value+'.pwd',
						"Session": $("input[name=se]").val(),
						"sesstimet":sesstimet,
						"Filenewname": 'expt_'+window.parent.document.frm.us.value+'.pwd',
				}
				var if_html_client = false;
				var base64_str = '';
				$.ajax({
						url: "/bhost/get_base64",
						type:"POST",
						async:false,
						data:{a0:$("input[name=se]").val(),z1:JSON.stringify(json_download)},
						success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
										if_html_client = result.info;
										base64_str = result.b64;
								}else{
										_alert(1,"密码导出",result.ErrMsg); 
								}
						}
				})
				if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
				else{
					get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
					$('#YuFrame1').remove();
					$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
					$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
				}
			}
		}
	});
}
//下载
function down_load(num) {
	
	delect_save();
	if(delect_str.length==0){
		_alert(2,'密码导出','请选择主机');
		return false;
	}
	down_load_ajax(null,num);
}
//选中字段存储
function delect_save(){
	$(">tr","#pwd_export_list").each(function(i,item){
		var input  = $(this).find("input[type='checkbox']");
		var delect_item=$(">td",this).eq(1).text();
		var index=$.inArray(delect_item,delect_str);
		if($(input).is(':checked')){
			if(index<0){
				delect_str.push(delect_item);
			}
		}else{
            if(index>=0 ){
                delect_str.splice(index,1);
            }
		}
	});
}
//check显示
function check_show(){
	$(">tr","#pwd_export_list").each(function(i,item){
		//////console.log($(this).find("input"));
		var check_id=$(">td",this).eq(1).text();
        if($.inArray(check_id,delect_str)>=0){
            $('#input-'+check_id).iCheck('check');
        }
	});
}
//input回车触发事件
function showMsg(){
	delect_save();
	var cur = $("#pwd_export_page").val();
	cur=cur.replace(/\D/g, "");
	if(cur=='' || parseInt(cur) < 1){
		cur=1;
	}else if (parseInt(cur)>fenye_r) {
		cur=fenye_r;
	}
	if (parseInt(cur) ==parseInt(document.frm_pwd_export.c.value)){
		$("#pwd_export_page").val(cur);
		return false;
	}
    document.frm_pwd_export.c.value=cur;
	show_pwd_export_list();
}
function hostpwdstrategy_send() {
	document.frm_pwd_export.action = '/bhost/hostpwd_showing'
	document.frm_pwd_export.submit();
}
//以每页显示数显示列表函数
function show_pwd_export_list(){
	var pass=1;
	$.ajax({
		url: "/bhost/get_global_IfPwdApprove",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				IfPwdFileApprove=result.info.PwdFileApproveNum;
			}
		}
	});
	$.ajax({
		url: "/bhost/get_hostpwdstrategy",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var result_hostpwd=JSON.parse(result);
			if(result_hostpwd.Result){
				hostpwd_data=result_hostpwd.info;
				if (window.parent.document.frm.us.value!='admin' && (hostpwd_data==null ||(IfPwdFileApprove && (hostpwd_data.PwdFileApproveUserSet==null || hostpwd_data.PwdFileApproveUserSet.length==0)))){
					parent.layer.open({
						type: 1,
						title: '密码导出',
						content: '<div class="layer-alert"><i class="alert warning"></i>改密设定未配置</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							parent.layer.close(i);
							hostpwdstrategy_send();
						}
					});
					clearInterval(show_list_interval);
					pass=0;
					return false;
				}else if(window.parent.document.frm.us.value!='admin' && IfPwdFileApprove && hostpwd_data.PwdFileApproveUserSet.length<IfPwdFileApprove){
					parent.layer.open({
						type: 1,
						title: '密码导出',
						content: '<div class="layer-alert"><i class="alert warning"></i>改密设定下载审批配置不正确</div>',
						btn: ['确&nbsp;&nbsp;定'],
						btnAlign: 'c',
						closeBtn: false,
						skin: 'layer-custom',
						area: ['380px', '310px'],
						move: false,
						resize: false,
						yes: function (i) {
							parent.layer.close(i);
							hostpwdstrategy_send();
						}
					});
					clearInterval(show_list_interval);
					pass=0;
					return false;
				}
			}
		}
	});
	if(pass==0){
		return false;
	}
	$.ajax({
		url: "/bhost/user_value",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val()},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				user_value=result.info;
				appr=result.appr;
				if(result.ip_str!=''){
					ip_str=[];
					var ip_str_t=result.ip_str.split(',');
					$.each(ip_str_t,function(i,item){
						if ($.inArray(item,ip_str)<0) ip_str.push(item);
					})
				}else{
					ip_str=[];
				}
			}else{
				_alert(2,'密码导出',result.ErrMsg);
				clearInterval(show_list_interval);
				pass=0
				return false;
			}
		}
	});
	if(pass==0){
		return false;
	}
	$('.ctr>a').show();
	if((hostpwd_data!=null && hostpwd_data.PwdFileApproveNum) && window.parent.document.frm.us.value!='admin'){
		$('#PwdApprove_User').show();
		$('#pwd_export_list').prev('thead').find('th:last').css('width',80);
	}else{
		$('#PwdApprove_User').hide();
		$('#pwd_export_list').prev('thead').find('th:last').css('width',60);
	}
	$('#down_load_1').show();	
	$('#down_load_2').show();	
	/*
	if(window.parent.document.frm.us.value!='admin' && hostpwd_data.PwdFileApproveNum && hostpwd_data.PwdFileApproveUserSet.length>0 && appr==0){
		$('#down_load_1').hide();	
		$('#down_load_2').hide();	
	}else{
		$('#down_load_1').show();	
		$('#down_load_2').show();	
	}
	*/
	update_all_list();
	var paging = document.frm_pwd_export.c.value;
	var page_num = MAX_PAGE;
	var pwd_exportId=document.frm_pwd_export.a.value;
	var search_typeall=search_typeall_r.join('\t');
    if(search_typeall_new!=''){
        search_typeall+=('\t'+search_typeall_new);
    }
	$.ajax({
		url: "/bhost/get_pwd_export_list",
		type:"POST",
		async:false,
		data:{a0:$("input[name=se]").val(),a4:page_num,a3:paging,a2:search_typeall},
		success:function(result){
			var pwd_export_result = JSON.parse(result);
			if (pwd_export_result.Result){
				var pwd_export_data = pwd_export_result.info;
				pwd_export_json_data=pwd_export_data.data;
				var total_all = pwd_export_data.totalrow;
				fenye_r=parseInt(total_all/MAX_PAGE)+(total_all%MAX_PAGE==0?0:1);
				if(pwd_export_data.data=="" && paging!="1"){
					pwd_export_page(0.9);
				}else{
					total_all_r = total_all;
					if(total_all){
						var id='{'+pwd_export_data.data.map(function (item) {
							return item.HostId;
						}).join(',')+'}'
						$.ajax({
							url: "/bhost/get_pwd_export_list",
							type:"POST",
							async:false,
							data:{a0:$("input[name=se]").val(),a1:id,a5:false},
							success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
									$("#pwd_export_list").empty();
									$("#pwd_export_list").append(result.info.data.map(function (item) {
										if (item.AccountPassword==null) item.AccountNum=0;
										/*
										console.log("<tr>"+
											"<td class=\"in\"><input type=\"checkbox\" id=\"input-"+item.HostId+"\" class=\"input_checkbox\" /></td>"+
											"<td style = \"display:none\">"+item.HostId+"</td>"+
											"<td>"+(item.HostName||'')+"</td>"+
											"<td>"+(item.HostIP||'')+"</td>"+
											"<td>"+(item.AccountNum||'0')+"</td>"+
											"<td><div class=\"tab-ctr\">"+
											((window.parent.document.frm.us.value!='admin' && hostpwd_data.PwdFileApproveNum && hostpwd_data.PwdFileApproveUserSet.length>0 && $.inArray(item.HostIP,ip_str)<0)?"<a href=\"javascript:;\" style=\"background-position: -128px 0;\" class=\"disabled\" title='下载' id=\"\"></a>":"<a href=\"javascript:;\" style=\"background-position: -128px 0;\" class=\"\" title='下载' id=\"download\"></a>")+
											((window.parent.document.frm.us.value!='admin' && hostpwd_data.PwdFileApproveNum && hostpwd_data.PwdFileApproveUserSet.length>0 && $.inArray(item.HostIP,ip_str)<0)?"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -80px 0;\" class=\"disabled\" title='发送' class=\"\" id=\"\"></a>":"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -80px 0;\" title='发送' class=\"\" id=\"send\"></a>")+
											((window.parent.document.frm.us.value!='admin' && hostpwd_data.PwdFileApproveNum && hostpwd_data.PwdFileApproveUserSet.length>0)?($.inArray(item.HostIP,ip_str)<0?"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -128px -17px;\" class=\"\" title='审批' class=\"\" id=\"appr\"></a>":"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -128px -17px;\" title='审批' class=\"disabled\" id=\"\"></a>"):"")+
											"</div></td></tr>");
										*/
										return "<tr>"+
											"<td class=\"in\"><input type=\"checkbox\" id=\"input-"+item.HostId+"\" class=\"input_checkbox\" /></td>"+
											"<td style = \"display:none\">"+item.HostId+"</td>"+
											"<td>"+(item.HostName||'')+"</td>"+
											"<td>"+(item.HostIP||'')+"</td>"+
											"<td>"+(item.AccountNum||'0')+"</td>"+
											"<td><div class=\"tab-ctr\">"+
											((window.parent.document.frm.us.value!='admin' && hostpwd_data.PwdFileApproveNum && hostpwd_data.PwdFileApproveUserSet.length>0 && $.inArray(item.HostIP,ip_str)<0)?"<a href=\"javascript:;\" style=\"background-position: -128px 0;\" class=\"disabled\" title='下载' id=\"\"></a>":"<a href=\"javascript:;\" style=\"background-position: -128px 0;\" class=\"\" title='下载' id=\"download\"></a>")+
											((window.parent.document.frm.us.value!='admin' && hostpwd_data.PwdFileApproveNum && hostpwd_data.PwdFileApproveUserSet.length>0 && $.inArray(item.HostIP,ip_str)<0)?"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -80px 0;\" class=\"disabled\" title='发送' class=\"\" id=\"\"></a>":"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -80px 0;\" title='发送' class=\"\" id=\"send\"></a>")+
											((window.parent.document.frm.us.value!='admin' && hostpwd_data.PwdFileApproveNum && hostpwd_data.PwdFileApproveUserSet.length>0)?($.inArray(item.HostIP,ip_str)<0?"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -128px -17px;\" class=\"\" title='审批' class=\"\" id=\"appr\"></a>":"<a href=\"javascript:;\" style=\"margin-top: 1px;background-position: -128px -17px;\" title='审批' class=\"disabled\" id=\"\"></a>"):"")+
											"</div></td></tr>";
									}));
									tabArr();
									$(".input_checkbox","#pwd_export_list").iCheck({
										checkboxClass: 'icheckbox_minimal-blue',
										radioClass: 'iradio_minimal-blue',
										increaseArea: '0' // optional
									});
								}
							}
						});
						if(paging>=fenye_r){
							paging=fenye_r;
						}
						document.frm_pwd_export.c.value=paging;
						document.getElementById("pwd_export_page").value=paging;
						$("#pwd_export_pages").text(fenye_r);
						$('#check_one_page').iCheck('uncheck');	
						$("#pwd_export_total").text(total_all);
						$("table tbody tr td.in input").iCheck('uncheck');
						check_show();
						check_num=delect_str.length;
						$("span.sum").text(check_num);
					}else{
						$('#check_one_page').iCheck('uncheck');	
						$("span.sum").text(0);
						$("table tbody tr td.in input").iCheck('uncheck');
						$("#pwd_export_list").empty();
						$("#pwd_export_total").text(total_all);
						$("#pwd_export_pages").text(1);
						document.frm_pwd_export.c.value=1;
						fenye_r=1;
						document.getElementById("pwd_export_page").value=1;
					}	
				}
			}else{
				clearInterval(show_list_interval);
				_alert(1,"密码导出",pwd_export_result.ErrMsg);
				$('#check_one_page').iCheck('uncheck');	
				$("table tbody tr").find("input").iCheck('uncheck');
				$("span.sum").text(0);
				$("#pwd_export_total").text(0);
				$("#pwd_export_pages").text(1);
				document.frm_pwd_export.c.value=1;
				fenye_r=1;
				document.getElementById("pwd_export_page").value=1;
				return false;
			}
		}
	});
}
//分页 and 刷新
function pwd_export_page(num){
	var paging=parseInt(document.frm_pwd_export.c.value)+num;
	if(paging==0 || paging==fenye_r+1){
		return false;
	}
	delect_save();
	if (num == 0.1){
		paging = 1;
	}else if(num == 0.9){
		paging=fenye_r;
	}
	$("span.sum").text(0);
	document.getElementById("pwd_export_page").value=paging;
	document.frm_pwd_export.c.value=paging;
	show_pwd_export_list();
}
var pwd_export_array=null;
function update_all_list() {
	var search_typeall=search_typeall_r.join('\t');
    if(search_typeall_new!=''){
        search_typeall+=('\t'+search_typeall_new);
    }
	$.ajax({
		url: "/bhost/get_pwd_export_list",
		type:"POST",
		async:true,
		data:{a0:$("input[name=se]").val(),a2:search_typeall},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				pwd_export_array=result.info.data.map(function (params) {
					return params.HostId+'';
				});
			}
		}
	});
}
var delect_str=new Array();
//全选按钮
function click_all_list(){
	////console.log(pwd_export_array);
	////console.log(delect_str);
	if(pwd_export_array.length==delect_str.length){
		delect_str=new Array();
	}else{
		delect_str=pwd_export_array;
	}
	show_pwd_export_list();
}
function back() {
	document.frm_pwd_export.tasktype.value = 4;
	document.frm_pwd_export.action = '/bhost/index';
	document.frm_pwd_export.submit();
}
function pwd_export() {
	document.frm_pwd_export.action = '/bhost/pwd_export';
	document.frm_pwd_export.tasktype.value = 1;
	document.frm_pwd_export.submit();
}
</script>
</body>
</html>
