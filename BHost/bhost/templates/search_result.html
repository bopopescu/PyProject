{% extends  "index.html" %}
<!-- 继承 html-->
{% block main %}
    <div id="viewWrap" style="visibility: hidden" style="background: white;margin-bottom: 10px">
        <div class="srWrap" style="width: 100%;max-width: 100%">

            <div class="clearfix"></div>
            <div class="srCont">
                <div class="srItem">
                    <div class="label"><span>类型</span></div>
                    <span class="srFix"></span>
                    <div class="c">
                        <select name="" id="logtype" class="srSelect2" onchange="change_type(this);">
							<option id="logtype1" value="NORMAL" selected>操作</option>
							<option id="logtype2" value="SESSION">会话</option>
							<option id="logtype3" value="SYSTEM">系统</option>
						</select>
                    </div>
                </div>
                <!--load area-->
                <div id="srArea">
                </div>
            </div>
        </div>
    </div>
	<div class="c-wrap">
		<div class="c-table">
			<div class="tab-t jsiWrap">
				<div class="js-ss" id="condition">
				</div>
				<a href="javascript:;" class="js-vm" onclick="_jsInfoView(0)" title="二次检索"></a>
				<div id="jsMoreInfo" style="overflow: auto">
					<a href="javascript:;" class="js-vm" onclick="_jsInfoView(1)" style="z-index: 2"></a>
					<!--新加的功能-->

                    <div class="btns" id="div_save" style="position: inherit;box-shadow: none;border: none;display:none;">
                        <a href="javascript:;" class="btn btn-normal s-hide" onclick="_submit()">检&nbsp;&nbsp;索</a>
                        <a href="javascript:;" class="btn btn-normal" onclick="show_condition_info();">重&nbsp;&nbsp;置</a>
                    </div>
					<div class="detail">
					</div>

				</div>
			</div>
			<div class="clearfix"></div>
			<!--
			<div class="tab-vsel">
				<div class="vcc">
					<span class="vbt" onclick="_tabColView(this)">列表展示项</span>
					<div id="tabvList">
						<ul>
							
						</ul>
					</div>
				</div>
			</div>
			<table cellpadding="0" cellspacing="0" id="log_list">
				<thead>
					<tr>
						<th>名称</th>
						<th>入库时间</th>
						<th>编号</th>
						<th>会话标识</th>
						<th>服务器端口</th>
						<th>服务器IP</th>
					</tr>
				</thead>
				<tbody>
					
				</tbody>
			</table>
			<div class="tab-i">
				<div class="il">
					每页显示<span id="page_total">10</span>条 总数<span id = "account_total">0</span>  选中：<span id = "select_total">0</span>
					
				</div>
				<div class="ipage">
					<a href="javascript:;" class="nav2 begin" onclick="firstpage();"><i></i></a>
					<a href="javascript:;" class="nav prev" onclick="prevpage();"><i></i></a>
					<input type="text" value="1" id="curpage" onchange="jumppage();">/<span id = "totalpage">1</span>
					<a href="javascript:;" class="nav next" onclick="nextpage();"><i></i></a>
					<a href="javascript:;" class="nav2 end" onclick="lastpage();"><i></i></a>
				</div>
			</div>
			-->
			
			
            <div class="" id="dataTable">
               
            </div>
			
		</div>
	</div>
	
	<div id="bBtn" style="position: fixed;z-index:5;">	
		{%if from_flag =='search' %}
			<a href="/bhost/search_index?a0={{se}}&t1={{taskid}}" class="btn" style="float: right;" ><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
		{%else%}
			<a href="/bhost/history_task_index?a0={{se}}&t1={{taskid}}&tp1={{task_page}}" class="btn" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
		{%endif%}	
	</div>
	 <!---->
    <div id="forTemp" style="display: none;">
        <div class="label" onclick="_getSubSel(this)">
            <span>入库时间</span><i class="arrCtl"></i>
            <div class="subSel" style="margin-top:37px;margin-left: -20px">
                <ul>
                   
                </ul>
            </div>
        </div>
        
        <div class="srItem">
            <div id="srCont" class="c2"></div>
        </div>
    </div>
    <div class="srItem" id="areaTemp" style="display: none;">
        <div class="label" onclick="_getSubSel(this)">
            <span>入库时间</span><i class="arrCtl"></i>
            <div class="subSel">
                <ul>
					<li data-type="blank_0">请选择</li>
					<li data-type="xtime_00">编号</li>
					<li class="active" data-type="xtime_01">入库时间</li>
					<li data-type="xtime_02">发生时间</li>
					<li data-type="xtime_03">会话标识</li>
					<li data-type="xtime_04">起始时间</li>
					<!--<li data-type="int08_00">日志属性</li>-->
					<li data-type="int08_11">告警处理</li>
					<li data-type="int08_14">告警类型</li>
					<li data-type="int08_15">告警等级</li>
					<li data-type="int16_00">客户端端口</li>
					<li data-type="int16_01">服务器端口</li>
					<li data-type="int32_01">日志类型</li>
					<li data-type="ip_00">发生地址</li>
					<li data-type="ip_01">服务端地址</li>
					<li data-type="ip_02">客户端地址</li>
					<li data-type="int64_15">告警动作</li>
					<li data-type="str32_00">服务器用户</li>
					<li data-type="str32_01">操作</li>
					<li data-type="str32_02">信息</li>
					<li data-type="str32_05">客户端工具</li>
					<li data-type="str32_08">数据库名</li>
					<li data-type="str32_20">运维访问策略</li>
					<li data-type="str32_21">运维操作备注</li>
					<li data-type="str32_22">运维用户帐号</li>
					<li data-type="str32_23">运维用户姓名</li>
					<li data-type="str32_24">审批用户帐号</li>
					<li data-type="str32_25">审批用户姓名</li>
					<li data-type="str32_28">回放文件</li>
					<li data-type="str32_29">策略名称</li>
					<li data-type="str32_30">事件信息</li>
					<li data-type="str32_31">告警对象</li>
				</ul>
            </div>
        </div>
        <span class="srFix"></span>
        <div class="c">
            <div class="srCtrl">
                <div class="a">
                    <a href="javascript:;" onclick="_reloadItem(this)" title="初始化条件"><i class="re"></i></a>
                    <a href="javascript:;" onclick="_delItem(this)" class="disable" title="删除条件"><i class="del"></i></a>
                    <a href="javascript:;" onclick="_addItem(this)" title="添加条件" ><i class="add"  ></i></a>
                </div>
                <a href="javascript:;" class="b1" onclick="_hideCtrl(this);" title="收拢条件" ><i class="vv"></i></a>
                <a href="javascript:;" class="b2" onclick="_showCtrl(this);" onmouseover="_showBtns(this);" title="展开条件" ><i class="vh" ></i></a>
            </div>
        </div>
		
        <div class="c2">

        </div>
    </div>
    <!--number-->
    <div class="srSort" id="srTemp-int" style="display: none;">
        <select name="_action" id="" class="srSelect" style="width: 80px" onchange="srSelType(this,1)">
            <option value="equal">=</option>
            <option value="between">区间</option>
            <option value="high">&gt;</option>
            <option value="ehigh">&gt;=</option>
            <option value="low">&lt;</option>
            <option value="elow">&lt;=</option>
            <option value="not equal">不等于</option>
        </select>
        <input type="text" value="" class="search_input">
        <span class="srTip" style="display: none;">至</span>
        <input type="text" value="" class="search_input" style="display: none;">
        <span class="srsCtl">
            <a href="javascript:;" class="add" title="添加条件" onclick="_itemAdd(this)"></a>
            <a href="javascript:;" class="del" title="删除条件" onclick="_itemDel(this)"></a>
        </span>
    </div>
    <!--time-->
    <div class="srSort" id="srTemp-xtime" style="display: none;">
        <select name="_action" id="" class="srSelect" style="width: 80px" onchange="srSelType(this,2)">
            <option value="between">区间</option>
            <option value="equal">=</option>
            <option value="ehigh">&gt;=</option>
            <option value="elow">&lt;=</option>
        </select>
        <span class="stwrap">
            <input type="text" value="" placeholder="日期" class="datepicker" readonly>
            <input type="text" value="" placeholder="时" class="timeinput" min="00" max="23">
            <span class="srTip">:</span>
            <input type="text" value="" placeholder="分" class="timeinput" min="00" max="59">
            <span class="srTip">:</span>
            <input type="text" value="" placeholder="秒" class="timeinput" min="00" max="59">
        </span>
        <span class="srTip">至</span>
         <span class="stwrap">
            <input type="text" value="" placeholder="日期" class="datepicker" readonly>
            <input type="text" value="" placeholder="时" class="timeinput" min="00" max="23">
            <span class="srTip">:</span>
            <input type="text" value="" placeholder="分" class="timeinput" min="00" max="59">
            <span class="srTip">:</span>
            <input type="text" value="" placeholder="秒" class="timeinput" min="00" max="59">
        </span>
        <span class="srsCtl">
            <a href="javascript:;" class="add" title="添加条件" onclick="_itemAdd(this)"></a>
            <a href="javascript:;" class="del" title="删除条件" onclick="_itemDel(this)"></a>
        </span>
    </div>
    <!--port-->
    <div class="srSort" id="srTemp-port" style="display: none;">
        <select name="_action" id="" class="srSelect" style="width: 80px" onchange="srSelType(this,1)">
            <option value="equal">=</option>
            <option value="between">区间</option>
            <option value="high">&gt;</option>
            <option value="ehigh">&gt;=</option>
            <option value="low">&lt;</option>
            <option value="elow">&lt;=</option>
            <option value="not equal">不等于</option>
        </select>
        <input type="text" value="" style="width: 5em">
        <span class="srTip" style="display: none;">至</span>
        <input type="text" value="" style="width: 5em;display: none;">
        <span class="srsCtl">
            <a href="javascript:;" class="add" title="添加条件" onclick="_itemAdd(this)"></a>
            <a href="javascript:;" class="del" title="删除条件" onclick="_itemDel(this)"></a>
        </span>
    </div>
    <!--select-->
    <div class="srSort" id="srTemp-select" style="display: none;">
        <select name="_action" id="" class="srSelect" style="width: 80px" onchange="srSelType(this,3)">
            <option value="equal">等于</option>
            <option value="not equal">不等于</option>
        </select>
		<!--告警处理-->
        <select style="width:215px; " id="" name="" class="srSelect">
            <option value="-1">无</option>
        </select>
        <span class="srsCtl">
            <a href="javascript:;" class="add" title="添加条件" onclick="_itemAdd(this)"></a>
            <a href="javascript:;" class="del" title="删除条件" onclick="_itemDel(this)"></a>
        </span>
    </div>
    <!--ip-->
    <div class="srSort srSort-ip" id="srTemp-ip" style="display: none;">
        <select name="_action" id="" class="srSelect" style="width: 72px" onchange="srSelType(this,4)">
            <option value="equal">等于</option>
            <option value="between">区间</option>
            <option value="not equal">不等于</option>
            <option value="group">主机组</option>
        </select>
        <!--主机-->
        <select name="_host" id="_host" class="srSelect" style="width: 120px" onchange="srSelType(this,5)">
            <option value="-1">其他</option>
        </select>
        <input name="" class="" type="text" value="" />
        <span class="srTip" style="display: none;">至</span>
        <input name="" class="" type="text" value="" style="display: none;" />
        <!--主机组-->
		<!--
        <select name="_group" id="" class="srSelect" style="width: 120px;">
            <option value="2">xx</option>
        </select>-->
		<div class="forgroup" "group"="" onclick="_getHostGroup(this)"></div>
		
        <span class="srsCtl">
            <a href="javascript:;" class="add" title="添加条件" onclick="_itemAdd(this)"></a>
            <a href="javascript:;" class="del" title="删除条件" onclick="_itemDel(this)"></a>
        </span>
    </div>
    <!--string-->
    <div class="srSort" id="srTemp-str32" style="display: none;">
        <select name="_action" id="" class="srSelect" style="width: 170px" onchange="srSelType(this,6)">
			<option value="include">包含</option>
			<option value="not include">不包含</option>
            <option value="begin">开始</option>
            <option value="end">结束</option>                     
			<option value="regx">正则匹配（忽略大小写）</option>
			<option value="not regx">正则不匹配（忽略大小写）</option>
			<option value="ncregx">正则匹配（区分大小写）</option>
			<option value="not ncregx">正则不匹配（区分大小写）</option>
			<option value="match">通配符</option>
			
        </select>
        <input type="text" value="">
        <span class="srsCtl">
            <a href="javascript:;" class="add" onclick="_itemAdd(this)"></a>
            <a href="javascript:;" class="del" onclick="_itemDel(this)"></a>
        </span>
    </div>
	<!--int64_15-->
    <div class="srSort" id="srTemp-int64_15" style="display: none;">
        <select name="_action" id="" class="srSelect" onchange="srSelType(this,6)">
			<option value="equal">等于</option>
            <option value="not equal">不等于</option>
			<option value="include">包含</option>
			<option value="not include">不包含</option>
        </select>
        <select style="width:150px; " id="" name="" class="srSelect">
        </select>
        <span class="srsCtl">
            <a href="javascript:;" class="add" onclick="_itemAdd(this)"></a>
            <a href="javascript:;" class="del" onclick="_itemDel(this)"></a>
        </span>
    </div>
	<script src="/manage/js/jquery.jedate.min.js"></script>
    <link rel="stylesheet" href="/manage/css/jedate.css">	
	<script src="/manage/js/mmGrid.js"></script>
    <script src="/manage/js/mmPaginator.js"></script>
    <script src="/manage/js/xTable.js"></script>
    <link rel="stylesheet" href="/manage/css/mmGrid.css">
	<script src="/manage/js/Sortable.js"></script>
	
	<form name="frm" method="post" action=''>
		<input name="session" id = "session" value="{{se}}" type="hidden">
		<input name="session" id = "taskid" value="{{taskid}}" type="hidden">	
		<input name="session" id = "current_page" value="{{current_page}}" type="hidden">	
		<!--操作-->
		<input name="service_1" id="service_1" value="{{service_1}}"  type="hidden">
		<!--会话-->
		<input name="service_2" id="service_2" value="{{service_2}}"  type="hidden">
		<!--系统-->
		<input name="service_3" id="service_3" value="{{service_3}}" type="hidden">
		
	</form>
	<!-- location.href="/bhost/search_log?a0={{se}}&f1={{from_flag}}&t1="+taskid+"&a1="+xtime_00+"&a2="+logtype+"&i1="+index+"&p1="+page+'&tp1='+{{task_page}}-->
	<form name="frm_search" method="post" action='/bhost/search_log'>
		<!--session-->
		<input name="a0" id = "" 	value="{{se}}" 		type="hidden">
		<input name="f1" id = "" 	value="{{from_flag}}" 	type="hidden">	
		<input name="t1" id = ""	value="{{taskid}}" 	type="hidden">	
		<!--task_page-->
		<input name="tp1" id=""	value="{{task_page}}" 	type="hidden">
		<!--logtype-->
		<input name="a2" id="" 	value="" 	 type="hidden">
		<!--xtime_00 -->
		<input name="a1" id="" 	value=""  type="hidden">
		<!--index-->
		<input name="i1" id="" 	value="" type="hidden">
		<!--page-->
		<input name="p1" id="" 	value=""  type="hidden">
		<input name="v1" id=""  value="1"  type="hidden">	
		
	</form>
	<form action="/bhost/analysis_index" method="get" name="frm_analysis">
			<input type="hidden" name="a0"  value="{{se}}" />
			<input type="hidden" name="s1"  value="" />
			<input type="hidden" name="st"  value="" />
			<input type="hidden" name="et"  value="" />
			<input type="hidden" name="stat"  value="" />
			<input type="hidden" name="tp"  value="" />
			<input type="hidden" name="su"  value="" />
			<input type="hidden" name="si"  value="" />
			<input type="hidden" name="lo"  value="" />
			<input type="hidden" name="yu"  value="" />
			<input type="hidden" name="ot"  value="" />
	</form>
	<form action="/bhost/playback_index" method="get" name="frm_playback">
                        <input type="hidden" name="a0"  value="{{se}}" />
                        <input type="hidden" name="s1"  value="" />
                        <input type="hidden" name="st"  value="" />
                        <input type="hidden" name="et"  value="" />
                        <input type="hidden" name="stat"  value="" />
                        <input type="hidden" name="tp"  value="" />
                        <input type="hidden" name="su"  value="" />
                        <input type="hidden" name="si"  value="" />
                        <input type="hidden" name="lo"  value="" />
						
						
	 </form>
{% endblock  %}

<!-- 继承 js-->
{% block script %}
<style>
.layui-layer-setwin .layui-layer-close1{
		background-position:0;
	}
.layui-layer-ico{
		background: url(/manage/images/icon_close.png) no-repeat 0 0;
	}
	.tab-ctr a.m_ses_icon2 {
	display: inline-block;
	float: left;
	width: 16px;
	height: 20px;
	overflow: hidden;
	background: url(/manage/images/m_ses_icon.png) -16px 0px no-repeat;
	margin: -1px 4px 0 4px;
}
.tab-ctr a.m_ses_icon3 {
	display: inline-block;
	float: left;
	width: 16px;
	height: 20px;
	overflow: hidden;
	background: url(/manage/images/m_ses_icon.png) -32px 0px no-repeat;
	margin: -1px 4px 0 4px;
}
.tab-ctr a.m_ses_icon1 {
	display: inline-block;
	float: left;
	width: 16px;
	height: 20px;
	overflow: hidden;
	background: url(/manage/images/m_ses_icon.png) 0px 0px no-repeat;
	margin: -1px 4px 0 4px;
}
.tab-ctr a.m_ses_icon4 {
	display: inline-block;
	float: left;
	width: 16px;
	height: 20px;
	overflow: hidden;
	background: url(/manage/images/m_ses_icon.png) -48px 0px no-repeat;
	margin: -1px 4px 0 4px;
}
.tab-ctr a.m_ses_icon5 {
	display: inline-block;
	float: left;
	width: 16px;
	height: 20px;
	overflow: hidden;
	background: url(/manage/images/m_ses_icon.png) -64px 0px no-repeat;
	margin: -1px 4px 0 4px;
}
.tab-ctr a.m_ses_icon6 {
	display: inline-block;
	float: left;
	width: 16px;
	height: 20px;
	overflow: hidden;
	background: url(/manage/images/m_ses_icon6.png) no-repeat 0 0;
	margin: -1px 4px 0 4px;
}
.xTable-body tr:hover .tab-ctr {
    position: absolute;
    display: block;
    padding: 13px;
    background-color: #63c3d9;
}
.subSel{
	max-height: 196px;
}
</style>
<script>
	var if_disable = $('#nav-s1 li[data-modeid=2]',parent.parent.parent.document).attr('_if_disable');
	if_disable_list = if_disable.split('-');
	// 三权分立 8->运维操作(操作、会话) 9->运维管理(系统日志-运维部分) 11->系统日志(系统日志-非运维用户部分)
	/*
	if(if_disable_list[0] == '2' && (if_disable_list[1] == '2' || if_disable_list[2] == '2')){
		//$('#div_save').show();
		//$('.s-hide').remove();
	}else if (if_disable_list[0] == '1' && (if_disable_list[1] == '2' || if_disable_list[2] == '2')){
		//$('#div_save').show();
		$('#logtype1').remove();
		$('#logtype2').remove();
	}else if (if_disable_list[0] == '2' && (if_disable_list[1] == '1' && if_disable_list[2] == '1')){
		//$('#div_save').show();
		$('#logtype3').remove();
	}else if (if_disable_list[0] == '1' && (if_disable_list[1] == '1' && if_disable_list[2] == '1')){
		//$('#div_save').show();
		$('.s-hide').remove();
	}*/
	
	/*if(if_disable == '1'){
		$('.s-hide').remove();
	}*/
	var from_flag= '{{from_flag}}';
	var taskid={{taskid}};
	var action_list ={'between':'区间','equal':'等于','not equal':'不等于','high':'大于','ehigh':'大于等于','low':'小于','elow':'小于等于','begin':'开始','end':'结束','include':'包含','not include':'不包含','group':'主机组','regx':'正则匹配','match':'通配符','not regx':'正则不匹配','ncregx':'正则匹配（忽略大小写）','not ncregx':'正则不匹配（区分大小写）'};
	var logtype = 'NORMAL';
	var show_field = "";
	var display_field_list = [];
	var field_list = [];
	var condition_json=[];
	var field_list_show = [];
	var _btn=[];
	var btn_ses = [
		{
			class:'m_ses_icon2',
			title:'回放',
			cb: function(data){
				if(data['IfReplay'] == true){
					MapPort = '8080';
					$.ajax({
						url: "/bhost/get_MapPort",
						type:"POST",
						async:false,		
						data:{a0:{{se}}},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								MapPort = result.info;
							}else{
								_alert(1,"数据检索",result.ErrMsg);
							}
						}
					})
					var sesstimet = (new Date()).valueOf();
					cmd_json ={
						"Cmd":"",
						"Protocol":data['int32_01']==null?"":data['int32_01'],
						"ReplayPath":data['str32_28']==null?"":data['str32_28'],
						"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
						"ClientIp":data['ip_02']==null?"":data['ip_02'],
						"ServerIp":data['ip_01']==null?"":data['ip_01'],
						"StartTime":data['xtime_04']==null?"":((new Date(data['xtime_04']).valueOf())/1000),
						"File":"pm02qgAra6HxipYvGc8czCBbrk8dM7NQ385dwKqhuor8cz9lAUMIeJfYQ+skvL6J3g==",//SlasEncode 加密？？？
						"Sessid":data['xtime_03'],
						"Usercode":data['str32_22']==null?"":data['str32_22'],
						"Username":data['str32_23']==null?"":data['str32_23'],
						"IfReplay":true,
						"IfReplayDrawing":data['IfReplayDrawing'],
						"MapPort":MapPort,
						"sesstimet":sesstimet,
						"sess":'{{se}}'
					}
					var if_html_client = false;
					var base64_str = '';
					$.ajax({
						url: "/bhost/get_base64",
						type:"POST",
						async:false,		
						data:{a0:{{se}},z1:JSON.stringify(cmd_json)},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								if_html_client = result.info;
								base64_str = result.b64;
							}else{
								_alert(1,"数据检索",result.ErrMsg);
							}
						}
					})
					if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+{{se}}+'&z1='+JSON.stringify(cmd_json));
					else{
						//window.location.href = 'bhost://cmd&'+base64_str;
						get_regedit('bhost', {{se}},'',sesstimet);
						$('#YuFrame1').remove();
						$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
						$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
					}
					
				
					return false;
				}
				//alert(data.id);
				/*
		  		xtime_03 会话标志
		  		xtime_04 起始时间
		  		xtime_05 结束时间
		  		int08_03 会话状态
		  		int32_01 日志类型
		  		str32_00 服务器用户
		  		ip_01    服务端地址
				*/
        			sessid = data['xtime_03'];//会话标志
        			stime = data['xtime_04']==null?"":data['xtime_04'];
        			etime = data['xtime_05']==null?"":data['xtime_05'];
        			s =data['int08_03'] ;
        			if(s == '连接中') statue = 0;
        			else if (s == '异常退出') statue = 2;
        			else statue = 1;
                                
        			typ = data['int32_01'] ;//proto
        			server_user = data['str32_00']==null?"":data['str32_00'];
        			server_ip = data['ip_01']==null?"":data['ip_01'];  
        			$('form[name=frm_playback]').attr('target','_blank');
        			$('form[name=frm_playback]').attr('method','get');
					
        			document.frm_playback.s1.value = sessid;
        			document.frm_playback.st.value = stime.replace('T','  ').replace('+08:00','');;
        			document.frm_playback.et.value = etime.replace('T','  ').replace('+08:00','');;
        			document.frm_playback.stat.value = statue;
        			document.frm_playback.tp.value = typ;
        			document.frm_playback.su.value = server_user;
        			document.frm_playback.si.value = server_ip;
        			if (logtype == 'NORMAL') lo = 1;
        			else if(logtype == 'SESSION') lo = 2;
        			else lo = 3;
        			document.frm_playback.lo.value = lo;
        			document.frm_playback.submit();
       				//console.log(data);
    			}
		},{
			class:'m_ses_icon3',
			title:'下载',
			cb: function(data){
				//console.log(data);
				download_file(data);
			}
		},
		{
			class:'m_ses_icon1',
			title:'指令查看',
			cb: function(data){
				sessid = data['xtime_03'];//会话标志
				stime = data['xtime_04']==null?"":data['xtime_04'];
				etime = data['xtime_05']==null?"":data['xtime_05'];
				s =data['int08_03'] ;
				if(s == '连接中') statue = 0;
				else if (s == '异常退出') statue = 2;
				else statue = 1;
				IfReplay = data['IfReplay'];//ir
                                IfReplayDrawing = data['IfReplayDrawing'];//ird
                                document.frm_analysis.ot.value = IfReplay+"@"+IfReplayDrawing;	
				typ = data['int32_01'] ;//proto
				server_user = data['str32_00']==null?"":data['str32_00'];
				y_user = data['str32_22']==null?"":data['str32_22'];
				server_ip =data['ip_01']==null?"":data['ip_01'];  
				$('form[name=frm_analysis]').attr('target','_blank');
				$('form[name=frm_analysis]').attr('method','get');
				
				document.frm_analysis.s1.value = sessid;
				document.frm_analysis.st.value = stime.replace('T',' ').replace('+08:00','');;
				document.frm_analysis.et.value = etime.replace('T',' ').replace('+08:00','');;
				document.frm_analysis.stat.value = statue;
				document.frm_analysis.tp.value = typ;
				document.frm_analysis.su.value = server_user;
				document.frm_analysis.si.value = server_ip;
				document.frm_analysis.yu.value = y_user;
				if (logtype == 'NORMAL') lo = 1;
				else if(logtype == 'SESSION') lo = 2;
				else lo = 3;
				document.frm_analysis.lo.value = lo;	
				document.frm_analysis.submit();
				//console.log(data);
			}
		},{
		class:'msg1',
		title:'确认',
		cb: function(data,obj){
			//console.log($(obj));
			MarkWMsg(data.xtime_00,2,obj);
		}
	}
		/*
		{
			class:'m_ses_icon4',
			title:'指令导出',
			cb: function(data){
				//console.log(data);
			}
		}*/
	];
	var btn_ops = [
	/*
			document.frm_analysis.s1.value = sessid;
			document.frm_analysis.st.value = stime;
			document.frm_analysis.et.value = etime;
			document.frm_analysis.stat.value = statue;
			document.frm_analysis.tp.value = type;
			document.frm_analysis.su.value = server_user;
			document.frm_analysis.si.value = server_ip;
			document.frm_analysis.submit();
	*/
	{
    		class:'m_ses_icon2',
    		title:'回放',
    		cb: function(data){
        		//alert(data.id);
			/*
		 	xtime_03 会话标志
		  	xtime_04 起始时间
		  	xtime_05 结束时间
		  	int08_03 会话状态
		  	int32_01 日志类型
		  	str32_00 服务器用户
		  	ip_01    服务端地址
			*/
				if(data['IfReplay'] == true){
					MapPort = '8080';
					$.ajax({
						url: "/bhost/get_MapPort",
						type:"POST",
						async:false,		
						data:{a0:{{se}}},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								MapPort = result.info;
							}else{
								_alert(1,"数据检索",result.ErrMsg);
							}
						}
					})
					var sesstimet = (new Date()).valueOf();
					cmd_json ={
						"Cmd":"",
						"Protocol":data['int32_01']==null?"":data['int32_01'],
						"ReplayPath":data['str32_28']==null?"":data['str32_28'],
						"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
						"ClientIp":data['ip_02']==null?"":data['ip_02'],
						"ServerIp":data['ip_01']==null?"":data['ip_01'],
						"StartTime":data['xtime_04']==null?"":((new Date(data['xtime_04']).valueOf())/1000),
						"File":"pm02qgAra6HxipYvGc8czCBbrk8dM7NQ385dwKqhuor8cz9lAUMIeJfYQ+skvL6J3g==",//SlasEncode 加密？？？
						"Sessid":data['xtime_03'],
						"Usercode":data['str32_22']==null?"":data['str32_22'],
						"Username":data['str32_23']==null?"":data['str32_23'],
						"IfReplay":true,
						"IfReplayDrawing":data['IfReplayDrawing'],
						"MapPort":MapPort,
						"sesstimet":sesstimet,
						"sess":'{{se}}'
					}
				
					var if_html_client = false;
					var base64_str = '';
					$.ajax({
						url: "/bhost/get_base64",
						type:"POST",
						async:false,		
						data:{a0:{{se}},z1:JSON.stringify(cmd_json)},
						success:function(result){
							var result=JSON.parse(result);
							if(result.Result){
								if_html_client = result.info;
								base64_str = result.b64;
							}else{
								_alert(1,"数据检索",result.ErrMsg);
							}
						}
					})
					if(if_html_client) window.open('https://'+document.domain+'/bhost/test_html?se='+{{se}}+'&z1='+JSON.stringify(cmd_json));
					else{
						//window.location.href = 'bhost://cmd&'+base64_str;
						get_regedit('bhost', {{se}},'',sesstimet);
						$('#YuFrame1').remove();
						$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
						$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
					}
					
				
					return false;
				}
        		sessid = data['xtime_03'];
        		stime = data['xtime_04']==null?"":data['xtime_04'];
        		etime = data['xtime_05']==null?"":data['xtime_05'];
        		s =data['int08_03'] ;
        		if(s == '连接中') statue = 0;
        		else if (s == '异常退出') statue = 2;
        		else statue = 1;
                                
        		typ = data['int32_01'] ;
        		server_user = data['str32_00']==null?"":data['str32_00'];
        		server_ip = data['ip_01']==null?"":data['ip_01'];  
        		$('form[name=frm_playback]').attr('target','_blank');
        		$('form[name=frm_playback]').attr('method','get');
        		document.frm_playback.s1.value = sessid;
        		document.frm_playback.st.value = stime.replace('T','  ').replace('+08:00','');;
        		document.frm_playback.et.value = etime.replace('T','  ').replace('+08:00','');;
        		document.frm_playback.stat.value = statue;
        		document.frm_playback.tp.value = typ;
        		document.frm_playback.su.value = server_user;
        		document.frm_playback.si.value = server_ip;
        		if (logtype == 'NORMAL') lo = 1;
        		else if(logtype == 'SESSION') lo = 2;
        		else lo = 3;
        		document.frm_playback.lo.value = lo;
        		document.frm_playback.submit();
        		//console.log(data);
		}
	},{
			class:'m_ses_icon5',
			title:'关联分析',
			cb: function(data){
				//alert(data.id);
				sessid = data['xtime_03'];
				stime = data['xtime_04']==null?"":data['xtime_04'];
				etime = data['xtime_05']==null?"":data['xtime_05'];
				s =data['int08_03'] ;
				if(s == '连接中') statue = 0;
				else if (s == '异常退出') statue = 2;
				else statue = 1;
				
				typ = data['int32_01'] ;
				server_user = data['str32_00']==null?"":data['str32_00'];
				y_user = data['str32_22']==null?"":data['str32_22'];
				server_ip =data['ip_01']==null?"":data['ip_01'];  
				$('form[name=frm_analysis]').attr('target','_blank');
				$('form[name=frm_analysis]').attr('method','get');
				
				//
				IfReplay = data['IfReplay'];//ir
				IfReplayDrawing = data['IfReplayDrawing'];//ird			
				document.frm_analysis.ot.value = IfReplay+"@"+IfReplayDrawing;
				
				document.frm_analysis.s1.value = sessid;
				document.frm_analysis.st.value = stime.replace('T','  ').replace('+08:00','');;
				document.frm_analysis.et.value = etime.replace('T','  ').replace('+08:00','');;
				document.frm_analysis.stat.value = statue;
				document.frm_analysis.tp.value = typ;
				document.frm_analysis.su.value = server_user;
				document.frm_analysis.si.value = server_ip;
				document.frm_analysis.yu.value = y_user;
				if (logtype == 'NORMAL') lo = 1;
				else if(logtype == 'SESSION') lo = 2;
				else lo = 3;
				document.frm_analysis.lo.value = lo;
				document.frm_analysis.submit();
				//console.log(data);
			}
		}/*,
		{
			class:'m_ses_icon4',
			title:'关联导出',
			cb: function(data){
				//console.log(data);
			}
		}*/,{
			class:'m_ses_icon3',
			title:'下载',
			cb: function(data){
				//console.log(data);
				download_file(data);
			}
		},{
			class:'m_ses_icon6',
			title:'删除',
			cb: function(data){
				delete_file(data);
			}
		},{
			class:'msg1',
			title:'确认',
			cb: function(data,obj){
				//console.log($(obj));
				MarkWMsg(data.xtime_00,1,obj);
			}
		}
	];
	btn_sys = [
			{
					class:'msg1',
					title:'确认',
					cb: function(data,obj){
							MarkWMsg(data.xtime_00,3,obj);
					}
			}
	];
	$(function() {
		document.onkeydown = function() {
			if (event.keyCode == 9) {  //如果是其它键，换上相应在ascii 码即可。
				return false; //非常重要
			}
		}	
		//
		 $('.srSelect2').select2({ minimumResultsForSearch: -1 });
		  _initArea();

		_getDate('#srTemp-time');

		// var bh = $(window).height();
		// $('#viewWrap').height(bh - 300);
		//console.log($("#viewWrap").height());
		
		if(from_flag == 'search') $('#bBtn',parent.parent.document).hide();
		else  $('#bBtn',parent.document).hide();
		//获取条件
		$.ajax({
			url:'/bhost/search_task_condition',
			type:'post',
			async:true,
			data:{a0:{{se}},t1:taskid},
			success:function(result){
				result = JSON.parse(result); 
				if(result.Result == true){
					condition_json = result.info;
					//回显条件
					show_condition(condition_json);
					return false;
				}else{
					_alert(1,'检索',result.ErrMsg);
				}
			}
		})
		$("input.search_input").bind('keydown', function(e){
			DigitInput(e);
		});
	})
	function get_name(id,type){
		var name = "";
		//console.log('get_name')
		$.ajax({
			url:'/bhost/get_host_name',
			type:'post',
			async:false,
			data:{a0:{{se}},g1:id,t1:type}, //0 主机组 1 主机  2 协议
			success:function(result){
				result = JSON.parse(result); 
				if(result.Result == true){
					name = result.info;				
				}
			}
		})
		return name;
	}
	function down(x, y) {
		if(parseInt(x.Order) > parseInt(y.Order)){
			return 1;
		}else{
			return -1;
		}
	}
	function get_displaylogfield(){
		//获取 显示得日志 字段
		display_field_list = [];
		show_field = "";
		$.ajax({
			url:'/bhost/get_displaylogfield',
			type:'post',
			async:false,
			data:{a0:{{se}},o1:logtype},
			success:function(result){
				display_field_list = JSON.parse(result);
				display_field_list.sort(down);
				$(display_field_list).each(function(i,item){
					show_field = show_field + item.Content + ',';
				})
				show_field = show_field.substring(0,show_field.length-1);
				
			}
		})
		return display_field_list;
	}
	function  show_condition(condition_json){
		
		logtype = condition_json.type;
		
		// 三权分立 8->运维操作(操作、会话) 9->运维管理(系统日志-运维部分) 11->系统日志(系统日志-非运维用户部分)
		if(if_disable_list[0] != '0' && (if_disable_list[1] != '0' || if_disable_list[2] != '0')){
				$('#div_save').show();
				//$('.s-hide').remove();
		}else if (if_disable_list[0] == '0' && (if_disable_list[1] != '0' || if_disable_list[2] != '0')){
			$('#div_save').show();
			//$('#logtype').empty('<option id="logtype1" value="NORMAL">操作</option><option id="logtype2" value="SESSION">会话</option><option id="logtype3" value="SYSTEM">系统</option>');
			
			if(logtype == 'NORMAL'){
				$('#logtype').empty().append('<option id="logtype1" value="NORMAL">操作</option><option id="logtype3" value="SYSTEM">系统</option>');
			}else if(logtype == 'SESSION'){
				$('#logtype').empty().append('<option id="logtype2" value="SESSION">会话</option><option id="logtype3" value="SYSTEM">系统</option>');
			}else{
				$('#logtype').empty().append('<option id="logtype3" value="SYSTEM">系统</option>');
			}
			//$('#logtype1').remove();
			//$('#logtype2').remove();
		}else if (if_disable_list[0] != '0' && (if_disable_list[1] == '0' && if_disable_list[2] == '0')){
			$('#div_save').show();
			if(logtype == 'SYSTEM'){
				$('#logtype').empty().append('<option id="logtype1" value="NORMAL">操作</option><option id="logtype2" value="SESSION">会话</option><option id="logtype3" value="SYSTEM">系统</option>');
			}else{
				$('#logtype').empty().append('<option id="logtype1" value="NORMAL">操作</option><option id="logtype2" value="SESSION">会话</option>');
			}
			//$('#logtype3').remove();
		}
		$('#logtype').select2('destroy').select2({ minimumResultsForSearch: -1 });
		
		/*
		if(logtype == 'NORMAL' || logtype == 'SESSION'){
			if(if_disable_list[0] == '2') $('.s-hide').show();
			else  $('.s-hide').hide();
		}else{
			if(if_disable_list[1] == '2' || if_disable_list[2] == '2') $('.s-hide').show();
			else  $('.s-hide').hide();
		}*/
		
		//获取所有的字段
		/*
		[{"Content": "xtime_00","Translation": "编号"}]*/
		field_list = [];
		field_list_show = [];
		$.ajax({
			url:'/bhost/get_logfield',
			type:'post',
			async:false,
			data:{a0:{{se}},o1:logtype},
			success:function(result){
				field_list_show = JSON.parse(result);
				$(field_list_show).each(function(i,item){
					field_list[item.Content] = item.Translation;
				})
			}
		})
		if(logtype == 'NORMAL') logtype_str ="操作";
		if(logtype == 'SESSION') logtype_str ="会话";
		if(logtype == 'SYSTEM') logtype_str ="系统";
		var bh=$(window).height();
		var $viewWrap=$("#viewWrap");
		var $btns=$(".btns");
		
		$viewWrap.css({"background":"white","min-height":"450px","max-height":bh-220,"margin-bottom":"30px"});
		$('#condition').empty().append('<span>日志属性：'+logtype_str+'</span>');
		$('#jsMoreInfo').empty().append('<a href="javascript:;" class="js-vm" onclick="_jsInfoView(1)" style="z-index: 2"></a>');
		$('#jsMoreInfo').append($viewWrap);
		$("#jsMoreInfo").append($btns);
		
		$(condition_json.data).each(function(i,item){
			simple_tmp = "<span>" +field_list[item.operate] + "：";
			div_item = '<div class="item"><div class="label">'+field_list[item.operate]+'：</div><div class="c">'
			var s = "",d="";
			$(item.condition).each(function(i1,item1){
				value = item1.value;
				//console.log(value);
				//console.log(item.operate);
				if(item.operate=="int32_01") {
					if (logtype == 'SYSTEM'){ 
						if(value == 1) value = '用户操作';
						else if(value == 2) value='系统管理'
					}
					else value = get_name(item1.value,2);
				}
				if(item.operate.indexOf('ip')>=0 && item1.action == "group") value = get_name(item1.value,0);
				if(item.operate.indexOf('ip')>=0 && item1.action != "group") {
					value = get_name(item1.value,1);
					if(value != "")  value = value +"("+item1.value+")";
					
				}
				s = s + action_list[item1.action] + " " + value + "  ";
				d = d + '<div class="citem">'+action_list[item1.action]+' '+value+'</div>'
			})
			simple_tmp = simple_tmp + s + "</span>";
			div_item = div_item + d  + '</div></div>'
			$('#condition').append(simple_tmp);
			//$('#jsMoreInfo div.detail').append(div_item);			
		})
		display_field_list = get_displaylogfield();
		
		$('#tabvList ul').empty();
		
		$(field_list_show).each(function(i,item){
			$('#tabvList ul').append('<li><input type="checkbox" name="'+item.Content+'" id="" class="form-checkbox" >'+item.Translation+'</li>');
		})
		/*
		$('#log_list thead>tr').empty();
		_tabvList_ul = $('#tabvList ul');
		$(display_field_list).each(function(i,item){
			
			$('input[name='+item+']',_tabvList_ul).prop('checked',true);
			if(i<=5) $('#log_list thead>tr').append('<th style="width: 20%;">'+field_list[item]+'</th>');
			else if(i<=10) $('#log_list thead>tr').append('<th >'+field_list[item]+'</th>');
		})*/
		$('.form-checkbox,.form-radio').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
			radioClass: 'iradio_minimal-blue',
			increaseArea: '0' // optional
		});
		
		//###绑定 可变条件下拉
		$('#forTemp>div.label>div.subSel>ul').empty();
		var fieldlist = [];
		if(logtype == "NORMAL"){ //操作 
			fieldlist = $('#service_1').val().split(';');
		}else if(logtype == "SESSION"){
			fieldlist = $('#service_2').val().split(';');
		}else if(logtype == "SYSTEM"){
			fieldlist = $('#service_3').val().split(';');
		}
		$(fieldlist).each(function(i,item){
			tmp = item.split(',');
			if(tmp[0] == 'int08_00') return true;
			$('#forTemp>div.label>div.subSel>ul').append("<li data-type=\""+tmp[0]+"\" >"+tmp[1]+"</li>");
		})
		//获取 日志 列表
		//get_log_list();
		dataTable();
		
	}
	var Status = 0;
	function get_totalrow(){	
		function do2(){
			$.ajax({
				url:'/bhost/get_totalrow',
				type:'post',
				async:true,
				data:{a0:{{se}},t1:taskid},
				success:function(result){
					result = JSON.parse(result);
					if(result.Result){
						totalrow = result.Count;
						Status = result.Status;
						//页码计算
						var data_page = {
							"page": $('li.jump input').val(),
							 "totalCount": totalrow
						}

						xtable._initPage(data_page,'page');
						
					}else{
						_alert(1,'检索结果',result.ErrMsg);
					}
				}
			})
		}
		var if_ok = setInterval(function(){
			////console.log(index);
			if (Status > 1){    //获取信息结束
				clearInterval(if_ok);
				return false;
			}
			do2();	
			//if($("#dataTable tbody>tr").length <10 ) {/*dataTable();*/}
		},2000);
	}
	
	/// 1207 修改
	$(document).on('keydown','input.timeinput',function(){
        var i = $(this).index();        
        var v = $(this).val();
        v = v.replace(/[^\d]/g,'');
        $(this).val(v);
    }).on('keyup','input.timeinput',function(e){
        var i = $(this).index();
        var v = $(this).val();    
        var max = 23;
        if(i>1){
            max = 59;
        }

        if(v > max){
            v = max;
        }

        $(this).val(v);

        v = v.toString();
        if(v.length >= 2){
            $(this).val(v.substring(0,2));

            var keycode = e.keyCode;
            if(keycode != 9){
                $(this).next().next().focus();
            }
        }
    }).on('focus','input.timeinput',function(){
        $(this).select();
    }).on('blur','input.timeinput',function(){
        var v = $(this).val();
        v = v.toString();

        if(v == ''){
            v = '00';
        }else if(v.length == 1){
            v = '0' + v;
        }

        $(this).val(v);
    });
	function ChangeLogFieldStatus(obj){
		if(logtype == 'NORMAL') logtype_i =1;
		if(logtype == 'SESSION') logtype_i =2;
		if(logtype == 'SYSTEM') logtype_i =3;
		
		field_json = 
			{
				"logtype": logtype_i,    //日志类型，1-操作，2-会话，3-系统
				"logfieldset":[
					
				]
			};
		logfieldset = [];
		$(obj).each(function(i,item){
			if(item.hide == false) fStatus = 0;
			else fStatus = 1;
			////console.log(item.field_id);
			logfieldset.push(JSON.parse('{"LogFieldId":'+item.field_id+',"Order":'+(i+1)+',"Status":'+fStatus+'}'));
		})
		field_json.logfieldset = logfieldset;
		msstr = aceg(JSON.stringify(field_json),window.parent.document.frm.se.value);
		$.ajax({
			url:'/bhost/ChangeLogFieldStatus',
			type:'post',
			async:true,
			data:{a0:{{se}},s1:JSON.stringify(field_json),m1:msstr},
			success:function(result){
				
			}
		})
	}
    var xtable;
	function dataTable() {
		if(logtype == 'SESSION'){
			_btn = btn_ses;
			//logtype = 'SESSION';
		}else if(logtype == 'NORMAL'){
			_btn = btn_ops;		
			//logtype = 'NORMAL';
		}else if(logtype == 'SYSTEM'){
			_btn = btn_sys;		
			//logtype = 'NORMAL';
		}
		var cols = [];
		if(display_field_list.length > 0 ){
			$(display_field_list).each(function(i,item){
				if(item.Translation == '日志属性') return true;
				var width_value=200;
				if(item.Translation.indexOf('时间')>=0){
				width_value=140;
			}
			else if(item.Translation.indexOf('地址')>=0){
				width_value=110;
			}
			else if(item.Translation=='日志类型' || item.Translation=='是否告警' || 
			item.Translation=='编号' || item.Translation=='会话状态' || 
			item.Translation=='告警类型' || item.Translation=='告警等级' ||
			item.Translation=='操作个数' || item.Translation=='告警处理' || item.Translation=='告警动作'){
					width_value=100;
				}
				else if(item.Translation=='会话标识'){
					width_value=160;
				}
				else if(item.Translation=='客户端端口' || item.Translation=='服务器端口'){
					width_value=70;
				}
				else if(item.Translation=='文件大小'){
					width_value=70;
				}
				if(item.Status == 0) 
					cols.push(JSON.parse('{ "title": "'+item.Translation+'", "name": "'+item.Content+'","field_id":"'+item.LogFieldId+'" ,"width": '+width_value+', "align": "center" }'));
				else 
					cols.push(JSON.parse('{ "title": "'+item.Translation+'", "name": "'+item.Content+'", "field_id":"'+item.LogFieldId+'","width": '+width_value+', "align": "center","hide": true}'));
			})	
		}
		//cols.push(JSON.parse(' { "title": "","name":"1111","infoDiv": false}'));
		//hide: true/*默认隐藏*/
		//lock: true/*锁定*/
		//infoDiv: true/*信息层*/
		/*
        var cols = [
            { title: '入库时间', name: 'startTime', width: 160, align: 'center' },
            { title: '发生时间', name: 'endTime', width: 160, align: 'center' },
            { title: '子类型', name: 'type', width: 120, align: 'center' },
            { title: '会话标识', name: 'status', width: 60, align: 'center' },
            { title: '运维用户账号', name: 'user', width: 120, align: 'center' },
            { title: '运维用户姓名', name: 'username', width: 600, align: 'center',hide: true },
            { title: '服务端IP', name: 'ip', width: 200, align: 'center' },
            { title: '审批用户姓名', name: 'suser', width: 120, align: 'center' },
            { title: '服务器用户名', name: 'husername', width: 120, align: 'center', lock: true},
            { title: '',name:'moreInfo',infoDiv: true}
        ];*/
		//ipage = $("#curpage").val(); //页数
		//ipage = 1;
		
          xtable = $('#dataTable').xTable({
            cols: cols,
			url: '/bhost/get_log_list_mm?a0={{se}}&t1='+MAX_PAGE+'&t2=1&t3='+taskid+'&t4='+logtype+'&t5='+show_field,
            method: 'get',
            data: {page:$('#current_page').val(),limit:10},
            select: true,//显示筛选
            infoDiv: false,/*  信息浮层 */
            btns:_btn,
            dblclick: function(data,items){//双击
				//console.log(data);
				//console.log(items);
				page = $('li.jump input').val();
				xtime_00 = data.xtime_00;
				index = "";
				$(items).each(function(i,trm){
					index = index + trm.xtime_00 +",";
				
				})
				index = index.substring(0,index.length-1);
				//location.href="/bhost/search_log?a0={{se}}&f1={{from_flag}}&t1="+taskid+"&a1="+xtime_00+"&a2="+logtype+"&i1="+index+"&p1="+page+'&tp1='+{{task_page}};
				document.frm_search.a1.value=xtime_00;
				document.frm_search.a2.value=logtype;
				document.frm_search.i1.value=index;
				document.frm_search.p1.value=page;
				document.frm_search.submit();
				
            },
            success: function(){//加载完成
				get_totalrow();
			}
        })
    }
</script>
<script>
    $(function() {
		_initSize();
		_initData();
    })

    $(window).resize(function(){
        _initSize();
    });

    function _initSize(){
        var h = $(window).height();
        $('.c-wrap').height(h - 28).css('overflow','auto');
    }

    function _jsInfoView(i) {
        if (i == 0) {
            $('#jsMoreInfo').slideDown(400);
            $("#viewWrap").css("visibility","visible");
			show_condition_info();
			
        } else if (i == 1) {
            $('#jsMoreInfo').slideUp(400);
        }
    }
	function show_condition_info(){
		$('#srArea').empty();
		_initArea();
		/*
		{"Result":true,
		"info":{
				"type":NORMAL,
				"data":[
					{"operate":xtime_01,"condition":[{"action":between,"value":"2017-10-11 00:00:00;2017-10-11 23:59:59"}]},
					{"operate":int16_01,"condition":[{"action":high,"value":"21"}]},
					{"operate":str32_22,"condition":[{"action":begin,"value":"yt"}]},
					{"operate":ip_00,"condition":[{"action":equal,"value":"3.3.3.3"}]},
					{"operate":ip_01,"condition":[{"action":equal,"value":"192.168.0.46"}]}
				]
			}

		}
		*/
		logtype = condition_json.type;
		$('#logtype').val(logtype).trigger('change');
		data = condition_json.data;
		$(data).each(function(i,item){
			operate = item.operate;
			_srItem = $("#srArea>div.srItem:eq("+i+")");
			
			li_obj = $("div.subSel>ul>li[data-type="+operate+"]",$(_srItem));
			
			var type =operate,
                name = $(li_obj).text();
            $(li_obj).addClass('active').siblings().removeClass('active');
			$_obj = $("div.label",$(_srItem));
			var $c2 = $_obj.siblings('.c2');
            setTimeout(function() {
                $_obj.removeClass('on');
            }, 100);
            $_obj.children('span').text(name);
            _loadTemp($_obj.parent(), type);

            var nType = type.split('_');
            if (nType[0] == 'blank') {
                $c2.hide().siblings('.c').find('.srCtrl').addClass('on3');
                $_obj.parent().find('a.b1').addClass('disable');
            } else {
                $c2.show().siblings('.c').find('.srCtrl').removeClass('on3');
                $_obj.parent().find('a.b1').removeClass('disable');
            }
			
			$(item.condition).each(function(i1,item1){		
				_srSort = $("div.srSort:eq(0)",$(_srItem));
				//console.log(_srSort);
				$(_srSort).find('select[name=_action]').val(item1.action).trigger('change');
				if(operate.indexOf('ip') >=0 ){
					if(item1.action == "between"){ //区间
						$("input:eq(0)",$(_srSort)).val(item1.value.split(';')[0]);
						$("input:eq(1)",$(_srSort)).val(item1.value.split(';')[1]);	
					}else if(item1.action == "group"){						
						$("div.forgroup",$(_srSort)).attr('group',item1.value).text(get_name(item1.value,0));
					}else{						
						if(hostip.indexOf(item1.value) < 0){ //其他
							$("select[name='_host']",$(_srSort)).val(-1).trigger('change');
							$("input:eq(0)",$(_srSort)).val(item1.value);
						}else{							
							$("select[name='_host']",$(_srSort)).val(item1.value).trigger('change');
						}
					}
				}else if(operate.indexOf('int08') >=0 ||  operate == 'int32_01' ||  operate == 'int64_15'){ //下拉 select的值
					if(operate != 'int32_01'){
						$("select:eq(1) option",$(_srSort)).each(function(){
							if($(this).text() == item1.value){  
								$(this).attr("selected","selected").trigger('change');  
							}  
						})
					}else 
						$("select:eq(1)",$(_srSort)).val(item1.value).trigger('change');
					//$("select:eq(1)",$(_srSort)).val(item1.value).trigger('change');
				}else{
					if(item1.action == "between"){ //区间
						if(operate.indexOf('xtime')>=0 && operate!="xtime_00" && operate!='xtime_03'){
							start = item1.value.split(';')[0];
							end = item1.value.split(';')[1];
							ymd = start.split(' ')[0];
							h =  start.split(' ')[1].split(':')[0];
							f =  start.split(' ')[1].split(':')[1];
							s =  start.split(' ')[1].split(':')[2];
							//8 个 input 
							$("input:eq(0)",$(_srSort)).val(ymd);
							$("input:eq(1)",$(_srSort)).val(h);
							$("input:eq(2)",$(_srSort)).val(f);
							$("input:eq(3)",$(_srSort)).val(s);
							//
							ymd = end.split(' ')[0];
							h =  end.split(' ')[1].split(':')[0];
							f =  end.split(' ')[1].split(':')[1];
							s =  end.split(' ')[1].split(':')[2];
							$("input:eq(4)",$(_srSort)).val(ymd);
							$("input:eq(5)",$(_srSort)).val(h);
							$("input:eq(6)",$(_srSort)).val(f);
							$("input:eq(7)",$(_srSort)).val(s);
						}else{
							$("input:eq(0)",$(_srSort)).val(item1.value.split(';')[0]);
							$("input:eq(1)",$(_srSort)).val(item1.value.split(';')[1]);
						}
					}else{
						if(operate.indexOf('xtime')>=0 && operate!="xtime_00" && operate!='xtime_03'){
							ymd = item1.value.split(' ')[0];
							h =  item1.value.split(' ')[1].split(':')[0];
							f =  item1.value.split(' ')[1].split(':')[1];
							s =  item1.value.split(' ')[1].split(':')[2];
							$("input:eq(0)",$(_srSort)).val(ymd);
							$("input:eq(1)",$(_srSort)).val(h);
							$("input:eq(2)",$(_srSort)).val(f);
							$("input:eq(3)",$(_srSort)).val(s);
						}else{
							$("input:eq(0)",$(_srSort)).val(item1.value.replace(/&quot;/g,'"').replace(/&amp;/g,'&').replace(/&apos;/g,'\'').replace(/&gt;/g,'>').replace(/&lt;/g,'<'));
						}
					}
				}
				//添加
				if( i1 < (item.condition.length -1)){
					$('span.srsCtl a.add',$(_srSort)).click();
				}
				
			})
			//添加
			if( i <= (data.length -1))
				$("#srArea>div.srItem:eq("+i+") div.c>div.srCtrl>div.a>a:eq(2)").click();
		})
		$('#srArea div.srItem:last-child').remove();
		if($('#srArea div.srItem').length == 1){
			$('#srArea div.srItem').eq(0).find('i.del').parent('a').attr('class','disable');
		} 
	}
    function _tabColView(obj) {
        var $c = $(obj).parent();
        if ($('#tabvList').is(':hidden')) {
            $c.addClass('on').on('mouseout', function() {
                document.onclick = function() {
                    $c.removeClass('on');
                }
            }).on('mouseover', function() {
                document.onclick = null;
            });
        }
    }
	var proto_list = [];
	var hostip=[];
	function _initData(){
		//获取 所有主机
		$.ajax({
			url:'/bhost/get_search_host',
			type:'post',
			async:false,
			data:{a0:{{se}}},
			success:function(result){
				result = JSON.parse(result); 
				$('#_host').empty().append('<option value="-1">其他</option>');
				$(result).each(function(i,item){
					$('#_host').append('<option value="'+item.HostIP+'">'+item.HostName+'</option>');
					hostip.push(item.HostIP);
				})
			}
		})
		//获取 所有协议
		$.ajax({
			url:'/bhost/get_search_proto',
			type:'post',
			async:false,
			data:{a0:{{se}}},
			success:function(result){
				result = JSON.parse(result); 
				proto_list = result.data;
			}
		})
		
	}
	
	var IPReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/
    var numberReg = /^[0-9]*$/;
	function compareIP(ipBegin, ipEnd)  
    {  
        var ipBegin = ipBegin.split(".");
		var ipEnd = ipEnd.split(".");
		for (var i = 0; i < 4; i++) {
			if (parseInt(ipBegin[i]) > parseInt(ipEnd[i])) {
				return 1
			} else if (parseInt(ipBegin[i]) < parseInt(ipEnd[i])) {
				break;
			}
		}  
        return 0;     
    }  
	function compareTime(begin,end){
		 var d1 = new Date(begin.replace(/\-/g, "\/"));  
		 var d2 = new Date(end.replace(/\-/g, "\/"));  

		 if(d1 >d2){  
			return 1;
		 }
		 return 0;
	}
    //提交
    function _submit(){
		tasktype = 0;
        //获取 检索条件
		logtype =$('#logtype').val(); 
		/*
		var json_condition ={
			"type":logtype,
			"data":[
				{
					"operate":"xtime_00",
					"translate:"编号",
					"condition":[
						{
							"action":"between",
							"value":"2017-10-9 00:00:00;2017-10-9 23:59:59"
						}
					]
					
				}
			]
		}*/
		var json_condition ={
			"type":logtype,
			"data":[]
		};
		var check_p = 0;
		var oper = '';
		$("#srArea>div.srItem").each(function(i,item){
			one_condition ={};
			operate = $("div.subSel>ul>li.active",$(item)).data('type');
			translate = $("div.subSel>ul>li.active",$(item)).text();
			one_condition.operate = operate;
			one_condition.translate = translate;
			one_condition.condition = [];
			
			//获取条件
			//ip
			value = "";
			var check = 0;
			var son_oper ='';
			$("div.c2 div.srSort",$(item)).each(function(i1,item1){
				
				////console.log(item1);
				//获取 单个条件
				//action
				action = $("select[name=_action]",$(item1)).val();
				action_trans = $("select[name=_action] option:selected",$(item1)).text();
				
				if(operate.indexOf('ip') >=0 ){
					if(action == "between"){ //区间
						start = $("input:eq(0)",$(item1)).val();
						end = $("input:eq(1)",$(item1)).val();
						if(start == "") {		
							if(i1 == 0) return true;
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 不能为空',$("input:eq(0)",$(item1)));
							return false; 
						}
						if(end == "") {	
							if(i1 == 0) return true;
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 不能为空',$("input:eq(1)",$(item1)));
							return false; 
						}
						if (!IPReg.test(start)) {
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 IP格式错误',$("input:eq(0)",$(item1)));
							return false;
						}if (!IPReg.test(end)) {
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 IP格式错误',$("input:eq(1)",$(item1)));
							return false;
						}
						ret = compareIP(start,end);
						if(ret == 1){
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 起始地址不能大于结束地址',$("input:eq(0)",$(item1)));
							return false; 
						}
						value = start + ";" + end;
						son_oper = son_oper+''+action_trans + ' '+ value;
					}else if(action == "group"){
						value = $("div.forgroup",$(item1)).attr('group');
						son_oper = son_oper+''+action_trans + ' '+ value;
					}else{
						if($("select[name='_host']",$(item1)).val() == -1){ //其他
							value = $("input:eq(0)",$(item1)).val();
							value_trans = value;
							if(value == "") {		
								if(i1 == 0) return true;
								check = 1;
								_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 不能为空',$("input:eq(0)",$(item1)));
								return false; 
							}
							if (!IPReg.test(value)) {
								check = 1;
								_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 IP格式错误',$("input:eq(0)",$(item1)));
								return false; 
							}
						}else{
							value = $("select[name='_host']",$(item1)).val();
							value_trans = $("select[name='_host'] option:selected",$(item1)).text();
						}
						son_oper = son_oper+''+action_trans + ' '+ value_trans;
					}
				}else if(operate.indexOf('int08') >=0 ||  operate == 'int32_01' || operate == 'int64_15' ){ //下拉 select的值
					value = $("select:eq(1)",$(item1)).val();
					value_trans = $("select:eq(1) option:selected",$(item1)).text()
					son_oper = son_oper+''+action_trans + ' '+ value_trans;
				}else{
					if(action == "between"){ //区间
						start = $("input:eq(0)",$(item1)).val();
						end = $("input:eq(1)",$(item1)).val();
						if(start == "") {		
							if(i1 == 0) return true;
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 不能为空',$("input:eq(0)",$(item1)));
							return false; 
						}
						if(end == "") {	
							if(i1 == 0) return true;
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 不能为空',$("input:eq(1)",$(item1)));
							return false; 
						}
						
						if(operate.indexOf('xtime')>=0 && operate!="xtime_00" && operate!='xtime_03'){ //时间 除去 编号和会话标志 因为是时间控件 不需要判断格式
							//现在 有 8个input
							ymd = $("input:eq(0)",$(item1)).val();
							h = $("input:eq(1)",$(item1)).val();
							f = $("input:eq(2)",$(item1)).val();
							s = $("input:eq(3)",$(item1)).val();
							start =  ymd +" " + h +":"+ f + ":" + s ;
							
							ymd = $("input:eq(4)",$(item1)).val();
							h = $("input:eq(5)",$(item1)).val();
							f = $("input:eq(6)",$(item1)).val();
							s = $("input:eq(7)",$(item1)).val();
							end = ymd +" " + h +":"+ f + ":" + s ;
							
							
							ret = compareTime(start,end);
							if(ret == 1){	
								check = 1;
								_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 起始时间不能大于结束时间',$("input:eq(0)",$(item1)));
								return false; 
							}
						}else{
							if(operate.indexOf('str32')>=0){;} //字符串的先不限制条件
							else{
								
								if (!numberReg.test(start)){ //限制数字
									check = 1;
									_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 格式不正确',$("input:eq(0)",$(item1)));
									return false;
								}
								if (!numberReg.test(end)){ //限制数字
									check = 1;
									_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 格式不正确',$("input:eq(0)",$(item1)));
									return false;
								}
								if(parseInt(start) > parseInt(end)){	
									check = 1;
									_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 起始'+translate+'不能大于结束'+translate+'',$("input:eq(0)",$(item1)));
									return false;					
								}
							}
						}
						value = start + ";" + end;
						son_oper = son_oper+''+action_trans + ' '+ value;
						
						
					}else{
						value = $("input:eq(0)",$(item1)).val();
						
						if(value == "") {		
							if(i1 == 0) return true;
							check = 1;
							_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 不能为空',$("input:eq(0)",$(item1)));
							return false; 
						}
						if(operate.indexOf('xtime')>=0 && operate!="xtime_00" && operate!='xtime_03'){ //时间 除去 编号和会话标志 因为是时间控件 不需要判断格式
							ymd = $("input:eq(0)",$(item1)).val();
							h = $("input:eq(1)",$(item1)).val();
							f = $("input:eq(2)",$(item1)).val();
							s = $("input:eq(3)",$(item1)).val();
							value =  ymd +" " + h +":"+ f + ":" + s ;
							;
						}else{
							if(operate.indexOf('str32')>=0){;} //字符串的先不限制条件
							else{
								
								if (!numberReg.test(value)){ //限制数字
									check = 1;
									_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件 格式错误',$("input:eq(0)",$(item1)));
									return false;
								}
								
							}
						
						}
						son_oper = son_oper+''+action_trans + ' '+ value;
					}
					
					
				}
				condition = JSON.parse("{\"action\":\""+action+"\",\"value\":\""+value.replace(/&/g,'&amp;').replace(/\"/g,'&quot;').replace(/\'/g,'&apos;').replace(/>/g,'&gt;').replace(/</g,'&lt;').replace(/\\/g,'\\\\')+"\"}");
				
				//console.log("con="+JSON.stringify(condition))
				//console.log("one="+JSON.stringify(one_condition.condition))
				var n = 0;
				var ind = 0;
				$(one_condition.condition).each(function(ind,itemj){
					if(JSON.stringify(condition) == JSON.stringify(itemj)){
						n =1;						
						return false;
					}
				})
				if(n){
					check = 1;
					_alert(1,'检索','第' + (i+1) +"个条件的第" + (i1+1) +'个子条件与第'+(ind+1)+'个子条件相同');
					return false;
				}
				one_condition.condition.push(condition);
				//console.log(JSON.stringify(one_condition));
				if(i1 == $("div.c2 div.srSort",$(item)).length -1){
					//son_oper = '(' +son_oper+ ')';
				}else{
					son_oper = son_oper+ ' 或 ';
				}
					
			})		
			if(check){
				check_p = 1;
				return false;
			}
			n=0;
			var iind = 0;
			$(json_condition.data).each(function(iind,itemk){
				if(JSON.stringify(one_condition) == JSON.stringify(itemk)){
					n =1;						
					return false;
				}
			})
			if(n){
				check_p = 1;
				_alert(1,'检索','第' + (i+1) +'个条件与第'+(iind+1)+'个条件相同');
				return false;
			}
			if(one_condition.condition.length == 0){
				check_p = 1;
				_alert(1,'检索','第' + (i+1) +'个条件为空');
				return false;
			}
			oper = oper + translate + '(' + son_oper +") 并且 ";
			json_condition.data.push(one_condition);			
		})
		if(check_p) return false;
		oper = oper.substring(0,oper.length-4);
		oper = "日志属性("+ $('#logtype option:selected').text()+') 并且 '+oper
		oper = '检索：'+oper ;
		//console.log(oper);
		msstr = aceg(JSON.stringify(json_condition),{{se}});
		$.ajax({
			url:'/bhost/search_action',
			type:'post',
			async:true,
			data:{a0:{{se}},s1:0,s2:JSON.stringify(json_condition),s3:0,s4:"",s5:"",s6:"",s8:oper,s9:if_disable,m1:msstr},
			success:function(result){
				result = JSON.parse(result);
				if(result.Result == true){
					if(tasktype == 0){
						if(result.jump == true){
							$.ajax({
								url:'/bhost/get_totalrow',
								type:'post',
								data:{a0:{{se}},t1:result.TaskId},
								success:function(result1){
									result1 = JSON.parse(result1);
									if(result1.Result){
										totalrow = result1.Count;
										
										if(totalrow >0 ){
											location.href = '/bhost/search_result?a0={{se}}&f1='+from_flag+'&t1='+result.TaskId+'&tp1={{task_page}}';
										}
										else  {
											url = '/bhost/search_result?a0={{se}}&f1='+from_flag+'&t1='+result.TaskId+'&tp1={{task_page}}';
											_alert(1,'检索','查询结果为空',$('#_'),url);
										}
									}else{
										_alert(1,'检索结果',result.ErrMsg);
									}
								}
							})
							return false;
						}else{
							__doSearch(result.TaskId);
						}
					}
				}else{
					_alert(1,"检索",result.ErrMsg);
					
				}
			}
		})
	}
	
	var loadLayer;
	var if_ok;
    function __doSearch(TaskId){
        _showLoading();
        //vf = $('#newCont_task').children('iframe:visible');
		//取当前 任务的数量 一旦取到数据就关闭等待 如果搜索完成之后 数据为空 则提示不需要跳转
		var Status = 0;
		var totalrow = 0;
		function _do(){
			$.ajax({
				url:'/bhost/get_totalrow',
				type:'post',
				async:true,
				data:{a0:{{se}},t1:TaskId},
				success:function(result){
					result = JSON.parse(result);
					if(result.Result){
						totalrow = result.Count;
						Status = result.Status;
					}else{
						_alert(1,'检索结果',result.ErrMsg);
					}
				}
			})
		}
		if_ok = setInterval(function(){
			////console.log(index);
			if(Status > 1 && totalrow == 0){
				clearInterval(if_ok);
				_closeLoading();
				
				url = '/bhost/search_result?a0={{se}}&f1='+from_flag+'&t1='+TaskId+'&tp1={{task_page}}';
				_alert(1,'检索','查询结果为空',$('#_'),url);
				
				//_alert(1,'检索','查询结果为空');
				//location.href = '/bhost/search_result?a0={{se}}&f1='+from_flag+'&t1='+TaskId+'&tp1={{task_page}}';
				return false;
			}
			else if (Status > 1 || totalrow>0){    //获取信息结束	
				_closeLoading();
				clearInterval(if_ok);
				location.href = '/bhost/search_result?a0={{se}}&f1='+from_flag+'&t1='+TaskId+'&tp1={{task_page}}';
				return false;
			}
			_do();	
		},1000);
    }
	function _stop(){
		clearInterval(if_ok);
	}
    function _showLoading(){
        loadLayer = layer.open({
            title:false,
            closeBtn:false,
            content:'<div id="Loading">正在查询中……</div>',
            btn:false,
            skin:'loadingbar',
            area:['150px','180px'],
            move:false,
            resize:false,
		isOutAnim: false,
            shade:[0.1,'#000']
        })
    }

    function _closeLoading(){
        layer.close(loadLayer);
    }
    var rsout;
    // $(window).resize(function(){
    //     clearTimeout(rsout);
    //     rsout = setTimeout(function(){
    //         var bh = $(window).height();
    //         $('#viewWrap').height("");
    //     },200);
    // })
	function _loadTemp(obj, type) {
        var $_obj = $(obj);
        var $c2 = $_obj.children('.c2');

        var oldType = $_obj.data('type');
        if (oldType && oldType == type) {
            return;
        }
        var nType = type.split('_');
        $_obj.data('type', type);
		if(type =="int08_11" || type =="int08_14" || type =="int08_15" || type =="int32_01" || type =="int08_03" || type =="int08_12") {
			nType[0] = "select";
			$('#srTemp-select select:eq(1)').empty();
			if(type =="int08_11" ){	//告警处理
				$('#srTemp-select select:eq(1)').append('<option value="0">未处理</option><option value="1">已处理</option>');
			}else if(type =="int08_14"){ //告警类型
				$('#srTemp-select select:eq(1)').append('<option value="0">无</option><option value="1">违规操作</option><option value="2">高危操作</option><option value="3">登录异常</option>');
			}else if(type =="int08_15"){ //告警等级
				$('#srTemp-select select:eq(1)').append('<option value="0">无</option><option value="1">低</option><option value="2">中</option><option value="3">高</option>');
			}else if(type =="int32_01"){ //所有协议
				if($('#logtype').val()=='SYSTEM'){
						$('#srTemp-select select:eq(1)').append('<option value="1">用户操作</option><option value="2">系统管理</option>');
				}else{
					$(proto_list).each(function(i,item){
						$('#srTemp-select select:eq(1)').append('<option value="'+item.ProtocolId+'">'+item.ProtocolName+'</option>');
					})
				}
				
			}else if(type =="int08_03"){ //会话状态
				//$('#srTemp-select select:eq(1)').append('<option value="0">连接中</option><option value="1">正常退出</option><option value="2">异常退出</option><option value="3">用户退出</option><option value="4">用户阻断</option><option value="5">超时退出</option><option value="6">指令阻断</option><option value="7">访问审批拒绝</option><option value="8">SQL超时阻断</option><option value="9">工单未审批</option>');
				$('#srTemp-select select:eq(1)').append('<option value="0">连接中</option><option value="1">正常退出</option><option value="2">异常退出</option>');
			}else if(type =="int08_12"){ //是否告警
				//$('#srTemp-select select:eq(1)').append('<option value="0">连接中</option><option value="1">正常退出</option><option value="2">异常退出</option><option value="3">用户退出</option><option value="4">用户阻断</option><option value="5">超时退出</option><option value="6">指令阻断</option><option value="7">访问审批拒绝</option><option value="8">SQL超时阻断</option><option value="9">工单未审批</option>');
				$('#srTemp-select select:eq(1)').append('<option value="0">无</option><option value="1">告警</option>');
			}
		}else if(type =="int64_15"){ //告警动作
			$('#srTemp-int64_15 select:eq(1)').append('<option value="80">邮件</option><option value="100">短信</option><option value="2000">阻断</option><option value="4000">SYSLOG</option><option value="8000">SNMP</option><option value="10000">忽略</option>');
			nType[0] = "int64_15";
		}else if(type == "xtime_00" || type == "xtime_03" ||  nType[0].indexOf('int')>=0 ) nType[0] = "int";
		
        $c2.html($('#srTemp-' + nType[0]).clone().attr('id', '').show());

        if (nType[0] == 'blank') {
            $c2.siblings('.c').find('.srCtrl').addClass('on3');
        }
		//
		if(type.indexOf('ip') >=0 ) {
			$('.srSelect', $c2).eq(0).select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });
			$('.srSelect', $c2).eq(1).select2({ theme: 'default srSelect2' });
		}else if(type == 'int32_01'){
			$('.srSelect', $c2).eq(0).select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });
			$('.srSelect', $c2).eq(1).select2({ theme: 'default srSelect2' });
		}
		else $('.srSelect', $c2).select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });
		
        $('.srSelect:first', $c2).trigger('change');
		
		//绑定 int  input 只能输入数字
		$("input.search_input",$c2).bind('keydown', function(e){
			DigitInput(e);
		});
		
        var now = new Date();
        var setDate = {
            year: now.getFullYear(),
            month: now.getMonth() + 1,
            day: now.getDate()
        }
		//console.log($c2);

        $('input.datepicker',$c2).each(function(){
            $(this).jeDate({
                format:"YYYY-MM-DD",
                isTime:true,
                maxDate:setDate.year + "-" + setDate.month + "-" + setDate.day
            });
        })
		_getDate($c2);
    }
	
	function _getDate(obj) {
		var now = new Date();
        var setDate = now.getTime();
        setDate = new Date(setDate);
        var month = (setDate.getMonth() + 1).toString();
        var day =  setDate.getDate().toString();

        if(month.length == 1){
            month = '0' + month;
        }

        if(day.length == 1){
            day = '0' + day;
        }
        setDate = {
            year: setDate.getFullYear(),
            month: month,
            day: day
        }
        setDate = setDate.year + '-' + setDate.month + '-' + setDate.day;
        $('input.datepicker', obj).each(function(i,item){
            if(i==0){
                $(item).val(setDate);
                $(item).parent().find('input.timeinput').val('00');
            }else if(i==1){
                $(item).val(setDate);
                $(item).parent().find('input.timeinput').each(function(i){
                    if(i == 0){
                        $(this).val('23');
                    }else{
                        $(this).val('59');
                    }
                })
            }
            
        });
    }

    function _showBtns(obj) {
        var $obj = $(obj).parent();
        var sout;
        $obj.addClass('on2').unbind().hover(function() {
            clearTimeout(sout);
        }, function() {
            var $_this = $(this);
            sout = setTimeout(function() {
                $_this.removeClass('on2');
            }, 100);
        });
    }

    function _hideCtrl(obj) {
        var $c = $(obj).parent().parent();
        var $c2 = $c.next();

        var type = $c.parent().data('type').split(':')[0];
        if(type == 'blank'){
            return;
        }

        //$('.srSort', $c).show();
        $c2.slideUp(200);
        $(obj).parent().addClass('on');

        var $_obj = $c.parent();
        var len = 2;
        var type = $_obj.data('type').split(':');
        if (type[0] == 'port') {
            len = 5;
        } else if (type[0] == 'number') {
            len = 4;
        } else if (type[0] == 'select') {
            len = 5;
        } else if (type[0] == 'time') {
            len = 2;
        } else if (type[0] == 'ip') {
            $('.srSort', $c2).each(function(i, item) {
                var tv = $('select:first', item).val();
                if (tv != 'ingroup') {
                    //$('.select2-container:eq(2)', item).hide();
                    $('.forgroup', item).hide();
                }else{
                    $('.forgroup', item).show();
                }
            });

        }

        $('.srSort', $c2).each(function(i, item) {

            if (i < len) {
                var $_item = $(item).clone();
                $c.append($_item).append('<span class="srFix" />');
            }
        });

        $('span.srFix:last', $c).remove();
        $('.srSort input', $c).prop('readonly', true);
    }

    function _showCtrl(obj) {
        var $c = $(obj).parent().parent();
        var $c2 = $c.next();

        $('.srSort,.srFix', $c).remove();
        $c2.slideDown(200);
        $(obj).parent().removeClass('on');
    }

    function _save() {
        var name = $('#tempNameSelect>option:selected').text();
        parent._getSaveLayer(name);
    }

    function _itemDel(obj) {
        var $_obj = $(obj).parent().parent()
        $_obj.fadeOut(function() {
            $_obj.remove();
        })
    }


    function _getSubSel(obj) {
		var $_obj = $(obj);
        var offset = $_obj.offset();
        var wh = $('#viewWrap').height();
		var st = $("#viewWrap").scrollTop();
        if(offset.top-st>wh - 170){
            $('.subSel', $_obj).css('margin-top',-226);
        }else{
            $('.subSel', $_obj).css('margin-top',0);
        }
		
		var $sel = $('.select2-container--open').prev('select');
        $sel.select2('destroy').select2({minimumResultsForSearch: -1});
		
        var ctype = $_obj.parent().data('type').split('_');
        var $c2 = $_obj.siblings('.c2');
        if ($c2.is(':hidden') && ctype[0] != 'blank') {
            return;
        }

        var c = $_obj.attr('class').split(' ');
        var b = $.inArray('on', c);
        if (b < 0) {
            $_obj.addClass('on').parent().siblings().children('div.label').removeClass('on');
            $_obj.hover(function() {
                document.onclick = null;
            }, function() {
                document.onclick = function() {
                    $_obj.removeClass('on');
                }
            });
        } else {
            $_obj.removeClass('on');
        }
        $('.subSel', $_obj).unbind().on('click', 'li', function() {
            var type = $(this).data('type'),
                name = $(this).text();
            $(this).addClass('active').siblings().removeClass('active');
            setTimeout(function() {
                $_obj.removeClass('on');
            }, 100);
            $_obj.children('span').text(name);
            _loadTemp($_obj.parent(), type);

            var nType = type.split('_');
            if (nType[0] == 'blank') {
                $c2.hide().siblings('.c').find('.srCtrl').addClass('on3');
                $_obj.parent().find('a.b1').addClass('disable');
            } else {
                $c2.show().siblings('.c').find('.srCtrl').removeClass('on3');
                $_obj.parent().find('a.b1').removeClass('disable');
            }
        });
    }

    function _initArea(i) {
        var $c = $('#areaTemp').clone().attr('id', '').show();
        $('#srArea').append($c);
		
        if(i == 1){
            _loadTemp($c, 'blank_0');
            $c.find('.label span').text('请选择');
            $c.find('div.c2').hide();
            $c.find('.subSel>ul').children('li:first').addClass('active').siblings().removeClass('active');
            $c.find('a.b1').addClass('disable');
            $('div.srCtrl a:eq(1)',$c).removeClass('disable');
            $('div.srCtrl a:eq(1)').removeClass('disable');
        }else{
			if($('#logtype').val()=='SYSTEM') _loadTemp($c, 'xtime_02');
			else _loadTemp($c, 'xtime_01');
            _getDate($c);
        }
    }

    //重载
    function _reloadItem(obj) {
		$(obj).blur();
        parent.layer.open({
            type: 1,
            title: '初始化确认',
            content: '<div class="layer-alert"><i class="alert warning"></i>是否初始化此索引条件？</div>',
            btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
            btnAlign: 'c',
            area: ['380px','310px'],
            yes: function(i) {
                var $c = $(obj).parents('.srItem');
                var type = $c.data('type');
                $c.data('type', 0);
                _loadTemp($c, type);
                parent.layer.close(i);
            },
            skin:'layer-custom'
        });
    }
	function check_value(_parent_srSort,enalert){
		//console.log(_parent_srSort);
		_type = $(_parent_srSort).parent().siblings('div.label').children('div.subSel').children('ul').children('li.active').attr('data-type');
		_type_txt = $(_parent_srSort).parent().siblings('div.label').children('div.subSel').children('ul').children('li.active').text();
		//console.log(_type);
		//1空值 判断
		_input = _parent_srSort.find('input:visible');
		_action = $('select[name=_action]',_parent_srSort).val();
		////console.log(_type);
		if(_input.length == 0){
			if(_action == "group") {
				v = $('div.forgroup',_parent_srSort).attr('group');
				if((v == "" || v == undefined)&& enalert){
					_alert(1,'检索','请选择主机组');
					return false;
				}
			}
			else v = $('select:eq(1)',_parent_srSort).val();
		}
		else if(_input.length == 1){ //非区间
			v = $(_input).val();
			if( v == "" && enalert ){
				_alert(1,'检索','请输入检索条件',$(_input));
				return false;
			}
			if(_type.indexOf('ip')>=0){
				if (!IPReg.test(v) && enalert ) {
					_alert(1,'检索','请输入正确的检索条件',$(_input));
					return false;
				}
			}else if(_type.indexOf('xtime')>=0 && _type!="xtime_00" && _type!='xtime_03'){ //时间 除去 编号和会话标志 因为是时间控件 不需要判断格式
				;
			}else{
				if(_type.indexOf('str32')>=0){;} //字符串的先不限制条件
				else{
					if (!numberReg.test(v) && enalert){ //限制数字
						_alert(1,'检索','请输入正确的检索条件',$(_input));
						return false;
					}
				}
			}
			
		}else if(_input.length == 2){ //区间
			start = $(_input).eq(0).val();
			end = $(_input).eq(1).val();
			if(start == ""&& enalert){
				_alert(1,'检索','请输入检索条件',$(_input).eq(0));
				return false;
			}
			if(end == "" && enalert){
				_alert(1,'检索','请输入检索条件',$(_input).eq(1));
				return false;
			}
			
			if(_type.indexOf('ip')>=0){
				if (!IPReg.test(start) && enalert ) {
					_alert(1,'检索','请输入正确的检索条件',$(_input).eq(0));
					return false;
				}
				if (!IPReg.test(end) && enalert) {
					_alert(1,'检索','请输入正确的检索条件',$(_input).eq(1));
					return false;
				}
				ret  = compareIP(start,end);
				if(ret == 1 && enalert){
					_alert(1,'检索','起始地址不能大于结束地址',$(_input).eq(0));
					return false;
				}
			}else{
				if(_type.indexOf('str32')>=0){;} //字符串的先不限制条件
				else{
					
					if (!numberReg.test(start) && enalert){ //限制数字
						_alert(1,'检索','请输入正确的检索条件',$(_input).eq(0));
						return false;
					}
					if (!numberReg.test(end) && enalert&& enalert){ //限制数字
						_alert(1,'检索','请输入正确的检索条件',$(_input).eq(1));
						return false;
					}
					if(parseInt(start) > parseInt(end) && enalert){				
						_alert(1,'检索','起始'+_type_txt+'不能大于结束'+_type_txt+'',$(_input).eq(0));
						return false;						
					}
				}
			}
			v = start +";"+end;
		}else{		
			if(_action == 'between'){
				ymd = $(_input).eq(0).val();
				h = $(_input).eq(1).val();
				f = $(_input).eq(2).val();
				s = $(_input).eq(3).val();
				start =  ymd +" " + h +":"+ f + ":" + s ;
				
				ymd = $(_input).eq(4).val();
				h = $(_input).eq(5).val();
				f = $(_input).eq(6).val();
				s = $(_input).eq(7).val();
				end = ymd +" " + h +":"+ f + ":" + s ;
				
				if(_type.indexOf('xtime')>=0 && _type!="xtime_00" && _type!='xtime_03'){ //时间 除去 编号和会话标志 因为是时间控件 不需要判断格式
					ret = compareTime(start,end);
					if(ret == 1 && enalert){
						_alert(1,'检索','起始时间不能大于结束时间',$(_input).eq(0));
						return false;
					}
				}
				v = start +";"+end;
			}else{
				ymd = $(_input).eq(0).val();
				h = $(_input).eq(1).val();
				f = $(_input).eq(2).val();
				s = $(_input).eq(3).val();
				v =  ymd +" " + h +":"+ f + ":" + s ;
				
			}
		}
		return (_action + "	" + v);
	}
	function _itemAdd(obj) {
		
		_parent_srSort = $(obj).parent().parent();
		value_first = check_value(_parent_srSort,true);
		//console.log(value_first);
		if(value_first == false) return false;
		//查看是否存在 相同的配置
		_parent_c2 = _parent_srSort.parent();
		var n = 0;
		$("div.srSort",$(_parent_c2)).each(function(i,item){
			if(i == 0) return true;
			if((check_value($(item),false)) == value_first){
				n =1;
				_alert(1,'检索','与第'+(i+1)+'个子条件相同');
				return false;
			}
		})
		if(n) return false;
			
        var $_obj = $(obj).parent().parent();
        $_obj.children('select').select2('destroy')
        var $_obj2 = $_obj.clone()
        $_obj.before($_obj2);
        $('input', $_obj2).val('');
		$('div.forgroup', $_obj2).attr('group','').text('');
		
        var $_p = $_obj.parents('.srItem');
        var type = $_p.data('type').split('_');
        var ov = $_obj.children('select').eq(0).val();
        if(type[0] == 'ip' && (ov == 'equal' || ov == 'not equal')){
            $_obj.children('select').select2({ theme: 'default srSelect2' }).trigger('change');
        }else if(type[0] == 'ip' && ov == 'between'){
            $_obj.children('select').select2({ theme: 'default srSelect2' });
            $_obj.find('.select2').eq(1).hide();
        }else if(type[0] == 'ip' && ov == 'group'){
            $_obj.children('select').select2({ theme: 'default srSelect2' }).trigger('change');
            $_obj.children('input').eq(0).hide();
        }else{
			if($_p.data('type') == "int32_01") $_obj.children('select').trigger('change').select2({ theme: 'default srSelect2' });
			else $_obj.children('select').trigger('change').select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });
        }
        if(type[0] == 'ip' || $_p.data('type') == "int32_01" ) $_obj2.children('select').trigger('change').select2({ theme: 'default srSelect2' });
		else  $_obj2.children('select').trigger('change').select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });
        
        _getDate($_obj2);
		
		
		
        var now = new Date();
        var setDate = {
            year: now.getFullYear(),
            month: now.getMonth() + 1,
            day: now.getDate()
        }

        $('input.datepicker',$_obj2).each(function(){
            $(this).jeDate({
                format:"YYYY-MM-DD",
                isTime:true,
                maxDate:setDate.year + "-" + setDate.month + "-" + setDate.day
            });
        })
    }
    //删除
    function _delItem(obj) {
        var len = $('#srArea>div.srItem').length;

        if (len == 1) {
            return;
        }
		$(obj).blur();
        parent.layer.open({
            type: 1,
            title: '删除确认',
            content: '<div class="layer-alert"><i class="alert warning"></i>是否删除此索引条件？</div>',
            btn: ['确&nbsp;&nbsp;定', '取&nbsp;&nbsp;消'],
            btnAlign: 'c',
            area: ['380px','310px'],
            yes: function(i) {
                var $_obj = $(obj).parents('.srItem')
                $_obj.fadeOut(function() {
                    $_obj.remove();
                    var len2 = $('#srArea>div.srItem').length;
                    if(len2 == 1){
                        $('div.srCtrl a:eq(1)').addClass('disable');
                    }else{
                        $('div.srCtrl a:eq(1)').removeClass('disable');
                    }
                });
               parent.layer.close(i);
            },
            skin:'layer-custom'
        });
    }

    //添加
    function _addItem(obj) {
        _initArea(1);
    }

    //
    function srSelType(obj, i) {
        var v = $(obj).val();
        var $_obj = $(obj).parents('.srSort');
        if (i == 1) {
            if (v == 'between') {
                $('input:eq(1),span.srTip', $_obj).show();
            } else {
                $('input:eq(1),span.srTip', $_obj).hide();
            }
        } else if (i == 2) {
			if (v == 'between') {
                $('.stwrap:eq(1),>span.srTip', $_obj).show();
            } else {
                $('.stwrap:eq(1),>span.srTip', $_obj).hide();
            }
        } else if (i == 4) {
            $_obj.children('input,.select2-container,span.srTip').hide();
            $('.select2-container:eq(0)', $_obj).show();
			 $('.forgroup', $_obj).hide();
            if (v == 'between') {
                $('input:eq(0),input:eq(1),span.srTip', $_obj).show();
            } else if (v == 'group') {
               // $('.select2-container:eq(2)', $_obj).show();
			    $('.forgroup', $_obj).show();
            } else {
                $('.select2-container:eq(1),input:eq(0)', $_obj).show();
                $_obj.find('select').eq(1).trigger('change');
            }
        } else if (i == 5) {
            if (v == '-1') {
                $('input:eq(0)', $_obj).show();
                $('.select2-container:eq(1)', $_obj).removeClass('selon');
            } else {
                $('input:eq(0)', $_obj).hide();
                $('.select2-container:eq(1)', $_obj).addClass('selon');
            }
        }
    }

    //
    /*
    function _getHostGroup(obj){
        hglayer = layer.open({
            type:2,
            title:'选择主机组',
            content:'hostgroup.html',
            area:['640px','480px'],
            btn:false
        });

        $_hostGroupObj = $(obj);
    }

    function _closeHgLayer(){
        layer.close(hglayer);
    }
    */
	function _getHostGroup(obj){
        parent.__getHostGroup(obj);
    }
    function _setHostGroup(data,obj){
		
        var $_p = obj.parents('div.c2');
		
        var hgIds = new Array();
        $('div.forgroup:visible',$_p).each(function(){
            var hgid = parseInt($(this).attr('group'));

            if(hgid){
                hgIds.push(hgid);
            }
        })

        //console.log(hgIds);
		//加一层判断
		
        $.each(data,function(i,item){
            if($.inArray(item.id,hgIds) < 0){				
                var $_c = $('#srTemp-ip').clone().attr('id', '').show();
                $_c.children('select:first').val('group');
                $_c.children('select').select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });
                $_c.children('select:first').trigger('change');
                $_p.append($_c);
                $_c.children('div.forgroup').text(item.name);
				$_c.children('div.forgroup').attr('group',item.id).attr('path',item.path).show();
            }
        })

        parent._closeHgLayer();

        $('div.srSort:first',$_p).remove();
        var $_defaultTemp = $('#srTemp-ip').clone().attr('id', '').show();
        $_p.prepend($_defaultTemp);
		//$('div.srSort:first',$_p).remove();
        $('.srSelect', $_defaultTemp).select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });
        $('.srSelect:first', $_defaultTemp).trigger('change');
    }
	//改变类型
	function change_type(obj){
		type = $(obj).val();
		
		if(type == 'NORMAL' || type == 'SESSION'){
			if(if_disable_list[0] == '2') $('.s-hide').show();
			else  $('.s-hide').hide();
		}else{
			if(if_disable_list[1] == '2' || if_disable_list[2] == '2') $('.s-hide').show();
			else  $('.s-hide').hide();
		}
		
		_obj = $("#srArea>div.srItem").eq(0);
		$("div.subSel>ul",_obj).empty().append('<li data-type="blank_0">请选择</li>');
		/*<input name="service_1" id="service_1" value="xtime_00,编号;xtime_01,入库时间;xtime_02,发生时间;xtime_03,会话标识;xtime_04,起始时间;int08_00,日志属性;int08_11,告警处理;int08_14,告警类型;int08_15,告警等级;int16_00,客户端端口;int16_01,服务器端口;int32_01,日志类型;ip_00,发生地址;ip_01,服务端地址;ip_02,客户端地址;int64_15,告警动作;str32_00,用户;str32_01,操作;str32_02,信息;str32_05,客户端工具;str32_20,运维访问策略;str32_21,运维操作备注;str32_22,运维用户帐号;str32_23,运维用户姓名;str32_24,审批用户帐号;str32_25,审批用户姓名;str32_28,回放文件;str32_29,策略名称;str32_30,事件信息;str32_31,告警对象"  type="hidden">*/
		var fieldlist = [];
		if(type == "NORMAL"){ //操作 
			fieldlist = $('#service_1').val().split(';');
		}else if(type == "SESSION"){
			fieldlist = $('#service_2').val().split(';');
		}else if(type == "SYSTEM"){
			fieldlist = $('#service_3').val().split(';');
		}
		$('#areaTemp div.subSel>ul').empty();
		$(fieldlist).each(function(i,item){
			tmp = item.split(',');
			if(tmp[0] == 'int08_00') return true;
			$("div.subSel>ul",_obj).append("<li data-type=\""+tmp[0]+"\" >"+tmp[1]+"</li>");
			$('#areaTemp div.subSel>ul').append("<li data-type=\""+tmp[0]+"\" >"+tmp[1]+"</li>");
		})
		$("#srArea>div.srItem").each(function(i,item){
			if(i == 0){
				if( $('div.c>div.srCtrl',$(item)).attr('class').indexOf('on') >=0) $('div.c>div.srCtrl a.b2',$(item)).click();
				if(type == 'SYSTEM') $('div.subSel>ul',$(item)).find('li[data-type=xtime_02]').click().addClass('active');
				else $('div.subSel>ul',$(item)).find('li').eq(2).click().addClass('active');
				$('div.srCtrl>div.a a:eq(1)',$(item)).addClass('disable');
				$('div.c2 div.srSort span.srsCtl>a.del',$(item)).each(function(i1,item1){
					if(i1 == 0) return true;
					$(item1).click();
				})
			}else{
				$(item).remove();
			}
		})
		
		if(type == 'SYSTEM') $('#srArea>div.srItem div.subSel>ul').find('li[data-type=xtime_02]').click().addClass('active');
		else $('#srArea>div.srItem div.subSel>ul').find('li').eq(2).click().addClass('active');
		
		if($('#logtype').val()=='SYSTEM') typ = 'xtime_02';
		else typ = 'xtime_01';
		var nType = typ.split('_');
		$c2 = $('#srArea div.c2');
		$c2.html($('#srTemp-' + nType[0]).clone().attr('id', '').show());

        if (nType[0] == 'blank') {
            $c2.siblings('.c').find('.srCtrl').addClass('on3');
        }
		//
		$('.srSelect', $c2).select2({ minimumResultsForSearch: -1, theme: 'default srSelect2' });		
        $('.srSelect:first', $c2).trigger('change');
		
		//绑定 int  input 只能输入数字
		$("input.search_input",$c2).bind('keydown', function(e){
			DigitInput(e);
		});
		
        var now = new Date();
        var setDate = {
            year: now.getFullYear(),
            month: now.getMonth() + 1,
            day: now.getDate()
        }
		//console.log($c2);

        $('input.datepicker',$c2).each(function(){
            $(this).jeDate({
                format:"YYYY-MM-DD",
                isTime:true,
                maxDate:setDate.year + "-" + setDate.month + "-" + setDate.day
            });
        })
		_getDate($c2);
		
	}
    //保存模板
    function _saveTemp(name){
        alert(name);

        parent._cancelSave();
    }
	
    function _doSearch(){
        parent.__doSearch();
    }

    function _getResult(){
        window.location.href = '检索-检索结果.html';
    }
	function download_file(data){
		//console.log(data)
		var DownloadType = 0;		//1->回放文件  2->传输文件；
		var log_id,log_name;
		if(data.str32_28 != ""){
			DownloadType = 1;
			log_id = data.xtime_00;
			log_name = data.str32_28;		
		}else{
			if(data.str32_28 == "" && data.int32_01 == 'SFTP' || data.int32_01 == 'FTP' || data.int32_01 == 'SSH'){
				if(data.str32_01.indexOf('Save') >= 0){
					DownloadType = 2;
					log_id = data.xtime_00;
					log_name = data.str32_01.replace('Save ','',1);
				}
			}
		}
		if(log_name != ""){	
			$.ajax({
				url: "/bhost/download_fileCheck",
				type:"POST",
				async:true,		
				data:{a0:{{se}},a1:log_id,a2:log_name,a3:DownloadType,a10:"数据检索"},
				success:function(result){
					var result=JSON.parse(result);
					if(result.Result){
						//console.log(document.referrer);
						var referer_tmp = document.referrer.toString();
						var referer_array_tmp = referer_tmp.split('/');
						referer_array_tmp.pop();
						var referer_new = referer_array_tmp.join('/');
						//console.log(referer_new);
						if(DownloadType == 1){
							var index_tmp = data.str32_28.split('/').length;
							log_name = data.str32_28.split('/')[index_tmp-1]
						}
						var sesstimet = (new Date()).valueOf();
						var json_download = {
							"Type": "Download",
							"Url": referer_new,
							"Path": result.Path,
							"Filename": log_name,
							"Session": '{{se}}',
							"sesstimet":sesstimet
						}
						//cmd_str = JSON.stringify(json_download);
						//var evt = document.createEvent("CustomEvent");
						//evt.initCustomEvent('LocalEvent', true, false, cmd_str);
						//document.dispatchEvent(evt);
						//window.open('https://'+document.domain+'/bhost/test_html?se={{se}}&z1='+cmd_str);
						// var form = $("<form></form>").attr("action", '/bhost/download_file_log').attr("method", "post").attr('enctype','multipart/form-data');
						// form.append($("<input></input>").attr("type", "hidden").attr("name", "a3").attr("value", DownloadType));
						// form.append($("<input></input>").attr("type", "hidden").attr("name", "a2").attr("value", log_name));
						// form.append($("<input></input>").attr("type", "hidden").attr("name", "a1").attr("value", log_id));
						// form.append($("<input></input>").attr("type", "hidden").attr("name", "a0").attr("value", {{se}}));
						// form.appendTo('body').submit().remove();
						var if_html_client = false;
						var base64_str = '';
						$.ajax({
							url: "/bhost/get_base64",
							type:"POST",
							async:false,
							data:{a0:window.parent.document.frm.se.value,z1:JSON.stringify(json_download)},
							success:function(result){
								var result=JSON.parse(result);
								if(result.Result){
									if_html_client = result.info;
									base64_str = result.b64;
								}else{
									_alert(1,"实时监控",result.ErrMsg);
								}
							}
						})
						if(if_html_client) window.open('https://'+document.domain+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
						else{
							//window.location.href = 'bhost://cmd&'+base64_str;
							get_regedit('bhost', {{se}},'',sesstimet);
							$('#YuFrame1').remove();
							$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
							$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
						}
					}else{
						_alert(1,$("#frist").children('span').text(),result.ErrMsg);
					}
				}
			})
		}	
	}

	function delete_file(data){
	
		parent.layer.open({
			type:1,
			title:"数据检索",
			content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
			btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
			btnAlign:'c',
			closeBtn: false,
			skin:'layer-custom',
			area:['380px','310px'],
			move: false,
			resize: false,
			btn1:function(i){
				parent.layer.close(i);
				//传输文件；
				var log_id = data.xtime_00;
				var log_name = data.str32_01.replace('Save ','',1);
				$.ajax({
					url: "/bhost/delete_file_log",
					type:"POST",
					async:true,
					data:{a0:{{se}},a1:log_id,a2:log_name,a10:"数据检索"},
					success:function(result){
						var re = JSON.parse(result);
						if(re.Result == false){
							_alert(1,"检索",re.ErrMsg);
						}else{
							_alert(0,"检索","删除成功");
						}
					}
				})
			},
			btn2:function(i){
				parent.layer.close(i);
			}
		});
	
		
	}
    $(document).on('keydown','input.timeinput',function(){
        var i = $(this).index();
        var v = $(this).val();
        v = v.replace(/[^\d]/g,'');
        $(this).val(v);
    }).on('keyup','input.timeinput',function(e){
        var i = $(this).index();
        var v = $(this).val();
        var max = 23;
        if(i>1){
            max = 59;
        }

        if(v > max){
            v = max;
        }

        $(this).val(v);

        v = v.toString();
        if(v.length >= 2){
            $(this).val(v.substring(0,2));

            var keycode = e.keyCode;
            if(keycode != 9){
                $(this).next().next().focus();
            }
        }
    }).on('focus','input.timeinput',function(){
        $(this).select();
    }).on('blur','input.timeinput',function(){
        var v = $(this).val();
        v = v.toString();

        if(v == ''){
            v = '00';
        }else if(v.length == 1){
            v = '0' + v;
        }

        $(this).val(v);
    });
	
	function MarkWMsg(s_id,type,obj){
		//1-操作，2-会话，3-系统
		$.ajax({
				url: "/bhost/set_logstat",
				type:"POST",
				async:false,
				data:{a0:{{se}},a1:type,a2:s_id,a10:"检索"},
				success:function(result){
						var result = JSON.parse(result);
						if(result.Result == true){
								_alert(0,"检索","操作成功");
								//console.log($(obj));
								$.each($(obj).parent().parent().siblings(),function(i,item){
										if($(item).data('role') == 'int08_11'){
												$obj1 = $(item);
										}
								});
								//console.log($obj1);
								$obj1.text("已处理");
								$(obj).attr('class','msg1 disabled').unbind();
						}else{
								_alert(1,"检索","操作失败");
						}
				}
		})
}
var $_hostGroupObj;
var type_g;
var s_id_g;
function MarkWMsg(s_id,type,obj){
        $_hostGroupObj = $(obj);
        type_g = type;
        s_id_g = s_id;
        hglayer = layer.open({
                type:2,
                title:'确认备注',
                content:'/bhost/mark_layer?a0={{se}}&a1='+s_id+'&a2='+type+'&a3=实时监控',
                area:['650px','350px'],
                btn:false,
                shade:0.7
        });
}

function _closeHgLayer(flag,content){
        if(flag == 0){
                //1-操作，2-会话，3-系统
                $.ajax({
                        url: "/bhost/set_logstat",
                        type:"POST",
                        async:false,
                        data:{a0:"{{se}}",a1:type_g,a2:s_id_g,a3:content,a10:"数据检索>查询结果"},
                        success:function(result){
                                var result = JSON.parse(result);
                                if(result.Result == true){
                                        _alert(0,$("#frist").children('span').text(),"操作成功");
                                        $.each($_hostGroupObj.parent().parent().parent().children('td'),function(i,item){
                                                //console.log($(item).data('role'));
                                                if($(item).data('role') == 'int08_11'){
                                                        $obj1 = $(item);
                                                }else if($(item).data('role') == 'str32_16'){
                                                        $obj2 = $(item);
                                                }else if($(item).data('role') == 'str32_17'){
                                                        $obj3 = $(item);
                                                }else if($(item).data('role') == 'str32_18'){
                                                        $obj4 = $(item);
                                                }
                                        });
                                        $obj1.text("已处理");
										$obj2.text(result.UserCode);
										$obj3.text(result.UserName);
										$obj4.text(content);
                                        
                                        $_hostGroupObj.attr('class','msg1 disabled').unbind();
                                }else{
                                        _alert(1,$("#frist").children('span').text(),"操作失败");
                                }
                        }
                })
        }else{

        }
        layer.close(hglayer);
}
	
</script>
{% endblock  %}
