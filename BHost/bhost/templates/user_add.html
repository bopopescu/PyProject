{% extends  "index.html" %}
{% block head %}
	<!--icheck
	<script type="text/javascript" src="/manage/js/jquery.datepick.js"></script>-->	
	<script src="/manage/js/icheck.min.js"></script>
	<script src="/manage/js/select2.full.min.js"></script>
	<script src="/manage/js/xSelect.js"></script>
	<script src="/manage/js/jquery.jedate.min.js"></script>
	<link rel="stylesheet" href="/manage/css/jedate.css">
	<link rel="stylesheet" href="/manage/skin/icheck/minimal/blue.css">
	<link rel="stylesheet" href="/manage/css/select2.min.css">
	<link rel="stylesheet" href="/manage/css/G-style.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<script src="/manage/js/my_scrollbar.js"></script>
	
{% endblock  %}

{% block main %}
<body style="overflow:hidden; overflow-y: scroll" class="bg-white">

<!---->
	<div class="mainer" style="padding-bottom: 100px">
		
		<div class="container">
			<div class="c-top">
				<div class="c-title">
					<div class="manual-head" onclick="reload(0);"style="float:left;width:100px">
						<div class="manual-title" >
								<span id="sys_user" style="cursor: pointer;">系统用户</span>
							<i class="sys_user_icon"></i>
						</div>
					</div>
				</div>
			</div>

			<div class="c-cont">
				<div class="c-wrap" id="user_page" style="padding: 10px 0 0">
					<div class="c-exp" style="margin: -1px auto;">
						<div class="h-explorer">
							<div class="G-top">
								<div class="G-box1"></div><strong>&nbsp;基本信息</strong>								
								<div class="G-box2">启用：
									<input type="checkbox" class="form-checkbox" name="" id="status" value="" checked="checked" >
								</div>							
							</div>
							
							<div class="h-content2" style="min-height:210px;height:auto;width: 100%;overflow: hidden;padding: 14px 0 0;">
								<div class="form-item for-avatar" style="width: 180px;">
									<div id="tAvatar" onclick="_getAvatarList(this)"><img src="/manage/images/avatar1.jpg"></div>
								</div>
								<div class="col3">
									<div class="form-item">
										<span class="form-tag" style=""><em class="imp">*</em>账&nbsp;&nbsp;号：</span>
										<div class="form-c" style="">
											<input type="text" class="form-text" id="sys_u_name" maxlength="31" style="" onblur="regCheck(this,/^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/);change_name();" tabindex="1"><i class="v-check"></i>
											<p class="form-tip">仅支持英文、数字、下划线、横杠、小数点</p>
										</div>
									</div>
									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em>姓&nbsp;&nbsp;名：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "user_name" maxlength="127" onblur="regCheck(this,/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/)" tabindex="2"><i class="v-check"></i>
											<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">描&nbsp;&nbsp;述：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_descr" maxlength="2047" tabindex="3"><i class="v-check"></i>
										</div>
									</div>
									
									<div class="form-item" style="width: 33.3%;">
										<span class="form-tag">认证方式：</span>
										<div class="g-cont" style="">
											<div class="sel-type1" id="authtype_list_select" style="width:330px">
												<div class="xSelect xSelect_aythtypeList" id="sys_u_authtype"></div>
											</div>
										</div>
										
										<div class="tab-t" style=" width: 8%; position: absolute; margin-left: 290px; margin-top: -28px;" id="changepin_local">
											<div class="item" style="float: left;width: 100%" >
												<select class="filter-select" name="select_local" id="select_local" style="width:75px;" tabindex="-1" aria-hidden="false">
													<option value="1">设置密码</option>
													<option value="0">初始密码</option>												
												</select>
											</div>
										</div>
									</div>
									
									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em><span id="span_pwd">密&nbsp;&nbsp;码</span>：</span>
										<div class="form-c" style="width: 33.3%; position: absolute;">
											<input type="password" class="form-text" id = "sys_u_pwd_new" onkeydown="changepwdsta();" maxlength="64" tabindex="5" style="margin-left: 80px;"><i class="v-check"></i>
										</div>
										<div class="tab-t" style=" width: 9%; position: absolute; margin-left: 290px; margin-top: 1px">
											<div class="ctr">
												<a href="javascript:;" id="btn_pwd" class="btn btn-default btn-normal" onclick="create_pwd()">随机密码</a>
											</div>
										</div>
									</div>
									<div class="form-item" style="margin-left: -5px;">
										<span class="form-tag" style="width: 85px;"><em class="imp">*</em><span id="span_pwd1">确认密码</span>：</span>
										<div class="form-c">
											<input type="password" class="form-text" id = "sys_u_pwd_tr" maxlength="64" onkeydown="changepwdsta();" tabindex="6"><i class="v-check"></i>
										</div>
									</div>
										

									<div class="form-item" style="width: 33.3%;">
										<span class="form-tag">工&nbsp;&nbsp;号：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "UserNumber" maxlength="127" onblur="regCheck(this,/^[a-zA-Z\d_]+$/)" tabindex=""><i class="v-check"></i>
											<p class="form-tip">仅支持英文、数字、下划线</p>
										</div>
									</div>

									<div class="form-item" style="width: 33.3%;">
										<span class="form-tag">部&nbsp;&nbsp;门：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_depart" maxlength="127" tabindex="7"><i class="v-check"></i>
										</div>
									</div>
									
									<div class="form-item">
										<span class="form-tag"><em class="imp" style="display:none;" id="phone_em">*</em>手&nbsp;&nbsp;机：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_phone" onblur="regCheck(this,/^[0-9]{11}$/)" maxlength="11" tabindex="8"><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item" >
										<span class="form-tag"><em class="imp" style="display:none;" id="mail_em">*</em>邮&nbsp;&nbsp;箱：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_email" onblur="regCheck(this,/^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/)" maxlength="127" tabindex="9"><i class="v-check"></i>
										</div>
									</div>
									
									<div class="form-item" id="CertCn_div" style="display:none;">
										<span class="form-tag" style="width: 110px; margin-left: -30px;"><em class="imp">*</em>认证唯一标识：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "CertCn" maxlength="127" tabindex="10"></i>
										</div>
									</div>
									<div class="form-item" style="width:100%" id="action_div">
										<span class="form-tag">操&nbsp;&nbsp;作：</span>
										<div class="form-c">
											<div class="form-label-group" id="">
												<label class="form-label"><input class="form-radio" type="radio" name="user_action" id="user_action1" value="true" checked>角色定义</label>
												<label class="form-label"><input class="form-radio" type="radio" name="user_action" id="user_action2" value="false">角色继承</label>													
											</div>
										</div>
									</div>
									
									<div class="form-item" style="width:100%" id="role_div">
										<span class="form-tag" style=""><em class="imp">*</em>角&nbsp;&nbsp;色：</span>
										<div class="form-c">
											<div class="sel-type2" style="margin-top: -18px;">
												<div class="set-view" id="select_r" style="width: 80%;">
													<div class="sitem" style=" width: 33%;float: left; margin-left: -10px;" >
														<i class="ctrl add" style="margin-left: -132px;display:none;" onclick="_addRole(this)"></i>
														<!-- #####################客户端集合下拉框及添加界面-->
														<div class="g-cont" style="height:28px;">
															<div class="sel-type1" style="" id="select_role_div" style="margin-top: -10px;width:360px">
																<div class="xSelect xSelect_RoleList" id="select_r_xselect"></div>
															</div>
														</div>
														
													</div>
												</div>
											</div>
										</div>
									</div>
									
									<div class="form-item" style="width: 100%;margin-bottom: 15px;" id="admin_div">
										<span class="form-tag" style=""><em class="imp">*</em>管理员：</span>
										<div class="h-content3" id="select_u" style="margin-top: -19px;width:80%;padding: 10px;">
										</div>
									</div>
									<div class="form-item" style="width: 100%;margin-bottom: 15px;" id="auth_div" style="display: none;">
										<span class="form-tag" style="">认证配置：</span>
										<div class="h-content3" id="auth_divs" style="margin-top: -19px;width:80%;padding: 10px 0;">
											<div class="item" style="float: left;width: 16.5%">
												<!-- <select class="filter-select" name="select_pin" id="select_pin" style="width:98px;" tabindex="-1" aria-hidden="false">
													<option value="0">初始密码</option>
													<option value="1">设置PIN码</option>
												</select> -->
												<div class="form-item" id="tokenid_div" style="width:100%; margin-top: -13px;">
													<div class="h-content3" id="TokenID" style="padding: 0;">
													</div>
												</div>
											</div>
											<div class="item" style="float: left;width: 16.5%; display: none;">
												<label class="tab-t" style="" id="totp_reset_div">
													<div class="ctr">
														<a href="javascript:;" class="btn btn-default btn-normal" style="padding: 0 10px;" onclick="qr_code_show();">重置TOTP</a>
													</div>
												</label>
											</div>
											<div class="item" style="float: left;width: 16.5%">
												<div class="tab-t s-hide" style="" id="changepin_div">
													<div class="ctr">
														<a href="javascript:;" id="changePIN" class="btn btn-default btn-normal" onclick="change_PIN()">设置pin码</a>
														<text style="line-height: 27px; margin-left: -5px;">未设置</text>
													</div>
												</div>
											</div>
											<div class="item" style="float: left;width: 16.5%">
												<label class="tab-t" style="" id="FinP_reset_div">
													<div class="ctr">
														<a href="javascript:;" class="btn btn-default btn-normal" style="" onclick="setFinP();">录入指纹</a>
														<text style="line-height: 27px; margin-left: -5px;">未录入</text>
													</div>
												</label>
											</div>
										</div>
										<!-- <div class="item" style="float: left;width: 16.5%">
											<label class="tab-t" style="" id="FinP_reset_div">
												<div class="ctr">
													<a href="javascript:;" class="btn btn-default btn-normal" style="padding: 0 10px;" onclick="setFinP();">录入指纹</a>
													<text style="line-height: 27px; margin-left: -5px;">未录入</text>
												</div>
											</label>
										</div> -->
									</div>

									<!-- test -->
									<!--<div class="form-item" style="width: 100%;margin-bottom: 15px;" id="admin_div">
										<input type="text" class="form-text" onblur="" id="adduser1" maxlength="" style="width: 50px">至
										<input type="text" class="form-text" onblur="" id="adduser2" maxlength="" style="width: 50px">

										<button class="form-button" onclick="_adduser();">批量添加</button>
										<p class="form-tip">起始大于10，不要和之前Code重复</p>
									</div> -->
									<!--  -->
								</div>	
							</div>
						</div>
					</div>
					<div class="c-exp" style="margin: -1px auto;" id="append_div">
						<div class="h-explorer">
							<div class="G-top">
								<div class="G-box1"></div><strong>&nbsp扩展选项</strong>	
							</div>
							<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 14px 0 0 0px;">
								<div class="form-item" style="margin-left: 85px;width: 320px;">
									<span class="form-tag" style="width: 112px;margin-left: -32px;" >第三方认证账号：</span>
									<div class="form-c">
										<input type="text" class="form-text" id = "thirduser" maxlength="19" >
									</div>
								</div>
								
								<div class="form-item" style="display:none">
									<span class="form-tag">改密审批者：</span>
									<div class="form-c">
										<select class="form-select" name="" id="pu_id" style="width:190px">
										</select>
									</div>
								</div>
								<div class="form-item" style="width: 150px;">
									<span class="form-tag" style="width: 113px;" >唯一登录：</span>
									<div class="form-c" style="" >
										<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="" id="uniqueIP"></label>
									</div>
								</div>
								<div class="form-item" style="width: 105px;height: 37px;display:none;">
									<span class="form-tag" style="width: 112px;margin-left: -32px;" >TOTP：</span>
									<div class="form-c" style="" >
										<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="" id="totp_checkbox"></label>
									</div>
								</div>
								<div class="dialog-cont" id="qr_code" style="display:none;max-height:500px">
									<span style="margin-left: 68px;">请使用您的 TOTP 应用扫描二维码</span>
									<div style="text-align:center;">
										<img src="">
									</div>
									<div style="text-align: center;height: 34px;">
										<span>请在下方输入应用中的验证码进行测试。
										</span>
									</div>
									<div style="float:left;margin-left: 57px">
										<input type="text" class="form-text" id="totp_v" style="width:133px;" placeholder="输入验证码" onkeydown="if (event.keyCode == 13){submit_totp();return false;} else return;">
									</div>
									<div class="tab-t">
										<div class="ctr">
											<a class="btn" href="javascript:;" style="margin-left:16px;" onclick="submit_totp();">验证</a>
										</div>
									</div>
								</div>
								<div class="form-item" style="width: 395px;">
									<span class="form-tag" style="width: 113px;">失效时间：</span>
									<div class="form-c" style="" >
										<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="" id="timeSet"></label>
										<div class="bc srItem" style="display: none; float: right; width: 61%;">
											<div class="srSort" id="srTemp-xtime">
												<span class="stwrap">
													<input type="text" style="height: 27px;" id="datepicker" value="" placeholder="日期" class="datepicker" readonly>
													<input type="text" id="shour" style="height: 27px; margin-left: -5px; width: 25px; border-left: 1px solid #AAA; border-radius: 0; text-align: right; margin-top: 1px;" value="" placeholder="时" class="timeinput" min="00" max="23">
													<span class="srTip" style="float: left;">:</span>
													<input type="text" style="height: 27px; margin-top: 1px;" id="smin" value="" placeholder="分" class="timeinput" min="00" max="59">
													<span class="srTip" style="float: left;">:</span>
													<input type="text" style="height: 27px; margin-top: 1px;" id="ssec" value="" placeholder="秒" class="timeinput" min="00" max="59">
												</span>
											</div>
										</div>
									</div>
								</div>

								<div class="form-item" style="margin-left: 52px; width: 93%;">
									<span class="form-tag" style="width: 113px;">客户端登录限制：</span>
									<div class="form-c">
										<div class="sel-type2" style="padding-left: 113px;">
											<div class="set-view set-view1" id="Temp4" style="margin-top: -18px;">
												<div class="sitem" style=" width: 510px;float: left; margin-left: -10px;height:40px" _auth_data="">
													<i class="ctrl add" id="add2" onclick="_addSet4(this)" style="margin-left: 128px;height: 28px; display: none;"></i>
													<select name="" id="IPorMAC" class="select2 " style="width: 120px" onchange="change_limit(this)">
														<option value="1">IP地址</option>
														<option value="2">IP区间</option>
														<option value="3">MAC地址</option>
														<option value="4">MAC地址区间</option>
														<option value="5">客户端集合</option>
													</select>	
													<!-- #####################客户端集合下拉框及添加界面-->
													<div class="g-cont">
														<div class="sel-type1" style="display: none;" id="client_list" style="margin-top: -10px;width:360px">
															<div class="xSelect xSelect_clientList" id="accset"></div>
														</div>
													</div>

													<!-- ######################################## -->
													
													<div class="set-view set-view4" style="display:none; margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width: 302px;" type="text" class="form-text" id="ip_input">
													</div>
													
													<div class="set-view set-view2" id="Temp2" style="display:none; margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width:139px;" type="text" class="form-text" id="start_ip"><span class="fix">-</span>
														<input style="width: 139px;" type="text" class="form-text" id="end_ip">
													</div>

													<div class="set-view set-view3" id="Temp3" style="display:none;margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width: 316px;" type="text" class="form-text" id="mac_input">
													</div>

													<div class="set-view set-view5" style="display:none;margin-top: -10px;width:360px">
														<input style="margin-left:-10px;width:135px;padding: 0px 10px;" type="text" class="form-text" id="start_mac"><span class="fix" style="margin-left: 7px;margin-right: 3px;">-</span>
														<input style="width: 135px;padding: 0px 10px;" type="text" class="form-text" id="end_mac">
													</div>
												</div>
											</div>
											<!-- 添加 -->
										<div class="dialog-cont" id="client_suspend" style="display:none;max-height:500px">
											<div class="container" style="padding: 0px 20px 20px 20px;">
												<div class="c-cont2" style="overflow-x: hidden;">
													<div class="c-form c-form2" style="padding: 0;">
														<div class="h-top" style="width:958px;border-top: 1px solid rgb(204, 204, 204);border-right:1px solid rgb(204, 204, 204);border-left: 1px solid rgb(204, 204, 204);border-bottom: 0px;">
															<div class="form-item" style="padding: 0 0 0 19px;float:left;width:auto;margin:3px;">
																<span class="form-tag" style="float:left;width:auto;">
																	<em class="imp">*</em>名称：</span>
																<div class="form-c" style="float:left;padding-left:0px;">
																	<input type="text" class="form-text" id="c_n" name="c_n" style="width:160px;" maxlength="128" onblur="regCheck(this,nameReg);">
																	<i class="v-check" style="    margin: 7px 0 0 -26px;"></i>
																	<span>特殊字符仅支持下划线、横杠、小数点</span>
																</div>
															</div>
														</div>
														<div class="form form1" style="width:469px; border: 1px solid #ccc; max-height: 300px;overflow: auto; min-height: 300px">
															<div class="c-form c-form-host" style="width: 420px;min-width: 420px;padding-top:0px;">
																<div class="form" style="width:auto;">
																	<div class="form-item form-item-100 " style="width: 461px;font-size:16px;margin-left: -17px;">
																		<span class="form-tag" style="width: 63px;float: left;">IP地址：</span>
																		<div id="ip_n_c1" name="ip_n_c1" class="form-c" style="padding-left: 0px;width: 381px;float: left;" value="0">
																			<span class="ss ss-add" id="ip_span1" value="0" style="float:left;position:static;width:180px;">
																				<input type="text" class="form-text" style="width:123px;padding-right: 8px;">
																				<i class="ctr ctr-add" onclick="_addIp_c1(this);" style="margin-left: 5px;"></i>
																			</span>
																		</div>
																		<span class="form-tag" style="width: 63px;float: left;padding-top: 10px;">IP区间：</span>
																		<div id="ip_n_c" name="ip_n_c" class="form-c" style="padding-left: 0px;width: 381px;float: left;padding-top: 10px;" value="0">
																			<span class="ss ss-add" id="ip_span" value="0" style="float:left;position:static;padding: 0 0 10px 0;width: 340px;">
																				<input type="text" class="form-text" placeholder="起始IP地址" style="width:123px;padding-right: 8px;">
																				<span style="vertical-align:middle;">-</span>
																				<input type="text" class="form-text" placeholder="结束IP地址" style="width:123px;padding-right: 8px;margin-left: -1px;">
																				<i class="ctr ctr-add" onclick="_addIp_c(this);" style="margin-left: 5px;"></i>
																			</span>
																		</div>
																	</div>
																</div>
															</div>
														</div>
														<div class="form form3" style="width:488px;border: 1px solid #ccc;max-height: 300px; min-height: 300px; overflow-x: hidden;border-left: 0px;">
															<div class="c-form c-form-host" style="width:450px;min-width:450px;padding-top:0px;">
																<div class="form">
																	<div class="form-item form-item-100 " style="width: 475px;font-size:16px;margin-left: -15px;">
																		<span class="form-tag" style="width: 85px;float: left;">MAC地址：</span>
																		<div id="MACAddress" name="MACAddress" class="form-c" style="padding-left: 0px;width: 381px;float:left;" value="0">
																			<span class="ss ss-add" value="0" style="float:left;position:static;width: 190px;">
																				<input type="text" class="form-text" maxlength="17" style="width:138px;padding-right: 8px;">
																				<i class="ctr ctr-add" onclick="_addMAC(this)" style=" margin-left: 5px;"></i>
																			</span>
																		</div>
																		<span class="form-tag" style="width: 85px;float: left;padding-top: 10px;">MAC区间：</span>
																		<div id="MACAddress1" name="MACAddress1" class="form-c" style="padding-left: 0px;width: 381px;float:left;padding-top: 10px;" value="0">
																			<span class="ss ss-add" value="0" style="float:left;position:static;padding: 0 0 10px 0;width: 380px;">
																				<input type="text" class="form-text" maxlength="17" placeholder="起始MAC地址" style="width:138px;padding-right: 8px;">
																				<span style="vertical-align:middle;">-</span>
																				<input type="text" class="form-text" maxlength="17" placeholder="结束MAC地址" style="width:138px;padding-right: 8px;margin-left: 1px;">
																				<i class="ctr ctr-add" onclick="_addMAC1(this)" style=" margin-left: 5px;"></i>
																			</span>
																		</div>
																	</div>
																</div>
															</div>
														</div>

														<div class="clearfix"></div>
													</div>
												</div>
											</div>
											<div class="btns">
													<a href="javascript:;" class="btn btn-normal btn-submit">保&nbsp;&nbsp;存</a>
													<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="c-exp" style="margin: -1px auto;display:none;" id="exp_auth" >
						<div class="h-explorer">
							<div class="G-top">
								<div class="G-box1"></div><strong>&nbsp访问授权</strong>	
							</div>
							<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
								<div class="form-item" style="width: 100%; margin-left: -15px;">
									<span class="form-tag" style="width: 180px">访问授权：</span>
									<div class="h-content3" id="select_a" style="margin-top: -19px; width:80%">
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="c-exp" style="margin: -1px auto; margin-bottom: 10px;" id="ug_div">
						<div class="h-explorer" style="min-height: 300px">
							<div class="G-top">
								<div class="G-box1"></div><strong>&nbsp用户组</strong>	
							</div>
							<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
								<div class="h-top" style="background-color: #fff;float: right;/*width: 40%;*/border-bottom:none;">
										<div class="filter" style="float:right;min-width:auto;">
											<div id="waitTip" class="waitTip1" style="float: right;margin-top: 7px; margin-left: -26px;"></div>										
											<div class="search">
												<select name="user_select" id="user_select" class="filter-select">
													<option value="0" selected>所有</option>
													<option value="Name">组名</option>
												</select>

												<input type="text" class="filter-text" placeholder="输入关键字" name="user_text" id="user_text" 
												maxlength="128" style="padding-right: 22px;"
												onchange="if($('#user_text').val()==''){$('#user_text_check').hide();}else{$('#user_text_check').show();}"
												onblur="if($('#user_text').val()=='' && search_user_n!=''){search_user_n='';find_usergroup();}"
												onblur="if($('#user_text').val()=='' && search_user_n!=''){search_user_n='';_addFilter_user(this,false,1);}"
												onkeyup="if($('#user_text').val()==''){$('#user_text_check').hide();}else{$('#user_text_check').show();}"
												onkeydown="if($('#user_text').val()==''){$('#user_text_check').hide();}else{$('#user_text_check').show();};if (event.keyCode == 13){_addFilter_user(this,false);$(this).blur();return false;} else return; ">
												<i class="v-check v-wrong" id="user_text_check" 
											onclick="_clearFilter(this,1)" 
											style="display:none;cursor: pointer;float: left;position: static;"></i>
												<button class="filter-btn" onclick="_addFilter_user(this,false)"><i class="add-filter"></i></button>
												<button class="filter-btn" onclick="_addFilter_user(this,true)"><i class="append-filter"></i></button>
											</div>
											
											<div class="search" id="clearFilter" style="margin: 0px 15px 0px -16px;display:none;">
												<button class="filter-btn" onclick="_clearFilter(this)"><i class="clear-filter"></i></button>
											</div>
											<div class="selector selector-multiple" id="filterWW1" style="display: none;">
												<span class="ww" style="">搜索条件</span>
												<ul style="padding-left: 0px;"></ul>
											</div>
										</div>
									</div>
								<div style="width:59%;height:90%;margin-top: 7px; margin-left: -23px;" id="usertree_div">
									<h2 style="width:180px;text-align: right;color: #333">用户组：</h2>
									<ul id="userTree"  class="hosttree" style="padding-left: 196px;"></ul>
								</div>
							</div>
						</div>
					</div>
				
			<div class="c-exp" style="margin: -1px auto;display:none;" id="transfer_div" >
				<div class="h-explorer">
					<div class="G-top" style="    margin: 10px 0 10px 0;">
						<div class="G-box1"></div><strong>&nbsp;继承对象</strong>	
					</div>
					<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;" >
						<div class="form-item" style="width:100%;">
							<span class="form-tag" style="margin-left:85px;"><em class="imp">*</em>用&nbsp;&nbsp;户：</span>
							<div class="form-c">
								<select class="form-select" name="" id="user_tranfer" style="width:200px" tabindex="7" >
								</select>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="btns">							
				<a href="javascript:;" class="btn btn-normal btn-submit" id="saveUser" onclick="">保&nbsp;&nbsp;存</a>
				<!-- <a href="javascript:;" class="btn btn-normal btn-cancel" onclick="">取&nbsp;&nbsp;消</a> -->
			</div>
			<div id="bBtn" style="position: fixed;z-index:5;">
				<a href="javascript:;" class="btn btn-cancel" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
			</div>
		</div>
	</div>
	<!-- 认证方式浮层 -->
	<div class="dialog-cont" id="authtype_suspend" style="display:none;max-height:500px;min-height:500px;scrolling:yes">
		<iframe src="" width="100%" height="100%" frameborder="0" name="mframe1" id="mframe1" style="    height: 521px;margin-top: -21px;"></iframe>
		<div class="clearfix"></div>
		
	</div>
	
	<!-- 角色浮层 -->
	<div class="dialog-cont" id="role_suspend" style="display:none;max-height:580px;min-height:500px;scrolling:yes">
		<div class="container" style="">
			<div class="c-cont3" style="height: 585px;">
				<div class="c-wrap">
					<div class="form-item form-nm" style = "margin-left: 8px; ">
						<div class="form-tag"><em class="imp">*</em>名&nbsp;&nbsp;称：</div>
						<div class="form-c">
							<input type="text" class="form-text" id = "r_n" maxlength="127" onblur="regCheck(this,/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/)"><i class="v-check"></i>
							<span style="font-size: 12px;">&nbsp;&nbsp;特殊字符仅支持下划线、横杠、小数点</span>
						</div>
					</div>

					<div class="c-box">
						<div class="cb-title">
							<em class="imp"style="color: #F00;font-style: normal;float: left;margin-left: -6px;">*</em>
							<h3>角&nbsp;&nbsp;色</h3>
						</div>

						<div class="cb-cont">
							<table cellpadding="0" cellspacing="0" class="cbtab">
								<tbody>

								</tbody>
							</table>
						</div>
					</div>
					<div class="btns s-hide">
						<a href="javascript:;" class="btn btn-submit btn-normal">保&nbsp;&nbsp;存</a>
						<!--
						<a href="javascript:;" class="btn btn-cancle btn-normal">取&nbsp;&nbsp;消</a>
						-->
					</div>
				</div>
			</div>
		</div>
		
	</div>

	<!-- 修改PIN浮层 -->
	<div class="dialog-cont" id="PINDialog" style="display:none;">
		<div class="container">
			<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
				<div class="c-form c-form-host" style="padding: 0 0 90px;">
					<div class="clearfix"></div>
					<div class="c-table">
						<div class="form">
							<div class="form-item" style="width: 35%;">
								<span class="form-tag" style=""><em class="imp">*</em>新pin码：</span>
								<div class="form-c" style="">
									<input type="password" class="form-text" id="pin_input1" style="width: 100%;" tabindex="1">
								</div>
							</div>
							<div class="form-item" style="width: 35%;margin-left: 140px;">
								<span class="form-tag" style=""><em class="imp">*</em>确认pin码：</span>
								<div class="form-c" style="">
									<input type="password" class="form-text" id="pin_input2" style="width: 100%;" tabindex="1">
								</div>
							</div>
						</div>
						<div class="btns" style="padding: 10px 0 10px;">
							<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
							<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

<div id="avatars" class="avatars">
	<ul>
		<li><a href="javascript:;" class="active" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar1.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar2.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar3.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar4.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar5.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar6.jpg"></a></li>
	</ul>
</div>
<form action="/bhost/u_add" method="POST" name="u_add" id="u_add">
	<input type="hidden" name="se" id = "se" value="" />
	<input type="hidden" name="tasktype1" id = "tasktype1" value="" />
</form>
<style>
	#user_page{
		min-width: 1191px;
	}
	#saveUser {
		outline:none
	}
	.c-form-host .form-item .form-tag {
		width: 8em;
	}
	.c-form-host {
		width: auto;
		min-width: 0;
		font-size: 14px;
		padding: 10px 20px;
	}
	#changePIN:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}
	#changePIN{
		outline:none;		
		float: left;
		padding: 0px 2px;
		line-height: 25px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
		width: 80px;
		text-align: center;	
	}	
	.ui-dialog-body{
		padding: 20px 0 0 0;
	}
	#btn_pwd:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}
	#btn_pwd{
		float: left;
		padding: 0px 5px;
		line-height: 24px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
	}
	.srItem .stwrap input.datepicker, .timeTemp input.datepicker {
		float: left;
		width: 97px;
		border: 0;
		background: transparent;
		text-align: center;
		margin-right: 4px;
	}
	.srItem .stwrap input.timeinput, .timeTemp input.timeinput {
		float: left;
		width: 18px;
		text-align: center;
		vertical-align: middle;
		border: 0;
		padding: 0;
	}
	.srItem {
		width: 61%;
		height: auto;
		line-height: 30px;
		border-bottom: 1px solid #ffffff;
		overflow: hidden;
	}
	.h-content2 .form-item {
		height: auto;
		padding: 20px 0 10px;
		min-height: 38px;
		padding: 5px;
		width: 380px;
		float: left;
	}
	.h-content2 .form-tag {
		float: left;
		width: 80px;
		text-align: right;
		color: #000;
		line-height: 28px;
	}
	.h-content2 .form-c {
		padding-left: 0px;
		position: relative;
	}
	.h-content2 .form-text {
		width: 170px;
	}
	.h-content2 .rzj {
		float: right;
		margin-right: 40px;
		color: #000;
	}
	.h-content2 .form-tip {
		padding-left: 48px;

	}
	a.btn-normal1{
		display: inline-block;
		width: 90px;
		height: 30px;
		border: 1px solid #DDD;
		text-align: center;
		line-height: 32px;
		border-radius: 18px;
		margin: 0 10px;
		background-color: #fff;
		transition: background-color 0.4s;
		color: #7c7c7c;
	}
	a.btn-normal1:hover{
		background-color: #8d808a;
		color: #fff;
	}
	.for-avatar {
		margin-top: -13px;
		margin-left: 5px;
	}
	.col3{
		padding-left: 90px;
		height: auto;
		overflow: hidden;
	}
	.col3 .form-item{
		width: 33.3%;
		padding: 12px 0px 0px 0px;
	}
	.h-content2 .form-tip{
		padding-left: 80px;
	}
	.input-group{
		display: inline-block;
		width: 200px;
		border: 1px solid #b2b2b2;
		border-radius: 5px;
		overflow: hidden;
		vertical-align: middle;
	}
	.input-group input{
		border: 0;
		text-align: center;
		background: transparent;
	}
	.blank_in{width: 12px;}
	
	.set-view li i.ctrl.del {
		display: none;
		position: inherit;
		width: 15px;
		height: 15px;
		background: url(/manage/images/icon-ctr.png) no-repeat 0 0;
		vertical-align: middle;
		margin-left: 5px;
		cursor: pointer;
		margin-top: 0px;
	}
	
	
	.set-view li:hover i.ctrl.del {
		display: inline-block;
	}
	#select_local + .select2-container .select2-selection--single .select2-selection__rendered{
		padding-left:5px;
		padding-right:0px;
	}
	#select_local + .select2-container--default .select2-selection--single .select2-selection__arrow{
		width:13px;
	}

	
</style>
{% endblock  %}

{% block script %}
<script>
var temp4 = $('#Temp4>.sitem:last').clone();
var search_user='';
var search_user_n = '';
var sess = window.parent.document.frm.se.value;
var authDefault_flag = 0;//0->no change; 1-> tokenkey; 2-> change pin code 3-> both;
var auth_class = 0;
var actnu = 0;
var new_pin = "";
var Flag_load = 1;
var group_array = [];
var CREATE_FLAG = true;
$(function(){
	get_AuthType_role();
	Flag_load = 1;
	CREATE_FLAG = true;
	group_array = [];
	global_id = 0;
	$("#user_name").val("");
	$("#sys_u_pwd_new").val(""); // 防止浏览器保存密码时加载页面自动添加账号密码
	get_role_simple();
	getPwdStrategy();
	var now = new Date();
	var setDate = {
		year: now.getFullYear(),
		month: now.getMonth() + 1,
		day: now.getDate()
	}

	$('input.datepicker').each(function(){
		$(this).jeDate({
			format:"YYYY-MM-DD",
			isTime:true,
			minDate:setDate.year + "-" + setDate.month + "-" + setDate.day
		});
	})

	_getDate('#srTemp-time');

	$('.form-checkbox,.form-radio').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
	    radioClass: 'iradio_minimal-blue',
	    increaseArea: '0' // optional
	});
	$('.form-select,.select2,.filter-select').select2({minimumResultsForSearch: -1});
	//get_AuthType();
	$("a.btn-submit").unbind().bind("click",function(){
		//
		savedata();
	});
	$("a.btn-cancel").unbind().bind("click",function(){
		document.frm.tasktype.value = 3;
		document.frm.se.value = sess;
		document.frm.action = '/bhost/index';
		document.frm.i10.value = 1;
		document.frm.submit();
	});

	$('#timeSet').on('ifChecked', function(event){
		$('.bc.srItem').show();
	}).on('ifUnchecked', function(event){
		$('.bc.srItem').hide();
		$('#jedatebox').remove();
	});
	$('.form-time').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
	_get_un(0,true);
	$("#changepin_local").show();//创建时显示设置初始密码	
	var admin_list = [];
	UGroupSet_tmp = [];
	admin_id = $('#select_u select').val();
	if(admin_id != -1){
		admin_list.push(admin_id);
	}
	$('#select_u li.item').each(function(i,item){
		admin_list.push($(this).attr('id'));
	})
	userid_str = admin_list.join(",");//admin_list已选择的管理员	
	//_get_rn(admin_list);
	bind_role_xSelect();
	_get_client();
	_get_tokenid();
	//get_authtype_list();
	bind_authtype_xSelect();
	// $("#un").next().next().click();
	$("#IPorMAC").val(5).trigger('change');
	
	$("input[name=user_action]").on('ifChanged',function(){
		if($('input[name=user_action]:checked').val() == 'true'){
			$('#role_div').show();
			$('#admin_div').show();
			$("#append_div").show();
			var name2 = $('#select_r_xselect').data('value');
			var pwd_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('pwd_flag');
			var access_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('access_flag');
			if(access_flag == '1'){
				$('#exp_auth').show();
			}else{
				//找到所有的 已选的角色
				var a = false
				$('#select_r li.item input').each(function(i,item){
					if($(this).attr('access_flag') == '1'){
						$('#exp_auth').show();
						a = true;
						return false;
					}
				})
				if(!a){
					$('#exp_auth').hide();
				}
			}
			$('#ug_div').show();
			$('#transfer_div').hide();
			$('div.xSelect-view[data-id=xSelect-role]').hide();
			$('div.xSelect-show[data-id=xSelect-role]').removeClass('on');
			$('#un').select2('destroy');
			$('#un').select2();
	
		}else{
			$('#role_div').hide();
			$('#role_div').hide();
			$('#admin_div').hide();
			$("#append_div").hide();
			$('#exp_auth').hide();
			$('#ug_div').hide();
			$('#transfer_div').show();
			$('div.xSelect-view[data-id=xSelect-role]').hide();
			$('div.xSelect-show[data-id=xSelect-role]').removeClass('on');
			$('#un').select2('destroy');
			$('#un').select2();
			//获取继承的用户
			get_tranuser();
		}
	})
	_get_an();

	bind_client_xSelect();
	$("#totp_v").on("input propertychange",function(){
		this.value = this.value.replace(/\D/g, "");
	}).on("paste",function(){return false});
	$("#select_pin").bind('change',function(){
		if($(this).val() == '0'){
			$('#span_pwd').html("初始密码");
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();		
		}else{
			if(global_flag_pwd == '3'){ //只有usbkey
				$('#span_pwd').html("密&nbsp;&nbsp;码");
				$('#sys_u_pwd_new').attr('disabled',true);
				$('#sys_u_pwd_tr').attr('disabled',true);
				$('#btn_pwd').parent().hide();
			}else{ 
				$('#span_pwd').html("密&nbsp;&nbsp;码");
				$('#sys_u_pwd_new').attr('disabled',false);
				$('#sys_u_pwd_tr').attr('disabled',false);
				$('#btn_pwd').parent().show();
			}
		
			change_PIN();
		}
		$('#sys_u_pwd_new').val('');
		$('#sys_u_pwd_tr').val('');
	});

	$("#select_local").bind('change',function(){
		if($(this).val() == '0'){
			$('#span_pwd').html("初始密码");
			if(($("#changepin_div").find("text").is(":visible") && $("#changepin_div").find("text").text() == "未配置") || ($("#FinP_reset_div").find("text").is(":visible") && $("#FinP_reset_div").find("text").text() == "未录入") || $("#auth_div").is(":visible") == false){ //存在未配置 或者 未录入
				$('#sys_u_pwd_new').attr('disabled',false);
				$('#sys_u_pwd_tr').attr('disabled',false);
				$('#btn_pwd').parent().show();
			}else{
				$('#sys_u_pwd_new').attr('disabled',true);
				$('#sys_u_pwd_tr').attr('disabled',true);
				$('#btn_pwd').parent().hide();
			}
		}else{
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
			$('#span_pwd').html("密&nbsp;&nbsp;码");
		}
		/*if(($("#changepin_div").find("text").is(":visible") && $("#changepin_div").find("text").text() == "未配置") || ($("#FinP_reset_div").find("text").is(":visible") && $("#FinP_reset_div").find("text").text() == "未录入")){ //存在未配置 或者 未录入
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}else{
			$('#sys_u_pwd_new').attr('disabled',true);
			$('#sys_u_pwd_tr').attr('disabled',true);
			$('#btn_pwd').parent().hide();
		}*/
	});
	$("#select_local").val("1").trigger('change');
	
})

$(document).on('keydown','input.timeinput',function(){
	var i = $(this).index();        
	var v = $(this).val();
	v = v.replace(/[^\d]/g,'');
	$(this).val(v);
}).on('keyup','input.timeinput',function(e){
	var i = $(this).index();
	var v = $(this).val();    
	var max = 23;
	if(i>1){
		max = 59;
	}

	if(v > max){
		v = max;
	}

	$(this).val(v);

	v = v.toString();
	if(v.length >= 2){
		$(this).val(v.substring(0,2));

		var keycode = e.keyCode;
		if(keycode != 9){
			$(this).next().next().focus();
		}
	}
}).on('focus','input.timeinput',function(){
	$(this).select();
}).on('blur','input.timeinput',function(){
	var v = $(this).val();
	v = v.toString();

	if(v == ''){
		v = '00';
	}else if(v.length == 1){
		v = '0' + v;
	}

	$(this).val(v);
});
function change_name(){
	if($('#user_name').val()=="") {
		$('#user_name').val($('#sys_u_name').val());
	}
}
//12-8更改时间插件
function _getDate(obj) {
	var now = new Date();
	var setDate = now.getTime();
	setDate = new Date(setDate);
	var month = (setDate.getMonth() + 1).toString();
	var day =  setDate.getDate().toString();

	if(month.length == 1){
		month = '0' + month;
	}

	if(day.length == 1){
		day = '0' + day;
	}
	setDate = {
		year: setDate.getFullYear(),
		month: month,
		day: day
	}
	setDate = setDate.year + '-' + setDate.month + '-' + setDate.day;
	$('input.datepicker').each(function(i,item){
		if(i==0){
			$(item).val(setDate);
			$(item).parent().find('input.timeinput').val('00');
		}else if(i==1){
			$(item).val(setDate);
			$(item).parent().find('input.timeinput').each(function(i){
				if(i == 0){
					$(this).val('23');
				}else{
					$(this).val('59');
				}
			})
		}
	});
}
//1.17增加pin码更改
function change_PIN(){
	$("#pin_input1").val('');
	$("#pin_input2").val('');
	var $dialogCont = $("#PINDialog").show();
	var title = 'PIN设置';
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"PINDialog",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		$("#pin_input1").val('');
		$("#pin_input2").val('');
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if($("#pin_input1").val() == ""){
			_alert(1,"系统用户","请输入新pin码",$("#pin_input1"));
			return false;
		}
		if($("#pin_input1").val() != $("#pin_input2").val()){
			_alert(1,"系统用户","两次pin码不匹配",$("#pin_input1"));
			return false;			
		}
		if($("#pin_input1").attr('maxlength') > 0){
			if($("#pin_input1").val().length != parseInt($("#pin_input1").attr('maxlength'))){
				_alert(1,"系统用户","pin码长度不正确("+$("#pin_input1").attr('maxlength')+"位)",$("#pin_input1"));
				return false;
			}		
		}
		///调用插件
		//flag == 1 edit user  flag == 0 create user
		new_pin = $("#pin_input1").val();
		KEY_SET = true;
		$("#changepin_div").find('text').text("已配置");
		if($("#select_local").val() == "0" && $("#select_local").prop('disabled') == true){
			$("#select_local").val('0').trigger('change');
		}else{
			$("#select_local").val('1').trigger('change').attr("disabled",true);
		}
		d.close().remove();
	})
}
function repeat_get_usb_status(sesstime){
	var st = 0;
	$.ajax({
		url: "/bhost/repeat_get_usb_status",
		type:"POST",
		async:false,		
		data:{a0:sess,z1:sesstime},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				st = result.info;
			}else{
				_alert(1,"系统用户",result.ErrMsg);
				return false;
			}
		}
	})
	return st;
}
var loadLayer =0;
function _showLoading(text){
	var st = text || "";
	loadLayer = layer.open({
		title:false,
		closeBtn:false,
		content:'<div id="Loading">'+st+'</div>',
		btn:false,
		skin:'loadingbar',
		area:['150px','180px'],
		move:false,
		resize:false,
		isOutAnim: false,
		shade:[0.1,'#000']
	})
}

function _closeLoading(){
layer.close(loadLayer);
}

var accdata;
var c_index_all = [];
function binding_clientset() {
	$.ajax({
		url:'/bhost/get_clientset_z',
		type:'post',
		async:false,
		data:{a0: sess},
		success:function(result){
			accdata = JSON.parse(result);
		}
	});
}
//绑定客户端集合
function bind_client_xSelect(){
	$('#accset').empty().data('xSelect','');
	binding_clientset();
	var client_array = [];
	c_index_all = [];
	$.each(accdata.data,function(i,item){
		if ($("#accset").data('value') == item.ClientScopeId){
			
		}else{
			if (client_list.indexOf(item.ClientScopeId) > -1){
				return true;
			}
		}
		var select_data_json = {
			'value':1,
			'name':'admin2',
			'type':'edit'
		};
		select_data_json.value = item.ClientScopeId;
		select_data_json.name = item.ClientScopeName;
		client_array.push(select_data_json);
		c_index_all.push(item.ClientScopeId);
	});
	$('#accset').xSelect({
		width: 334,
		defaultText: '请选择',
		items:client_array,
		module_type:'client',
		edit: function(item,obj){
			$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
			_editNode2(obj,1);
		},
		btn:[
			{
				'name':'新增',
				'event': function(items,obj){
					_editNode2(obj,2);
				}
			}
		],
		setval:function(item,obj){
			//change_client_scope(obj);
		}
	});
}
function change_client_scope(obj){
	var t = $(obj).find('span').data('value');
	if (client_list.indexOf(t) === -1 && t != undefined) {
		client_list.splice(0, 1, t);
	}
	if ($(obj).parent('ul').children('li').length == 2 && t != '-1') {
		$('#accset').next('i.add').click();
		$('#accset').hide();
	}
}
function submit_totp(){
	var totp_v = $("#totp_v").val();
	if (totp_v == ""){
		$(".layui-layer-btn0").blur();
		_alert(1,"系统用户","验证码不正确",$("#totp_v"));
		return false;
	}
	
	$.ajax({
		url: "/bhost/test_qrcode",
		type: "POST",
		async: true,
		data: {a0:sess,z1:totp_v,z2:secret},
		success: function (result) {
			if (result == "true"){
				$(".layui-layer-btn0").blur();
				layer.open({
					type:1,
					title:"系统用户",
					content:'<div class="layer-alert"><i class="alert succ"></i>验证成功</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						d_qrcode.close().remove();
						user.SecretKey = secret;
						
						var msstr = aceg(JSON.stringify(user),sess);
						var msstr1 = aceg(JSON.stringify(AccessSet),sess);
						$.ajax({
							url:'/bhost/add_sys_user',
							type:"POST",
							async:true,
							data:{a0:sess,a1:JSON.stringify(user),a2:JSON.stringify(AccessSet),a3:"",a4:repeat,a10:"运维管理>系统用户",m1:msstr,m2:msstr1},
							//contentType: 'application/json',
							success: function(Result) {
								data = JSON.parse(Result);
								if (data.Result){
									layer.open({
										type:1,
										title:"系统用户",
											content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
										btn:'确&nbsp;&nbsp;定',
										btnAlign:'c',
										closeBtn: false,
										skin:'layer-custom',
										area:['380px','310px'],
										move: false,
										resize: false,
										btn1:function(i){
											layer.close(i);
											document.frm.tasktype.value = 3;
											document.frm.se.value = sess;
											document.frm.action = '/bhost/index';
											document.frm.i10.value = 1;
											document.frm.submit();
										}
									});
									return false;
								}
								else{
									_alert(1,"系统用户",data.ErrMsg);
								}
							}
						})
						//savedata();
					}
				});
				return false;
			}else{
				$(".layui-layer-btn0").blur();
				_alert(1,"系统用户","验证失败",$("#totp_v"));
				return false;
			}
		}
	});
}

var secret;
var d_qrcode;
function qr_code_show(){
	var account_name = $("#sys_u_name").val();
	$.ajax({
		url: "/bhost/get_qrcode_img",
		type: "POST",
		async: true,
		data: {a0:sess,z1:account_name},
		success: function (result) {
			var result = JSON.parse(result);
			secret = result.secret;
			$("#qr_code").find('img').attr('src',result.img);
		}
	});
	var $dialogCont = $("#qr_code").show();
	
	d_qrcode = dialog({
		title:"TOTP",
		content:$dialogCont,
		id:"qr_code",
		width:"368px",
	}); 
	d_qrcode.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d_qrcode.showModal();
	$("#qr_code").parents(".ui-dialog-body").css("padding","20px 0px 20px 0px");
	$("#totp_v").val('');
	$('.ui-popup.ui-popup-modal.ui-popup-show.ui-popup-focus').css("top","65px");
}

function back(){
	document.frm.tasktype.value = 3;
	document.frm.se.value = sess;
	document.frm.action = '/bhost/index';
	document.frm.i10.value = 1;
	document.frm.submit();
}

function g_tsel(obj){
	var this_class=$(obj).attr('class');
	if(this_class=='g-tsel'){
		$('#accset').focus().select();
		_autoView($(obj).children(),4,3);
	}
}

//获取 继承用户列表
function get_tranuser(){
	loginusercode = $('input[name=us]').val();
	$.ajax({
		url: '/bhost/GetTransUser',
		type: "POST",
		async: true,
		data: { a0:sess, a1:loginusercode, a2:''},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result) {
				tranuser_list  = result.info;
				$('#user_tranfer').empty().append('<option value="">请选择</option>');
				$(tranuser_list).each(function(i,item){
					$('#user_tranfer').append('<option value="'+item.UserId+'">'+item.UserCode+'</option>');
				})
				$('#user_tranfer').val('').trigger('change');
			}
		}
	})
	$('#user_tranfer').select2();
}

function _addFilter_user(obj,type,flag) {		// 0 -> 只是搜索   1-> 添加条件
	var nameReg = /^[A-Za-z0-9_-]+$/;
	var id = $(obj).parent().children('select').children('option:selected').val();
	var v1 = $(obj).parent().children('select').children('option:selected').text();
	var v2 = $(obj).parent().children('input[type=text]').val().trim();
	_getWait($("waitTip1"));
	if (id == "0") {
		// $('#filterWW1>ul').empty();
		// search_user = "";
		// search_user_n = "";
		// $(obj).parent().children('input[type=text]').val('');
		// $("#filterWW1").attr("style", "display:none;");
		// selView_user();
		// return false;
		v1='';
	}else{
		v1=v1+'-';
	}
	if (v2 == '' && flag != 1) {
		$("#user_text").focus();
		_alert(2, '搜索', '请输入关键字',$("#user_text"));
		return false;

	}else{
		if(search_user.indexOf(id+'-'+v2+'\t')>=0){
			$("#user_text").focus();
			_alert(2,'搜索','相同的搜索条件已存在',$("#user_text"));
			return false;
		}
		// if(id=='Name' && !nameReg.test(v2)){
		// 	$("#user_text").focus();
		// 	_alert(1,'搜索','搜索条件格式不正确',$("#user_text"));
		// 	return false;
		// }
		if(type == false){
			if(flag!=1) search_user_n = v1+v2;
			selView_user();
		}else{
			var search_typeall=search_user;
			search_typeall=search_typeall+id+'-'+v2+'\t';
			search_user = search_typeall;
			search_user_n = "";
			$('#filterWW1>ul').append('<li style="height: 18px;"><span style = "display:none;">' + id+'-'+v2 + '</span><span style="" class="ww">' + v1  + v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter_user(this);"></i></li>')
			$("#user_text").val("");
			$('#user_text_check').hide();
			selView_user();
		}
	}
}
function _delFilter_user(obj) {
	var id = $(obj).parent().find("span");
	var ids=$(id).eq(0).text();
	var v2_text = $(id).eq(1).text();
	var v2_str=v2_text.split("-");
	var search_typeall=search_user;
	v2_str[0]="";
	var str_v2=v2_str.join('-');
	var str = ids+'-'+str_v2.substr(1,str_v2.length);
	var search_str="";
	var search_typeall_str = search_typeall.split("\t");
	var i2=0;
	$.each(search_typeall_str,function(i,item){
		if (i2==0 && item==ids){
			i2=1;
		}else if(item!=""){
			search_str=search_str+item+'\t';
		}
	})
	search_user = search_str;
	$(obj).parent().remove();
	_getWait($("waitTip1"));
	selView_user();
}
function _clearFilter(obj,num){
	if(num==1){
	$('#user_text').val('');
	$('#user_text_check').hide();
	search_user_n='';
	selView_user();
	return;
	}
	$('#clearFilter').next().children('ul').empty();
	$('#user_text').val('');
	$('#user_text_check').hide();
	$('#clearFilter').hide();
	search_user='';
	search_user_n='';
	selView_user();
}
function selView_user() {
	var $sel = $('#filterWW1');
	var len = $('li',$sel).length;

	if (len == 0) {
		$sel.hide();
		_waitDone($(".waitTip1"));
		$('#clearFilter').hide();
	} else if (len == 1) {
		$("#filterWW1").show();
		$('>span.ww', $sel).show();
		$('#clearFilter').show();
		$sel.addClass('selector-multiple');
	} else {
		$("#filterWW1").show();
		$('>span.ww', $sel).show();
		$sel.addClass('selector-multiple');
	}
	find_usergroup();
}

//返回第一个标红处
function scrollTop_check(){
	$('.c-cont').scrollTop(0);
	if(data_array_Path.length!=0){
		var top=9999;
		$.each(data_array_Path,function(i,item){
			if(item.Type==1){
				var top_item=$('#node-'+item.Id).offset().top;
				if(top_item<top){
					top=top_item;
				}
			}
		});
		$('.c-cont').scrollTop(top+400);
	}
}

var user = {
	"LoginUserCode": '{{us}}',	
	"UserId": 0,
	"UserCode": "",
	"UserName": "",
	"Password": "", 
	"Department": null, 
	"MobilePhone": null,
	"Email": null,
	"Description": null,
	"ExpireTimeEnabled": false,
	"ExpireTime": "", 
	"UserStatus": 1,
	"PhotoIcon": null,
	"CreatorId": 1,
	"ThirdUserCode": "",
	"ManageIPUnlimited": false,
	"SrcIPUnlimited": false,
	"AuthTypeId": null,
	//"TokenId": "",
	"LanCode": 0,
	"PwdApproveUserId": null,
	"LoginUniqueIP": false,
	"OldPassword":null,
	"AdminSet": [
	],
	"UGroupSet": [
	],
	"RoleSet": [
	],
	"ManageAuthSet": [       	
	],
	"SecretKey":null
};

var AccessAuthSet = {
	"UserId": 0, 
	"AccessAuthSet": [
	]
}
var photo = "avatar1.jpg";

//
var PwdStrategy;
function getPwdStrategy(){
	$.ajax({
		url:'/bhost/get_pwdstrategy',
		type:"POST",
		async:true,
		data:{a0:sess},
		success: function(Result) {
			data = JSON.parse(Result);
			PwdStrategy = data.info;
		}
	})
}
function changepwdsta(){
	$("#sys_u_pwd_new").attr("type","password");
	$("#sys_u_pwd_tr").attr("type","password");
}
//生成密码
function create_pwd(){
	$("#sys_u_pwd_new").val("");
	$("#sys_u_pwd_tr").val("");
	$("#sys_u_pwd_new").attr("type","text");
	$("#sys_u_pwd_tr").attr("type","text");	
	var length = 0;
	var chars = '';
	var len = 0;
	var pw='';
	if(PwdStrategy.PwdMinLen){
		length = PwdStrategy.PwdMinLen;
	}else{
		length = 6;	
	}
	if(PwdStrategy.IfPwdComplex){
		if(PwdStrategy.IfPwdIncLowerApha){
			len ++;
			chars += 'abcdefghijklmnopqrstuvwxyz';
			var str = 'abcdefghijklmnopqrstuvwxyz';
			pw += str[Math.floor(Math.random() * str.length)];
		};
		if(PwdStrategy.IfPwdIncUpperApha){
			len ++;
			chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			var str = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			pw += str[Math.floor(Math.random() * str.length)];
		};
		if(PwdStrategy.IfPwdIncNumber){
			len ++;
			chars += '0123456789';
			var str = '0123456789';
			pw += str[Math.floor(Math.random() * str.length)];
		};
		if(PwdStrategy.IfPwdIncSpecialChar){
			len ++;
			chars += '!#$%&*+-=?@^_~';
			var str = '!#$%&*+-=?@^_~';
			pw += str[Math.floor(Math.random() * str.length)];
		}
	}else{
		chars += 'abcdefghijklmnopqrstuvwxyz';
		chars += '0123456789';
	}
	
	chars = chars.split('');
	for(var i = 0; i < length-len; i++)
		pw += chars[Math.floor(Math.random() * chars.length)];
	
	pw = pw.split('');
	pw.sort(function(){return Math.random()>0.5?-1:1;});
 	pw = pw.join('');
	
	$("#sys_u_pwd_new").val(pw);
	$("#sys_u_pwd_tr").val(pw);
}

//检查格式
function dataCheck(obj, min, max){//min can not bigger than 1
	obj.value = obj.value.replace(/\D/g, "");
	if(min){
		if(parseInt(obj.value, 10) < parseInt(min, 10)) obj.value = min;
	}
	if(max){
		if(parseInt(obj.value, 10) > parseInt(max, 10)) obj.value = max;
	}
}

function IDCheck(obj){
	var IDReg = /^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check');

	if(IDReg.test(val) && val.length > 1){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}

function nameCheck(obj){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check');

	if(nameReg.test(val)){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}
function phoneCheck(obj){
	var phoneReg = /^[0-9]{11}$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check')

	if(phoneReg.test(val) || val == ""){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}
function emailCheck(obj){
	var emailReg = /^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check')

	if(emailReg.test(val) || val == ""){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}
//提交数据
function _compare_ip(x,y){
	var ip1 = x.split('.');
	var ip2 = y.split('.');
	var i1 = 0;
	var ip1_str = "";
	var ip2_str = "";
	for (var i1 = 0; i1 < 4; i1++){
		if (ip1[i1] < 10){
			ip1[i1] = "00"+ip1[i1];
		}else if (ip1[i1] < 100){
			ip1[i1] = "0"+ip1[i1];
		}else{
			
		}
		ip1_str = ip1_str + ip1[i1];
		if (ip2[i1] < 10){
			ip2[i1] = "00"+ip2[i1];
		}else if (ip2[i1] < 100){
			ip2[i1] = "0"+ip2[i1];
		}else{
			
		}
		ip2_str = ip2_str + ip2[i1];
	}
	if (ip1_str == ip2_str){
		return 3;
	}else if (ip1_str > ip2_str){
		return 2
	}else{
		return 3;
	}
}
function _jScrollBar(scid) {
	var myBar = new MyScrollBar({
		selId:scid,
		hasX:true,
		hasY:false,
		width:6,
		// enterShow:false,
	})
}
var repeat;
var AccessSet;
function savedata(){
	var IDReg = /^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/;
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var UserNumberReg = /^[a-zA-Z\d_]+$/;
	var phoneReg = /^[0-9]{11}$/;
	var emailReg = /^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/;
	var sys_u_name = $("#sys_u_name").val();
	var UserNumber = $("#UserNumber").val().trim();
	var user_name = $("#user_name").val();
	var sys_u_pwd_new = $("#sys_u_pwd_new").val();
	var sys_u_pwd_tr = $("#sys_u_pwd_tr").val();
	var thirduser = $("#thirduser").val();
	var sys_u_depart = $("#sys_u_depart").val();
	var sys_u_phone = $("#sys_u_phone").val();
	var sys_u_email = $("#sys_u_email").val();
	var sys_u_descr = $("#sys_u_descr").val();
	//var sys_u_authtype = $("#sys_u_authtype").val();
	sys_u_authtype = global_auth == -1 ? null:global_auth;
	var timeSet = $("#timeSet").val();
	var date = $("#datepicker").val();
	var hour = $("#shour").val();
	var min = $("#smin").val();
	var sec = $("#ssec").val();
	var bdiusr = $("#bdiusr").val();
	var manaip = $("#manaip").val();
	var iplimited = $("#iplimited").val();	
	var pwdApproveUserId = $("#pu_id").val();
	if(sys_u_name == ""){
		_alert(2,"系统用户","请输入账号",$('#sys_u_name'));
		return false;
	}
	if(!IDReg.test(sys_u_name)){
		_alert(1,"系统用户","账号格式不正确",$('#sys_u_name'));
		return false;
	}
	if(user_name == ""){
		_alert(2,"系统用户","请输入姓名",$('#user_name'));
		return false;
	}
	if(!nameReg.test(user_name)){
		_alert(1,"系统用户","姓名格式不正确",$('#user_name'));
		return false;
	}
	if(UserNumber != "" && !UserNumberReg.test(UserNumber)){
		_alert(1,"系统用户","工号不正确",$('#UserNumber'));
		return false;
	}else if(UserNumber==''){
		UserNumber=null;
	}
	if(sys_u_pwd_new == "" && $('#sys_u_pwd_new').attr('disabled') != 'disabled'){
		_alert(2,"系统用户","请输入"+$("#span_pwd").text().replace('&nbsp;&nbsp;','').replace(' ',''),$('#sys_u_pwd_new'));
		return false;
	}
	if(sys_u_pwd_new != sys_u_pwd_tr){
		_alert(1,"系统用户","两次密码不匹配",$('#sys_u_pwd_new'));
		return false;
	}

	if (!PwdStrategy.PwdMinLen) PwdStrategy.PwdMinLen = 6;
	if(sys_u_pwd_new.length<PwdStrategy.PwdMinLen && $('#sys_u_pwd_new').attr('disabled') != 'disabled'){
		_alert(1,"系统用户","密码长度必须大于或等于"+PwdStrategy.PwdMinLen+"位",$('#sys_u_pwd_new'));
		return false;
	}
	if(sys_u_pwd_new.length > 64){
		_alert(2, "系统用户", "密码不能超过系统限定64位", $("#sys_u_pwd_new"));
		return false;
	}
	if(PwdStrategy.IfPwdComplex && $('#sys_u_pwd_new').attr('disabled') != 'disabled'){
		if(PwdStrategy.IfPwdIncLowerApha){
			var now=sys_u_pwd_new.search(/[a-z]/);
			if(now==-1){_alert(1,"系统用户","密码中请包含小写字母",$('#sys_u_pwd_new'));return false;}
		}
		if(PwdStrategy.IfPwdIncUpperApha){
			var now=sys_u_pwd_new.search(/[A-Z]/);
			if(now==-1){_alert(1,"系统用户","密码中请包含大写字母",$('#sys_u_pwd_new'));return false;}
		}
		if(PwdStrategy.IfPwdIncNumber){
			var now=sys_u_pwd_new.search(/[0-9]/);
			if(now==-1){_alert(1,"系统用户","密码中请包含数字",$('#sys_u_pwd_new'));return false;}
		}
		if(PwdStrategy.IfPwdIncSpecialChar){
			var now=sys_u_pwd_new.search(/[^A-Za-z0-9]/);
			if(now==-1){_alert(1,"系统用户","密码中请包特殊字符",$('#sys_u_pwd_new'));return false;}
		}
	}
	
	if($('#phone_em').is(':hidden') ==false){
		if(sys_u_phone == ''){
			_alert(1,"系统用户","请输入手机",$('#sys_u_phone'));
			return false;
		}
	}
	if(!phoneReg.test(sys_u_phone) && sys_u_phone != ""){
		_alert(1,"系统用户","手机格式不正确",$('#sys_u_phone'));
		return false;
	}
	
	if($('#mail_em').is(':hidden') ==false){
		if(sys_u_email == ''){
			_alert(1,"系统用户","请输入邮箱",$('#sys_u_email'));
			return false;
		}
	}
	
	if(!emailReg.test(sys_u_email) && sys_u_email != ""){
		_alert(1,"系统用户","邮箱格式不正确",$('#sys_u_email'));
		return false;
	}
	if($("#ti").is(':visible') == true && $("#ti").val() == -1){
		_alert(1,"系统用户","请选择令牌");
		return false;		
	}

	//设置密码情况下 存在未配置的认证配置时 提示录入或者设置pin
	if($("#select_local").val() == 1 && $('#sys_u_pwd_new').attr('disabled') != 'disabled'){
		if($("#changepin_div").find("text").is(":visible") && $("#changepin_div").find("text").text() == "未配置"){
			if($("#select_local").val() == 0 && $("#sys_u_pwd_new").val() != ""){//初始密码

			}else{
				_alert(2,"系统用户","请设置Pin码");
				return false;
			}
		}
		if($("#FinP_reset_div").find("text").is(":visible") && $("#FinP_reset_div").find("text").text() == "未录入"){
			if($("#select_local").val() == 0 && $("#sys_u_pwd_new").val() != ""){//初始密码

			}else{
				_alert(2,"系统用户","请录入指纹");
				return false;
			}
		}
	}
	/*if($("#changepin_div").is(':visible') == true && $('#select_pin').val() == '1'){
		new_pin = sys_u_pwd_new;
	}*/
	
	//是否是 继承用户
	if($('input[name=user_action]:checked').val() == 'false'){ //继承用户
		if($('#user_tranfer').val() == ""){
			_alert(2,"系统用户","请选择要继承的用户");
			return false;
		}
		user.UserCode = sys_u_name;
		user.UserName = user_name;
		user.Password = sys_u_pwd_new;
		user.Department = sys_u_depart;
		user.MobilePhone = sys_u_phone;
		user.Email = sys_u_email;
		user.Description = sys_u_descr;
		user.AuthTypeId = (sys_u_authtype == 'null'?null:sys_u_authtype);
		var msstr = aceg(JSON.stringify(user),sess);
		$.ajax({
			url:'/bhost/TransferAuthority',
			type:"POST",
			async:true,
			data:{a0:sess,a1:JSON.stringify(user),a2:$('#user_tranfer').val(),a3:true,a10:"运维管理>系统用户",m1:msstr},
			//contentType: 'application/json',
			success: function(Result) {
				data = JSON.parse(Result);
				if (data.Result){
					layer.open({
						type:1,
						title:"系统用户",
						content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
						btn:'确&nbsp;&nbsp;定',
						btnAlign:'c',
						closeBtn: false,
						skin:'layer-custom',
						area:['380px','310px'],
						move: false,
						resize: false,
						btn1:function(i){
							layer.close(i);
							document.frm.tasktype.value = 3;
							document.frm.se.value = sess;
							document.frm.action = '/bhost/index';
							document.frm.i10.value = 1;
							document.frm.submit();
						}
					});
					return false;
				}
				else{
					_alert(1,"系统用户",data.ErrMsg);
				}
			}
		})
		return false;
	}
		
	
	if(thirduser != "" ){
		if(!IDReg.test(thirduser) || thirduser.length == 1){
			_alert(1,"系统用户","第三方认证账号格式不正确",$('#thirduser'));
			return false;
		}
	}
	time = date+" "+hour+":"+min+":"+sec;
	if(date=="" || hour=="" || min=="" || sec=="") time = "";
	if (time == "" && $("#timeSet").prop("checked")){
		_alert(2,"系统用户","请输入完整时间",$('#datepicker'));
		return false;
	}

	
	var RoleSet = [];
	var AdminSet = [];
	AccessSet = {
		"UserId": 0, 
		"AccessAuthSet": [
		]
	}
	role_id_tmp = $('#select_r_xselect').data('value')
	if(role_id_tmp != -1 && role_id_tmp!=undefined){
		var admin = '{"RoleId":'+role_id_tmp+'}';
		admin = JSON.parse(admin);
		RoleSet.push(admin);
	}
	
	$('#select_r li.item').each(function(i,item){
		var admin = '{"RoleId":'+$(this).attr('id')+'}';
		admin = JSON.parse(admin);
		RoleSet.push(admin);
	})
	if(RoleSet.length == 0){
		_alert(2,"系统用户","请添加角色");
		return false;
	}

	$.each(user_arry,function(i,item){
		if (item != '-1'){
			var admin = '{"AdminId":'+item+'}';
			admin = JSON.parse(admin);
			AdminSet.push(admin);
		}
	});
	if(AdminSet.length == 0){
		_alert(2,"系统用户","请添加管理员");
	 	return false;
	 }

	$.each(auth_arry,function(i,item){
		if (item != '-1'){
			var auth = '{"AccessAuthId":'+item+'}';
			auth = JSON.parse(auth);
			AccessSet.AccessAuthSet.push(auth);
		}
	});


	if($("#timeSet").prop("checked") == true){
		timeSet = true;
	}
	else{
		timeSet = false;
	}
	bdiusr = false;
	
	manaip = false;
	// --------------------------------------------------------------------	

	// p = $(".sitem:first").children("i");
	IPList = {"IPSetId":0,"Set":[]};
	MACList = {"MACSetId":0,"Set":[]};
	CScopeSet =[];
	client_list = [];
	var flag_ip_mac = 0;
	$.each($("#Temp4").find('i'),function(i,item){
		var m = $(item).parent().find('input').not('input:hidden').val();
		if(i == 0 && m == ""){
			return true;		
		}else{
			var obj = $(item);
			var type = $(obj).parent().children('select').find('option:selected').val();
			
			var add = 0;
			if (type == 1 || type == 2){
				if (type == 2){
					var start_ip = $(obj).parent().find('input').not('input:hidden').eq(0).val();
					var end_ip = $(obj).parent().find('input').not('input:hidden').eq(1).val();
					if (start_ip == "" && i != 0 && end_ip != ""){
						_alert(2,"系统用户","请输入起始IP地址",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (end_ip == "" && start_ip != ""){
						_alert(2,"系统用户","请输入终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					if (!ipcheck_route.test(start_ip)){
						_alert(1,"系统用户","起始IP地址格式不正确",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (!ipcheck_route.test(end_ip)){
						_alert(1,"系统用户","终止IP地址格式不正确",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					var a = _compare_ip(start_ip,end_ip);
					if (a != 3){
						_alert(1,"系统用户","起始IP地址不能大于或等于终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view2').not('.set-view.set-view2:hidden').each(function(i,item){
						if ($(item).find('input').not('input:hidden').eq(0).val() == start_ip && $(item).find('input').not('input:hidden').eq(1).val() == end_ip){
							add = 1;
							_alert(1,"系统用户","已存在相同IP区间",$(obj).parent().find('input').not('input:hidden').eq(0));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(1,start_ip,end_ip);
				}else{
					var start_ip = $(obj).parent().find('input').not('input:hidden').val();
					var end_ip = start_ip;
					if (start_ip == "" && i != 0){
						_alert(2,"系统用户","请输入IP地址",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					if (!ipcheck_route.test(start_ip)){
						_alert(2,"系统用户","IP地址格式不正确",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view4').not('.set-view.set-view4:hidden').each(function(i,item){
						if ($(item).find('input').not('input:hidden').val() == start_ip){
							add = 1;
							_alert(1,"系统用户","已存在相同IP地址",$(obj).parent().find('input').not('input:hidden'));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(1,start_ip,end_ip);
				}
			}else{
				if (type == 3 ){
					var mac_input = $(obj).parent().find('input').not('input:hidden').val().trim();
					if (mac_input == "" && i != 0){
						_alert(2,"系统用户","请输入MAC地址",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					if (!MACReg.test(mac_input)){
						_alert(1,"系统用户","MAC地址格式不正确",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view3').not('.set-view.set-view3:hidden').each(function(i,item){
						if (mac_input == $(item).find('input').not('input:hidden').val().trim()){
							add = 1;
							_alert(1,"系统用户","相同MAC地址已存在",$(obj).parent().find('input').not('input:hidden'));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(2,mac_input,mac_input);
				}else if(type == 4){
					var start_mac = $(obj).parent().find('input').not('input:hidden').eq(0).val().trim();
					var end_mac = $(obj).parent().find('input').not('input:hidden').eq(1).val().trim();
					if (start_mac == "" && i != 0 && end_mac != ""){
						add = 1;
						_alert(2,"系统用户","请输入起始MAC地址",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (end_mac == "" && i != 0 && start_mac != ""){
						add = 1;
						_alert(2,"系统用户","请输入终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					if (!MACReg.test(start_mac)){
						add = 1;
						_alert(1,"系统用户","起始MAC地址格式不正确",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (!MACReg.test(end_mac)){
						add = 1;
						_alert(1,"系统用户","终止MAC地址格式不正确",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					var a = _compare_mac(start_mac,end_mac);
					if (a != 3){
						add = 1;
						_alert(1,"系统用户","起始MAC地址不能大于或等于终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view5').not('.set-view.set-view5:hidden').each(function(i,item){
						if (start_mac == $(item).find('input').not('input:hidden').eq(0).val().trim() && end_mac == $(item).find('input').not('input:hidden').eq(1).val().trim()){
							add = 1;
							_alert(2,"系统用户","相同的MAC地址区间已存在",$(obj).parent().find('input').not('input:hidden').eq(0));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(2,start_mac,end_mac);
				}else if(type == 5){
					var accset;
					if(i == 0){
						if($("#client_list").is(":visible")){
							if($("#accset").data('value') == undefined || $("#accset").data('value') == '-1'){
								return true;
							}else{
								accset = $("#accset").data('value');
							}
						}
					}else{
						accset = $(obj).parent().attr('id');						
					}
					if (client_list.indexOf(accset) == -1){
						client_list.push(accset);
					}
					save_mana_set(3,accset,accset); 
				}
			}
		}	
	})
	if(flag_ip_mac != 0){
		return false;
	}
	List2 = {
	  "ClientScopeId": 0,
	  "Type": 2, 
	  "IPList": {},
	  "MACList": {}
	};
	if(!$.isEmptyObject(IPList.Set)){
		List2.IPList = IPList;
	}
	if(!$.isEmptyObject(MACList.Set)){
		List2.MACList = MACList;
	}
	var ManageAuthSet = [
		{
			"ManageAuthId": 0,
			"ManageScopeMode": 2,
			"UserSet": [
				{
					"Id": 0,
					"Type": 1
				}
			],
			"MScopeSet": [],
			"CScopeSet": [],
		}
	];
	ManageAuthSet[0].CScopeSet = CScopeSet;
	user.ManageAuthSet = ManageAuthSet;
	if(List2.ClientScopeId != 0 || !$.isEmptyObject(List2.IPList) || !$.isEmptyObject(List2.MACList)){
		CScopeSet.push(List2);
		ManageAuthSet[0].CScopeSet = CScopeSet;
		user.ManageAuthSet = ManageAuthSet;
	}
	if(user.ManageAuthSet[0].MScopeSet == "" && user.ManageAuthSet[0].CScopeSet == ""){
		user.ManageAuthSet = null;
	}
	iplimited = true;

	//保存 用户组	
	//
	var UGroupSet = [];
	
	$('#userTree li').each(function(){ 
		if($(this).children('input').prop('checked') == true){
			ugid = $(this).children('input').attr('id').split('-')[1];
			UGroupSet.push(JSON.parse('{"UGId":'+ugid+'}'));
		}
	})
	
	time = date+" "+hour+":"+min+":"+sec;
		if($("#timeSet").prop("checked") == false)  time='';
	sys_u_name = sys_u_name.toLowerCase();
	user.LoginUserCode = '{{us}}';	
	user.UserCode = sys_u_name;
	user.UserName = user_name;
	user.UserNumber=UserNumber;
	user.Password = sys_u_pwd_new;
	user.Department = sys_u_depart;
	user.MobilePhone = sys_u_phone;
	user.Email = sys_u_email;
	user.Description = sys_u_descr;
	user.ExpireTimeEnabled = timeSet;
	user.ExpireTime = time;
	if(thirduser == "") thirduser = sys_u_name;
	user.ThirdUserCode = thirduser;
	user.IsBuildinUser = bdiusr;
	user.ManageIPUnlimited = true;
	user.SrcIPUnlimited = iplimited;
	user.AuthTypeId = (sys_u_authtype == 'null'?null:sys_u_authtype);
	user.AdminSet = AdminSet;
	user.RoleSet = RoleSet;
	user.PhotoIcon = photo;
	user.PwdApproveUserId = (pwdApproveUserId =="0"?null:pwdApproveUserId);
	user.UserStatus = $("#status").prop('checked') == true? 1 :0;
	user.LoginUniqueIP = $("#uniqueIP").prop('checked');
	user.UGroupSet = UGroupSet;
	user.OldPassword = null;
	if($("#ti").is(':visible') == true){
		user.TokenId = $("#ti").val();
	}else{
		user.TokenId = null;
	}
	//return false;
	repeat = 0;
	if(PwdStrategy.IfPwdUnRepeat){
		repeat = PwdStrategy.PwdUnRepeat;
	}else{
		repeat = 0;
	}
	var test_qrcode_flag = 0;
	user.SecretKey = null;
	
	if(new_pin !='' && $("#changepin_div").is(':visible') == true && $('#select_pin').val() == '1' ) user.SecretKey=new_pin;
	else if($('#span_pwd').text() != '初始密码') user.SecretKey=sys_u_pwd_new;
	if(user.SecretKey == null && $("#sys_u_pwd_new").prop('disabled') == true){
		user.SecretKey = "";
	}	
	//
	if($("#CertCn").is(':visible') == true) {
		if($('#CertCn').val() == ''){
			_alert(1,"系统用户","请输入认证唯一标识",$('#CertCn'));
			return false;
		}
		user.CertCn = $('#CertCn').val();
		
	}
	else user.CertCn = '';
	
	loginusercode = window.parent.document.frm.us.value;
	if (test_qrcode_flag == 0){
		var msstr = aceg(JSON.stringify(user),sess);
		var msstr1 = aceg(JSON.stringify(AccessSet),sess);
		if($("#setFinP").is(":visible") != true){
			FP_TMP == "";
		}		
		$.ajax({
			url:'/bhost/add_sys_user',
			type:"POST",
			async:false,
			data:{a0:sess,a1:JSON.stringify(user),a2:JSON.stringify(AccessSet),a3:"",a4:repeat,a5:new_pin,a7:FP_TMP,a10:"运维管理>系统用户",m1:msstr,m2:msstr1},
			//contentType: 'application/json',
			success: function(Result) {
				data = JSON.parse(Result);
				if (data.Result){
					//save_jump();
					//return true;
					
					if(new_pin !='' && $("#changepin_div").is(':visible') == true){
						try{
							sesstime = new Date().getTime()-1;
							cmd_json ={
								"type":"SetUser",
								"sesstime": sesstime,//毫秒
								"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
								"IfUsbkey":true,
								"certInfo":'',
								"crlInfo":'',
								"bhuser":$('#sys_u_name').val(),
								"password":new_pin
							}
							client_request(cmd_json,'SetUser',data.UserId,sesstime,data.Content);
						}catch(e){
							_alert(1,"系统用户",'pin码保存失败' +e);
							$.ajax({
								url:"/bhost/delete_user_list_u",
								type:"POST",
								async:false,
								data:{a0:sess,a1:loginusercode,a2:data.UserId},
								success:function(result){
								}
							})
						}
					}else{
						layer.open({
							type:1,
							title:"系统用户",
							content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:'确&nbsp;&nbsp;定',
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							btn1:function(i){
								layer.close(i);
								document.frm.tasktype.value = 3;
								document.frm.se.value = sess;
								document.frm.action = '/bhost/index';
								document.frm.i10.value = 1;
								document.frm.submit();
								return false;
							}
						});
					}
				}else{
					if(data.Content == null){
						_alert(1,"系统用户",'保存失败 原因：'+data.ErrMsg);
					}else{
						_alert(1,"系统用户",'pin码保存失败');
					}
				}
			}
		})
	}
}

function client_request(cmd_json,type,UserId,sesstime,Content){
	var if_html_client = false;
	var base64_str = '';
	var sesstimet = (new Date()).valueOf()+1;
	cmd_json['sesstimet'] = sesstimet;
	$.ajax({
		url: "/bhost/get_base64",
		type:"POST",
		async:false,		
		data:{a0:sess,z1:JSON.stringify(cmd_json)},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				if_html_client = result.info;
				base64_str = result.b64;
			}else{
				_alert(1,"系统用户",result.ErrMsg);
			}
		}
	})
	
	
	if(if_html_client) window.open('https://'+document.domain+'/bhost/test_html?se='+sess+'&z1='+JSON.stringify(cmd_json));
	else{
		//window.location.href = 'bhost://cmd&'+base64_str;
		get_regedit('bhost', sess,'',sesstimet);
		$('#YuFrame1').remove();
		$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
		$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
	}
	
	//插入数据库数据
	$.ajax({
		url: "/bhost/insert_usbkeys",
		type:"POST",
		async:false,		
		data:{a0:sess,z1:sesstime,t1:type,u1:$('#sys_u_name').val(),c1:Content,a10:"运维管理>系统用户"},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
			}else{
				_alert(1,"系统用户",result.ErrMsg);
				return false;
			}
		}
	})
	
	//循环获取 数据库状态
	_showLoading("正在设置PIN码......");
	var c = 0;
	
	if_ok_down = setInterval(function(){
		ret = repeat_get_usb_status(sesstime);
		if(ret == 1){
			clearInterval(if_ok_down);
			_closeLoading();
			save_jump();		
			return 0;				
		}
		if(ret == 2){
			clearInterval(if_ok_down);
			_closeLoading();
			_alert(1,"系统用户",'设置PIN码失败');
			$.ajax({
				url:"/bhost/delete_user_list_u",
				type:"POST",
				async:false,
				data:{a0:sess,a1:loginusercode,a2:UserId},
				success:function(result){
				}
			})
			return 0;				
		}
		if(c >=20){
			clearInterval(if_ok_down);
			_closeLoading();
			_alert(1,"系统用户",'设置PIN码超时');
			
			$.ajax({
				url:"/bhost/delete_user_list_u",
				type:"POST",
				async:false,
				data:{a0:sess,a1:loginusercode,a2:UserId},
				success:function(result){
				}
			})
		}			
		c = c + 1;				
	},1000)
}

function save_jump(){
	layer.open({
		type:1,
		title:"系统用户",
		content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
		btn:'确&nbsp;&nbsp;定',
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			layer.close(i);
			document.frm.tasktype.value = 3;
			document.frm.se.value = sess;
			document.frm.action = '/bhost/index';
			document.frm.i10.value = 1;
			document.frm.submit();
			return false;
		}
	});
}
//________________________________________________

//_______________________________________________________

//管理员
var user_data;
var u_nm = window.parent.document.frm.us.value;
var u_id = "";
var user_data_all = [];
var Admin_Data = [];
function _get_un(id,FLAG){
	//alert(FLAG);
	var sid = -1;
	if(id != undefined){
		var userid = id;
	}else{
		var userid = null;
	}
	if(FLAG == undefined){
		FLAG = true;
	}
	if(global_id != 0){
		sid = id;
	}
	// $("#pu_id").append("<option value=\"0\">无</option>");
	$('#select_u').empty().html('<div class="item" style="width: 33%;float: left;margin-left: -10px;"><select class="filter-select" name="un" id="un" style="width:202px;" tabindex="-1" aria-hidden="false" onchange="user_select(this)"></select><i class="ctrl add" onclick="_addUser(this)"></i></div>');
	// -----------------------------获取登陆用户name 和 ID
	$.ajax({
		url:'/bhost/_get_userid',
		type:"POST",
		async:false,
		data:{a0:sess,a1:u_nm},
		success: function(Result) {
			data = JSON.parse(Result);
			u_id = data.info;
		}
	})
	user_data_all.push(u_id);
	//--------------------------------------------
	//获取当前 角色id
	var ro_list = [];
	ro = $('#select_r select').val();
	if(ro != -1){
		ro_list.push(ro);
	}
	$('#select_r li.item').each(function(i,item){
		ro_list.push($(this).attr('id'));
	})
	ro_str = ro_list.join(",");
	//
	var tmp_list = [];
	$.ajax({
		url:"/bhost/_get_un",
		type:"POST",
		async:false,
		data:{a0:sess,a1:userid,r1:ro_str},
		success:function(result){
			user_result = JSON.parse(result);
			if(user_result){
				user_data = user_result.info;
				Admin_Data = user_data;
				tmp_list=Admin_Data.map(function (params) {
                     return params.UserId;
                });
				if(sid == -1 || sid != u_id){
					$("#un").empty().append("<option value=\"-1\">请选择</option>")
					if(tmp_list.indexOf(u_id) >=0 )$("#un").append("<option value=\""+u_id+"\" selected title=\""+u_nm+"\" type=\"true\" >"+u_nm+"</option>");				
				}else{
					$("#un").empty().append("<option value=\"-1\" selected>请选择</option>")
				}
				//$("#un").empty().append("<option value=\"-1\" selected>请选择</option>")
				if(FLAG == true){
					$.each(user_data,function(i,item){
						if(item.UserId != u_id && item.UserId != global_id){
							// $("#pu_id").append("<option value=\""+item.UserId+"\">"+item.UserCode+"</option>");
							$("#un").append('<option value="'+item.UserId+'" title="'+item.UserCode+'" type="'+item.UserRoot+'">'+item.UserCode+'</option>');
							user_data_all.push(item.UserId);
						}
					})
				 }else{
				 	$.each(user_data,function(i,item){
				 		if(item.UserId != u_id && item.UserId != global_id && item.UserRoot != true){
				 			// $("#pu_id").append("<option value=\""+item.UserId+"\">"+item.UserCode+"</option>");
				 			$("#un").append('<option value="'+item.UserId+'" title="'+item.UserCode+'" type="'+item.UserRoot+'">'+item.UserCode+'</option>');
				 			user_data_all.push(item.UserId);
				 		}
				 	})
				 }
			}else{
				_alert(1,"系统用户",'获取管理员失败');
			}
		}
	})
	
	$('#un').unbind().select2();
	$('#un').select2('destroy').select2();
	$('#un').change(function(){
		setTimeout(function() {
				reload_rn();
			
			_initList_ug();
		},1);
	});
	
	//
	if(global_id == 0){ //创建
		$("#un").val('-1').trigger('change');	
		if(tmp_list.indexOf(u_id) >=0 ) $("#un").val(u_id).trigger('change');
		//continue;
	}else{ //修改用户
		$.ajax({		//回显用户信息
			url:"/bhost/get_user_list",
			type:"POST",
			async:false,
			data:{a0:sess,a1:global_id},
			success:function(result){
				user_item = JSON.parse(result);
				if(user_item.Result == false){
					_alert(1,"系统用户","获取信息失败："+user_item.info);
					return false;
				}
				user_item = user_item.info;
				AdminSet_group = user_item.AdminSet;
			}
		})
		$(AdminSet_group).each(function(i1,item1){
			$("#un").val(item1.AdminId).trigger('change');
			if($("#un").next().next('.ctrl.add').is(':visible')){
				$("#un").next().next().click();
			}
		})
		
		
		if($('#select_u select').val() == null){
			$('#select_u select').val('-1').trigger('change');
		}
	}
}

var user_tmp = [];
var user_arry=['-1'];
var global_flag = false;
function user_select(obj){
	var t = $(obj).children('option:selected').val();
	if (user_arry.indexOf(t) === -1 && t != undefined){
		user_arry.splice(0,1,t);
	}
	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}
}

function _addUser(obj){
	var add = 0;
	var name2 = $(obj).parent().children('select').children('option:selected').val();
	var tp = $(obj).parent().children('select').children('option:selected').attr('type');
	
	if (name2 == undefined){
		$(obj).parent().children('select').val('-1').trigger('change');
		return false;
	}	
	
	var t = $(obj).parent().children('select').children('option[value='+name2+']:first').text();
	if (name2 == -1){
		_alert(2,"系统用户","请选择管理员");
		return;
	}
	user_arry.splice(0,0,'-1');
	user_data_all.splice($.inArray(parseInt(name2), user_data_all), 1);
	var $c = $(obj).parent();
	// $c.children('select').select2('destroy');
	var d = $('select>option:first',$c).val();
	var $s = $('<li class="item" id="'+name2+'" isroot="'+tp+'" style="width: 33%;float: left;margin-left: -10px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:170px;" disabled="true"><i class="ctrl del" onclick="_delUser(this)"></i></li>');
	$c.children('select').val(d);
	$c.children('select').find('option[value='+name2+']').remove();

	$c.after($s);
	// $c.children('select').select2({minimumResultsForSearch: -1});
	user_tmp=[];
	$("#select_u>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		user_tmp.push(v_tmp);
	});
	//获取当前 已添加的管理员 是否存在 系统用户员 
	var flag_user_role =false;
	$('#select_u li.item').each(function(i,item){
		if($(this).attr('isroot') == 'true'){
			flag_user_role = true;
			return false;
		}
	})
	if(!flag_user_role && parent.user_item.UserId != name2){
		$('#select_u select').val(parent.user_item.UserId).trigger('change');
		//reload_rn();
	}
	reload_rn();
	
	_initList_ug();
	if($(obj).parent().children('select').val() == null){
		$(obj).parent().children('select').val('-1').trigger('change');
	}	
}
function _delUser(obj){
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var $p = $("#un");
	var data, max;
	var min = 0;
	max = user_data_all.length - 1;
	data = user_data_all;
	var isRoot = $(obj).parent('li').attr('isroot');
	var t = $(obj).siblings('input').val();
	$c.remove();
	$("#un").parent().show();
	user_arry.splice($.inArray(id,user_arry),1);

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<option value="' + id + '" title="'+t+'" type="'+isRoot+'" >' + t + '</option>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('option').eq(0).after('<option value="' + id + '" title="'+t+'" type="'+isRoot+'">' + t + '</option>');
	} else {
		$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '" title="'+t+'" type="'+isRoot+'" >' + t + '</option>');
	}
	user_data_all.splice(index_1, 0, parseInt(id));

	user_tmp=[];
	$("#select_u>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		user_tmp.push(v_tmp);
	});
	//获取当前 已添加的管理员 是否存在 系统管理员 
	var flag_user_role =false;
	$('#select_u li.item').each(function(i,item){
		if($(this).attr('isroot') == 'true'){
			flag_user_role = true;
			return false;
		}
	})
	if(flag_user_role == false){
		if($('#select_u option:selected').attr('type') == true){
			flag_user_role = true;
		}else{
			flag_user_role = false;
		}
	}
	if(!flag_user_role && $('#select_u select').val() == -1 ){
		$('#select_u select').val(parent.user_item.UserId).trigger('change');
		//reload_rn();
	}
	if($('#select_u select').val() == null){
		$('#select_u select').val('-1').trigger('change');
	}	
	//if(isRoot == 'true'){
		reload_rn();
	//}
		
	
	_initList_ug();
}

//访问授权
var auth_data; 
var auth_tmp = [];
var auth_data_all = [];
var auth_arry=['-1'];
function auth_select(obj){
	var t = $(obj).children('option:selected').val();
	if (auth_arry.indexOf(t) === -1 && t != undefined){
		auth_arry.splice(0,1,t);
	}
	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();

	}
}
function _addAuth(obj){
	var add = 0;
	var name2 = $(obj).parent().children('select').children('option:selected').val();
	if (name2 == undefined){
		$(obj).parent().children('select').val('-1').trigger('change');
		return false;
	}
	var t = $(obj).parent().children('select').children('option[value='+name2+']').text();
	if (name2 == -1){
		_alert(2,"系统用户","请选择访问授权");
		return;
	}
	auth_arry.splice(0,0,'-1');
	auth_data_all.splice($.inArray(parseInt(name2), auth_data_all), 1);
	var $c = $(obj).parent();
	// $c.children('select').select2('destroy');
	var d = $('select>option:first',$c).val();
	var $s = $('<li class="item" id="'+name2+'"style="width: 32%;float: left;margin-left: -19px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:170px;" disabled="true"><i class="ctrl del" onclick="_delAuth(this)"></i></li>');
	$c.children('select').val(d);
	$c.children('select').find('option[value='+name2+']').remove();

	$c.after($s);
	// $c.children('select').select2({minimumResultsForSearch: -1});
	auth_tmp=[];
	$("#select_a>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		auth_tmp.push(v_tmp);
	});
}
function _delAuth(obj){
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var $p = $("#an");
	var data, max;
	var min = 0;
	max = auth_data_all.length - 1;
	data = auth_data_all;

	var t = $(obj).siblings('input').val();
	$c.remove();
	$("#an").parent().show();
	auth_arry.splice($.inArray(id,auth_arry),1);

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<option value="' + id + '">' + t + '</option>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('option').eq(0).after('<option value="' + id + '">' + t + '</option>');
	} else {
		$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '">' + t + '</option>');
	}
	auth_data_all.splice(index_1, 0, parseInt(id));

	auth_tmp=[];
	$("#select_a>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		auth_tmp.push(v_tmp);
	});
}

function _get_an(){
	$('#select_a').empty().html('<div class="item" style="width: 32%;float: left;margin-left: -19px;"><select class="filter-select" name="an" id="an" style="width:202px;" tabindex="-1" aria-hidden="false" onchange="auth_select(this)"></select><i class="ctrl add" onclick="_addAuth(this)"></i></div>');
	$.ajax({
		url:"/bhost/get_access_way_x",
		type:"POST",
		async:true,
		data:{a0:sess},
		success:function(result){
			var result = JSON.parse(result);
			auth_data = result;
			if(result){
				data = result.data;
				$("#an").empty().append('<option value=\"-1\" selected>请选择</option>');
				$.each(data,function(i,item){
					$("#an").append('<option value="'+item.AccessAuthId+'" title="'+item.UserCode+'">'+item.AccessAuthName+'</option>');
					auth_data_all.push(item.AccessAuthId);
				})
			}else{
				_alert(1,"系统用户",'获取访问授权失败');
			}
		}
		
	})
	$('#select_a .filter-select').select2();
}

//令牌
function _get_tokenid(){
	$("#TokenID").empty().html('<div class="item" style="float: left;margin-top: -10px;width: 100%"><select class="filter-select" name="ti" id="ti" style="width:98px;" tabindex="-1" aria-hidden="false"></select></div>');
	var s = {
		"TokenId":"",
		"Key":"",
		"UserSet":"",
		"searchstring":""
	}
	$.ajax({
		url:"/bhost/get_toten_list",
		type:"POST",
		async:false,
		data:{a0:sess,a5:JSON.stringify(s)},
		success:function(result){
			token_result = JSON.parse(result);
			if(token_result.Result){
				token_result = token_result.info;
				$("#ti").empty().append('<option value=\"-1\">选择令牌</option>');
				$.each(token_result.data,function(i,item){
					if(item.UserSet == null && item.Memo == '已检测'){
						$("#ti").append('<option value="'+item.TokenId+'" title="'+item.TokenId+'">'+item.TokenId+'</option>');
					}
				})
			}else{
				_alert(1,"系统用户",'获取令牌失败');
			}
		}
	});
	$('#TokenID .filter-select').select2();
}
//客户端登陆限制
function _get_client(){
	$.ajax({
		url:"/bhost/_get_client",
		type:"POST",
		async:false,
		data:{a0:sess},
		success:function(result){
			var result = JSON.parse(result);
			$("#select_client").empty().append('<option value="" >请选择</option>');;
			$(result.data).each(function(i,item){
				$("#select_client").append('<option value="'+item.ClientScopeId+'">'+item.ClientScopeName+'</option>');
			})
			//$('#select_client').select2({minimumResultsForSearch: -1});
		}
	})
}

var client_tmp = [];

function check_client(obj){
	var pass = 1;
	var v=$(obj).children("option:selected").val();
	if(client_tmp.indexOf(v) >=0){
		pass=0;
		_alert(1,"系统用户",'已存在相同客户端集合');
	}
	if(pass==1){
		client_tmp=[];
		$('#Temp4>div>div.set-view4').each(function(i,item){
			var v_tmp=$(item).children("select").val();
			client_tmp.push(v_tmp)
		});
	}else{
		$('#Temp4>div>div.set-view4').each(function(i,item){
			var new_mo=$(item).children("select").val();
			if(client_tmp[i] != new_mo){				
				if(client_tmp[i])$(item).children("select").val(client_tmp[i]);
				else $(item).children("select").val("");
				return false;
			}
		});
		$('#Temp4 .select2').select2({minimumResultsForSearch: -1});
	}
	
}

function change_limit(obj){
	var type = $(obj).find('option:selected').val();
	var v = $(obj).val();
	var $c = $(obj).siblings('div.g-cont');
	var $c1 = $c.children('div.sel-type1'),
			$c2 = $(".set-view").not(":first");
	if (type == 1){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view4').show();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view5').hide();
	}else if (type == 2){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view2').show();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
		$(obj).parent().find('.set-view.set-view5').hide();
	}else if (type == 3){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view3').show();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
		$(obj).parent().find('.set-view.set-view5').hide();
	}else if (type == 4){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view5').show();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
	}else{//客户端集合
		$c1.show();
		// $c2.hide();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view5').hide();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
		// $("#client_list").show();
	}
}
var ipcheck_route=/(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/
var MACReg = /([A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2}/;

var client_list = ['-1'];
var client_id;
var IPList = {"IPSetId":0,"Set":[]};
var MACList = {"MACSetId":0,"Set":[]};
var List1 = {
  "ClientScopeId": 0,
  "Type": 1, 
  "IPList": null,
  "MACList": null
};
var List2 = {
  "ClientScopeId": 0,
  "Type": 2, 
  "IPList": {},
  "MACList": {}
};
var CScopeSet=[];

function _addSet4(obj){
	var type = $(obj).parent().children('select').find('option:selected').val();
	var add = 0;
	var clientId;
	if (type == 1 || type == 2){
		if (type == 2){
			var start_ip = $(obj).parent().find('input').not('input:hidden').eq(0).val();
			var end_ip = $(obj).parent().find('input').not('input:hidden').eq(1).val();
			if (start_ip == ""){
				_alert(2,"系统用户","请输入起始IP地址",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (end_ip == ""){
				_alert(2,"系统用户","请输入终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			if (!ipcheck_route.test(start_ip)){
				_alert(1,"系统用户","起始IP地址不正确",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (!ipcheck_route.test(end_ip)){
				_alert(1,"系统用户","终止IP地址不正确",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			var a = _compare_ip(start_ip,end_ip);
			if (a != 3){
				_alert(1,"系统用户","起始IP地址不能大于或等于终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view2').not('.set-view.set-view2:hidden').each(function(i,item){
				if ($(item).find('input').not('input:hidden').eq(0).val() == start_ip && $(item).find('input').not('input:hidden').eq(1).val() == end_ip){
					add = 1;
					_alert(1,"系统用户","相同IP区间已存在",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(1,start_ip,end_ip);
		}else{
			var start_ip = $(obj).parent().find('input').not('input:hidden').val();
			var end_ip = start_ip;
			if (start_ip == ""){
				_alert(2,"系统用户","请输入IP地址",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			if (!ipcheck_route.test(start_ip)){
				_alert(1,"系统用户","IP地址不正确",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view4').not('.set-view.set-view4:hidden').each(function(i,item){
				if ($(item).find('input').not('input:hidden').val() == start_ip){
					add = 1;
					_alert(1,"系统用户","相同IP地址已存在",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(1,start_ip,end_ip);
		}
	}else{
		if (type == 3){
			var mac_input = $(obj).parent().find('input').not('input:hidden').val().trim();
			if (mac_input == ""){
				_alert(2,"系统用户","请输入MAC地址",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			if (!MACReg.test(mac_input)){
				_alert(1,"系统用户","MAC地址格式不正确",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view3').not('.set-view.set-view3:hidden').each(function(i,item){
				if (mac_input == $(item).find('input').not('input:hidden').val().trim()){
					add = 1;
					_alert(2,"系统用户","相同MAC地址已存在",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(2,mac_input,mac_input);
		}else if(type == 4){
			var start_mac = $(obj).parent().find('input').not('input:hidden').eq(0).val().trim();
			var end_mac = $(obj).parent().find('input').not('input:hidden').eq(1).val().trim();
			if (start_mac == ""){
				add = 1;
				_alert(2,"系统用户","请输入起始MAC地址",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (end_mac == ""){
				add = 1;
				_alert(2,"系统用户","请输入终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			if (!MACReg.test(start_mac)){
				add = 1;
				_alert(1,"系统用户","起始MAC地址格式不正确",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (!MACReg.test(end_mac)){
				add = 1;
				_alert(1,"系统用户","终止MAC地址格式不正确",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			var a = _compare_mac(start_mac,end_mac);
			if (a != 3){
				add = 1;
				_alert(1,"系统用户","起始MAC地址不能大于或等于终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			if (add == 1){
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view5').not('.set-view.set-view5:hidden').each(function(i,item){
				if (start_mac == $(item).find('input').not('input:hidden').eq(0).val().trim() && end_mac == $(item).find('input').not('input:hidden').eq(1).val().trim()){
					add = 1;
					_alert(2,"系统用户","相同的MAC地址区间已存在",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(2,start_mac,end_mac);
		}else if(type == 5){
			var accset = $('#accset').find('span').text();
			clientId = $('#accset').data('value');
			if (clientId == "-1" || clientId == undefined){
				_alert(2,"系统用户","请选择客户端集合");
				return false;
			}
		}
	}

	if(type == 5){
		var cid = $("#accset").data('value');
		var $H = '<div class="sitem" id="'+cid+'" style=" width: 510px;float: left; margin-left: -10px;height:40px" _auth_data="">'+
			'<i class="ctrl del" onclick="_del(this)" style="bottom: 30px;margin-left: 130px"></i>'+
				'<select name="" id="Clone" class="select2 " style="width: 120px" disabled="disabled">'+
					'<option value="5" selected>客户端集合</option></select>'+
				'<input id="accset" style="width: 302px;" type="text" class="form-text" value="'+accset+'" disabled="disabled">'+
			'</div>';
		$(obj).parent().after($H);
		$('#Clone').select2({minimumResultsForSearch: -1});
		if (client_list.indexOf(cid) === -1) {
			client_list.push(cid);
		}
		client_list.splice(0, 0, '-1');
		c_index_all.splice($.inArray(parseInt(cid), c_index_all), 1);
		$("#accset").find('span').text('请选择');
		$("#accset").data('value','-1');
		$("div[data-id=xSelect-client]").children('input').val('');
		$("div[data-id=xSelect-client]").find('span[data-value='+cid+']').parent('li').remove();
		$(obj).prev('div').data('value','-1');
	}else{
		var $H = temp4.clone().wrap();
		var select_type = $("#Temp4").children('.sitem:first').children('select:first').val();
		var input1_str = null;
		var input2_str = null;
		if($("#Temp4").children('.sitem:first').find('input:visible').length == 1){
			input1_str = $("#Temp4").children('.sitem:first').find('input:visible').val();
		}else{
			input1_str = $("#Temp4").children('.sitem:first').find('input:visible').eq(0).val();
			input2_str = $("#Temp4").children('.sitem:first').find('input:visible').eq(1).val();
		}
		$('.select2',$H).select2({minimumResultsForSearch: -1});
		$("#Temp4").children('.sitem:first').after($H);
		$("#Temp4").children('.sitem').eq(1).children('select:first').val(select_type).trigger('change');
		if($("#Temp4").children('.sitem').eq(1).find('input:visible').length == 1){
			$("#Temp4").children('.sitem').eq(1).find('input:visible').val(input1_str);
		}else{
			$("#Temp4").children('.sitem').eq(1).find('input:visible').eq(0).val(input1_str);
			$("#Temp4").children('.sitem').eq(1).find('input:visible').eq(1).val(input2_str);
		}	
		$("#Temp4").children('.sitem').eq(1).find('select').attr("disabled",true);
		$("#Temp4").children('.sitem:first').find('input').val('');
		$("#Temp4").children('.sitem:first').children('select:first').val('5').trigger('change');
		$("#Temp4").children('.sitem').eq(1).append('<i class="ctrl del" onclick="_del(this)" style="bottom: 30px;margin-left: 130px"></i>');
	}
	_autoHeight();
}

//保存客户端登陆限制  type :  1-->ip   2-->mac  3-->scope

var ip_order = 1;
var mac_order = 1;
function save_mana_set(type,start,end){
	var IPSet = {
		"IPSetMemberId": 0,
		"Order": 0,
		"StartIP": "",
		"EndIP": ""                            
	};
	var MACSet = {
		"MACSetMemberId": 0,
		"Order": 0,
		"StartMACAddress": "",
		"EndMACAddress": ""
	};
	var scope = {
		"ClientScopeId": 1,
		"Type": 1, 
		"IPList": null,
		"MACList": null
	}
	if(type == 1){
		IPSet.Order = ip_order;
		ip_order++;
		IPSet.StartIP = start;
		IPSet.EndIP = end;
		// IPSet = JSON.parse(IPSet);
		IPList.Set.push(IPSet);
	}
	if(type == 2){
		MACSet.Order = mac_order;
		mac_order++;
		MACSet.StartMACAddress = start;
		MACSet.EndMACAddress = end;
		// MACSet = JSON.parse(MACSet);
		MACList.Set.push(MACSet);
	}	
	if(type == 3){
		scope.ClientScopeId = start;
		// scope = JSON.parse(scope);
		CScopeSet.push(scope);
	}
}

function _del(obj){
	var type = $(obj).parent().children("select").val();
	var value0 = $(obj).parent().find("input").not('input:hidden').eq(0).val();
	var value1 = $(obj).parent().find("input").not('input:hidden').eq(1).val();
	var value3 = $(obj).parent().attr("_auth_data");
	if (type == 1){
		$(IPList.Set).each(function(a1,item1){
			if(item1.StartIP == value0 && item1.EndIP == value0){
				IPList.Set.splice(a1,1);
			}
		})
	}
	if (type == 2){
		$(IPList.Set).each(function(a1,item1){
			if(item1.StartIP == value0 && item1.EndIP == value1){
				IPList.Set.splice(a1,1);
			}
		})
	}
	if (type == 3){
		$(MACList.Set).each(function(a1,item1){
			if(item1.StartMACAddress == value0 && item1.EndMACAddress == value0){
				MACList.Set.splice(a1,1);
			}
		})
	}
	if (type == 4){
		$(MACList.Set).each(function(a1,item1){
			if(item1.StartMACAddress == value0 && item1.EndMACAddress == value1){
				MACList.Set.splice(a1,1);
			}
		})
	}
	if (type == 5){
		var $c = $(obj).parent();
		var id = $c.attr('id');
		var t = $(obj).siblings('input').val();
		var v, data, max;
		var min = 0;
		max = c_index_all.length - 1;
		data = c_index_all;
		$("#accset").show();
		client_list.splice($.inArray(parseInt(id), client_list), 1);
		var $p = $("div[data-id=xSelect-client]").children('ul');
		if (max < 0){
			var index_1 = -1;
		}else{
			var index_1 = search_i(min, max, parseInt(id), data);
		}
		index_1 = parseInt(index_1);
		if (index_1 == -1) {
			index_1 = max;
			$p.append('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
		} else if (index_1 == -2) {
			index_1 = 0;
			$p.children('li').eq(0).before('<li style=""><i class="edit"></i><span data-value="'+id+'"  title="'+t+'" style="width:324px">'+t+'</span></li>');
		} else {
			$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
		}
		data.splice(index_1, 0, parseInt(id));
	}
	var $c = $(obj).parent();
	$c.remove();
}
function search_i(min, max, id, data) {
	var mid, res;
	if (data[max] < id) {
		return -1;
	}
	if (data[min] > id) {
		return -2;
	}
	while (min <= max) {
		mid = parseInt((min + max) / 2);
		if (data[mid] > id) {
			max = mid - 1;
			res = mid;
		} else {
			min = mid + 1;
		}
	}
	return res;
}
var $focusObj;
var accdata;
function _autoView(obj,i,j){
	$(document)[0].onclick = null;
	$focusObj = $(obj);
	$.ajax({
		url:'/bhost/get_clientset_z',
		type:'post',
		async:false,
		data:{a0: sess},
		success:function(result){
			accdata = JSON.parse(result);
		}
	});
	var v = $.trim($(obj).val());
	var $view;
	if($('#autoView').length == 0){
		$('body').append('<div id="autoView" />');
	}
	$view = $('#autoView');
	var c = '';
	$.each(accdata.data,function(i,item){
		var add = 0;
		$.each(client_list,function(i1,item1){
			if (item.ClientScopeId == item1){
				add = 1;
				return false;
			}
		})
		if (add == 1){
			return true;
		}
		if(v == ''){
			c += '<li><i class="edit" onclick="_editNode2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.ClientScopeId+'" onclick="_setVal(this,3);">'+item.ClientScopeName+'</a></li>';
		}else{
			if(item.ClientScopeName.indexOf(v) >= 0 ){
				c += '<li><i class="edit" onclick="_editNode2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.ClientScopeId+'" onclick="_setVal(this,3);">'+item.ClientScopeName+'</a></li>';
			}
		}
	});
	$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_editNode2(this,2);">添加新客户端集合</a></div>');

	var offset = $(obj).offset();
	var w = $(obj).outerWidth();
	$view.css({
		top:offset.top+24,
		left:offset.left,
		width:w-12
	}).show();

	$(obj).parents('.g-tsel').addClass('on');
	if (j == 0){
		input_val = $(obj).val();
	}
}

var client_data;
function _editNode2(obj,type){
	clientId1 = obj;
	clientId2 = type;
	clear_client();
	var title;
	if (type == 1){			//编辑客户端集合
		clientId = $(obj).children('span').data('value');
		$.ajax({
			url: "/bhost/get_client_list",
			type: "POST",
			async: false,
			data: { a0: sess, a1: clientId },
			success: function (result) {
				var client_result = JSON.parse(result);
				if (client_result.Result == true) {
					client_data = client_result.info.data[0];
					title = "客户端集合";
				}
			}
		})
	}else if(type == 2){		//添加客户端集合
		client_data = null;
		clientId = 0;
		title = "客户端集合";
	}
	var $dialogCont = $("#client_suspend").show();
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"client_suspend",
		width:"1000px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	initformlist();
	$(".ui-dialog-title").css("width","140px");
	client_main(type);
	
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload(1);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
		client_add(d);	
	})	
}

function _hideView(obj){
	$(obj).parents(".sitem").attr("_auth_data","");
	$(accdata.data).each(function(i,item){
		if(item.ClientScopeName == $("#accset").val()){
			$(obj).parents(".sitem").attr("_auth_data",item.ClientScopeId)
			return false;
		}
	})
	var value = $(obj).parents(".sitem").attr("_auth_data");
	if(value == ""){
		$(obj).val("");
	}
	$(document)[0].onclick = function(){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
	}
}

var input_val = "";
var serverid_list = [];

function _setVal(t,t1){
	var val = $(t).text();
	var add = 0;

	$($focusObj).val(val);
	$view = $('#autoView');
	$view.hide();
	client_id =  parseInt($(t).attr('id'));
	var $item = $focusObj.parents('div.g-title').next('div.g-cont').find('div.forName');
	var $item2 = $focusObj.parent().next('input.forName');
	$item.hide();
	$item2.hide();
	var authdata = client_id;
	$("#Temp4").children("[class='sitem']:first").attr("_auth_data",authdata);
}
function _jScrollBar(scid) {
	var myBar = new MyScrollBar({
		selId:scid,
		hasX:true,
		hasY:false,
		width:6,
		// enterShow:false,
	})
}
function clear_client(){
	client_set = {
		"ClientScopeId": 0,
		"ClientScopeName": "",
		"IsApplyToServerScope": false,
		"IPList":{
			"IPSetId": 0,
			"Set": new Array()
		},
		"MACList":{
			"MACSetId": 0,
			"Set": new Array()
		}
	};
	$("#ip_n_c1").children('span').not('span:first').remove();
	$("#ip_n_c").children('span').not('span:first').remove();
	$("#MACAddress").children('span').not('span:first').remove();
	$("#MACAddress1").children('span').not('span:first').remove();
	$("#ip_n_c1").children('span:first').find('input').val('');
	$("#ip_n_c").children('span:first').find('input').val('');
	$("#MACAddress").children('span:first').find('input').val('');
	$("#MACAddress1").children('span:first').find('input').val('');
	$("#c_n").val('');
	$("#c_n").attr("disabled",false);
	$("#c_n").next('i').attr('class','v-check');
}

function initformlist(){
	var h1 = $('.form1').height();
	var h2 = $('.form3').height();
	if (h1 > h2){
		$('.form3').height(h1);
	}else{
		$('.form1').height(h2);
	}
}


function client_main(type){
	if (type == 1) {
		$("#c_n").val(client_data.ClientScopeName);
		$("#c_n").attr("disabled", true);
		if (client_data.IPList != null) {
			client_set.IPList.IPSetId = client_data.IPList.IPSetId;
			if(client_data.IPList.Set!=null){
				var IPset_group=client_data.IPList.Set.filter(function (params) {
					return params.StartIP != params.EndIP
				});
				var IP_group=client_data.IPList.Set.filter(function (params) {
					return params.StartIP == params.EndIP
				});
				for(var i=0;i<IPset_group.length-1;i++){
					var $c = $('<span class="ss" value="' + IPset_group[i].IPSetMemberId + '" style="float:left;width: 340px;position:static;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;"value="' + IPset_group[i].StartIP + '">'
						+ '<span style="vertical-align:middle;padding-left: 5px;padding-right: 4px;">-</span>' + '<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + IPset_group[i].EndIP + '">'
						+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
					$("#ip_n_c").find("span[class='ss ss-add']").after($c);
				}
				if(IPset_group.length!=0){
					$('#ip_n_c').attr('value',IPset_group[i].IPSetMemberId);
					$('#ip_n_c').find('input:eq(0)').val(IPset_group[i].StartIP);
					$('#ip_n_c').find('input:eq(1)').val(IPset_group[i].EndIP);
				}
				for(var i=0;i<IP_group.length-1;i++){
					var $c = $('<span class="ss" style="float:left;position:static;padding: 0 0 10px 0;" value=' + IP_group[i].IPSetMemberId + '/>');
					$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + IP_group[i].StartIP + '">'
						+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
					$("#ip_n_c1").find("span[class='ss ss-add']").after($c);
				}
				if(IP_group.length!=0){
					$('#ip_n_c1').attr('value',IP_group[i].IPSetMemberId);
					$('#ip_n_c1').find('input').val(IP_group[i].StartIP);
				}
			}
		}
		if (client_data.MACList != null) {
			client_set.MACList.MACSetId = client_data.MACList.MACSetId;
			if(client_data.MACList.Set!=null){
				var MACset_group=client_data.MACList.Set.filter(function (params) {
					return params.StartMACAddress != params.EndMACAddress
				});
				var MAC_group=client_data.MACList.Set.filter(function (params) {
					return params.StartMACAddress == params.EndMACAddress
				});
				for(var i=0;i<MACset_group.length-1;i++){
					var $c = $('<span class="ss" value="' + MACset_group[i].MACSetMemberId + '" style="float:left;width: 380px;position: static;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" value="' + MACset_group[i].StartMACAddress + '" style="width:138px;padding-right: 8px;">'
						+ '<span style="vertical-align:middle;padding-left: 5px;padding-right: 5px;">-</span>'
						+ '<input type="text" class="form-text" value="' + MACset_group[i].EndMACAddress + '" style="width:138px;padding-right: 8px;">'
						+ '<i class="ctr ctr-del" style="margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
					$("#MACAddress1").find("span[class='ss ss-add']").after($c);
				}
				if(MACset_group.length!=0){
					$("#MACAddress1").find("span[class='ss ss-add']").attr('value',MACset_group[i].MACSetMemberId);
					var $mac_input=$("#MACAddress1").find("span[class='ss ss-add']").find('input');
					$mac_input.first().val(MACset_group[i].StartMACAddress);
					$mac_input.last().val(MACset_group[i].EndMACAddress);
				}
				for(var i=0;i<MAC_group.length-1;i++){
					var $c = $('<span class="ss" value="' + MAC_group[i].MACSetMemberId + '" style="float:left;position:static;width: 190px;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" style="width:138px;padding-right: 8px;" value="' + MAC_group[i].StartMACAddress + '">'
						+ '<i class="ctr ctr-del" style="    margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
					$("#MACAddress").find("span[class='ss ss-add']").after($c);
				}
				if(MAC_group.length!=0){
					$("#MACAddress").find("span[class='ss ss-add']").attr('value',MAC_group[i].MACSetMemberId);
					$("#MACAddress").find("span[class='ss ss-add']").find('input').val(MAC_group[i].StartMACAddress);
				}
			}
		}
	}
}
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
var ipReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
//创建
function client_add(d) {
	var ip_section = 1;
	var mac_address = 1;
	var ip_section1 = 1;
	var mac_address1 = 1;
	var pass = 1;
	var no_pass = "";
	var val = $("#c_n").val();
	var $i = $("#c_n").next('i.v-check');
	if (val == "") {
		_alert(2, '客户端集合操作', '请输入名称',$("#c_n"));
		return false;

	} else if (!nameReg.test(val)) {
		_alert(1, '客户端集合操作', '名称格式不正确',$("#c_n"));
		return false;
	}
	var v2 = $("#ip_n_c1").find("span[class='ss ss-add']").children("input").val().trim();
	if (v2=='' && !$(">span[class='ss']", "#ip_n_c1").length) {
		ip_section1 = 0;
	}
	var ip_n_c1_len = $('#ip_n_c1').children('span').length;
	$('#ip_n_c1').children('span').each(function(i,item){
		if (ip_section1 == 0){
			return true;
		}
		var input1 = $(item).find('input').val();
		if (i == 0 && input1 == "" && ip_n_c1_len != 1){
			return true;
		}
		if (input1 == ""){
			pass = 0;
			_alert(2, '客户端集合操作', '请输入IP地址', $(item).find('input'));
			return false;
		}
		if (!ipReg.test(input1)) {
			pass = 0;
			_alert(2, '客户端集合操作', 'IP地址格式不正确', $(item).find('input'));
			return false;
		}
		$('#ip_n_c1').children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var input2 = $(item1).find('input').val();
			if (input2 == ""){
				pass = 0;
				_alert(2, '客户端集合操作', '请输入IP地址', $(item1).find('input'));
				return false;
			}
			if (!ipReg.test(input2)) {
				pass = 0;
				_alert(2, '客户端集合操作', 'IP地址格式不正确', $(item1).find('input'));
				return false;
			}
			if (input1 == input2){
				pass = 0;
				_alert(2,"客户端集合操作","相同的IP地址已存在",$(item).find('input'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	if (pass == 0){
		return false;
	}
	var v = $("#ip_n_c").find("span[class='ss ss-add']").children("input").first().val().trim();
	var v1 = $("#ip_n_c").find("span[class='ss ss-add']").children("input").last().val().trim();

	if (v=="" && v1 == "" && !$(">span[class='ss']", "#ip_n_c").length) {
		ip_section = 0;
	}
	var ip_n_c_len = $("#ip_n_c").children('span').length;
	$("#ip_n_c").children('span').each(function(i,item){
		if (ip_section == 0){
			return true;
		}
		var ip_input1 = $(item).find('input:eq(0)').val();
		var ip_input2 = $(item).find('input:eq(1)').val();
		if (i == 0 && ip_input1 == "" && ip_input2 == "" && ip_n_c_len != 1){
			return true;
		}
		if (ip_input1 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '请输入起始IP', $(item).find('input:eq(0)'));
			return false;
		} else if (!ipReg.test(ip_input1)) {
			pass = 0;
			_alert(1, '客户端集合操作', '起始IP格式不正确', $(item).find('input:eq(0)'));
			return false;
		}
		if (ip_input2 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '请输入结束IP',$(item).find('input:eq(1)'));
			return false;
		} else if (!ipReg.test(ip_input2)) {
			pass = 0;
			_alert(1, '客户端集合操作', '结束IP格式不正确', $(item).find('input:eq(1)'));
			return false;
		}
		var r_v = _compare_ip(ip_input1,ip_input2);
		if (r_v != 3){
			pass = 0;
			_alert(2, '客户端集合操作', '起始IP不能大于等于结束IP', $(item).find('input:eq(0)'));
			return false;
		}
		$("#ip_n_c").children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var ip1_input1 = $(item1).find('input:eq(0)').val();
			var ip1_input2 = $(item1).find('input:eq(1)').val();
			if (ip1_input1 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '请输入起始IP', $(item1).find('input:eq(0)'));
				return false;
			} else if (!ipReg.test(ip1_input1)) {
				pass = 0;
				_alert(1, '客户端集合操作', '起始IP格式不正确', $(item1).find('input:eq(0)'));
				return false;
			}
			if (ip1_input2 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '请输入结束IP',$(item1).find('input:eq(1)'));
				return false;
			} else if (!ipReg.test(ip1_input2)) {
				pass = 0;
				_alert(1, '客户端集合操作', '结束IP格式不正确', $(item1).find('input:eq(1)'));
				return false;
			}
			var r_v = _compare_ip(ip1_input1,ip1_input2);
			if (r_v != 3){
				pass = 0;
				_alert(2, '客户端集合操作', '起始IP不能大于等于结束IP', $(item1).find('input:eq(0)'));
				return false;
			}
			if (ip1_input1 == ip_input1 && ip_input2 == ip1_input2){
				pass = 0;
				_alert(2,"客户端集合操作","相同的IP区间已存在",$(item).find('input:eq(1)'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	if (pass == 0){
		return false;
	}
	
	var input_str = $("#MACAddress").find("span[class='ss ss-add']").children("input").val();
	if (input_str=='' && !$(">span[class='ss']", "#MACAddress").length) {
		mac_address = 0;
	}
	var mac_len = $('#MACAddress').children('span').length;
	$('#MACAddress').children('span').each(function(i,item){
		if (mac_address == 0){
			return false;
		}
		var input1 = $(item).find('input').val();
		if (i == 0 && input1 == "" &&  mac_len != 1){
			return true;
		}
		
		if (input1 == ""){
			pass = 0;
			_alert(2,"客户端集合操作","请输入MAC地址",$(item).find('input'));
			return false;
		}
		if (!MACReg.test(input1)){
			pass = 0;
			_alert(1, '客户端集合操作', 'MAC地址格式不正确',$(item).find('input'));
			return false;
		}
		$('#MACAddress').children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var input2 = $(item1).find('input').val();
			if (input2 == ""){
				pass = 0;
				_alert(2,"客户端集合操作","请输入MAC地址",$(item1).find('input'));
				return false;
			}
			if (!MACReg.test(input2)){
				pass = 0;
				_alert(1, '客户端集合操作', 'MAC地址格式不正确',$(item1).find('input'));
				return false;
			}
			if (input1 == input2){
				pass = 0;
				_alert(2,"客户端集合操作","相同的MAC地址已存在",$(item).find('input'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	
	if (pass == 0){
		return false;
	}
	
	var input_str1 = $("#MACAddress1").find("span[class='ss ss-add']").children("input").first().val().trim();
	var input_str2 = $("#MACAddress1").find("span[class='ss ss-add']").children('input').last().val().trim();
		
	if (input_str1 == "" && input_str2 == "" && !$(">span[class='ss']", "#MACAddress1").length) {
		mac_address1 = 0;
	}
	var mac1_len = $("#MACAddress1").children('span').length;
	$("#MACAddress1").children('span').each(function(i,item){
		if (mac_address1 == 0){
			return true;
		}
		var mac_input1 = $(item).find('input:eq(0)').val();
		var mac_input2 = $(item).find('input:eq(1)').val();
		if (i == 0 && mac_input1 == "" && mac_input2 == "" && mac1_len != 1){
			return true;
		}
		if (mac_input1 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '请输入起始MAC地址',$(item).find('input:eq(0)'));
			return false;
		} else if (!MACReg.test(mac_input1)) {
			pass = 0;
			_alert(1, '客户端集合操作', '起始MAC地址格式不正确',$(item).find('input:eq(0)'));
			return false;
		}
		if (mac_input2 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '请输入结束MAC地址',$(item).find('input:eq(1)'));
			return false;
		} else if (!MACReg.test(mac_input2)) {
			pass = 0;
			_alert(1, '客户端集合操作', '结束MAC地址格式不正确',$(item).find('input:eq(1)'));
			return false;
		}
		var r_v = _compare_mac(mac_input1,mac_input2);
		if (r_v != 3){
			pass = 0;
			_alert(2, '客户端集合操作', '开始MAC地址不能大于等于结束MAC地址',$(item).find('input:eq(0)'));
			return false;
		}
		
		$("#MACAddress1").children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var mac1_input1 = $(item1).find('input:eq(0)').val();
			var mac1_input2 = $(item1).find('input:eq(1)').val();
			if (mac1_input1 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '请输入起始MAC地址',$(item1).find('input:eq(0)'));
				return false;
			} else if (!MACReg.test(mac1_input1)) {
				pass = 0;
				_alert(2, '客户端集合操作', '起始MAC地址格式不正确',$(item1).find('input:eq(0)'));
				return false;
			}
			if (mac1_input2 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '结束MAC地址为空',$(item1).find('input:eq(1)'));
				return false;
			} else if (!MACReg.test(mac1_input2)) {
				pass = 0;
				_alert(2, '客户端集合操作', '结束MAC地址格式错误',$(item1).find('input:eq(1)'));
				return false;
			}
			var r_v = _compare_mac(mac1_input1,mac1_input2);
			if (r_v != 3){
				pass = 0;
				_alert(2, '客户端集合操作', '开始MAC地址不能大于等于结束MAC地址',$(item1).find('input:eq(0)'));
				return false;
			}
			if (mac1_input1 == mac_input1 && mac1_input2 == mac_input2){
				pass = 0;
				_alert(2,"客户端集合操作","相同的MAC地址区间已存在",$(item).find('input:eq(1)'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	if (pass == 0){
		return false;
	}
	
	if (mac_address == 0 && ip_section == 0 && mac_address1==0 && ip_section1==0) {
		_alert(2, "客户端集合操作", "请输入IP地址/区间、MAC地址/区间", $("#ip_n_c1").find("span[class='ss ss-add']").children("input"));
		return false;
	}

	if (pass == 1) {
		client_set.ClientScopeId = clientId;
		client_set.ClientScopeName = val;
		client_set.IPList.Set = new Array();
		client_set.MACList.Set = new Array();
		var i = 1;
		var $all=$('#ip_n_c').find('span[class=ss]');
		var len=$all.length;
		for(j=len-1;j>=0;j--){
			var ip_id =$all.eq(j).attr("value");
			var input1 = $all.eq(j).find("input").eq(0).val();
			var input2 = $all.eq(j).find("input").eq(1).val();
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + input1 + '","EndIP":"' + input2 + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}

		if (v != "" && v1 != "") {
			ip_id = $("#ip_span").attr("value");
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + v + '","EndIP":"' + v1 + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}
		var $all=$('#ip_n_c1').find('span[class=ss]');
		var len=$all.length;
		for(var j=len-1;j>=0;j--){
			var ip_id = $all.eq(j).attr("value");
			var ip_str =  $all.eq(j).find("input").val();
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + ip_str + '","EndIP":"' + ip_str + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}

		if (v2 != "") {
			ip_id = $("#ip_span1").attr("value");
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + v2 + '","EndIP":"' + v2 + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}
		var i = 1;
		var $all=$("#MACAddress").find('span[class=ss]');
		var len=$all.length;
		for(var j=len-1;j>=0;j--){
			var mac_id = $all.eq(j).attr("value");
			var mac_str = $all.eq(j).find("input").val();
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + mac_str + '","EndMACAddress":"' + mac_str + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++;
		}

		if (input_str != "") {
			var mac_id = $("#MACAddress").find('.ss-add').attr("value");
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + input_str + '","EndMACAddress":"' + input_str + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++
		}
		var $all=$('#MACAddress1').find('span[class=ss]');
		var len=$all.length;
		for(var j=len-1;j>=0;j--){
			var mac_id = $all.eq(j).attr("value");
			var mac_0 = $all.eq(j).find("input").eq(0).val();
			var mac_1 = $all.eq(j).find("input").eq(1).val();
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' +mac_0 + '","EndMACAddress":"' +mac_1 + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++;
		}

		if(input_str1!="" && input_str2!=''){
			var mac_id = $("#MACAddress1").find('.ss-add').attr("value");
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + input_str1 + '","EndMACAddress":"' + input_str2 + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++;
		}
		client_set.IsApplyToServerScope = false;
		save_client(client_set,d);
	}
}
//加入ip
function _addIp_c1(obj) {
	var pass = 1;
	var v = $(obj).prev('input').val().trim();
	if (v == '') {
		_alert(1,"客户端集合", '请输入IP',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	} else if (!ipReg.test(v)) {
		_alert(1,"客户端集合", 'IP格式不正确',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	} else {
		$(">span[class='ss']", "#ip_n_c1").each(function () {
			ip_str = $(this).find("input").val();
			if (ip_str == v) {
				_alert(1,"客户端集合", '相同的IP已存在',$(obj).prev('input'));
				//$(obj).prev('input').val("");
				pass = 0;
				return false;
			}
		});
	}
	var ip_id = $("#ip_span1").attr("value");
	if (pass == 1) {
		var $c = $('<span class="ss" style="float:left;position:static;padding: 0 0 10px 0;width:195px;" value=' +ip_id + '/>');
		$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + v+ '" >'
		+'<i class="ctr ctr-del" onclick="_delIp(this)"  style="margin-top: 5px;margin-left: -3px;"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').focus();
		$("#ip_span1").attr("value", "0");
	}
	initformlist();
}

//加入ip
function _addIp_c(obj) {
	var pass =1;
	var v1 = $(obj).prev().val().trim();
	var v = $(obj).prev().prev().prev().val().trim();
	
	if (v == '') {
		_alert(2,"客户端集合", '请输入起始IP', $(obj).prev().prev().prev());
		//$(obj).prev().prev().prev().val("");
		return false;
	} else if (!ipReg.test(v)) {
		_alert(1,"客户端集合", '起始IP格式不正确', $(obj).prev().prev().prev());
		//$(obj).prev().prev().prev().val("");
		return false;
	}
	if (v1 == '') {
		_alert(2,"客户端集合", '请输入结束IP',$(obj).prev());
		//$(obj).prev().val("");
		return false;
	} else if (!ipReg.test(v1)) {
		_alert(1,"客户端集合", '结束IP格式不正确',$(obj).prev());
		//$(obj).prev().val("");
		return false;
	}
	if(v==v1){
		_alert(1,"客户端集合", '起始IP不能大于等于结束IP',$(obj).prev().prev().prev());
		//$(obj).prev().prev().prev().val("");
		return false;
	}
	//add zero
	var v_str = v.split(".");
	var v1_str = v1.split(".");
	for (var i = 0; i < 4; i++) {
		if (parseInt(v_str[i]) > parseInt(v1_str[i])) {
			_alert(1,"客户端集合", '起始IP不能大于等于结束IP',$(obj).prev().prev().prev());
			return false;
		}else if (parseInt(v_str[i]) < parseInt(v1_str[i])) {
			break;
		}
	}
	$('>span[class=ss]','#ip_n_c').each(function(){
		var input1=$(this).find('input').eq(0).val();
		var input2=$(this).find('input').eq(1).val();
		if(input1==v && input2==v1){
			_alert(2,'客户端集合','相同的IP区间已存在', $(obj).prev().prev().prev())
			pass=0;
			return false;
		}
	});
	if(pass==1){
		var ip_id = $("#ip_span").attr("value");
		var $c = $('<span class="ss" value="' + ip_id + '" style="float:left;width: 340px;position:static;padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;"value="'+v+'" >'
		+'<span style="vertical-align:middle;padding-left: 5px;    padding-right: 4px;">-</span>'
		+'<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="'+v1+'" >'
		+'<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
		$(obj).parent().after($c);
		$(obj).prev().val("");
		$(obj).prev().prev().prev().val("");
		 $(obj).prev().prev().prev().focus();
		$("#ip_span").attr("value", "0");
	}
	initformlist();
}

function _addMAC(obj) {
	var pass = 1;
	var v = $(obj).prev('input').val().trim();

	if (v == '') {
		_alert(2, "客户端集合", "请输入MAC地址",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else if (!MACReg.test(v)) {
		_alert(2, "客户端集合", "MAC地址格式不正确",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else {
		$(">span[class='ss']", "#MACAddress").each(function () {
			mac_str = $(this).find("input").val();
			if (mac_str == v) {
				_alert(2, "客户端集合", "相同的MAC地址",$(obj).prev('input'))
				//layer.alert('MAC重复！',{icon: 2});
				//$(obj).prev('input').val("");
				pass = 0;
				return false;
			}
		});
	}
	var mac_id = $(obj).parent().attr("value");
	if (pass == 1) {
		var $c = $('<span class="ss" value="' +  mac_id + '" style="float:left;position:static;width: 190px;padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text" style="width:138px;padding-right: 8px;" value="' + v + '" >'
		+'<i class="ctr ctr-del" style="    margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').focus();
	}
	initformlist();
}

function _addMAC1(obj) {
	var pass = 1;
	var v1 = $(obj).prev('input').val().trim();
	var v = $(obj).prev('input').prev().prev('input').val().trim();
	
	if (v == '') {
		_alert(2, "客户端集合", "请输入起始MAC地址",$(obj).prev('input').prev().prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else if (!MACReg.test(v)) {
		_alert(1, "客户端集合", "起始MAC地址格式不正确",$(obj).prev('input').prev().prev('input'))
		//$(obj).prev('input').val("");
		return false;
	}
	if (v1 == '') {
		_alert(2, "客户端集合", "请输入结束MAC地址",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else if (!MACReg.test(v1)) {
		_alert(1, "客户端集合", "结束MAC地址格式不正确",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	}
	if (v == v1) {
		_alert(1,"客户端集合", '起始MAC地址不能大于等于结束MAC地址',$(obj).prev('input').prev().prev('input'));
		return false;
	}
	var v_str = v.split(':');
	var v1_str = v1.split(':');
	for (var i = 0; i < 6; i++) {
		if (parseInt(v_str[i], 16) > parseInt(v1_str[i], 16)) {
			_alert(1,"客户端集合", '起始MAC地址不能大于等于结束MAC地址',$(obj).prev('input').prev().prev('input'));
			return false;
		}else if (parseInt(v_str[i], 16) < parseInt(v1_str[i], 16)) {
			break;
		}
	}
	$('>span[class=ss]','#MACAddress1').each(function(){
		var input1=$(this).find('input').eq(0).val();
		var input2=$(this).find('input').eq(1).val();
		if(input1==v && input2==v1){
			_alert(2,'客户端集合','相同的MAC区间已存在', $(obj).prev().prev().prev())
			pass=0;
			return false;
		}
	});
	
	if (pass == 1) {
		var mac_id = $(obj).parent().attr("value");
		var $c = $('<span class="ss" value="' + mac_id  + '" style="float:left;width: 380px;position: static;padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text"  value="' + v + '" style="width:138px;padding-right: 8px;">'
		+'<span style="vertical-align:middle;padding-left: 5px;padding-right: 5px;">-</span>'
		+'<input type="text" class="form-text"  value="' + v1 + '" style="width:138px;padding-right: 8px;">'
		+'<i class="ctr ctr-del" style="margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').prev().prev('input').val("");
		$(obj).prev('input').prev().prev('input').focus();
	}
	initformlist();
}

function _delMAC(obj) {
	var $c = $(obj).parent();
	$c.remove();
}

//删除ip
function _delIp(obj) {
	var $c = $(obj).parent();
	$c.remove();
}

function save_client(client_set,d) {
	var msstr = aceg(JSON.stringify(client_set),sess);
	$.ajax({
		url: '/bhost/add_client',
		type: "POST",
		async: false,
		data: { a0: sess, a1: JSON.stringify(client_set), a2: "0", a3: "null" ,m1:msstr},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result == true) {
				parent.layer.open({
					type: 1,
					title: '客户端集合',
					content: '<div class="layer-alert"><i class="alert succ"></i>操作成功</div>',
					btn: ['确&nbsp;&nbsp;定'],
					btnAlign: 'c',
					closeBtn: false,
					skin: 'layer-custom',
					area: ['380px', '310px'],
					move: false,
					resize: false,
					yes: function (i) {
						parent.layer.close(i);
						var client_text = $('#accset').find('span').text();
						$("div[data-id=xSelect-client]").remove();
						$('#accset').empty().data('xSelect','');
						bind_client_xSelect();
						if ($("#accset").data('value') == "-1" || $("#accset").data('value') == undefined){
							$("#accset").data('value',result.ClientScopeId);
							$("#accset").find('span').text(client_set.ClientScopeName);
							client_list.splice(0,1,result.ClientScopeId);
						}else{
							$('#accset').find('span').text(client_text);
						}
						d.close().remove();
					}
				});
			} else {
				_alert(1,"客户端集合", result.ErrMsg,$("#c_n"));
				return false;
			}
		}
	});
}

var MACReg = /([A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2}/;
function _autoHeight(){
	var arr = new Array();
	$('div.g-sort:first>div.g-items').each(function(){
		var h = $(this).children('div.g-cont').height();
		arr.push(h);
	});

	var maxh = Math.max.apply( Math, arr);
	$('div.g-sort:first>div.g-items').height(maxh + 45);
}

function _compare_mac(x,y){
	var start_mac1_arry = x.split(':');
	var start_mac2_arry = y.split(':');
	var start_mac1_num = "";
	var start_mac2_num = "";
	for (var mac_i = 0; mac_i < 6; mac_i++){
		start_mac1_num = start_mac1_num + start_mac1_arry[mac_i];
	}
	for (var mac_i = 0; mac_i < 6; mac_i++){
		start_mac2_num = start_mac2_num + start_mac2_arry[mac_i];
	}
	var start_mac1_d = parseInt(start_mac1_num,16);
	var start_mac2_d = parseInt(start_mac2_num,16);
	if (start_mac1_d == start_mac2_d){
		return 1;
	}else if (start_mac1_d > start_mac2_d){
		return 2;
	}else{
		return 3;
	}
}

//获取头像列表
function _getAvatarList(obj){
	var offset = $(obj).offset();
	$('#avatars').css({
		top:offset.top -5,
		left:offset.left -5
	}).show();

	document.onclick = null;

	$('#avatars').hover(function(){
		document.onclick = null;
	},function(){
		document.onclick = function(){
			$('#avatars').fadeOut();
		}
	})
}
//设置头像
function _setAvatar(obj){
	var src = $(obj).children('img').attr('src');
	$(obj).addClass('active').parent().siblings('li').children('a').removeClass('active');
	$('#tAvatar>img').attr('src',src);
	$('#avatars').fadeOut();
	photo = src.split('/')[3];
}

$(window).resize(function(){
	if($('#avatars').is(':visible')){
		var offset = $('#tAvatar').offset();
		$('#avatars').css({
			top:offset.top -5,
			left:offset.left -5
		});
	}
})

</script>

<script>
//节点
var Data = [];
//子节点
var nodeData = [
];
$(function(){
	sess = window.parent.document.frm.se.value;
		// $.ajax({
		// 	url:"/bhost/get_u_Dir",
		// 	type:"POST",
		// 	async:false,
		// 	data:{a0:sess,a1:0,a2:0},
		// 	success:function(result){
		// 		var result = JSON.parse(result);
		// 		Data = result.data.UGroup;
		// 	}
		// })
		// _initList();
		_initList_ug();
});
var global_path = [];
var UGroupSet_tmp = [];
function _initList_ug(pid){
	if(Flag_load == 0){
		return true;
	}
	var admin_list = [];
	admin_id = $('#select_u select').val();
	if(admin_id != -1){
		admin_list.push(admin_id);
	}
	$('#select_u li.item').each(function(i,item){
		admin_list.push($(this).attr('id'));//admin_list已选择的管理员
	})			
	admin_list_str = admin_list.join(',');
	if(admin_list_str.substr(0, 1) == ","){
		admin_list_str = admin_list_str.substr(1);
	}
	admin_str = admin_list_str;
	global_path = [];
	$('#hostRoute div.h-path-wrap a').each(function(){
		global_path.push(parseInt($(this).attr('id').split('-')[2]))
	})
	//global_path = global_path.substr(0,global_path.length-1);
	var Data = [];
	if(UGroupSet_tmp != []){
		$.each(UGroupSet_tmp,function(i,item){
			item.Mode = 2;
			item.Selected = 2;
		})
	}
	$.ajax({
		url:"/bhost/get_u_Dir",
		type:"POST",
		async:true,
		data:{a0:sess,a1:0,a2:admin_str,a3:u_id},
		success:function(result){
			var result = JSON.parse(result);
			Data = result.data.UGroup;
			
			$('#userTree').unbind();
			$('#userTree').on('click','i.h-aicon',function(){
				var $item = $(this);
				var id = $item.data('id').split('-')[1];
				var $u = $item.parent().children('ul');
				if($u.is(':hidden')){
					$item.addClass('h-aicon-d');
					$u.show();
					if($u.children('li').length == 0){
						var v = 2;
						var $input = $(this).siblings('span.checkbox');
						
						var c = $input.attr('class');
						if(c.indexOf('checked')>0){
							v=1;
						}else if(c == 'checkbox'){
							v=0;
						}

						_initHTML($u,id,v,admin_str);
					}
				}else{
					$item.removeClass('h-aicon-d');
					$u.hide();
				}
			}).on('dblclick','i.h-eicon,span.h-name',function () {
				var $item = $(this).siblings('i:first');
				var id = $item.data('id').split('-')[1];
				var $u = $item.parent().children('ul');
				if($u.is(':hidden')){
					$item.addClass('h-aicon-d');
					$u.show();
					if($u.children('li').length == 0){
						var v = 2;
						var $input = $(this).siblings('span.checkbox');
						
						var c = $input.attr('class');
						if(c.indexOf('checked')>0){
							v=1;
						}else if(c == 'checkbox'){
							v=0;
						}

						_initHTML($u,id,v,admin_str);
					}
				}else{
					$item.removeClass('h-aicon-d');
					$u.hide();
				}
			});

			var data = Data;
			$('#userTree').empty();
			if(data != null){
				if(data.length != 0){
					_viewHTML(data,'#userTree');
				}
			}
			
		}
	})
	
}

function down(x, y) {
	if(parseInt(x.Mode) <= parseInt(y.Mode)){
		if(parseInt(x.Mode) == parseInt(y.Mode)){
			if(parseInt(x.UGId) > parseInt(y.UGId)){
				return 1;
			}else{
				return -1;
			}
		}else return 1;
	}else{
		return -1;
	}
}
function _initList(){
	var data = Data;
    _viewHTML(data,'#userTree');

    $('#userTree').on('click','i.h-aicon',function(){
		var $item = $(this);
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if($u.is(':hidden')){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2;
				var $input = $(this).siblings('span.checkbox');
				
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}

				_initHTML($u,id,v);
			}
		}else{
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
    }).on('dblclick','i.h-eicon,span.h-name',function () {
		var $item = $(this).siblings('i:first');
		var id = $item.data('id').split('-')[1];
		var $u = $item.parent().children('ul');
		if($u.is(':hidden')){
			$item.addClass('h-aicon-d');
			$u.show();
			if($u.children('li').length == 0){
				var v = 2;
				var $input = $(this).siblings('span.checkbox');
				
				var c = $input.attr('class');
				if(c.indexOf('checked')>0){
					v=1;
				}else if(c == 'checkbox'){
					v=0;
				}

				_initHTML($u,id,v);
			}
		}else{
			$item.removeClass('h-aicon-d');
			$u.hide();
		}
	});
}

function _initHTML(obj,id,v,admin_str){
	//data
	$.ajax({
		url:"/bhost/get_u_Dir",
		type:"POST",
		async:true,
		data:{a0:sess,a1:id,a2:admin_str,a3:u_id},
		success:function(result){
			var result = JSON.parse(result);
			nodeData = result.data.UGroup;
			
			var cdata = nodeData;
			if(nodeData != null){
				nodeData.sort(down);		
			}
			$(obj).empty();
			$.each(nodeData,function(i,item){
				if(item.MemberNum <= 0 ){
					class_name = 'h-blank blank_in';
				}else{
					class_name = 'h-aicon';
				}
				var index_path = 0;
				if(( index_path= global_path.indexOf(item.UGId)) >=0){
					if(index_path == global_path.length-1) item.Selected=2;
					else item.Selected = 1;
				}
				var flag_disabled = '';
				if(item.Mode == 1){
					flag_disabled = 'disabled';
				}
				if(item.Mode != 0 || item.Selected != 0){
					var $H = $('<li></li>');
					$H.html('<i class="'+class_name+'" data-id="arr-'+item.UGId+'" />'+
						'<input type="checkbox" id="node-'+item.UGId+'" data-check="0" '+flag_disabled+' class="zcheck zcheck-g" data-name="'+item.UGName+'">'+
						'<i class="h-eicon h-eicon-s"></i>'+
						'<span class="h-name" id="spanHG-' + item.UGId + '" style="width: 12em;">'+
						'<span class="h-name-son" style="">' + 
							item.UGName.split('').map(function (params) {
							return '<font>'+params+'</font>'    
						}).join('') + 
						'</span>'+
						'<ul style="display:none">Loading...</ul>');
				}

				$(obj).append($H);
				//setTimeout(_jScrollBar,1000,'spanHG-' + item.UGId);
				
				//if(item.Selected !=0){
					//$("#node-"+item.UGId+"").parent().children('i').eq(0).click();
				//}
				$(obj).append($H);
				//setTimeout(_jScrollBar,1000,'spanHG-' + item.UGId);
			});
			//_checkView(obj);
			_checkView(obj);
		}
	})
	
	
}

function _viewHTML(data,obj){
	data.sort(down);
	$(obj).empty();
	$.each(data,function(i,item){
		if(item.UGId == 1) return true;
		
		if(item.MemberNum <= 0 ){
			class_name = 'h-blank blank_in';
		}else{
			class_name = 'h-aicon';
		}
		var index_path = 0;
		if(( index_path= global_path.indexOf(item.UGId)) >=0){
			if(index_path == global_path.length-1) item.Selected=2;
			else item.Selected = 1;
		}
		var flag_disabled = '';
		if(item.Mode == 1){
			flag_disabled = 'disabled';
		}
		if(item.Mode != 0 || item.Selected != 0){
				var $H = $('<li></li>');
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.UGId+'" />'+
				'<input type="checkbox" id="node-'+item.UGId+'" data-check="0" '+flag_disabled+' class="zcheck zcheck-g" data-name="'+item.UGName+'">'+
				'<i class="h-eicon h-eicon-s"></i>'+
				'<span class="h-name" id="spanHG-' + item.UGId + '" style="width: 12em;">'+
					'<span class="h-name-son" style="">' + 
					item.UGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
					'</span>'+
					'<ul style="display:none">Loading...</ul>');
		}

		$(obj).append($H);
		//setTimeout(_jScrollBar,1000,'spanHG-' + item.UGId);
    });
	_checkView(obj);
}

function _checkView(obj){
    $('input.zcheck',obj).each(function(){
    	var $s = $('<span class="checkbox"></span>');
    	$(this).after($s);
    	var v = $(this).prop('checked');
    	if(v){
    		$s.addClass('checked');
    	}else{
    		var c = $(this).data('check');
    		if(c && c==2){
    			$s.addClass('half');
    		}
    	}

    	var d = $(this).prop('disabled');
    	if(d){
    		$s.addClass('disabled');
    	}
    }).on('change',function(){
    	var v = $(this).prop('checked');
    	var $s = $(this).next('span.checkbox');
    	var $u = $(this).parent().children('ul');
    	if(v){
    		$s.attr('class','checkbox checked');
	    	//$('input.zcheck',$u).prop('checked',true);
	    	//$('span.checkbox',$u).attr('class','checkbox checked');
    	}else{
    		$s.attr('class','checkbox');
	    	//$('input.zcheck',$u).prop('checked',false);
	    	//$('span.checkbox',$u).attr('class','checkbox');
    	}

    	//_checkEvent(this);
    });
}

function _checkEvent(obj){
	var _run = function(){
		var $li = $(obj).parent().parent().parent();
		var tagname = $li[0].tagName.toLowerCase();
		var v = $(obj).prop('checked');

		if(tagname == 'li'){
			var c1=0,c2=0;
			var len = $(obj).parent().parent().children('li').length;
			$(obj).parent().parent().children('li').each(function(){
				var c = $(this).children('span.checkbox').attr('class');
				if(c.indexOf('checked')>0){
					c1++;
				}else if(c.indexOf('half')>0){
					c2++;
				}

				if(c1 == len){
					$li.children('input.zcheck').prop('checked',true).siblings('span.checkbox').attr('class','checkbox checked');//.siblings('span.authtype').show();
				}else if(c1==0 && c2==0){
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox');//.siblings('span.authtype').hide();
				}else{
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox half');
				}
			});
			_checkEvent($li.children('input.zcheck'));
		}else{
			return;
		}
	}

	_run();
}

function _adduser(){
	var p = $("#adduser1").val();
	var p1 = $("#adduser2").val();
	p = parseInt(p);
	p1 = parseInt(p1);
	if (p < 10){
		_alert(2,"系统用户","code要大于10",$("#adduser1"));
		return false;
	}
	for (p; p <= p1; p++){
		var code = "testuser" + p;
		var user1 = {
				"UserId": 0,
				"UserCode": "",
				"UserName": "addtest",
				"Password": "addtest", 
				"Department": null, 
				"MobilePhone": null,
				"Email": null,
				"Description": null,
				"ExpireTimeEnabled": false,
				"ExpireTime": "", 
				"UserStatus": 1,
				"PhotoIcon": "avatar1.jpg",
				"CreatorId": 1,
				"ThirdUserCode": "",
				"ManageIPUnlimited": false,
				"SrcIPUnlimited": false,
				"AuthTypeId": null,
				//"TokenId": "",
				"LanCode": 0,
				"PwdApproveUserId": "2",
				"AdminSet": [{"AdminId":212}
				],
				"UGroupSet": [
				],
				"RoleSet": [{"RoleId":234}
				],
				"ManageAuthSet": [       	
		    	]
		};
		user1.UserCode = code;
		var AccessAuthSet1 = {
		        "UserId": 0, 
		        "AccessAuthSet": [
		        ]
		}

		var UGroupSet = [];
	
		$('#userTree li').each(function(){ 
			if($(this).children('input').prop('checked') == true){
				ugid = $(this).children('input').attr('id').split('-')[1];
				UGroupSet.push(JSON.parse('{"UGId":'+ugid+'}'));
			}
		})
		user1.UGroupSet = UGroupSet;
		var msstr = aceg(JSON.stringify(user1),sess);
		var msstr1 = aceg(JSON.stringify(AccessAuthSet1),sess);
		$.ajax({
			url:'/bhost/add_sys_user',
			type:"POST",
			async:false,
			data:{a0:sess,a1:JSON.stringify(user1),a2:JSON.stringify(AccessAuthSet1),a3:"",a10:"运维管理>系统用户",m1:msstr,m2:msstr1},
			success: function(Result) {
				data = JSON.parse(Result);
				if(data.Result == true){
					document.frm.tasktype.value = 3;
					document.frm.se.value = sess;
					document.frm.action = '/bhost/index';
					document.frm.i10.value = 1;
					document.frm.submit();
				}else{
					_alert(1,"系统用户",data.ErrMsg);
				}
			}
		})
	}
}

function _getWait(obj){
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
	
	$(obj).removeClass('done').show().unbind().on('mouseover',function(){
		waitlayer = layer.tips('搜索中',this,{
			tips:1,
			time:0,
			skin: 'waitlayer'
		});
	}).on('mouseout',function(){
		if(typeof waitlayer != 'undefined'){
			layer.close(waitlayer);
		}
	});
}

function _waitDone(obj){
	if(typeof waitlayer != 'undefined'){
		layer.close(waitlayer);
	}
	$(obj).fadeOut(3000);
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
}

/*
Functions about the tree search result!
*/
function click_h(){
	$('#userTree').find('span.h-name-red').find('.font-red').removeClass('font-red');
	$('#userTree').find('span.h-name-red').removeClass('h-name-red');
	$('#userTree').find('ul').hide();
	$('#userTree').find('li').hide();
	$('#userTree').find('i.h-aicon-d').trigger('click');
}
var path_all;
function find_usergroup(){
	$('#userTree').find('li').show();
	click_h();
	$('#userTree').find('li').hide();
	jsondata={
		"ugid": 0,
		"istree": true,
		"ugname":"",
		"limitrow":null,
		"offsetrow":0
	}
	var GName = '';
	search_usert = search_user + search_user_n;
	find_host_arry = search_usert.split('\t');
	$.each(find_host_arry,function(i,item){
		if(item == '' || item == null){
			return true;
		}
		var item_id = item.indexOf('-');
		GName += (item.substr(item_id + 1,item.length)+'\n');
	})
	GName = GName.substr(0,GName.length - 1);
	jsondata.ugname = GName;
	if (GName == ""){
		$('#userTree').find('li').show();
		return false;
	}
	$.ajax({
		url: '/bhost/find_user_list',
		type: "POST",
		async: true,
		data: {a0:sess,a1:JSON.stringify(jsondata)},
		success: function(result){
			result = JSON.parse(result);
			result = result.info;
			if (result == null){
				$("#user_text").blur();
				_waitDone($(".waitTip1"));
				$('#userTree').find('li').hide();
				_alert(0,'搜索','无搜索结果',$("#user_text"));
				return false;
			}
			path_all = result;
			if (path_all.length != 0){
				$.each(path_all,function(i,item){
					var Path_array=item.Path.split('/');
					var len=Path_array.length;
					for(var j=1;j<len-1;j++){
						var id=Path_array[j].split(',')[1];
						$i_item=$('#node-'+id).siblings('i.h-aicon');
						if($('#node-'+id).length != 0){
							if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
								$i_item.parent('li').show();
								$i_item.trigger('click');
								$i_item.siblings('ul').find('li').hide();
							}
						}
					}
					if(item.Type==1){
						if($('#node-'+item.Id).length != 0){
							$('#node-'+item.Id).parent('li').show();
							$('#node-'+item.Id).siblings('span.h-name').addClass('h-name-red');
							var $span_son_font=$('#node-'+item.Id).siblings('span.h-name').find('font')
							var span_son_name=$('#node-'+item.Id).attr('data-name').toLowerCase();
							$.each(search_usert.split('\t'),function(i1,item1){
								if(item1=='' || item1==null){
									return true;
								}
								var index=item1.indexOf('-');
								switch (item1.substring(0,index)) {
									case 'Name':
									case '':
									case '组名':
									case '0':
										$.each(item1.substring(index+1).split(' '),function (i_s,params_s) {
											params_s=params_s.toLowerCase();
											var index_true=span_son_name.indexOf(params_s);
											if(index_true>=0){
												for(var i_red_span=index_true;i_red_span<index_true+params_s.length;i_red_span++){
													$span_son_font.eq(i_red_span).addClass('font-red');
												}
											}
										});
										break;
								}
							});
						}
					}
				})
				li_hide_while_no_red_1($('#userTree'),0);
				scrollTop_check_server();
			}else{
				$("#user_text").blur();
				_waitDone($(".waitTip1"));
				_alert(0,'搜索','无搜索结果',$("#user_text"));
			}
		}
	});
}
function li_hide_while_no_red_1(obj,num){
	var li_visible=$(obj).children('li');
	var _len=li_visible.length
	if(num<_len){
		var item=li_visible.eq(num);
		if($(item).children('span.h-name-red').length!=0){
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
		}else if($(item).find('span.h-name-red').length==0){
			$(item).hide();
		}else{
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
			var $children_ul=$(item).children('ul');
			if($children_ul.length>0){
				setTimeout(function(){
					li_hide_while_no_red_1($children_ul,0);
				},1);
			}
		}
	}
	var item_1=li_visible.eq(num+1);
	if(item_1.length!=0){
		setTimeout(function(){
			li_hide_while_no_red_1(obj,num+1);
		},1);
	}
}
function scrollTop_check_server(){
	$('.c-cont').scrollTop(0);
	if(path_all.length!=0){
		var top=9007199254740992;
		$.each(path_all,function(i,item){
			if($('#node-'+item.Id).length != 0){
				if(item.Type==1){
					var top_item=$('#node-'+item.Id).offset().top;
					if(top_item<top){
						top=top_item;
					}
				}
			}
		});
		$('.c-cont').scrollTop(top+300);
		_waitDone($(".waitTip1"));
	}
}
var clientId1;
var clientId2;
function reload(type){
	if(type == 0){
		document.u_add.tasktype1.value=1;
		document.u_add.action = '/bhost/access_user_index';
		document.u_add.submit();
	}else if(type == 1){
		_editNode2(clientId1,clientId2);
	}
}
/*
*/
var authtype_data;
//var flag_pwd_default = 0;
function get_authtype_list(){
	$.ajax({
		url: "/bhost/get_authtype_list",
		type:"POST",
		async:false,
		data:{a0:sess},
		success:function(result){
			var authtype_result = JSON.parse(result);
			if (authtype_result.Result==true){
				authtype_list = authtype_result.info.data;
				authtype_data = authtype_list;
				//$('#sys_u_authtype').empty();
				//$('#sys_u_authtype').append('<option value="null" selected>默认</option>');
				var default_authtype = {};
				var flag_pwd_default=0;
				var flag_usbkeylen_default=-1;
				$(authtype_data).each(function(i,item){
					//查看是否存在 本地认证		0->包含本地认证  不包含usbkey    1->不包含本地认证 但是 包含 TOTP    3->包含usbkey 不包含本地认证   4  包含usbkey  包含本地认证    2-> 不包含 0 1 3 4的情况 	5->只包含本地认证
					var flag_pwd = 0; 					
					var tmplist = [];
					var usbkeylen = -1; //不是usbkey认证
					
					$(item.Set).each(function(i1,item1){
						tmplist.push(item1.AuthMode);	
						if(item1.AuthMode == 8) {
							if(item1.PwdLen !=null) usbkeylen =  item1.PwdLen;
							else usbkeylen = 0; //没有配置长度
						}
					})
					
					if(tmplist.indexOf(1) >=0){
						flag_pwd = 0;
					}
					else{
						flag_pwd = 2;
					}
					if(tmplist.indexOf(9) >=0){
						flag_pwd = flag_pwd+',9';
					}
					if(item.IsDefault == true){
						flag_pwd_default = flag_pwd;
						flag_usbkeylen_default = usbkeylen;
					}
					authtype_data[i].flag_pwd = flag_pwd;
					authtype_data[i].usbkeylen = usbkeylen;
				})
				 default_authtype = {
					"Set": [

					],
					"IsDefault": true,
					"Separator": null,
					"AuthTypeId":-1,
					"AuthTypeName": "默认",
					"MustAllModulesSucc": true
				}
				default_authtype.flag_pwd=flag_pwd_default;
				default_authtype.usbkeylen=flag_usbkeylen_default;
				authtype_data.unshift(default_authtype);
				
				
				authDefault_flag = 0;	
				$.each(authtype_data,function(i,item){
					if(item.IsDefault == true){
						$.each(item.Set,function(i1,item1){
							if(item1.AuthMode == 6){
								authDefault_flag += 1;
							}else if(item1.AuthMode == 8){
								authDefault_flag += 2;
							}
						})
					}	
				})
				
				//$('#sys_u_authtype option').eq(0).attr('flag_pwd',flag_pwd_default);
				//$('#sys_u_authtype').select2().trigger('change');
			}
		}
	})
	
}
var AuthType_role = 0;
function get_AuthType_role(){ // 0 只能选  1 能看到 2 能编辑
	$.ajax({
		url: "/bhost/get_AuthType_role",
		type:"POST",
		async:false,
		data:{a0:sess},
		success:function(result){
			var results = JSON.parse(result);
			if (results.Result==true){
				AuthType_role = results.info
			}
		}
	})
}  
var c_index_all_authtype = [];
var authtype_list_tmp =[];
//绑定客户端集合
function bind_authtype_xSelect(){
	get_authtype_list();
	$('#sys_u_authtype').empty().data('xSelect','');
	var authtype_array = [];
	c_index_all_authtype = [];
	$.each(authtype_data,function(i,item){
		if ($("#sys_u_authtype").data('value') == item.AuthTypeId){
			
		}else{
			if (authtype_list_tmp.indexOf(item.AuthTypeId) > -1){
				return true;
			}
		}
		if(AuthType_role == 0){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'flag_pwd':0,
				'usbkeylen':0,
				'type':''
			};
		}else if (AuthType_role == 1){
			if(item.AuthTypeId == -1){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':''
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':'check'
				};
			}
		}else{
			if(item.AuthTypeId == -1){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':''
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':'edit'
				};
			}
		}
		select_data_json.value = item.AuthTypeId;
		select_data_json.name = item.AuthTypeName;
		select_data_json.flag_pwd = item.flag_pwd;
		select_data_json.usbkeylen = item.usbkeylen;
		authtype_array.push(select_data_json);
		c_index_all_authtype.push(item.AuthTypeId);
	});
	if(AuthType_role ==2){
		$('#sys_u_authtype').xSelect({
			width: 200,
			defaultText: '默认',
			items:authtype_array,
			module_type:'authtype',
			edit: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			check: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_editNode3(obj,1);
					}
				}
			],
			setval:function(item,obj){
				change_authtype_scope(obj);
			}
		});
	}else{
		$('#sys_u_authtype').xSelect({
			width: 200,
			defaultText: '默认',
			items:authtype_array,
			module_type:'authtype',
			edit: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			check: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			setval:function(item,obj){
				change_authtype_scope(obj);
			}
		});
	}
	$("#sys_u_authtype").find('span').text("默认");
	$('#sys_u_authtype').data('value','-1');
	change_authtype_scope($(".xSelect-authtype li").eq(0));
	$(".xSelect-authtype li").eq(0).attr('class','active');
	if($("#FinP_reset_div").find("text").is(":visible") == true && $("#FinP_reset_div").find("text").text() == "已录入"){
		$("#select_local").val('1').trigger('change').attr("disabled",true);
	}else if($("#changepin_div").find("text").is(":visible") == true && $("#changepin_div").find("text").text() == "已配置"){
		$("#select_local").val('1').trigger('change').attr("disabled",true);
	}else{
		$("#select_local").val('0').trigger('change').attr("disabled",false);
	}
}

var global_auth = -1;
var global_flag_pwd = 0;
function change_authtype_scope(obj){
	var auth_type = $(obj).children('span').data('value');
	global_auth = parseInt(auth_type);
	auth_class = 0;
	var F1 = false;
	var totp_flag = false;
	//yt 2018-05-10
	ts = $(obj).children('span').attr('flag_pwd').split(',');
	flag_pwd = ts[0];
	global_flag_pwd = flag_pwd;
	flag_usekey = false; //第三方key
	if( ts.length > 1){
		flag_usekey = true;
	}

	if(auth_type == '-1'){
		if(authDefault_flag == 1){
			auth_class = 1;
		}else if(authDefault_flag == 2){
			auth_class = 2;
		}else if(authDefault_flag == 3){
			auth_class = 3;
		}
	}else{
		$.each(authtype_data,function(i,item){
			if(auth_type == item.AuthTypeId){
				$.each(item.Set,function(i1,item1){

					if(item1.AuthMode == 6){
						auth_class += 1;
					}else if(item1.AuthMode == 8){
						auth_class += 2;
						F1 = true;
					}else if(item1.AuthMode == 13){ //中控指纹
						auth_class += 4;
						F1 = true;
					}else if(item1.AuthMode == 10){ //totp
						totp_flag = true;
					}
				})
				return false;
			}
		})
	}
	//$("#changepin_local").hide();
	/*	
			1: 令牌
			2:  key
			3: 令牌 + key
			4:  指纹
			5:  指纹 + 令牌
			6: 指纹 + key
			7: 令牌 + key + 指纹
	*/
		if(auth_class == 2){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().show();
			$("#changePIN").text('设置pin码');
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
			//$("#changepin_div1").attr('style','width: 8%; position: absolute; margin-left: 290px; margin-top: -27px;');
		}else if(auth_class == 1){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
			//$("#tokenid_div").attr('style','width:20%; margin-left: 305px; margin-top: -40px;');
		}else if(auth_class == 3){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 4){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 5){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 6){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().show();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 7){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else{
			$("#auth_div").hide();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}

		//密码栏处理
		/*
		先全部锁定
			存在usbkey 第三方 指纹 ->F1 放开初始密码（保存认证配置时 判断 不存在未配置的时候 锁定初始密码）
			存在本地认证 放开设置密码 （默认为设置密码）
			存在TOTP 只有初始密码 ->totp_flag
			保存的时候判断（设置密码情况下 存在未配置的认证配置时 提示录入或者设置pin）
		*/
		$("#select_local").val('1').trigger('change').attr("disabled",true);
		$('#sys_u_pwd_new').attr('disabled',true);
		$('#sys_u_pwd_tr').attr('disabled',true);
		$('#btn_pwd').parent().hide();
		if(F1 == true){
			$("#select_local").val('0').trigger('change').attr("disabled",true);
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}
		if(flag_pwd == '0'){
			$("#select_local").val('1').trigger('change').attr("disabled",false);
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}
		if(totp_flag == true){
			$("#select_local").val('0').trigger('change').attr("disabled",true);
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}
	
	//查看是否存在 本地认证		0->包含本地认证 1->不包含本地认证 但是 包含 TOTP Logbase usbkey	2-> 不包含 0 1 的情况

	////短信 手机必填 邮箱认证 邮箱必填
	var flag_phone= false;
	var flag_email = false;
	if(auth_type == '-1'){
		$.each(authtype_data,function(i,item){
			if(item.IsDefault == true){
				$.each(item.Set,function(i1,item1){
					if(item1.AuthMode == 11){
						flag_phone = true;
					}
					if(item1.AuthMode == 12){
						flag_email = true;
					}
				})
				return false;
			}
		})
	}else{
		$.each(authtype_data,function(i,item){
			if(auth_type == item.AuthTypeId){
				$.each(item.Set,function(i1,item1){
					if(item1.AuthMode == 11){
						flag_phone = true;
					}
					if(item1.AuthMode == 12){
						flag_email = true;
					}
				})
				return false;
			}
		})
	}
	if(flag_phone == true){
		$('#phone_em').show();
	}else{
		$('#phone_em').hide();
	}
	if(flag_email == true){
		$('#mail_em').show();
	}else{
		$('#mail_em').hide();
	}
	
	//
	usbkeylen = flag_pwd = $(obj).children('span').attr('usbkeylen');
	if(usbkeylen == '-1' || usbkeylen == '0'){
		$('#pin_input1').removeAttr('maxlength');
		$('#pin_input2').removeAttr('maxlength');
	}else{
		$('#pin_input1').attr('maxlength',usbkeylen);
		$('#pin_input2').attr('maxlength',usbkeylen);
	}
	//
	if(flag_usekey) $('#CertCn_div').show();
	else $('#CertCn_div').hide();
	
}

var FP_SET = false;		//是否配置指纹
var FP_TMP = "";
var KEY_SET = false;	//是否配置Pin

var client_data;
var d_authtype ;
function _editNode3(obj,type){
	title = "认证方式";
	var $dialogCont = $("#authtype_suspend").show();
	
	d_authtype = dialog({
		title:title,
		content:$dialogCont,
		id:"authtype_suspend",
		width:"1200px"
	});
	if(type == 1){
		authtypeId = 0;
	}else{		
		authtypeId = $(obj).children('span').data('value')
	}
	$('#mframe1').attr('src','/bhost/authtype_handle?tasktype='+type+'&authtypeId='+authtypeId+'&paging=1&search_typeall=&e=all-&se='+sess+'&i1=1')
	d_authtype.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d_authtype.showModal();
	//initformlist();
	$(".ui-dialog-title").css("width","140px");
	//client_main(type);
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		//reload(1);
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
		//client_add(d);	
	})	
}
var fp_index = 1;
function IfSaveSuccess(sesstime){
	$.ajax({
		url: "/bhost/get_fpResult",
		type:"POST",
		async: true,
		data:{a0:window.parent.document.frm.us.value,a1:sesstime},
		success:function(result){
			//{\"Result\":true,\"status\":\"%s\",\"finger\":\"%s\"}
			var result=JSON.parse(result);
			if(result.Result){
				if(result.status == 1){
					_closeLoading();
					clearInterval(if_ok);
					_alert(0,'系统用户','录入成功');
					$("#FinP_reset_div").find('text').text("已录入");
					if($("#select_local").val() == "0" && $("#select_local").prop('disabled') == true){
						$("#select_local").val('0').trigger('change');
					}else{
						$("#select_local").val('1').trigger('change').attr("disabled",true);
					}
					FP_SET = true;
					name_index = 1;
					fp_index = getRamdomIndex(1);
					name_index = getNameIndex(1);
					var fp_name = "指纹"+name_index;
					if(FP_TMP == ""){
						FP_TMP = fp_name + '\t' + result.finger;
					}else{
						FP_TMP = FP_TMP + '\n' + fp_name + '\t' + result.finger;
					}
					var html_str1 = '<li class="item" id="fp_index'+fp_index+'" index="'+fp_index+'" style="width: 16.5%;"><input type="text" class="form-text" id="fp_conf'+fp_index+'" maxlength="31" style="width: 66px;" onblur="change_fpName(this)"><i class="ctrl del" onclick="_delFp(this)"></i></li>';
					$("#auth_divs").append(html_str1);
					$("#auth_divs").children('li:last').children('input').val(fp_name);
				}else if(result.status == 3){
					_closeLoading();
					clearInterval(if_ok);
				}
			}else{
				_alert(1,"系统用户",result.ErrMsg);
				return false;
			}
		}
	})
}
function getRamdomIndex(fp_index) {
	var flag4 = true;
	function innerFunc1(){
		flag4 = true;
		$.each($("#auth_div").find('li'),function(i,item){
			if($(item).children('input').val().substring(0, 2) == "指纹" && fp_index == $(item).attr('index')){
				fp_index++;
				flag4 = false;
				innerFunc1(fp_index);
				return false;
			}
		})
	}
	innerFunc1(fp_index);
	if(flag4 == true){
		return fp_index;
	}
}
function getNameIndex(name_index) {
	var flag4 = true;
	function innerFunc1() {
		flag4 = true;
		$.each($("#auth_divs").find('li'),function(i,item){
			if($(item).children('input').val() == "指纹"+name_index){
				name_index++;
				flag4 = false;
				innerFunc1(name_index);
				return false;
			}
		})
	}	
	innerFunc1(name_index);
	if(flag4 == true){
		return name_index;
	}
}
function _delFp(obj) {
	var $c = $(obj).parent();
	var fname = $(obj).prev().val();
	$c.remove();
	var fp_list = FP_TMP.split('\n');
	$.each(fp_list,function (i,item) {
		if(item.split('\t')[0] == fname){
			fp_list.splice(i,1);
			return false;
		}
	})
	FP_TMP = fp_list.join('\n');
	if(FP_TMP == ""){
		$("#FinP_reset_div").find('text').text("未录入");
	}
}
function change_fpName(obj) {
	var index = $(obj).parent().index() - $("#auth_divs").children('div').length;
	var fname = $(obj).val();
	if(fname == ""){
		_alert(1, "用户登录", "指纹配置名称不能为空");
	}
	var fp_list = FP_TMP.split('\n');
	var flag3 = false;
	$.each(fp_list,function (i,item) {
		if(item.split('\t')[0] == fname && index != i){
			flag3 = true;
			$(obj).val("");
			_alert(1, "用户登录", "已存在相同指纹配置名称");
			return false;
		}
		if(index == i){
			var fname_tmp = item.split('\t')[1];
			fp_list[i] = fname + '\t' + fname_tmp;
		}
	})
	if(flag3 == false){
		FP_TMP = fp_list.join('\n');
	}
}
//中控指纹
var re_5;
function setFinP() {
	if(FP_TMP.split('\n').length >= 10){
		_alert(1,"系统用户","指纹配置不能超过十个");
		return false;
	}
	var sesstime = new Date().getTime();
	//type -> 录入 Register    验证 Verify
	json_data = {
		"type": "Register",
		"UrlIp": document.domain+ (location.port!=''?':'+location.port:''), 
		"sesstimet": sesstime, 
		"User": window.parent.document.frm.us.value, 
		"Id": "",
		"Ifzkfp": 1
	}
	_showLoading();
	$.ajax({
		url: "/bhost/insert_fp",
		type:"POST",
		async: true,
		data:{a0:window.parent.document.frm.us.value,a1:sesstime},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				$.ajax({
					url: "/bhost/get_base64",
					type:"POST",
					async: true,
					data:{z1:JSON.stringify(json_data)},
					success:function(result){
						var result=JSON.parse(result);
						if(result.Result){
							base64_str = result.b64;
							$('#YuFrame1').remove();
							$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
							$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+ base64_str);
							//每5秒刷新录入结果
							var c = 0;
							var if_ok_down_other = setInterval(function(){
								var se = se || ' ';
								var ret = repeat_get_path_other(sesstime,se);
								if(ret[0] == 1 && ret[1].toLowerCase() == 'true' ){
									if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='1';
									clearInterval(if_ok_down_other);
									re_5 = function(){
										if_ok = setInterval(function(){
											IfSaveSuccess(sesstime);
										},1000)}
									re_5();
									return 0;
								}
								if(c >= 10){
									if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='0';
									clearInterval(if_ok_down_other);
									alertError('bhost',se,window.parent.document.frm.us.value);
									_closeLoading();
									return 0;
								}
								c = c + 1;
							},500)
						}else{
							_alert(1,"用户登录",result.ErrMsg);
							return false;
						}
					}
				})
			}else{
				_alert(1,"系统用户",result.ErrMsg);
				return false;
			}
		}
	})
}

//角色编辑样式整理

</script>
<script type="text/javascript">
//角色
var role_data;
var role_data_all = [];
var Role_Data = [];
var roleid = null;
var userid_str = '';
function _get_rn(){
	$.ajax({
		url:"/bhost/_get_rn",
		type:"POST",
		async:false,
		data:{a0:sess,a1:userid_str},
		success:function(result){
			role_result = JSON.parse(result);
			if(role_result.Result){
				role_data = role_result.info;
				Role_Data = role_data;
				$("#rn").empty().append('<option value=\"-1\">请选择</option>');
				$.each(role_data.data,function(i,item){
					pwd_flag = 0;
					access_flag = 0;
					$(item.Permission).each(function(i1,item1){
						if(item1.SubMenuId == 19 || item1.SubMenuId == 20 || item1.SubMenuId == 21 || item1.SubMenuId == 22 || item1.SubMenuId == 29 || item1.SubMenuId == 30 || item1.SubMenuId == 31 && item1.Mode != 0){
							pwd_flag = 1;
						}
						if(item1.SubMenuId == 25 && item1.Mode != 0){
							access_flag = 1;
						}
					})
					item['pwd_flag'] = pwd_flag;
					item['access_flag'] = access_flag;
					//$("#rn").append('<option value="'+item.RoleId+'" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" title="'+item.RoleName+'">'+item.RoleName+'</option>');
					if(role_data_all.indexOf(item.RoleId) <0 ) role_data_all.push(item.RoleId);
				})
			}else{
				_alert(1,"系统用户",'获取角色失败');
			}
		}
	});
}

function reload_un(FLAG){ //重新加载功能管理员，系统用户员不变
	var sid = -1;
	var admin_list = [];
	var isRoot = false;
	if(FLAG == undefined){
		FLAG = true;
	}
	admin_id = $('#select_u select').val();
	if(admin_id != -1 && admin_id != null){
		$.each(Admin_Data,function(i1,item1){
			if(admin_id == item1.UserId){
				isRoot = item1.UserRoot;
			}
		})
		if(isRoot == false){
			admin_list.push(admin_id);
		}
	}
	$('#select_u li.item').each(function(i,item){
		var isRoot = false;
		$.each(Admin_Data,function(i1,item1){
			if($(this).attr('id') == item1.UserId){
				isRoot = item1.UserRoot;
				return false;
			}
		})
		if(isRoot == true){
			$(this).remove();
		}
		else{
			admin_list.push($(this).attr('id'));
		}
	})

	user_data_all = [];

	//重新加载管理员下拉框
	var ro_list = [];
	ro = $("#select_r_xselect").data('value')
	if(ro != -1){
		ro_list.push(ro);
	}
	$('#select_r li.item').each(function(i,item){
		ro_list.push($(this).attr('id'));
	})
	ro_str = ro_list.join(",");
	var tmp_list = [];
	$.ajax({
		url:"/bhost/_get_un",
		type:"POST",
		async:false,
		data:{a0:sess,a1:null,r1:ro_str},
		success:function(result){
			user_result = JSON.parse(result);
			if(user_result){
				user_data = user_result.info;
				Admin_Data = user_data;
				tmp_list=Admin_Data.map(function (params) {
                     return params.UserId;
                });
				if(sid == -1 || sid != u_id && FLAG == true){
					$("#un").empty().append("<option value=\"-1\">请选择</option>")
					if(tmp_list.indexOf(u_id) >=0 ) 	$("#un").append("<option value=\""+u_id+"\" selected>"+u_nm+"</option>");				
				}else{
					$("#un").empty().append("<option value=\"-1\" selected>请选择</option>")
				}
				//$("#un").empty().append("<option value=\"-1\" selected>请选择</option>")
				if(FLAG == true){
					$.each(user_data,function(i,item){
						if(item.UserId != u_id && item.UserId != global_id){
							// $("#pu_id").append("<option value=\""+item.UserId+"\">"+item.UserCode+"</option>");
							$("#un").append('<option value="'+item.UserId+'" title="'+item.UserCode+'" type="'+item.UserRoot+'">'+item.UserCode+'</option>');
							user_data_all.push(item.UserId);
						}
					})
				}else{
					$.each(user_data,function(i,item){
						if(item.UserId != u_id && item.UserId != global_id && item.UserRoot != true){
							// $("#pu_id").append("<option value=\""+item.UserId+"\">"+item.UserCode+"</option>");
							$("#un").append('<option value="'+item.UserId+'" title="'+item.UserCode+'" type="'+item.UserRoot+'">'+item.UserCode+'</option>');
							user_data_all.push(item.UserId);
						}
					})
				}
			}else{
				_alert(1,"系统用户",'获取管理员失败');
			}
		}
	})
	$("#un").val('-1').trigger('change');
	if(admin_list.length != 0){
		$.each(admin_list,function(i,item){
			$.each(Admin_Data,function(i1,item1){
				if(item == item1.UserId){
					if(item1.UserRoot == true){
						user_arry.splice(0,0,'-1');
						user_data_all.splice($.inArray(parseInt(item), user_data_all), 1);
						$('#un').find('option[value='+item+']').remove();
						global_flag = true;
						$('#un').val('-1').trigger('change');
						user_tmp=[];
						$("#select_u>li").each(function(i,item){
							v_tmp=$(item).attr("id");
							user_tmp.push(v_tmp);
						});
					}else{
						if($("#un").val() != -1 && $("#un").val() != null){
							$("#un").siblings('i').click();
							$("#un").val('-1').trigger('change');
						}
						$("#un").val(item).trigger('change');
						new_admin_str = $("#un").val();				
						$.each($("#select_u").children('li'),function(i3,item3){
							if($(item3).attr('id') == new_admin_str){
								$("#un").siblings('i').click();
								$("#select_u").children('li').eq(0).remove();
								//$("#un").val('-1').trigger('change');
								return false;
							}
						})
					}
				}
			})
		})
	}
	//
	if(admin_id != -1 && admin_id != null){
		$.each(Admin_Data,function(i1,item1){
			if(parseInt(admin_id) == item1.UserId){
				$("#un").val(admin_id).trigger('change');
				return false;
			}
		})
	}
	if($("#un").val() == undefined && admin_id != null){
		$("#un").val('-1').trigger('change');
	}
}

var role_tmp = [];
var role_arry=['-1'];
var global_role = -1;
function role_select(obj){
	var t = $(obj).children('span').data('value')
	global_role = t;
	if (role_arry.indexOf(t) === -1 && t != undefined){
		role_arry.splice(0,1,t);
	}
	//查看 当前角色是否有密码管理的权限
	//获取当前 角色id
	if($(obj).children('span').attr('pwd_flag') == '1'){
		//$('#mail_em').show();
	}else{
		//找到所有的 已选的角色 
		var s = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('pwd_flag') == '1'){
				//$('#mail_em').show();
				s = true;
				return false;
			}
			
		})
		if(!s){
			//$('#mail_em').hide();
		}
	}
	
	if($(obj).children('span').attr('pwd_flag') == '1'){
		$('#exp_auth').show();
	}else{
		//找到所有的 已选的角色 
		var a = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('access_flag') == '1'){
				if(global_id ==0 ) {
					$('#exp_auth').show();
					a = true;
					return false;
				}
				
			}
		})
		if(!a){
			$('#exp_auth').hide();
		}
	}
	
	setTimeout(function() {
		reload_un(CREATE_FLAG);
	},1);
	
}
function _addRole(obj){
	var add = 0;
	var t = $('#select_r_xselect').find('span').text();
	var name2 = $('#select_r_xselect').data('value');
	var pwd_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('pwd_flag');
	var access_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('access_flag');	
	if (name2 == "-1" || name2 == undefined){
		_alert(2,"系统用户","请选择角色");
		return false;
	}

	
	role_arry.splice(0,0,'-1');
	role_data_all.splice($.inArray(parseInt(name2), role_data_all), 1);
	var $c = $(obj).parent();
	var $s = $('<li class="item" id="'+name2+'" style="width: 33%;float: left;margin-left: -10px;height: 40px;margin-top: 9px;overflow: hidden;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:170px;" disabled="true" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" ><i class="ctrl del" onclick="_delRole(this)"></i></li>');
	$c.after($s);
	$("#select_r_xselect").find('span').text('请选择');
	$("#select_r_xselect").data('value','-1');
	$("div[data-id=xSelect-role]").find('span[data-value='+name2+']').parent('li').remove();
	
	//重新获取
	reload_un(CREATE_FLAG);
}
function _delRole(obj){
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var $p = $("div[data-id=xSelect-role]").children('ul');
	var data, max;
	var min = 0;
	max = role_data_all.length - 1;
	data = role_data_all;
	var t = $(obj).siblings('input').val();
	//access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'"
	access_flag = $(obj).siblings('input').attr('access_flag');
	pwd_flag = $(obj).siblings('input').attr('pwd_flag');
	
	$c.remove();
	$("#select_r_xselect").show();
	role_arry.splice($.inArray(id,role_arry),1);

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" style="width:324px">'+t+'</span></li>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('li').eq(0).before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" style="width:324px">'+t+'</span></li>');
	} else {
		$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" >'+t+'</span></li>');
	}
	role_data_all.splice(index_1, 0, parseInt(id));
	//查看 当前角色是否有密码管理的权限
	//获取当前 角色id
	if($("div[data-id=xSelect-role]").find('span[data-value='+id+']').attr('pwd_flag') == '1'){
		//$('#mail_em').show();
	}else{
		var s = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('pwd_flag') == '1'){
				//$('#mail_em').show();
				s = true;
				return false;
			}			
		})
		if(!s){
			$('#mail_em').parent().next().find('i').attr('class','v-check');
			//$('#mail_em').hide();
		}
	}
	if($("div[data-id=xSelect-role]").find('span[data-value='+id+']').attr('access_flag') == '1'){
		$('#exp_auth').show();
	}
	else{
		//找到所有的 已选的角色 
		var a = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('access_flag') == '1'){
				$('#exp_auth').show();
				a = true;
				return false;
			}
		})
		if(!a){
			$('#exp_auth').hide();
		}
	}
	//重新获取
	reload_un(CREATE_FLAG);
}

var c_index_all_role = [];
var role_list_tmp =[];
//绑定角色集合
function bind_role_xSelect(){
	$("div[data-id=xSelect-role]").remove();
	_get_rn();
	$('#select_r_xselect').empty().data('xSelect','');
	var role_array = [];
	c_index_all_role = [];
	//当前用户的角色
	var pRoleSet = parent.user_item.RoleSet;
	var p_role_id = [];
	if(pRoleSet == undefined || pRoleSet.length == 0){
		p_role_id = []
	}else{
		$(pRoleSet).each(function(i,item){
			p_role_id.push(item.RoleId);
		})
	}
	$.each(role_data.data,function(i,item){
		if ($("#select_r_xselect").data('value') == item.RoleId){
			
		}else{
			if (role_list_tmp.indexOf(item.RoleId) > -1){
				return true;
			}
		}

		if($("#sys_user").attr("value")=='none'){
			var select_data_json = {};
		}else{		
			if(p_role_id.indexOf(item.RoleId) >=0){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'access_flag':0,
					'pwd_flag':0,
					'type':'check'
				};
			}else if(role_simple.indexOf(item.RoleId) < 0){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'access_flag':0,
					'pwd_flag':0,
					'type':'check'
				};
			}else if($("#sys_user").attr("value")=='none'){
				var select_data_json = {};
			}else if($("#sys_user").attr("value")=='view'){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'access_flag':0,
					'pwd_flag':0,
					'type':'check'
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'access_flag':0,
					'pwd_flag':0,
					'type':'edit'
				};
			}
		}
		
		select_data_json.value = item.RoleId;
		select_data_json.name = item.RoleName;
		select_data_json.access_flag = item.access_flag;
		select_data_json.pwd_flag = item.pwd_flag;
		if(item.RoleName == "超级管理员"){
			select_data_json.type = 'check';
		}
		role_array.push(select_data_json);
		c_index_all_role.push(item.RoleId);
	});
	if($("#sys_user").attr("value")!='none' && $("#sys_user").attr("value")!='view'){
		$('#select_r_xselect').xSelect({
		width: 202,
		defaultText: '请选择',
		items:role_array,
		module_type:'role',
		edit: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,0);
		},
		check: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,1);
		},
		btn:[
			{
				'name':'新增',
				'event': function(items,obj){
					_editNode4(obj,1,0);
				}
			}
		],
		setval:function(item,obj){
			role_select(obj);
		}
	});
	}else{
		$('#select_r_xselect').xSelect({
		width: 202,
		defaultText: '请选择',
		items:role_array,
		module_type:'role',
		edit: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,0);
		},
		check: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,1);
		},
		setval:function(item,obj){
			role_select(obj);
		}
	});
	}
	
	$('#select_r i.add').show();
}

//编辑页面全选
function _checkAllStatus(obj){
	var $c = $(obj).parents('div.cbi-cont');
	var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
	var len_v = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
	var len_1 = $('input[value=1]:checked:visible',$c).length;
	var len_2 = $('input[value=2]:checked:visible',$c).length;
	var $i = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
	var $i_1 = $c.prev('div.cbi-t').find('input[value=1]');
	var $i_2 = $c.prev('div.cbi-t').find('input[value=2]');
	if(len != clen){
		$i.prop('checked',false);
		$i.parent().removeClass('checked');
	}else{
		$i.prop('checked',true);
		$i.parent().addClass('checked');
	}
	if(len_v != len_1){
		$i_1.iCheck('uncheck');
	}else{
		$i_1.iCheck('check');
	}
	if(len_v != len_2){
		$i_2.iCheck('uncheck');
	}else{
		$i_2.iCheck('check');
	}	
}
var d_Role;
$(function(){
	initMenu();	
	$('#role_suspend .form-checkbox,#role_suspend .form-radio').iCheck({
		checkboxClass:'icheckbox_minimal-blue',
		radioClass:'iradio_minimal-blue',
		increaseArea:'0'
	});
	//运维概要 系统概要 checkbox 事件绑定
	$('#role_suspend div.cbi-tag input[type=checkbox]').on('ifChecked',function(){
		var $s = $(this).parents('div.cbi-tag').next().next('div.cbi-sel.radio');
		var $i = $(this).parents('div.cbi-cont').prev('div.cbi-t');
		$s.show();
		$i.children().eq(2).show();
		$i.children().eq(3).show();
		_checkAllStatus(this);
	}).on('ifUnchecked',function(){
		var $s = $(this).parents('div.cbi-tag').next().next('div.cbi-sel.radio');
		var $i = $(this).parents('div.cbi-cont').prev('div.cbi-t');
		var j = 1;
		$s.hide();
		$.each($(this).parents('div.cbi-cont').find('.cbi-tag').find('input[type=checkbox]'),function(i,item){
			if($(item).prop('checked') == true){
				j = 0;
				return false;
			}
		})
		if(j == 1){
			$i.children().eq(2).hide();
			$i.children().eq(3).hide();
		}
		var $c = $(this).parents('div.cbi-cont');
		var $s = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
		var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
		if(len != clen){
			$s.prop('checked',false);
			$s.parent().removeClass('checked');
		}else{
			$s.prop('checked',true);
			$s.parent().addClass('checked');
		}
		//_checkAllStatus(this);	
	});

	//授权
	$('#role_suspend div.cbi-sel.auth input[type=checkbox]').on('ifChecked',function(){
		var $c = $(this).parents('div.cbi-cont');
		var $i_a = $c.prev('div.cbi-t').find('input[type=checkbox]:last');
		var $s = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
		var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
		var len_a = $('input[type=checkbox]:checked',$c.children().children('.cbi-sel.auth')).length;
		if(len != len_a){
			$i_a.prop('checked',false);
			$i_a.parent().removeClass('checked');
		}else{
			$i_a.prop('checked',true);
			$i_a.parent().addClass('checked');
		}
		$('.cbi-s[value=role_] input[type=checkbox]').eq(0).iCheck('check');
		$('input[name=S_30][value=2]').iCheck('check');
	}).on('ifUnchecked',function(){
		var $c = $(this).parents('div.cbi-cont');
		var $i_a = $c.prev('div.cbi-t').find('input[type=checkbox]:last');
		var $s = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
		var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
		var len_a = $('input[type=checkbox]:checked',$c.children().children('.cbi-sel.auth')).length;
		if(len != len_a){
			$i_a.prop('checked',false);
			$i_a.parent().removeClass('checked');
		}else{
			$i_a.prop('checked',true);
			$i_a.parent().addClass('checked');
		}
		//_checkAllStatus(this);	
	});

	//访问 管理 radio 事件绑定
	$('#role_suspend div.cb-item input[type=radio]').on('ifChecked',function(){
		_checkAllStatus(this);
	}).on('ifUnchecked',function(){
		_checkAllStatus(this);
	});

	//实时监控 标题 事件绑定
	$('#role_suspend div.cbi-t .all input[type=checkbox]').on('ifChecked',function(){
		var $d = $(this).parents('div.cbi-t').next('div.cbi-cont').find('.cbi-tag');
		$('input[type=checkbox]',$d).iCheck('check');
	}).on('ifUnchecked',function(){
		var $d = $(this).parents('div.cbi-t').next('div.cbi-cont').find('.cbi-tag');
		$('input[type=checkbox]',$d).iCheck('uncheck');
	});

	//radio全选 事件绑定
	$('#role_suspend div.cbi-t input[value=1]').on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=1]').iCheck('check');
	});
	$('#role_suspend div.cbi-t input[value=2]').on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=2]').iCheck('check');
	});


	//系统用户 事件绑定 --> 授权
	$('div.cbi-tag input[type=checkbox]',$('.cbi-cont').children('.cbi-s')).on('ifChecked',function(){
		$obj1 = $(this);
		if($obj1.parents('label').text() == '系统用户'){
			if($('input[value=2]',$obj1.parents('.cbi-tag').siblings('.cbi-sel.radio')).prop('checked') == true){
				$('.cb-item .cbi-sel.auth').show();
				$('label.auth').show();
				$('.cbi-s[value=role_]').show();//显示 角色管理
				if($('div.cbi-s[value=user_] .cbi-sel.auth input[type=checkbox]').prop('checked') == false || $('.cbi-s[value=role_] input[type=checkbox]').prop('checked') == false)
				$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",true);
				// 角色授权 不可编辑
			}
		}
	}).on('ifUnchecked',function(){
		$obj1 = $(this);
		if($obj1.parents('label').text() == '系统用户'){
			$('.cb-item .cbi-sel.auth').hide();
			$('label.auth').hide();
			$('.cbi-s[value=role_]').hide();//隐藏  角色管理
			var $d = $('div.cbi-s[value=role_]').find('.cbi-tag');
			$('input[type=checkbox]',$d).iCheck('uncheck');//取消选中系统用户 --> 取消选中角色管理
		}
	});

	//系统用户radio 事件绑定 --> 授权
	$('input[value=2]',$('.cbi-cont').children('.cbi-s')).on('ifChecked',function(){
		$obj1 = $(this);
		if($obj1.parents('.cbi-sel.radio').siblings('.cbi-tag').find('label').text() == '系统用户'){
			if($('input[type=checkbox]',$obj1.parents('.cbi-sel.radio').siblings('.cbi-tag')).prop('checked') == true){
				$('.cb-item .cbi-sel.auth').show();
				$('label.auth').show();
			}
		}
	})
	$('input[value=1]',$('.cbi-cont').children('.cbi-s')).on('ifChecked',function(){
		$obj1 = $(this);
		if($obj1.parents('.cbi-sel.radio').siblings('.cbi-tag').find('label').text() == '系统用户'){
			if($('input[type=checkbox]',$obj1.parents('.cbi-sel.radio').siblings('.cbi-tag')).prop('checked') == true){
				$('.cb-item .cbi-sel.auth').hide();
				$('label.auth').hide();
			}
		}
	});

	//授权 全选 事件绑定
	$('div.cbi-t .auth input[type=checkbox]').on('ifChecked',function(){
		$('.cbi-s[value=role_] input[type=checkbox]').eq(0).iCheck('check');
		$('input[name=S_30][value=2]').iCheck('check');
		var $d = $(this).parents('div.cbi-t').next().children().find('.cbi-sel.auth');
		$('input[type=checkbox]',$d).iCheck('check');
	}).on('ifUnchecked',function(){
		var $d = $(this).parents('div.cbi-t').next().children().find('.cbi-sel.auth');
		$('input[type=checkbox]',$d).iCheck('uncheck');
	});
//用户授权 绑定 角色授权
	$('div.cbi-s[value=user_] .cbi-sel.auth input[type=checkbox]').on('ifChecked',function(){
		if($('.cbi-s[value=role_] input[type=checkbox]').prop('checked') == true){
			$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",false).iCheck('enable');//角色授权可编辑
		}
	}).on('ifUnchecked',function(){
		$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').iCheck('uncheck');//取消选中角色授权
		$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",true).iCheck('disable');//角色授权不可编辑
	});
	//角色管理 绑定 角色授权
	$('.cbi-s[value=role_] input[type=checkbox]').on('ifChecked',function(){
		if($('div.cbi-s[value=user_] .cbi-sel.auth input[type=checkbox]').prop('checked') == true){
			$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",false).iCheck('enable');//角色授权可编辑
		}
	}).on('ifUnchecked',function(){
		$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').iCheck('uncheck');
		if($('.cbi-s[value=role_] input[type=checkbox]').prop('checked') == false){
			$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",true).iCheck('disable');//角色授权不可编辑
		}
	});
	_checkStatus();
})

function _editNode4(obj,type,f_dis){
	title = "角色";
	var $dialogCont = $("#role_suspend").show();
	
	d_Role = dialog({
		title:title,
		content:$dialogCont,
		id:"role_suspend",
		width:"1200px"
	});
	if(f_dis){
		$('#role_suspend').find('a.btn-submit').parent().hide()
	}else{
		$('#role_suspend').find('a.btn-submit').parent().show()
	}
	//$('#mframe1').attr('src','/bhost/authtype_handle?tasktype='+type+'&authtypeId='+authtypeId+'&paging=1&search_typeall=&e=all-&se='+sess+'&i1=1')
	d_Role.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d_Role.showModal();
	//initformlist();
	$(".ui-dialog-title").css("width","140px");
	//client_main(type);
	if(type == 1){
		RoleId = 0;
		create();
	}else{		
		RoleId = $(obj).children('span').data('value');
		edit_role(RoleId);
	}
	
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		//reload(1);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
		savedata_role();	
	})
	
}

var select_str = "";
var check_num = 0;
var role_array=null;
var r_p = {
	"RoleId": 0,
	"RoleName": "",
	"Permission": [
	]
}

function initMenu(){
	$('.cbtab').children('tbody').empty();
	$.ajax({
		url:'/bhost/get_role_menu',
		type:"POST",
		async:false,
		data:{a0:sess},
		success: function(Result){
			var data = JSON.parse(Result);
			if (data.Result){
				var menuInfo = data.info;
				var index = 0;
				var html_str = "<tr>";
				var flag2 = false;
				$.each(menuInfo,function(i,item){
					var flag1 = false;
					if(index < 4){
						if(item.SystemMenuName != '运维访问'){
							html_str += ('<td style="white-space: normal;"><div class="cb-item">'+
							'<div class="cbi-t">'+
								'<label class="all"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" />'+item.SystemMenuName+'</label>'+
								'<label class="auth" style="float: right;display: none;margin-right: 28px;"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" /></label>'+
								'<label style="font-size: 14px;color: #999;float:right;margin-left: 35px;margin-right: 28px;display: none;"><input class="form-radio" type="radio" name="s_all_'+item.SystemMenuId+'" value="1" /></label>'+
								'<label style="font-size: 14px;color: #999;display: none;float:right;"><input class="form-radio" type="radio" name="s_all_'+item.SystemMenuId+'" value="2" /></label>'+
							'</div>');
						}else{
							html_str += ('<td style="white-space: normal;"><div class="cb-item">'+
							'<div class="cbi-t">'+
								'<label class="all"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" />'+item.SystemMenuName+'</label>'+
								'<label class="auth" style="float: right;display: none;margin-right: 28px;"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" /></label>'+
							'</div>');
						}

						var html_str_content = ('<div class="cbi-cont" id="S_'+item.SystemMenuId+'">');
						// //console.log("++++++++++++++++++++++++++++++++++++++++++++");
						// //console.log(typeof(html_str_content));
						var html_str_content_user = ('');
						var html_str_content_role = ('');
						var html_str_content_ur = ('');
						var html_str_content_o = ('');
						$.each(item.SubMenu,function(i1,item1){
							if(item1.SubMenuId == '2'){
								if(item1.PermissionFlag == false && item1.ManageFlag == 1){
									//只有访问
									$('#sys_user').show();
									$('#sys_user').attr("value","view");
								}else if(item1.PermissionFlag == true && item1.ManageFlag == 2){
									//授权、管理
									$('#sys_user').show();
								}else if(item1.PermissionFlag == false && item1.ManageFlag == 2){
									//只有管理
									$('#sys_user').show();
								}else{
									// 没有授权、管理、访问 隐藏角色管理
									$('#sys_user').show();
									$('#sys_user').attr("value","none");
								}
							}
							if(item1.PermissionFlag == true){
								if(item1.SubMenuName == '角色管理'){
									html_str_content_role = ('<div class="cbi-s" style="display:none;" value="role_">'+
										'<div class="cbi-tag">'+
											'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
										'</div>'+
										'<div class="cbi-sel auth">'+
											'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
										'</div>'+
										'<div class="cbi-sel radio">'+
											'<label style="margin-right: 7px;"><input class="form-radio" type="radio" checked="checked" name="S_'+item.SystemMenuId+i1+'" value="2">管理</label>'+
											'<label><input class="form-radio" type="radio" name="S_'+item.SystemMenuId+i1+'" value="1" />访问</label>'+
										'</div>'+
									'</div>'); 

								}else if(item1.SubMenuName == '系统用户'){
									html_str_content_user = ('<div class="cbi-s" value="user_">'+
										'<div class="cbi-tag">'+
											'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
										'</div>'+
										'<div class="cbi-sel auth">'+
											'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
										'</div>'+
										'<div class="cbi-sel radio">'+
											'<label style="margin-right: 7px;"><input class="form-radio" type="radio" checked="checked" name="S_'+item.SystemMenuId+i1+'" value="2">管理</label>'+
											'<label><input class="form-radio" type="radio" name="S_'+item.SystemMenuId+i1+'" value="1" />访问</label>'+
										'</div>'+
									'</div>'); 
									
								}else{
									if(item1.SubMenuName != '设备访问'){
										html_str_content_o += ('<div class="cbi-s">'+
											'<div class="cbi-tag">'+
												'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
											'</div>'+
											'<div class="cbi-sel auth">'+
												'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
											'</div>'+
											'<div class="cbi-sel radio">'+
												'<label style="margin-right: 7px;"><input class="form-radio" type="radio" checked="checked" name="S_'+item.SystemMenuId+i1+'" value="2">管理</label>'+
												'<label><input class="form-radio" type="radio" name="S_'+item.SystemMenuId+i1+'" value="1" />访问</label>'+
											'</div>'+
										'</div>');
									}else{
										html_str_content_o += ('<div class="cbi-s">'+
											'<div class="cbi-tag">'+
												'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
											'</div>'+
											'<div class="cbi-sel auth">'+
												'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
											'</div>'+
										'</div>');
									}
								}
			
							}
						})
						html_str_content_ur += html_str_content_user.concat(html_str_content_role);
						html_str_content += html_str_content_ur.concat(html_str_content_o);
						html_str_content += ("</div></td>");	
						html_str += html_str_content;
						if(index == 3 || index == menuInfo.length){
							html_str += ('<tr>');
							$('.cbtab').children('tbody').append(html_str);
							flag2 = true;
							index = 0;
							html_str = "<tr>";
						}
						index++;
					}
				})
			}
			else{
				_alert(1,"用户", "获取角色菜单信息失败");
			}
		}
	})
}

var editID;
//编辑
function edit_role(id){
	editID = id;
	// $('div.cbi-tag input[type=checkbox]').unbind();
	$('#role_suspend div.cbi-t input[value=1]').unbind();
	$('#role_suspend div.cbi-t input[value=2]').unbind();	
	filter = ""
	roleid = id;
	var paging = "1";
	var page_num = "1";
	var search_typeall= "";
	var roleid= id;
	r_p.RoleId = roleid; 
	$("#role_suspend .cbtab input:checked").each(function(i,item){
		$(this).iCheck('uncheck');
	})
	$('#role_suspend .auth').iCheck('uncheck');
	$('#role_suspend label.auth').iCheck('uncheck');
	$("#role_suspend .cbi-s").find("input[value='2']").iCheck('check');
	$("#r_n").next('i').attr('class','v-check');
	$('#role_suspend .auth').hide();
	$.ajax({
		url: "/bhost/get_role_list",
		type:"POST",
		async:false,
		data:{a0:sess,a1:page_num,a2:paging,a3:search_typeall,a4:roleid,a6:1},
		success:function(Result){
			result = JSON.parse(Result);
			if(result.Result == false){
				_alert(1,"角色编辑","获取信息失败，失败原因："+result.ErrMsg);
				return false;
			}else{
				data = result.info.data[0];
				$('#r_n').val(data.RoleName);
				$("#r_n").attr("disabled",true);
				permission = data.Permission;
				$.each(permission,function(i,item){
					if(item.Mode == 1){
						$("#" +item.SubMenuId).iCheck('check');
						$("#" +item.SubMenuId).parent().parent().parent().next().next().find("input[value='1']").iCheck('check');
					}else if(item.Mode == 2){
						$("#" +item.SubMenuId).iCheck('check');
						$("#" +item.SubMenuId).parent().parent().parent().next().next().find("input[value='2']").iCheck('check');
					}
					if(item.EnableAuth == 1){
						$("#" +item.SubMenuId).parent().parent().parent().next().find("input[type=checkbox]").iCheck('check');
					}				
				})
			}
		}
	})

	$('#role_suspend div.cbi-t input[value=1]').on('ifChecked',function(){
		////console.log("click value1");
		$(this).parents('div.cbi-t').next().children().find('input[value=1]').iCheck('check');
	});
	$('#role_suspend div.cbi-t input[value=2]').on('ifChecked',function(){
		////console.log("click value2");
		$(this).parents('div.cbi-t').next().children().find('input[value=2]').iCheck('check');
	});	
}
function _checkStatus(){
	$('div.cbi-tag input[type=checkbox]').each(function(){
		var c = $(this).prop('checked');
		var $s = $(this).parents('div.cbi-tag').next().next('div.cbi-sel.radio');
		if(c){
			$s.show();
		}else{
			$s.hide();
		}
	});
}
//编辑页面提交数据
function savedata_role(){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var r_n = $("#r_n").val();


	if(r_n == ""){
		_alert(2,"用户","请输入名称",$('#r_n'));
		return false;
	}
	if(!nameReg.test(r_n)){
		_alert(1,"用户","名称格式不正确",$('#r_n'));
		return false;
	}
	var $u = $("#S_3").find(".cbi-s").eq(1).find('.cbi-sel.radio');
	if($u.find('input[value=2]').prop('checked') == true && $u.find('input[value=2]').is(":visible") == true){
		if($('.cbtab').find('.cbi-sel.auth').find('input[type=checkbox]:checked').length == 0){
			_alert(1,"用户","至少要选择一种授权");
			return false;
		}
	}
	if($('.cbtab').find('.cbi-sel.auth').find('input[type=checkbox]:checked').length > 0){
		if($u.find('input[value=2]').prop('checked') != true || $u.find('input[value=2]').is(":visible") != true){
			_alert(1,"用户","请选中角色管理管理权限");
			return false;
		}
	}
	//得到选中的数据
	var Permission = [];

	$(">div","#S_1").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}
			Permission.push(tmp);
		}
	})
	$(">div","#S_2").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_3").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_4").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_5").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})	
	$(">div","#S_6").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_7").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			tmp.SubMenuId = f1[0].id;
			tmp.Mode = 2;
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	if(Permission.length == 0){
		_alert(2,"用户","请选择权限");
		return false;
	}
	r_p.RoleName = r_n;
	r_p.Permission = Permission
	var roleid = r_p.RoleId;
	var msstr = aceg(JSON.stringify(r_p),sess);
	$.ajax({
		url:'/bhost/add_sys_role',
		type:"POST",
		async:false,
		data:{a0:sess,a1:JSON.stringify(r_p),a10:"运维管理>系统用户>用户",m1:msstr},
		success: function(Result){
			data = eval("("+Result+")");
			if (data.Result){
				_alert(0,"用户",'操作成功');
				var role_text = $('#select_r_xselect').find('span').text();
				get_role_simple();
				$("div[data-id=xSelect-role]").remove();
				$('#select_r_xselect').empty().data('xSelect','');
				bind_role_xSelect();
				if ($("#select_r_xselect").data('value') == "-1" || $("#select_r_xselect").data('value') == undefined){
					$("#select_r_xselect").data('value',data.RoleId);
					$("#select_r_xselect").find('span').text(r_n);
					role_arry.splice(0,1,data.RoleId);
				}else{
					$('#select_r_xselect').find('span').text(role_text);
				}
				d_Role.close().remove();
			}
			else{
				_alert(1,"用户",'保存失败，失败原因：' + data.ErrMsg);
			}
		}
	})
 }
//创建
function create(){
	editID = 0;
	$(".container").show();
	$(".container1").hide();
	// $('div.cbi-tag input[type=checkbox]').unbind();
	$('#role_suspend div.cbi-t input[value=1]').unbind();
	$('#role_suspend div.cbi-t input[value=2]').unbind();	
	$("#r_n").attr("disabled",false);
	$("#r_n").val("");
	$("#r_n").next('i').attr('class','v-check');
	$("#role_suspend .cbtab input:checked").each(function(i,item){
		$(this).iCheck('uncheck');
	})
	$('#role_suspend .auth').iCheck('uncheck');
	$('#role_suspend label.auth').iCheck('uncheck');
	$("#role_suspend .cbi-s").find("input[value='2']").iCheck('check');
	r_p.RoleId = 0;

	$('#role_suspend div.cbi-t input[value=1]').on('ifChecked',function(){
		////console.log("click value1");
		$(this).parents('div.cbi-t').next().children().find('input[value=1]').iCheck('check');
	});
	$('#role_suspend div.cbi-t input[value=2]').on('ifChecked',function(){
		////console.log("click value2");
		$(this).parents('div.cbi-t').next().children().find('input[value=2]').iCheck('check');
	});
	$('#role_suspend .auth').hide();
}

function user_manage(){
	document.frm_role.tasktype.value= 1;
	document.frm_role.action = '/bhost/user_p';
	document.frm_role.submit();
}


function reload_rn(){ //重新加载角色
	var admin_list = [];
	var role_list = [];
	var role_list_se = [];
	admin_id = $('#select_u select').val();
	if(admin_id != -1){
		admin_list.push(admin_id);
	}
	role_id = $("#select_r_xselect").data('value');
	t = $('#select_r_xselect').find('span').text();
	var tmp_roleid = -1;
	if(role_id != -1){
		role_list.push(parseInt(role_id));
		tmp_roleid = role_id
	}			
	$('#select_u li.item').each(function(i,item){
		admin_list.push($(this).attr('id'));//admin_list已选择的管理员
	})
	$('#select_r li.item').each(function(i,item){
		role_list.push($(this).attr('id'));//role_list已选择的角色
		role_list_se.push(parseInt($(this).attr('id')));
	})
	userid_str = admin_list.join(',');

	bind_role_xSelect();
	
	if(c_index_all_role.indexOf(role_id) >=0){
		$("#select_r_xselect").data('value',role_id);
		$('#select_r_xselect').find('span').text(t);
	}else{
		$("#select_r_xselect").data('value',-1);
	}
	if($.inArray(parseInt(tmp_roleid),role_data_all) >=0) {
		global_flag = true;
		//$("#rn").val(tmp_roleid).trigger('change');
	}
	if(role_list_se.length != 0){
		$.each(role_data.data,function(i,item){
			var flag_repeat = 0;
			ind = role_list_se.indexOf(item.RoleId);
			if(ind >=0){
				flag_repeat = 1;
				role_arry.splice($.inArray(parseInt(item.RoleId),role_arry),1);
				
				role_data_all.splice($.inArray(parseInt(item.RoleId), 0, parseInt(item)));
				//$('#rn').find('option[value='+item.RoleId+']').remove();
				user_tmp=[];
				$("#select_r li.item").each(function(i1,item1){
					v_tmp=$(item1).attr("id");
					////console.log("v_tmp =" +v_tmp);
					role_tmp.push(v_tmp);
					if(parseInt(v_tmp) == parseInt(role_list_se[ind]) ){
						//$('#rn').find('option[value='+item.RoleId+']').remove();
						$("div[data-id=xSelect-role]").find('span[data-value='+item.RoleId+']').parent('li').remove();
						
					}					
				});
				role_list_se.splice($.inArray(parseInt(item.RoleId),role_list_se),1);
			}else{
				$('#role_div div.set-view li[id='+item.RoleId+']').children('i.del').click();
			}
		})
	}
	
	$(role_list_se).each(function(i,item){
		$('#role_div div.set-view li[id='+item+']').remove();
	})
	
}
var role_simple = [];
function get_role_simple(){
	role_simple = [];
	$.ajax({
		url:'/bhost/get_role_list1',
		type:'post',
		async:false,
		data:{a0:sess,a1:'',a2:1,a3:'',a4:''},
		success:function(result){
			var user_result = JSON.parse(result);
			if (user_result.Result){
				role_simple_list=user_result.info.data;
				if(role_simple == null) role_simple =[];
				$(role_simple_list).each(function(i,item){
					role_simple.push(item.RoleId);
				})
			}
		}
	})
}
</script>
{% endblock %}
</body>
