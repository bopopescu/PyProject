{% extends  "index.html" %}
{% block head %}
	<link rel="stylesheet" href="/manage/css/G-style.css">
	<link rel="stylesheet" href="/manage/css/new-head.css">
	<link rel="stylesheet" href="/manage/css/jedate.css">
	<script src="/manage/js/jquery.jedate.min.js"></script>
	<script src="/manage/js/xSelect.js"></script>
	<script src="/manage/js/my_scrollbar.js"></script>
	{% endblock  %}
{% block main %}
<body style="overflow:hidden; overflow-y: scroll" class="bg-white">
	<div class="rwrap">
		<div class="mainer">
			<!-- 创建用户1 -->	
			<div class="container" style="display:none;">

				<div class="manual-head">
					<div class="manual-title">
						<span onclick="reload(this);" id="user_title">用户管理</span>
						<i class="userm_icon"></i>
					</div>
				</div>

				<div class="c-cont">
					<div class="c-wrap" id="user_page" style="padding: 10px 0 0;overflow:auto;">
						<div class="c-exp" style="margin: -1px auto;">
						
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp;基本信息</strong>
									<div class="G-box2">启用：
										<input type="checkbox" class="form-checkbox" name="" id="status" value="" checked="checked" >
									</div>
								</div>
								
								<div class="h-content2" style="min-height:210px;height:auto;width: 100%;overflow: hidden;padding: 14px 0 0;">

									<div class="form-item for-avatar" style="width: 180px;">
										<div id="tAvatar" onclick="_getAvatarList(this)"><img src="/manage/images/avatar1.jpg"></div>
									</div>
									
									<div class="col3">
										<div class="form-item">
											<span class="form-tag" style=""><em class="imp">*</em>账&nbsp;&nbsp;号：</span>
											<div class="form-c" style="">
												<input type="text" class="form-text" id="sys_u_name" maxlength="31" style="" onblur="regCheck(this,/^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/);change_name();" tabindex="1"><i class="v-check"></i>
												<p class="form-tip">仅支持英文、数字、下划线、横杠、小数点</p>
											</div>
										</div>

										<div class="form-item">
											<span class="form-tag"><em class="imp">*</em>姓&nbsp;&nbsp;名：</span>
											<div class="form-c">
												<input type="text" class="form-text" id = "user_name" maxlength="127" onblur="regCheck(this,/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/)" tabindex="2"><i class="v-check"></i>
												<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
											</div>
										</div>

										<div class="form-item">
											<span class="form-tag">描&nbsp;&nbsp;述：</span>
											<div class="form-c">
												<input type="text" class="form-text" id = "sys_u_descr" maxlength="2047" tabindex="3"><i class="v-check"></i>
											</div>
										</div>
										<div class="form-item" style="width: 33.3%; height: 35px;">
											<span class="form-tag">认证方式：</span>
											<!--<div class="form-c" style="width: 20%; position: absolute;margin-left: 80px">
												<select class="form-select" name="" id="sys_u_authtype" style="width:202px" tabindex="4">
													<option value="null" >默认</option>
												</select>
											</div>-->
											<div class="g-cont">
												<div class="sel-type1" id="authtype_list_select" style="width:330px">
													<div class="xSelect xSelect_aythtypeList" id="sys_u_authtype"></div>
												</div>
											</div>
											<div class="tab-t" style=" width: 8%; position: absolute; margin-left: 290px; margin-top: -28px;" id="changepin_local">
												<div class="item" style="float: left;width: 100%" >
													<select class="filter-select" name="select_local" id="select_local" style="width:75px;" tabindex="-1" aria-hidden="false">
														<option value="1">设置密码</option>
														<option value="0">初始密码</option>												
													</select>
												</div>
											</div>
											<!-- <div class="tab-t" style=" width: 8%; position: absolute; margin-left: 290px; margin-top: 1px; display: none;" id="changepin_div1">
												<div class="item" style="float: left;width: 100%" >
													<select class="filter-select" name="select_pin" id="select_pin" style="width:98px;" tabindex="-1" aria-hidden="false">
														<option value="0">初始密码</option>
														<option value="1">设置PIN码</option>
													</select>
												</div>
											</div> -->
											
											<!-- <div class="tab-t s-hide" style=" width: 8%; position: absolute; margin-left: 290px; margin-top: 1px; display: none;" id="changepin_div">
												<div class="ctr">
													<a href="javascript:;" id="changePIN" class="btn btn-default btn-normal" onclick="change_PIN()">修改pin码</a>
												</div>
											</div> -->
											
											<!-- <div class="form-item" id="tokenid_div" style="width:20%; display: none; margin-left: 226px; margin-top: -12px;">
												<div class="h-content3" id="TokenID" style="padding: 0; margin-left: -16px">
												</div>
											</div> -->
											<!-- <label class="tab-t" style="width: 8%; position: absolute; margin-left: 290px; margin-top: 32px; display: none;" id="totp_reset_div">
												<div class="ctr">
													<a href="javascript:;" class="btn btn-default btn-normal" style="padding: 0 10px;" onclick="qr_code_show();">重置TOTP</a>
												</div>
											</label> -->
											
										</div>
										<div class="form-item">
											<span class="form-tag"><em class="imp">*</em><span id="span_pwd">密&nbsp;&nbsp;码</span>：</span>
											<div class="form-c" style="width: 33.3%; position: absolute;">
												<input type="password" class="form-text" id = "sys_u_pwd_new" onkeydown="changepwdsta();" maxlength="64" tabindex="5" style="margin-left: 80px;"><i class="v-check"></i>
											</div>
											<div class="tab-t" style=" width: 9%; position: absolute; margin-left: 290px; margin-top: 1px">
												<div class="ctr">
													<a href="javascript:;" id="btn_pwd" class="btn btn-default btn-normal" onclick="create_pwd()">随机密码</a>
												</div>
											</div>
										</div>
										<div class="form-item" style="margin-left: -5px;">
											<span class="form-tag" style="width: 85px;"><em class="imp">*</em><span id="span_pwd1">确认密码</span>：</span>
											<div class="form-c">
												<input type="password" class="form-text" id = "sys_u_pwd_tr" maxlength="64" onkeydown="changepwdsta();" tabindex="6"><i class="v-check"></i>
											</div>
										</div>
											

										<div class="form-item" style="width: 33.3%;">
											<span class="form-tag">工&nbsp;&nbsp;号：</span>
											<div class="form-c">
												<input type="text" class="form-text" id = "UserNumber" maxlength="127" onblur="regCheck(this,/^[a-zA-Z\d_]+$/)" tabindex=""><i class="v-check"></i>
												<p class="form-tip">仅支持英文、数字、下划线</p>
											</div>
										</div>
										
										<div class="form-item" style="width: 33.3%;">
											<span class="form-tag">部&nbsp;&nbsp;门：</span>
											<div class="form-c">
												<input type="text" class="form-text" id = "sys_u_depart" maxlength="127" tabindex="7"><i class="v-check"></i>
											</div>
										</div>

										<div class="form-item">
											<span class="form-tag"><em class="imp" style="display:none;" id="phone_em">*</em>手&nbsp;&nbsp;机：</span>
											<div class="form-c">
												<input type="text" class="form-text" id = "sys_u_phone" onblur="regCheck(this,/^[0-9]{11}$/)" maxlength="11" tabindex="8"><i class="v-check"></i>
											</div>
										</div>

										<div class="form-item" >
											<span class="form-tag"><em class="imp" style="display:none;" id="mail_em">*</em>邮&nbsp;&nbsp;箱：</span>
											<div class="form-c">
												<input type="text" class="form-text" id = "sys_u_email" onblur="regCheck(this,/^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/)" maxlength="127" tabindex="9"><i class="v-check"></i>
											</div>
										</div>
										<div class="form-item" id="CertCn_div" style="display:none;">
											<span class="form-tag" style="width: 110px; margin-left: -30px;"><em class="imp">*</em>认证唯一标识：</span>
											<div class="form-c">
												<input type="text" class="form-text" id = "CertCn" maxlength="127" tabindex="10"></i>
											</div>
										</div>
										<div class="form-item" style="width:100%" id="action_div">
											<span class="form-tag">操&nbsp;&nbsp;作：</span>
											<div class="form-c">
												<div class="form-label-group" id="">
													<label class="form-label"><input class="form-radio" type="radio" name="user_action" id="user_action1" value="true" checked>角色定义</label>
													<label class="form-label"><input class="form-radio" type="radio" name="user_action" id="user_action2" value="false">角色继承</label>													
												</div>
											</div>
										</div>
										
										<div class="form-item" style="width:100%" id="role_div">
											<span class="form-tag" style=""><em class="imp">*</em>角&nbsp;&nbsp;色：</span>
											<div class="form-c">
												<div class="sel-type2" style="margin-top: -18px;">
													<div class="set-view" id="select_r" style="width: 80%;">
														<div class="sitem" style=" width: 33%;float: left; margin-left: -10px;" >
															<i class="ctrl add" style="margin-left: -132px;display:none;" onclick="_addRole(this)"></i>
															<!-- #####################客户端集合下拉框及添加界面-->
															<div class="g-cont" style="height:28px;">
																<div class="sel-type1" style="" id="select_role_div" style="margin-top: -10px;width:360px">
																	<div class="xSelect xSelect_RoleList" id="select_r_xselect"></div>
																</div>
															</div>
															
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="form-item" style="width: 100%;margin-bottom: 15px;" id="admin_div">
											<span class="form-tag" style=""><em class="imp">*</em>管理员：</span>
											<div class="h-content3" id="select_u" style="margin-top: -19px; width:80%;padding: 10px;">
											</div>
										</div>
										<div class="form-item" style="width: 100%;margin-bottom: 15px;" id="auth_div" style="display: none;">
											<span class="form-tag" style="">认证配置：</span>
											<div class="h-content3" id="auth_divs" style="margin-top: -19px;width:80%;padding: 10px 0;">
												<div class="item" style="float: left;width: 16.5%">
													<!-- <select class="filter-select" name="select_pin" id="select_pin" style="width:98px;" tabindex="-1" aria-hidden="false">
														<option value="0">初始密码</option>
														<option value="1">设置PIN码</option>
													</select> -->
													<div class="form-item" id="tokenid_div" style="width:100%; margin-top: -13px;">
														<div class="h-content3" id="TokenID" style="padding: 0;">
														</div>
													</div>
												</div>
												<div class="item" style="float: left;width: 16.5%">
													<label class="tab-t" style="" id="totp_reset_div">
														<div class="ctr">
															<a href="javascript:;" class="btn btn-default btn-normal" style="padding: 0 10px;" onclick="qr_code_show();">重置TOTP</a>
														</div>
													</label>
												</div>
												<div class="item" style="float: left;width: 16.5%">
													<div class="tab-t s-hide" style="" id="changepin_div">
														<div class="ctr">
															<a href="javascript:;" id="changePIN" class="btn btn-default btn-normal" onclick="change_PIN()">设置pin码</a>
															<text style="line-height: 27px; margin-left: -5px;">未设置</text>
														</div>
													</div>
												</div>
												<div class="item" style="float: left;width: 16.5%">
													<label class="tab-t" style="" id="FinP_reset_div">
														<div class="ctr">
															<a href="javascript:;" class="btn btn-default btn-normal" style="" onclick="setFinP();">录入指纹</a>
															<text style="line-height: 27px; margin-left: -5px;">未录入</text>
														</div>
													</label>
												</div>	
											</div>											
										</div>
								</div>
							</div>
						</div>
						</div>
						<div class="c-exp" style="margin: -1px auto;" id="append_div">
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp扩展选项</strong>	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 14px 0 0 0px;">
									
									<div class="form-item" style="margin-left: 85px;width: 320px;">
										<span class="form-tag" style="width: 112px;margin-left: -32px;" >第三方认证账号：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "thirduser" maxlength="19" >
										</div>
									</div>

									<div class="form-item" style="display:none">
										<span class="form-tag">改密审批者：</span>
										<div class="form-c">
											<select class="form-select" name="" id="pu_id" style="width:190px">
											</select>
										</div>
									</div>
									<div class="form-item" style="width: 150px;">
										<span class="form-tag" style="width: 113px;" >唯一登录：</span>
										<div class="form-c" style="" >
											<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="" id="uniqueIP" checked="false"></label>
										</div>
									</div>
									
									<div class="form-item" style="width: 105px;height: 37px;display:none;" id="totp_div" >
										<span class="form-tag" style="width: 112px;margin-left: -32px;" >TOTP：</span>
										<div class="form-c" style="" >
											<label class="form-label" style="margin-top:5px;vertical-align: initial;width:0px;"><input class="form-checkbox" type ="checkbox" name="" id="totp_checkbox" checked="true"></label>
											<label class="tab-t" style="position: absolute;width: 60px;display:none;">
											<div class="ctr">
												<a href="javascript:;" class="btn btn-default btn-normal" style="padding: 0 10px;" onclick="clear_totp();">重置</a>
											</div>
											</label>
										</div>
									</div>
									<div class="dialog-cont s-hide" id="qr_code" style="display:none;max-height:500px">
										<span style="margin-left: 68px;">请使用您的 TOTP 应用扫描二维码</span>
										<div style="text-align:center;">
											<img src="">
										</div>
										<div style="text-align: center;height: 34px;">
											<span>请在下方输入应用中的验证码进行测试。
											</span>
										</div>
										<div style="float:left;margin-left: 57px">
											<input type="text" class="form-text" id="totp_v" style="width:133px;" placeholder="输入验证码" onkeydown="if (event.keyCode == 13){submit_totp();return false;} else return;">
										</div>
										<div class="tab-t">
											<div class="ctr">
												<a class="btn" href="javascript:;" style="margin-left:16px;" onclick="submit_totp();">验证</a>
											</div>
										</div>
										<!--
										<div class="ctr">
											<a class="btn" href="javascript:;" style="float:left;margin-left:13px;;padding: 0 15px;line-height: 24px;color: #8D808A;border: 1px solid #8D808A;border-radius: 5px;transition: all 0.4s;" onclick="submit_totp();">验证</a>
										</div>
										-->
									</div>
									<div class="form-item" style="width: 395px;">
										<span class="form-tag" style="width: 113px;" >失效时间：</span>
										<div class="form-c" style="" >
											<label class="form-label" style="margin-top:5px;vertical-align: initial;"><input class="form-checkbox" type ="checkbox" name="" id="timeSet"></label>
											<div class="bc srItem" style="display: none; float: right; width: 61%;">
												<div class="srSort" id="srTemp-xtime">
													<span class="stwrap">
														<input type="text" id="datepicker" value="" placeholder="日期" class="datepicker" readonly>
														<input type="text" id="shour" style="height: 27px; margin-left: -5px; width: 25px; border-left: 1px solid #AAA; border-radius: 0; text-align: right; margin-top: 1px;" value="" placeholder="时" class="timeinput" min="00" max="23">
														<span class="srTip" style="float: left;">:</span>
														<input type="text" id="smin" style="height: 27px; margin-top: 1px;" value="" placeholder="分" class="timeinput" min="00" max="59">
														<span class="srTip" style="float: left;">:</span>
														<input type="text" id="ssec" style="height: 27px; margin-top: 1px;" value="" placeholder="秒" class="timeinput" min="00" max="59">
													</span>
												</div>
											</div>
										</div>
									</div>
									
									<div class="form-item" style="margin-left: 52px; width: 93%;">
										<span class="form-tag" style="width: 113px;">客户端登录限制：</span>
										<div class="form-c">
											<div class="sel-type2" style="padding-left: 113px;">
												<div class="set-view set-view1" id="Temp4" style="margin-top: -18px;">
													<div class="sitem" style=" width: 510px;float: left; margin-left: -10px;height:40px" _auth_data="">
														<i class="ctrl add" id="add2" onclick="_addSet4(this)" style="margin-left: 128px;height: 28px; display: none;"></i>
														<select name="" id="IPorMAC" class="select2 " style="width: 120px" onchange="change_limit(this)">
															<option value="1">IP地址</option>
															<option value="2">IP区间</option>
															<option value="3">MAC地址</option>
															<option value="4">MAC地址区间</option>
															<option value="5">客户端集合</option>
														</select>	
														<!-- ################################客户端集合下拉框及添加界面-->
														<div class="g-cont">
															<div class="sel-type1" style="display: none;" id="client_list" style="margin-top: -10px;width:360px">
																<div class="xSelect xSelect_clientList" id="accset"></div>
															</div>
														</div>
														<!-- ######################################## -->
														
														<div class="set-view set-view4" style="display:none; margin-top: -10px;width:360px">
															<input style="margin-left:-10px;width: 302px;" type="text" class="form-text" id="ip_input">
														</div>
														
														<div class="set-view set-view2" id="Temp2" style="display:none; margin-top: -10px;width:360px">
															<input style="margin-left:-10px;width:139px;" type="text" class="form-text" id="start_ip"><span class="fix">-</span>
															<input style="width: 139px;" type="text" class="form-text" id="end_ip">
														</div>
														<div class="set-view set-view3" id="Temp3" style="display:none;margin-top: -10px;width:360px">
															<input style="margin-left:-10px;width: 316px;" type="text" class="form-text" id="mac_input">
														</div>

														<div class="set-view set-view5" style="display:none;margin-top: -10px;width:360px">
															<input style="margin-left:-10px;width:135px;padding: 0px 10px;" type="text" class="form-text" id="start_mac"><span class="fix" style="margin-left: 7px;margin-right: 3px;">-</span>
															<input style="width: 135px;padding: 0px 10px;" type="text" class="form-text" id="end_mac">
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<!-- 添加 -->
									<div class="dialog-cont" id="client_suspend" style="display:none;max-height:500px">
										<div class="container" style="padding: 0px 20px 20px 20px;">
											<div class="c-cont2" style="overflow-x: hidden;">
												<div class="c-form c-form2" style="padding: 0;">
													<div class="h-top" style="width:958px;border-top: 1px solid rgb(204, 204, 204);border-right:1px solid rgb(204, 204, 204);border-left: 1px solid rgb(204, 204, 204);border-bottom: 0px;">
														<div class="form-item" style="padding: 0 0 0 19px;float:left;width:auto;margin:3px;">
															<span class="form-tag" style="float:left;width:auto;"><em class="imp">*</em>名称：</span>
															<div class="form-c" style="float:left;padding-left:0px;">
																<input type="text" class="form-text" id="c_n" name="c_n" style="width:160px;" maxlength="128" onblur="regCheck(this,nameReg);">
																<i class="v-check" style=" margin: 7px 0 0 -26px;"></i>
																<span>特殊字符仅支持下划线、横杠、小数点</span>
															</div>
														</div>
													</div>
													<div class="form form1" style="width:469px; border: 1px solid #ccc; max-height: 300px;overflow: auto;min-height:300px">
														<div class="c-form c-form-host" style="width: 420px;min-width: 420px;padding-top:0px;">
															<div class="form" style="width: auto;">
																<div class="form-item form-item-100 " style="width: 460px;font-size:16px;padding-left: 8px;padding-right: 0px;margin-left: -25px;">
																	<span class="form-tag" style="width: 63px;float: left;">IP地址：</span>
																	<div id="ip_n_c1" name="ip_n_c1" class="form-c" style="padding-left: 0px;width:380px;float: left;" value="0">
																		<span class="ss ss-add" id="ip_span1" value="0" style="float:left;position:static;width:180px;">
																			<input type="text" class="form-text" style="width:123px;padding-right: 8px;">
																			<i class="ctr ctr-add" onclick="_addIp_c1(this);" style="margin-left: 5px;"></i>
																		</span>
																	</div>
																	<span class="form-tag" style="width: 63px;padding-top: 10px;float: left;">IP区间：</span>
																	<div id="ip_n_c" name="ip_n_c" class="form-c" style="padding-left: 0px;width: 380px;float: left;padding-top: 10px;" value="0">
																		<span class="ss ss-add" id="ip_span" value="0" style="float:left;position:static;padding: 0 0 10px 0;width: 340px;">
																			<input type="text" class="form-text"placeholder="起始IP地址" style="width:123px;padding-right: 8px;">
																			<span style="vertical-align:middle;">-</span>
																		<input type="text" class="form-text" placeholder="结束IP地址" style="width:123px;padding-right: 8px;margin-left: -1px;">
																		<i class="ctr ctr-add" onclick="_addIp_c(this);" style="margin-left: 5px;"></i>
																		</span>
																	</div>
																</div>
															</div>
														</div>
													</div>
													<div class="form form3" style="width:488px;border: 1px solid #ccc;max-height: 300px;overflow-x: hidden;border-left: 0px;">
														<div class="c-form c-form-host" style="width:450px;min-width:450px;padding-top:0px;">
															<div class="form">
																<div class="form-item form-item-100 " style="width: 472px;font-size:16px;margin-left: -12px;">
																	<span class="form-tag" style="width: 83px;float: left;">MAC地址：</span>
																	<div id="MACAddress" name="MACAddress" class="form-c" style="padding-left: 0px;width: 380px;float:left;;" value="0">
																		<span class="ss ss-add" value="0" style="float:left;position:static;width: 190px;">
																			<input type="text" class="form-text" maxlength="17" style="width:138px;padding-right: 8px;">
																			<i class="ctr ctr-add" onclick="_addMAC(this)" style=" margin-left: 5px;"></i>
																		</span>
																	</div>
																	<span class="form-tag" style=" width: 85px;float: left;padding-top: 10px;">MAC区间：</span>
																	<div id="MACAddress1" name="MACAddress1" class="form-c" style="padding-left: 0px;width: 380px;float:left;padding-top: 10px;" value="0">
																		<span class="ss ss-add" value="0" style="float:left;position:static;padding: 0 0 10px 0;width: 350px;">
																			<input type="text" class="form-text" maxlength="17" placeholder="起始MAC地址" style="width:138px;padding-right: 8px;">
																			<span style="vertical-align:middle;">-</span>
																		<input type="text" class="form-text" maxlength="17" placeholder="结束MAC地址" style="width:138px;padding-right: 8px;">
																		<i class="ctr ctr-add" onclick="_addMAC1(this)" style=" margin-left: 5px;"></i>
																		</span>
																	</div>
																</div>
															</div>
														</div>
													</div>

													<div class="clearfix"></div>
												</div>
											</div>
										</div>
										<div class="btns">
											<a href="javascript:;" class="btn btn-normal btn-submit s-hide">保&nbsp;&nbsp;存</a>
											<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
										</div>
									</div>	
								</div>
							</div>
						</div>
						
						<div class="c-exp" style="margin: -1px auto;display:none;" id="exp_auth" >
							<div class="h-explorer">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp访问授权</strong>	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
									<div class="form-item" style="width: 100%; margin-left: -15px;">
										<span class="form-tag" style="width: 180px">访问授权：</span>
										<div class="h-content3" id="select_a" style="margin-top: -19px; width:80%">
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="c-exp" style="margin: -1px auto; margin-bottom: 10px;" id="ug_div">
							<div class="h-explorer" style="min-height: 300px">
								<div class="G-top">
									<div class="G-box1"></div><strong>&nbsp用户组</strong>	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;">
									<div class="h-top" style="background-color: #fff;float: right;/*width: 40%;*/border-bottom:none;">
											<div class="filter" style="float:right;min-width:auto;">
												<div id="waitTip" class="waitTip1" style="float: right;margin-top: 7px; margin-left: -26px;"></div>
												<div class="search">
													<select name="user_select1" id="user_select1" class="filter-select">
														<option value="0" selected>所有</option>
														<option value="Name">组名</option>
													</select>

													<input type="text" class="filter-text" 
													placeholder="输入关键字" name="user_text" id="user_text" 
													maxlength="128" style="padding-right: 22px;" 
													onchange="if($('#user_text').val()==''){$('#user_text_check').hide();}else{$('#user_text_check').show();}"
													onkeyup="if($('#user_text').val()==''){$('#user_text_check').hide();}else{$('#user_text_check').show();}"
													onblur="if($('#user_text').val()=='' && search_user_n!=''){search_user_n='';_addFilter_user(this,false,1);}"
													onkeydown="if($('#user_text').val()==''){$('#user_text_check').hide();}else{$('#user_text_check').show();}; if (event.keyCode == 13){_addFilter_user(this,false);$(this).blur();return false;} else return; ">
													<i class="v-check v-wrong" id="user_text_check"
													onclick="_clearFilter(this,1)"
													style="display:none;cursor: pointer;float: left;position: static;"></i>
													<button class="filter-btn" onclick="_addFilter_user(this,false)"><i class="add-filter"></i></button>
													<button class="filter-btn" onclick="_addFilter_user(this,true)"><i class="append-filter"></i></button>
												</div>
		
												<div class="search" id="clearFilter" style="margin: 0px 15px 0px -16px;display:none;">
													<button class="filter-btn" onclick="_clearFilter(this)"><i class="clear-filter"></i></button>
												</div>
												<div class="selector selector-multiple" id="filterWW1" style="display: none;">
													<span class="ww" style="">搜索条件</span>
													<ul style="padding-left: 0px;"></ul>
												</div>
											</div>
										</div>
										<div style="width:59%;height:90%;margin-top: 7px; margin-left: -23px;" id="usertree_div">
											<h2 style="width:180px;text-align: right;color: #333">用户组：</h2>
												<ul id="userTree"  class="hosttree" style="padding-left: 196px;"></ul>
										</div>
									</div>
								</div>
							</div>
						
						<div class="c-exp" style="margin: -1px auto;display:none;" id="transfer_div" >
							<div class="h-explorer">
								<div class="G-top" style=" margin: 10px 0 10px 0;">
									<div class="G-box1"></div><strong>&nbsp;继承对象</strong>	
								</div>
								<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;" >
									<div class="form-item" style="width:100%;">
										<span class="form-tag" style="margin-left:85px;"><em class="imp">*</em>用&nbsp;&nbsp;户：</span>
										<div class="form-c">
											<select class="form-select" name="" id="user_tranfer" style="width:200px" tabindex="7">
											</select>
										</div>
									</div>
								</div>
							</div>
						</div>	
						<div class="clearfix"></div>
						<div class="btns s-hide">							
							<a href="javascript:;" class="btn btn-normal btn-submit" id="saveUser" onclick="">保&nbsp;&nbsp;存</a>
							<!-- <a href="javascript:;" class="btn btn-normal" onclick="BackUsermanage();" >取&nbsp;&nbsp;消</a> -->
						</div>
						<div id="bBtn" style="position: fixed;z-index:5;">
							<a href="javascript:;" class="btn" style="float: right;" onclick="BackUsermanage();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
						</div>
					
				</div>
			</div>
			</div>
			<!-- 创建用户组 -->
			<div class="container2" style="display: none">

				<div class="manual-head">
					<div class="manual-title">
						<span onclick="reload(this);" id="group_title">用户管理</span>
						<i class="userm_icon"></i>
					</div>
				</div>

				<div class="c-cont">
					<div class="c-form c-form2">
						<div class="form form1" style="height: 500px;">
							<div class="form-item">
								<span class="form-tag"><em class="imp">*</em>名&nbsp;&nbsp;称：</span>
								<div class="form-c">
									<input type="text" class="form-text" id = "ug_n" maxlength="127" onblur="nameCheck(this)"><i class="v-check"></i>
									<p class="form-tip">特殊字符仅支持下划线、横杠、小数点</p>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag"></em>描&nbsp;&nbsp;述：</span>
								<div class="form-c">
									<input type="text" class="form-text" id = "ug_des" maxlength="2047"><i class="v-check"></i>
								</div>
							</div>

							<div class="form-item">
								<span class="form-tag">访问授权：</span>
								<div class="h-content3" id="select_a_g" style="margin-top: -19px; position: relative;width:300px">
								</div>
							</div>
						</div>
						
						<!---->
						<div class="form">
							<div class="form-item" style="height: 500px">
								<span class="form-tag"><em class="imp">*</em>管理员：</span>
								
								<div class="h-content3" id="select_ug" style=" width: 55%; margin-top: -19px;;padding: 10px 20px 0px 19px;">
									
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="btns s-hide">
				<a href="javascript:;" class="btn g_btn-submit btn-normal">保&nbsp;&nbsp;存</a>
				<!-- <a href="javascript:;" class="btn btn-normal" onclick="BackUsermanage();" >取&nbsp;&nbsp;消</a> -->
			</div>
				<div id="bBtn" style="position: fixed;z-index:5;">
				<a href="javascript:;" class="btn" style="float: right;" onclick="BackUsermanage();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
			</div>
			</div>
			
			<!-- 用户列表 -->
			<div class="container3">
				<div class="c-top">
					<!-- <div class="c-title">
						<a href="javascript:;" onclick="BackUsermanage();"><h3>用户管理</h3></a>
						<a href="javascript:;" onclick="user_manage();"><h3 class="unsel">角色管理</h3></a>
					</div> -->
					<div class="manual-head">
						{%if 2 in _power_sonid %}
						<div class="manual-title-other title-item" id="frist">
							<span onclick="reload(this);" id="user_Manage">用户管理</span>
							<i class="userm_icon"></i>
						</div>
						<div class="manual-title-other title-item" id="two" style="color: rgb(121, 121, 121);background: rgb(222, 222, 222)">
							<span onclick="user_manage();">角色管理</span>
							<i style="display: none;"></i>
						</div>
						{% else %}
						<div class="manual-title" id="">
							<span onclick="reload(this);" id="user_Manage">用户管理</span>
							<i class="userm_icon"></i>
						</div>
						{% endif %}
					</div>
				</div>
				<div class="c-wrap" style="padding: 10px 0 0;overflow:auto;">
					<div class="c-exp">
					
						<div class="h-explorer" id="user_manage_explorer">
							<div class="h-top h-top1">
								<div class="h-route" id="hostRoute"></div>

									<div class="filter filter1" style="float:right;min-width:auto;">
										<div id="waitTip" class="waitTip" style="float: right;margin-top: 7px; margin-left: -26px;"></div>
										<div class="search">
											<select name="user_select" id="user_select" class="filter-select" onchange="">
												<option value="0" selected>所有</option>
												<option value="ugname">用户组名</option>
												<option value="usercode">账号</option>
												<option value="username">姓名</option>
												<option value="description">描述</option>
												<option value="usernumber">工号</option>
												<option value="department">部门</option>
												<option value="phone">手机</option>
												<option value="rolename">角色名</option>
												<option value="adminname">管理员账号</option>
												<!-- <option value="userstatus">用户状态</option> -->
											</select>
											<select id="user_status" class="filter-select" style="display:none;">
												<option value="0">停用</option>
												<option value="1">启用</option>
												<option value="2">锁定</option>
												<option value="6">用户过期</option>
												<option value="7">临时用户</option>
												<option value="8">需要修改密码</option>
												<option value="9">密码过期</option>
											</select>

											<input type="text" class="filter-text" 
											id="gjz"
											placeholder="输入关键字" 
											onchange="if($('#gjz').val()!=''){$('#v_clear').show();}else{$('#v_clear').hide();};" 
											onblur="if($('#gjz').val() == '' && global_filter_n != ''){global_filter_n = '';_addFilterFuzzy(this,false,1);}"
											onkeydown=" if($('#gjz').val()!=''){$('#v_clear').show();}else{$('#v_clear').hide();};if (event.keyCode == 13){_addFilterFuzzy(this,false);return false;} else return; "
											onkeyup="if($('#gjz').val()!=''){$('#v_clear').show();}else{$('#v_clear').hide();};"
											style = "border-left: 0px;padding-right: 20px;">
											<i style="display:none;cursor: pointer;" class="v-check v-wrong" id="v_clear" onclick="_clearFilterFuzzy(this,1)"></i>
											<button class="filter-btn" onclick="_addFilterFuzzy(this,false)"><i class="add-filter"></i></button>
											<button class="filter-btn" onclick="_addFilterFuzzy(this,true)"><i class="append-filter"></i></button>
										</div>
										<div class="search" id="clearFilter1" style="margin: 0px 15px 0px -16px;display:none;">
											<button class="filter-btn" onclick="_clearFilterFuzzy(this)"><i class="clear-filter"></i></button>
										</div>
										<div class="selector" id="filterWW" style="display: none;">
											<span class="ww">检索条件</span>
											<ul></ul>
										</div>
										<div style="width: auto;float: right;margin-top:0px;/*margin-right:10px;*/">
											<a style="display:none;" href="javascript:;" value="0" id="first_grp" class="btn-first-grp"
												onclick="select_first_grp(this);">图标</a>
											<!--
											<select name="first_grp" id="first_grp" class="filter-select" style=" float: left;height: 27px;width:60px;margin-right:10px" onchange="select_first_grp(this);">
												<option value="0" selected="">图标</option>
												<option value="1">列表</option>
											</select>
											-->
										</div>
									</div>
								</div>

								<div class="h-catelog" style="padding-right: 0px; overflow: hidden !important;">
									<div class="icon-div" style="float: right;margin-top: 10px;margin-right: 10px;">
										<i style="display:none;" class="add-group" title="创建用户组" id="btn_2" onclick="create_g();"></i>
										<i style="display:none;" class="add-user" title="创建用户" id="btn_1" onclick="create_u();"></i>
									</div>
                                    <a href="javascript:;" id="route-root" style="font-size: 16px;color: #4d4d4d;font-weight: bold; margin: 15px 0 10px;"><i class="h-eicon h-eicon-g"></i><span>所有组</span></a>
                                    <div class="h-catelog-son-div" style="overflow: auto; height: 223px;">
                                    <ul id="hostCatelog"></ul>
                                    </div>
								</div>

							<div class="h-content" id="hostContent" style="user-select: none;-moz-user-select:none;" onselectstart="return false;" unselectable="on"></div>
						</div>
					</div>
					<div class="clearfix"></div>
					<div class="btns">
						<a href="javascript:;" class="btn btn-normal s-hide" id="importUser" onclick="_import_user(1);">导&nbsp;&nbsp;入</a>
						<a href="javascript:;" class="btn btn-normal" onclick="_export_user(2);">导&nbsp;&nbsp;出</a>
					</div>
					<div id="bBtn" style="position: fixed;z-index:5;">
						<a href="javascript:;" class="btn btn-cancle" style="float: right;"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>						
				</div>
			</div>
		<!--导入信息详情-->
			<div class="container6">
			<div id="importPage" style="display: none;">
				<div class="ap-top" id="">
					<div class="ctrl">
						<a href="javascript:;" class="re" onclick="_reloadDetail(2)" style="border-radius: 14px;"><i style="margin: 3px auto;margin-left: 8px;"></i></a>
						<!--<a href="javascript:;" class="close" onclick="_closeDetail(2)"><i></i></a>-->
					</div>
					<div class="types">
						<label>
							<input type="checkbox" name="" id="fail_IP_box" class="form-checkbox" >失败的用户</label>
					</div>
				</div>
				<div class="apWrap">
					<div class="title">
						<h2>导入详情</h2>
					</div>
					<div class="top">
						<div class="mm mm1">
							总数：<span>11</span> &nbsp;&nbsp;成功用户：<span>11</span> &nbsp;&nbsp;失败用户：<span>11</span> &nbsp;&nbsp;新增用户：<span>11</span> &nbsp;&nbsp;已存在用户：<span>11</span>
						</div>
					</div>
					<div class="clearfix"></div>
					<div id="apArea1" style="height:auto;">
					</div>
					<div id="aploadTip1">正在加载</div>
				</div>
				<div id="bBtn" style="position: fixed;z-index:5;">
                			<a href="javascript:;" class="btn" style="float: right;" onclick="_closeDetail(2)"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
        			</div>
			</div>
		</div>
		<!--交接 -->
			<div class="container4" style="display:none;">
			<div class="manual-head">
				<div class="manual-title">
					<span onclick="reload(this);" id="takeOver">交接用户</span>
					<i class="userm_icon"></i>
				</div>
			</div>

			<div class="c-cont">
				<div class="c-wrap" style="padding: 10px 0 0">
					<div class="c-exp" style="margin: -1px auto;">
					
						<div class="h-explorer">
							<div class="G-top">
								<div class="G-box1"></div><strong>&nbsp;基本信息</strong>
							</div>
							
							<div class="h-content2" style="min-height:120px;height:auto;width: 100%;overflow: hidden;padding: 14px 0 0;">
								<!--
								<div class="form-item for-avatar" style="width: 180px;">
									<div id="tAvatar_d" onclick="_getAvatarList(this)"><img src="/manage/images/avatar1.jpg"></div>
								</div>-->
								
								<div class="col3">
									<div class="form-item">
										<span class="form-tag" style=""><em class="imp">*</em>账号：</span>
										<div class="form-c" style="">
											<input type="text" class="form-text" id="sys_u_name_d" maxlength="31" style="" onblur="regCheck(this,/^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/)" tabindex="1" disabled ><i class="v-check"></i>
										</div>
									</div>
									
									

									<div class="form-item">
										<span class="form-tag"><em class="imp">*</em>姓&nbsp;&nbsp;名：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "user_name_d" maxlength="127" onblur="regCheck(this,/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/)" tabindex="4" disabled><i class="v-check"></i>
										</div>
									</div>
									
									<div class="form-item">
										<span class="form-tag">手&nbsp;&nbsp;机：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_phone_d" onblur="regCheck(this,/^[0-9]{11}$/)" maxlength="11" tabindex="5" disabled ><i class="v-check"></i>
										</div>
									</div>
									
									<div class="form-item">
										<span class="form-tag">描&nbsp;&nbsp;述：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_descr_d" maxlength="2047" tabindex="8" disabled ><i class="v-check"></i>
										</div>
									</div>	
									<div class="form-item" >
										<span class="form-tag">邮&nbsp;&nbsp;箱：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_email_d" onblur="regCheck(this,/^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/)" maxlength="127" tabindex="6" disabled ><i class="v-check"></i>
										</div>
									</div>

									<div class="form-item">
										<span class="form-tag">部&nbsp;&nbsp;门：</span>
										<div class="form-c">
											<input type="text" class="form-text" id = "sys_u_depart_d" maxlength="127" tabindex="9" disabled ><i class="v-check"></i>
										</div>
									</div>
								</div>
								
							</div>
						</div>
					</div>
					<div class="c-exp" style="margin: -1px auto;" id="exp_auth_d" >
						<div class="h-explorer">
							<div class="G-top" style="    margin: 10px 0 10px 0;">
								<div class="G-box1"></div><strong>&nbsp;交接对象</strong>	
							</div>
							<div class="h-content2" style="height: auto;width: 100%;overflow: hidden;padding: 0px;" >
								<div class="form-item" style="width:100%;">
									<span class="form-tag" style="margin-left:85px;"><em class="imp">*</em>用户：</span>
									<div class="form-c">
										<select class="form-select" name="" id="user_tranfer_t" style="width:202px" tabindex="7" >
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="clearfix"></div>
					<div class="btns s-hide">							
						<a href="javascript:;" class="btn btn-normal" onclick="Transfer();">保&nbsp;&nbsp;存</a>
						<!-- <a href="javascript:;" class="btn btn-normal" onclick="BackUsermanage();" >取&nbsp;&nbsp;消</a> -->
					</div>
					<div id="bBtn" style="position: fixed;z-index:5;">
						<a href="javascript:;" class="btn" style="float: right;" onclick="BackUsermanage();"><i class="icon-c3-1"></i>返&nbsp;&nbsp;&nbsp;&nbsp;回</a>
					</div>
				</div>
			</div>
		</div>
		<!--用户导入-->
			<div class="dialog-cont" id="scDCTab2_import" style="display:none;">
			<div class="fsel" style="margin-left: 0;">
				<ul><li><a class="active" href="javascript:;" id="task_import" onclick="set_tab(this,1);">用户导入</a></li>
					<li><a href="javascript:;" id="task_list_tab" onclick="set_tab(this,2);">任务列表</a></li>
				</ul>
			</div>
			<div class="container5">
				<div id="import_module" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;">
					<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
						<div class="tab-t c-form">
							<span class="form-tag">下载模板：</span>
							<div class="ctr" style="margin-left:6px;">
								<a class="btn" href="javascript:;" style="" onclick="_export_user(1);">下载</a>
							</div>
						</div>
						<div class="c-form" style="">
							<form id="uploadForm">
							<!--form action="/bhost/import_data" method="POST" name="frm1" enctype="multipart/form-data">
								<input type="hidden" name="z1" value="" />-->
								<div class="form-item tab-t">
									<span class="form-tag"><em class="imp">*</em>选择文件：</span>
									<div class="form-c ctr" style="width:300px;padding:0 0 0 7px;">
										<div class="item" style="float: left;width:67%">
											<input id="file_v" name="file_v" class="form-text" type="text" style="float: left;width: 220px;cursor: pointer;">
											<input id="file_change" name="file_change" class="form-text" type="text" onclick="browes();" onchange="/*filetip(this);*/" style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;">
											<input id="file_change1" name="file_change1" class="form-text" type="file" onchange="filetip(this);" style="float: left;opacity: 0;margin-top: -28px;cursor: pointer;display: none;">
										</div>
										<div class="item" style="float: left;width:33%">
											<a class="btn" href="javascript:;" style="margin-left: 70px;height: 26px;width:33px;" onclick="browes();">浏览</a>
										</div>
										<p class="form-tip" id="" style="margin-top: 28px;width: 243px;height: 32px;">特殊字符仅支持下划线、横杠、小数点</p>
									</div>
								</div>
							</form>
						</div>
						<!-- <div class="c-form">
							<span class="form-tag">审核：</span>
							<div style="width: 215px;margin-left: 200px;margin-top: 4px;">
								<input class="form-checkbox" id="pending_box" type="checkbox"/>
								<span class="tip" style="color: #b2b2b2;">导入前对主机进行连接测试</span>
							</div>
						</div> -->
						<div class="c-form">
							<span class="form-tag">覆盖：</span>
							<div style="width: 215px;margin-left: 200px;margin-top: 4px;">
								<input class="form-checkbox" id="cover_box1" type="checkbox"/>
								<span class="tip" style="color: #b2b2b2;">覆盖相同账号的用户</span>
							</div>
						</div>
						<div class="btns" style="">
							<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
							<!-- <a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a> -->
						</div>
					</div>
				</div>
			
				<div id="details_module" class="c-cont" style="min-height:400px;max-height:400px;overflow:hidden;display:none;">
					<div class="c-form" style="padding:0;width: auto;">
						<div class="c-wrap" style="padding:0;">
						<div class="c-table r-list" style="padding:0;">
							<div class="tab-t">
								<div class="ctr">
									<a href="javascript:;" class="btn btn-default" onclick="select_all()">全选</a>
									<a href="javascript:;" class="btn btn-default" onclick="del_hosttask_more()">删除</a>
									<a href="javascript:;" class="btn btn-default" onclick="fresh_task_list()">刷新</a>
								</div>
							</div>
							<div class="box-table" style="overflow: hidden;">
								<table cellpadding="0" cellspacing="0" id="usertask_list">
									<thead>
										<tr>		
											<th width="50"><input type="checkbox" class="form-checkbox" id="check_task_page"/></th>
											<th>名称</th>
											<th>成功数</th>
											<th>失败数</th>
											<th>状态</th>
											<th>错误信息</th>
											<th width="50"></th>
										</tr>
									</thead>
									<tbody>
										
									</tbody>
								</table>
							</div>
							<div class="tab-i">
								<div class="il">
									每页显示<span id="page_total">10</span>条 总数<span id = "task_total">25</span>  选中：<span id = "select_total">0</span>
								</div>

								<div class="ipage">
									<a href="javascript:;" class="nav2 begin" onclick="turn_page(1);"><i></i></a>
									<a href="javascript:;" class="nav prev" onclick="turn_page(2)"><i></i></a>
									<input type="text" value="1" id="curpage" onchange="turn_page(5)">/ <span id = "totalpage">25</span>
									<a href="javascript:;" class="nav next" onclick="turn_page(3)"><i></i></a>
									<a href="javascript:;" class="nav2 end" onclick="turn_page(4)"><i></i></a>
								</div>
							</div>
						</div>
						
						<div class="clearfix"></div>
						<!--
						<div class="btns" style="/*padding: 20px 0 0px;*/">
							<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
							<a href="javascript:;" class="btn btn-normal btn-cancel" >取&nbsp;&nbsp;消</a>
						</div>
						-->
					</div>
				</div>
			</div>
		</div>
		<!-- 修改PIN浮层 -->
		<div class="dialog-cont" id="PINDialog" style="display:none;">
			<div class="container">
				<div class="c-cont" style="min-height:200px;max-height:200px;overflow:auto;">
					<div class="c-form c-form-host" style="padding: 0 0 90px;">
						<div class="clearfix"></div>
						<div class="c-table">
							<div class="form">
								<div class="form-item" style="width: 35%;">
									<span class="form-tag" style=""><em class="imp">*</em>新pin码：</span>
									<div class="form-c" style="">
										<input type="password" class="form-text" id="pin_input1" style="width: 100%;" tabindex="1">
									</div>
								</div>
								<div class="form-item" style="width: 35%;margin-left: 140px;">
									<span class="form-tag" style=""><em class="imp">*</em>确认pin码：</span>
									<div class="form-c" style="">
										<input type="password" class="form-text" id="pin_input2" style="width: 100%;" tabindex="1">
									</div>
								</div>
							</div>
							<div class="btns" style="padding: 10px 0 10px;">
								<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
								<a href="javascript:;" class="btn btn-normal btn-cancel">重&nbsp;&nbsp;置</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<form action="/bhost/import_data" method="POST" name="frm1" enctype="multipart/form-data">
			<input type="hidden" name="z1"  value="" />
			<input type="hidden" name="a0"  value="" />
			<input type="hidden" name="a1"  value="" />
			<input type="hidden" name="a99"  value="" />
		</form>
	</div>
		<!-- 认证方式浮层 -->
		<div class="dialog-cont" id="authtype_suspend" style="display:none;max-height:500px;min-height:500px;scrolling:yes">
		<iframe src="" width="100%" height="100%" frameborder="0" name="mframe1" id="mframe1" style="    height: 521px;margin-top: -21px;"></iframe>
		<div class="clearfix"></div>
			
		</div>
		<!-- 角色浮层 -->
			<div class="dialog-cont" id="role_suspend" style="display:none;max-height:580px;min-height:500px;scrolling:yes">
			<div class="container14" style="">
				<div class="c-cont3" style="height: 585px;" >
					<div class="c-wrap">
						<div class="form-item form-nm" style = "margin-left: 8px; ">
							<div class="form-tag"><em class="imp">*</em>名&nbsp;&nbsp;称：</div>
							<div class="form-c">
								<input type="text" class="form-text" id = "r_n" maxlength="127" onblur="regCheck(this,/^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/)"><i class="v-check"></i>
								<span style="font-size: 12px;">&nbsp;&nbsp;特殊字符仅支持下划线、横杠、小数点</span>
							</div>
						</div>

						<div class="c-box">
							<div class="cb-title">
								<em class="imp"style="color: #F00;font-style: normal;float: left;margin-left: -6px;">*</em>
								<h3>角&nbsp;&nbsp;色</h3>
							</div>

							<div class="cb-cont">
								<table cellpadding="0" cellspacing="0" class="cbtab">
									<tbody>

									</tbody>
								</table>
							</div>
						</div>
						<div class="btns s-hide">
							<a href="javascript:;" class="btn btn-submit btn-normal">保&nbsp;&nbsp;存</a>
							<!--
							<a href="javascript:;" class="btn btn-cancle btn-normal">取&nbsp;&nbsp;消</a>
							-->
						</div>
					</div>
				</div>
			</div>
			
		</div>
	
		</div>
	</div>
	<!-- 导出方式 浮层-->
	<div class="dialog-cont s-hide" id="export_type" style="display:none;">
		<div class="container99">
			<div id="export_module" class="c-cont" style="min-height:350px;max-height:300px;overflow:hidden;">
				<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
					<span>方式：</span>
					<!--<select class="filter-select" style="width: 120px" id="exportType_select">
						<option value="all" selected>所有</option>
						<option value="user">用户</option>
						<option value="usergroup">用户组</option>
					</select>-->
					<label class="form-label" style="width: 60px;"><input type="radio" class="form-radio" id="all_check" value="all" name="exportType_radio" checked="checked"/>所有</label>
					<label class="form-label" style="width: 60px;"><input type="checkbox" class="form-checkbox" id="user_check" value="user" name="exportType_radio"/>用户</label>
					<label class="form-label" style="width: 60px;"><input type="checkbox" class="form-checkbox" id="usergroup_check" value="usergroup" name="exportType_radio"/>用户组</label>
				</div>
				<div class="c-form" style="padding-bottom:10px;padding-left:50px;">
					<span>格式：</span>
					<label class="form-label" style="width: 60px;"><input type="radio" class="form-radio" value=0 name="exportType_radio2" checked="checked"/>CSV</label>
					<label class="form-label" style="width: 60px;"><input type="radio" class="form-radio" value=1 name="exportType_radio2"/>XLS</label>
					<!--<label class="form-label" style="width: 60px;"><input type="radio" class="form-radio" value=2 name="exportType_radio2"/>XLSX</label>-->
					
					
					
				</div>
			</div>
			<div class="btns" style="/*padding: 20px 0 0px;*/">
				<a href="javascript:;" class="btn btn-normal btn-submit" >确&nbsp;&nbsp;定</a>
			</div>
		</div>
	</div>
<!--  -->
<form action="/bhost/get_u" method="POST" name="frm_user" id="frm_user">
	<input type="hidden" name="tasktype" value = ""/>
	<input type="hidden" name="userid" id = "userid" value="" />
	<input type="hidden" name="se" id = "se" value="" />
	<input type="hidden" name="a0" value="" />
</form>
<!-- -->
<div id="avatars" class="avatars">
	<ul>
		<li><a href="javascript:;" class="active" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar1.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar2.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar3.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar4.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar5.jpg"></a></li>
		<li><a href="javascript:;" onclick="_setAvatar(this)"><img alt="" src="/manage/images/avatar6.jpg"></a></li>
	</ul>
</div>

<style>
	#user_page{
		min-width: 1191px;
	}
	#changePIN {
		outline:none;
	}
	#saveUser {
		outline:none;
	}
	#importUser {
		outline:none;
	}	
	.c-form-host .form-item .form-tag {
		width: 8em;
	}
	.c-form-host {
		width: auto;
		min-width: 0;
		font-size: 14px;
		padding: 10px 20px;
	}
	#changePIN:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}
	#changePIN{
		float: left;
		padding: 0px 2px;
		line-height: 25px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
		width: 80px;
		text-align: center;		
	}	
	.fsel {
		position: fixed;
		margin: -67px 0 0 -20px;
		width: 580px;
		height: 45px;
		background: #FFF;
	}
	.fsel ul li {
		float: left;
	}

	.fsel ul li a.active {
		border-top: 5px solid #4cb2d0;
		border-right: 1px solid #DDD;
		border-left: 1px solid #DDD;
		line-height: 41px;
		border-bottom: 1px solid #FFF;
	}
	.fsel ul li a {
		float: left;
		padding: 0 32px;
		line-height: 45px;
		font-size: 18px;
		color: #000;
	}
	.ui-dialog-body{
		padding: 20px 0 0 0;
	}
	#btn_pwd:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}
	#btn_pwd{
		float: left;
		padding: 0px 5px;
		line-height: 24px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
	}
	.srItem .stwrap input.datepicker, .timeTemp input.datepicker {
		float: left;
		width: 97px;
		border: 0;
		background: transparent;
		text-align: center;
		margin-right: 4px;
	}
	.srItem .stwrap input.timeinput, .timeTemp input.timeinput {
		float: left;
		width: 18px;
		text-align: center;
		vertical-align: middle;
		border: 0;
		padding: 0;
	}
	.srItem {
		width: 61%;
		height: auto;
		line-height: 30px;
		border-bottom: 1px solid #ffffff;
		overflow: hidden;
	}
	.h-content2 .form-item {
		height: auto;
		padding: 20px 0 10px;
		min-height: 38px;
		padding: 5px;
		width: 380px;
		float: left;
	}
	.h-content2 .form-tag {
		float: left;
		width: 80px;
		text-align: right;
		color: #000;
		line-height: 28px;
	}
	.h-content2 .form-c {
		padding-left: 0px;
		position: relative;
	}
	.h-content2 .form-text {
		width: 170px;
	}
	.h-content2 .rzj {
		float: right;
		margin-right: 40px;
		color: #000;
	}
	.h-content2 .form-tip {
		padding-left: 48px;

	}
	a.btn-normal1{
		display: inline-block;
		width: 90px;
		height: 30px;
		border: 1px solid #DDD;
		text-align: center;
		line-height: 32px;
		border-radius: 18px;
		margin: 0 10px;
		background-color: #fff;
		transition: background-color 0.4s;
		color: #7c7c7c;
	}
	a.btn-normal1:hover{
		background-color: #8d808a;
	    color: #fff;
	}
	.for-avatar {
	    margin-top: -13px;
	    margin-left: 5px;
	}
	.col3{
		padding-left: 90px;
		height: auto;
		overflow: hidden;
	}
	.col3 .form-item{
		width: 33.3%;
		padding: 12px 0px 0px 0px;
	}
	.h-content2 .form-tip{
		padding-left: 80px;
	}
	.input-group{
		display: inline-block;
		width: 200px;
		border: 1px solid #b2b2b2;
		border-radius: 5px;
		overflow: hidden;
		vertical-align: middle;
	}
	.input-group input{
		border: 0;
		text-align: center;
		background: transparent;
	}
	.blank_in{width: 12px;}
	/*
	#totp_checkbox span:hover {
		display: inline-block;
		position: absolute;
		vertical-align: middle;
		width: 20px;
		height: 20px;
		z-index: 1;
		background: url(/manage/images/checkbox.png) no-repeat 0 0;
		background-position: -20px 0;
		cursor: pointer;
	}
	*/
	#details_module table th {
		text-align:center
	}
	#details_module table td {
		text-align:center
	}
	#table_title th{
		text-align:center
	}
	#hosttask_list_detail td{
		text-align:center
	}
	#import_host_list_detail td{
		text-align:center
    }
    .h-path-wrap a {
        line-height: 18px;
        padding: 0px 4px;
        border-width: 1px;
        border-style: solid;
        border-color: rgb(217, 217, 217);
        border-image: initial;
    }
	#importPage{
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: #f3f3f3;
		overflow: auto;
	}
	div.icon-div i {
		width: 30px;
    	height: 30px;
	}
	div.icon-div i.add-user {
		float: right;
		margin-right: 0;
		margin-left: 5px;
		margin-top: 3px;
		background: url(/manage/images/icon-coll23.png) no-repeat 50% 50%;
		cursor: pointer;
	}
	div.icon-div i.add-group {
		float: right;
		margin-right: 0;
		margin-left: 5px;
		margin-top: 3px;
		background: url(/manage/images/icon-coll22.png) no-repeat 50% 50%;
		cursor: pointer;
	}
	.apItem .label.succ:before{
		content: '';
		float: left;
		width: 20px;
		height: 20px;
		margin: 3px 14px 0 14px;
		background: url(/manage/images/user_succ.png) no-repeat 0 0;
	}
	.apItem .label.fail:before{
		content: '';
		float: left;
		width: 20px;
		height: 20px;
		margin: 3px 14px 0 14px;
		background: url(/manage/images/user_fail.png) no-repeat 0 0;
	}
	#filterWW_account:after{
		margin: 11px 0 0 34.5em;
	}
	.apItem {
		width: 50%;
		padding: 5px 0;
		overflow: hidden;
		transition: background-color 0.4s;
		float: left;
	}	
	.set-view li i.ctrl.del {
		display: none;
		position: inherit;
		width: 15px;
		height: 15px;
		background: url(/manage/images/icon-ctr.png) no-repeat 0 0;
		vertical-align: middle;
		margin-left: 5px;
		cursor: pointer;
		margin-top: 0px;
	}
	
	
	.set-view li:hover i.ctrl.del {
		display: inline-block;
	}
	#select_local + .select2-container .select2-selection--single .select2-selection__rendered{
		padding-left:5px;
		padding-right:0px;
	}
	#select_local + .select2-container--default .select2-selection--single .select2-selection__arrow{
		width:13px;
	}
	.h-content-list{
		padding-top:0px !important;
	}
	.h-content-list tr td.in {
		width:10px;
	}
	.h-content-list tr td:last-child {
		width:150px;
	}
    .h-content-list tr td:nth-child(3){
		width:60px;
	}
    .h-content-list tr td:nth-child(5){
		width:50px;
	}
	.h-content-list .item{
		display:none;
		height:28px;
		width:10px;
		padding: 0;
		margin-left: 0px;
		padding-bottom: 11px;
	}
	.h-content-list .tab-ctr a {
		width:16px !important;
	}
	.h-content-list .item i{
		display:none;
	}
	.h-content-list .item .c {
		width: 99%;/*写给不支持calc()的浏览器*/ 
		width:-moz-calc(100% - (1px) * 2); 
		width:-webkit-calc(100% - (1px) * 2); 
		width: calc(100% - (1px) * 2);
		padding: 6px 0;
	}
	.h-content-list .item .div_item {
		float: left;
		width: 25%;
	}
	.h-content-list .c-table {
		padding: 10px 10px 0 10px;
	}
	.h-content-list .c-table {
		padding: 10px 10px 0 10px;
	}
	a.btn-first-grp {
		float: left;
		padding: 0 15px;
		line-height: 24px;
		color: #8D808A;
		border: 1px solid #8D808A;
		margin-right: 12px;
		border-radius: 5px;
		transition: all 0.4s;
		margin-top: 1px;
		background-color: #fff;
	}
	a.btn-first-grp:hover {
		background-color: #8D808A;
		border-color: #8D808A;
		color: #fff;
	}
    .tab-moreinfo {
        max-height: 160px;
    }
</style>

{% endblock %} 

{% block script %}

<script>
	var temp4 = $('#Temp4>.sitem:last').clone();
	var global_filter = "";
	var global_pid = "";	//所在组ID
	var global_piid = ""; //路径id
	var global_id = 0;		
	var flag = "0";   //0为创建 1为修改
	var find_result = ""; //过滤结果
	var copy_id = "";
	var photo = "avatar1.jpg";
	var oldpid = "";
	var isuser = "";
	var iscut = "";
	var copy_name = [];		//copy 或cut 的名字 用于剪切后改动目录
	var copy_piid = "";		//copy 或cut 时的父ID 用于剪切后改动目录
	var cut_num = "";
	var user_ugroup = "";
	var user_Password = "";
	var search_user='';
	var sess = window.parent.document.frm.se.value;
	var authDefault_flag = 0;//0->no change; 1-> tokenkey; 2-> change pin code 3-> both;	
	var auth_class = 0;
	var flag_pin = 0;//判断用户是否新绑定usbkey 1->已绑定
	var loginuserid;
	var disabled_class = '';
	var _power_arr={{_power_sonid}};
	var first_grp = '{{first_grp}}';
	if (first_grp == '0') {
		$('#first_grp').text('列表');
		$('#first_grp').attr("value", '0');
		$('#first_grp').show();
	} else {
		$('#first_grp').text('图标');
		$('#first_grp').attr("value", '1');
		$('#first_grp').show();
	}
	$(function(){
		if_disable = $('#nav-s1 li[data-modeid=4]',parent.document).attr('_if_disable').split('-')[0];
		if(if_disable == '1'){
			$('.s-hide').remove();
		}
		$.ajax({
			url:'/bhost/_get_userid',
			type:"POST",
			async:false,
			data:{a0:sess,a1:window.parent.document.frm.us.value},
			success: function(Result) {
				data = JSON.parse(Result);
				loginuserid = data.info;
			}
		})	
		get_AuthType_role();
		_get_tokenid();
		get_role_simple();
		var now = new Date();
		var setDate = {
			year: now.getFullYear(),
			month: now.getMonth() + 1,
			day: now.getDate()
		}
		$('input.datepicker').each(function(){
			$(this).jeDate({
				format:"YYYY-MM-DD",
				isTime:true,
				minDate:setDate.year + "-" + setDate.month + "-" + setDate.day
			});
		})

		_getDate('#srTemp-time');
		getPwdStrategy();

		$('#user_select').on('change',function(){
			var user_select=$('#user_select').val();
			if(user_select=='userstatus'){
				$("#user_status").val('0').trigger('change');
				$('#user_status').next().show();
				$('#gjz').hide();
			}else{
				$("#user_status").val('0').trigger('change');
				$('#user_status').next().hide();
				$('#gjz').show();
			}
		});

		$('.form-select,.filter-select').select2({minimumResultsForSearch: -1});
		$("#user_status").next('span').find('span.select2-selection').css({"border-bottom-left-radius":"1px","border-top-left-radius":"1px","margin-left":"-1px"});
		$('#user_status').next().hide();		
		//$('#sys_u_authtype').select2('destroy').select2();
		$('#user_tranfer_t').select2('destroy').select2();
		//$('.filter-select').select2({minimumResultsForSearch: -1});
		$('#Temp4 .select2').select2({minimumResultsForSearch: -1});
		$("a.btn-submit").unbind().bind("click",function(){
			savedata();
		});
		
		$("a.btn-cancle").unbind().bind("click",function(){
			document.frm.tasktype.value = 3;
			document.frm.se.value = sess;
			document.frm.a0.value = sess;
			document.frm.action = '/bhost/index';
			document.frm.i10.value = 1;
			document.frm.submit();
		});

		$("a.g_btn-submit").unbind().bind("click",function(){
			save_g();
		});
		$('#timeSet').on('ifChecked', function(event){
			$('.bc.srItem').show();
		}).on('ifUnchecked', function(event){
			$('#jedatebox').remove();
			$('.bc.srItem').hide();
		});
		$('.form-time').iCheck({
			checkboxClass: 'icheckbox_minimal-blue',
	    	radioClass: 'iradio_minimal-blue',
	    	increaseArea: '0' // optional
		});
		$('#user_select').select2('destroy').select2({minimumResultsForSearch: -1});

		$("input[name=user_action]").on('ifChanged',function(){
			if($("#user_action1").prop('checked') == true){
				$('#role_div').show();
				$('#admin_div').show();
				$("#append_div").show();
				var name2 = $('#select_r_xselect').data('value');
				var pwd_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('pwd_flag');
				var access_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('access_flag');
				if(access_flag == '1'){
					if(global_id ==0 ) $('#exp_auth').show();
				}else{
					//找到所有的 已选的角色
					var a = false
					$('#select_r li.item input').each(function(i,item){
						if($(this).attr('access_flag') == '1'){
							if(global_id ==0 ) {
								$('#exp_auth').show();
								a = true;
								return false;
							}
						}
					})
					if(!a){
						$('#exp_auth').hide();
					}
				}
				$('#ug_div').show();
				$('#transfer_div').hide();
				$('div.xSelect-view[data-id=xSelect-role]').hide();
				$('div.xSelect-show[data-id=xSelect-role]').removeClass('on');
				$('#un').select2('destroy');
				$('#un').select2();
			}else{
				$('#role_div').hide();
				$('#admin_div').hide();
				$("#append_div").hide();
				$('#exp_auth').hide();
				$('#ug_div').hide();
				$('#transfer_div').show();
				$('div.xSelect-view[data-id=xSelect-role]').hide();
				$('div.xSelect-show[data-id=xSelect-role]').removeClass('on');
				$('#un').select2('destroy');
				$('#un').select2();
				//获取继承的用户
				get_tranuser();
			}
		});
		/*
		$("#totp_checkbox").next('span').on("click",function(){
			if($(this).attr("class") == "checkbox"){
				if ($("#sys_u_name").val() != ""){
					qr_code_show();
				}else{
					_alert(2,"系统用户","请输入账号");
				}
			}else{
				$("#totp_checkbox").attr('checked',false);
				$(this).attr("class","checkbox");
				$(this).css({
					"display": "inline-block",
					"position": "absolute",
					"vertical-align": "middle",
					"width": "20px",
					"height": "20px",
					"margin-left": "-12px",
					"margin-top": "-20px",
					"z-index": "1",
					"background": "url(/manage/images/checkbox.png) no-repeat 0 0",
					"cursor": "pointer"
				});
			}
		});
		*/
		$("#totp_v").on("input propertychange",function(){
			this.value = this.value.replace(/\D/g, "");
		}).on("paste",function(){return false});
		
		var myBrowser_value=myBrowser();
		if(myBrowser_value=='FF'){
			$('#v_clear').css('margin-left',-77);
		}
		
		$("#select_pin").bind('change',function(){
			if($(this).val() == '0'){
				$('#span_pwd').html("初始密码");
				$('#sys_u_pwd_new').attr('disabled',false);
				$('#sys_u_pwd_tr').attr('disabled',false);
				$('#btn_pwd').parent().show();		
			}else{
				if(global_flag_pwd == '3'){ //只有usbkey
					$('#span_pwd').html("密&nbsp;&nbsp;码");
					$('#sys_u_pwd_new').attr('disabled',true);
					$('#sys_u_pwd_tr').attr('disabled',true);
					$('#btn_pwd').parent().hide();
				}else{ 
					$('#span_pwd').html("密&nbsp;&nbsp;码");
					$('#sys_u_pwd_new').attr('disabled',false);
					$('#sys_u_pwd_tr').attr('disabled',false);
					$('#btn_pwd').parent().show();
				}
				change_PIN();
			}
			$('#sys_u_pwd_new').val('');
			$('#sys_u_pwd_tr').val('');
		});
		$("#select_local").bind('change',function(){
			if($(this).val() == '0'){
				$('#span_pwd').html("初始密码");
				if(($("#changepin_div").find("text").is(":visible") && $("#changepin_div").find("text").text() == "未配置") || ($("#FinP_reset_div").find("text").is(":visible") && $("#FinP_reset_div").find("text").text() == "未录入") || $("#auth_div").is(":visible") == false){ //存在未配置 或者 未录入
					$('#sys_u_pwd_new').attr('disabled',false);
					$('#sys_u_pwd_tr').attr('disabled',false);
					$('#btn_pwd').parent().show();
				}else{
					$('#sys_u_pwd_new').attr('disabled',true);
					$('#sys_u_pwd_tr').attr('disabled',true);
					$('#btn_pwd').parent().hide();
				}
			}else{
				$('#sys_u_pwd_new').attr('disabled',false);
				$('#sys_u_pwd_tr').attr('disabled',false);
				$('#btn_pwd').parent().show();
				$('#span_pwd').html("密&nbsp;&nbsp;码");
			}
			/*if(($("#changepin_div").find("text").is(":visible") && $("#changepin_div").find("text").text() == "未配置") || ($("#FinP_reset_div").find("text").is(":visible") && $("#FinP_reset_div").find("text").text() == "未录入")){ //存在未配置 或者 未录入
				$('#sys_u_pwd_new').attr('disabled',false);
				$('#sys_u_pwd_tr').attr('disabled',false);
				$('#btn_pwd').parent().show();
			}else{
				$('#sys_u_pwd_new').attr('disabled',true);
				$('#sys_u_pwd_tr').attr('disabled',true);
				$('#btn_pwd').parent().hide();
			}*/
		});
		// $('#all_check').iCheck('uncheck');
		// $('#user_check').iCheck('check');
		// $('#usergroup_check').iCheck('check');
	})

function myBrowser(){
	var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
	var isOpera = userAgent.indexOf("Opera") > -1;
	if (isOpera) {
		return "Opera"
	}; //判断是否Opera浏览器
	if (userAgent.indexOf("Firefox") > -1) {
		return "FF";
	} //判断是否Firefox浏览器
	if (userAgent.indexOf("Chrome") > -1){
		return "Chrome";
	}
	if (userAgent.indexOf("Safari") > -1) {
		return "Safari";
	} //判断是否Safari浏览器
	if (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera) {
		return "IE";
	}; //判断是否IE浏览器
}
function change_name(){
	if($('#user_name').val()=="") {
		$('#user_name').val($('#sys_u_name').val());
	}
}
//令牌
function _get_tokenid(current_name){
	$("#TokenID").empty().html('<div class="item" style="float: left;margin-top: -10px;width: 100%"><select class="filter-select" name="ti" id="ti" style="width:86px;" tabindex="-1" aria-hidden="false"></select></div>');
	var s = {
		"TokenId":"",
		"Key":"",
		"UserSet":"",
		"searchstring":""
	}
	$.ajax({
		url:"/bhost/get_toten_list",
		type:"POST",
		async:false,
		data:{a0:sess,a5:JSON.stringify(s)},
		success:function(result){
			token_result = JSON.parse(result);
			if(token_result.Result){
				token_result = token_result.info;
				$("#ti").empty().append('<option value=\"-1\">选择令牌</option>');
				$.each(token_result.data,function(i,item){
					if((item.UserSet == null || item.UserSet == current_name) && item.Memo == '已检测'){
						$("#ti").append('<option value="'+item.TokenId+'" title="'+item.TokenId+'">'+item.TokenId+'</option>');
					}
				})
			}else{
				_alert(1,"系统用户",'获取令牌失败');
			}
		}
	});
	$('#TokenID .filter-select').select2();
}

//12-8更改时间插件
function _getDate(obj) {
	var now = new Date();
	var setDate = now.getTime();
	setDate = new Date(setDate);
	var month = (setDate.getMonth() + 1).toString();
	var day =  setDate.getDate().toString();

	if(month.length == 1){
		month = '0' + month;
	}

	if(day.length == 1){
		day = '0' + day;
	}
	setDate = {
		year: setDate.getFullYear(),
		month: month,
		day: day
	}
	setDate = setDate.year + '-' + setDate.month + '-' + setDate.day;
	$('input.datepicker').each(function(i,item){
		if(i==0){
			$(item).val(setDate);
			$(item).parent().find('input.timeinput').val('00');
		}else if(i==1){
			$(item).val(setDate);
			$(item).parent().find('input.timeinput').each(function(i){
				if(i == 0){
					$(this).val('23');
				}else{
					$(this).val('59');
				}
			})
		}
	});
}

function g_tsel(obj){
	var this_class=$(obj).attr('class');
	if(this_class=='g-tsel'){
		$('#accset').focus().select();
		_autoView($(obj).children(),4,3);
	}
}

	//获取 继承用户列表
function get_tranuser(){
	loginusercode = window.parent.document.frm.us.value;
	$.ajax({
		url: '/bhost/GetTransUser',
		type: "POST",
		async: false,
		data: { a0:sess, a1:loginusercode, a2:''},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result) {
				tranuser_list  = result.info;
				$('#user_tranfer').empty().append('<option value="">请选择</option>');
				$(tranuser_list).each(function(i,item){
					$('#user_tranfer').append('<option value="'+item.UserId+'">'+item.UserCode+'</option>');
				})
				$('#user_tranfer').val('').trigger('change');
			}
			else{
				$('#user_tranfer_t').empty().append('<option value="">无交接对象</option>');
			}
		}
	})
	$('#user_tranfer').select2();
}
function _addFilter_user(obj,type,flag) {		// 0 -> 只是搜索   1-> 添加条件
	var nameReg = /^[A-Za-z0-9_-]+$/;
	var id = $(obj).parent().children('select').children('option:selected').val();
	var v1 = $(obj).parent().children('select').children('option:selected').text();
	var v2 = $(obj).parent().children('input[type=text]').val().trim();
	_getWait($("waitTip1"));
	if (id == "0") {
		// $('#filterWW1>ul').empty();
		// search_user = "";
		// search_user_n = "";
		// $(obj).parent().children('input[type=text]').val('');
		// $("#filterWW1").attr("style", "display:none;");
		// selView_user();
		// return false;
		v1='';
	}else{
		v1=v1+'-';
	}
	if (v2 == '' && flag != 1) {
		$("#user_text").focus();
		_alert(2, '搜索', '请输入关键字',$("#user_text"));
		return false;

	}else{
		if(search_user.indexOf(id+'-'+v2+'\t')>=0){
			$("#user_text").focus();
			_alert(2,'搜索','相同的搜索条件已存在',$("#user_text"));
			return false;
		}
		// if(id=='Name' && !nameReg.test(v2)){
		// 	$("#user_text").focus();
		// 	_alert(1,'搜索','搜索条件格式不正确',$("#user_text"));
		// 	return false;
		// }
		if(type == false){
			if(flag!=1) search_user_n = v1+v2;
			selView_user();
		}else{
			var search_typeall=search_user;
			search_typeall=search_typeall+id+'-'+v2+'\t';
			search_user = search_typeall;
			search_user_n = "";
			$('#filterWW1>ul').append('<li style="height: 18px;"><span style="display:none;">' + id+'-'+v2 + '</span><span style="" class="ww">' + v1 + v2 + '</span><i class="del" style="margin-top: 2px;" onclick="_delFilter_user(this);"></i></li>')
			$("#user_text").val("");
			$('#user_text_check').hide();
			selView_user();
		}
	}
}
function _delFilter_user(obj) {
	var id = $(obj).parent().find("span");
	var ids = $(id).eq(0).text();
	var v2_text = $(id).eq(1).text();
	var v2_str = v2_text.split("-");
	var search_typeall = search_user;
	v2_str[0] = "";
	var str_v2 = v2_str.join('-');
	var str = ids + '-' + str_v2.substr(1,str_v2.length);
	var search_str = "";
	var search_typeall_str = search_typeall.split("\t");
	var i2 = 0;
	$.each(search_typeall_str,function(i,item){
		if (i2 == 0 && item == ids){
			i2 = 1;
		}else if(item != ""){
			search_str = search_str + item + '\t';
		}
	})
	search_user = search_str;
	$(obj).parent().remove();
	_getWait(".waitTip1");
	selView_user();
}
function _clearFilter(obj,num){
	if(num==1){
		$('#user_text').val('');
		$('#user_text_check').hide();
		search_user_n='';
		selView_user();
		return;
	}
	$('#clearFilter').next().children('ul').empty();
	$('#user_text').val('');
	$('#user_text_check').hide();
	$('#clearFilter').hide();
	search_user='';
	search_user_n='';
	selView_user();
}
function selView_user() {
	var $sel = $('#filterWW1');
	var len = $('li',$sel).length;

	if (len == 0) {
		$sel.hide();
		_waitDone($(".waitTip1"));
		$('#clearFilter').hide();
	} else if (len == 1) {
		$("#filterWW1").show();
		$('>span.ww', $sel).show();
		$('#clearFilter').show();
		$sel.addClass('selector-multiple');
	} else {
		$("#filterWW1").show();
		$('>span.ww', $sel).show();
		$sel.addClass('selector-multiple');
	}
	find_usergroup();
}

//返回第一个标红处
function scrollTop_check(){
	$('.c-cont').scrollTop(0);
	if(data_array_Path.length!=0){
		var top=9999;
		$.each(data_array_Path,function(i,item){
			if(item.Type==1){
				var top_item=$('#node-'+item.Id).offset().top;
				if(top_item<top){
					top=top_item;
				}
			}
			// else{
			// 	var Path_array=item.Path.split('/');
			// 	var len=Path_array.length;
			// 	$i_item=$('#node-'+Path_array[len-2].split(',')[1]).siblings('i.h-aicon');
			// 	var top_item=$i_item.siblings('ul').find('li').find('input[id=node-'+item.Id+']').eq(0).offset().top;
			// 	if(top_item<top){
			// 		top=top_item;
			// 	}
			// }
		});
		$('.c-cont').scrollTop(top+220);
	}
}
var authtype_data;
/*
function get_authtype_list(){
	$.ajax({
		url: "/bhost/get_authtype_list",
		type:"POST",
		async:false,
		data:{a0:sess},
		success:function(result){
			var authtype_result = JSON.parse(result);
			if (authtype_result.Result==true){
				authtype_list = authtype_result.info.data;
				authtype_data = authtype_list;
				$('#sys_u_authtype').empty();
				$('#sys_u_authtype').append('<option value="null" selected>默认</option>');
				var flag_pwd_default = 0;
				$(authtype_list).each(function(i,item){
					//查看是否存在 本地认证		0->包含本地认证 1->不包含本地认证 但是 包含 TOTP Logbase usbkey	2-> 不包含 0 1 的情况 5->只包含本地认证
					var flag_pwd = 0; 					
					var tmplist = [];
					$(item.Set).each(function(i1,item1){
						tmplist.push(item1.AuthMode);									
					})
					if(tmplist.indexOf(1) >=0){
						flag_pwd = 0;
						if(tmplist.length == 1) flag_pwd = 5;
					}else if(tmplist.length ==1 && tmplist.indexOf(8) >=0 ){
						flag_pwd = 3;
					}else if(tmplist.indexOf(8) >=0 || tmplist.indexOf(10) >=0){
						if(global_id >0 && user_item.SecretKey !=null && user_item.SecretKey !='' ){
							flag_pwd = 2;
						}else flag_pwd = 1;
					}else{
						flag_pwd = 2;
					}
					
					if(item.IsDefault == true){
						flag_pwd_default = flag_pwd;
					}
					$('#sys_u_authtype').append('<option flag_pwd='+flag_pwd+' value="'+item.AuthTypeId+'">'+item.AuthTypeName+'</option>');
				})
				$('#sys_u_authtype option').eq(0).attr('flag_pwd',flag_pwd_default);
				$('#sys_u_authtype').select2().trigger('change');
			}
		}
	})
}
*/

function BackUsermanage(){
	$(".container3").show();
	$(".container2").hide();
	$(".container1").hide();
	$(".container").hide();
	$(".container4").hide();
	$('div.btns').show();
	_initSize();
	_pathWrap();
}
	//-------------------------创建界面 JS
var user = {
	"LoginUserCode": '{{us}}',
	"UserId": 0,
	"UserCode": "",
	"UserName": "",
	"Password": "", 
	"Department": null, 
	"MobilePhone": null,
	"Email": null,
	"Description": null,
	"ExpireTimeEnabled": false,
	"ExpireTime": "", 
	"UserStatus": 1,
	"PhotoIcon": null,
	"CreatorId": 1,
	"ThirdUserCode": "",
	"ManageIPUnlimited": true,
	"SrcIPUnlimited": true,
	"AuthTypeId": null,
	//"TokenId": "",
	"LanCode": 0,
	"PwdApproveUserId": null,
	"LoginUniqueIP": false,
	"OldPassword":null,
	"AdminSet": [
	],
	"UGroupSet": [
	],
	"RoleSet": [
	],
	"ManageAuthSet": [
	],
	"SecretKey":null
};

var group = {
	"UGId": 0,
	"UGName": "",
	"Description": null,
	"ParentUGId": 0,
	"AdminSet": [
	]
}
var AccessAuthSet = {
	"UserId": 0, 
	"AccessAuthSet": [
	]
}
//----------------检查格式
var PwdStrategy;
function getPwdStrategy(){
	$.ajax({
		url:'/bhost/get_pwdstrategy',
		type:"POST",
		async:true,
		data:{a0:sess},
		success: function(Result) {
			data = JSON.parse(Result);
			PwdStrategy = data.info;
		}
	})
}
var current_id = '';
function list_initList() {
	if(first_grp=='0'){
		return 0;
    }
    if ($('.user_list_div table').height() > $('.user_list_div').height()) {
        $('#user_list thead tr th:last').width(160);
    } else {
        $('#user_list thead tr th:last').width(150);
    }
	$('#user_list_ td.in .input_checkbox').iCheck({
		checkboxClass: 'icheckbox_minimal-blue',
		radioClass: 'iradio_minimal-blue',
		increaseArea: '0' // optional
	});
	$('#user_list_').unbind();
	$('#user_list_ .input_checkbox').unbind();
	$('#user_list_all').unbind();
	tabArr_host_line();
	$('#user_list_ .input_checkbox').on("ifChecked", function (e) {
		//console.log('ifChecked');
		$(this).parents('td.in').find('div.c').addClass('on');
		if ($("#user_list_ tr input.input_checkbox:checked:enabled").length == $("#user_list_ tr input.input_checkbox:enabled").length) {
			$('#user_list_all').iCheck('check');
		}
	}).on("ifUnchecked", function (e) {
		//console.log('ifUnchecked');
		$(this).parents('td.in').find('div.c').removeClass('on');
		$('#user_list_all').iCheck('uncheck');
	});
	$('#user_list_all').on('ifClicked', function (e) {
		if (!$('#user_list_all').is(':checked')) {
			$("#user_list_ tr input.input_checkbox:enabled").iCheck('check');
		} else {
			$("#user_list_ tr input.input_checkbox:enabled").iCheck('uncheck');
		}

	});
	//tabArr();
	
	$('#user_list_').on("click", "tr",
		function (e) {
			x = e.target;
			switch (x.id) {
				case '_edit':
					{
						current_id = $(this).find('div.c').attr('id');
						edit();
					}
					break;
				case '_copy':
					{
						current_id = $(this).find('div.c').attr('id');
						copy(1);
					}
					break;
				case '_cut':
					{
						current_id = $(this).find('div.c').attr('id');
						cut(1);
					}
					break;
				case '_del':
					{
						current_id = $(this).find('div.c').attr('id');
						_delete(0,1);
					}
					break;
				case '_remove':
					{
						current_id = $(this).find('div.c').attr('id');
						_delete(1,1);
					}
                    break;
                case '_transfer':
                    {
                        current_id = $(this).find('div.c').attr('id');
                        _transfer(1);
                    }
                    break;
			}
		$('div.tab-moreinfo-on').remove();
		}
	).on('dblclick', 'tr',
		function (e) {
			x = e.target;
			if (x.nodeName != 'A' && x.nodeName != 'INS') {
				var tr_dbl_value = $(this).find('div.c').attr('id').split('-');
				var id = tr_dbl_value[1];
				var iid = tr_dbl_value[2];
				if (parent_id.indexOf('root') < 0) {
					if ($('#' + parent_id).prev().attr("class").indexOf('h-aicon-d') < 0) {
						$('#' + parent_id).prev().click();
					}
				}
				$('#node-' + id + '-' + iid).click();
				//$('#node-'+id).prev().trigger('click');
				if ($(this).find('td').eq(2).text()=='用户') { //双击 用户  编辑
					current_id = $(this).find('div.c').attr('id');
					edit();
				}
			}
			$('div.tab-moreinfo-on').remove();
		}
	);
}

function tabArr_host_line() {
	$('#user_list_').parent('table').unbind();
	var tout, tin;
	var $cloneItem;
	var z = false;

	$('#user_list_').parent('table').on('mouseover', 'tbody>tr', function () {
		document.onclick = null;
	}).on('mouseout', 'tbody>tr', function () {
		document.onclick = function () {
			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
		}
	}).on('click', 'tbody>tr', function (e) {

		x = e.target;
		if (x.id == 'del') {
			return false;
		}
		if (x.id == 'edit') {
			return false;
		}
		if (x.localName == 'a') {
			return false;
		}
		document.onclick = null;

		var $this = $(this);
		var $tr = $this;
		var oset = $tr.offset();

		var trc = $tr.attr('class');
		if (trc && trc.indexOf('on') >= 0) {
			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
			return;
		}

		$('div.tab-moreinfo-on').hide();
		$('tr.on').removeClass('on');
		$tr.addClass('on');
		var $box = $this.parents('div.box-table');
		var boxh = $box.height() - 40, boxo = $box.offset();
		var $this_trlast = $this.children('td:last');
		var $item = $this_trlast.children('div.tab-moreinfo');
		$item.remove();
		var $this_trfirst = $this.children('td:first');
        var hg_h_id = $this_trfirst.find('div.c').attr('id').split('-');
        //判断是否是用户 还是用户组
        var markText='';
		if ($this_trfirst.find('i').attr('class').indexOf('h-bicon-g') >= 0) {
            var hg_h_flag = 'group';
            $.ajax({
                url: "/bhost/get_ugroup",
                type: "POST",
                async: false,
                data: { a0: sess, a1: hg_h_id[2] },
                success: function (result) {
                    var ugroup_item = JSON.parse(result);
                    if (ugroup_item.Result == false) {
                        _alert(1, "用户管理", "获取用户组信息失败：" + ugroup_item.info[0]);
                        return false;
                    } else {
                        ugroup_item = ugroup_item.info[0];
                        if (ugroup_item.Description == null) {
                            ugroup_item.Description = "";
                        }
                        markText = "用户组名：" + ugroup_item.UGName + "<br>" +
                            "描述：" + ugroup_item.Description ;
                        
                    }
                }
            })
		} else {
            var hg_h_flag = 'user';
            $.ajax({
                url: "/bhost/get_user_list",
                type: "POST",
                async: false,
                data: { a0: sess, a1: hg_h_id[2] },
                success: function (result) {
                    var user_item = JSON.parse(result);
                    if (user_item.Result == false) {
                        _alert(1, "用户管理", "获取用户信息失败：" + user_item.info);
                        return false;
                    } else {
                        user_item = user_item.info;
                        if (user_item.Department == null) {
                            user_item.Department = "";
                        }
                        if (user_item.MobilePhone == null) {
                            user_item.MobilePhone = "";
                        }
                        if (user_item.Email == null) {
                            user_item.Email = "";
                        }
                        if (user_item.Description == null) {
                            user_item.Description = "";
                        }
                        var status_str;
                        switch (user_item.UserStatus) {
                            case 0:
                                status_str = "停用";
                                break;
                            case 1:
                                status_str = "启用";
                                break;
                            case 2:
                                status_str = "锁定";
                                break;
                            case 6:
                                status_str = "用户过期";
                                break;
                            case 7:
                                status_str = "临时用户";
                                break;
                            case 8:
                                status_str = "需要修改密码";
                                break;
                            case 9:
                                status_str = "密码过期";
                                break;
                        }
                        roleset_arr=[];
                        $.each(user_item.RoleSet,function(i,item){
                            roleset_arr.push(item.RoleName);
                        });
                        markText = "姓名：" + user_item.UserName + "<br>" +
                            "工号：" + (user_item.UserNumber || '') + "<br>" +
                            "角色："+roleset_arr.join(',') + '<br>' +
                            "部门：" + user_item.Department + "<br>" +
                            "手机：" + user_item.MobilePhone + "<br>" + 
                            "Email：" + user_item.Email + "<br>"+
                            "描述：" + user_item.Description + "<br>"+
                            "状态：" + status_str ;
                    }
                }
            })
        }
        var path = $(this).find('div.item').find('div.c').attr('value');
        if (filter_flag) markText = markText + "<br>路径：" + path;
		$this_trlast.append('<div class="tab-moreinfo" style="">' + markText + '</div>');
		$item = $this_trlast.children('div.tab-moreinfo');
		var ih = $item.outerHeight(), th = $tr.outerHeight();
		$cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');

		if (boxh < oset.top - boxo.top + ih + th - 40) {
			$cloneItem.css({
				top: oset.top - ih,
				left: oset.left,
				width: $tr.outerWidth() - 1,
				opacity: 0,
				display: 'block'
			}).stop().animate({
				opacity: 1
			});

			var iof = $cloneItem.offset().top + $cloneItem.outerHeight();
			var tof = $tr.offset().top;
			if (iof != tof) {
				$cloneItem.css('top', $tr.offset().top - $cloneItem.outerHeight());
			}
		} else {
			$cloneItem.css({
				top: oset.top + $tr.outerHeight() + 1,
				left: oset.left,
				width: $tr.outerWidth() - 1,
				opacity: 0,
				display: 'block'
			}).stop().animate({
				opacity: 1
			});
		}
    })
    $('.box-table,body,.c-cont2,.c-cont').off("scroll");
	$('.box-table,body,.c-cont2,.c-cont').on('scroll', function () {
		$('div.tab-moreinfo-on').remove();
		$('tr.on').removeClass('on');
	})
}
function list_or_ico() {
	
	first_grp = $('#first_grp').attr('value');
	if (first_grp == '0') {
		$('#hostContent').removeClass('h-content-list');
		$('#hostContent').empty();
	} 
	else {
		$('#hostContent').addClass('h-content-list');
		if ($('#hostContent .c-table').length == 0) {
			$('#hostContent').empty().html('<div class="c-table">' +
				'<div class="tab-t">' +
				'<div class="ctr" style="width: auto;">' +
				// '<a href="javascript:;" id="btn_1" class="btn btn-default" onclick="create_u();">创建用户</a>' +
				// '<a href="javascript:;" id="btn_2" class="btn btn-default" onclick="create_g()">创建用户组</a>' +
				'<a href="javascript:;" id="btn_6" class="btn btn-default" onclick="copy();">复制</a>' +
				'<a href="javascript:;" id="btn_7" class="btn btn-default" onclick="cut();">剪切</a>' +
				'<a href="javascript:;" id="btn_4" class="btn btn-default" onclick="paste();">粘贴</a>' +
				'<a href="javascript:;" id="btn_8" class="btn btn-default" onclick="_delete(0);">删除</a>' +
				'<a href="javascript:;" id="btn_9" class="btn btn-default" onclick="_delete(1);">移除</a>' +
				'<a href="javascript:;" id="btn_5" class="btn btn-default" onclick="refresh();">刷新</a>' +
				'</div>' +
				'</div>' +
				'<div class="box-table">' +
				'<table cellpadding="0" cellspacing="0" id="user_list">' +
				'<thead>' +
				'<tr>' +
				'<th style="width: 10px;"><input type="checkbox" class="form-checkbox" id="user_list_all" style=""></th>' +
				'<th style="">名称</th>' +
				'<th width="60">类型</th>' +
				'<th width="">管理员</th>' +
				'<th width="50">状态</th>' +
				'<th width="160"></th>' +
				'</tr>' +
				'</thead>' +
				'</table>' +
				'</div>' +
				'<div class="box-table user_list_div" style="overflow: auto; margin-top: -1px;">' +
				'<table cellpadding="0" cellspacing="0">' +
				'<tbody id="user_list_">' +
				'</tbody>' +
				'</table>' +
				'</div>' +
				'</div>');
			$('#user_list_all').iCheck({
				checkboxClass: 'icheckbox_minimal-blue',
				radioClass: 'iradio_minimal-blue',
				increaseArea: '0' // optional
			});

		}
		else {
			$('#user_list_').empty();
		}
		
		$('#user_list_all').iCheck('uncheck');
	}
	$('#btn_1').show();
	$('#btn_2').show();
	$('#btn_4').show();
	$('#btn_5').show();
	$('#btn_6').show();
	$('#btn_7').show();
	$('#btn_8').show();
	$('#btn_9').show();
	//console.log(filter_flag);
	if (filter_flag) {
		$('#btn_1').hide();
		$('#btn_2').hide();
		$('#btn_4').hide();
	} else if (copy_flag == 1) {

	} else if (copy_flag == 0) {
		$('#btn_4').hide();
	}
	if (if_disable == '1') {
		$('#btn_1').remove();
		$('#btn_2').remove();
		$('#btn_4').remove();
		$('#btn_6').remove();
		$('#btn_7').remove();
		$('#btn_8').remove();
		$('#btn_9').remove();
	}
	var $parent_item = $("#route-root").next().children().last();
	// if ($("#route-root").next().children().last().length == 0) {
	// 	parent_id = 'route-root';
	// } else {
	// 	var parent_id_arr = $parent_item.attr('id').split('-');
	// 	parent_id = 'node-' + parent_id_arr[1] + '-' + parent_id_arr[2];
	// }
	//console.log(parent_id);
	if (parent_id == 'node-0-1') {		//未分组下
		$('#btn_2').hide();
		$('#btn_6').hide();
		$('#btn_4').hide();
		$('#btn_9').hide();
	} else if (parent_id == 'route-root' || parent_id == '') {		//所有组下
		$('#btn_1').hide();
		$("#btn_4").hide();
		$('#btn_9').hide();
	}
	_initSize();
}
function changepwdsta(){
	$("#sys_u_pwd_new").attr("type","password");
	$("#sys_u_pwd_tr").attr("type","password");
}
//生成密码
function create_pwd(){
	$("#sys_u_pwd_new").val("");
	$("#sys_u_pwd_tr").val("");
	$("#sys_u_pwd_new").attr("type","text");
	$("#sys_u_pwd_tr").attr("type","text");	
	var length = 0;
	var chars = '';
	var len = 0;
	var pw='';
	if(PwdStrategy.PwdMinLen){
		length = PwdStrategy.PwdMinLen;
	}else{
		length = 6;	
	}
	if(PwdStrategy.IfPwdComplex){
		if(PwdStrategy.IfPwdIncLowerApha){
			len ++;
			chars += 'abcdefghijklmnopqrstuvwxyz';
			var str = 'abcdefghijklmnopqrstuvwxyz';
			pw += str[Math.floor(Math.random() * str.length)];
		};
		if(PwdStrategy.IfPwdIncUpperApha){
			len ++;
			chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			var str = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			pw += str[Math.floor(Math.random() * str.length)];
		};
		if(PwdStrategy.IfPwdIncNumber){
			len ++;
			chars += '0123456789';
			var str = '0123456789';
			pw += str[Math.floor(Math.random() * str.length)];
		};
		if(PwdStrategy.IfPwdIncSpecialChar){
			len ++;
			chars += '!#$%&*+-=?@^_~';
			var str = '!#$%&*+-=?@^_~';
			pw += str[Math.floor(Math.random() * str.length)];
		}
	}else{
		chars += 'abcdefghijklmnopqrstuvwxyz';
		chars += '0123456789';
	}
	
	chars = chars.split('');
	for(var i = 0; i < length-len; i++)
		pw += chars[Math.floor(Math.random() * chars.length)];
	
	pw = pw.split('');
	pw.sort(function(){return Math.random()>0.5?-1:1;});
 	pw = pw.join('');
	
	$("#sys_u_pwd_new").val(pw);
	$("#sys_u_pwd_tr").val(pw);
}

function dataCheck(obj, min, max){
	obj.value = obj.value.replace(/\D/g, "");
	if(min){
		if(parseInt(obj.value, 10) < parseInt(min, 10)) obj.value = min;
	}
	if(max){
		if(parseInt(obj.value, 10) > parseInt(max, 10)) obj.value = max;
	}
}
function nameCheck(obj){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check');

	if(nameReg.test(val)){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}

function IDCheck(obj){
	var IDReg = /^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check');

	if(IDReg.test(val) && val.length > 1){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}

function phoneCheck(obj){
	var phoneReg = /^[0-9]{11}$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check')

	if(phoneReg.test(val) || val == ""){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}
function emailCheck(obj){
	var emailReg = /^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/;
	var val = $(obj).val();
	var $i = $(obj).next('i.v-check')

	if(emailReg.test(val) || val == ""){
		$i.show().attr('class','v-check v-right');
	}else{
		$i.show().attr('class','v-check v-wrong');
	}
}
//-----------------------
//提交数据
function _compare_ip(x,y){
	var ip1 = x.split('.');
	var ip2 = y.split('.');
	var i1 = 0;
	var ip1_str = "";
	var ip2_str = "";
	for (var i1 = 0; i1 < 4; i1++){
		if (ip1[i1] < 10){
			ip1[i1] = "00"+ip1[i1];
		}else if (ip1[i1] < 100){
			ip1[i1] = "0"+ip1[i1];
		}else{
			
		}
		ip1_str = ip1_str + ip1[i1];
		if (ip2[i1] < 10){
			ip2[i1] = "00"+ip2[i1];
		}else if (ip2[i1] < 100){
			ip2[i1] = "0"+ip2[i1];
		}else{
			
		}
		ip2_str = ip2_str + ip2[i1];
	}
	if (ip1_str == ip2_str){
		return 3;
	}else if (ip1_str > ip2_str){
		return 2
	}else{
		return 3;
	}
}

function _compare_ip(x,y){
	var ip1 = x.split('.');
	var ip2 = y.split('.');
	var i1 = 0;
	var ip1_str = "";
	var ip2_str = "";
	for (var i1 = 0; i1 < 4; i1++){
		if (ip1[i1] < 10){
			ip1[i1] = "00"+ip1[i1];
		}else if (ip1[i1] < 100){
			ip1[i1] = "0"+ip1[i1];
		}else{
			
		}
		ip1_str = ip1_str + ip1[i1];
		if (ip2[i1] < 10){
			ip2[i1] = "00"+ip2[i1];
		}else if (ip2[i1] < 100){
			ip2[i1] = "0"+ip2[i1];
		}else{
			
		}
		ip2_str = ip2_str + ip2[i1];
	}
	if (ip1_str == ip2_str){
		return 3;
	}else if (ip1_str > ip2_str){
		return 2
	}else{
		return 3;
	}
}


//提交数据
var AccessSet;
var repeat;
function savedata(){
	var IDReg = /^[a-zA-Z0-9_.-]+[a-zA-Z0-9_.-]$/;
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var UserNumberReg = /^[a-zA-Z\d_]+$/;
	var phoneReg = /^[0-9]{11}$/;
	var emailReg = /^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9_\-])+\.)+([a-zA-Z0-9])+$/;
	var sys_u_name = $("#sys_u_name").val();
	var UserNumber = $("#UserNumber").val().trim();
	var user_name = $("#user_name").val();
	var thirduser = $("#thirduser").val();
	var sys_u_depart = $("#sys_u_depart").val();
	var sys_u_phone = $("#sys_u_phone").val();
	var sys_u_email = $("#sys_u_email").val();
	var sys_u_descr = $("#sys_u_descr").val();
	//var sys_u_authtype = $("#sys_u_authtype").val();
	sys_u_authtype = global_auth == -1 ? null:global_auth;
	var timeSet = $("#timeSet").val();
	var date = $("#datepicker").val();
	var hour = $("#shour").val();
	var min = $("#smin").val();
	var sec = $("#ssec").val();
	var bdiusr = $("#bdiusr").val();
	var manaip = $("#manaip").val();
	var iplimited = $("#iplimited").val();
	var pwdApproveUserId = $("#pu_id").val();

	if(sys_u_name == ""){
		_alert(2,"系统用户","请输入账号",$('#sys_u_name'));
		return false;
	}
	if(!IDReg.test(sys_u_name)){
		_alert(1,"系统用户","账号格式不正确",$('#sys_u_name'));
		return false;
	}
	if(user_name == ""){
		_alert(2,"系统用户","请输入姓名",$('#user_name'));
		return false;
	}
	if(!nameReg.test(user_name)){
		_alert(1,"系统用户","姓名格式不正确",$('#user_name'));
		return false;
	}
	if(UserNumber != "" && !UserNumberReg.test(UserNumber)){
		_alert(1,"系统用户","工号不正确",$('#UserNumber'));
		return false;
	}else if(UserNumber==''){
		UserNumber=null;
	}
	
	

	if(flag == 0){          //创建
		user.UserId = 0;
		user.MonitorBGColor = 2;
		UGroupSet = [{"UGId": global_pid}];
		var sys_u_pwd_new = $("#sys_u_pwd_new").val();
		var sys_u_pwd_tr = $("#sys_u_pwd_tr").val();
		if(sys_u_pwd_new == "" && $('#sys_u_pwd_new').attr('disabled') != 'disabled' ){
			_alert(2,"系统用户","请输入"+$("#span_pwd").html().replace('&nbsp;&nbsp;',''),$('#sys_u_pwd_new'));
			return false;
		}
		if(sys_u_pwd_new != sys_u_pwd_tr){
			_alert(2,"用户管理","两次密码不匹配",$('#sys_u_pwd_new'));
			return false;
		}
		if($("#changepin_div1").is(':visible') == true && $('#select_pin').val() == '1'){
		
		}else{
			if (!PwdStrategy.PwdMinLen) PwdStrategy.PwdMinLen = 6;
			if(sys_u_pwd_new.length<PwdStrategy.PwdMinLen && $('#sys_u_pwd_new').attr('disabled') != 'disabled'){
				_alert(1,"系统用户","密码长度必须大于或等于"+PwdStrategy.PwdMinLen+"位",$('#sys_u_pwd_new'));
				return false;
			}
			if(sys_u_pwd_new.length > 64){
				_alert(2, "系统用户", "密码不能超过系统限定64位", $("#sys_u_pwd_new"));
				return false;
			}
			if(PwdStrategy.IfPwdComplex && $('#sys_u_pwd_new').attr('disabled') != 'disabled' ){
				if(PwdStrategy.IfPwdIncLowerApha){
					var now=sys_u_pwd_new.search(/[a-z]/);
					if(now==-1){_alert(1,"系统用户","密码中请包含小写字母",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncUpperApha){
					var now=sys_u_pwd_new.search(/[A-Z]/);
					if(now==-1){_alert(1,"系统	用户","密码中请包含大写字母",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncNumber){
					var now=sys_u_pwd_new.search(/[0-9]/);
					if(now==-1){_alert(1,"系统用户","密码中请包含数字",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncSpecialChar){
					var now=sys_u_pwd_new.search(/[^A-Za-z0-9]/);
					if(now==-1){_alert(1,"系统用户","密码中请包特殊字符",$('#sys_u_pwd_new'));return false;}
				}
			}
		}
		//设置密码情况下 存在未配置的认证配置时 提示录入或者设置pin
		if($("#select_local").val() == 1 && $('#sys_u_pwd_new').attr('disabled') != 'disabled'){
			if($("#changepin_div").find("text").is(":visible") && $("#changepin_div").find("text").text() == "未配置"){
				_alert(2,"用户管理","请设置Pin码");
				return false;
			}
			if($("#FinP_reset_div").find("text").is(":visible") && $("#FinP_reset_div").find("text").text() == "未录入"){
				_alert(2,"用户管理","请录入指纹");
				return false;
			}
		}

		user_Password = "";
		AccessSet = {
			"UserId": 0, 
			"AccessAuthSet": [
			]
		}
		var ManageAuthSet = [
				{
				"ManageAuthId": 0,
				"ManageScopeMode": 2,
				"UserSet": [
				    {
							"Id": 0, 
							"Type": 1
				    }
				],
				"MScopeSet": [],
				"CScopeSet": [],
			}
		];
	}
	
	if(flag == 1){				//编辑
		user.UserId = parseInt(global_id);
		UGroupSet = user_ugroup;
		var sys_u_pwd_new = $("#sys_u_pwd_new").val();
		var sys_u_pwd_tr = $("#sys_u_pwd_tr").val();			
		if(sys_u_pwd_new ==  sys_u_pwd_tr && sys_u_pwd_new == ""){
			if(user_Password !='') 
				sys_u_pwd_new = user_Password;
			else{
				if($('#sys_u_pwd_new').attr('disabled') != 'disabled'){
					_alert(2,"系统用户","请输入"+$("#span_pwd").html().replace('&nbsp;&nbsp;','').replace(' ',''),$('#sys_u_pwd_new'));
					return false;
				}else{
					sys_u_pwd_new = user_Password;
				}
			}
		}else if(sys_u_pwd_new != "" && sys_u_pwd_tr!= "" && sys_u_pwd_new == sys_u_pwd_tr){
			sys_u_pwd_new = $("#sys_u_pwd_new").val();

			if (!PwdStrategy.PwdMinLen) PwdStrategy.PwdMinLen = 6;
			if(sys_u_pwd_new.length<PwdStrategy.PwdMinLen){
				_alert(1,"系统用户","密码长度必须大于或等于"+PwdStrategy.PwdMinLen+"位",$('#sys_u_pwd_new'));
				return false;
			}
			if(PwdStrategy.IfPwdComplex){
				if(PwdStrategy.IfPwdIncLowerApha){
					var now=sys_u_pwd_new.search(/[a-z]/);
					if(now==-1){_alert(1,"系统用户","密码中请包含小写字母",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncUpperApha){
					var now=sys_u_pwd_new.search(/[A-Z]/);
					if(now==-1){_alert(1,"系统	用户","密码中请包含大写字母",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncNumber){
					var now=sys_u_pwd_new.search(/[0-9]/);
					if(now==-1){_alert(1,"系统用户","密码中请包含数字",$('#sys_u_pwd_new'));return false;}
				}
				if(PwdStrategy.IfPwdIncSpecialChar){
					var now=sys_u_pwd_new.search(/[^A-Za-z0-9]/);
					if(now==-1){_alert(1,"系统用户","密码中请包特殊字符",$('#sys_u_pwd_new'));return false;}
				}
			}
		}else{
			_alert(1,"用户管理","两次密码不匹配",$('#sys_u_pwd_new'));
			return false;
		}
		// if (new_pin == "" && $("#changepin_div1").is(':visible') == true && $('#select_pin').val() == '1' ){
		// 	_alert(2,"用户管理","请输入PIN码");
		// 	return false;
		// }
		//判断存在未配置的认证配置时 提示录入或者设置pin
		if($("#changepin_div").find("text").is(":visible") && $("#changepin_div").find("text").text() == "未配置"){
			_alert(2,"用户管理","请设置Pin码");
			return false;
		}
		if($("#FinP_reset_div").find("text").is(":visible") && $("#FinP_reset_div").find("text").text() == "未录入"){
			_alert(2,"用户管理","请录入指纹");
			return false;
		}

		AccessSet = {
			"UserId": global_pid, 
			"AccessAuthSet": [
			]
		}
		var ManageAuthSet = [
			{
				"ManageAuthId": 0,
				"ManageScopeMode": 2,
				"UserSet": [
			    {
						"Id": global_id,
						"Type": 1
			    }
				],
				"MScopeSet": [],
				"CScopeSet": [],
			}
		];
		user.OldPassword = user_item.OldPassword;
	}
	
	if($('#phone_em').is(':hidden') ==false){
		if(sys_u_phone == ''){
			_alert(1,"系统用户","请输入手机",$('#sys_u_phone'));
			return false;
		}
	}
	if(!phoneReg.test(sys_u_phone) && sys_u_phone != ""){
		_alert(1,"系统用户","手机格式不正确",$('#sys_u_phone'));
		return false;
	}
	
	
	if(!phoneReg.test(sys_u_phone) && sys_u_phone != ""){
		_alert(1,"用户管理","手机格式不正确",$('#sys_u_phone'));
		return false;
	}
		
	if($('#mail_em').is(':hidden') ==false){
		if(sys_u_email == ''){
			_alert(1,"用户管理","请输入邮箱",$('#sys_u_email'));
			return false;
		}
	}
	
	if(!emailReg.test(sys_u_email) && sys_u_email != ""){
		_alert(1,"用户管理","邮箱格式不正确",$('#sys_u_email'));
		return false;
	}
	if($("#ti").is(':visible') == true && $("#ti").val() == -1){
		_alert(1,"用户管理","请选择令牌");
		return false;		
	}
	if(flag == 0){
		//是否是 继承用户
		if($('#action_div').children().find('.form-label').eq(1).children().prop("class") == 'iradio_minimal-blue checked'){ //继承用户
			if($('#user_tranfer').val() == ""){
				_alert(2,"用户管理","请选择要继承的用户");
				return false;
			}
			user.UserCode = sys_u_name;
			user.UserName = user_name;
			user.Password = sys_u_pwd_new;
			user.Department = sys_u_depart;
			user.MobilePhone = sys_u_phone;
			user.Email = sys_u_email;
			user.Description = sys_u_descr;
			user.AuthTypeId = (sys_u_authtype == 'null'?null:sys_u_authtype);
			var msstr = aceg(JSON.stringify(user),sess);
			$.ajax({
				url:'/bhost/TransferAuthority',
				type:"POST",
				async:false,
				data:{a0:sess,a1:JSON.stringify(user),a2:$('#user_tranfer').val(),a3:true,a10:"运维管理>用户管理",m1:msstr},
				//contentType: 'application/json',
				success: function(Result) {
					data = JSON.parse(Result);
					if (data.Result){
						layer.open({
							type:1,
							title:"用户管理",
							content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:'确&nbsp;&nbsp;定',
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							btn1:function(i){
								layer.close(i);
								BackUsermanage();
							}
						});
						refresh();
						return false;
					}
					else{
						_alert(1,"用户管理",'保存失败 原因：'+data.ErrMsg);
					}
				}
			})
			return false;
		}
	}

	var RoleSet = [];
	var AdminSet = [];
	
	role_id_tmp = $('#select_r_xselect').data('value')
	if(role_id_tmp != -1 && role_id_tmp!=undefined ){
		var admin = '{"RoleId":'+role_id_tmp+'}';
		admin = JSON.parse(admin);
		RoleSet.push(admin);
	}
	$('#role_div li.item').each(function(i,item){
		var admin = '{"RoleId":'+$(this).attr('id')+'}';
		admin = JSON.parse(admin);
		RoleSet.push(admin);
	})
	
	/*
	$.each(role_arry,function(i,item){
		if (item != '-1'){
			var role = '{"RoleId":'+item+'}';
			role = JSON.parse(role);
			RoleSet.push(role);
		}
	});*/
	if(RoleSet.length == 0){
		_alert(2,"用户管理","请添加角色");
		return false;
	}
	/*
	$.each(user_arry,function(i,item){
		if (item != '-1'){
			var admin = '{"AdminId":'+item+'}';
			admin = JSON.parse(admin);
			AdminSet.push(admin);
		}
	});*/
	$('#select_u select').each(function(i,item){
		if($(this).val() == -1) return false;
		var admin = '{"AdminId":'+$(this).val()+'}';
		admin = JSON.parse(admin);
		AdminSet.push(admin);
	})
	$('#select_u li.item').each(function(i,item){
		var admin = '{"AdminId":'+$(this).attr('id')+'}';
		admin = JSON.parse(admin);
		AdminSet.push(admin);
	})
	
	
	if(AdminSet.length == 0){
		_alert(2,"用户管理","请添加管理员");
	 	return false;
	 }

	$.each(auth_arry,function(i,item){
		if (item != '-1'){
			var auth = '{"AccessAuthId":'+item+'}';
			auth = JSON.parse(auth);
			AccessSet.AccessAuthSet.push(auth);
		}
	});
	if(thirduser != "" ){
		if(!IDReg.test(thirduser) || thirduser.length == 1){
			_alert(1,"用户管理","第三方认证账号格式错误");
			return false;
		}
	}
	if($("#timeSet").prop("checked") == true){
		timeSet = true;
	}
	else{
		timeSet = false;
	}
	bdiusr = false;
	manaip = false; 	
	time = date+" "+hour+":"+min+":"+sec;
	if(date==""||hour==""||min==""||sec=="") time = "";
	if (time == "" && $("#timeSet").prop("checked")){
		_alert(2,"用户管理","请输入完整时间",$('#datepicker'));
		return false;
	}
	iplimited = true;

	// p = $(".sitem:first").children("i");
	IPList = {"IPSetId":0,"Set":[]};
	MACList = {"MACSetId":0,"Set":[]};
	CScopeSet =[];
	var flag_ip_mac = 0;
	$.each($("#Temp4").find('i'),function(i,item){
		var m = $(item).parent().find('input').not('input:hidden').val();
		if(i == 0 && m == ""){
			return true;		
		}else{
			var obj = $(item);
			var type = $(obj).parent().children('select').find('option:selected').val();
			
			var add = 0;
			if (type == 1 || type == 2){
				if (type == 2){
					var start_ip = $(obj).parent().find('input').not('input:hidden').eq(0).val();
					var end_ip = $(obj).parent().find('input').not('input:hidden').eq(1).val();
					if (start_ip == "" && i != 0 && end_ip != ""){
						_alert(2,"用户管理","请输入起始IP地址",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (end_ip == "" && start_ip != ""){
						_alert(2,"用户管理","请输入终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					if (!ipcheck_route.test(start_ip)){
						_alert(1,"用户管理","起始IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (!ipcheck_route.test(end_ip)){
						_alert(1,"用户管理","终止IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					var a = _compare_ip(start_ip,end_ip);
					if (a != 3){
						_alert(2,"用户管理","起始IP地址不能大于或等于终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view2').not('.set-view.set-view2:hidden').each(function(i,item){
						if ($(item).find('input').not('input:hidden').eq(0).val() == start_ip && $(item).find('input').not('input:hidden').eq(1).val() == end_ip){
							add = 1;
							_alert(1,"用户管理","已存在相同IP区间",$(obj).parent().find('input').not('input:hidden').eq(0));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(1,start_ip,end_ip);
				}else{
					var start_ip = $(obj).parent().find('input').not('input:hidden').val();
					var end_ip = start_ip;
					if (start_ip == "" && i != 0){
						_alert(2,"用户管理","请输入IP地址",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					if (!ipcheck_route.test(start_ip)){
						_alert(1,"用户管理","IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view4').not('.set-view.set-view4:hidden').each(function(i,item){
						if ($(item).find('input').not('input:hidden').val() == start_ip){
							add = 1;
							_alert(1,"用户管理","已存在相同IP地址",$(obj).parent().find('input').not('input:hidden'));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(1,start_ip,end_ip);
				}
			}else{
				if (type == 3 ){
					var mac_input = $(obj).parent().find('input').not('input:hidden').val().trim();
					if (mac_input == "" && i != 0){
						_alert(2,"用户管理","请输入MAC地址",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					if (!MACReg.test(mac_input)){
						_alert(1,"用户管理","MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden'));
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view3').not('.set-view.set-view3:hidden').each(function(i,item){
						if (mac_input == $(item).find('input').not('input:hidden').val().trim()){
							add = 1;
							_alert(1,"用户管理","该MAC地址已存在",$(obj).parent().find('input').not('input:hidden'));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(2,mac_input,mac_input);
				}else if(type == 4){
					var start_mac = $(obj).parent().find('input').not('input:hidden').eq(0).val().trim();
					var end_mac = $(obj).parent().find('input').not('input:hidden').eq(1).val().trim();
					if (start_mac == "" && i != 0 && end_mac != ""){
						add = 1;
						_alert(2,"用户管理","请输入起始MAC地址",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (end_mac == "" && i != 0 && start_mac != ""){
						add = 1;
						_alert(2,"用户管理","请输入终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					if (!MACReg.test(start_mac)){
						add = 1;
						_alert(1,"用户管理","起始MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
						flag_ip_mac = 1;
						return false;
					}
					if (!MACReg.test(end_mac)){
						add = 1;
						_alert(1,"用户管理","终止MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					var a = _compare_mac(start_mac,end_mac);
					if (a != 3){
						add = 1;
						_alert(1,"用户管理","起始MAC地址不能大于或等于终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
						flag_ip_mac = 1;
						return false;
					}
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					$(obj).parent().siblings().find('.set-view.set-view5').not('.set-view.set-view5:hidden').each(function(i,item){
						if (start_mac == $(item).find('input').not('input:hidden').eq(0).val().trim() && end_mac == $(item).find('input').not('input:hidden').eq(1).val().trim()){
							add = 1;
							_alert(1,"用户管理","该MAC地址区间已存在",$(obj).parent().find('input').not('input:hidden').eq(0));
							flag_ip_mac = 1;
							return false;
						}
					});
					if (add == 1){
						flag_ip_mac = 1;
						return false;
					}
					save_mana_set(2,start_mac,end_mac);
				}else if(type == 5){
					var accset;
					if(i == 0){
						if($("#client_list").is(":visible")){
							if($("#accset").data('value') == undefined || $("#accset").data('value') == '-1'){
								return true;
							}else{
								accset = $("#accset").data('value');
							}
						}
					}else{
						if($(obj).parent().attr('auth_id') !=undefined) return true;
						accset = $(obj).parent().attr('id');						
					}
					if (client_list.indexOf(accset) == -1){
						client_list.push(accset);
					}
					save_mana_set(3,accset,accset); 
				}
			}
			// var $H = temp4.clone().wrap("<div class='sitem' _auth_data=\"\"></div>");
			// $(obj).parent().children('select').attr('id','');
			// $('.select2',$H).select2({minimumResultsForSearch: -1});
			// $(obj).parent().before($H);
			// // $(obj).parent().find('select').attr("disabled",true);
			// // $(obj).parent().find('input').attr("disabled",true);
			// // $(obj).parent().find('span.select2-selection--single').css("background-color","rgb(235, 235, 228)");
			// $(obj).parent().find('span.select2-selection__arrow').remove();
			// $H.children('select:last').trigger('change');
			// $(obj).after('<i class="ctrl del" onclick="_del(this)" style="bottom: 30px;margin-left: 115px"></i>').remove();

			// _autoHeight();
		}	
	})
	if(flag_ip_mac != 0){
		return false;
	}
	List2 = {
	  "ClientScopeId": 0,
	  "Type": 2, 
	  "IPList": {},
	  "MACList": {}
	};
	if(!$.isEmptyObject(IPList.Set)){
		List2.IPList = IPList;
	}
	if(!$.isEmptyObject(MACList.Set)){
		List2.MACList = MACList;
	}
	ManageAuthSet[0].CScopeSet = CScopeSet;
	//ManageAuthSet[0].MScopeSet = edit_MScopeSet;
	user.ManageAuthSet = ManageAuthSet;
	if($.inArray(List2,CScopeSet) == -1){
		if(List2.ClientScopeId != 0 || !$.isEmptyObject(List2.IPList) || !$.isEmptyObject(List2.MACList)){
			CScopeSet.push(List2);
			ManageAuthSet[0].CScopeSet = CScopeSet;
			user.ManageAuthSet = ManageAuthSet;
		}
		// if(user_item.ManageAuthSet == null || user_item.ManageAuthSet.length == 0){
		// 	iplimited = false;
		// 	user_item.ManageAuthSet = null;
		// }else{
		// 	iplimited = true;
		// }
		//保存 用户组
		
		//
	}
	if(user.ManageAuthSet[0].MScopeSet == "" && user.ManageAuthSet[0].CScopeSet == ""){
		user.ManageAuthSet = null;
	}
	var UGroupSet = [];
	
	$('#userTree li').each(function(){ 
		if($(this).children('input').next().attr('class').indexOf("checked") > -1){
			ugid = $(this).children('input').attr('id').split('-')[1];
			UGroupSet.push(JSON.parse('{"UGId":'+ugid+'}'));
		}
	})

	if($("#timeSet").prop("checked") == false)  time='';
	sys_u_name = sys_u_name.toLowerCase();
	user.LoginUserCode = '{{us}}';
	user.UserCode = sys_u_name;
	user.UserName = user_name;
	user.UserNumber=UserNumber;
	user.Password = sys_u_pwd_new;
	user.Department = sys_u_depart;
	user.MobilePhone = sys_u_phone;
	user.Email = sys_u_email;
	user.Description = sys_u_descr;
	user.ExpireTimeEnabled = timeSet;
	user.ExpireTime = time;
	if(thirduser == "") thirduser = sys_u_name;
	user.ThirdUserCode = thirduser;
	user.IsBuildinUser = bdiusr;
	user.ManageIPUnlimited = true;
	user.SrcIPUnlimited = iplimited;
	user.AuthTypeId = (sys_u_authtype == 'null'?null:sys_u_authtype);
	user.AdminSet = AdminSet;
	user.RoleSet = RoleSet;
	user.PhotoIcon = photo;
	user.PwdApproveUserId = (pwdApproveUserId =="0"?null:pwdApproveUserId);
	user.UserStatus = $("#status").prop('checked') == true? 1 :0;
	user.LoginUniqueIP = $("#uniqueIP").prop('checked');	
	user.UGroupSet = UGroupSet;
	if($("#ti").is(':visible') == true){
		user.TokenId = $("#ti").val();
	}else{
		user.TokenId = null;
	}
	//return false;
	repeat = 0;
	if(PwdStrategy.IfPwdUnRepeat){
		repeat = PwdStrategy.PwdUnRepeat;
	}else{
		repeat = 0;
	}
	var test_qrcode_flag = 0;
	if(global_id >0)
		user.SecretKey = user_item.SecretKey;
	else user.SecretKey = null;
	/*
	if ($("#totp_checkbox").next('span').attr('class') == "checkbox checked"){
		user.SecretKey = secret;
	}else{
		user.SecretKey = null;
	}
	*/
	if(new_pin !='' && $("#changepin_div1").is(':visible') == true && $('#select_pin').val() == '1' && flag == 0 ) user.SecretKey=new_pin;
	else if($('#span_pwd').text() != '初始密码' && flag == 0 ) user.SecretKey=sys_u_pwd_new;
	if(user.SecretKey == null && $("#sys_u_pwd_new").prop('disabled') == true){
		user.SecretKey = "";
	}
	loginusercode = window.parent.document.frm.us.value;
	//
	if($("#CertCn").is(':visible') == true) {
		if($('#CertCn').val() == ''){
			_alert(1,"系统用户","请输入认证唯一标识",$('#CertCn'));
			return false;
		}
		user.CertCn = $('#CertCn').val();
		
	}
	else user.CertCn = '';
	
	if (test_qrcode_flag == 0){
		var msstr = aceg(JSON.stringify(user),sess);
		var msstr1 = aceg(JSON.stringify(AccessSet),sess);
		if($("#setFinP").is(":visible") != true){
			FP_TMP == "";
		}
		$.ajax({
			url:'/bhost/add_sys_user',
			type:"POST",
			async:false,
			data:{a0:sess,a1:JSON.stringify(user),a2:JSON.stringify(AccessSet),a3:user_Password,a4:repeat,a5:new_pin,a7:FP_TMP,a10:"运维管理>用户管理",m1:msstr,m2:msstr1},
			//contentType: 'application/json',
			success: function(Result) {
				data = JSON.parse(Result);
				if (data.Result){
					if(new_pin !='' && (($("#changepin_div1").is(':visible') == true && $('#select_pin').val() == '1') || $('#changePIN').is(':visible') == true)){
						try{
							sesstime = new Date().getTime()-1;
							cmd_json ={
								"type":"SetUser",
								"sesstime": sesstime,//毫秒
								"UrlIp":document.domain+ (location.port!=''?':'+location.port:''),
								"IfUsbkey":true,
								"certInfo":'',
								"crlInfo":'',
								"bhuser":$('#sys_u_name').val(),
								"password":new_pin
							}
							client_request(cmd_json,'SetUser',data.UserId,sesstime,data.Content);
						}catch(e){
							_alert(1,"系统用户",'pin码保存失败' +e);
							$.ajax({
								url:"/bhost/delete_user_list_u",
								type:"POST",
								async:false,
								data:{a0:sess,a1:loginusercode,a2:data.UserId},
								success:function(result){
								}
							})
						}
					}else{
						layer.open({
							type:1,
							title:"用户管理",
							content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
							btn:'确&nbsp;&nbsp;定',
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							btn1:function(i){
								layer.close(i);
								BackUsermanage();
								refresh();
								return false;
							}
						});
					}
				}else{
					if(data.Content == null){
						_alert(1,"系统用户",'保存失败 原因：'+data.ErrMsg);
					}else{
						_alert(1,"系统用户",'pin码保存失败');
					}
				}
			}
		})
	}
}

var AccessSet_g;
function save_g(){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var name = $("#ug_n").val();
	var des = $("#ug_des").val();
	var pid = global_pid;
	var AdminSet = [];
	$.each(ug_arry,function(i,item){
		if (item != '-1'){
			var role = '{"AdminId":'+item+'}';
			role = JSON.parse(role);
			AdminSet.push(role);
		}
	});
	if(AdminSet.length == 0){
		_alert(2,"用户管理","请添加管理员");
	 	return false;
	 }
	if(!nameReg.test(name)){
		_alert(1,"用户管理","名称格式不正确",$('#ug_n'));
		return false;
	}
	if(name == ""){
		_alert(2,"用户管理","请输入用户组名称",$('#ug_n'));
		return false;
	}	

	if(flag == 0){
		group.UGId = 0;
	}
	if(flag == 1){
		group.UGId = global_id;			
	}
	AdminSet_tmp = [];
	AccessSet_g = {
		"UGId": 0, 
		"AccessAuthSet": [
		]
	}
	select_tmp = $('#select_ug option:selected').text();
	AdminSet_tmp.push(select_tmp);
	$('#select_ug li.item input').each(function(i,item){
		var admin = $(this).val();
		AdminSet_tmp.push(admin);
	})
	loginusercode = window.parent.document.frm.us.value;
	var flag_admin = false;
	if(AdminSet_tmp.indexOf(loginusercode) <0){
		flag_admin =true;
	}
	if($('.container2').find('.form.form1').children('.form-item').eq(2).is(':visible')){
		$.each(auth_arry_g,function(i,item){
			if (item != '-1'){
				var auth = '{"AccessAuthId":'+item+'}';
				auth = JSON.parse(auth);
				AccessSet_g.AccessAuthSet.push(auth);
			}
		});
	}
	group.UGName = name;
	group.Description = des;
	group.ParentUGId = pid;
	group.AdminSet = AdminSet;
	var msstr = aceg(JSON.stringify(group),sess);
	var msstr1 = aceg(JSON.stringify(AccessSet_g),sess);
	$.ajax({
		url:'/bhost/save_ugroup_list',
		type:"POST",
		async:false,
		data:{a0:sess,a1:JSON.stringify(group),a2:JSON.stringify(AccessSet_g),a10:"运维管理>用户管理",m1:msstr,m2:msstr1},
		success: function(Result) {
			data = JSON.parse(Result);
			if (data.Result){
				_alert(0,"用户管理",'操作成功');
				$(".container3").show();
				$(".container2").hide();
				/////////////////------------------------>刷新改动————————
				if(group.UGId == 0){
					if(pid == 0){
						$("#route-root").click();
						// refresh();
						var new_Gid = 'cnode-'+pid+'-'+data.UGId;
						if($("#"+new_Gid+"").length != 0){
							$('#hostCatelog').append('<li><i class="h-blank" /><a href="javascript:;" id="node-'+pid+'-'+data.UGId+'"><i class="h-eicon h-eicon-g"></i><span>'+group.UGName+'</span></a></li>');
						}
					}else{
						s = $("#hostCatelog").find("a[class='active']");
						var newmem = parseInt($("#hostCatelog").find("a[class='active']").attr('mem'))+1;
						$("#hostCatelog").find("a[class='active']").attr('mem',newmem);
						piid = s.attr("id")
						$("#"+piid).click();
						if(s.prev().attr("class").indexOf("h-aicon-d") >= 0){
						}else{
							s.prev().attr("class",'h-aicon');
							s.after('<ul style="display:none;"></ul>');
						}
					}
					refresh();
				}
				else{
					refresh();
					if(flag_admin && loginusercode != 'admin'){
						$('#node-'+pid+'-'+group.UGId).parent().remove();
					}
					$('#node-'+pid+'-'+data.UGId+'>span').text(name);
				}
				
			}
			else{
				_alert(1,"用户管理",'操作失败'+data.ErrMsg);
			}
		}
	})
}
	//获取创建界面管理员
//_______________________________________________________
//管理员
var user_data;
var u_nm = window.parent.document.frm.us.value;
var u_id = "";
var user_data_all = [];
var AdminSet_group = [];
var Admin_Data = [];
function _get_un(id,FLAG){
	var sid = -1;
	if(id != undefined){
		var userid = id;
	}else{
		var userid = null;
	}
	if(FLAG == undefined){
		FLAG = true;
	}
	if(global_id != 0){
		sid = id;
	}
	$('#select_u').empty().html('<div class="item" style="width: 33%;float: left;margin-left: -10px;"><select class="filter-select" name="un" id="un" style="width:202px;" tabindex="-1" aria-hidden="false" onchange="user_select(this)"></select><i class="ctrl add" onclick="_addUser(this)"></i></div>');
	// -----------------------------获取登陆用户name 和 ID
	$.ajax({
		url:'/bhost/_get_userid',
		type:"POST",
		async:false,
		data:{a0:sess,a1:u_nm},
		success: function(Result) {
			data = JSON.parse(Result);
			u_id = data.info;
		}
	})
	user_data_all.push(u_id);
	//--------------------------------------------
	//获取当前 角色id
	var ro_list = [];
	ro = $('#select_r select').val();
	if(ro != -1){
		ro_list.push(ro);
	}
	$('#select_r li.item').each(function(i,item){
		ro_list.push($(this).attr('id'));
	})
	ro_str = ro_list.join(",");
	$.ajax({
		url:"/bhost/_get_un",
		type:"POST",
		async:false,
		data:{a0:sess,a1:userid,r1:ro_str},
		success:function(result){
			user_result = JSON.parse(result);
			if(user_result){
				user_data = user_result.info;
				Admin_Data = user_data;
				if(sid == -1 || sid != u_id){
					$("#un").empty().append("<option value=\"-1\">请选择</option>"+
						"<option value=\""+u_id+"\" title=\""+u_nm+"\" type=\"true\" selected>"+u_nm+"</option>");
				}else{
					$("#un").empty().append("<option value=\"-1\">请选择</option>"+
						"<option value=\""+u_id+"\" title=\""+u_nm+"\" type=\"true\" selected>"+u_nm+"</option>");
				}

				$.each(user_data,function(i,item){
					if(item.UserId != u_id && item.UserId != global_id){
						$("#un").append('<option value="'+item.UserId+'" title="'+item.UserCode+'" type="'+item.UserRoot+'">'+item.UserCode+'</option>');
						user_data_all.push(item.UserId);
					}
				})
				$('#un').unbind();
				$('#un').select2();
				$('#un').change(function(){
					setTimeout(function() {
						reload_rn();
						_initList_ug();
					},1);
				});

				if(global_id == 0){ //创建
					$("#un").val('-1').trigger('change');
					$("#un").val(u_id).trigger('change');
					bind_grpAdmin(global_pid);

				}else{ //修改用户
					bind_grpAdmin(global_pid);	
					AdminSet_group = user_item.UGroupAdminSet;
					var AdminSet_group_tmp = [];
					$(AdminSet_group).each(function(i1,item1){
						AdminSet_group_tmp.push(item1.AdminId);
					})
					//绑定管理员

					AdminSet = user_item.AdminSet;
					AdminSet_tmp = [];
					var ii=0;

					//bind_grpAdmin(global_pid,1);
					$(AdminSet).each(function(i1,item1){
						if(AdminSet_group_tmp.indexOf(item1.AdminId)>=0){
							return true;
							// $("#un").val(item1.AdminId).trigger('change');
							// $("#un").next().next().click();
							// $("#select_u").find('.item').eq(1).find('.del').remove();
						}
						if(ii != 0){
							$("#un").next().next().click();
						}
							$("#un").val(item1.AdminId).trigger('change');
							ii = ii +1;
						
					})
					$.each(Admin_Data,function(i,item){
						if($("#un").val() == item.UserId){
							if(item.UserRoot == true){
								$("#un").next().next().click();
							}
						}
					})
					$.each($("#select_u").find('li'),function(i,item){
						$.each(Admin_Data,function(i1,item1){
							if($(item).attr('id') == item1.UserId){
								if(item1.UserRoot == true){
									$(item).attr('isroot','true');
								}
							}
						})
					})
					
					if($('#select_u select').val() == null){
						$('#select_u select').val('-1').trigger('change');
					}
					//绑定角色
					var admin_list = [];
					admin_id = $('#select_u select').val();
					if(admin_id != -1 && admin_id != null){
						admin_list.push(admin_id);
					}
					$('#select_u li.item').each(function(i,item){
						admin_list.push($(this).attr('id'));
					})
					userid_str = admin_list.join(",");//admin_list已选择的管理员
					
					bind_role_xSelect();
					RoleSet = user_item.RoleSet;
					if(RoleSet == ""){
						Flag_load = 1;
						_initList_ug(global_pid);
					}
					$(RoleSet).each(function(i1,item1){
						if(i1 != 0){
							$("#select_r_xselect").parent().parent().prev().click();
						}			
						$("#select_r_xselect").find('span').text(item1.RoleName);
						$('#select_r_xselect').data('value',item1.RoleId);
						if(i1 == RoleSet.length-1){
							setTimeout(function(){
								Flag_load = 1;
								_initList_ug(global_pid);
							},1000);
						}
					})
					$("#select_r_xselect").parent().parent().prev().click();
					// bind_grpAdmin(global_pid);
					_closeLoading();
				}
			}else{
				_alert(1,"系统用户",'获取管理员失败');
			}
		}
	})
}
var global_flag = false;
var AdminSet_group = [];
function bind_grpAdmin(global_pid_tmp,type){
	AdminSet_group = [];
	$.ajax({									//绑定父组管理员
		url:"/bhost/get_ugroup",
		type:"POST",
		async:false,
		data:{a0:sess,a1:global_pid_tmp},
		success:function(result){
			ugroup_item1 = JSON.parse(result);
			if(ugroup_item1.Result == false){
				_alert(1,"用户管理","获取信息失败："+ugroup_item1.info[0]);
				return false;
			}
			else{
				ugroup_item1 = ugroup_item1.info[0];
				AdminSet_group = ugroup_item1.AdminSet;
				if(type != 1){
					$(AdminSet_group).each(function(i1,item1){
						$("#un").val(item1.AdminId).trigger('change');
						$("#un").next().next().click();
					})
				}
				$('#select_u li.item i.ctrl.del').hide();
				
				if($('#select_u select').val() == null){
					$('#select_u select').val('-1').trigger('change');
				}
			}
		}
	})
}

var user_tmp = [];
var user_arry=['-1'];

function user_select(obj){
	var t = $(obj).children('option:selected').val();
	if (user_arry.indexOf(t) === -1 && t != undefined){
		user_arry.splice(0,1,t);
	}
	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}
}

function _addUser(obj){
	var add = 0;
	var name2 = $(obj).parent().children('select').children('option:selected').val();
	var tp = $(obj).parent().children('select').children('option:selected').attr('type');
	
	if (name2 == undefined){
		$(obj).parent().children('select').val('-1').trigger('change');
		return false;
	}	
	
	var t = $(obj).parent().children('select').children('option[value='+name2+']:first').text();
	if (name2 == -1 ){
		if($(obj).parent().children('select option').length >1)
			_alert(2,"系统用户","请选择管理员");
		return;
	}
	user_arry.splice(0,0,'-1');
	user_data_all.splice($.inArray(parseInt(name2), user_data_all), 1);
	var $c = $(obj).parent();
	var d = $('select>option:first',$c).val();
	var $s = $('<li class="item" id="'+name2+'" isroot="'+tp+'" style="width: 33%;float: left;margin-left: -10px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:170px;" disabled="true"><i class="ctrl del" onclick="_delUser(this)"></i></li>');
	
	$c.children('select').val(d);
	$c.children('select').find('option[value='+name2+']').remove();
	$c.after($s);
	user_tmp=[];
	$("#select_u>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		user_tmp.push(v_tmp);
	});
	//获取当前 已添加的管理员 是否存在 用户管理员 
	var flag_user_role =false;
	$('#select_u li.item').each(function(i,item){
		if($(this).attr('isroot') == 'true'){
			flag_user_role = true;
			return false;
		}
	})
	if(!flag_user_role && parent.user_item.UserId != name2 ){
		$('#select_u select').val(parent.user_item.UserId).trigger('change');
	}
	if($(obj).parent().children('select').val() == null){
		$(obj).parent().children('select').val('-1').trigger('change');
	}
}

function _delUser(obj){
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var $p = $("#un");
	var data, max;
	var min = 0;
	max = user_data_all.length - 1;
	data = user_data_all;

	var t = $(obj).siblings('input').val();
	var isRoot = $(obj).parent('li').attr('isroot');
	
	$c.remove();
	$("#un").parent().show();
	user_arry.splice($.inArray(id,user_arry),1);

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<option value="' + id + '" title="'+t+'" type="'+isRoot+'" >' + t + '</option>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('option').eq(0).after('<option value="' + id + '" title="'+t+'" type="'+isRoot+'">' + t + '</option>');
	} else {
		$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '" title="'+t+'" type="'+isRoot+'" >' + t + '</option>');
	}
	user_data_all.splice(index_1, 0, parseInt(id));
	user_tmp=[];
	$("#select_u>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		user_tmp.push(v_tmp);
	});
	//获取当前 已添加的管理员 是否存在 用户管理员 
	var flag_user_role =false;
	$('#select_u li.item').each(function(i,item){
		if($(this).attr('isroot') == 'true'){
			flag_user_role = true;
			return false;
		}
	})
	if(flag_user_role == false){
		if($('#select_u option:selected').attr('type') == true){
			flag_user_role = true;
		}else{
			flag_user_role = false;
		}
	}
	if(!flag_user_role && $('#select_u select').val() == -1 ){
		$('#select_u select').val(parent.user_item.UserId).trigger('change');
	}
	if($('#select_u select').val() == null){
		$('#select_u select').val('-1').trigger('change');
	}
	reload_rn();
	_initList_ug();
}

//访问授权
var auth_data; 
var auth_tmp = [];
var auth_tmp_g = [];
var auth_data_all = [];
var auth_arry=['-1'];
var auth_arry_g=['-1'];
function auth_select(obj,type){
	var t = $(obj).children('option:selected').val();
	if(type == 'g'){
		if (auth_arry_g.indexOf(t) === -1 && t != undefined){
			auth_arry_g.splice(0,1,t);
		}
	}else{
		if (auth_arry.indexOf(t) === -1 && t != undefined){
			auth_arry.splice(0,1,t);
		}
	}

	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}
}

function _addAuth(obj,type){
	var add = 0;
	var name2 = $(obj).parent().children('select').children('option:selected').val();
	if (name2 == undefined){
		$(obj).parent().children('select').val('-1').trigger('change');
		return false;
	}
	var t = $(obj).parent().children('select').children('option[value='+name2+']').text();
	if (name2 == -1){
		_alert(2,"用户管理","请选择访问授权");
		return;
	}
	if(type == 'g'){
		auth_arry_g.splice(0,0,'-1');
	}else{
		auth_arry.splice(0,0,'-1');
	}
	auth_data_all.splice($.inArray(parseInt(name2), auth_data_all), 1);
	var $c = $(obj).parent();
	// $c.children('select').select2('destroy');
	var d = $('select>option:first',$c).val();
	if(type == 'g'){
		var $s = $('<li class="item" id="'+name2+'" style="float: left;margin-left: -19px; width: 315px; padding: 10px 6px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:238px;" disabled="true"><i class="ctrl del" onclick="_delAuth(this,\'g\')"></i></li>');
	}else{
		var $s = $('<li class="item" id="'+name2+'"style="width: 32%;float: left;margin-left: -19px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" style="width:170px;" disabled="true"><i class="ctrl del" onclick="_delAuth(this)"></i></li>');		
	}

	$c.children('select').val(d);
	$c.children('select').find('option[value='+name2+']').remove();

	$c.after($s);
	// $c.children('select').select2({minimumResultsForSearch: -1});
	auth_tmp=[];
	auth_tmp_g=[];
	if(type == 'g'){
		$("#select_a_g>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp_g.push(v_tmp);
		});
	}else{
		$("#select_a>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp.push(v_tmp);
		});
	}
}

function _delAuth(obj,type){
	var $c = $(obj).parent();
	var id = $c.attr('id');
	if(type == 'g'){
		var $p = $("#an_g");
	}else{
		var $p = $("#an");
	}
	var data, max;
	var min = 0;
	max = auth_data_all.length - 1;
	data = auth_data_all;

	var t = $(obj).siblings('input').val();
	$c.remove();
	if(type == 'g'){
		$("#an_g").parent().show();
	}else{
		$("#an").parent().show();
	}
	if(type == 'g'){
		auth_arry_g.splice($.inArray(id,auth_arry_g),1);
	}else{
		auth_arry.splice($.inArray(id,auth_arry),1);
	}

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<option value="' + id + '">' + t + '</option>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('option').eq(0).after('<option value="' + id + '">' + t + '</option>');
	} else {
		$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '">' + t + '</option>');
	}
	auth_data_all.splice(index_1, 0, parseInt(id));

	auth_tmp=[];
	auth_tmp_g = [];
	if(type == 'g'){
		$("#select_a_g>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp_g.push(v_tmp);
		});
	}else{
		$("#select_a>li").each(function(i,item){
			v_tmp=$(item).attr("id");
			auth_tmp.push(v_tmp);
		});
	}
}

function _get_an(){
	$('#select_a').empty().html('<div class="item" style="width: 32%;float: left;margin-left: -19px;"><select class="filter-select" name="an" id="an" style="width:202px;" tabindex="-1" aria-hidden="false" onchange="auth_select(this)"></select><i class="ctrl add" onclick="_addAuth(this)"></i></div>');
	$('#select_a_g').empty().html('<div class="item" style="float: left;margin-left: -19px; width: 315px; padding: 10px 6px;"><select class="filter-select" name="an_g" id="an_g" style="width:270px;" tabindex="-1" aria-hidden="false" onchange="auth_select(this,\'g\')"></select><i class="ctrl add" onclick="_addAuth(this,\'g\')"></i></div>');
	$.ajax({
		url:"/bhost/get_access_way_x",
		type:"POST",
		async:true,
		data:{a0:sess},
		success:function(result){
			var result = JSON.parse(result);
			auth_data = result;
			if(result){
				data = result.data;
				$("#an").empty().append('<option value=\"-1\" selected>请选择</option>');
				$("#an_g").empty().append('<option value=\"-1\" selected>请选择</option>');
				$.each(data,function(i,item){
					$("#an").append('<option value="'+item.AccessAuthId+'" title="'+item.UserCode+'">'+item.AccessAuthName+'</option>');
					$("#an_g").append('<option value="'+item.AccessAuthId+'" title="'+item.UserCode+'">'+item.AccessAuthName+'</option>');
					auth_data_all.push(item.AccessAuthId);
					//$("#un").append("<label class=\"form-label\"  title=\""+item.UserCode+"\"style=\"width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 10px;\"><input class=\"form-checkbox\" type=\"checkbox\" name=\""+item.UserCode+"\" id=\""+item.UserId+"\">"+item.UserCode+"</label>"); 
				})
			}else{
				_alert(1,"系统用户",'获取访问授权失败');
			}
		}
		
	})
	$('#select_a .filter-select').select2();
	$('#select_a_g .filter-select').select2();
}


var accdata;
var c_index_all;
function binding_clientset() {
	$.ajax({
		url:'/bhost/get_clientset_z',
		type:'post',
		async:false,
		data:{a0: sess},
		success:function(result){
			accdata = JSON.parse(result);
		}
	});
}

//绑定客户端集合
function bind_client_xSelect(){
	$('#accset').empty().data('xSelect','');
	binding_clientset();
	var client_array = [];
	c_index_all = [];
	
	if(if_disable =='1'){
		type_str ='check';
	}else{
		type_str ='edit';
	}
	
	//type_str ='edit';
	$.each(accdata.data,function(i,item){
		if ($("#accset").data('value') == item.ClientScopeId){
			
		}else{
			if (client_list.indexOf(item.ClientScopeId) > -1){
				return true;
			}
		}	
		
		var select_data_json = {
			'value':1,
			'name':'admin2',
			'type':type_str
		};
		select_data_json.value = item.ClientScopeId;
		select_data_json.name = item.ClientScopeName;
		client_array.push(select_data_json);
		c_index_all.push(item.ClientScopeId);
	});
	
	if(if_disable =='1'){
		$('#accset').xSelect({
			width: 334,
			defaultText: '请选择',
			items:client_array,
			module_type:'client',
			edit: function(item,obj){
				$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
				_editNode2(obj,1)
			},
			setval:function(item,obj){
				//change_client_scope(obj);
			}
		});
	}else{
		$('#accset').xSelect({
			width: 334,
			defaultText: '请选择',
			items:client_array,
			module_type:'client',
			edit: function(item,obj){
				$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
				_editNode2(obj,1)
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_editNode2(obj,2);
					}
				}
			],
			setval:function(item,obj){
				//change_client_scope(obj);
			}
		});
	}
	/*
	$('#accset').xSelect({
		width: 334,
		defaultText: '请选择',
		items:client_array,
		module_type:'client',
		edit: function(item,obj){
			$('.'+$('.xSelect_clientList .xSelect-show').data('id')).hide();
			_editNode2(obj,1)
		},
		btn:[
			{
				'name':'新增',
				'event': function(items,obj){
					_editNode2(obj,2);
				}
			}
		],
		setval:function(item,obj){
			//change_client_scope(obj);
		}
	});
	*/
}

function change_client_scope(obj){
	var t = $(obj).find('span').data('value');
	if (client_list.indexOf(t) === -1 && t != undefined) {
		client_list.splice(0, 1, t);
	}
	if ($(obj).parent('ul').children('li').length == 2 && t != '-1') {
		$('#accset').next('i.add').click();
		$('#accset').hide();
	}
}
var client_tmp = [];
function select_first_grp(){
	$('#find_select').val('all').trigger('change');
	first_grp = $('#first_grp').attr('value');
	if (first_grp == '0') {
		$('#first_grp').text('图标');
		$('#first_grp').attr("value", '1');
		first_grp = '1';
		$('#first_grp').show();
    } 
    else {
		$('#first_grp').text('列表');
		$('#first_grp').attr("value", '0');
		first_grp = '0';
		$('#first_grp').show();
	}
	$.ajax({
		url:'/bhost/save_select_first_grp_user',
		type: "post",
		cache:false,
		data: {a0:sess,a1:first_grp},
		success: function(Result) {

		}
	})
	if($(".h-catelog").find("a[class ='active']").length>0){
		$(".h-catelog").find("a[class ='active']").click();
	}
	else{
		_initList();
	}
}
function check_client(obj){
	var pass = 1;
	var v=$(obj).children("option:selected").val();
	if(client_tmp.indexOf(v) >=0){
		pass=0;
		_alert(1,"用户管理",'已存在相同客户端集合');
	}
	if(pass==1){
		client_tmp=[];
		$('#Temp4>div>div.set-view4').each(function(i,item){
			var v_tmp=$(item).children("select").val();
			client_tmp.push(v_tmp)
		});
	}else{
		$('#Temp4>div>div.set-view4').each(function(i,item){
			var new_mo=$(item).children("select").val();
			if(client_tmp[i] != new_mo){				
				if(client_tmp[i])$(item).children("select").val(client_tmp[i]);
				else $(item).children("select").val("");
				return false;
			}
		});
		// $('#Temp4 .select2').select2({minimumResultsForSearch: -1}); //----------------------------8.8-----------------------------
	}
}

function change_limit(obj){
	var type = $(obj).find('option:selected').val();
	var v = $(obj).val();
	var $c = $(obj).siblings('div.g-cont');
	var $c1 = $c.children('div.sel-type1'),
			$c2 = $(".set-view").not(":first");
	if (type == 1){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view4').show();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view5').hide();
	}else if (type == 2){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view2').show();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
		$(obj).parent().find('.set-view.set-view5').hide();
	}else if (type == 3){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view3').show();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
		$(obj).parent().find('.set-view.set-view5').hide();
	}else if (type == 4){
		$c1.hide();
		// $c2.show();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view5').show();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
	}else if (type == -1){
		$c1.hide();
		// $c2.hide();
		$("#add2").hide();
		$(obj).parent().find('.set-view.set-view5').hide();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
	}else{//客户端集合
		$c1.show();
		// $c2.hide();
		$("#add2").show();
		$(obj).parent().find('.set-view.set-view5').hide();
		$(obj).parent().find('.set-view.set-view2').hide();
		$(obj).parent().find('.set-view.set-view3').hide();
		$(obj).parent().find('.set-view.set-view4').hide();
		// $("#client_list").show();
	}
}
var ipcheck_route=/(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/
var MACReg = /([A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2}/;
var c_index_all = [];
var client_list = ['-1'];
var client_id;
var IPList = {"IPSetId":0,"Set":[]};
var MACList = {"MACSetId":0,"Set":[]};
var List1 = {
  "ClientScopeId": 0,
  "Type": 1, 
  "IPList": null,
  "MACList": null
};
var List2 = {
  "ClientScopeId": 0,
  "Type": 2, 
  "IPList": {},
  "MACList": {}
};
var CScopeSet=[];

function _addSet4(obj){
	var type = $(obj).parent().children('select').find('option:selected').val();
	var add = 0;
	if (type == 1 || type == 2){
		if (type == 2){
			var start_ip = $(obj).parent().find('input').not('input:hidden').eq(0).val();
			var end_ip = $(obj).parent().find('input').not('input:hidden').eq(1).val();
			if (start_ip == ""){
				_alert(2,"用户管理","请输入起始IP地址",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (end_ip == ""){
				_alert(2,"用户管理","请输入终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			if (!ipcheck_route.test(start_ip)){
				_alert(1,"用户管理","起始IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (!ipcheck_route.test(end_ip)){
				_alert(1,"用户管理","终止IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			var a = _compare_ip(start_ip,end_ip);
			if (a != 3){
				_alert(1,"用户管理","起始IP地址不能大于或等于终止IP地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view2').not('.set-view.set-view2:hidden').each(function(i,item){
				if ($(item).find('input').not('input:hidden').eq(0).val() == start_ip && $(item).find('input').not('input:hidden').eq(1).val() == end_ip){
					add = 1;
					_alert(1,"用户管理","已存在相同IP区间",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(1,start_ip,end_ip);
		}else{
			var start_ip = $(obj).parent().find('input').not('input:hidden').val();
			var end_ip = start_ip;
			if (start_ip == ""){
				_alert(2,"用户管理","请输入IP地址",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			if (!ipcheck_route.test(start_ip)){
				_alert(1,"用户管理","IP地址不正确,请重新输入",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view4').not('.set-view.set-view4:hidden').each(function(i,item){
				if ($(item).find('input').not('input:hidden').val() == start_ip){
					add = 1;
					_alert(1,"用户管理","已存在相同IP地址",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(1,start_ip,end_ip);
		}
	}else{
		if (type == 3){
			var mac_input = $(obj).parent().find('input').not('input:hidden').val().trim();
			if (mac_input == ""){
				_alert(2,"用户管理","请输入MAC地址",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			if (!MACReg.test(mac_input)){
				_alert(1,"用户管理","MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden'));
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view3').not('.set-view.set-view3:hidden').each(function(i,item){
				if (mac_input == $(item).find('input').not('input:hidden').val().trim()){
					add = 1;
					_alert(1,"用户管理","该MAC地址已存在",$(obj).parent().find('input').not('input:hidden'));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(2,mac_input,mac_input);
		}else if(type == 4){
			var start_mac = $(obj).parent().find('input').not('input:hidden').eq(0).val().trim();
			var end_mac = $(obj).parent().find('input').not('input:hidden').eq(1).val().trim();
			if (start_mac == ""){
				add = 1;
				_alert(2,"用户管理","请输入起始MAC地址",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (end_mac == ""){
				add = 1;
				_alert(2,"用户管理","请输入终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			if (!MACReg.test(start_mac)){
				add = 1;
				_alert(1,"用户管理","起始MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(0));
				return false;
			}
			if (!MACReg.test(end_mac)){
				add = 1;
				_alert(1,"用户管理","终止MAC地址格式错误,请重新输入",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			var a = _compare_mac(start_mac,end_mac);
			if (a != 3){
				add = 1;
				_alert(1,"用户管理","起始MAC地址不能大于或等于终止MAC地址",$(obj).parent().find('input').not('input:hidden').eq(1));
				return false;
			}
			if (add == 1){
				return false;
			}
			$(obj).parent().parent().find('.sitem').not('.sitem:first').find('.set-view.set-view5').not('.set-view.set-view5:hidden').each(function(i,item){
				if (start_mac == $(item).find('input').not('input:hidden').eq(0).val().trim() && end_mac == $(item).find('input').not('input:hidden').eq(1).val().trim()){
					add = 1;
					_alert(1,"用户管理","该MAC地址区间已存在",$(obj).parent().find('input').not('input:hidden').eq(0));
					return false;
				}
			});
			if (add == 1){
				return false;
			}
			// save_mana_set(2,start_mac,end_mac);
		}else if(type == 5){
			var accset = $('#accset').find('span').text();
			clientId = $('#accset').data('value');
			if (clientId == "-1" || clientId == undefined){
				_alert(2,"系统用户","请选择客户端集合");
				return false;
			}
		}
	}
	if(type == 5){
		var cid = $("#accset").data('value');
		var $H = '<div class="sitem" id="'+cid+'" style=" width: 510px;float: left; margin-left: -10px;height:40px" _auth_data="">'+
			'<i class="ctrl del" onclick="_del(this)" style="bottom: 30px;margin-left: 130px"></i>'+
				'<select name="" id="Clone" class="select2 " style="width: 120px" disabled="disabled">'+
					'<option value="5" selected>客户端集合</option></select>'+
				'<input id="accset" style="width: 302px;" type="text" class="form-text" value="'+accset+'" disabled="disabled">'+
			'</div>';
		$(obj).parent().after($H);
		$('#Clone').select2({minimumResultsForSearch: -1});
		if (client_list.indexOf(cid) === -1) {
			client_list.push(cid);
		}
		client_list.splice(0, 0, '-1');
		c_index_all.splice($.inArray(parseInt(cid), c_index_all), 1);
		$("#accset").find('span').text('请选择');
		$("#accset").data('value','-1');
		$("div[data-id=xSelect-client]").children('input').val('');
		$("div[data-id=xSelect-client]").find('span[data-value='+cid+']').parent('li').remove();
		$(obj).prev('div').data('value','-1');
	}else{
		var $H = temp4.clone().wrap();
		var select_type = $("#Temp4").children('.sitem:first').children('select:first').val();
		var input1_str = null;
		var input2_str = null;
		if($("#Temp4").children('.sitem:first').find('input:visible').length == 1){
			input1_str = $("#Temp4").children('.sitem:first').find('input:visible').val();
		}else{
			input1_str = $("#Temp4").children('.sitem:first').find('input:visible').eq(0).val();
			input2_str = $("#Temp4").children('.sitem:first').find('input:visible').eq(1).val();
		}
		$('.select2',$H).select2({minimumResultsForSearch: -1});
		$("#Temp4").children('.sitem:first').after($H);
		$("#Temp4").children('.sitem').eq(1).children('select:first').val(select_type).trigger('change');
		if($("#Temp4").children('.sitem').eq(1).find('input:visible').length == 1){
			$("#Temp4").children('.sitem').eq(1).find('input:visible').val(input1_str);
		}else{
			$("#Temp4").children('.sitem').eq(1).find('input:visible').eq(0).val(input1_str);
			$("#Temp4").children('.sitem').eq(1).find('input:visible').eq(1).val(input2_str);
		}	
		$("#Temp4").children('.sitem').eq(1).find('select').attr("disabled",true);
		$("#Temp4").children('.sitem:first').find('input').val('');
		$("#Temp4").children('.sitem:first').children('select:first').val('5').trigger('change');
		$("#Temp4").children('.sitem').eq(1).children('i.add').remove();
		$("#Temp4").children('.sitem').eq(1).append('<i class="ctrl del" onclick="_del(this)" style="bottom: 30px;margin-left: 130px"></i>');
	}
	_autoHeight();
}

//保存客户端登陆限制  type :  1-->ip   2-->mac  3-->scope

var ip_order = 1;
var mac_order = 1;
function save_mana_set(type,start,end){
	var IPSet = {
		"IPSetMemberId": 0,
		"Order": 0,
		"StartIP": "",
		"EndIP": ""                            
	};
	var MACSet = {
		"MACSetMemberId": 0,
		"Order": 0,
		"StartMACAddress": "",
		"EndMACAddress": ""
	};
	var scope = {
		"ClientScopeId": 1,
		"Type": 1, 
		"IPList": null,
		"MACList": null
	}
	if(type == 1){
		IPSet.Order = ip_order;
		ip_order++;
		IPSet.StartIP = start;
		IPSet.EndIP = end;
		// IPSet = JSON.parse(IPSet);
		IPList.Set.push(IPSet);
	}
	if(type == 2){
		MACSet.Order = mac_order;
		mac_order++;
		MACSet.StartMACAddress = start;
		MACSet.EndMACAddress = end;
		// MACSet = JSON.parse(MACSet);
		MACList.Set.push(MACSet);
	}	
	if(type == 3){
		scope.ClientScopeId = start;
		// scope = JSON.parse(scope);
		CScopeSet.push(scope);
	}
}

function _del(obj){
	var type = $(obj).parent().children("select").val();
	var value0 = $(obj).parent().find("input").not('input:hidden').eq(0).val();
	var value1 = $(obj).parent().find("input").not('input:hidden').eq(1).val();
	var value3 = $(obj).parent().attr("_auth_data");
	if (type == 1){
		$(IPList.Set).each(function(a1,item1){
			if(item1.StartIP == value0 && item1.EndIP == value0){
				IPList.Set.splice(a1,1);
			}
		})
	}
	if (type == 2){
		$(IPList.Set).each(function(a1,item1){
			if(item1.StartIP == value0 && item1.EndIP == value1){
				IPList.Set.splice(a1,1);
			}
		})
	}
	if (type == 3){
		$(MACList.Set).each(function(a1,item1){
			if(item1.StartMACAddress == value0 && item1.EndMACAddress == value0){
				MACList.Set.splice(a1,1);
			}
		})
	}
	if (type == 4){
		$(MACList.Set).each(function(a1,item1){
			if(item1.StartMACAddress == value0 && item1.EndMACAddress == value1){
				MACList.Set.splice(a1,1);
			}
		})
	}
	if (type == 5){
		var $c = $(obj).parent();
		var id = $c.attr('id');
		var t = $(obj).siblings('input').val();
		var v, data, max;
		var min = 0;
		max = c_index_all.length - 1;
		data = c_index_all;
		$("#accset").show();
		client_list.splice($.inArray(id, client_list), 1);
		var $p = $("div[data-id=xSelect-client]").children('ul');
		if (max < 0){
			var index_1 = -1;
		}else{
			var index_1 = search_i(min, max, parseInt(id), data);
		}
		index_1 = parseInt(index_1);
		if (index_1 == -1) {
			index_1 = max;
			$p.append('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
		} else if (index_1 == -2) {
			index_1 = 0;
			$p.children('li').eq(0).before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
		} else {
			$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px">'+t+'</span></li>');
		}
		data.splice(index_1, 0, parseInt(id));
	}
	var $c = $(obj).parent();
	$c.remove();
}
var $focusObj;
var all_accesss = [];
var serdata = null;
var accdata;
var selectedId_array = [];
function _autoView(obj,i,j){
	$(document)[0].onclick = null;
	$focusObj = $(obj);
	//var data = ['aaaa','bbbbb','ccccc','safefdds','gjhjsa'];
	if (j == 1){
		$.ajax({
			url:'/bhost/get_ServerScope',
			type:'post',
			async:false,
			data:{},
			success:function(result){
				serdata = JSON.parse(result);
			}
		});
	}else if (j == 0){
		get_AccessStrategy(-1);
	}else if (j == 2){
		$.ajax({
			url:'/bhost/get_timeset_z',
			type:'post',
			async:false,
			data:{},
			success:function(result){
				tdata = JSON.parse(result);
			}
		})
	}else if (j == 3){
		$.ajax({
			url:'/bhost/get_clientset_z',
			type:'post',
			async:false,
			data:{a0:sess},
			success:function(result){
				accdata = JSON.parse(result);
			}
		});
	}
	var v = $.trim($(obj).val());
	var $view;
	if($('#autoView').length == 0){
		$('body').append('<div id="autoView" />');
	}
	$view = $('#autoView');
	var c = '';
	if (j == 0){
		$.each(accsdata.data,function(i,item){
			if(v == ''){
				c += '<li><i class="del" onclick="_delNode(this)" /><a href="javascript:;" id="'+item.AccessStrategyId+'" onclick="_setVal(this,0);select_AccessStrategy(this);">'+item.AccessStrategyName+'</a></li>';
			}else{
				if(item.AccessStrategyName.indexOf(v) >= 0 ){
					c += '<li><i class="del" onclick="_delNode(this)" /><a href="javascript:;" id="'+item.AccessStrategyId+'" onclick="_setVal(this,0);select_AccessStrategy(this);">'+item.AccessStrategyName+'</a></li>';
				}
			}
		});
	}else if (j == 1){
		$.each(serdata.data,function(i,item){
			var add = 0;
			$.each(serverid_list,function(i1,item1){
				if (item.ServerScopeId == item1){
					add = 1;
					return false;
				}
			})
			if (add == 1){
				return true;
			}
			if(v == ''){
				c += '<li><i class="edit" onclick="_editNode(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.ServerScopeId+'" onclick="_setVal(this,1);">'+item.ServerScopeName+'</a></li>';
			}else{
				if(item.ServerScopeName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_editNode(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.ServerScopeId+'" onclick="_setVal(this,1);">'+item.ServerScopeName+'</a></li>';
				}
			}
		});
	}else if (j == 2){
		$.each(tdata.data,function(i,item){
			var add = 0;
			$.each(time_list,function(i1,item1){
				if (item.TimeSetId == item1){
					add = 1;
					return false;
				}
			})
			if (add == 1){
				return true;
			}
			if(v == ''){
				c += '<li><i class="edit" onclick="_editNode1(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.TimeSetId+'" onclick="_setVal(this,2);">'+item.Name+'</a></li>';
			}else{
				if(item.Name.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_editNode1(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.TimeSetId+'" onclick="_setVal(this,2);">'+item.Name+'</a></li>';
				}
			}
		});
	}else if (j == 3){
		$.each(accdata.data,function(i,item){
			var add = 0;
			$.each(client_list,function(i1,item1){
				if (item.ClientScopeId == item1){
					add = 1;
					return false;
				}
			})
			if (add == 1){
				return true;
			}
			
			if(v == ''){
				c += '<li><i class="edit" onclick="_editNode2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.ClientScopeId+'" onclick="_setVal(this,2);">'+item.ClientScopeName+'</a></li>';
			}else{
				if(item.ClientScopeName.indexOf(v) >= 0 ){
					c += '<li><i class="edit" onclick="_editNode2(this,1)" /><a style="white-space: nowrap;text-overflow: ellipsis;vertical-align: middle;overflow: hidden;" href="javascript:;" id="'+item.ClientScopeId+'" onclick="_setVal(this,2);">'+item.ClientScopeName+'</a></li>';
				}
			}
		});
	}
	if(i==1){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" onclick="_addNew(this)">创建新配置...</a></div>');
	}else if(i == 0){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_addNew2(this);">添加新策略</a></div>');
	}else if(i == 2){
		//$view.html('<ul>'+c+'</ul>');
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_editNode(this,2);">添加新服务器范围</a></div>');
	}else if(i == 3){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_editNode1(this,2);">添加新时间集合</a></div>');
	}else if(i == 4){
		$view.html('<ul>'+c+'</ul><div class="add2"><a href="javascript:;" id="-1" onclick="_editNode2(this,2);">添加新客户端集合</a></div>');
	}

	var offset = $(obj).offset();
	var w = $(obj).outerWidth();
	$view.css({
		top:offset.top+24,
		left:offset.left,
		width:w-12
	}).show();

	$(obj).parents('.g-tsel').addClass('on');
	if (j == 0){
		input_val = $(obj).val();
	}
}

var client_data;
function _editNode2(obj,type){
	clientId1 = obj;
	clientId2 = type;
	clear_client();
	var title;
	if (type == 1){//编辑客户端集合
		clientId = $(obj).children('span').data('value');
		$.ajax({
			url: "/bhost/get_client_list",
			type: "POST",
			async: false,
			data: { a0: sess, a1: clientId },
			success: function (result) {
				var client_result = JSON.parse(result);
				if (client_result.Result == true) {
					client_data = client_result.info.data[0];
					title = "客户端集合";
				}
			}
		})
	}else if(type == 2){
		client_data = null;
		clientId = 0;
		title = "客户端集合";
	}
	var $dialogCont = $("#client_suspend").show();
	
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"client_suspend",
		width:"1000px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	initformlist();
	$(".ui-dialog-title").css("width","140px");
	client_main(type);
	
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		reload_client();
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
		client_add(d);
	})	
}

function _hideView(obj){
	$(obj).parents(".sitem").attr("_auth_data","");
	$(accdata.data).each(function(i,item){
		if(item.ClientScopeName == $("#accset").val()){
			$(obj).parents(".sitem").attr("_auth_data",item.ClientScopeId)
			return false;
		}
	})
	var value = $(obj).parents(".sitem").attr("_auth_data");
	if(value == ""){
		$(obj).val("");
	}
	//AccessStrategySet.AccessStrategyId = -1;
	$(document)[0].onclick = function(){
		$('#autoView').hide();
		$('.g-tsel').removeClass('on');
	}
}

var input_val = "";
var server_id;
var serverscope = {
	"server_id":0,
	"server_name":""
};
var serverid_list = [];
function _setVal(t,t1){
	var val = $(t).text();
	var add = 0;

	$($focusObj).val(val);
	$view = $('#autoView');
	$view.hide();
	if (t1 == 0){
		AccessStrategySet.AccessStrategyId = parseInt($(t).attr('id'));
		AccessStrategySet.AccessStrategyName = val;
	}else if (t1 == 2){
		server_id = null;
		server_id = parseInt($(t).attr('id'));
		serverscope.server_id = server_id;
		serverscope.server_name = val;
		// change_server();
	}else if(t1 == 1){
		time_id =  parseInt($(t).attr('id'));
	}
	var $item = $focusObj.parents('div.g-title').next('div.g-cont').find('div.forName');
	var $item2 = $focusObj.parent().next('input.forName');
	$item.hide();
	$item2.hide();
	var authdata = server_id;
	$("#Temp4").children("[class='sitem']:first").attr("_auth_data",authdata);
}

function clear_client(){
	client_set = {
		"ClientScopeId": 0,
		"ClientScopeName": "",
		"IsApplyToServerScope": false,
		"IPList":{
			"IPSetId": 0,
			"Set": new Array()
		},
		"MACList":{
			"MACSetId": 0,
			"Set": new Array()
		}
	};
	$("#ip_n_c1").children('span').not('span:first').remove();
	$("#ip_n_c").children('span').not('span:first').remove();
	$("#MACAddress").children('span').not('span:first').remove();
	$("#MACAddress1").children('span').not('span:first').remove();
	$("#ip_n_c1").children('span:first').find('input').val('');
	$("#ip_n_c").children('span:first').find('input').val('');
	$("#MACAddress").children('span:first').find('input').val('');
	$("#MACAddress1").children('span:first').find('input').val('');
	$("#c_n").val('');
	$("#c_n").attr("disabled",false);
	$("#c_n").next('i').attr('class','v-check');
}

function initformlist(){
	var h1 = $('.form1').height();
	var h2 = $('.form3').height();
	if (h1 > h2){
		$('.form3').height(h1);
	}else{
		$('.form1').height(h2);
	}
}

function client_main(type){
	if (type == 1) {
		$("#c_n").val(client_data.ClientScopeName);
		$("#c_n").attr("disabled", true);
		if (client_data.IPList != null) {
			client_set.IPList.IPSetId = client_data.IPList.IPSetId;
			if(client_data.IPList.Set!=null){
				var IPset_group=client_data.IPList.Set.filter(function (params) {
					return params.StartIP != params.EndIP
				});
				var IP_group=client_data.IPList.Set.filter(function (params) {
					return params.StartIP == params.EndIP
				});
				// console.log(IP_group);
				// console.log(IPset_group);
				for(var i=0;i<IPset_group.length-1;i++){
					var $c = $('<span class="ss" value="' + IPset_group[i].IPSetMemberId + '" style="float:left;width: 340px;position:static;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;"value="' + IPset_group[i].StartIP + '">'
						+ '<span style="vertical-align:middle;padding-left: 5px;padding-right: 4px;">-</span>' + '<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + IPset_group[i].EndIP + '">'
						+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
					$("#ip_n_c").find("span[class='ss ss-add']").after($c);
				}
				if(IPset_group.length!=0){
					$('#ip_n_c').attr('value',IPset_group[i].IPSetMemberId);
					$('#ip_n_c').find('input:eq(0)').val(IPset_group[i].StartIP);
					$('#ip_n_c').find('input:eq(1)').val(IPset_group[i].EndIP);
				}
				for(var i=0;i<IP_group.length-1;i++){
					var $c = $('<span class="ss" style="float:left;position:static;padding: 0 0 10px 0;" value=' + IP_group[i].IPSetMemberId + '/>');
					$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + IP_group[i].StartIP + '">'
						+ '<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
					$("#ip_n_c1").find("span[class='ss ss-add']").after($c);
				}
				if(IP_group.length!=0){
					$('#ip_n_c1').attr('value',IP_group[i].IPSetMemberId);
					$('#ip_n_c1').find('input:eq(0)').val(IP_group[i].StartIP);
				}
			}
		}
		if (client_data.MACList != null) {
			client_set.MACList.MACSetId = client_data.MACList.MACSetId;
			if(client_data.MACList.Set!=null){
				var MACset_group=client_data.MACList.Set.filter(function (params) {
					return params.StartMACAddress != params.EndMACAddress
				});
				var MAC_group=client_data.MACList.Set.filter(function (params) {
					return params.StartMACAddress == params.EndMACAddress
				});
				for(var i=0;i<MACset_group.length-1;i++){
					var $c = $('<span class="ss" value="' + MACset_group[i].MACSetMemberId + '" style="float:left;width: 350px;position: static;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" value="' + MACset_group[i].StartMACAddress + '" style="width:138px;padding-right: 8px;;">'
						+ '<span style="vertical-align:middle;padding-left: 5px;padding-right: 5px;">-</span>'
						+ '<input type="text" class="form-text" value="' + MACset_group[i].EndMACAddress + '" style="width:138px;padding-right: 8px;;">'
						+ '<i class="ctr ctr-del" style="margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
					$("#MACAddress1").find("span[class='ss ss-add']").after($c);
				}
				if(MACset_group.length!=0){
					$("#MACAddress1").find("span[class='ss ss-add']").attr('value',MACset_group[i].MACSetMemberId);
					var $mac_input=$("#MACAddress1").find("span[class='ss ss-add']").find('input');
					$mac_input.first().val(MACset_group[i].StartMACAddress);
					$mac_input.last().val(MACset_group[i].EndMACAddress);
				}
				for(var i=0;i<MAC_group.length-1;i++){
					var $c = $('<span class="ss" value="' + MAC_group[i].MACSetMemberId + '" style="float:left;position:static;width: 190px;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" style="width:138px;padding-right: 8px;" value="' + MAC_group[i].StartMACAddress + '">'
						+ '<i class="ctr ctr-del" style="    margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
					$("#MACAddress").find("span[class='ss ss-add']").after($c);
				}
				if(MAC_group.length!=0){
					$("#MACAddress").find("span[class='ss ss-add']").attr('value',MAC_group[i].MACSetMemberId);
					$("#MACAddress").find("span[class='ss ss-add']").find('input').val(MAC_group[i].StartMACAddress);
				}
			}
			/*
			$.each(client_data.MACList.Set, function (i, item) {
				if (item.StartMACAddress == item.EndMACAddress) {
					var $c = $('<span class="ss" value="' + item.MACSetMemberId + '" style="float:left;position:static;width: 190px;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" style="width:138px" value="' + item.StartMACAddress + '">'
						+ '<i class="ctr ctr-del" style="    margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
					$("#MACAddress").find("span[class='ss ss-add']").after($c);
				} else {
					var $c = $('<span class="ss" value="' + item.MACSetMemberId + '" style="float:left;width: 380px;position: static;padding: 0 0 10px 0;"/>');
					$c.html('<input type="text" class="form-text" value="' + item.StartMACAddress + '" style="width:138px;">'
						+ '<span style="vertical-align:middle;padding-left: 5px;padding-right: 5px;">-</span>'
						+ '<input type="text" class="form-text" value="' + item.EndMACAddress + '" style="width:138px;">'
						+ '<i class="ctr ctr-del" style="margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
					$("#MACAddress1").find("span[class='ss ss-add']").after($c);
				}

			});
			*/
		}
	}
}
var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
var ipReg = /(^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\.(25[0-4]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])$)/;
//创建
function client_add(d) {
	var ip_section = 1;
	var mac_address = 1;
	var ip_section1 = 1;
	var mac_address1 = 1;
	var pass = 1;
	var no_pass = "";
	var val = $("#c_n").val();
	var $i = $("#c_n").next('i.v-check');
	if (val == "") {
		_alert(2, '客户端集合操作', '名称不能为空',$("#c_n"));
		return false;

	} else if (!nameReg.test(val)) {
		_alert(2, '客户端集合操作', '名称不符合要求',$("#c_n"));
		return false;
	}
	var v2 = $("#ip_n_c1").find("span[class='ss ss-add']").children("input").val().trim();
	if (v2=='' && !$(">span[class='ss']", "#ip_n_c1").length) {
		ip_section1 = 0;
	}
	var ip_n_c1_len = $('#ip_n_c1').children('span').length;
	$('#ip_n_c1').children('span').each(function(i,item){
		if (ip_section1 == 0){
			return true;
		}
		var input1 = $(item).find('input').val();
		if (i == 0 && input1 == "" && ip_n_c1_len != 1){
			return true;
		}
		if (input1 == ""){
			pass = 0;
			_alert(2, '客户端集合操作', 'IP地址不能为空', $(item).find('input'));
			return false;
		}
		if (!ipReg.test(input1)) {
			pass = 0;
			_alert(2, '客户端集合操作', 'IP地址格式错误', $(item).find('input'));
			return false;
		}
		$('#ip_n_c1').children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var input2 = $(item1).find('input').val();
			if (input2 == ""){
				pass = 0;
				_alert(2, '客户端集合操作', 'IP地址不能为空', $(item1).find('input'));
				return false;
			}
			if (!ipReg.test(input2)) {
				pass = 0;
				_alert(2, '客户端集合操作', 'IP地址格式错误', $(item1).find('input'));
				return false;
			}
			if (input1 == input2){
				pass = 0;
				_alert(2,"客户端集合操作","IP地址重复",$(item).find('input'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	if (pass == 0){
		return false;
	}
	var v = $("#ip_n_c").find("span[class='ss ss-add']").children("input").first().val().trim();
	var v1 = $("#ip_n_c").find("span[class='ss ss-add']").children("input").last().val().trim();

	if (v=="" && v1 == "" && !$(">span[class='ss']", "#ip_n_c").length) {
		ip_section = 0;
	}
	var ip_n_c_len = $("#ip_n_c").children('span').length;
	$("#ip_n_c").children('span').each(function(i,item){
		if (ip_section == 0){
			return true;
		}
		var ip_input1 = $(item).find('input:eq(0)').val();
		var ip_input2 = $(item).find('input:eq(1)').val();
		if (i == 0 && ip_input1 == "" && ip_input2 == "" && ip_n_c_len != 1){
			return true;
		}
		if (ip_input1 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '起始IP为空', $(item).find('input:eq(0)'));
			return false;
		} else if (!ipReg.test(ip_input1)) {
			pass = 0;
			_alert(2, '客户端集合操作', '起始IP格式错误', $(item).find('input:eq(0)'));
			return false;
		}
		if (ip_input2 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '结束IP为空',$(item).find('input:eq(1)'));
			return false;
		} else if (!ipReg.test(ip_input2)) {
			pass = 0;
			_alert(2, '客户端集合操作', '结束IP格式错误', $(item).find('input:eq(1)'));
			return false;
		}
		var r_v = _compare_ip(ip_input1,ip_input2);
		if (r_v != 3){
			pass = 0;
			_alert(2, '客户端集合操作', '起始IP不能大于等于结束IP', $(item).find('input:eq(0)'));
			return false;
		}
		$("#ip_n_c").children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var ip1_input1 = $(item1).find('input:eq(0)').val();
			var ip1_input2 = $(item1).find('input:eq(1)').val();
			if (ip1_input1 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '起始IP为空', $(item1).find('input:eq(0)'));
				return false;
			} else if (!ipReg.test(ip1_input1)) {
				pass = 0;
				_alert(2, '客户端集合操作', '起始IP格式错误', $(item1).find('input:eq(0)'));
				return false;
			}
			if (ip1_input2 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '结束IP为空',$(item1).find('input:eq(1)'));
				return false;
			} else if (!ipReg.test(ip1_input2)) {
				pass = 0;
				_alert(2, '客户端集合操作', '结束IP格式错误', $(item1).find('input:eq(1)'));
				return false;
			}
			var r_v = _compare_ip(ip1_input1,ip1_input2);
			if (r_v != 3){
				pass = 0;
				_alert(2, '客户端集合操作', '起始IP不能大于等于结束IP', $(item1).find('input:eq(0)'));
				return false;
			}
			if (ip1_input1 == ip_input1 && ip_input2 == ip1_input2){
				pass = 0;
				_alert(2,"客户端集合操作","IP区间重复",$(item).find('input:eq(1)'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	if (pass == 0){
		return false;
	}
	
	var input_str = $("#MACAddress").find("span[class='ss ss-add']").children("input").val();
	if (input_str=='' && !$(">span[class='ss']", "#MACAddress").length) {
		mac_address = 0;
	}
	var mac_len = $('#MACAddress').children('span').length;
	$('#MACAddress').children('span').each(function(i,item){
		if (mac_address == 0){
			return false;
		}
		var input1 = $(item).find('input').val();
		if (i == 0 && input1 == "" &&  mac_len != 1){
			return true;
		}
		
		if (input1 == ""){
			pass = 0;
			_alert(2,"客户端集合操作","MAC地址不能为空",$(item).find('input'));
			return false;
		}
		if (!MACReg.test(input1)){
			pass = 0;
			_alert(2, '客户端集合操作', 'MAC地址格式错误',$(item).find('input'));
			return false;
		}
		$('#MACAddress').children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var input2 = $(item1).find('input').val();
			if (input2 == ""){
				pass = 0;
				_alert(2,"客户端集合操作","MAC地址不能为空",$(item1).find('input'));
				return false;
			}
			if (!MACReg.test(input2)){
				pass = 0;
				_alert(2, '客户端集合操作', 'MAC地址格式错误',$(item1).find('input'));
				return false;
			}
			if (input1 == input2){
				pass = 0;
				_alert(2,"客户端集合操作","MAC地址重复",$(item).find('input'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	
	if (pass == 0){
		return false;
	}
	
	var input_str1 = $("#MACAddress1").find("span[class='ss ss-add']").children("input").first().val().trim();
	var input_str2 = $("#MACAddress1").find("span[class='ss ss-add']").children('input').last().val().trim();
		
	if (input_str1 == "" && input_str2 == "" && !$(">span[class='ss']", "#MACAddress1").length) {
		mac_address1 = 0;
	}
	var mac1_len = $("#MACAddress1").children('span').length;
	$("#MACAddress1").children('span').each(function(i,item){
		if (mac_address1 == 0){
			return true;
		}
		var mac_input1 = $(item).find('input:eq(0)').val();
		var mac_input2 = $(item).find('input:eq(1)').val();
		if (i == 0 && mac_input1 == "" && mac_input2 == "" && mac1_len != 1){
			return true;
		}
		if (mac_input1 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '起始MAC地址为空',$(item).find('input:eq(0)'));
			return false;
		} else if (!MACReg.test(mac_input1)) {
			pass = 0;
			_alert(2, '客户端集合操作', '起始MAC地址格式错误',$(item).find('input:eq(0)'));
			return false;
		}
		if (mac_input2 == '') {
			pass = 0;
			_alert(2, '客户端集合操作', '结束MAC地址为空',$(item).find('input:eq(1)'));
			return false;
		} else if (!MACReg.test(mac_input2)) {
			pass = 0;
			_alert(2, '客户端集合操作', '结束MAC地址格式错误',$(item).find('input:eq(1)'));
			return false;
		}
		var r_v = _compare_mac(mac_input1,mac_input2);
		if (r_v != 3){
			pass = 0;
			_alert(2, '客户端集合操作', '开始MAC地址不能大于等于结束MAC地址',$(item).find('input:eq(0)'));
			return false;
		}
		
		$("#MACAddress1").children('span').not($(item)).each(function(i1,item1){
			if (i1 < i){
				return true;
			}
			var mac1_input1 = $(item1).find('input:eq(0)').val();
			var mac1_input2 = $(item1).find('input:eq(1)').val();
			if (mac1_input1 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '起始MAC地址为空',$(item1).find('input:eq(0)'));
				return false;
			} else if (!MACReg.test(mac1_input1)) {
				pass = 0;
				_alert(2, '客户端集合操作', '起始MAC地址格式错误',$(item1).find('input:eq(0)'));
				return false;
			}
			if (mac1_input2 == '') {
				pass = 0;
				_alert(2, '客户端集合操作', '结束MAC地址为空',$(item1).find('input:eq(1)'));
				return false;
			} else if (!MACReg.test(mac1_input2)) {
				pass = 0;
				_alert(2, '客户端集合操作', '结束MAC地址格式错误',$(item1).find('input:eq(1)'));
				return false;
			}
			var r_v = _compare_mac(mac1_input1,mac1_input2);
			if (r_v != 3){
				pass = 0;
				_alert(2, '客户端集合操作', '开始MAC地址不能大于等于结束MAC地址',$(item1).find('input:eq(0)'));
				return false;
			}
			if (mac1_input1 == mac_input1 && mac1_input2 == mac_input2){
				pass = 0;
				_alert(2,"客户端集合操作","MAC地址区间重复",$(item).find('input:eq(1)'));
				return false;
			}
		});
		if (pass == 0){
			return false;
		}
	});
	if (pass == 0){
		return false;
	}
	
	if (mac_address == 0 && ip_section == 0 && mac_address1==0 && ip_section1==0) {
		_alert(2, "客户端集合操作", "IP地址/区间、MAC地址/区间不能同时为空", $("#ip_n_c1").find("span[class='ss ss-add']").children("input"));
		return false;
	}

	if (pass == 1) {
		//var clientId = document.frm_client_add.clientId.value;
		client_set.ClientScopeId = clientId;
		client_set.ClientScopeName = val;
		client_set.IPList.Set = new Array();
		client_set.MACList.Set = new Array();
		var i = 1;
		var $all=$('#ip_n_c').find('span[class=ss]');
		var len=$all.length;
		for(j=len-1;j>=0;j--){
			var ip_id =$all.eq(j).attr("value");
			var input1 = $all.eq(j).find("input").eq(0).val();
			var input2 = $all.eq(j).find("input").eq(1).val();
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + input1 + '","EndIP":"' + input2 + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}

		if (v != "" && v1 != "") {
			ip_id = $("#ip_span").attr("value");
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + v + '","EndIP":"' + v1 + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}
		var $all=$('#ip_n_c1').find('span[class=ss]');
		var len=$all.length;
		for(var j=len-1;j>=0;j--){
			var ip_id = $all.eq(j).attr("value");
			var ip_str =  $all.eq(j).find("input").val();
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + ip_str + '","EndIP":"' + ip_str + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}

		if (v2 != "") {
			ip_id = $("#ip_span1").attr("value");
			var json_a = '{"IPSetMemberId":' + ip_id + ',"Order":' + (i) + ',"StartIP":"' + v2 + '","EndIP":"' + v2 + '"}';
			client_set.IPList.Set.push(JSON.parse(json_a));
			i++;
		}
		var i = 1;
		var $all=$("#MACAddress").find('span[class=ss]');
		var len=$all.length;
		for(var j=len-1;j>=0;j--){
			var mac_id = $all.eq(j).attr("value");
			var mac_str = $all.eq(j).find("input").val();
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + mac_str + '","EndMACAddress":"' + mac_str + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++;
		}

		if (input_str != "") {
			var mac_id = $("#MACAddress").find('.ss-add').attr("value");
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + input_str + '","EndMACAddress":"' + input_str + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++
		}
		var $all=$('#MACAddress1').find('span[class=ss]');
		var len=$all.length;
		for(var j=len-1;j>=0;j--){
			var mac_id = $all.eq(j).attr("value");
			var mac_0 = $all.eq(j).find("input").eq(0).val();
			var mac_1 = $all.eq(j).find("input").eq(1).val();
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' +mac_0 + '","EndMACAddress":"' +mac_1 + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++;
		}

		if(input_str1!="" && input_str2!=''){
			var mac_id = $("#MACAddress1").find('.ss-add').attr("value");
			var json_a = '{"MACSetMemberId":' + mac_id + ',"Order":' + (i) + ',"StartMACAddress":"' + input_str1 + '","EndMACAddress":"' + input_str2 + '"}';
			client_set.MACList.Set.push(JSON.parse(json_a));
			i++;
		}
		client_set.IsApplyToServerScope = false;
		save_client(client_set,d);
	}
}

//加入ip
function _addIp_c1(obj) {
	var pass = 1;
	var v = $(obj).prev('input').val().trim();
	if (v == '') {
		_alert(1,"客户端集合", 'IP不能为空',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	} else if (!ipReg.test(v)) {
		_alert(1,"客户端集合", 'IP格式错误',$(obj).prev('input'));
		//$(obj).prev('input').val("");
		return false;
	} else {
		$(">span[class='ss']", "#ip_n_c1").each(function () {
			ip_str = $(this).find("input").val();
			if (ip_str == v) {
				_alert(1,"客户端集合", 'IP重复',$(obj).prev('input'));
				//$(obj).prev('input').val("");
				pass = 0;
				return false;
			}
		});
	}
	var ip_id = $("#ip_span1").attr("value");
	if (pass == 1) {
		var $c = $('<span class="ss" style="float:left;position:static;padding: 0 0 10px 0;width:195px;" value=' +ip_id + '/>');
		$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="' + v+ '">'
		+'<i class="ctr ctr-del" onclick="_delIp(this)"  style="margin-top: 5px;margin-left: -3px;"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').focus();
		$("#ip_span1").attr("value", "0");
	}
	initformlist();
}

//加入ip
function _addIp_c(obj) {
	var pass =1;
	var v1 = $(obj).prev().val().trim();
	var v = $(obj).prev().prev().prev().val().trim();
	
	if (v == '') {
		_alert(1,"客户端集合", '起始IP不能为空', $(obj).prev().prev().prev());
		//$(obj).prev().prev().prev().val("");
		return false;
	} else if (!ipReg.test(v)) {
		_alert(1,"客户端集合", '起始IP格式错误', $(obj).prev().prev().prev());
		//$(obj).prev().prev().prev().val("");
		return false;
	}
	if (v1 == '') {
		_alert(1,"客户端集合", '结束IP不能为空',$(obj).prev());
		//$(obj).prev().val("");
		return false;
	} else if (!ipReg.test(v1)) {
		_alert(1,"客户端集合", '结束IP格式错误',$(obj).prev());
		//$(obj).prev().val("");
		return false;
	}
	if(v==v1){
		_alert(1,"客户端集合", '起始IP不能大于等于结束IP',$(obj).prev().prev().prev());
		//$(obj).prev().prev().prev().val("");
		return false;
	}
	//add zero
	var v_str = v.split(".");
	var v1_str = v1.split(".");
	for (var i = 0; i < 4; i++) {
		if (parseInt(v_str[i]) > parseInt(v1_str[i])) {
			_alert(1,"客户端集合", '起始IP不能大于等于结束IP',$(obj).prev().prev().prev());
			return false;
		}else if (parseInt(v_str[i]) < parseInt(v1_str[i])) {
			break;
		}
	}
	$('>span[class=ss]','#ip_n_c').each(function(){
		var input1=$(this).find('input').eq(0).val();
		var input2=$(this).find('input').eq(1).val();
		if(input1==v && input2==v1){
			_alert(1,"客户端集合",'IP区间重复', $(obj).prev().prev().prev())
			pass=0;
			return false;
		}
	});
	if(pass==1){
		var ip_id = $("#ip_span").attr("value");
		var $c = $('<span class="ss" value="' + ip_id + '" style="float:left;width: 340px;position:static;padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text" style="width:123px;padding-right: 8px;"value="'+v+'">'
		+'<span style="vertical-align:middle;padding-left: 5px;    padding-right: 4px;">-</span>'
		+'<input type="text" class="form-text" style="width:123px;padding-right: 8px;" value="'+v1+'">'
		+'<i class="ctr ctr-del" onclick="_delIp(this)" style="margin-top: 5px;margin-left: -3px;"></i>');
		$(obj).parent().after($c);
		$(obj).prev().val("");
		$(obj).prev().prev().prev().val("");
		 $(obj).prev().prev().prev().focus();
		$("#ip_span").attr("value", "0");
	}
	initformlist();
}

function _addMAC(obj) {
	var pass = 1;
	var v = $(obj).prev('input').val().trim();

	if (v == '') {
		_alert(2,"客户端集合", "MAC地址不能为空",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else if (!MACReg.test(v)) {
		_alert(2,"客户端集合", "MAC地址格式错误",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else {
		$(">span[class='ss']", "#MACAddress").each(function () {
			mac_str = $(this).find("input").val();
			if (mac_str == v) {
				_alert(2,"客户端集合", "MAC地址重复",$(obj).prev('input'))
				//layer.alert('MAC重复！',{icon: 2});
				//$(obj).prev('input').val("");
				pass = 0;
				return false;
			}
		});
	}
	var mac_id = $(obj).parent().attr("value");
	if (pass == 1) {
		var $c = $('<span class="ss" value="' +  mac_id + '" style="float:left;position:static;width: 190px;padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text" style="width:138px;padding-right: 8px;" value="' + v + '">'
		+'<i class="ctr ctr-del" style="    margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').focus();
	}
	initformlist();
}

function _addMAC1(obj) {
	var pass = 1;
	var v1 = $(obj).prev('input').val().trim();
	var v = $(obj).prev('input').prev().prev('input').val().trim();
	
	if (v == '') {
		_alert(2,"客户端集合", "起始MAC地址不能为空",$(obj).prev('input').prev().prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else if (!MACReg.test(v)) {
		_alert(2,"客户端集合", "起始MAC地址格式错误",$(obj).prev('input').prev().prev('input'))
		//$(obj).prev('input').val("");
		return false;
	}
	if (v1 == '') {
		_alert(2,"客户端集合", "结束MAC地址不能为空",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	} else if (!MACReg.test(v1)) {
		_alert(2,"客户端集合", "结束MAC地址格式错误",$(obj).prev('input'))
		//$(obj).prev('input').val("");
		return false;
	}
	if (v == v1) {
		_alert(1,"客户端集合", '起始MAC地址不能大于等于结束MAC地址',$(obj).prev('input').prev().prev('input'));
		return false;
	}
	var v_str = v.split(':');
	var v1_str = v1.split(':');
	for (var i = 0; i < 6; i++) {
		if (parseInt(v_str[i], 16) > parseInt(v1_str[i], 16)) {
			_alert(1,"客户端集合", '起始MAC地址不能大于等于结束MAC地址',$(obj).prev('input').prev().prev('input'));
			return false;
		}else if (parseInt(v_str[i], 16) < parseInt(v1_str[i], 16)) {
			break;
		}
	}
	$('>span[class=ss]','#MACAddress1').each(function(){
		var input1=$(this).find('input').eq(0).val();
		var input2=$(this).find('input').eq(1).val();
		if(input1==v && input2==v1){
			_alert(1,"客户端集合",'MAC区间重复', $(obj).prev().prev().prev())
			pass=0;
			return false;
		}
	});
	
	if (pass == 1) {
		var mac_id = $(obj).parent().attr("value");
		var $c = $('<span class="ss" value="' + mac_id  + '" style="float:left;width: 350px;position: static;padding: 0 0 10px 0;"/>');
		$c.html('<input type="text" class="form-text" value="' + v + '" style="width:138px;padding-right: 8px;;">'
		+'<span style="vertical-align:middle;padding-left: 5px;padding-right: 5px;">-</span>'
		+'<input type="text" class="form-text" value="' + v1 + '" style="width:138px;padding-right: 8px;;">'
		+'<i class="ctr ctr-del" style="margin-top: 4px;margin-left: -3px;" onclick="_delMAC(this)"></i>');
		$(obj).parent().after($c);
		$(obj).prev('input').val("");
		$(obj).prev('input').prev().prev('input').val("");
		$(obj).prev('input').prev().prev('input').focus();
	}
	initformlist();
}

function _delMAC(obj) {
	var $c = $(obj).parent();
	$c.remove();
}

//删除ip
function _delIp(obj) {
	var $c = $(obj).parent();
	$c.remove();
}

function save_client(client_set,d) {
	var msstr = aceg(JSON.stringify(client_set),sess);
	$.ajax({
		url: '/bhost/add_client',
		type: "POST",
		async: false,
		data: { a0: sess, a1: JSON.stringify(client_set), a2: "0", a3: "null" ,m1:msstr},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result == true) {
				parent.layer.open({
					type: 1,
					title: '客户端集合',
					content: '<div class="layer-alert"><i class="alert succ"></i>操作成功</div>',
					btn: ['确&nbsp;&nbsp;定'],
					btnAlign: 'c',
					closeBtn: false,
					skin: 'layer-custom',
					area: ['380px', '310px'],
					move: false,
					resize: false,
					yes: function (i) {
						parent.layer.close(i);
						var client_text = $('#accset').find('span').text();
						$("div[data-id=xSelect-client]").remove();
						$('#accset').empty().data('xSelect','');
						bind_client_xSelect();
						if ($("#accset").data('value') == "-1" || $("#accset").data('value') == undefined){
							$("#accset").data('value',result.ClientScopeId);
							$("#accset").find('span').text(client_set.ClientScopeName);
							client_list.splice(0,1,result.ClientScopeId);
						}else{
							$('#accset').find('span').text(client_text);
						}
						d.close().remove();
					}
				});
			} else {
				_alert(1,"客户端集合", "客户端集合操作失败:"+result.ErrMsg,$("#c_n"));
				return false;
			}
		}
	});
}

var MACReg = /([A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2}/;
function _autoHeight(){
	var arr = new Array();
	$('div.g-sort:first>div.g-items').each(function(){
		var h = $(this).children('div.g-cont').height();
		arr.push(h);
	});

	var maxh = Math.max.apply( Math, arr);
	$('div.g-sort:first>div.g-items').height(maxh + 45);
}

function _compare_mac(x,y){
	var start_mac1_arry = x.split(':');
	var start_mac2_arry = y.split(':');
	var start_mac1_num = "";
	var start_mac2_num = "";
	for (var mac_i = 0; mac_i < 6; mac_i++){
		start_mac1_num = start_mac1_num + start_mac1_arry[mac_i];
	}
	for (var mac_i = 0; mac_i < 6; mac_i++){
		start_mac2_num = start_mac2_num + start_mac2_arry[mac_i];
	}
	var start_mac1_d = parseInt(start_mac1_num,16);
	var start_mac2_d = parseInt(start_mac2_num,16);
	if (start_mac1_d == start_mac2_d){
		return 1;
	}else if (start_mac1_d > start_mac2_d){
		return 2;
	}else{
		return 3;
	}
}

//获取头像列表
function _getAvatarList(obj){
	var offset = $(obj).offset();
	$('#avatars').css({
		top:offset.top -5,
		left:offset.left -5
	}).show();

	document.onclick = null;

	$('#avatars').hover(function(){
		document.onclick = null;
	},function(){
		document.onclick = function(){
			$('#avatars').fadeOut();
		}
	})
}
//设置头像
function _setAvatar(obj){
	var src = $(obj).children('img').attr('src');
	$(obj).addClass('active').parent().siblings('li').children('a').removeClass('active');
	$('#tAvatar>img').attr('src',src);
	$('#avatars').fadeOut();
	photo = src.split('/')[3];
}

$(window).resize(function(){
	if($('#avatars').is(':visible')){
		var offset = $('#tAvatar').offset();
		$('#avatars').css({
			top:offset.top -5,
			left:offset.left -5
		});
	}
})
	//------------------------创建界面end

	//------------------------列表界面
function user_manage(){
    document.frm_user.tasktype.value = 2;
	document.frm_user.a0.value = sess;
    document.frm_user.action = '/bhost/user_p';
    document.frm_user.submit();
}
var global_filter_n  = "";
var filter_flag = false;
function _addFilterFuzzy(obj,type,flag){
	var id = $('#user_select').children('option:selected').val();
	var v1 = $('#user_select').children('option:selected').text();
	if(v1 == '用户状态'){
		var v2 = $("#user_status").val();
	}else{
		var v2 = $("#gjz").val();
	}
	if(id=='0'){
		v1='';
	}else{
		v1=v1+'-';
	}
	if(v2 == '' && v1 != '用户状态-' && flag != 1){
		$("#gjz").focus();
		_alert(2,"用户管理","关键字为空",$("#gjz"));
		return false;
	}else{
		if(type == false){//直接检索
			if(global_filter.indexOf(id+'-'+v2+'\t') >= 0){
				$("#gjz").focus();
				_alert(1,"用户管理","已存在相同的搜索条件",$("#gjz"));
				return false;
			}
			// global_filter_n = "";
			filter_flag = true;
			if(v2 == ""){
				global_filter_n = "";
			}else{
				global_filter_n = id+'-'+v2;
			}
			$("#gjz").focus();
		}else{
			if(global_filter.indexOf(id+'-'+v2+'\t') >= 0){
				$("#gjz").focus();
				_alert(1,"用户管理","已存在相同的搜索条件",$("#gjz"));
				return false;
			}
			$('#filterWW>ul').append('<li><span class="ww" name="" data=\"'+id+'-'+v2.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/ /g, "&nbsp;")+'\">'+v1+v2+'</span><i class="del" onclick="_delFilter(this)"></i></li>')
			filter_flag = true;
			var filter=global_filter;
			filter=filter+id+'-'+v2+'\t'
			global_filter = filter;
			global_filter_n = "";
			$("#gjz").val('');
			$('#v_clear').hide();
			$("#gjz").focus();
		}
		var c = $("#route-root").next().children().length;
		if(c == 0){
			global_pid = 0;
			global_piid = "route-root";
		}
		else{
			c = $("#route-root").next().children().last();
			global_pid = c[0].id.split('-')[2];
			global_piid = c[0].id;			
		}
		selView();
		// $("#gjz").val('');
	}
}
//删除关键字
function _delFilter(obj){
	var id = $(obj).parent().find("span");
	var v2_str = $(id).eq(0).text();
	var str = 'Name' + '-' + v2_str;
	var filter = global_filter;
	var filter_str = filter.split("\t");
	var i2 = 0;
	var search_str="";
	$.each(filter_str,function(i,item){
		if(i2 == 0 && item.split('-')[1] == v2_str){
			i2 = 1;
		}else if(item != ""){
			search_str = search_str + item + '\t';
		}
	})
	global_filter = search_str;
	var c = $("#route-root").next().children().length;
	if(c == 0){
		global_pid = 0;
		global_piid = "route-root";
	}
	else{
		c = $("#route-root").next().children().last();
		global_pid = c[0].id.split('-')[2];
		global_piid = c[0].id;			
	}
	$(obj).parent().remove();
	selView();
}
function _clearFilterFuzzy(obj,num){
	if(num==1){
		$('#gjz').val('');
		$('#v_clear').hide();
		global_filter_n='';
		filter_flag = true;
		refresh();
		_waitDone($(".waitTip"));
		selView(1);
		return false;
	}
	$('#clearFilter1').next().children('ul').empty();
	$('#clearFilter1').hide();
	global_filter='';
	global_filter_n='';
	filter_flag = false;
	_waitDone($(".waitTip"));
	refresh();
	selView(1);
}
function change_select(type_text){
	type_value = $("#user_select").val();
	if(type_text == ""){
		$("#user_select").empty().append('<option value="0" >所有</option><option value="ugname">用户组名</option><option value="usercode">账号</option><option value="username">姓名</option><option value="description">描述</option><option value="usernumber">工号</option><option value="department">部门</option><option value="phone">手机</option><option value="rolename">角色名</option><option value="adminname">管理员账号</option>');
	}else if(type_text.indexOf( "用户组名") >=0){
		$("#user_select").empty().append('<option value="0" >所有</option><option value="ugname">用户组名</option><option value="adminname">管理员账号</option>');				
	}else{
		$("#user_select").empty().append('<option value="0" >所有</option><option value="usercode">账号</option><option value="username">姓名</option><option value="description">描述</option><option value="usernumber">工号</option><option value="department">部门</option><option value="phone">手机</option><option value="rolename">角色名</option><option value="adminname">管理员账号</option>');
	}
	$("#user_select").val(type_value).trigger('change');
}
function selView(typ){
	typ = typ | "";
	var $sel = $('#filterWW');
	var len = $('li',$sel).length;

	if(len == 0){
		$sel.hide();
		$('#clearFilter1').hide();
	}else if(len == 1){
		$("#filterWW").show();
		$('>span.ww',$sel).show();
		$('#clearFilter1').show();
		$sel.addClass('selector-multiple');
	}else{
		$("#filterWW").show();
		$('>span.ww',$sel).show();
		$('#clearFilter1').show();
		$sel.addClass('selector-multiple');
	}
	
	//filter_all();
	var flag_hgname = false;
	var flag_all_count = 0;
	if(len == 0){
		change_select('');
	}else{
		$("#filterWW li span").each(function(i,item){
			if($(this).attr("data").indexOf('ugname') >=0){
				flag_hgname = true;
				return false;
			}
			if($(this).attr("data").indexOf('0-') ==0){
				flag_all_count +=1;
			}
		})
		if(flag_hgname == true){
			change_select('用户组名');
		}else if(flag_all_count == $("#filterWW li span").length){
			change_select('');
		}else{
			change_select('用户');
		}
	}
	if(typ == 0) find_list();
}

$(function(){
	_initList();
	_initSize();
});

$(window).resize(function(){
	_initSize();
	_pathWrap();
});

var	firstData_user = [];
var	firstData_group = [];

//刷新当前页面
function refresh(){
	var new_id = 0;
	$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-g-cut']").attr("class","h-bicon h-bicon-g");
	$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-h-cut']").attr("class","h-bicon h-bicon-h");
	$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-l-cut']").attr("class","h-bicon h-bicon-l");
	$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-d-cut']").attr("class","h-bicon h-bicon-d");
	if(filter_flag == true){		//判断是否为过滤后页面
		find_list();
		return false;
	}else{
		var c = $("#route-root").next().children('a').length; //当前路径长度
		if(c == 0){		//当前为根目录
			$("#route-root").click();
			if($("#hostContent").find('.item').length == $("#hostCatelog").children('li').length){
				return true;
			}else{
				$.each($("#hostContent").find('.item'),function(i,item){
					var flag_1 = 0;
					new_id = 0;
					$.each($("#hostCatelog").children('li'),function(i1,item1){
						if($(item).children('.c').attr('id').split('-')[2] == $(item1).children('a').attr('id').split('-')[2]){
							flag_1 = 1;
							return false;
						}
					})
					if(flag_1 == 0){
						new_id = $(item).children('.c').attr('id').split('-')[2];
						var new_name = $(item).text();
						$("#hostCatelog").append('<li><i class="h-blank"></i><a href="javascript:;" auth="'+2+'" id="node-0-'+new_id+'" mem="0" title="'+new_name+'"><i class="h-eicon h-eicon-g"></i><span>'+new_name+'</span></a></li>');
						return false;
					}
				})
			}
		}
		else{
			$("#hostCatelog").find("a[class='active']").click(); //通过点击左侧目录刷新
			var pId = $("#route-root").next().children().last().attr('id').split('route')[1];
			var $item = $("#node" +pId).prev('i');
			_getNode(0,$item);
		}
	}
	result_tmp = {
		total:0,
		finish:0,
		success:0,
		fail:0
	};
}

//获取子节点
function _getNode(i,obj){
		var id; // id
		filter_flag = false;
		if(i == 0){
			id = parseInt($(obj).next('a').attr('id').split('-')[2]);
			//获取 节点数据
			var group_data = [];
			var user_data = [];
			var loginusercode = window.parent.document.frm.us.value;
			var Memnum;
			$.ajax({
				url:"/bhost/get_ugroup_list",
				type:"POST",
				async:false,
				data:{a0:sess,a1:loginusercode,a2:id,a3:loginuserid,a9:0},
				success:function(result){ 
					var ugroup_result = JSON.parse(result);
					if(ugroup_result.Result == false){
						_alert(1,"用户管理","获取信息失败："+ugroup_result.info);
						return false;
					}
					else{
						result = ugroup_result.info;
						Memnum = result.totalrow;
						result = result.data;
						group_data = result.UGroup;
						user_data = result.User;
					}
				}
			})
			if($(obj).next('a').next('ul').length == 0){
				$(obj).next('a').after("<ul><p>Loading...</p></ul>");
			}
			var $_u = $(obj).next('a').next('ul');
			//已加载节点，返回不再插入节点数据
			// if($('li',$_u).length > 0){
			// 	return false;
			// }
			//
			$_u.unbind();
			$_u.empty();
			//Mode---> 1 查询权限  2---> 编辑
			//Selected != 0 显示 ==0 隐藏
			$(obj).next('a').attr('mem',Memnum);
			$.each(group_data,function(i,item){
				if(item.Mode == 2 || '{{us}}' == 'admin' || item.UGName == '未分组' || (item.Mode == 1)){
					display_none = ""
					if(item.Mode == 1){
						display_none = "display:none;";
						uglist.push(id + '-'+ item.UGId +"-false");
					}
					if(item.MemberNum > 0){
						$_u.append('<li style="'+display_none+'"><i class="h-aicon"/><a href="javascript:;" id="node-'+id+'-'+item.UGId+'" auth="'+item.Mode+'"  mem="'+item.MemberNum+'" title="'+item.UGName+'"><i class="h-eicon h-eicon-g'+disabled_class+'"></i><span>'+item.UGName+'</span></a><ul><p>Loading...</p></ul></li>');
					}else{
						$_u.append('<li style="'+display_none+'"><i class="h-blank"/><a href="javascript:;" id="node-'+id+'-'+item.UGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'" title="'+item.UGName+'"><i class="h-eicon h-eicon-g'+disabled_class+'"></i><span>'+item.UGName+'</span></a></li>');
					}
				}
			});
			if(group_data == null){
				group_data = [];
			}
			if(group_data.length > 0){
				if ($(obj).attr('class') == 'h-blank')
					$(obj).attr('class','h-aicon');
			}else{
				$(obj).attr('class','h-blank');
			}
			//
			select_checkbox();
		}
		else{
            parent_id = $(obj).attr('id');
            
			id_list = $(obj).attr('id').split('-');
            iid = id_list[1];
            global_id = id_list[2];
			if(iid == 'root'){
				id = 0;
			}else{
				id = id_list[2];
			}
			//获取 节点数据
			var group_data = [];
			var user_data = [];
			var loginusercode = window.parent.document.frm.us.value;
			$.ajax({
				url:"/bhost/get_ugroup_list",
				type:"POST",
				async:false,
				data:{a0:sess,a1:loginusercode,a2:id,a3:loginuserid,a9:0},//////////
				success:function(result){ 
					var ugroup_result = JSON.parse(result);
					if(ugroup_result.Result == false){
						_alert(1,"用户管理","获取信息失败："+ugroup_result.info);
						return false;
					}
					else{
						result = ugroup_result.info;
						result = result.data;
						group_data = result.UGroup;
						user_data = result.User;
					}
				}
			})
			var $_c = $('#hostContent');
			if (first_grp == '0') {
				$_c.unbind();
				$('div.item', $_c).remove();
			}  
			clear_filter();
			$('#user_select').val('0').trigger('change');
			list_or_ico();
			//Mode---> 1 查询权限  2---> 编辑
			//Selected != 0 显示 ==0 隐藏
			$.each(group_data,function(i,item){
				if(item.Mode == 2 || '{{us}}' == 'admin'|| item.UGName == '未分组' || (item.Mode == 1)){
					display_none = ""
					if(item.Mode == 1){
						display_none = "display:none;";
						uglist.push(id + '-'+ item.UGId +"-false");
					}
					if (first_grp == '0') {
						$_c.append('<div class="item" style="'+display_none+'"><div class="c" id="cnode-'+id+'-'+item.UGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'" type="'+item.Mode+'"><i class="h-bicon h-bicon-g'+disabled_class+'"></i><span>'+item.UGName+'</span></div></div>');
					}
					else{
						$('#user_list_').append('<tr style="'+display_none+'">' +
							'<td class="in">' +
							'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((item.UGName == '未分组' || item.Mode < 2 || if_disable == '1') ? 'disabled' : '') + '>' +
							'<div class="item" style="' + display_none + '"><div class="c" id="cnode-' + id + '-' + item.UGId + '" auth="' + item.Mode + '" mem="' + item.MemberNum + '" type="' + item.Mode + '"><i class="h-bicon h-bicon-g' + disabled_class + '"></i><span>' + item.UGName +'</span></div></div>' +
							'</td>' +
							'<td title="' + item.UGName + '">' + item.UGName + '</td>' +
							'<td title="用户组">用户组</td>' +
							'<td title="'+(item.AdminSet||'')+'">'+(item.AdminSet||'')+'</td>' +
							'<td title=""></td>' +
							'<td><div class="tab-ctr">' +
							'<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + ' ' + ((item.UGName == '未分组') ? 'disabled' : '') + '" id="' +
							((item.UGName == '未分组') ? '' : '_edit') + '" title="' + ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
							'<a href="javascript:;" style="width:8px;" class="copy ' + ((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
							((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                            '<a href="javascript:;" style="width:8px;" class="cut ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                            ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
							'<a href="javascript:;" style="width:8px;" class="transfer disabled" id="" title="交接"></a>' +
                            '<a href="javascript:;" style="width:8px;" class="del ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                            ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
							'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>' +
							'</div></td>' +
							'</tr>');
					}

				}
			})
			$.each(user_data,function(i,item){
				if(item.UserCode =='admin') return true;
				if((item.Mode == 2 && item.UserCode != '{{us}}') || '{{us}}' == 'admin'){
					if(item.UserStatus == 0 || item.UserStatus == 6){
						if (first_grp == '0') {
							$_c.append('<div class="item"><div class="c" id="cnode-'+id+'-'+item.UserId+'" type="'+item.Mode+'"><i class="h-bicon h-bicon-d'+disabled_class+'"></i><span>'+item.UserCode+'</span></div></div>');
						}
						else{
							$('#user_list_').append('<tr>'+
							'<td class="in">'+
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') +'>'+
								'<div class="item"><div class="c" id="cnode-' + id + '-' + item.UserId + '" type="' + item.Mode + '"><i class="h-bicon h-bicon-d' + disabled_class + '"></i><span>' + item.UserCode +'</span></div></div>'+
							'</td>'+
							'<td title="'+item.UserCode+'">'+item.UserCode+'</td>'+
							'<td title="用户">用户</td>'+
							'<td title="' + item.AdminSet +'">'+ item.AdminSet+'</td>'+
							'<td title="停用">停用</td>'+
							'<td><div class="tab-ctr">'+
                                '<a href="javascript:;" style="width:8px;" class="'+((if_disable == '1' || item.Mode<2)?'search_result':'edit')+'" id="_edit" title="'+
                                ((if_disable == '1' || item.Mode < 2)?'查看':'修改')+'"></a>'+
								'<a href="javascript:;" style="width:8px;" class="copy '+((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2)?'disabled':'')+'" id="'+
								((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2)?'':'_copy')+'" title="复制"></a>'+
                                '<a href="javascript:;" style="width:8px;" class="cut '+((if_disable == '1' || item.Mode < 2)?'disabled':'')+'" id="'+
                                ((if_disable == '1' || item.Mode < 2)?'':'_cut')+'" title="剪切"></a>'+
                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') +'" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') +'" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del '+((if_disable == '1' || item.Mode < 2)?'disabled':'')+'" id="'+
                                ((if_disable == '1' || item.Mode < 2)?'':'_del')+'" title="删除"></a>'+
								'<a href="javascript:;" style="width:8px;" class="move '+((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2)?'disabled':'')+'" id="'+
								((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2)?'':'_remove')+'" title="移除"></a>'+
							'</div></td>'+
						'</tr>');
						}
					}else if(item.UserStatus == 2){
						if (first_grp == '0') {
							$_c.append('<div class="item"><div class="c" id="cnode-'+id+'-'+item.UserId+'" type="'+item.Mode+'"><i class="h-bicon h-bicon-l'+disabled_class+'"></i><span>'+item.UserCode+'</span></div></div>');
						}
						else{
							$('#user_list_').append('<tr>'+
							'<td class="in">'+
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') +'>'+
								'<div class="item"><div class="c" id="cnode-' + id + '-' + item.UserId + '" type="' + item.Mode + '"><i class="h-bicon h-bicon-l' + disabled_class + '"></i><span>' + item.UserCode +'</span></div></div>'+
							'</td>'+
							'<td title="'+item.UserCode+'">'+item.UserCode+'</td>'+
							'<td title="用户">用户</td>'+
							'<td title="' + item.AdminSet +'">'+ item.AdminSet+'</td>'+
							'<td title="锁定">锁定</td>'+
							'<td><div class="tab-ctr">'+
                                '<a href="javascript:;" style="width:8px;" class="'+((if_disable == '1' || item.Mode < 2)?'search_result':'edit')+'" id="_edit" title="'+
                                ((if_disable == '1' || item.Mode < 2)?'查看':'修改')+'"></a>'+
								'<a href="javascript:;" style="width:8px;" class="copy '+((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2)?'disabled':'')+'" id="'+
								((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2)?'':'_copy')+'" title="复制"></a>'+
                                '<a href="javascript:;" style="width:8px;" class="cut '+((if_disable == '1' || item.Mode < 2)?'disabled':'')+'" id="'+
                                ((if_disable == '1' || item.Mode < 2)?'':'_cut')+'" title="剪切"></a>'+
                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del '+((if_disable == '1' || item.Mode < 2)?'disabled':'')+'" id="'+
                                ((if_disable == '1' || item.Mode < 2)?'':'_del')+'" title="删除"></a>'+
								'<a href="javascript:;" style="width:8px;" class="move '+((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2)?'disabled':'')+'" id="'+
								((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2)?'':'_remove')+'" title="移除"></a>'+
							'</div></td>'+
						'</tr>');
						}
					}else{
						if (first_grp == '0') {
							$_c.append('<div class="item"><div class="c" id="cnode-'+id+'-'+item.UserId+'" type="'+item.Mode+'"><i class="h-bicon h-bicon-h'+disabled_class+'"></i><span>'+item.UserCode+'</span></div></div>');
						}
						else {
							$('#user_list_').append('<tr>' +
								'<td class="in">' +
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
								'<div class="item"><div class="c" id="cnode-' + id + '-' + item.UserId + '" type="' + item.Mode + '"><i class="h-bicon h-bicon-h' + disabled_class + '"></i><span>' + item.UserCode +'</span></div></div>' +
								'</td>' +
								'<td title="' + item.UserCode + '">' + item.UserCode + '</td>' +
								'<td title="用户">用户</td>' +
							    '<td title="' + item.AdminSet +'">'+ item.AdminSet+'</td>'+
								'<td title="启用">启用</td>' +
								'<td><div class="tab-ctr">' +
                                '<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + '" id="_edit" title="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
								'<a href="javascript:;" style="width:8px;" class="copy ' + ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
								'<a href="javascript:;" style="width:8px;" class="move ' + ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? '' : '_remove') + '" title="移除"></a>' +
								'</div></td>' +
								'</tr>');
						}
					}
				}
			})

			var rpath;
			var rarr = new Array();
			var _getRoute = function(item){
                var tagname = $(item).parent().parent()[0].tagName;
                var tagname_id = $(item).parent().parent()[0].id;
				if(tagname.toLowerCase() == 'ul'){
					var iid = $(item).attr('id').split('-')[2];
					var id = parseInt($(item).attr('id').split('-')[1]);
					rarr.unshift('<a href="javascript:;" title="'+$(item).text()+'" id="route-'+id+'-'+iid+'">'+$(item).text()+'</a>');
                    // _getRoute($(item).parent().parent().prev());
                    if (tagname_id == 'hostCatelog') {
                        _getRoute($(item).parent().parent().parent().prev());
                    } else {
                        _getRoute($(item).parent().parent().prev());
                    }
				}else{
					rpath = rarr.join('<span class="fix" />');
				}
			}
			_getRoute(obj);
			if(id !=0) $('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a><div class="h-path-wrap">'+rpath+'</div>');
			else $('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a>');
			_pathWrap();
			list_initList();
			//clear_filter();
			_initHostMenu();
			//
			select_checkbox();
    }
}

//清空搜索条件
function clear_filter(){
	$('#filterWW').hide();
	global_filter = "";
	filter_flag = false;
	$('#clearFilter1').hide();
	$("#gjz").val('');
	$('#v_clear').hide();
	$("#filterWW").children().next().empty()
	global_piid = "";
}
var uglist = [];
//初始化右边列表
function _initList(){
	parent_id = 'route-root';
	filter_flag = false;
	var user_data = [];
	var group_data = [];
	var loginusercode = window.parent.document.frm.us.value;
	$.ajax({
		url:"/bhost/get_ugroup_list",
		type:"POST",
		async:false,
		data:{a0:sess,a1:loginusercode,a2:0,a3:loginuserid,a9:0},
		success:function(result){ 
		var ugroup_result = JSON.parse(result);
		if(ugroup_result.Result == false){
			_alert(1,"用户管理","获取信息失败："+ugroup_result.info);
		return false;
	}else{
			var result = ugroup_result.info;
			result = result.data;
			firstData_group = result.UGroup;
			firstData = group_data;
			firstData_user = result.User;
		}
		}
	})

	//$('#hostCatelog,#hostContent').empty();
	$('#hostCatelog').empty();
	clear_filter();
	$('#user_select').val('0').trigger('change');
	list_or_ico();
	$('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a>');
	_pathWrap();
	//Mode---> 1 查询权限  2---> 编辑
	//Selected != 0 显示 ==0 隐藏	
	$.each(firstData_group,function(i,item){
		if(item.Mode == 2 || '{{us}}' == 'admin'|| item.UGName == '未分组' || (item.Mode == 1)){
			display_none = ""
			if(item.Mode == 1){
				display_none = "display:none;";
				uglist.push("0" + '-'+ item.UGId +"-false");
			}
			if(item.MemberNum > 0){
				$('#hostCatelog').append('<li style="'+display_none+'"><i class="h-aicon" /><a href="javascript:;" id="node-0-'+item.UGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'" title="'+item.UGName+'"><i class="h-eicon h-eicon-g'+disabled_class+'"></i><span>'+item.UGName+'</span></a><ul><p>Loading...</p></ul></li>');
			}else{
				$('#hostCatelog').append('<li style="'+display_none+'"><i class="h-blank" /><a href="javascript:;" id="node-0-'+item.UGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'" title="'+item.UGName+'"><i class="h-eicon h-eicon-g'+disabled_class+'"></i><span>'+item.UGName+'</span></a></li>');
			}
			//$('#hostContent').append('<div class="item" style="'+display_none+'"><div class="c" id="cnode-0-'+item.UGId+'" auth="'+item.Mode+'" mem="'+item.MemberNum+'" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" type="'+item.Mode+'"><i class="h-bicon h-bicon-g'+disabled_class+'"></i>'+item.UGName+'</div></div>');		
			if(first_grp=='0'){
					$('#hostContent').append('<div class="item" style="' + display_none + '"><div class="c" id="cnode-0-' + item.UGId + '" auth="' + item.Mode + '" mem="' + item.MemberNum + '" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" type="' + item.Mode + '"><i class="h-bicon h-bicon-g' + disabled_class + '"></i>' + item.UGName + '</div></div>');		
			}else{
					$('#user_list_').append('<tr style="' + display_none + '">' +
					'<td class="in">' +
					'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2)? 'disabled' : '') + '>' +
					'<div class="item" style="' + display_none + '"><div class="c" id="cnode-0-' + item.UGId + '" auth="' + item.Mode + '" mem="' + item.MemberNum + '" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" type="' + item.Mode + '"><i class="h-bicon h-bicon-g' + disabled_class + '"></i>' + item.UGName + '</div></div>' +
					'</td>' +
					'<td title="' + item.UGName + '">' + item.UGName + '</td>' +
					'<td title="用户组">用户组</td>' +
					'<td title="'+(item.AdminSet||'')+'">'+(item.AdminSet||'')+'</td>' +
					'<td title=""></td>' +
					'<td><div class="tab-ctr">' +
					'<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + ' ' + ((item.UGName == '未分组') ? 'disabled' : '') + '" id="' +
					((item.UGName == '未分组') ? '' : '_edit') + '" title="' + ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
					'<a href="javascript:;" style="width:8px;" class="copy ' + ((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
					((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                    '<a href="javascript:;" style="width:8px;" class="cut ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                    ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                    '<a href="javascript:;" style="width:8px;" class="transfer disabled" id="" title="交接"></a>' +
                    '<a href="javascript:;" style="width:8px;" class="del ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                    ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
					'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>' +
					'</div></td>' +
					'</tr>');
			}
		}
	})
	/*
	$.each(firstData_user,function(i,item){
		if((item.Mode == 2 && item.UserCode != '{{us}}') || '{{us}}' == 'admin'){
			if(item.UserStatus == 0){
			$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.UserId+'"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-d'+disabled_class+'"></i>'+item.UserCode+'</div></div>');
			}else if(item.UserStatus == 2){
			$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.UserId+'"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-l'+disabled_class+'"></i>'+item.UserCode+'</div></div>');
			}else{
				$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.UserId+'"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-h'+disabled_class+'"></i>'+item.UserCode+'</div></div>');
			}
		}
	})
	*/
	list_initList();
	_initHostCatalog();
	_initHostMenu();
	_initRoute();
	//
	select_checkbox();
}
var g_ug_list = [];
///// 绑定 用户组状态
	var parent_id='';
function select_checkbox() {
	//var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
	if(uglist.length == 0) return false;
	var i = 0;
	var index_w = 0;
	var indx = 0;
	_showLoading();
	var m = [];
	var flag_se = false;
	if(g_ug_list.length ==0 ) flag_se = true;
	function _doselect() {
		for (i = index_w; i < index_w + 100; i+=100) { //每次只加载一个 根据情况定
			if (i >= uglist.length) {
				if (uglist.length == 0) {
					clearInterval(if_select);
					_closeLoading();
					return false;
				} else {
					index_w = 0;
					return false;
				}
			}
			if(flag_se == true){
				indxx = g_ug_list.indexOf(parseInt(uglist[i].split('-')[1]));
				if( indxx >= 0 ){
					ind = uglist.indexOf( uglist[i].split('-')[0] +'-' +uglist[i].split('-')[1]+'-false');
					if(ind >=0) uglist.splice(ind, 1);
					continue;
				}
			}
			
			
			var PGetHNodeSelected_json={
				"type":8,
				"id":loginuserid,
				"unodeset": new Array()
			}
			for(var m=i;m<i+100;m++){
				if(m>=uglist.length){
					break;
				}
				var pid = uglist[m].split("-")[0];
				var uid = uglist[m].split("-")[1];
				var falg_sec = uglist[m].split("-")[2];
				if(falg_sec == 'false'){
					PGetHNodeSelected_json.unodeset.push(JSON.parse('{"uid": '+uid+',"pid":'+pid+'}'));
					uglist[m] = pid+'-'+uid + "-" + "true";
				}
			}
			
			//if(m.length >= 20) continue;
			if(PGetHNodeSelected_json.unodeset.length>0){
				//uglist[i] = hg_id + ":" + "true";
				$.ajax({
					url: '/bhost/PGetUNodeSelected',
					type: 'post',
					async: true,
					data:{a0:sess,z1:JSON.stringify(PGetHNodeSelected_json)},//hg_id
					success: function (result) {
						var result = JSON.parse(result);
						var data = result.info;
						/*
							[
								{
									"uid": 3,
									"selected": 1  --0-未选中，1-部分选中，2-全部选中
									"pid":7
								}
							]
						*/
						$.each(data,function (i,item) {
							var flag_selected = item.selected;
							var curr_ugid = item.uid;
							var pugid = item.pid;
							if(curr_ugid == 1 || '{{us}}' == 'admin' ){
								$('#node-' + pugid + '-' + curr_ugid).parent().show();
								if (first_grp == '0') {
									$('#cnode-' + pugid + '-' + curr_ugid).parent().show();
								}else{
									$('#cnode-' + pugid + '-' + curr_ugid).parents('tr').show();
								}
							}else{
								if(flag_selected > 0){
									$('#node-' + pugid + '-' + curr_ugid).parent().show();
									if (first_grp == '0') {
										$('#cnode-' + pugid + '-' + curr_ugid).parent().show();
									}else{
										$('#cnode-' + pugid + '-' + curr_ugid).parents('tr').show();
									}
								}else{
									$('#cnode-' +pugid +'-'+curr_ugid).parent().hide();
									if (first_grp == '0') {
										$('#node-'+pugid +'-'+curr_ugid).parent().hide();
									}else{
										$('#cnode-' + pugid + '-' + curr_ugid).parents('tr').remove();
									}
								}
							}
							ind = uglist.indexOf(pugid +'-'+curr_ugid +'-true');
							if(ind >=0) uglist.splice(ind, 1);
							g_ug_list.push(curr_ugid);
						})
					},
					error: function (XmlHttpRequest, textStatus, errorThrown) {
						ind = uglist.indexOf(uglist[i].split('-')[0] +'-'+uglist[i].split('-')[1]+'-true');
						if(ind >=0) uglist.push(uglist[i].split('-')[0] +'-'+uglist[i].split('-')[1] +'-false');
						return false;
					}
				});
			}
		}
		index_w = i;
	}
	var if_select = setInterval(function(){
		if (uglist.length == 0){  //
			clearInterval(if_select);
			_closeLoading();
			return false;
		}
		_doselect();	
	},1);
}

//初始化左边菜单
function _initHostCatalog(){
	var $_root = $('.h-catelog');
	$_root.unbind().on('click','i.h-aicon',function(){
		filter_flag = false;
		var $_item = $(this).next('a');
		var c = $_item.attr('class');
		var $_u = $_item.next('ul');
		_getNode(0,this);
		if($_u.length == 1){
			if($_u.is(':visible')){
				$(this).removeClass('h-aicon-d');
				$_u.slideUp();
			}else{
				$(this).addClass('h-aicon-d');
				$_u.slideDown();
			}
		}
	}).on('dblclick','i.h-eicon,span',function(){
		filter_flag = false;
		var $item = $(this).parent().prev('i');
		_getNode(0,$item);
		var $_item = $item.next('a');
		var c = $_item.attr('class');
		var $_u = $_item.next('ul');
		if($_u.length == 1){
			if($_u.is(':visible')){
				$item.removeClass('h-aicon-d');
				$_u.slideUp();
			}else{
				$item.addClass('h-aicon-d');
				$_u.slideDown();
			}
		}
	}).on('click','a',function(){
		_hideMenu();
		$('a',$_root).removeClass('active');
		$(this).addClass('active');
		_getNode(1,this);
	});
	//
	//var $_root = $('#hostCatelog');
}
function _jScrollBar(scid) {
	var myBar = new MyScrollBar({
		selId:scid,
		hasX:true,
		hasY:false,
		width:6,
		// enterShow:false,
	})
}
var copy_flag = 0;
//右键菜单(包含鼠标悬停信息)
function _initHostMenu(){
	if(filter_flag == true){		//判断当前为过滤后页面
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul><li><a href="javascript:;" onclick="refresh()">刷新</a></li></ul></div>';
	}
	else if(copy_flag == 1){
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul><li><a href="javascript:;" onclick="create_u()" id="addUser" >创建用户</a></li><li><a href="javascript:;" onclick="create_g()" id="addUserGrp" >创建用户组</a></li><li><a href="javascript:;" onclick="refresh()">刷新</a></li><li><a href="javascript:;" onclick="paste()" id="Paste">粘贴</a></li></ul></div>';
	}else if(copy_flag == 0){
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul><li><a href="javascript:;" onclick="create_u()" id="addUser" >创建用户</a></li><li><a href="javascript:;" onclick="create_g()" id="addUserGrp" >创建用户组</a></li><li><a href="javascript:;" onclick="refresh()">刷新</a></li></ul></div>';
	}
	var $menu2 = '<div class="hostmenu" id="hostMenu2"><ul><li><a href="javascript:;" onclick="edit()" id="Edit">修改</a></li><li><a href="javascript:;" onclick="copy()" id="Copy">复制</a></li><li><a href="javascript:;" onclick="cut()">剪切</a></li><li><a href="javascript:;" onclick="_transfer()" id="transfer" >交接</a></li><li><a href="javascript:;" onclick="_delete(0)">删除</a></li><li><a href="javascript:;" id="move_n" onclick="_delete(1);">移除</a></li></ul></div>';
	
	if(if_disable =='1'){
		var $menu1 = '<div class="hostmenu" id="hostMenu1"><ul><li><a href="javascript:;" onclick="refresh()">刷新</a></li></ul></div>';
		var $menu2 = '<div class="hostmenu" id="hostMenu2"><ul><li><a href="javascript:;" onclick="edit()" id="Edit">查看</a></li></ul></div>';
	}
	
	var $_root = $('#hostContent');
	var $_menu;
	var mtop = 0, mleft = 0;
	$_root.off("contextmenu");
	$_root.on('contextmenu',function(e){
		if (first_grp == '1') {
			return;
		}
		e.preventDefault();
		e.stopPropagation();
		if($(e.target).attr('id') != 'hostContent'){
			return true;
		}
		_hideMenu();

		$('#hostContent').append($menu1);
		if($("#route-root").next().children().last().attr('id') == 'route-0-1'){//在未分组下
			$('#addUserGrp').hide();
			$("#Paste").hide();
		}else if($("#route-root").next().children().last().length == 0){//在所有组下
			$('#addUser').hide();
			$("#Paste").hide();
		}
			
		$_menu = $('#hostMenu1'); 
		var $_item = $(this);

		var $p = $('#user_manage_explorer');
		var offset = $p.offset();

		var maxRight = offset.left + $p.width();
		var maxBottom = offset.top + $p.height();
		mtop = e.clientY + $_menu.height() < maxBottom ? e.clientY : e.clientY - $_menu.height() - 20;
		mleft = e.clientX + $_menu.width() < maxRight ? e.clientX : e.clientX - 100;

		$_menu.css({
				'top': mtop,
				'left': mleft
		}).show().on('mouseout',function(){
			$_root.on('click',function(){
				$_menu.remove();
			})
		});
		_initSize();
	});

	//-----11/30 ctrl shift 多选功能 
	var boardkey=0;  //记录ctrl/shift键
	var $_fcitem,onlen = 0;
	$(window).keydown(function(e){
		if(e.ctrlKey){
			boardkey=1;
		}else if(e.shiftKey){
			boardkey=2;
		}
	}).keyup(function(){
		boardkey=0;
	})
	//-----11/30_e
	$_root.off("click").off("dblclick").off("scroll").off("mouseover");
    $_root.on('contextmenu','div.c',function(e){//选中图标
        if (first_grp == '1') {
			return;
		}
		e.preventDefault();
		e.stopPropagation();
		_hideMenu();
		var $_item = $(this);
		// $_item.addClass('on').parent().siblings('div.item').children('div.c').removeClass('on');
		//11-30_s
		var c = $_item.attr('class').split(' ');
		var ids = new Array();
		if(c.indexOf('on') < 0){
			$_item.addClass('on').parent().siblings('div.item').children('div.c').removeClass('on');
			var id = $_item.attr('id').split('-')[1];
			ids.push(id);
			onlen = 1;
		}else{
			$('div.item>div.c.on',$_root).each(function(){
				var id = $(this).attr('id').split('-')[1];
				ids.push(id);
			});
		}
		//11-30_e
		var Class = $("#hostContent").find("div[class='c on']").find('i').attr('class');
		if($(this).attr('id') != 'cnode-0-1'){ //未选中未分组
			$('#hostContent').append($menu2);
			if($("#route-root").next().children().last().attr('id') == 'route-0-1'){//在未分组下
				$('#Copy').hide();
				$('#move_n').hide();
				//11-30_s
				if(onlen > 1){				//多选
					$("#Edit").hide();
					$('#transfer').hide();
					$('#move_n').hide();
					
				}
				//11-30_e
			}else if($("#route-root").next().children().last().length == 0){//在所有组下
				$('#move_n').hide();
				if($(this).attr('ppath') != undefined){
					if($(this).attr('ppath').indexOf('未分组,1')>=0){
						$('#Copy').hide();
					}
				}
				if(onlen > 1){				//多选
					$("#Edit").hide();
					$('#transfer').hide();
					$('#move_n').hide();
				}
			}else if(Class == "h-bicon h-bicon-g"){//用户组
				$('#move_n').hide();
				if(onlen > 1){				//多选
					$("#Edit").hide();
				}
			}
		}
		var flag_user = 0;
		$("#hostContent").find('.item').children('.c.on').each(function(i,item){
			if($(item).children('i').attr('class').indexOf('h-bicon-g') >= 0 ){//选中用户组
				$('#transfer').hide();
				if(onlen > 1){				//多选
					$("#Edit").hide();
					$('#transfer').hide();
					$('#move_n').hide();
				}
				flag_user = 1;
				return false;
			}
		})
		if(flag_user == 0 && onlen > 1){
			$("#Edit").hide();
			$('#transfer').hide();
			//$('#move_n').hide();
		}
		$_menu = $('#hostMenu2');

		var $p = $('#user_manage_explorer');
		var offset = $p.offset();

		var maxRight = offset.left + $p.width();
		var maxBottom = offset.top + $p.height();

		mtop = e.clientY + $_menu.height() < maxBottom ? e.clientY : e.clientY - $_menu.height() - 20;
		mleft = e.clientX + $_menu.width() < maxRight ? e.clientX : e.clientX - 100;

		$_menu.css({
			'top': mtop,
			'left': mleft
		}).show().on('mouseout',function(){
				$_root.on('click',function(){
				$_menu.remove();
			})
		});
		var Mode = $("#hostContent").find("div[class='c on']").attr('type');//1-->只读 2-->可编辑
		if(Mode == 1){
			$("#Edit").hide();
			//'<div class="hostmenu" id="hostMenu2"><ul><li><a href="javascript:;" onclick="edit()" id="Edit">查看</a></li></ul></div>';
			$('#hostMenu2 ul').empty().append('<li><a href="javascript:;" onclick="edit()" id="Edit">查看</a></li>');
		}	
		var id = $_item.attr('id').split('-')[1];
		if(id == "root") parent_id = "route-root";
		else parent_id = 'node-' + $_item.attr('id').split('-')[1] +'-' +$_item.attr('id').split('-')[2];
		global_id = $_item.attr('id').split('-')[2];
		_initSize();
		
		var fa = false;
		$('#hostMenu2 a').each(function(i,item){
			if($(item).is(':visible')){
				fa =true;
				return false;
			}
		})
		if(fa == false){
			$_menu.hide();
		}
		
	}).on('click',function(e){
        if (first_grp == '1') {
            return;
        }
		if(e.target.className == 'h-content'){
			$("#hostContent").find('.c.on').removeClass('on');
		}else{
			//11-30_s
			if(e.target.className == 'c' || e.target.className == 'c on' ){
				var $_item = $(e.target); 
			}else{
				var $_item = $(e.target).parent();
			}
			if(boardkey == 0){
				$_item.addClass('on').parent().siblings('div.item').children('div.c').removeClass('on');
				$_fcitem = $_item;
			}else if(boardkey == 1){		//ctrl
				var c = $_item.attr('class').split(' ');
				if(c.indexOf('on') < 0){
					$_item.addClass('on');
					$_fcitem = $_item;
				}else{
					$_item.removeClass('on');
				}
			}else if(boardkey == 2){		//shift
				var index = $_item.parent().index();
				var fi;
				if(typeof $_fcitem == 'undefined'){
					fi = index;
				}else{
					fi = $_fcitem.parent().index();
				}
				$('div.item>div.c',$_root).removeClass('on');
				if(index > fi){
					$('div.item',$_root).each(function(i,item2){
						if(i >= fi && i <= index){
							$(item2).children('div.c').addClass('on');
						}
					})
				}else if(index < fi){
					$('div.item',$_root).each(function(i,item2){
						if(i <= fi && i >= index){
							$(item2).children('div.c').addClass('on');
						}
					})
				}else{
					$_item.addClass('on');
					$_fcitem = $_item;
				}
			}
			onlen = $('>div.item>div.c.on',$_root).length;
			//11-30_e
		}
	}).on('dblclick','div.item>div.c',function(){
		var $_item = $(this);
		var id = $_item.attr('id').split('-')[1];
		if($(this).children().attr('class') == "h-bicon h-bicon-h"+disabled_class || $(this).children().attr('class') == "h-bicon h-bicon-h-cut" || $(this).children().attr('class') == "h-bicon h-bicon-l"+disabled_class || $(this).children().attr('class') == "h-bicon h-bicon-l-cut" || $(this).children().attr('class') == "h-bicon h-bicon-d"+disabled_class || $(this).children().attr('class') == "h-bicon h-bicon-d-cut" ){
			if($(this).children('i').attr('class').indexOf('h-bicon-h') >=0 || $(this).children('i').attr('class').indexOf('h-bicon-l') >=0 || $(this).children('i').attr('class').indexOf('h-bicon-d') >=0){	//双击用户 成修改
				if(id == "root") parent_id = "route-root";
				else parent_id = 'node-' + $_item.attr('id').split('-')[1] +'-' +$_item.attr('id').split('-')[2];
				edit();
			}
		}
		else{
			var id = $(this).attr('id').split('-')[1];
			var iid = $(this).attr('id').split('-')[2];
			
			$('#node-'+id).prev().trigger('click');
			$("#route-root").next().children('a').each(function(i,item){
				var id_str = $(item).attr('id').split('route')[1];
				if($("#node"+id_str).prev().attr('class') == 'h-aicon'){
					$("#node"+id_str).prev().click();
				}
			})
			//if($("#hostCatelog").find("a[class='active']").prev().attr("class") == "h-aicon"){
				//$("#hostCatelog").find("a[class='active']").prev().click();
			//}
			$('#node-'+ id +'-'+ iid).click();
		}
	}).on('scroll',function(){
		if($_menu){
			$_menu.hide();
		}
	}).on('mouseover','div.c',function(e){
		if(filter_flag == true){											//当前为过滤结果
			markText = '';
			$('#markView').remove();
			id_list = $(this).attr('id').split('-');
			path = $(this).attr('value');
			if($(this).find('i').attr('class').indexOf('h-bicon-g') >=0){ 		//判断是用户 还是用户组
				flag = 'group';
				$.ajax({
					url:"/bhost/get_ugroup",
					type:"POST",
					async:false,
					data:{a0:sess,a1:id_list[2]},
					success:function(result){
						ugroup_item = JSON.parse(result);
						if(ugroup_item.Result == false){
						_alert(1,"用户管理","获取用户组信息失败："+ugroup_item.info[0]);
						return false;
						}else{
							ugroup_item = ugroup_item.info[0];
							if(ugroup_item.Description == null){
								ugroup_item.Description = "";
							}
							markText =  "用户组名：" +ugroup_item.UGName +"<br>" +
													"描述：" +ugroup_item.Description +"<br>" +
													"路径：" +path;
							markText = HTMLEncode(markText).replace(/&lt;br&gt;/g,"<br>");
						}
					}
				})
			}else{
				flag = 'user';
				$.ajax({
					url:"/bhost/get_user_list",
					type:"POST",
					async:false,
					data:{a0:sess,a1:id_list[2]},
					success:function(result){
						user_item = JSON.parse(result);
						if(user_item.Result == false){
							_alert(1,"用户管理","获取用户信息失败："+user_item.info);
							return false;
						}else{
							user_item = user_item.info;
							if(user_item.Department == null){
								user_item.Department = "";
							}
							if(user_item.MobilePhone == null){
								user_item.MobilePhone = "";
							}
							if(user_item.Email == null){
								user_item.Email = "";
							}
							if(user_item.Description == null){
								user_item.Description = "";
							}
							var status_str;
							switch (user_item.UserStatus){
								case 0:
									status_str = "停用";
									break;
								case 1:
									status_str = "启用";
									break;
								case 2:
									status_str = "锁定";
									break;
								case 6:
									status_str = "用户过期";
									break;
								case 7:
									status_str = "临时用户";
									break;
								case 8:
									status_str = "需要修改密码";
									break;
								case 9:
									status_str = "密码过期";
									break;
                            }
                            var user_role_arr=[];
                            $.each(user_item.RoleSet,function(i,item){
                                user_role_arr.push(item.RoleName);
                            });
                            var user_admin_arr=[];
                            $.each(user_item.AdminSet,function(i,item){
                                user_admin_arr.push(item.UserCode);
                            });
							markText =  "姓名：" +user_item.UserName +"<br>" +
										"工号：" +(user_item.UserNumber||'')+"<br>" +
                                        "管理员：" + user_admin_arr.join(',') + "<br>" +
										"角色：" + user_role_arr.join(',')+"<br>" +
										"部门：" +user_item.Department +"<br>" +
										"手机：" +user_item.MobilePhone +"<br>" +
										"Email：" +user_item.Email +"<br>" +
										"描述：" +user_item.Description +"<br>" +
										"状态：" +status_str+"<br>" +
										"路径：" +path;
							markText = HTMLEncode(markText).replace(/&lt;br&gt;/g,"<br>");
						}
					}
				})
			}
			// markText = HTMLEncode(markText).replace(/&lt;br&gt;/g,"<br>");
			var HTML = '<div id="markView" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis">'+markText+'</div>';
			$('body').append(HTML);

			var $_mark = $('#markView');

			var $p = $('#user_manage_explorer');
			var offset = $p.offset();

			var maxRight = offset.left + $p.width();
			var maxBottom = offset.top + $p.height();

			mtop = e.clientY + $_mark.height() < maxBottom ? e.clientY + 5 : e.clientY - $_mark.height() - 25;
			mleft = e.clientX + $_mark.width() < maxRight ? e.clientX + 5 : e.clientX - 205;

			$_mark.css({
				'top': mtop,
				'left': mleft
			}).show();
			_initSize();
		}else{					// 当前不是过滤后界面
			markText = '';
			$('#markView').remove();
			id_list = $(this).attr('id').split('-');
			//判断是用户 还是用户组
			if($(this).find('i').attr('class').indexOf('h-bicon-g') >=0){
				flag = 'group';
				$.ajax({
					url:"/bhost/get_ugroup",
					type:"POST",
					async:false,
					data:{a0:sess,a1:id_list[2]},
					success:function(result){
						ugroup_item = JSON.parse(result);
						if(ugroup_item.Result == false){
							_alert(1,"用户管理","获取用户组信息失败："+ugroup_item.info[0]);
							return false;
						}else{
							ugroup_item = ugroup_item.info[0];
							if(ugroup_item.Description == null){
								ugroup_item.Description = "";
							}							
							markText =  "用户组名：" +ugroup_item.UGName +"<br>" +
										"描述：" +ugroup_item.Description;
							markText = HTMLEncode(markText).replace(/&lt;br&gt;/g,"<br>");
						}
					}
				})
			}else{
				flag = 'user';
				$.ajax({
					url:"/bhost/get_user_list",
					type:"POST",
					async:false,
					data:{a0:sess,a1:id_list[2]},
					success:function(result){
						user_item = JSON.parse(result);
						if(user_item.Result == false){
							_alert(1,"用户管理","获取用户信息失败："+user_item.info);
							return false;
						}else{
							user_item = user_item.info;
							if(user_item.Department == null){
								user_item.Department = "";
							}
							if(user_item.MobilePhone == null){
								user_item.MobilePhone = "";
							}
							if(user_item.Email == null){
								user_item.Email = "";
							}
							if(user_item.Description == null){
								user_item.Description = "";
							}						
							var status_str;
							switch (user_item.UserStatus)
							{
								case 0:
									status_str = "停用";
									break;
								case 1:
									status_str = "启用";
									break;
								case 2:
									status_str = "锁定";
									break;
								case 6:
									status_str = "用户过期";
									break;
								case 7:
									status_str = "临时用户";
									break;
								case 8:
									status_str = "需要修改密码";
									break;
								case 9:
									status_str = "密码过期";
									break;
                            }
                            var user_role_arr = [];
                            $.each(user_item.RoleSet, function (i, item) {
                                user_role_arr.push(item.RoleName);
                            });
                            var user_admin_arr = [];
                            $.each(user_item.AdminSet, function (i, item) {
                                user_admin_arr.push(item.UserCode);
                            });
							markText =  "姓名：" +user_item.UserName +"<br>" +
                                        "工号：" +(user_item.UserNumber||'')+"<br>" +
                                        "管理员：" + user_admin_arr.join(',') + "<br>" +
                                        "角色：" + user_role_arr.join(',') + "<br>" +
										"部门：" +user_item.Department +"<br>" +
										"手机：" +user_item.MobilePhone +"<br>" +
										"Email：" +user_item.Email +"<br>" +
										"状态：" +status_str +"<br>" +
										"描述：" +user_item.Description;
							markText = HTMLEncode(markText).replace(/&lt;br&gt;/g,"<br>");
						}
					}
			})
		}
	}
	// markText = HTMLEncode(markText).replace(/&lt;br&gt;/g,"<br>");
	var HTML = '<div id="markView" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis">'+markText+'</div>';
	$('body').append(HTML);

	var $_mark = $('#markView');

	var $p = $('#user_manage_explorer');
	var offset = $p.offset();

	var maxRight = offset.left + $p.width();
	var maxBottom = offset.top + $p.height();

	mtop = e.clientY + $_mark.height() < maxBottom ? e.clientY + 5 : e.clientY - $_mark.height() - 25;
	mleft = e.clientX + $_mark.width() < maxRight ? e.clientX + 5 : e.clientX  - 205;

	$_mark.css({
		'top': mtop,
		'left': mleft
	}).show();
	_initSize();
	}).on('mouseout','div.c',function(){
		markText = '';
		$('#markView').remove();
	});
}

//route路径
function _initRoute(){
	var $_root = $('#hostRoute');
	$_root.unbind().on('click','a',function(){
		filter_flag = false;
		var id = $(this).attr('id').split('-')[1];
		if(id == 'root'){
			var group_data = [];
	    var loginusercode = window.parent.document.frm.us.value;
	    $.ajax({
			url:"/bhost/get_ugroup_list",
			type:"POST",
			async:false,
			data:{a0:sess,a1:loginusercode,a2:0,a3:loginuserid,a9:0},
			success:function(result){ 
			  var ugroup_result = JSON.parse(result);
				if(ugroup_result.Result == false){
					_alert(1,"用户管理","获取信息失败："+ugroup_result.info);
					return false;
				}
				else{
					var result = ugroup_result.info;
					result = result.data;
					firstData_group = result.UGroup;
					firstData = group_data;
					firstData_user = result.User;
				}
		   	}
		  }) 
			clear_filter();
			$('#user_select').val('0').trigger('change');
			$('#hostRoute').empty().html('<a id="route-root" href="javascript:;">所有组</a>');
			$('#hostCatelog a.active').removeClass('active');
			$('#hostContent div.item').remove();
			list_or_ico();
			//Mode---> 1 查询权限  2---> 编辑
			//Selected != 0 显示 ==0 隐藏			
			$.each(firstData_group,function(i,item){
				if(item.Mode == 2 || '{{us}}' == 'admin'|| item.UGName == '未分组' || (item.Mode == 1)){
					if(item.Mode == 2)
						if (first_grp == '0') {
							$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-' + item.UGId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" type="' + item.Mode + '"><i class="h-bicon h-bicon-g"></i>' + item.UGName + '</div></div>');
						}
						else{
							$('#user_list_').append('<tr>' +
								'<td class="in">' +
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
								'<div class="item"><div class="c" id="cnode-0-' + item.UGId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" type="' + item.Mode + '"><i class="h-bicon h-bicon-g"></i>' + item.UGName + '</div></div>' +
								'</td>' +
								'<td title="' + item.UGName + '">' + item.UGName + '</td>' +
								'<td title="用户组">用户组</td>' +
								'<td title="'+(item.AdminSet||'')+'">'+(item.AdminSet||'')+'</td>' +
								'<td title=""></td>' +
								'<td><div class="tab-ctr">' +
								'<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + ' ' + ((item.UGName == '未分组') ? 'disabled' : '') + '" id="' +
								((item.UGName == '未分组') ? '' : '_edit') + '" title="' + ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
								'<a href="javascript:;" style="width:8px;" class="copy ' + ((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="transfer disabled" id="" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
								'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>' +
								'</div></td>' +
								'</tr>');
						}
					else{
						if (first_grp == '0') {
							$('#hostContent').append('<div class="item" style="display:none;"><div class="c" id="cnode-0-' + item.UGId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" type="' + item.Mode + '"><i class="h-bicon h-bicon-g"></i>' + item.UGName + '</div></div>');
						}
						else {
							$('#user_list_').append('<tr style="display:none;">' +
								'<td class="in">' +
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
								'<div class="item" style="display:none;"><div class="c" id="cnode-0-' + item.UGId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis" type="' + item.Mode + '"><i class="h-bicon h-bicon-g"></i>' + item.UGName + '</div></div>' +
								'</td>' +
								'<td title="' + item.UGName + '">' + item.UGName + '</td>' +
								'<td title="用户组">用户组</td>' +
								'<td title="'+(item.AdminSet||'')+'">'+(item.AdminSet||'')+'</td>' +
								'<td title=""></td>' +
								'<td><div class="tab-ctr">' +
								'<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + ' ' + ((item.UGName == '未分组') ? 'disabled' : '') + '" id="' +
								((item.UGName == '未分组') ? '' : '_edit') + '" title="' + ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
								'<a href="javascript:;" style="width:8px;" class="copy ' + ((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((item.UGName == '未分组' || if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="transfer disabled" id="" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del ' + ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((item.UGName == '未分组' || if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
								'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>' +
								'</div></td>' +
								'</tr>');
						}
						
						uglist.push("0" + '-'+ item.UGId +"-false");
					}
				}
			});
			$.each(firstData_user,function(i,item){
				if((item.Mode == 2 && item.UserCode != '{{us}}') || '{{us}}' == 'admin'){
					if(item.UserStatus == 0){
						if (first_grp == '0') {
							$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-'+item.UserId+'"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-d"></i>'+item.UserCode+'</div></div>');
						}
						else{
							$('#user_list_').append('<tr>' +
								'<td class="in">' +
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
								'<div class="item"><div class="c" id="cnode-0-' + item.UserId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-d"></i>' + item.UserCode +'</div></div>' +
								'</td>' +
								'<td title="' + item.UserCode + '">' + item.UserCode + '</td>' +
								'<td title="用户">用户</td>' +
								'<td title="'+item.AdminSet+'">' + item.AdminSet +'</td>' +
								'<td title="停用">停用</td>' +
								'<td><div class="tab-ctr">' +
                                '<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + '" id="_edit" title="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
								'<a href="javascript:;" style="width:8px;" class="copy ' + ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
								'<a href="javascript:;" style="width:8px;" class="move ' + ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? '' : '_remove') + '" title="移除"></a>' +
								'</div></td>' +
								'</tr>');
						}
					}else if(item.UserStatus == 2){
						if (first_grp == '0') {
							$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-' + item.UserId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-l"></i>' + item.UserCode + '</div></div>');
						}
						else{
							$('#user_list_').append('<tr>' +
								'<td class="in">' +
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
								'<div class="item"><div class="c" id="cnode-0-' + item.UserId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-l"></i>' + item.UserCode + '</div></div>' +
								'</td>' +
								'<td title="' + item.UserCode + '">' + item.UserCode + '</td>' +
								'<td title="用户">用户</td>' +
								'<td title="'+item.AdminSet + '">' + item.AdminSet + '</td>' +
								'<td title="锁定">锁定</td>' +
								'<td><div class="tab-ctr">' +
                                '<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + '" id="_edit" title="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
								'<a href="javascript:;" style="width:8px;" class="copy ' + ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
								'<a href="javascript:;" style="width:8px;" class="move ' + ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? '' : '_remove') + '" title="移除"></a>' +
								'</div></td>' +
								'</tr>');
						}
					}else{
						if (first_grp == '0') {
							$('#hostContent').append('<div class="item"><div class="c" id="cnode-0-' + item.UserId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-h"></i>' + item.UserCode + '</div></div>');
						}
						else {
							$('#user_list_').append('<tr>' +
								'<td class="in">' +
								'<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
								'<div class="item"><div class="c" id="cnode-0-' + item.UserId + '"  style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-h"></i>' + item.UserCode + '</div></div>' +
								'</td>' +
								'<td title="' + item.UserCode + '">' + item.UserCode + '</td>' +
								'<td title="用户">用户</td>' +
								'<td title="'+item.AdminSet + '">' + item.AdminSet + '</td>' +
								'<td title="启用">启用</td>' +
								'<td><div class="tab-ctr">' +
                                '<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + '" id="_edit" title="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
								'<a href="javascript:;" style="width:8px;" class="copy ' + ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                '<a href="javascript:;" style="width:8px;" class="del ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                ((if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
								'<a href="javascript:;" style="width:8px;" class="move ' + ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
								((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? '' : '_remove') + '" title="移除"></a>' +
								'</div></td>' +
								'</tr>');
						}
					}
				}
			});
			list_initList();
			select_checkbox();
			_hideMenu();
		}else{
			$("#route-root").next().children('a').each(function(i,item){
				var id_str = $(item).attr('id').split('route')[1];
				if($("#node"+id_str).prev().attr('class') == 'h-aicon'){
					$("#node"+id_str).prev().click();
				}
			})
			var iid = $(this).attr('id').split('-')[2];
			$('#node-'+id+'-'+iid).click();
		}
		_initHostMenu();
	});
}

//data_array_Path=null;
//加载过滤后列表
function find_list(){
	_getWait($(".waitTip"));
	_initHostMenu();
	var jsondata = {
		"loginusercode":'{{us}}',
		"ugid":1,
		"ugname": "",               // --搜索条件，用户组名
		"usercode": "",             // --搜索条件，用户账号
		"username": "",             // --搜索条件，用户名
		"userstatus": "",
		"mobilephone": "",
		"department": "",
		"usernumber": "",
		"description":"",
		"rolename":"",
		"adminusercode":"",
		"istree":false,
		"searchstring":"",
		"limitrow":null,
		"offsetrow":null 
	}
	var filter = global_filter + global_filter_n;
	if(filter != ''){
		var f = '';
		var searchstring_str='';
		var ugname_str='';
		var usercode_str='';
		var username_str='';
		var userstatus_str='';
		var phone_str='';
		var department_str='';
		var description_str='';
		var usernumber_str='';
		var rolename_str='';
		var adminname_str='';
		$.each(filter.split('\t'),function(i,item){
			if(item == ''|| item == null){
				return true;
			}
			var item_id = item.indexOf('-');
			switch (item.substr(0,item_id)) {
				case '0':
					searchstring_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'ugname':
					ugname_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'usercode':
					usercode_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'username':
					username_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'description':
					description_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'usernumber':
					usernumber_str+=(item.substr(item_id+1,item.length)+'\n');
					break;
				case 'department':
					department_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'phone':
					phone_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'rolename':
					rolename_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'adminname':
					adminname_str += (item.substr(item_id+1,item.length) + '\n');
					break;
				case 'userstatus':
					userstatus_str += (item.substr(item_id+1,item.length) + '\n');
					break;
			}
		})
		username_str = username_str.substr(0,username_str.length-1);
		searchstring_str = searchstring_str.substr(0,searchstring_str.length-1);
		ugname_str = ugname_str.substr(0,ugname_str.length-1);
		usercode_str = usercode_str.substr(0,usercode_str.length-1);
		description_str = description_str.substr(0,description_str.length-1);
		department_str = department_str.substr(0,department_str.length-1);
		usernumber_str = usernumber_str.substr(0,usernumber_str.length-1);
		phone_str = phone_str.substr(0,phone_str.length-1);
		rolename_str = rolename_str.substr(0,rolename_str.length-1);
		adminname_str = adminname_str.substr(0,adminname_str.length-1);
		userstatus_str = userstatus_str.substr(0,userstatus_str.length-1);
		jsondata.ugname = ugname_str;
		jsondata.searchstring = searchstring_str;
		jsondata.username = username_str;
		jsondata.usercode = usercode_str;
		jsondata.description = description_str;
		jsondata.department = department_str;
		jsondata.usernumber = usernumber_str;
		jsondata.mobilephone = phone_str;
		jsondata.rolename = rolename_str;
		jsondata.adminusercode = adminname_str;
		jsondata.userstatus = userstatus_str;
		if($("#route-root").next().children().last().length == 0){
			jsondata.ugid = 0;
		}else{
			var c = $("#route-root").next().children().last();
			jsondata.ugid = c[0].id.split('-')[2];
		}
		var user_data = [];
		var group_data = [];
		var loginusercode = window.parent.document.frm.us.value;
		$.ajax({
			url:"/bhost/find_user_list",
			type:"POST",
			async:true,
			data:{a0:sess,a1:JSON.stringify(jsondata)},
			success:function(result){ 
				f_result = JSON.parse(result);
				_waitDone($(".waitTip"));
				var par_id = $("#hostRoute").children().next().children("a:last").attr("id");
				if(par_id == undefined){
					par_id = 0;
				}else{
					par_id = $("#hostRoute").children().next().children("a:last").attr("id").split('-')[2];
				}
				if(jsondata.ugid == par_id){
					find_result = f_result.info;
					if(find_result == null){
						_alert(0,"用户管理",'无搜索结果',$("#gjz"));
						$('#hostContent').empty();
						return false;
					}
					$('#hostContent').empty();
					_pathWrap();
					var name;
					list_or_ico();
					$.each(find_result,function(i,item){ //先显示用户组
						//if(item.Mode == 2){
							n = item.Path.split('/');
							h = item.Path;
							name = n[n.length-1].split(',')[0];
							id_2 = n[n.length-2].split(',')[1];
							if(id_2 == null){
								id_2 = 0;
							}
							var a="";
							for(i = 0 ;i<n.length-1 ;i++){
								a=a+"/";
								a=a+n[i+1].split(',')[0];
							}
							h = a;
							if(item.Type == 1){
								if (item.Mode==2 ){
									if (first_grp == '0') {
										$('#hostContent').append('<div class="item"><div class="c" id="cnode-'+item.Parent+'-'+item.Id+'" value="'+h+'" path = "'+item.Path+'" type="'+item.Mode+'" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-g" ></i>'+name+'</div></div>');
									}
									else{
										$('#user_list_').append('<tr>'+
											'<td class="in">'+
												'<input type="checkbox" class="input_checkbox" id="in" style="" '+((name == '未分组' || if_disable == '1' || item.Mode < 2)?'disabled':'')+'>'+
												'<div class="item"><div class="c" id="cnode-'+item.Parent+'-'+item.Id+'" value="'+h+'" path = "'+item.Path+'" type="'+item.Mode+'" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-g" ></i>'+name+'</div></div>'+
											'</td>'+
											'<td title="'+name+'">'+name+'</td>'+
											'<td title="用户组">用户组</td>'+
											'<td title="'+(item.AdminSet||'')+'">'+(item.AdminSet||'')+'</td>'+
											'<td title=""></td>'+
											'<td><div class="tab-ctr">'+
												'<a href="javascript:;" style="width:8px;" class="'+((if_disable =='1' || item.Mode < 2)?'search_result':'edit')+' '+((name=='未分组')?'disabled':'')+'" id="'+
												((name=='未分组')?'':'_edit')+'" title="'+((if_disable =='1' || item.Mode < 2)?'查看':'修改')+'"></a>'+
												'<a href="javascript:;" style="width:8px;" class="copy '+((name=='未分组' || if_disable =='1' || parent_id == 'node-0-1' || item.Mode < 2)?'disabled':'')+'" id="'+
												((name=='未分组' || if_disable =='1' || parent_id == 'node-0-1' || item.Mode < 2)?'':'_copy')+'" title="复制"></a>'+
                                                '<a href="javascript:;" style="width:8px;" class="cut '+((name=='未分组' || if_disable =='1' || item.Mode < 2)?'disabled':'')+'" id="'+
                                                ((name=='未分组' || if_disable =='1' || item.Mode < 2)?'':'_cut')+'" title="剪切"></a>'+
                                                '<a href="javascript:;" style="width:8px;" class="transfer disabled" id="" title="交接"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="del '+((name=='未分组' || if_disable =='1' || item.Mode < 2)?'disabled':'')+'" id="'+
                                                ((name=='未分组' || if_disable =='1' || item.Mode < 2)?'':'_del')+'" title="删除"></a>'+
												'<a href="javascript:;" style="width:8px;" class="move disabled" id="" title="移除"></a>'+
											'</div></td>'+
										'</tr>');
									}
									var static_id = 0;			//用来存储父ID
									$("#route-root").next().children('a').each(function(i,item){
										var id_str = $(item).attr('id').split('route')[1];
										if($("#node"+id_str).prev().attr('class') == 'h-aicon'){
											$("#node"+id_str).prev().click();
										}
									})
									for(i=0;i<n.length-1;i++){
										cid = n[i+1].split(',')[1];
										if($("#node-"+static_id+"-"+cid).prev().attr("class") == "h-aicon"){		//展开路径
											$("#node-"+static_id+"-"+cid).prev().click();
										}
										static_id = cid;
									}
								}
							}
						//}
					})
					$.each(find_result,function(i,item){	//再显示用户
						if((item.Name != '{{us}}')){
							n = item.Path.split('/');
							h = item.Path;
							name = n[n.length-1].split(',')[0];
							id_2 = n[n.length-2].split(',')[1];
							if(id_2 == null){
								id_2 = 0;
							}
							var a="";
							for(i = 0 ;i<n.length-1 ;i++){
								a=a+"/";
								a=a+n[i+1].split(',')[0];
							}
							h = a;
							if(item.Type == 2){
								if(item.Mode == 2 || "{{us}}" == 'admin'){
									if(item.UserStatus == 0){
                                        if (first_grp == '0') {
                                            $('#hostContent').append('<div class="item"><div class="c" id="cnode-'+item.Parent+'-'+item.Id+'" value="'+h+'" path = "'+item.Path+'" type="'+item.Mode+'" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-d"></i>'+name+'</div></div>');
                                        }
                                        else {
                                            $('#user_list_').append('<tr>' +
                                                '<td class="in">' +
                                                '<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
                                                '<div class="item"><div class="c" id="cnode-' + item.Parent + '-' + item.Id + '" value="' + h + '" path = "' + item.Path + '" type="' + item.Mode + '" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-d"></i>' + name +'</div></div>' +
                                                '</td>' +
                                                '<td title="' + name + '">' + name + '</td>' +
                                                '<td title="用户">用户</td>' +
                                                '<td title="'+ item.AdminSet.replace(/\t/g, ",")+'">'+item.AdminSet.replace(/\t/g, ",")+'</td>'+
                                                '<td title="停用">停用</td>' +
                                                '<td><div class="tab-ctr">' +
                                                '<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + '" id="_edit" title="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="copy ' + ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="del ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="move ' + ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? '' : '_remove') + '" title="移除"></a>' +
                                                '</div></td>' +
                                                '</tr>');
                                        }
                                    }else if(item.UserStatus == 2){
                                        if (first_grp == '0') {
                                            $('#hostContent').append('<div class="item"><div class="c" id="cnode-'+item.Parent+'-'+item.Id+'" value="'+h+'" path = "'+item.Path+'" type="'+item.Mode+'" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-l"></i>'+name+'</div></div>');
                                        }
                                        else {
                                            $('#user_list_').append('<tr>' +
                                                '<td class="in">' +
                                                '<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
                                                '<div class="item"><div class="c" id="cnode-' + item.Parent + '-' + item.Id + '" value="' + h + '" path = "' + item.Path + '" type="' + item.Mode + '" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-l"></i>' + name +'</div></div>' +
                                                '</td>' +
                                                '<td title="' + name + '">' + name + '</td>' +
                                                '<td title="用户">用户</td>' +
                                                '<td title="'+ item.AdminSet.replace(/\t/g, ",") + '">' + item.AdminSet.replace(/\t/g, ",") + '</td>' +
                                                '<td title="锁定">锁定</td>' +
                                                '<td><div class="tab-ctr">' +
                                                '<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + '" id="_edit" title="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="copy ' + ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="del ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="move ' + ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? '' : '_remove') + '" title="移除"></a>' +
                                                '</div></td>' +
                                                '</tr>');
                                        }
                                    }else{
                                        if (first_grp == '0') {
                                            $('#hostContent').append('<div class="item"><div class="c" id="cnode-'+item.Parent+'-'+item.Id+'" value="'+h+'" path = "'+item.Path+'" type="'+item.Mode+'" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-h"></i>'+name+'</div></div>');	        		
                                        }
                                        else {
                                            $('#user_list_').append('<tr>' +
                                                '<td class="in">' +
                                                '<input type="checkbox" class="input_checkbox" id="in" style="" ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '>' +
                                                '<div class="item"><div class="c" id="cnode-' + item.Parent + '-' + item.Id + '" value="' + h + '" path = "' + item.Path + '" type="' + item.Mode + '" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis"><i class="h-bicon h-bicon-l"></i>' + name +'</div></div>' +
                                                '</td>' +
                                                '<td title="' + name + '">' + name + '</td>' +
                                                '<td title="用户">用户</td>' +
                                                '<td title="'+ item.AdminSet.replace(/\t/g, ",") + '">' + item.AdminSet.replace(/\t/g, ",") + '</td>' +
                                                '<td title="启用">启用</td>' +
                                                '<td><div class="tab-ctr">' +
                                                '<a href="javascript:;" style="width:8px;" class="' + ((if_disable == '1' || item.Mode < 2) ? 'search_result' : 'edit') + '" id="_edit" title="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '查看' : '修改') + '"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="copy ' + ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || parent_id == 'node-0-1' || item.Mode < 2) ? '' : '_copy') + '" title="复制"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="cut ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_cut') + '" title="剪切"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="transfer ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_transfer') + '" title="交接"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="del ' + ((if_disable == '1' || item.Mode < 2) ? 'disabled' : '') + '" id="' + 
                                                ((if_disable == '1' || item.Mode < 2) ? '' : '_del') + '" title="删除"></a>' +
                                                '<a href="javascript:;" style="width:8px;" class="move ' + ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? 'disabled' : '') + '" id="' +
                                                ((if_disable == '1' || parent_id == 'node-0-1' || parent_id == 'route-root' || item.Mode < 2) ? '' : '_remove') + '" title="移除"></a>' +
                                                '</div></td>' +
                                                '</tr>');
                                        }
									}
								}
							}
							var static_id = 0;			//用来存储父ID
							for(i=0;i<n.length-2;i++){
								cid = n[i+1].split(',')[1];
								if($("#node-"+static_id+"-"+cid).prev().attr("class") == "h-aicon"){		//展开路径
									$("#node-"+static_id+"-"+cid).prev().click();
								}
								static_id = cid;
							}
						}
					})
					if($('#hostContent').find('div.item').length == 0){
						_alert(0,"用户管理",'无搜索结果',$("#gjz"));
					}					
                    filter_flag = true;
                    list_initList();
					_initSize();
				}
			}
		})
	}
	else{
		filter_flag = false;
		refresh();
		_waitDone($(".waitTip"));
	}
}

var group_array = [];
//创建用户
function create_u(){
	Flag_load = 1;
	CREATE_FLAG = true;
	group_array = [];
	client_list = ['-1'];
	$("#totp_div").css("width","105px;");
	$("#totp_div").find('label:eq(0)').css("width","0px");
	$("#totp_div").find('label:eq(1)').hide();
	//if(document.getElementsByTagName('body')[0].scrollTop)document.getElementsByTagName('body')[0].scrollTop = 0;
	new_pin = "";
	auth_class = 0;
	authDefault_flag = 0;
	$(".container").show();
	$("#user_title").text("创建用户");
	$(".container3").hide();
	document.getElementsByClassName('c-cont')[0].scrollTop = 0;//让滚动条出现在最上面
	$("#sys_u_name").removeAttr("disabled");
	user_clear();
	$('#action_div').show();
	$('.container div.btns').show();
	flag = 0;
	var c = $("#route-root").next().children().length;
	if(c == 0){
		global_pid = 0;
		global_piid = "route-root";
	}else{
		c = $("#route-root").next().children().last();
		global_pid = c[0].id.split('-')[2];
		global_piid = c[0].id;			
	}
	global_id = 0;
	_get_tokenid();
	_get_un(global_pid);
	$("#select_local").val("1").trigger('change');
	$("#changepin_local").show();//创建时显示设置初始密码	
	//bind_grpAdmin(global_pid);
	var admin_list = [];
	UGroupSet_tmp = [];
	admin_id = $('#select_u select').val();
	if(admin_id != -1 && admin_id != null){
		admin_list.push(admin_id);
	}
	$('#select_u li.item').each(function(i,item){
		admin_list.push($(this).attr('id'));
	})	
	userid_str = admin_list.join(",");//admin_list已选择的管理员
	$("#select_r_xselect").find('span').text("请选择");
	$('#select_r_xselect').data('value','-1');
	bind_role_xSelect();
	_get_an();
	$("#IPorMAC").val(5).trigger('change');
	$('#sys_u_authtype').data('value','-1');
	bind_authtype_xSelect();
	authDefault_flag = 0;	
	$.each(authtype_data,function(i,item){
		if(item.IsDefault == true){
			$.each(item.Set,function(i1,item1){
				if(item1.AuthMode == 6){
					authDefault_flag += 1;
				}else if(item1.AuthMode == 8){
					authDefault_flag += 2;
				}
			})
		}	
	})
	$("#sys_u_authtype").find('span').text("默认");
	$('#sys_u_authtype').data('value','-1');
	change_authtype_scope($(".xSelect-authtype li").eq(0));
	$("#select_local").val('1').trigger('change').attr("disabled",false);
	$("#select_local").val('1').trigger('change').attr("disabled",false);
	$(".xSelect-authtype li").eq(0).attr('class','active');
	$('#_Idimp1').show();
	$('#_Idimp2').show();
	$('#user_action1').iCheck('check');
	
	if($('#select_u select').val() == null){
		$('#select_u select').val('-1').trigger('change');
	}
	
}
function get_authtype_list1(o1){
	var obj1 = o1 || $('#sys_u_authtype');
	$.ajax({
		url: "/bhost/get_authtype_list",
		type:"POST",
		async:false,
		data:{a0:sess},
		success:function(result){
			var authtype_result = JSON.parse(result);
			if (authtype_result.Result==true){
				authtype_list = authtype_result.info.data;
				authtype_data = authtype_list;			
				obj1.empty();
				obj1.append('<option value="null" selected >默认</option>');
				$(authtype_list).each(function(i,item){
					obj1.append('<option value="'+item.AuthTypeId+'">'+item.AuthTypeName+'</option>');
				})			
				// obj1.select2({minimumResultsForSearch: -1});
			}
		}
	})
}
//创建用户组
var ug_data;
var ug_data_all = [];
var ug_arry = ['-1'];
var all_ug_data;
function _get_un_g(ug_id){
	var login_nm = window.parent.document.frm.us.value;
	$('#select_ug').empty().html('<div class="item" style="width:100%;float: left;margin-left: -19px;"><select class="filter-select" name="ug" id="ug" style="width:202px;" tabindex="-1" aria-hidden="false" onchange="ug_sel(this)"></select><i class="ctrl add" onclick="_addUg(this)"></i></div>');
	$.ajax({
		url:'/bhost/_get_userid',
		type:"POST",
		async:false,
		data:{a0:sess,a1:login_nm},
		success: function(Result) {
			data = JSON.parse(Result);
			u_id = data.info;
		}
	})
	ug_data_all.push(u_id);
	$.ajax({
		url:"/bhost/_get_un_g",
		type:"POST",
		async:false,
		data:{a0:sess,a1:ug_id},
		success:function(result){
			var user_result = JSON.parse(result);
			if(user_result){
				user_data = user_result.info;
				all_ug_data = user_data;
				ug_data = user_data;
				$("#ug").empty().append("<option value=\"-1\">请选择</option>"+
					"<option value=\""+u_id+"\">"+login_nm+"</option>");
				$.each(user_data,function(i,item){
					if(item.UserId != u_id){
						$("#ug").append('<option value="'+item.UserId+'">'+item.UserCode+'</option>');
						ug_data_all.push(item.UserId);
					}
				})
				$('#select_ug .filter-select').select2();
			}else{
				_alert(1,"用户管理",'获取管理员失败：'+data.info);
			}
		}
	})
}
var ug_tmp = [];
function ug_sel(obj){
	var t=$(obj).children("option:selected").val();
	if (ug_arry.indexOf(t) === -1 && t != undefined){
		ug_arry.splice(0,1,t);
	}
	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}
}
function search_i(min, max, id, data) {
	var mid, res;
	if (data[max] < id) {
		return -1;
	}
	if (data[min] > id) {
		return -2;
	}
	while (min <= max) {
		mid = parseInt((min + max) / 2);
		if (data[mid] > id) {
			max = mid - 1;
			res = mid;
		} else {
			min = mid + 1;
		}
	}
	return res;
}
function _addUg(obj){
	var add = 0;
	var name2 = $(obj).parent().children('select').children('option:selected').val();
	if (name2 == undefined){
		$(obj).parent().children('select').val('-1').trigger('change');
		return false;
	}
	
	var t = $(obj).parent().children('select').children('option[value='+name2+']').text();
	if (name2 == -1 ){
		if($('#ug option').length>1)
			_alert(2,"用户管理","请选择管理员");
		return ;
	}
	ug_arry.splice(0,0,'-1');
	ug_data_all.splice($.inArray(parseInt(name2), ug_data_all), 1);
	var $c = $(obj).parent();
	// $c.children('select').select2('destroy');
	var d = $('select>option:first',$c).val();
	var $s = $('<li class="item" id="'+name2+'" style="width:100%;float: left;margin-left: -19px;"><input type="text" class="form-text" id="'+name2+'" value="'+t+'" disabled="true" style="width:170px;" tabindex="-1" aria-hidden="false" onchange="ug_sel(this)"><i class="ctrl del" onclick="_delUg(this)"></i></li>');
	$c.children('select').val(d);
	$c.children('select').find('option[value='+name2+']').remove();

	$c.after($s);
	// $c.children('select').select2({minimumResultsForSearch: -1});

	ug_tmp=[];
	$("#select_u>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		ug_tmp.push(v_tmp);
	});
}
function _delUg(obj){
	// var $c = $(obj).parent();
	// var v = $c.find('select:first').children('option:selected').text();
	// $c.fadeOut(function(){
	// 	$c.remove();
	// });
	// if((index = ug_tmp.indexOf(v)) >= 0 ) ug_tmp.splice(index,1);
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var $p = $("#ug");
	var data, max;
	var min = 0;
	max = ug_data_all.length - 1;
	data = ug_data_all;

	var t = $(obj).siblings('input').val();
	$c.remove();
	$("#ug").parent().show();
	ug_arry.splice($.inArray(id,ug_arry),1);

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<option value="' + id + '">' + t + '</option>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('option').eq(0).after('<option value="' + id + '">' + t + '</option>');
	} else {
		$p.children('option[value=' + data[index_1] + ']').before('<option value="' + id + '">' + t + '</option>');
	}
	ug_data_all.splice(index_1, 0, parseInt(id));
	ug_tmp=[];
	$("#select_u>li").each(function(i,item){
		v_tmp=$(item).attr("id");
		ug_tmp.push(v_tmp);
	});
}

function create_g(){
	ug_arry = [];
	//document.getElementsByTagName('body')[0].scrollTop = 0;
	var c = $("#route-root").next().children().length;//判断当前是否为根目录
	if(c == 0){		//当前为根目录
		global_pid = 0;
		global_piid = "route-root";
	}
	else{
		c = $("#route-root").next().children().last();
		global_pid = c[0].id.split('-')[2];
		global_piid = c[0].id;			
	}	
	$(".container2").show();
	$('.container2').find('.form.form1').children('.form-item').eq(2).show();
	$("#group_title").text("创建用户组");
	$(".container3").hide();
	$('.container2 div.btns').show();
	_get_an();
	document.getElementsByClassName('c-cont')[0].scrollTop = 0;//让滚动条出现在最上面
	//表单清空
	$("#un_g").empty();
	$("#ug_n").val("");
	$("#ug_des").val("");
	$(".container2 .v-check").hide();
	$(".container2 .c-cont input:checked").each(function(i,item){
		$(this).iCheck('uncheck');
	})
	auth_tmp_g = [];
	auth_arry_g = ['-1'];
	_get_un_g(global_pid);
	$("#ug").val(u_id).trigger('change');
	$.ajax({									//绑定父组管理员
		url:"/bhost/get_ugroup",
		type:"POST",
		async:false,
		data:{a0:sess,a1:global_pid},
		success:function(result){
			ugroup_item1 = JSON.parse(result);
			if(ugroup_item1.Result == false){
				_alert(1,"用户管理","获取信息失败："+ugroup_item1.info[0]);
				return false;
			}
			else{
				ugroup_item1 = ugroup_item1.info[0];
			}
		}
    })
	AdminSet = ugroup_item1.AdminSet;

	$(AdminSet).each(function(i1,item1){
		$("#ug").val(item1.AdminId).trigger('change');
		$("#ug").next().next().click();
	})
	$('.container2').find(".ctrl.del").remove();
	//$('.container2').find(".ctrl.add").parent().children('select').val('-1').trigger('change');
	flag = 0;
}

//清空 用户信息
function user_clear(){
	//表单清空
	$("#sys_u_name").val("");
	$("#user_name").val("");
	$("#sys_u_pwd_new").val("");
	$("#sys_u_pwd_tr").val("");
	$("#thirduser").val("");
	$("#sys_u_depart").val("");
	$("#sys_u_phone").val("");
	$("#sys_u_email").val("");
	$("#sys_u_descr").val("");
	$("#sys_u_authtype").val('null').trigger("change");
	$("#datepicker").val("");
	$("#shour").val("");
	$("#smin").val("");
	$("#ssec").val("");
	$(".v-check").hide();
	$("#timeSet").iCheck('uncheck');
	$("#status").iCheck('check');
	$("#uniqueIP").iCheck('uncheck');
	// $("#pu_id").val("0").trigger("change");
	$('#tAvatar>img').attr('src','/manage/images/avatar1.jpg');
	$("#user_select1").val(0).trigger('change');
	$("#user_select1").next().next().next().click();
	role_tmp = [];
	user_tmp = [];
	auth_tmp = [];
	iplist = [];
	mac = [];
	client_tmp = [];
	role_arry = ['-1'];
	user_arry = ['-1'];
	auth_arry = ['-1'];
	FP_TMP = "";
	FP_SET = false;
	KEY_SET = false;
	$("#FinP_reset_div").find("text").show().text("未录入");
	$("#auth_divs").children("li").remove();
	$("#changepin_div").find("text").show().text("未配置");	
	$("#Temp4 .sitem").not(":first").remove();
	$("#Temp4 .sitem:first").children("select").val("5").trigger("change");
	IPList = {"IPSetId":0,"Set":[]};
	MACList = {"MACSetId":0,"Set":[]};
	$(".container").find('input').val("");

	List1 = {
	  "ClientScopeId": 0,
	  "Type": 1, 
	  "IPList": null,
	  "MACList": null
	};
	List2 = {
		"ClientScopeId": 0,
		"Type": 2, 
		"IPList": {},
		"MACList": {}
	};
	CScopeSet =[];
	bind_client_xSelect();
	_getDate('#srTemp-time');
	var temp4 = $('#Temp4>.sitem:last').clone();
	//$("#totp_checkbox").next('span').attr('class',"checkbox");
	$("#totp_checkbox").iCheck('uncheck');
	user.OldPassword = null;
	// $('#Temp4 .select2').select2({minimumResultsForSearch: -1});
	$("div[data-id=xSelect-role]").remove();
	$('#select_r li.item').remove();
	selected_ug =[];
	
	$("div[data-id=xSelect-authtype]").remove();
	global_flag_pwd = 0;
	$('#changepin_div').parent().hide();
	global_auth = -1;
	
}
//修改
var flag_client_all = 0;
var global_maid = 0;
var edit_MScopeSet = [];
var Flag_load = 0;
var CREATE_FLAG = true;
var edit_ScopeSet =[];
function edit(){
	//document.getElementsByTagName('body')[0].scrollTop = 0;
    var Mode='';
    var $item_e=null;
	if(first_grp=='1'){
        $item_e=$('#' + current_id);
	}else{
        $item_e=$("#hostContent").find("div[class='c on']");
	}
    Mode = $item_e.attr('type');
	if(Mode == 1){
		$('div.btns').hide();
	}else{
		$('div.btns').show();
	}
	new_pin = "";
	auth_class = 0;
	pin_success = 0;
	authDefault_flag = 0;
	var a=$item_e;
	if(filter_flag == true){			//当前为过滤结果
		var path = a.attr("path").split('/');
		var l = path.length;
		global_pid = path[l-2].split(',')[1] //取出所在组ID
	}
	var b = a.children();
	global_id = a[0].id.split('-')[2];    		       //选中ID
	var c = $("#route-root").next().children().length;
	if(c == 0){
		global_pid = 0;
		global_piid = "route-root";
	}
	else{
		c = $("#route-root").next().children().last();
		global_pid = c[0].id.split('-')[2];
		global_piid = c[0].id;			//所处用户组	
	}
	if($(b).attr('class')=="h-bicon h-bicon-g-cut" || $(b).attr('class')=="h-bicon h-bicon-g"+disabled_class){ //选择的是用户组(剪切后的用户组)
		ug_arry = [];
		$(".container2").show();
		$("#group_title").text("编辑用户组");
		$(".container3").hide();
		$('.container2').find('.form.form1').children('.form-item').eq(2).hide();
		document.getElementsByClassName('c-cont')[0].scrollTop = 0;//让滚动条出现在最上面
		//表单清空
		$("#un_g").empty();
		$("#ug_n").val("");
		$("#ug_des").val("");
		$("#select_ug").children(".item").not(":first").remove();
		$("#select_ug").children(".item").children("select").val("-1").trigger("change");
		$(".container2 .v-check").hide();
		$(".container2 .c-cont input:checked").each(function(i,item){
			$(this).iCheck('uncheck');
		})
		$.ajax({		//回显用户组信息
			url:"/bhost/get_ugroup",
			type:"POST",
			async:false,
			data:{a0:sess,a1:global_id},
			success:function(result){
				ugroup_item = JSON.parse(result);
				if(ugroup_item.Result == false){
					_alert(1,"用户管理","获取信息失败："+ugroup_item.info[0]);
					return false;
				}else{
					ugroup_item = ugroup_item.info[0];
				}
			}
		})
		_get_un_g(global_id);
		$.ajax({									//绑定父组管理员
			url:"/bhost/get_ugroup",
			type:"POST",
			async:false,
			data:{a0:sess,a1:global_pid},
			success:function(result){
				ugroup_item1 = JSON.parse(result);
				if(ugroup_item1.Result == false){
					_alert(1,"用户管理","获取信息失败："+ugroup_item1.info[0]);
					return false;
				}
				else{
					ugroup_item1 = ugroup_item1.info[0];
				}
			}
		})
		AdminSet = ugroup_item1.AdminSet;
		$(AdminSet).each(function(i1,item1){
			$("#ug").val(item1.AdminId).trigger('change');
			$("#ug").next().next().click();	
		})
		$('.container2').find(".ctrl.del").remove();
		flag = 1;
		$("#ug_n").val(ugroup_item.UGName);
		$("#ug_des").val(ugroup_item.Description);
		AdminSet = ugroup_item.AdminSet;
		/*
		$.each(AdminSet,function(i,item){
			$("#g" +item.AdminId).iCheck('check');
		})*/
		
		//绑定管理员
		$(AdminSet).each(function(i1,item1){
			if(i1 != 0){
				$("#ug").next().next().click();				
			}			
			$("#ug").val(item1.AdminId).trigger('change');
			//$("#ug").next().next().click();
		})
		if($('#select_ug select').val() == null){
			$('#select_ug select').val('-1').trigger('change');
		}
		if($('.container2').find(".ctrl.add").parent().children('select').val() == undefined){
			$('.container2').find(".ctrl.add").parent().children('select').val('-1').trigger('change');
		}
		// var $c = $("#ug").parent();
		// $c.children('select').select2('destroy');
		// ug_tmp = [];
		// $(AdminSet).each(function(i1,item1){
		// 	var $s = $c.clone();
		
		// 	$s.children('select').val(item1.AdminId).trigger("change");
		// 	$s.append('<i class="ctrl del" onclick="_delUg(this)"></i>').children('i.add').remove();
		// 	$c.after($s);
		// 	$s.children('select').select2({minimumResultsForSearch: -1})
		// 	ug_tmp.push((item1.AdminId).toString());
		// })
		// $c.children('select').select2({minimumResultsForSearch: -1});
	}else{				//用户
		//_showLoading();
		Flag_load = 0;
		CREATE_FLAG = true;
		group_array = [];
		$(".container").show();
		$("#user_title").text("编辑用户");
		$(".container3").hide();
		$('#action_div').hide();
		client_list = ['-1'];
		$("div[data-id=xSelect-client]").remove();
		$('#accset').empty().data('xSelect','');
		//bind_client_xSelect();
		edit_ScopeSet = [];
		
		$('#user_action1').iCheck('check');
		document.getElementsByClassName('c-cont')[0].scrollTop = 0;//让滚动条出现在最上面
		user_clear();
		UGroupSet_tmp = [];
		$("#select_local").val("1").trigger('change');
		$("#changepin_local").hide();//编辑时隐藏设置初始密码
		$.ajax({//回显用户信息
			url:"/bhost/get_user_list",
			type:"POST",
			async:false,
			data:{a0:sess,a1:global_id},
			success:function(result){
				user_item = JSON.parse(result);
				if(user_item.Result == false){
					_alert(1,"用户管理","获取信息失败："+user_item.info);
					return false;
				}
				user_item = user_item.info;
				if(user_item.ManageAuthSet != null){
					$(user_item.ManageAuthSet).each(function(i,item){
						if(item.ManageAuthName.indexOf('#') <0) edit_ScopeSet.push(item)
					})
					//edit_ScopeSet = user_item.ManageAuthSet[0].MScopeSet;
				}
			}
		})
		$.ajax({//获取用户认证配置
			url:"/bhost/get_authConfig",
			type:"POST",
			async:false,
			data:{a0:sess,a1:global_id},
			success:function(result){
				auth_item = JSON.parse(result.replace(/\n/g,"\\n").replace(/\t/g,"\\t"));
				if(auth_item.Result == false){
					_alert(1,"用户管理","获取认证配置信息失败："+user_item.ErrMsg);
					return false;
				}
				if(auth_item.sFlag == true){
					$("#changepin_div").find("text").show().text("已录入");
					if($("#select_local").val() == "0" && $("#select_local").prop('disabled') == true){
						$("#select_local").val('0').trigger('change');
					}else{
						$("#select_local").val('1').trigger('change').attr("disabled",true);
					}
					KEY_SET = true;
				}else{
					$("#changepin_div").find("text").show().text("未录入");
					$("#select_local").val('0').trigger('change').attr("disabled",false);
					KEY_SET = false;
				}
				if(auth_item.fFlag == true){
					FP_SET = true;
					$("#FinP_reset_div").find("text").show().text("已录入");
					if($("#select_local").val() == "0" && $("#select_local").prop('disabled') == true){
						$("#select_local").val('0').trigger('change');
					}else{
						$("#select_local").val('1').trigger('change').attr("disabled",true);
					}
					auth_item.fContent.replace(/\\n/g,"\n").replace(/\\t/g,"\t");
					$.each(auth_item.fContent.split('\n'),function (i,item) {
						var fp_name = item.split('\t')[0];
						if(FP_TMP == ""){
							FP_TMP = fp_name + '\t' + item.split('\t')[1];
						}else{
							FP_TMP = FP_TMP + '\n' + fp_name + '\t' + item.split('\t')[1];
						}
						var html_str1 = '<li class="item" id="fp_index'+i+'" index="'+i+'" style="width: 16.5%;"><input type="text" class="form-text" id="fp_conf'+i+'" maxlength="31" style="width: 66px;" onblur="change_fpName(this)"><i class="ctrl del" onclick="_delFp(this)"></i></li>';
						$("#auth_divs").append(html_str1);
						$("#auth_divs").children('li:last').children('input').val(fp_name);
					})
				}else{
					$("#FinP_reset_div").find("text").show().text("未录入");
					$("#select_local").val('0').trigger('change').attr("disabled",false);
					FP_TMP = "";
					FP_SET = false;
				}
				//.replace(/\\n/g,"\n").replace(/\\t/g,"\t");
			}
		})
		$("#changepin_local").hide();
		$.each(user_item.UGroupSet,function(i,item){
			group_array.push(item.UGId);
		})
		_get_un(global_pid);

		bind_authtype_xSelect();
		authDefault_flag = 0;		
		$.each(authtype_data,function(i,item){
			if(item.IsDefault == true){
				$.each(item.Set,function(i1,item1){
					if(item1.AuthMode == 6){ //令牌
						authDefault_flag += 1;
					}else if(item1.AuthMode == 8){ //logbase key
						authDefault_flag += 2;
						//KEY_SET = true;
						//console.log("key true");
					}else if(item1.AuthMode == 10){ // totp
						authDefault_flag += 4;
					}else if(item1.AuthMode == 13){ // 指纹
						authDefault_flag += 8;
						//FP_SET = true;
						//console.log("fp true");
					}
				})
			}	
		})
		$('#_Idimp1').hide();
		$('#_Idimp2').hide();

		flag = 1;
		if (user_item.SecretKey != null){//编辑
			$("#totp_div").css("width","170px");
			$("#totp_div").find('label:eq(0)').css("width","30px");
			$("#totp_div").find('label:eq(1)').show();
		}else{
			$("#totp_div").css("width","105px;");
			$("#totp_div").find('label:eq(0)').css("width","0px");
			$("#totp_div").find('label:eq(1)').hide();
		}
		if(user_item.PwdApproveUserId == null){
			user_item.PwdApproveUserId = '0';
		}
		if(user_item.PhotoIcon == null){
			user_item.PhotoIcon = "avatar1.jpg";
		}
		user_ugroup = user_item.UGroupSet;
		user_Password = user_item.Password;
		_get_tokenid(user_item.UserCode);
		$("#sys_u_name").val(user_item.UserCode);
		$("#user_name").val(user_item.UserName);
		$("#UserNumber").val(user_item.UserNumber||'');
		$("#sys_u_pwd_new").val("");
		$("#sys_u_pwd_tr").val("");
		$("#thirduser").val(user_item.ThirdUserCode);
		$("#sys_u_depart").val(user_item.Department);
		$("#sys_u_phone").val(user_item.MobilePhone);
		$("#sys_u_email").val(user_item.Email);
		$("#sys_u_descr").val(user_item.Description);
		$('#CertCn').val(user_item.CertCn);
		if (user_item.SecretKey != null){
			$("#totp_checkbox").iCheck('check');
			//$("#totp_checkbox").next('span').attr('class',"checkbox checked");
			secret = user_item.SecretKey;
		}
		// $("#pu_id").val((user_item.PwdApproveUserId == null?'0':user_item.PwdApproveUserId)).trigger("change");
		flag_pin = 0;
		$(authtype_list).each(function(i,item){
			if(user_item.AuthTypeId == item.AuthTypeId){
				$(item.Set).each(function(i1,item1){
					if(item1.AuthMode == 8){
						flag_pin = 1;
					} 
				})
			}
		})		
		//$("#sys_u_authtype").val((user_item.AuthTypeId==null?'null':user_item.AuthTypeId)).trigger("change");
		$("#sys_u_authtype").find('span').text(user_item.AuthTypeId==null?'默认':user_item.AuthTypeName);
		$('#sys_u_authtype').data('value',user_item.AuthTypeId==null?'-1':user_item.AuthTypeId);
		
		$('.xSelect-authtype li').each(function(){
			if($(this).children('span').data('value') == (user_item.AuthTypeId==null?'-1':user_item.AuthTypeId)){
				change_authtype_scope(this);
				$(this).attr('class','active');
			}
		})
		
		if(user_item.TokenId != null){
			$("#ti").val(user_item.TokenId).trigger('change');
		}
		if(user_item.ExpireTime != null){
			var date = user_item.ExpireTime.split('T')[0];
			var time = user_item.ExpireTime.split('T')[1];
			var hour = time.split(':')[0];
			var min = time.split(':')[1];
			var sec = time.split(':')[2];
			$("#datepicker").val(date);
			$("#shour").val(hour);
			$("#smin").val(min);
			$("#ssec").val(sec);
		}
		var ph = user_item.PhotoIcon;
		ph = "/manage/images/" +ph;
		$('#tAvatar>img').attr('src' ,ph);
		
		
		if(user_item.SrcIPUnlimited == true){
			$("#iplimited").iCheck('check');
		}
		if(user_item.ManageIPUnlimited == true){
			$("#manaip").iCheck('check');
		}
		if(user_item.ExpireTimeEnabled == true){
			$("#timeSet").iCheck('check');
		}
		
		//绑定 客户端地址
		var MScopeSet = []; // 先把原来数据中的服务器管理取出来
		flag_client_all = 1;
		if(user_item.ManageAuthSet == null ) {
			CScopeSet=[];
			user_item.ManageAuthSet = [];
		}
		else{
			var maid = user_item.ManageAuthSet;
			global_maid = maid[0].ManageAuthId;
			CScopeSet1 = user_item.ManageAuthSet;
			var cslist = [];
			$(CScopeSet1).each(function(i,item){
				if(item.CScopeSet == null) return true;
				$(item.CScopeSet).each(function(i1,item1){
					if (item1.Type == 1){
						if(cslist.indexOf(item1.ClientScopeId) >= 0) return true;
						cslist.push(item1.ClientScopeId);
						$("#add2").next('select').val(5).trigger('change');
						$("#accset").find('span').text(item1.ClientScopeName);
						$('#accset').data('value',item1.ClientScopeId);
						if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" && $("#accset").find('span').text() != "请选择"){
							$("#add2").click();
						}
						if(item.ManageAuthName.indexOf('#') <0 ){
							$("#add2").parent('div').next().children('i.del').remove(); //##公有的 不能删除
							$("#add2").parent('div').next().attr('auth_id',item.ManageAuthId);
						}
						
					}else{
						if(item1.IPList == null) item1.IPList == [];
						if(item1.MACList == null) item1.MACList == [];
						
						$.each(item1.IPList.Set,function(i2,item2){
							if(item2.StartIP == item2.EndIP){
								$("#add2").next().val(1).trigger('change');
								$("#Temp4 .sitem:first").find('.set-view.set-view4').children().val(item2.StartIP);
								//if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" && $("#accset").find('span').text() != "请选择"){
								if($("#Temp4").children('.sitem:first').find('input:visible').val() != ""){
									$("#add2").click();
								}								
								
								
								
							}else{
								$("#add2").next().val(2).trigger('change');
								$("#Temp4 .sitem:first").find('.set-view.set-view2').children().eq(0).val(item2.StartIP);
								$("#Temp4 .sitem:first").find('.set-view.set-view2').children().eq(2).val(item2.EndIP);
								
								if($("#Temp4").children('.sitem:first').find('input:visible').val() != ""){
									$("#add2").click();
								}
								
								
							}
						});
						$.each(item1.MACList.Set,function(i2,item2){
							if(item2.StartMACAddress == item2.EndMACAddress){
								$("#add2").next().val(3).trigger('change');
								$("#Temp4 .sitem:first").find('.set-view.set-view3').children().val(item2.StartMACAddress);
								if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" ){
									$("#add2").click();
								}
								//$("#add2").click();
							}else{
								$("#add2").next().val(4).trigger('change');
								$("#Temp4 .sitem:first").find('.set-view.set-view5').children().eq(0).val(item2.StartMACAddress);
								$("#Temp4 .sitem:first").find('.set-view.set-view5').children().eq(2).val(item2.EndMACAddress);
								if($("#Temp4").children('.sitem:first').find('input:visible').val() != "" ){
									$("#add2").click();
								}								
								//$("#add2").click();
							}
						});			
					}	
				})			
			})
		}
		flag_client_all = 0;
		// $("#add2").next('select').val(1).trigger('change');
		//绑定用户组
		global_user_path = [];
		UGroupSet = user_item.UGroupSet;
		$.each(UGroupSet,function(i,item){
			global_user_path.push(item.UGId);
		})
		$("#sys_u_name").attr("disabled",true);
		if(user_item.UserStatus == 1 || user_item.UserStatus == 7  || user_item.UserStatus == 8 || user_item.UserStatus == 9) $('#status').iCheck('check');
		else $('#status').iCheck('uncheck');
		if(user_item.LoginUniqueIP == true){
			$("#uniqueIP").iCheck('check');
		}else{
			$("#uniqueIP").iCheck('uncheck');
		}
	}
}
	var global_user_path = [];
	//记录结果
	var result_tmp = {
		total:0,
		finish:0,
		success:0,
		fail:0
	};
	//粘贴
	function paste(){
		_hideMenu();
		if(copyArray == "" || (copyArray.userGroups == "" && copyArray.users == "")){//判断是否未批量粘贴
			if(copy_id == ""){
				return false;
			}
			var loginusercode = window.parent.document.frm.us.value;
			var d = $("#route-root").next().children().length;
			if(d == 0){
				var newpid = 0;
				global_pid = "route-root";
			}else{
				d = $("#route-root").next().children().last();
				var newpid = d[0].id.split('-')[2];		
				global_pid = d[0].id;
			}

			//判断
			var flag_g = 0;
			if($("#route-root").next().children().last().attr('id') == 'route-0-1'){//在未分组下
				if(iscut == false && isuser == true){			//复制粘贴用户操作
					_alert(1,"用户管理","粘贴失败：不能将其他组下用户复制到未分组下");
					return false;
				}
				if(iscut == true && isuser == true){			//剪切粘贴用户操作
					$.ajax({
						url:"/bhost/get_user_list",
						type:"POST",
						async:false,
						data:{a0:sess,a1:copy_id},
						success:function(result){
							user_item = JSON.parse(result);
							user_item = user_item.info;
							if(user_item.UGroupSet.length != 1){
								_alert(1,"用户管理","粘贴失败：该用户从属多个用户组");
								flag_g = 1;
								return false;
							}
						}
					})
				}
			}
			if(flag_g == 1){
				return false;
			}
			////
			$.ajax({
				url:"/bhost/paste_user",
				type:"POST",
				async:false,
				data:{a0:sess,a1:loginusercode,a2:oldpid,a3:newpid,a4:copy_id,a5:isuser,a6:iscut,a10:"运维管理>用户管理"},
				success:function(result){ 
					var paste_result = JSON.parse(result);
					var paste_new_id;
					if(paste_result.Result == false){
						_alert(1,"用户管理","粘贴失败："+paste_result.ErrMsg);
						return false;
					}else{
						_alert(0,"用户管理","粘贴成功");
						if(iscut == true){
							paste_new_id = copy_id;
						}else{
							paste_new_id = paste_result.ID;
						}
						if(isuser == false){
							$("#hostCatelog").find("a[class ='active']").click();
							if($("#hostCatelog").find("a[class ='active']").prev().attr('class') == 'h-aicon h-aicon-d'){//catelog中当前组展开时加入新复制、粘贴的用户组
								var flag_mem = copy_mem;
								var groupName = copy_name;
								if(flag_mem == 0){
									$("#hostCatelog").find("a[class ='active']").next('ul').append('<li><i class="h-blank"></i><a href="javascript:;" id="node-'+newpid+'-'+paste_new_id+'" mem="'+flag_mem+'" title="'+groupName+'"><i class="h-eicon h-eicon-g"></i><span>'+groupName+'</span></a></li>');
								}else{
									$("#hostCatelog").find("a[class ='active']").next('ul').append('<li><i class="h-aicon"></i><a href="javascript:;" id="node-'+newpid+'-'+paste_new_id+'" mem="'+flag_mem+'" title="'+groupName+'"><i class="h-eicon h-eicon-g"></i><span>'+groupName+'</span></a></li>');
								}
							}else if($("#hostCatelog").find("a[class ='active']").prev().attr('class') == 'h-blank'){//catelog中当前组未展开时加入下拉三角
								$("#hostCatelog").find("a[class ='active']").prev().attr('class','h-aicon');
								$("#hostCatelog").find("a[class ='active']").after('<ul><p>Loading...</p></ul>');
							}
						}

						if(iscut == false){                  //复制操作
							refresh();
						}else{				//剪切粘贴操作
							if(isuser == true){		//剪切粘贴用户后操作
								$("#cnode-" +oldpid +'-' +paste_new_id).parent().remove();
								refresh();
							}else{
								$("#node-"+oldpid+"-"+copy_id).parent().remove();
								var oldGMember_now = oldGMember - 1;
								$('#'+oldGId).attr('mem',oldGMember_now);
								if(oldGMember_now == 0){
                                    $('#'+oldGId).prev().attr('class','h-blank'); 
                                    $('#' + oldGId).siblings('ul').html('<p>Loading...</p>');
								}
							}
							copy_id = "";
						}
						var memNum = parseInt($("#hostCatelog").find("a[class ='active']").attr("mem")) + 1;
						$("#hostCatelog").find("a[class ='active']").attr("mem",memNum);
					}
				}
			})

        }
        else{
			//记录结果
			result_tmp = {
				total:0,
				finish:0,
				success:0,
				fail:0,
				userGSusNum:0
			};
			result_tmp.total = copyArray.userGroups.length + copyArray.users.length;
			_getLoadBar();
			var finishNum = 0;
			var successNum = 0;
			var failNum = 0;
			var userGSusNum = 0;
			var loginusercode = window.parent.document.frm.us.value;
			var d = $("#route-root").next().children().length;
			var newpid;
			if(d == 0){
				newpid = 0;
			}else{
				d = $("#route-root").next().children().last();
				newpid = d[0].id.split('-')[2];		
			}
			function pasteUserG(){
				var time;
				var isuser = false;
				_do = function () {
					var copy_id;
					var oldpid;
					if(finishNum < copyArray.userGroups.length){
						copy_id = copyArray.userGroups[finishNum].id;
						oldpid = copyArray.userGroups[finishNum].pid;
					}else{	//用户组操作结束 ，开始处理被选用户
						pasteUser();
						clearTimeout(time);
						return false;
					}
					$.ajax({
						url:"/bhost/paste_user",
						type:"POST",
						async:false,
						data:{a0:sess,a1:loginusercode,a2:oldpid,a3:newpid,a4:copy_id,a5:isuser,a6:iscut,a10:"运维管理>用户管理"},
						success:function(result){
							clearTimeout(time);
							var ugroup_result = JSON.parse(result);
							var paste_new_id;
							time = setTimeout(function(){_do();},1);
							if(ugroup_result.Result == false){
								finishNum++;
								result_tmp.finish = finishNum;
								failNum++;
								result_tmp.fail = failNum;
							}else{
								if(iscut == true){
									paste_new_id = copy_id;
								}else{
									paste_new_id = ugroup_result.ID;
								}
								finishNum++;
								result_tmp.finish = finishNum;
								successNum++;
								result_tmp.success = successNum;
								userGSusNum++;
								result_tmp.userGSusNum = userGSusNum;
								if(iscut == true){
									$("#node"+"-"+oldpid+"-"+copy_id).parent().remove();
								}
								if($("#hostCatelog").find("a[class ='active']").prev().attr('class') == 'h-aicon h-aicon-d'){//catelog中当前组展开时加入新复制、粘贴的用户组
									var flag_mem = copyArray.userGroups[finishNum-1].mem;
									var groupName = copyArray.userGroups[finishNum-1].name;
									$("#cnode"+"-"+oldpid+"-"+paste_new_id).parent().remove();
									if(flag_mem == 0){
										$("#hostCatelog").find("a[class ='active']").next('ul').append('<li><i class="h-blank"></i><a href="javascript:;" id="node-'+newpid+'-'+paste_new_id+'" mem="'+flag_mem+'" title="'+groupName+'"><i class="h-eicon h-eicon-g"></i><span>'+groupName+'</span></a></li>');
									}else{
										$("#hostCatelog").find("a[class ='active']").next('ul').append('<li><i class="h-aicon"></i><a href="javascript:;" id="node-'+newpid+'-'+paste_new_id+'" mem="'+flag_mem+'" title="'+groupName+'"><i class="h-eicon h-eicon-g"></i><span>'+groupName+'</span></a></li>');
									}
								}
							}
						}
					})
				}
				_do();
			}
			function pasteUser(){
				var time;
				var isuser = true;
				_do = function () {
					var copy_id;
					var index = finishNum - copyArray.userGroups.length;
					if(index < copyArray.users.length){
						copy_id = copyArray.users[index].id;
						oldpid = copyArray.users[index].pid;
					}else{	//操作结束
						//粘贴后处理左边目录
						if(iscut == true && filter_flag == false){
							var oldGMember_now = oldGMember - result_tmp.userGSusNum;
							$('#'+oldGId).attr('mem',oldGMember_now);
							if(oldGMember_now == 0){
								$('#'+oldGId).prev().attr('class','h-blank'); 
							}
						}else if(iscut == true && filter_flag == true){
							var count = 0;
							var s = copyArray.userGroups[index].oldGId;
							$.each(copyArray.userGroups,function(i,item){
								if(item.oldGId == s){
									count++;
								}
							})
							var oldGMember_now = copyArray.userGroups[index].oldGMem - count;
							$('#'+copyArray.userGroups[index].oldGId).attr('mem',oldGMember_now);
							if(oldGMember_now <= 0){
								$('#'+copyArray.userGroups[index].oldGId).prev().attr('class','h-blank'); 
							}
						}
						$("#hostCatelog").find("a[class ='active']").click();
						var groupsNum = $("#hostContent").find('.h-bicon.h-bicon-g').length;
						$("#hostCatelog").find("a[class ='active']").attr('mem',groupsNum);
						if(groupsNum > 0 && $("#hostCatelog").find("a[class ='active']").prev().attr('class') == 'h-blank'){
							$("#hostCatelog").find("a[class ='active']").prev().attr('class','h-aicon');
							$("#hostCatelog").find("a[class ='active']").after('<ul><p>Loading...</p></ul>');
						}
						copyArray = [];
						clearTimeout(time);
						return false;
					}
					var flag_paste = 0;
					if($("#route-root").next().children().last().attr('id') == 'route-0-1'){//在未分组下
						if(iscut == false && isuser == true){			//复制粘贴用户操作
							finishNum++;
							result_tmp.finish = finishNum;
							failNum++;
							result_tmp.fail = failNum;
							flag_paste = 1;
							_do();
							return false;
						}else if(iscut == true && isuser == true){			//剪切粘贴用户操作
							$.ajax({		//回显用户信息
								url:"/bhost/get_user_list",
								type:"POST",
								async:false,
								data:{a0:sess,a1:copy_id},
								success:function(result){
									user_item = JSON.parse(result);
									user_item = user_item.info;
									if(user_item.UGroupSet.length != 1){
										finishNum++;
										result_tmp.finish = finishNum;
										failNum++;
										result_tmp.fail = failNum;
										flag_paste = 1;
									}
								}
							})
						}
					}
					if(flag_paste == 1){
						clearTimeout(time);
						time = setTimeout(function(){_do();},1);
						return false;
					}
					if(iscut == false && oldpid == 1){
						finishNum++;
						result_tmp.finish = finishNum;
						failNum++;
						result_tmp.fail = failNum;
						_do();
						return false;
					}
					$.ajax({
						url:"/bhost/paste_user",
						type:"POST",
						async:false,
						data:{a0:sess,a1:loginusercode,a2:oldpid,a3:newpid,a4:copy_id,a5:isuser,a6:iscut,a10:"运维管理>用户管理"},
						success:function(result){
							clearTimeout(time);
							time = setTimeout(function(){_do();},1);
							var ugroup_result = JSON.parse(result);
							var paste_new_id;
							if(ugroup_result.Result == false){
								finishNum++;
								result_tmp.finish = finishNum;
								failNum++;
								result_tmp.fail = failNum;
							}else{
								if(iscut == true){
									paste_new_id = copy_id;
								}else{
									paste_new_id = ugroup_result.ID;
								}
								finishNum++;
								result_tmp.finish = finishNum;
								successNum++;
								result_tmp.success = successNum;
							}
						}
					})
				}
				_do();
			}
			pasteUserG();
		}
	}
	//复制
	function copy(type_num){
        var a = null;
        if(type_num == 1){
            a=$('#'+current_id);
        }else{
            a = $("#hostContent").find("div[class='c on']");
        }
        var hostContent_on_len = a.length;
        if (hostContent_on_len == 0) {
            _alert(2, '用户', '请选择用户或用户组');
            return false;
        }
		copy_name = "";
        copy_mem = "";
		if(hostContent_on_len > 1){
            _copy_batch();
            if (first_grp == '1') {
                _alert(0, '用户管理', '复制成功');
                if (parent_id != 'route-root' && parent_id != '') {
                    $('#btn_4').show();
                }
            }
			return false;
		}
		copyArray = [];
		iscut = false;
		copy_flag = 1;
		_initHostMenu();
		_hideMenu();
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-g-cut']").attr("class","h-bicon h-bicon-g");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-h-cut']").attr("class","h-bicon h-bicon-h");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-l-cut']").attr("class","h-bicon h-bicon-l");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-d-cut']").attr("class","h-bicon h-bicon-d");
		copy_name = a.text();
		if(filter_flag == true){
			var groupId = $(a).attr('id');
			copy_mem = $('#node'+groupId).attr('mem');
		}else{
			copy_mem = $(a).attr('mem');
		}
		if(filter_flag == true){					//用来判断是否为过滤结果
			var path = a.attr("path").split('/');
			var l = path.length;
			oldpid = path[l-2].split(',')[1] //取出所在组ID
		}
		var b = a.children();
		copy_id = a[0].id.split('-')[2];    		       //选中ID
		var c = $("#route-root").next().children().length;
		if(c == 0){
			oldpid = 0;
		}
		else{
			c = $("#route-root").next().children().last();
			oldpid = c[0].id.split('-')[2];	
		}
		if($(b).attr('class')=="h-bicon h-bicon-g-cut" || $(b).attr('class')=="h-bicon h-bicon-g"){
			isuser = false;
		}
		else{
			isuser = true;
		}
		copyArray = {
			userGroups:[],
			users:[]
        };
        if (first_grp == '1') {
            _alert(0, '用户管理', '复制成功');
            if (parent_id != 'route-root' && parent_id != '') {
                $('#btn_4').show();
            }
        }
	}
	function _copy_batch(){
		iscut = false;
		copy_flag = 1;
		_initHostMenu();
		_hideMenu();
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-g-cut']").attr("class","h-bicon h-bicon-g");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-h-cut']").attr("class","h-bicon h-bicon-h");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-l-cut']").attr("class","h-bicon h-bicon-l");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-d-cut']").attr("class","h-bicon h-bicon-d");
		var a = $("#hostContent").find("div[class='c on']");
		copy_name = [];
		$.each(a,function(i,item){
			copy_name.push($(item).children('span').text());
		})

		copyArray = {
			userGroups:[],
			users:[]
		};

		var userGroups = [];
		var users = [];
		if(filter_flag != true){
			$("#hostContent").find("div[class='c on']").each(function(i,item){
				if($(item).attr("id") == 'cnode-0-1'){
					return false;
				}
				var tmp = {id:null,pid:null,mem:null,name:null};

				if($(item).children('i').attr('class').indexOf('h-bicon-g') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];
					tmp.mem = $(item).attr("mem");
					tmp.name = $(item).text();
					userGroups.push(tmp);
				}else if($(item).children('i').attr('class').indexOf('h-bicon-h') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];
					users.push(tmp);
				}
			});
		}else{				//当前为过滤结果
			$("#hostContent").find("div[class='c on']").each(function(i,item){
				var tmp = {id:null,pid:null};
				if($(item).children('i').attr('class').indexOf('h-bicon-g') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];
					userGroups.push(tmp);
				}else if($(item).children('i').attr('class').indexOf('h-bicon-h') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];				
					users.push(tmp);
				}
			});
		}
		copyArray.userGroups = userGroups;
		copyArray.users = users;
		// if(filter_flag == true){					//用来判断是否为过滤结果
		// 	var path = a.attr("path").split('/');
		// 	var l = path.length;
		// 	oldpid = path[l-2].split(',')[1] //取出所在组ID
		// }
		// var b = a.children();
		// copy_id = a[0].id.split('-')[2];    		       //选中ID
		// var c = $("#route-root").next().children().length;
		// if(c == 0){
		// 	oldpid = 0;
		// }
		// else{
		// 	c = $("#route-root").next().children().last();
		// 	oldpid = c[0].id.split('-')[2];
		// }
		// if($(b).attr('class')=="h-bicon h-bicon-g-cut" || $(b).attr('class')=="h-bicon h-bicon-g"){
		// 	isuser = false;
		// }
		// else{
		// 	isuser = true;
		// }
	}

	var oldGMember;
	var oldGId;
	var copy_mem;
	//剪切
	function cut(type_num){
        var a = null;
        if (type_num == 1) {
            a = $('#' + current_id);
        } else {
            a = $("#hostContent").find("div[class='c on']");
        }
        var hostContent_on_len = a.length;
        if (hostContent_on_len == 0) {
            _alert(2, '用户', '请选择用户或用户组');
            return false;
        }
		oldGMember = 0;
		oldGId = 0;
		copy_name = "";
		copy_mem = "";
		if(hostContent_on_len > 1){
            _cut_batch();
            if (first_grp == '1') {
                _alert(0, '用户管理', '剪切成功');
                if (parent_id != 'route-root' && parent_id != '' && parent_id!='node-0-1') {
                    $('#btn_4').show();
                }
            }
			return false;
		}
		copyArray = [];
		iscut = true;
		copy_flag = 1;
		_initHostMenu();
		_hideMenu();
		$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-g-cut']").attr("class","h-bicon h-bicon-g");
		$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-h-cut']").attr("class","h-bicon h-bicon-h");
		$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-l-cut']").attr("class","h-bicon h-bicon-l");
		$("#hostContent").find("div[class='item']").find("i[class='h-bicon h-bicon-d-cut']").attr("class","h-bicon h-bicon-d");
		copy_name = a.text();
		if(filter_flag == true){
			var groupId = $(a).attr('id');
			copy_mem = $('#node'+groupId).attr('mem');
		}else{
			copy_mem = $(a).attr('mem');
		}
		var class_tmp = a.children('i').attr('class');
		h = a;
		h.children("i").attr("class",class_tmp +"-cut");
		var b = a.children();
		copy_id = a[0].id.split('-')[2];    		       //选中ID
		var c = $("#route-root").next().children().length;
		if(c == 0){
			oldpid = 0;
			copy_piid = "";
			cut_num = $("#hostContent div.item>div.c>i[class='h-bicon h-bicon-g'],i[class='h-bicon h-bicon-g-cut']").length;
		}
		else{
			c = $("#route-root").next().children().last();
			oldpid = c[0].id.split('-')[2];
			copy_piid = "";	
			cut_num = $("#hostContent div.item>div.c>i[class='h-bicon h-bicon-g'],i[class='h-bicon h-bicon-g-cut']").length;
		}
		if(filter_flag == true){					//为过滤结果
			var path = a.attr("path").split('/');
			var l = path.length;
			oldpid = path[l-2].split(',')[1] ;//取出所在组ID
			if(oldpid == undefined){
				if($("#route-root").next().length == 0){
					oldpid = 0;
				}
				else{
					oldpid = $("#route-root").next().children().last().attr('id').split('-')[2];
				}
			}
			m = a[0].id.replace('c','');
			copy_piid = $("#" +m).parent().parent().prev().attr('id');
		}
		if($(b).attr('class')=="h-bicon h-bicon-g-cut" || $(b).attr('class')=="h-bicon h-bicon-g"){
			isuser = false;
		}
		else{
			isuser = true;
		}
		oldGId = $("#hostCatelog").find('.active').attr('id');
        oldGMember = $("#hostCatelog").find('.active').attr('mem');
        if (first_grp == '1') {
            _alert(0, '用户管理', '剪切成功');
            if (parent_id != 'route-root' && parent_id != '' && parent_id!='node-0-1') {
                $('#btn_4').show();
            }
        }
	}
	var copyArray = [];
	function _cut_batch(){
		iscut = true;
		copy_flag = 1;
		_initHostMenu();
		_hideMenu();
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-g-cut']").attr("class","h-bicon h-bicon-g");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-h-cut']").attr("class","h-bicon h-bicon-h");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-l-cut']").attr("class","h-bicon h-bicon-l");
		$("#hostContent").find("div[class ='item']").find("i[class='h-bicon h-bicon-d-cut']").attr("class","h-bicon h-bicon-d");
		var a = $("#hostContent").find("div[class='c on']");
		copy_name = [];
		$.each(a,function(i,item){
			copy_name.push($(item).children('span').text());
			var class_tmp = $(item).children('i').attr('class');
			$(item).children('i').attr("class",class_tmp +"-cut");
		})

		copyArray = {
			userGroups:[],
			users:[]
		};

		var userGroups = [];
		var users = [];
		if(filter_flag != true){
			$("#hostContent").find("div[class='c on']").each(function(i,item){
				if($(item).attr("id") == 'cnode-0-1'){
					return false;
				}
				var tmp = {id:null,pid:null,mem:null,name:null};
				if($(item).children('i').attr('class').indexOf('h-bicon-g') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];
					tmp.mem = $(item).attr("mem");
					tmp.name = $(item).text();
					userGroups.push(tmp);
				}else if($(item).children('i').attr('class').indexOf('h-bicon-h') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];
					users.push(tmp);
				}
			});
			oldGId = $("#hostCatelog").find('.active').attr('id');
			oldGMember = $("#hostCatelog").find('.active').attr('mem');
		}else{				//当前为过滤结果
			$("#hostContent").find("div[class='c on']").each(function(i,item){
				var tmp = {id:null,pid:null,mem:null,name:null,oldGId:null,oldMem:null};
				if($(item).children('i').attr('class').indexOf('h-bicon-g') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];
					var itemId = $(item).attr("id").split('cnode')[1];
					var groupMemNum = $("#node"+itemId).attr('mem');
					if(itemId.split('-')[1] == 0){
						oldGId = 0;
						oldMem = 0;
					}else{
						var oldGId = $("#node"+itemId).parent().parent().prev().attr('id').split('node')[1];
						var oldMem = $("#node"+itemId).parent().parent().prev().attr('mem');
					}
					tmp.mem = groupMemNum;
					tmp.name = $(item).text();
					tmp.oldGId = oldGId;
					tmp.oldMem = oldMem;		
					userGroups.push(tmp);
				}else if($(item).children('i').attr('class').indexOf('h-bicon-h') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];				
					users.push(tmp);
				}
			});
		}
		copyArray.userGroups = userGroups;
		copyArray.users = users;
	}

	//删除
	function _delete(type,type_num){
        if (type==1){
            var hostContent_on_hg_len=$("#hostContent div.c.on i.h-bicon-g").length+ $("#hostContent div.c.on i.h-bicon-g-cut").length;
            
            if(hostContent_on_hg_len>0){
                _alert(2,'用户','无法移除用户组');
                return false;
            }
        }
        var a = null;
        if (type_num == 1) {
            a = $('#' + current_id);
        } else {
            a = $("#hostContent").find("div[class='c on']");
        }
        var hostContent_on_len = a.length;
        if (hostContent_on_len == 0) {
            _alert(2, '用户', '请选择用户或用户组');
            return false;
        }
		if(hostContent_on_len > 1){
			_delete_batch(type);
			return false;
		}
		_hideMenu();
		var isdeleteuser = "";
		var flag_t = type;
		// var a = $("#hostContent").find("div[class='c on']");//获取选中信息
		var b = a.children();
		global_id = a[0].id.split('-')[2];    		       //选中ID
		var c = $("#route-root").next().children().length; 
		if(c == 0){		//当前为根目录
			global_pid = 0;
		}
		else{
			c = $("#route-root").next().children().last();
			global_pid = c[0].id.split('-')[2];		
		}
		if(filter_flag == true){					//当前为过滤结果
			var path = a.attr("path").split('/');
			var l = path.length;
			global_pid = a.attr('id').split('-')[1];
			m = a[0].id.replace('c','');
			copy_piid = $("#" +m).parent().parent().prev().attr('id')
		}
		var loginusercode = window.parent.document.frm.us.value;
		if(flag_t == 1){
			var isuser = true;
			layer.open({
				type: 1,
				title: '用户管理',
				content: '<div class="layer-alert"><i class="alert warning"></i>移除用户</div>',
				btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					layer.close(i);
					isdeleteuser = false;
					$.ajax({
						url:"/bhost/delete_user_list",
						type:"POST",
						async:false,
						data:{a0:sess,a1:loginusercode,a2:global_pid,a3:global_id,a4:isuser,a5:isdeleteuser,a10:"运维管理>用户管理"},
						success:function(result){ 
							var ugroup_result = JSON.parse(result);
							if(ugroup_result.Result == false){
								_alert(1,"用户管理","移除失败："+ugroup_result.ErrMsg);
								return false;
							}
							else{
								if(global_id == copy_id){
									copy_id = "";
								}
								_alert(0,"用户管理","移除成功");
                                if (first_grp=='1'){
                                    $("#cnode" + "-" + global_pid + "-" + global_id).parents('tr').remove();
                                }else{
                                    $("#cnode"+"-"+global_pid+"-" + global_id).parent().remove();
                                }
								//refresh();
							}
						}
					})
				},
				btn2:function(i){
					layer.close(i);
				}
			});
        }
        else if(flag_t == 0){
			layer.open({
				type: 1,
				title: '用户管理',
				content: '<div class="layer-alert"><i class="alert warning"></i>确认删除</div>',
				btn:['确&nbsp;&nbsp;认','取&nbsp;&nbsp;消'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				yes:function(i){
					layer.close(i);
					if($(b).attr('class')=="h-bicon h-bicon-g-cut" || $(b).attr('class')=="h-bicon h-bicon-g"){
						var isuser = false;
						layer.open({
							type: 1,
							title: '用户管理',
							content: '<div class="layer-alert"><i class="alert warning"></i>是否删除组内用户</div>',
							btn:['是','否'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							btn1:function(i){
								layer.close(i);
								isdeleteuser = true;
								$.ajax({
									url:"/bhost/delete_user_list",
									type:"POST",
									async:false,
									data:{a0:sess,a1:loginusercode,a2:global_pid,a3:global_id,a4:isuser,a5:isdeleteuser,a10:"运维管理>用户管理"},
									success:function(result){ 
										var ugroup_result = JSON.parse(result);
										if(ugroup_result.Result == false){
											_alert(1,"用户管理","删除失败："+ugroup_result.ErrMsg);
											return false;
										}
										else{
											if(global_id == copy_id){
												copy_id = "";
											}
											_alert(0,"用户管理","删除成功");
                                            // $("#hostCatelog").find("a[class ='active']").click();
                                            //console.log(global_pid);
                                            //console.log(global_id);
											if(global_pid == 0){
                                                if (first_grp=='1')
												$("#cnode"+"-"+global_pid+"-"+global_id).parents('tr').remove();
                                                else
												$("#cnode"+"-"+global_pid+"-"+global_id).parent().remove();
												$("#node"+"-"+global_pid+"-"+global_id).parent().remove();
											}
											else{
												$("#node"+"-"+global_pid+"-"+global_id).parent().remove();
                                                if (first_grp == '1')
                                                $("#cnode" + "-" + global_pid + "-" + global_id).parents('tr').remove();
                                                else
                                                $("#cnode"+"-"+global_pid+"-"+global_id).parent().remove();
												if($("#hostContent div.item>div.c>i[class='h-bicon h-bicon-g']").length == 0){
                                                    var $active_a=$("#hostCatelog").find("a[class='active']");
													$active_a.siblings('i').attr("class","h-blank");
													$active_a.siblings('ul').remove();
                                                }
												if(filter_flag == true){
                                                    if($("#" +copy_piid).next().children("li").length == 0){
                                                        $("#" +copy_piid).siblings("i").attr("class","h-blank");
                                                        $("#" + copy_piid).siblings('ul').remove();
                                                    }
                                                }
											}
											//refresh();
										}						           
							   		}
							   	})
							},
							btn2:function(i){
								isdeleteuser = false;
								$.ajax({
									url:"/bhost/delete_user_list",
									type:"POST",
									async:false,
									data:{a0:sess,a1:loginusercode,a2:global_pid,a3:global_id,a4:isuser,a5:isdeleteuser,a10:"运维管理>用户管理"},
									success:function(result){ 
										var ugroup_result = JSON.parse(result);
										if(ugroup_result.Result == false){
											_alert(1,"用户管理","删除失败："+ugroup_result.ErrMsg);
											return false;
										}
										else{
											if(global_id == copy_id){
												copy_id = "";
											}
											_alert(0,"用户管理","删除成功");
											// refresh();
											// $("#hostCatelog").find("a[class ='active']").click();
											if(global_pid == 0){
                                                if (first_grp == '1')
												$("#cnode"+"-"+global_pid+"-"+global_id).parents('tr').remove();
                                                else
												$("#cnode"+"-"+global_pid+"-"+global_id).parent().remove();
												$("#node"+"-"+global_pid+"-"+global_id).parent().remove();
											}
											else{
												$("#node"+"-"+global_pid+"-"+global_id).parent().remove();
                                                if (first_grp == '1')
                                                $("#cnode"+"-"+global_pid+"-"+global_id).parents('tr').remove();
                                                else
                                                $("#cnode"+"-"+global_pid+"-"+global_id).parent().remove();
                                                if ($("#hostContent div.item>div.c>i[class='h-bicon h-bicon-g']").length == 0) {
                                                    var $active_a = $("#hostCatelog").find("a[class='active']");
                                                    $active_a.siblings('i').attr("class", "h-blank");
                                                    $active_a.siblings('ul').remove();
                                                }
                                                if (filter_flag == true) {
                                                    if ($("#" + copy_piid).next().children("li").length == 0) {
                                                        $("#" + copy_piid).siblings("i").attr("class", "h-blank");
                                                        $("#" + copy_piid).siblings('ul').remove();
                                                    }
                                                }
											}
							            }
							   		}
							   	})
							    layer.close(i);
							}
						}); 
					}
					else{
						var isuser = true;
						isdeleteuser = true;
						$.ajax({
							url:"/bhost/delete_user_list_u",
							type:"POST",
							async:false,
							data:{a0:sess,a1:loginusercode,a2:global_id,a10:"运维管理>用户管理"},
							success:function(result){ 
								var ugroup_result = JSON.parse(result);
								if(ugroup_result.Result == false){
									_alert(1,"用户管理","删除失败："+ugroup_result.ErrMsg);
									return false;
								}
								else{
									if(global_id == copy_id){
										copy_id = "";
									}
									_alert(0,"用户管理","删除成功");
									$.each($("#hostContent").find('div.c'),function(i,item){
										if($(item).attr('id').split('-')[2] == global_id){
                                            if (first_grp == '1')
											$(item).parents('tr').remove();
                                            else
											$(item).parent().remove();
										}
									})
									//$("#cnode"+"-"+global_pid+"-"+global_id).parent().remove();
									//refresh();
								}
							}
						})
					}
				},
				no:function(i){
					layer.close(i);
				}
			});
		}
	}
	function _delete_batch(type){
		var typ = type;
		var isdeleteuser = "";
		var c = $("#route-root").next().children().length; // 0-->根目录
		if(c == 0){
			global_pid = 0;
		}else{
			c = $("#route-root").next().children().last();
			global_pid = c.attr("id").split('-')[2];		
		}
		//获取选中信息
		var delete_ids = {
			userGroups:[],
			users:[]
		}
		var userGroups = [];
		var users = [];
		if(filter_flag != true){
			$("#hostContent").find("div[class='c on']").each(function(i,item){
				if($(item).attr("id") == 'cnode-0-1'){
					return false;
				}
				var tmp = {id:null,pid:null};
				if($(item).children('i').attr('class').indexOf('h-bicon-g') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = global_pid;
					userGroups.push(tmp);
				}else if($(item).children('i').attr('class').indexOf('h-bicon-h') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = global_pid;
					users.push(tmp);
				}
			});
		}else{				//当前为过滤结果
			$("#hostContent").find("div[class='c on']").each(function(i,item){
				var tmp = {id:null,pid:null};
				if($(item).children('i').attr('class').indexOf('h-bicon-g') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];
					userGroups.push(tmp);
				}else if($(item).children('i').attr('class').indexOf('h-bicon-h') >= 0 ){
					var id_s = $(item).attr("id").split('-')[2];
					tmp.id = id_s;
					tmp.pid = $(item).attr("id").split('-')[1];				
					users.push(tmp);
				}
			});
		}
		delete_ids.userGroups = userGroups;
		delete_ids.users = users;
		//
		// if(filter_flag == true){
		// 	var path = a.attr("path").split('/');
		// 	var l = path.length;
		// 	global_pid = a.attr('id').split('-')[1];
		// 	m = a[0].id.replace('c','');
		// 	copy_piid = $("#" +m).parent().parent().prev().attr('id')
		// }
		var loginusercode = window.parent.document.frm.us.value;

		//记录结果
		result_tmp = {
			total:0,
			finish:0,
			success:0,
			fail:0
		};
		result_tmp.total = userGroups.length + users.length;
		function delete_function(){
			var finishNum = 0;
			var successNum = 0;
			var failNum = 0;

			function deleteUserG(){
				var time;
				var isuser = false;
				_do = function () {
					var g_id;
					var g_pid;	//用户组的父组ID，为了记录检索后被选组的父组ID
					if(finishNum < delete_ids.userGroups.length){
						g_id = delete_ids.userGroups[finishNum].id;
						g_pid = delete_ids.userGroups[finishNum].pid
					}else{	//用户组操作结束 ，开始处理被选用户
						deleteUser();
						clearTimeout(time);
						return false;
					}
					$.ajax({
						url:"/bhost/delete_user_list",
						type:"POST",
						async:false,
						data:{a0:sess,a1:loginusercode,a2:g_pid,a3:g_id,a4:isuser,a5:isdeleteuser,a10:"运维管理>用户管理"},
						success:function(result){
							clearTimeout(time);
							var ugroup_result = JSON.parse(result);
							time = setTimeout(function(){_do();},1);
							if(ugroup_result.Result == false){
								finishNum++;
								result_tmp.finish = finishNum;
								failNum++;
								result_tmp.fail = failNum;
							}else{
								finishNum++;
								result_tmp.finish = finishNum;
								successNum++;
								result_tmp.success = successNum;
								var memNum = parseInt($("#hostCatelog").find("a[class ='active']").attr('mem')) - 1;
								$("#hostCatelog").find("a[class ='active']").attr('mem',memNum);
								if(global_pid == 0){
                                    $("#node"+"-"+g_pid+"-"+g_id).parent().remove();
                                    if (first_grp == '1') {
                                        $("#cnode"+"-"+g_pid+"-"+g_id).parents('tr').remove();
                                    }
                                    else
									    $("#cnode"+"-"+g_pid+"-"+g_id).parent().remove();
								}else{
                                    $("#node"+"-"+g_pid+"-"+g_id).parent().remove();
                                    if (first_grp == '1') 
                                        $("#cnode"+"-"+g_pid+"-"+g_id).parents('tr').remove();
                                    else
									    $("#cnode"+"-"+g_pid+"-"+g_id).parent().remove();
								}
							}
						}
					})
				}
				_do();
			}
			function deleteUser(){
				var time;
				var isuser = true;
				_do = function () {
					var g_id;
					var g_pid;
					var index = finishNum - delete_ids.userGroups.length;
					if(index < delete_ids.users.length){
						g_id = delete_ids.users[index].id;
						g_pid = delete_ids.users[index].pid;
					}else{	//操作结束
						//删除后处理左边目录
						if(filter_flag != true){
							if($("#hostContent").find(".h-bicon.h-bicon-g").length == 0){
                                var $active_a= $("#hostCatelog").find('.active');
                                $active_a.prev().attr('class','h-blank');
                                $active_a.next('ul').remove();
							}
							$("#hostCatelog").find("a[class ='active']").click();
						}else{	//过滤后
							$("#hostCatelog").find(".h-aicon.h-aicon-d").each(function(i,item){
								if($(item).siblings('ul').children('li').length == 0){
                                    $(item).attr("class",'h-blank');
                                    $(item).siblings('ul').remove();
								}
							})
						}
						clearTimeout(time);
						delete_ids = {
							userGroups:[],
							users:[]
						}
						return false;
					}
					if(typ ==0){
						$.ajax({
							url:"/bhost/delete_user_list_u",
							type:"POST",
							async:false,
							data:{a0:sess,a1:loginusercode,a2:g_id,a10:"运维管理>用户管理"},
							success:function(result){
								clearTimeout(time);
								time = setTimeout(function(){_do();},1);
								var ugroup_result = JSON.parse(result);
								if(ugroup_result.Result == false){
									finishNum++;
									result_tmp.finish = finishNum;
									failNum++;
									result_tmp.fail = failNum;
								}else{
									finishNum++;
									result_tmp.finish = finishNum;
									successNum++;
                                    result_tmp.success = successNum;
                                    if (first_grp == '1')
									$("#cnode"+"-"+g_pid+"-"+g_id).parents('tr').remove();
                                    else
									$("#cnode"+"-"+g_pid+"-"+g_id).parent().remove();
								}
							}
						})
					}else{
						$.ajax({
							url:"/bhost/delete_user_list",
							type:"POST",
							async:false,
							data:{a0:sess,a1:loginusercode,a2:g_pid,a3:g_id,a4:true,a5:false,a10:"运维管理>用户管理"},
							success:function(result){ 
								clearTimeout(time);
								time = setTimeout(function(){_do();},1);
								var ugroup_result = JSON.parse(result);
								if(ugroup_result.Result == false){
									finishNum++;
									result_tmp.finish = finishNum;
									failNum++;
									result_tmp.fail = failNum;
								}else{
									finishNum++;
									result_tmp.finish = finishNum;
									successNum++;
                                    result_tmp.success = successNum;
                                    if (first_grp == '1')
									$("#cnode"+"-"+g_pid+"-"+g_id).parents('tr').remove();
                                    else
									$("#cnode"+"-"+g_pid+"-"+g_id).parent().remove();
								}
							}
						})
					}
				}
				_do();
			}
			deleteUserG();
		}
		if(typ == 0){
			layer.open({
				type: 1,
				title: '用户管理',
				content: '<div class="layer-alert"><i class="alert warning"></i>确认删除</div>',
				btn:['是','否'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					layer.close(i);
					_getLoadBar();
					if(delete_ids.userGroups.length != 0){	//多选中有用户组
						var isuser = false;
						layer.open({
							type: 1,
							title: '用户管理',
							content: '<div class="layer-alert"><i class="alert warning"></i>是否删除组内用户</div>',
							btn:['是','否'],
							btnAlign:'c',
							closeBtn: false,
							skin:'layer-custom',
							area:['380px','310px'],
							move: false,
							resize: false,
							btn1:function(i){
								layer.close(i);
								isdeleteuser = true;
								delete_function();
							},
							btn2:function(i){
								layer.close(i);
								isdeleteuser = false;
								delete_function();
							}
						});
					}else{
						if(type == 0){
							isdeleteuser = true;
						}else if(type == 1){
							isdeleteuser = false;
						}
						delete_function();
					}
				},
				btn2:function(i){
					layer.close(i);
				}
			})
        }
        else{
			layer.open({
				type: 1,
				title: '用户管理',
				content: '<div class="layer-alert"><i class="alert warning"></i>确认移除</div>',
				btn:['是','否'],
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					layer.close(i);
					_getLoadBar();
					isdeleteuser = false;
					delete_function();

				},
				btn2:function(i){
					layer.close(i);
				}
			})
		}
	}



	var loadBarLayer;//批量操作进度条
	function _getLoadBar(){
		var _loadBar = function(){
			$('#loadBarWrap').html('<div class="loadperw-host"><span id="loadNum"></span><span id="loadPer"></span></div><span id="loadPerText_host">0%</span><div class="loadberBtn"><a id="loadberBtn" href="javascript:;" onclick="_close(this)">关闭</a></div>');

			var _runOut;
			var _run = function(){
				_runOut = setTimeout(function(){
					var i = parseInt(result_tmp.finish),imax = parseInt(result_tmp.total);
					if(i < imax){
						$('#loadNum').text(i+'/'+imax);
						var per = parseInt(i/imax * 100);
						$('#loadPer').width(per+'%');
						$('#loadPerText_host').text(per+"%");
						_run();
					}else{
						$('#loadNum').text(i+'/'+imax);
						var per = parseInt(i/imax * 100);
						$('#loadPer').width(per+'%');
						$('#loadPerText_host').text(per+"%");
						$("#loadPerText_host").after('<p style="margin: -2px 0 0 8px;">成功数：'+result_tmp.success+'条，失败数：'+result_tmp.fail+'条</p>');
						clearTimeout(_runOut);
						$('#loadberBtn').css('display','block');
					}
				},10);
			}
			_run();
		}

		loadBarLayer = layer.open({
			title:false,
			closeBtn:false,
			content:'<div class="lodabar-w-host" id="loadBarWrap">加载中...</div>',
			btn:false,
			skin:'loadbar',
			area:['430px','400px'],
			move:false,
			success:function(i){
				_loadBar();
			}
		})
	}
	function _close(obj){
		layer.close(loadBarLayer);
	}

	function _hideMenu(){
		var $_menu = $('#hostMenu1,#hostMenu2,#markView');
		if($_menu.is(':visible')){
		    $_menu.remove();
		}
	}

	function _initSize(){
		var h = $(window).height();
		$('.h-catelog').height(h-200);
        $('.h-content').height(h-220);
        $('.h-catelog-son-div').height(h - 200 - 57);
        $('.h-content').width($('.h-explorer').width()-$('.h-catelog').width() - 33);
        $('.user_list_div').height(h - 220 - (244 - 158));
		$('div.container3 div.h-content').width($('div.container3 div.h-explorer').width()-$('.h-catelog').width() - 33);
	}

	function _pathWrap(){
		var w1 = $('div.h-top1').width(),
		w2 = $('#route-root').outerWidth(),
		w3 = $('div.filter1').outerWidth();
		var ww = w1-w2-w3-120;
		
		$('div.h-path-wrap span.over').next('span.fix').remove();
		$('div.h-path-wrap span.over').remove();
		
		$('div.h-path-wrap').width(ww);

		var len = $('div.h-path-wrap>a').length;
		var z = Math.floor(ww/90);
		if(len>z){
			if($('#hOver').length == 0){
				$('body').append('<div id="hOver" />');
			}

			var $over = $('#hOver');
			var n = len-z+1;
			$over.empty();
			$('div.h-path-wrap>a').each(function(i){
				if(i <=n && i>0){
					$(this).clone().show().appendTo($over);
					$(this).hide().next('span.fix').hide();
				}else{
					$(this).show().next('span.fix').show();
				}
			});
			
			$('div.h-path-wrap>span.fix:first').after('<span class="over">……</span><span class="fix"></span>');
		}else{
			$('div.h-path-wrap>a').show().next('span.fix').show();
		}
		$('#hOver').unbind().on('click','a',function(){
			id = $(this).attr('id').replace('route','node');
			$('#'+ id).click(); 
		});		
	}

	$(function(){
		var hHide = function(){
			$('#hOver').hide();
			$('span.over').removeClass('on');
		},hout;

		$('.h-route').on('mouseover','span.over',function(){
			clearTimeout(hout);
			$(this).addClass('on');
			var offset = $(this).offset();
			$('#hOver').css({
				top:offset.top+19,
				left:offset.left
			}).show();
		}).on('mouseout','span.over',function(){
			hout = setTimeout(function(){
				hHide();
			},100);
		});

		$('body').on('mouseover','#hOver',function(){
			clearTimeout(hout);
			$(this).show();
			$('span.over').addClass('on');
		}).on('mouseout','#hOver',function(){
			hout = setTimeout(function(){
				hHide();
			},100);
		}).on('click','#hOver a',function(){
			var id = $(this).attr('id').split('-')[1];
			$('#node-'+id).click();
			$('#hOver').hide();
		})
	})

//列表界面end

</script>

<script>
var global_path = [];
var UGroupSet_tmp = [];
function _initList_ug(pid){
	if(Flag_load == 0){
		return true;
	}
	var admin_list = [];
	admin_id = $('#select_u select').val();
	if(admin_id != -1 && admin_id != null){
		admin_list.push(admin_id);
	}
	$('#select_u li.item').each(function(i,item){
		admin_list.push($(this).attr('id'));//admin_list已选择的管理员
	})			
	admin_list_str = admin_list.join(',');
	if(admin_list_str.substr(0, 1) == ","){
		admin_list_str = admin_list_str.substr(1);
	}
	admin_str = admin_list_str;
	global_path = [];
	$('#hostRoute div.h-path-wrap a').each(function(){
		global_path.push(parseInt($(this).attr('id').split('-')[2]))
	})
	//global_path = global_path.substr(0,global_path.length-1);
	var Data = [];
	if(UGroupSet_tmp != []){
		$.each(UGroupSet_tmp,function(i,item){
			item.Mode = 2;
			item.Selected = 2;
		})
	}
	$.ajax({
		url:"/bhost/get_u_Dir",
		type:"POST",
		async:true,
		data:{a0:sess,a1:0,a2:admin_str,a3:u_id},
		success:function(result){
			var result = JSON.parse(result);
			Data = result.data.UGroup;
			$('#userTree').unbind();
			$('#userTree').on('click','i.h-aicon',function(){
				var $item = $(this);
				var id = $item.data('id').split('-')[1];
				var $u = $item.parent().children('ul');
				if($u.is(':hidden')){
					$item.addClass('h-aicon-d');
					$u.show();
					if($u.children('li').length == 0){
						var v = 2;
						var $input = $(this).siblings('span.checkbox');
						
						var c = $input.attr('class');
						if(c.indexOf('checked')>0){
							v=1;
						}else if(c == 'checkbox'){
							v=0;
						}

						_initHTML($u,id,v,admin_str);
					}
				}else{
					$item.removeClass('h-aicon-d');
					$u.hide();
				}
			}).on('dblclick','i.h-eicon,span.h-name',function () {
				var $item = $(this).siblings('i:first');
				var id = $item.data('id').split('-')[1];
				var $u = $item.parent().children('ul');
				if($u.is(':hidden')){
					$item.addClass('h-aicon-d');
					$u.show();
					if($u.children('li').length == 0){
						var v = 2;
						var $input = $(this).siblings('span.checkbox');
						
						var c = $input.attr('class');
						if(c.indexOf('checked')>0){
							v=1;
						}else if(c == 'checkbox'){
							v=0;
						}

						_initHTML($u,id,v,admin_str);
					}
				}else{
					$item.removeClass('h-aicon-d');
					$u.hide();
				}
			});

			var data = Data;
			$('#userTree').empty();
			if(data != null){
				if(data.length != 0){
					_viewHTML(data,'#userTree');
				}
			}
		}
	})
}
function down(x, y) {
	if(parseInt(x.Mode) <= parseInt(y.Mode)){
		if(parseInt(x.Mode) == parseInt(y.Mode)){
			if(parseInt(x.UGId) > parseInt(y.UGId)){
				return 1;
			}else{
				return -1;
			}
		}else return 1;
	}else{
		return -1;
	}
}
var ugtreelist=[];
function _initHTML(obj,id,v,admin_str){
	//data
	$.ajax({
		url:"/bhost/get_u_Dir",
		type:"POST",
		async:true,
		data:{a0:sess,a1:id,a2:admin_str,a3:u_id},
		success:function(result){
			var result = JSON.parse(result);
			nodeData = result.data.UGroup;
			
			var cdata = nodeData;
			$(obj).empty();
			if(nodeData != null){
				nodeData.sort(down);
			}
			$.each(nodeData,function(i,item){
				if(item.MemberNum <= 0 ){
					class_name = 'h-blank blank_in';
				}else{
					class_name = 'h-aicon';
				}
				var index_path = 0;
				if(( index_path= global_path.indexOf(item.UGId)) >=0){
					if(index_path == global_path.length-1) item.Selected=2;
					else item.Selected = 1;
				}
				var flag_disabled = '';
				if(item.Mode == 1 && '{{us}}' != 'admin' ){
					flag_disabled = 'disabled';
				}
				display_none ="";
				if(item.Mode == 0){
					display_none ="display:none;"
				}
				var $H = $('<li style="'+display_none+'"></li>');
					$H.html('<i class="'+class_name+'" data-id="arr-'+item.UGId+'" />'+
					'<input type="checkbox" id="node-'+item.UGId+'" data-check="0" '+flag_disabled+' class="zcheck zcheck-g" data-name="'+item.UGName+'">'+
					'<i class="h-eicon h-eicon-s"></i>'+
					'<span class="h-name" id="spanHG-' + item.UGId + '" style="width: 12em;">'+
					'<span class="h-name-son" style="">' + 
						item.UGName.split('').map(function (params) {
							return '<font>'+params+'</font>'    
						}).join('') + 
						'</span>'+
						'</span>'+
						'<ul style="display:none">Loading...</ul>');
				if(global_id > 0 ) ugtreelist.push(item.UGId +'-false');
				$(obj).append($H);
				_checkView_input($("#node-"+item.UGId));
				if(global_id == 0){
					// _checkView2($("#node-"+item.UGId));
					if(item.Selected ==1){
						$("#node-"+item.UGId).parent().children('i').eq(0).click();
					}else if(item.Selected ==2){
						$("#node-"+item.UGId).click();
					}					
				}else{				
				}
			});
			if(global_id == 0){
				// _checkView(obj);
			}else{
				// _checkView1(obj);
				select_checkbox_ug();
			}
		}
	})
	
	
	//
}
var selected_ug=[];
function select_checkbox_ug() {
	//var parent_id = $(obj).siblings('input').attr('id').split('-')[1];
	if(ugtreelist.length == 0) return false;
	var i = 0;
	var index_w = 0;
	var indx = 0;
	if(loadLayer == false) _showLoading();
	var m = [];
	var flag_first = false;
	if(selected_ug.length == 0) flag_first = true;
	function _doselect() {
		for (i = index_w; i < index_w + 20; i+=1) { //每次只加载一个 根据情况定
			if (i >= ugtreelist.length) {
				if (ugtreelist.length == 0) {
					clearInterval(if_select);
					_closeLoading();
					return false;
				} else {
					index_w = 0;
					return false;
				}
			}		
			if(ugtreelist[i].split('-')[1] =='false'){
				ugtreelist[i] = ugtreelist[i].split('-')[0] +'-true';
				m.push(ugtreelist[i].split('-')[0]+'-true');
				$.ajax({
					url: '/bhost/IsUNodeSelected',
					type: 'post',
					async: true,
					data:{a0:sess,z1:ugtreelist[i].split('-')[0],z2:0,z3:global_id,z4:7},//z1:ugid  z2:pugid
					success: function (result) {
						var result = JSON.parse(result);
						var flag_selected = result.info;
						var curr_ugid = result.ugid;
						var pugid = result.pugid;
						
						if(flag_selected > 0){
							//$("#node-"+curr_ugid).parent().show();
							flag_1 = false;
							$.each(global_user_path,function (i,item) {
								if(item == curr_ugid){
									flag_1 = true;
								}
							})
							if(flag_selected == 2 && flag_1){
								//console.log($("#node-"+curr_ugid));
								$("#node-"+curr_ugid).next('span').attr('class','checkbox checked');
							}
							_checkView2($("#node-"+curr_ugid).parent());
							if($("#node-"+curr_ugid).parent().children('i').eq(0).attr('class') == 'h-aicon'){
								$("#node-"+curr_ugid).parent().children('i').eq(0).click();
							}
						}else{
							//$("#node-"+curr_ugid).parent().hide();
							_checkView2($("#node-"+curr_ugid).parent());
						}
						//
						$("#node-"+curr_ugid).attr('selected_flag',flag_selected);
						
						ind = ugtreelist.indexOf(curr_ugid +'-true');
						if(ind >=0) ugtreelist.splice(ind, 1);
						
						ind = m.indexOf(curr_ugid +'-true');
						if(ind >=0) m.splice(ind, 1);
						
						selected_ug.push(curr_ugid +"-"+flag_selected);
					},
					error: function (XmlHttpRequest, textStatus, errorThrown) {
						ind = ugtreelist.indexOf(ugtreelist[i].split('-')[0] +'-true');
						if(ind >=0) ugtreelist.push(ugtreelist[i].split('-')[0] +'-false');
						return false;
					}
				});
			}	
			s = ugtreelist[i].split('-')[0];
			if(flag_first == false){			
				$(selected_ug).each(function(j,itemj){
					t = itemj.split('-')[0];					
					if(t == s){
						flag_selected = parseInt(itemj.split('-')[1]);
						if(flag_selected > 0){						
							if(flag_selected == 2){
								$("#node-"+t).click();
							}
							_checkView2($("#node-"+t).parent());
							$("#node-"+t).parent().children('i').eq(0).click();	
						}else{
							_checkView2($("#node-"+t).parent());
						}
						return false
					}
				})
				_checkView2($("#node-"+s).parent());
				ind = ugtreelist.indexOf( s +'-false');
				if(ind >=0) ugtreelist.splice(ind, 1);
				continue;
			}
			selected_tmp = $("#node-"+ugtreelist[i].split('-')[0]).attr("selected_flag");
			if( selected_tmp != undefined){
				if(flag_selected > 0){						
					if(flag_selected == 2){
						$("#node-"+ugtreelist[i].split('-')[0]).click();
					}
					_checkView2($("#node-"+ugtreelist[i].split('-')[0]).parent());
					$("#node-"+ugtreelist[i].split('-')[0]).parent().children('i').eq(0).click();	
				}else{
					_checkView2($("#node-"+ugtreelist[i].split('-')[0]).parent());
				}
				
				ind = ugtreelist.indexOf( ugtreelist[i].split('-')[0] +'-false');
				if(ind >=0) ugtreelist.splice(ind, 1);
				continue;
			}
			if(m.length >= 20) continue;
		}
		index_w = i;
	}
	var if_select = setInterval(function(){
		if (ugtreelist.length == 0){  //
			clearInterval(if_select);
			_closeLoading();			
			return false;
		}
		_doselect();	
	},1);
}


function _viewHTML(data,obj){
	$(obj).empty();
	data.sort(down);
	$.each(data,function(i,item){
		if(item.UGId == 1) return true;
		
		if(item.MemberNum <= 0 ){
			class_name = 'h-blank blank_in';
		}else{
			class_name = 'h-aicon';
		}
		var index_path = 0;
		if(( index_path= global_path.indexOf(item.UGId)) >=0){
			if(index_path == global_path.length-1) item.Selected=2;
			else item.Selected = 1;
		}
		var flag_disabled = '';
		if(item.Mode == 1 && '{{us}}' != 'admin'){
			flag_disabled = 'disabled';
		}
		
		display_none = '';
		if(item.Mode == 0){
			display_none = "display:none;"
		}
		var $H = $('<li style="'+display_none+'"></li>');
				$H.html('<i class="'+class_name+'" data-id="arr-'+item.UGId+'" />'+
				'<input type="checkbox" id="node-'+item.UGId+'" data-check="0" '+flag_disabled+' class="zcheck zcheck-g" data-name="'+item.UGName+'">'+
				'<i class="h-eicon h-eicon-s"></i>'+
				'<span class="h-name" id="spanHG-' + item.UGId + '" style="width: 12em;">'+
				'<span class="h-name-son" style="">' + 
					item.UGName.split('').map(function (params) {
						return '<font>'+params+'</font>'    
					}).join('') + 
					'</span>'+
					'</span>'+
					'<ul style="display:none">Loading...</ul>');		
		if(global_id > 0 ) ugtreelist.push(item.UGId +'-false');
		
		$(obj).append($H);
			//setTimeout(_jScrollBar,1000,'spanHG-' + item.UGId);
			_checkView_input($("#node-"+item.UGId));
		if(global_id == 0){
			if(item.Selected ==1){
				$("#node-"+item.UGId).parent().children('i').eq(0).click();
			}else if(item.Selected ==2){
				$("#node-"+item.UGId).click();
			}
		}else{
		}
		
    });
	if(global_id == 0){
		// _checkView(obj);
	}else{
		// _checkView1(obj);
		select_checkbox_ug();
	}
	
}
function _checkView_input(obj){
	$(obj).each(function(){
		var $s = $('<span class="checkbox"></span>');
		if($(this).parent().find('span.checkbox').length == 0)
			$(this).after($s);
		var v = $(this).prop('checked');
		if(v){
			$s.addClass('checked');
		}else{
			var c = $(this).data('check');
			if(c && c==2){
				$s.addClass('half');
			}
		}

		var d = $(this).prop('disabled');
		if(d){
			$s.addClass('disabled');
		}
	}).on('change',function(){
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul');
		if(v){
			$s.attr('class','checkbox checked');
	    	//$('input.zcheck',$u).prop('checked',true);
	    	//$('span.checkbox',$u).attr('class','checkbox checked');
		}else{
			$s.attr('class','checkbox');
	    	//$('input.zcheck',$u).prop('checked',false);
	    	//$('span.checkbox',$u).attr('class','checkbox');
		}

		//_checkEvent(this);
	});
}
function _checkView(obj){
	$('input.zcheck',obj).each(function(){
		var $s = $('<span class="checkbox"></span>');
		if($(this).parent().find('span.checkbox').length == 0)
			$(this).after($s);
		var v = $(this).prop('checked');
		if(v){
			$s.addClass('checked');
		}else{
			var c = $(this).data('check');
			if(c && c==2){
				$s.addClass('half');
			}
		}

		var d = $(this).prop('disabled');
		if(d){
			$s.addClass('disabled');
		}
	}).on('change',function(){
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul');
		if(v){
			$s.attr('class','checkbox checked');
	    	//$('input.zcheck',$u).prop('checked',true);
	    	//$('span.checkbox',$u).attr('class','checkbox checked');
		}else{
			$s.attr('class','checkbox');
	    	//$('input.zcheck',$u).prop('checked',false);
	    	//$('span.checkbox',$u).attr('class','checkbox');
		}

		//_checkEvent(this);
	});
}
function _checkView1(obj){
	$('input.zcheck',obj).on('change',function(){
		var v = $(this).prop('checked');
		var $s = $(this).next('span.checkbox');
		var $u = $(this).parent().children('ul');
		if(v){
			$s.attr('class','checkbox checked');
	    	//$('input.zcheck',$u).prop('checked',true);
	    	//$('span.checkbox',$u).attr('class','checkbox checked');
		}else{
			$s.attr('class','checkbox');
	    	//$('input.zcheck',$u).prop('checked',false);
	    	//$('span.checkbox',$u).attr('class','checkbox');
		}

		//_checkEvent(this);
	});
}
function _checkView2(obj){
	$('input.zcheck',obj).each(function(){
		var $s = $('<span class="checkbox"></span>');
		if($(this).parent().find('span.checkbox').length == 0)
			$(this).after($s);
		var v = $(this).prop('checked');
		if(v){
			$s.addClass('checked');
		}else{
			var c = $(this).data('check');
			if(c && c==2){
				$s.addClass('half');
			}
		}

		var d = $(this).prop('disabled');
		if(d){
			$s.addClass('disabled');
		}
	})
}
function _checkEvent(obj){
	var _run = function(){
		var $li = $(obj).parent().parent().parent();
		var tagname = $li[0].tagName.toLowerCase();
		var v = $(obj).prop('checked');

		if(tagname == 'li'){
			var c1=0,c2=0;
			var len = $(obj).parent().parent().children('li').length;
			$(obj).parent().parent().children('li').each(function(){
				var c = $(this).children('span.checkbox').attr('class');
				if(c.indexOf('checked')>0){
					c1++;
				}else if(c.indexOf('half')>0){
					c2++;
				}

				if(c1 == len){
					$li.children('input.zcheck').prop('checked',true).siblings('span.checkbox').attr('class','checkbox checked');//.siblings('span.authtype').show();
				}else if(c1==0 && c2==0){
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox');//.siblings('span.authtype').hide();
				}else{
					$li.children('input.zcheck').prop('checked',false).siblings('span.checkbox').attr('class','checkbox half');
				}
			});
			_checkEvent($li.children('input.zcheck'));
		}else{
			return;
		}
	}
	_run();
}

function _getWait(obj){
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
	
	$(obj).removeClass('done').show().unbind().on('mouseover',function(){
		waitlayer = layer.tips('搜索中',this,{
			tips:1,
			time:0,
			skin: 'waitlayer'
		});
	}).on('mouseout',function(){
		if(typeof waitlayer != 'undefined'){
			layer.close(waitlayer);
		}
	});
}
function _waitDone(obj){
	if(typeof waitlayer != 'undefined'){
		layer.close(waitlayer);
	}
	$(obj).fadeOut(3000);
	if(typeof waitDonelayer != 'undefined'){
		layer.close(waitDonelayer);
	}
}
</script>
<!-- 交接 -->
<script>
function _transfer(type_num){
	$(".container3").hide();
	$(".container1").hide();
	$(".container2").hide();
	$(".container").hide();
	$(".container4").show();
	document.getElementsByClassName('c-cont')[0].scrollTop = 0;//让滚动条出现在最上面			
	user_clear();
	_get_tokenid();
	get_authtype_list($('#sys_u_authtype_d'));
	authDefault_flag = 0;
	$.each(authtype_data,function(i,item){
		if(item.IsDefault == true){
			$.each(item.Set,function(i1,item1){
				if(item1.AuthMode == 6){
					authDefault_flag += 1;
				}else if(item1.AuthMode == 8){
					authDefault_flag += 2;
				}else if(item1.AuthMode == 10){
					authDefault_flag += 4;
				}else if(item1.AuthMode == 13){
					authDefault_flag += 8;
				}
			})
		}	
    })	
    if(type_num==1){
        global_id=current_id.split('-')[2];
    }
	$.ajax({		//回显用户信息
		url:"/bhost/get_user_list",
		type:"POST",
		async:false,
		data:{a0:sess,a1:global_id},
		success:function(result){
			user_item = JSON.parse(result);
			if(user_item.Result == false){
				_alert(1,"用户管理","获取信息失败："+user_item.info);
				return false;
			}
			user_item = user_item.info;
		}
	})
	flag = 1;
	if(user_item.PwdApproveUserId == null){
		user_item.PwdApproveUserId = '0';
	}
	if(user_item.PhotoIcon == null){
		user_item.PhotoIcon = "avatar1.jpg";
	}
	user_ugroup = user_item.UGroupSet;
	user_Password = user_item.Password;
	$("#sys_u_name_d").val(user_item.UserCode);
	$("#user_name_d").val(user_item.UserName);
	$("#sys_u_pwd_new_d").val("");
	$("#sys_u_pwd_tr_d").val("");
	$("#sys_u_depart_d").val(user_item.Department);
	$("#sys_u_phone_d").val(user_item.MobilePhone);
	$("#sys_u_email_d").val(user_item.Email);
	$("#sys_u_descr_d").val(user_item.Description);
	$("#sys_u_authtype_d").val((user_item.AuthTypeId==null?'null':user_item.AuthTypeId)).trigger("change");
	var ph = user_item.PhotoIcon;
	ph = "/manage/images/" +ph;
	$('#tAvatar>img').attr('src' ,ph);
	//绑定管理员
	//获取 当前用户
	user_admin = $('input[name=us]').val();
	
	
	var $c = $('#un_d').parent();
	$c.children('select').select2('destroy');
	var v = $('select',$c).children('option[title="'+user_admin+'"]').val();
	var $s = $('<div class="item" style="width: 31%; float: left; margin-left: -19px;" ><input type="text" class="form-text" id="'+v+'" maxlength="128" value="'+user_admin+'" style="width:170px;" disabled="true"></div>');;
	$c.before($s);
	
	
	
	$(user_item.AdminSet).each(function(i1,item1){
		var v = item1.AdminId;
		var t = $('select',$c).children('option[value="'+v+'"]').text();
		var d = $('select>option:first',$c).val();
		var $s = $('<div class="item" style="width: 31%; float: left; margin-left: -19px;" ><input type="text" class="form-text" id="'+v+'" maxlength="128" value="'+t+'" style="width:170px;" disabled="true"></div>');;
		$c.children('select').val(d);
		$c.children('select').find('option[value="'+v+'"]').remove();
		$c.before($s);
		$c.children('select').select2();
	})
	$c.children('select').select2();
	$c.children('select').parent().hide();
	
	
	//绑定角色			
	var $c = $('#rn_d').parent();
	$c.children('select').select2('destroy');
	$(user_item.RoleSet).each(function(i1,item1){
		
		var v = item1.RoleId;
		var t = $('select',$c).children('option[value="'+v+'"]').text();
		var d = $('select>option:first',$c).val();
		var $s = $('<div class="item" style="width: 31%; float: left; margin-left: -19px;"><input type="text" class="form-text" id="'+v+'" maxlength="128" value="'+t+'" style="width:170px;" disabled="true"></div>');;
		$c.children('select').val(d);
		$c.children('select').find('option[value="'+v+'"]').remove();
		$c.after($s);
		$c.children('select').select2();
	})
	$c.children('select').select2();
	$c.children('select').parent().hide();
	
	$("#sys_u_name").attr("disabled",true);
	if(user_item.UserStatus == 1) $('#status').iCheck('check');
	else $('#status').iCheck('uncheck');
	
	//获取 交接用户
	loginusercode = window.parent.document.frm.us.value;
	$.ajax({
		url: '/bhost/GetTransUser',
		type: "POST",
		async: false,
		data: { a0:sess, a1:'', a2:global_id},
		success: function (result) {
			var result = JSON.parse(result);
			if (result.Result) {
				tranuser_list  = result.info;
				$('#user_tranfer_t').empty().append('<option value="">请选择</option>');
				$(tranuser_list).each(function(i,item){
					if(item.UserId != global_id){
						$('#user_tranfer_t').append('<option value="'+item.UserId+'">'+item.UserCode+'</option>');
					}
				})
				$('#user_tranfer_t').val('').trigger('change');
				if(tranuser_list == ""){
					_alert(2,"交接用户",'没有可交接对象');
				}
			}
		}
	})
}

function Transfer(){
	if($('#user_tranfer_t').val() == ""){
		_alert(1,"交接用户",'请选择交接用户');
		return false;
	}
	var msstr = aceg($('#user_tranfer_t').val(),sess);
	$.ajax({
		url:'/bhost/TransferAuthority',
		type:"POST",
		async:false,
		data:{a0:sess,a1:$('#user_tranfer_t').val() ,a2:global_id ,a3:false,a10:"运维管理>用户管理",m1:msstr},
		//contentType: 'application/json',
		success: function(Result) {
			data = JSON.parse(Result);
			if (data.Result){
				layer.open({
					type: 1,
					title:"用户管理",
					content:'<div class="layer-alert"><i class="alert succ"></i>交接成功</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						layer.close(i);
						// BackUsermanage();
						$(".container3").show();
						$(".container4").hide();
						refresh();
					}
				});
				return false;
			}
			else{
				_alert(1,"交接用户",'保存失败 原因：'+data.ErrMsg);
			}
		}
	})
}

function submit_totp(){
	var totp_v = $("#totp_v").val();
	if (totp_v == ""){
		$(".btn").blur();
		_alert(1,"系统用户","验证码不正确",$("#totp_v"));
		return false;
	}
	$.ajax({
		url: "/bhost/test_qrcode",
		type: "POST",
		async: false,
		data: {a0:sess,z1:totp_v,z2:secret},
		success: function (result) {
			if (result == "true"){
				$(".btn").blur();
				//_alert(0,"系统用户","验证成功");
				//$("#totp_checkbox").attr("checked",true);
				//$("#totp_checkbox").next('span').attr('class',"checkbox checked");
				repeat = 0;
				if(PwdStrategy.IfPwdUnRepeat){
					repeat = PwdStrategy.PwdUnRepeat;
				}else{
					repeat = 0;
				}
				AccessSet = {
					"UserId": 0, 
					"AccessAuthSet": [
					]
				}
				layer.open({
					type:1,
					title:"系统用户",
					content:'<div class="layer-alert"><i class="alert succ"></i>验证成功</div>',
					btn:'确&nbsp;&nbsp;定',
					btnAlign:'c',
					closeBtn: false,
					skin:'layer-custom',
					area:['380px','310px'],
					move: false,
					resize: false,
					btn1:function(i){
						d_qrcode.close().remove();
						layer.close(i);
						user_item.SecretKey = secret;
						/*
						$.ajax({
							url:'/bhost/update_totp_key',
							type:"POST",
							async:false,
							data:{a0:sess,a1:user_item.UserCode,a2:secret,a10:"运维管理>用户管理"},
							//contentType: 'application/json',
							success: function(Result) {								
								data = JSON.parse(Result);
								if (data.Result){								
									user_item.SecretKey = secret;
									return false;
								}
								else{
									_alert(1,"用户管理",'TOTP重置失败 原因：'+data.ErrMsg);
								}
							}
						})*/
						//savedata();
					}
				});
				return false;
			}else{
				$(".btn").blur();
				_alert(1,"系统用户","验证失败",$("#totp_v"));
				return false;
			}
		}
	});
}

var secret;
var d_qrcode;
function qr_code_show(){
	var account_name = $("#sys_u_name").val();
	$.ajax({
		url: "/bhost/get_qrcode_img",
		type: "POST",
		async: true,
		data: {a0:sess,z1:account_name},
		success: function (result) {
			var result = JSON.parse(result);
			secret = result.secret;
			$("#qr_code").find('img').attr('src',result.img+"?m="+Math.random());
		}
	});
	var $dialogCont = $("#qr_code").show();
	
	d_qrcode = dialog({
		title:"TOTP",
		content:$dialogCont,
		id:"qr_code",
		width:"368px",
	}); 
	d_qrcode.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d_qrcode.showModal();
	$("#qr_code").parents(".ui-dialog-body").css("padding","20px 0px 20px 0px");
	$("#totp_v").val('');
	$('.ui-popup.ui-popup-modal.ui-popup-show.ui-popup-focus').css("top","65px");
}

/*
Functions about the tree search result!
*/
function click_h(){
	$('#userTree').find('span.h-name-red').find('.font-red').removeClass('font-red');
	$('#userTree').find('span.h-name-red').removeClass('h-name-red');
	$('#userTree').find('ul').hide();
	$('#userTree').find('li').hide();	
	$('#userTree').find('i.h-aicon-d').trigger('click');
}
var path_all;
function find_usergroup(){
	$('#userTree').find('li').show();
	click_h();
	$('#userTree').find('li').hide();
	jsondata={
		"ugid": 0,
		"istree": true,
		"ugname":"",
		"limitrow":null,
		"offsetrow":0
	}
	var GName = '';
	search_usert = search_user + search_user_n;
	find_host_arry = search_usert.split('\t');
	$.each(find_host_arry,function(i,item){
		if(item == '' || item == null){
			return true;
		}
		var item_id = item.indexOf('-');
		GName += (item.substr(item_id + 1,item.length)+'\n');
	})
	GName = GName.substr(0,GName.length - 1);
	jsondata.ugname = GName;
	if (GName == ""){
		$('#userTree').find('li').show();
		return false;
	}
	$.ajax({
		url: '/bhost/find_user_list',
		type: "POST",
		async: true,
		data: {a0:sess,a1:JSON.stringify(jsondata)},
		success: function(result){
			result = JSON.parse(result);
			result = result.info;
			if (result == null){
				$("#user_text").blur();
				_waitDone($(".waitTip1"));
				$('#userTree').find('li').hide();
				_alert(0,'搜索','无搜索结果',$("#user_text"));
				return false;
			}
			path_all = result;
			if (path_all.length != 0){
				$.each(path_all,function(i,item){
					var Path_array=item.Path.split('/');
					var len=Path_array.length;
					for(var j=1;j<len-1;j++){
						var id=Path_array[j].split(',')[1];
						if($('#node-'+id).length != 0){
							$i_item=$('#node-'+id).siblings('i.h-aicon');
							if(($i_item.attr('class').indexOf('h-aicon-d')) === -1){
								$i_item.parent('li').show();
								$i_item.trigger('click');
								$i_item.siblings('ul').find('li').hide();
							}
						}
					}
					if(item.Type==1){
						if($('#node-'+item.Id).length != 0){
							$('#node-'+item.Id).parent('li').show();
							$('#node-'+item.Id).siblings('span.h-name').addClass('h-name-red');
							var $span_son_font=$('#node-'+item.Id).siblings('span.h-name').find('font')
							var span_son_name=$('#node-'+item.Id).attr('data-name').toLowerCase();
							$.each(search_usert.split('\t'),function(i1,item1){
								if(item1=='' || item1==null){
									return true;
								}
								var index=item1.indexOf('-');
								switch (item1.substring(0,index)) {
									case 'Name':
									case '':
									case '组名':
									case '0':
										$.each(item1.substring(index+1).split(' '),function (i_s,params_s) {
											params_s=params_s.toLowerCase();
											var index_true=span_son_name.indexOf(params_s);
											if(index_true>=0){
												for(var i_red_span=index_true;i_red_span<index_true+params_s.length;i_red_span++){
													$span_son_font.eq(i_red_span).addClass('font-red');
												}
											}
										});
										break;
								}
							});
						}
					}
				})
				li_hide_while_no_red_1($('#userTree'),0);
				scrollTop_check_server();
			}else{
				$("#user_text").blur();
				_waitDone($(".waitTip1"));
				_alert(0,'搜索','无搜索结果',$("#user_text"));
			}
		}
	});
}
function li_hide_while_no_red_1(obj,num){
	var li_visible=$(obj).children('li');
	var _len=li_visible.length
	if(num<_len){
		var item=li_visible.eq(num);
		if($(item).children('span.h-name-red').length!=0){
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
		}else if($(item).find('span.h-name-red').length==0){
			$(item).hide();
		}else{
			$(item).show();
			$(item).find('span.h-name-red').parent('li').show();
			var $children_ul=$(item).children('ul');
			if($children_ul.length>0){
				setTimeout(function(){
					li_hide_while_no_red_1($children_ul,0);
				},1);
			}
		}
	}
	var item_1=li_visible.eq(num+1);
	if(item_1.length!=0){
		setTimeout(function(){
			li_hide_while_no_red_1(obj,num+1);
		},1);
	}
}
function scrollTop_check_server(){
	$('.c-cont').scrollTop(0);
	if(path_all.length!=0){
		var top=9007199254740992;
		$.each(path_all,function(i,item){
			if($('#node-'+item.Id).length != 0){
				if(item.Type==1){
					var top_item=$('#node-'+item.Id).offset().top;
					if(top_item<top){
						top=top_item;
					}
				}
			}
		});
		$('.c-cont').scrollTop(top+300);
		_waitDone($(".waitTip1"));
	}
}
function reload(obj){
	if($(obj).attr('id') == 'takeOver'){
		_transfer();
	}else if($(obj).attr('id') == 'user_title'){
		if($(obj).text() == "创建用户"){
			create_u();
		}else{
			edit();
		}
	}else if($(obj).attr('id') == 'group_title'){
		if($(obj).text() == "创建用户组"){
			create_g();
		}else{
			edit();
		}
	}else if($(obj).attr('id') == 'user_Manage'){
		document.frm_user.tasktype.value=0;
		document.frm_user.a0.value=sess;
		document.frm_user.se.value=sess;
		document.frm_user.action = '/bhost/user_manage';
		document.frm_user.submit();
	}
}
var clientId1;
var clientId2;
function reload_client(){
	_editNode2(clientId1,clientId2);
}
/*
导入浮层
*/

function _closeDetail(type) {
	if (type == 1){
		$('#allPage').hide();
	}else{
		$('#importPage').hide();
	}
	$(".container3").show();
	_import_user(1);
	$("#task_list_tab").click();
}

function _reloadDetail(type) {
	$('#apArea1').empty();
	$('#aploadTip1').html('正在加载').hide();
	page = 0;
	ppage = 0;
	append_flag = 0;
	row_len = 0;
	hostip = "";
	remain_page = 0;
	page_flag = 0;
	same_page = 0;
	_initLoadData1();
}

function get_task_data(){
	$.ajax({  
		url:'/bhost/get_usertask_data',
		type:"post",
		async:false,
		data:{a0:sess,a1:'null',a2:'null'},
		success:function(result){
			var result = JSON.parse(result);
			$.each(result.data,function(i,item){
				selectid.push(item.UserImportTaskId);
			});
		}
	});
}

//全选任务
function select_all(){
	selectid=[];
	var select_total = $("#select_total").text();
	var task_total = $("#task_total").text();
	if (parseInt(select_total) == parseInt(task_total)){
		$("#usertask_list").find('input').iCheck('uncheck');
	}else{
		get_task_data();
		$("#usertask_list tbody input[type='checkbox']").each(function(){
			if (!$(this).prop("disabled")){
				$(this).iCheck('check');   
			}
		})
	}
	$("#select_total").text(selectid.length);
}

//刷新任务
function fresh_task_list(){
	get_usertask_list();
	selectid = [];
	$("#details_module input[type='checkbox']").each(function(){	
		$(this).iCheck('uncheck');
	});
	$("#select_total").text(0);
}

function delete_usertask(type,id){
	$.ajax({
		url:'/bhost/del_usertask',
		type:'post',
		async:false,
		data:{a0:sess,a1:id},
		success:function(result){
			del_result = JSON.parse(result);
			if (del_result.Result){
				_alert(0,"用户任务","删除成功");
				$('div.tab-moreinfo-on').hide();
				return false;
			}else{
				_alert(1,"用户任务",del_result.ErrMsg);
				return false;
			}
		}
	})
}

function del_usertask_r(id){
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"用户任务",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否删除</div>',
		btn:['确&nbsp;&nbsp;定','取&nbsp;&nbsp;消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			delete_usertask(0,id);
			for (var i = 0; i < selectid.length; i++){      
				if (selectid[i] == parseInt(id)){
					num = $("#select_total").text();
					num = parseInt(num)-1;
					$("#select_total").text(num);
					selectid.splice($.inArray(parseInt(id),selectid),1);
					break;
				}
        	}
			get_usertask_list();
		},
		btn2:function(i){
			parent.layer.close(i);
		}
	});
}
//批量删除
function del_hosttask_more(){
	if (selectid.length == 0){
		_alert(2,"用户任务","请选择要删除的数据");
		return;
	}
	$('.btn').blur();
	parent.layer.open({
		type:1,
		title:"用户任务",
		content:'<div class="layer-alert"><i class="alert warning"></i>是否批量删除</div>',
		btn:['确定','取消'],
		btnAlign:'c',
		closeBtn: false,
		skin:'layer-custom',
		area:['380px','310px'],
		move: false,
		resize: false,
		btn1:function(i){
			parent.layer.close(i);
			selectid_str = selectid.toString();
			delete_usertask(1,selectid_str);
			selectid=[];
			get_usertask_list();
		},
		btn2:function(i){
			parent.layer.close(i);
		}
	});
}

function filetip(obj){
	var c=$(obj).val();
	c = c.split("\\");
	var b = c[c.length-1];
	$('#file_v').val(b);
}
var use_BH=window.parent.parent.document.frm.use_BH.value;
var setinterval=null;
function browes(){
	if(use_BH=='0'){
		$("#file_change1").click();
		return 0;
	}
	var referrer_arr=document.referrer.toString().split('/');
	referrer_arr.pop();
	var referrer=referrer_arr.join('/');
	var sesstimet = (new Date()).valueOf();
	var json_download = {
		"Type": "Upload",
		"Url": referrer,
		"Path": "/usr/storage/.system/upload/",
		"Filename": sesstimet+'',
		"Session": sess,
		"sesstimet":sesstimet+''
	}
	var if_html_client = false;
	var base64_str = '';
	$.ajax({
		url: "/bhost/get_base64",
		type:"POST",
		async:false,
		data:{a0:window.parent.document.frm.se.value,z1:JSON.stringify(json_download)},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				if_html_client = result.info;
				base64_str = result.b64;
			}else{
				_alert(1,"用户管理",result.ErrMsg); 
			}
		}
	})
	if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
	else{
		get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
		$('#YuFrame1').remove();
		$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
		$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
	}
	clearInterval(setinterval);
	setinterval=setInterval(function(){
		$.ajax({
			url: "/bhost/find_item_sql",
			type:"POST",
			async:false,
			data:{a0:window.parent.document.frm.se.value,a1:sesstimet},
			success:function(result){
				var result=JSON.parse(result);
				if(result.Result){
					if(result.info==null){

					}else{
						var info_arr=result.info.split('/');
						if(info_arr.length>1){
							$('#file_v').val(info_arr.pop());
							$('#file_change').val('/usr/storage/.system/upload/'+sesstimet);
						}else{
							if(result.info=='NULL'){
								$('#file_v').val('');
								$('#file_change').val('');
							}else{
								$('#file_v').val(result.info);
								$('#file_change').val('/usr/storage/.system/upload/'+sesstimet);
							}
						}
						
						clearInterval(setinterval);
					}
				}
			}
		});
	}, 3000);
}

var task_list_detail;
function _initLoadData() {
	var h1 = $('#allPage').height();
	var h2 = $('#apArea').height();
	var add = function() {
		if (h1 - 203 > h2){
			page++;
			get_data(page,10);
			h2 = $('#apArea').height();
		}else{
			clearInterval(if_select);
			return false;
		}
	}

	var if_select = setInterval(function(){
		if (h1 - 203 <= h2 || task_list_detail.totalrow <= 10){
			clearInterval(if_select);
			return false;
		}
		add();	
	},1000);

	add();
}

var keyword_re=[];//搜索条件
var selectid = [];
function get_usertask_list(){
	var MAX_PAGE = 5;
	var cur = $("#curpage").val();
	$.ajax({
		url:'/bhost/get_usertask_data',
		type:'post',
		async:false,
		data:{a0:sess,a1:cur,a2:MAX_PAGE},
		success:function(result){
			task_list = JSON.parse(result);
			$("#usertask_list tbody").empty();
			var Status = "";
			var SuccCount;
			var FailCount;
			var NewCount;
			var ExistedCount;
			var ErrorLog;
			$.each(task_list.data,function(i,item){
				if(item.Status == 0){
					Status = "正在执行";
				}else if(item.Status == 1){
					Status = "执行完成";
				}else if(item.Status == 2){
					Status = "执行失败";
				}
				if (item.SuccCount == null){
					SuccCount = "";
				}else{
					SuccCount = item.SuccCount;
				}
				if (item.FailCount == null){
					FailCount = "";
				}else{
					FailCount = item.FailCount;
				}
				if (item.NewCount == null){
					NewCount = "";
				}else{
					NewCount = item.NewCount;
				}
				if (item.ExistedCount == null){
					ExistedCount = "";
				}else{
					ExistedCount = item.ExistedCount;
				}
				if (item.ErrorLog == null){
					ErrorLog = "";
				}else{
					ErrorLog = item.ErrorLog;
				}
				var HostCount = parseInt(SuccCount) + parseInt(FailCount);
				float_str = "<p>错误信息："+ErrorLog+"</p>";
				$("#usertask_list tbody").append('<tr><td width="50"><input type="checkbox" class="form-checkbox" value="'+item.UserImportTaskId+'"/></td><td title="'+item.UserImportTaskName+'">'+item.UserImportTaskName+'</td><td title="'+SuccCount+'">'+SuccCount+'</td><td title="'+FailCount+'">'+FailCount+'</td><td title="'+Status+'">'+Status+'</td><td title="'+ErrorLog+'">'+ErrorLog+'</td><td width="50"><div class=\"tab-ctr\"><a href="javascript:;" class="icon7" id="edit" title="导入详情" data="'+item.UserImportTaskName+'" data1="'+item.Status+' "data2="'+item.NewCount+'" data3="'+item.ExistedCount+'" onclick="task_detail(this,'+item.UserImportTaskId+');"></a><a href=\"javascript:;\" class=\"del\" id=\"del\" title="删除任务" onclick=\"del_usertask_r('+item.UserImportTaskId+')\"></a></div><div class="tab-moreinfo">'+float_str+'</div></td></tr>');
			});
			$('.form-checkbox,.form-radio').iCheck({
				checkboxClass: 'icheckbox_minimal-blue',
				radioClass: 'iradio_minimal-blue',
				increaseArea: '0' 
			});
		}
	});
	tabArr1();
	$("#task_total").text(task_list.totalrow);
	totalpage = Math.ceil(parseInt(task_list.totalrow)/MAX_PAGE);
	if (totalpage < 1){
		totalpage = 1;
	}
	$("#totalpage").text(totalpage.toString());
	$("#page_total").text(MAX_PAGE);
	//<tr>中选择按钮进行设置
	$('#check_task_page').iCheck('uncheck');
	var check_page_flag = 0;
	$("#usertask_list tbody input[type='checkbox']").each(function(){
		if ($.inArray(parseInt(this.value), selectid) != -1){					
			$(this).iCheck('check');
			check_page_flag++;
		}
	});
	if (check_page_flag == $("#usertask_list tbody input[type='checkbox']").length && check_page_flag != 0){
		$('#check_task_page').iCheck('check');
	}
	if (parseInt(cur) > totalpage){
		$("#curpage").val(totalpage);
		get_usertask_list();
	}
	var flag_id = 0;
	num = selectid.length;
	$("#select_total").text(num);
	$("#usertask_list tbody input[type='checkbox']").on("ifChanged",function(){
		if ($(this).is(":checked")){
			num = $("#select_total").text();   
			num++;
			if (selectid.indexOf(parseInt(this.value)) == -1){
				selectid.push(parseInt(this.value))	
			}
			$("#select_total").text(num);
		}else{
			num = $("#select_total").text();
			num--;
			selectid.splice($.inArray(parseInt(this.value),selectid),1);
			$("#select_total").text(num);   
		}
		var check_num = 0;
		$("#usertask_list tbody input[type='checkbox']").each(function(){
			if (!$(this).prop("disabled")){
				check_num++;
			}
		}) 
		if ($("#usertask_list tbody").find('input[type=checkbox]:checked').length == check_num){
			$('#check_task_page').iCheck('check');
		}else{
			$('#check_task_page').iCheck('uncheck');
		}
	});
	$('#check_task_page').unbind().on('ifClicked',function(e){
		if(!$('#check_task_page').prop('checked')){
			$("#usertask_list tbody input[type='checkbox']").each(function(){
				$(this).iCheck('check');   
			}) 
		}else{
			$("#usertask_list").children('tbody').find('input[type=checkbox]').iCheck('uncheck');
		}
	});	
}
var actnu = 0;
var new_pin = "";
var pin_success = 0;//0--not saved 1--saved success!
function change_PIN(){
	$("#pin_input1").val('');
	$("#pin_input2").val('');
	var $dialogCont = $("#PINDialog").show();
	var title = 'pin设置';
	var d = dialog({
		title:title,
		content:$dialogCont,
		id:"PINDialog",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d.showModal();
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		$("#pin_input1").val('');
		$("#pin_input2").val('');
		new_pin = '';
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		
		if($("#pin_input1").val() != $("#pin_input2").val()){
			_alert(1,"用户管理","两次pin码不匹配",$("#pin_input1"));
			return false;			
		}
		if($("#pin_input1").attr('maxlength') > 0){
			if($("#pin_input1").val().length != parseInt($("#pin_input1").attr('maxlength'))){
				_alert(1,"系统用户","pin码长度不正确("+$("#pin_input1").attr('maxlength')+"位)",$("#pin_input1"));
				return false;
			}		
		}
		new_pin = $("#pin_input1").val();
		KEY_SET = true;
		$("#changepin_div").find('text').text("已配置");
		if($("#select_local").val() == "0" && $("#select_local").prop('disabled') == true){
			$("#select_local").val('0').trigger('change');
		}else{
			$("#select_local").val('1').trigger('change').attr("disabled",true);
		}
		d.close().remove();
	});
}
function client_request(cmd_json,type,UserId,sesstime,Content,dialogt){
	var if_html_client = false;
	var base64_str = '';
	var sesstimet = (new Date()).valueOf()+1;
	cmd_json['sesstimet'] = sesstimet;
	$.ajax({
		url: "/bhost/get_base64",
		type:"POST",
		async:false,		
		data:{a0:sess,z1:JSON.stringify(cmd_json)},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				if_html_client = result.info;
				base64_str = result.b64;
			}else{
				_alert(1,"用户管理",result.ErrMsg);
			}
		}
	})
	
	
	//window.location.href = 'bhost://cmd&'+base64_str;
	get_regedit('bhost', sess,'',sesstimet);
	$('#YuFrame1').remove();
	$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
	$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
	
	
	//插入数据库数据
	$.ajax({
		url: "/bhost/insert_usbkeys",
		type:"POST",
		async:false,		
		data:{a0:sess,z1:sesstime,t1:type,u1:$('#sys_u_name').val(),c1:Content,a10:"用户管理"},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
			}else{
				_alert(1,"用户管理",result.ErrMsg);
				return false;
			}
		}
	})
	
	//循环获取 数据库状态
	_showLoading("正在设置PIN码中......");
	var c = 0;
	
	if_ok_down = setInterval(function(){
		ret = repeat_get_usb_status(sesstime);
		if(ret == 1){
			clearInterval(if_ok_down);
			_closeLoading();
			layer.open({
				type:1,
				title:"用户管理",
				content:'<div class="layer-alert"><i class="alert succ"></i>保存成功</div>',
				btn:'确&nbsp;&nbsp;定',
				btnAlign:'c',
				closeBtn: false,
				skin:'layer-custom',
				area:['380px','310px'],
				move: false,
				resize: false,
				btn1:function(i){
					layer.close(i);
					BackUsermanage();
					refresh();
					return false;
				}
			});
			return 0;				
		}
		if(ret == 2){
			clearInterval(if_ok_down);
			_closeLoading();
			_alert(1,"用户管理",'设置PIN码失败');
			if(flag == 0){
				$.ajax({
					url:"/bhost/delete_user_list_u",
					type:"POST",
					async:false,
					data:{a0:sess,a1:loginusercode,a2:UserId},
					success:function(result){
					}
				})
			}
			
			return 0;				
		}
		if(c >=20){
			clearInterval(if_ok_down);
			_closeLoading();
			_alert(1,"用户管理",'设置PIN码超时');
			if(flag == 0){
				$.ajax({
					url:"/bhost/delete_user_list_u",
					type:"POST",
					async:false,
					data:{a0:sess,a1:loginusercode,a2:UserId},
					success:function(result){
					}
				})
			}
		}			
		c = c + 1;				
	},1000)
}
function repeat_get_usb_status(sesstime){
	var st = 0;
	$.ajax({
		url: "/bhost/repeat_get_usb_status",
		type:"POST",
		async:false,		
		data:{a0:sess,z1:sesstime},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				st = result.info;
			}else{
				_alert(1,"系统用户",result.ErrMsg);
				return false;
			}
		}
	})
	return st;
}
var loadLayer =0;
function _showLoading(text){
	var st = text || "请稍后......";
	loadLayer = layer.open({
		title:false,
		closeBtn:false,
		content:'<div id="Loading">'+st+'</div>',
		btn:false,
		skin:'loadingbar',
		area:['150px','180px'],
		move:false,
		resize:false,
		isOutAnim: false,
		shade:[0.1,'#000']
	})
}

function _closeLoading(){
layer.close(loadLayer);
}
//切换导入/任务
function set_tab(obj,type){
	if (type == 1){
		$("#import_module").show();
		$("#details_module").hide();
	}else if(type == 2){
		$("#details_module").show();
		$("#import_module").hide();
	}
	$(obj).addClass("active").parent().siblings().children().removeClass("active");
	if (type == 2){
		clearInterval(if_ok);
		get_usertask_list();
		repeat_execute = function(){
			if_ok = setInterval(function(){
				get_usertask_list();
			},5000)}
		repeat_execute();
	}else{
		clearInterval(if_ok);
	}
	var w = $(window).width();
	_initSize();
}

var d;
var if_ok;
var if_ok_down;
var host_task_id;
var MAX_PAGE_T = 5;
function task_detail(obj,id){
	var filename = $(obj).attr('data');
	status = $(obj).attr('data1');
	var host_count = $(obj).attr('data2');
	var acct_count = $(obj).attr('data3');
	$("#hosttask_list_detail tbody").empty();
	$("#cover_box").iCheck('uncheck');
	$("#import_host_list_detail tbody").empty();
	$(".tab-moreinfo.tab-moreinfo-on").remove();
	$('#apArea').empty();
	$('#apArea1').empty();
	page = 0;
	ppage = 0;
	append_flag = 0;
	row_len = 0;
	remain_page = 0;
	page_flag = 0;
	same_page = 0;
	keyword_t = null;
	if (status == 0){
		_alert(2,"用户任务","该任务正在导入中");
		return false;
	}
	if (status == 2){//导入中断
		_alert(1,"用户任务","该任务发生错误");
		return false;
	}
	d.close().remove();
	var succ_flag = $(obj).parents('tr:first').children('td:eq(2)').text();
	var fail_flag = $(obj).parents('tr:first').children('td:eq(3)').text();
    var old_flag = $(obj).attr('data3');
    var new_flag = $(obj).attr('data2');
	clearInterval(if_ok);
	if (status == 1){//导入完成
		$("#fail_IP_box").iCheck('uncheck');
		$(".mm.mm1").children('span').eq(0).text(parseInt(succ_flag)+parseInt(fail_flag));
		$(".mm.mm1").children('span').eq(1).text(succ_flag);
		$(".mm.mm1").children('span').eq(2).text(fail_flag);
        $(".mm.mm1").children('span').eq(3).text(new_flag);
        $(".mm.mm1").children('span').eq(4).text(old_flag);
		
		host_task_IP_id = id;
		_initLoadData1();
		$("#fail_IP_box").unbind().on('ifChanged',function(){//仅显示导入失败的用户信息
			if ($(this).prop("checked")){
				keyword_t = 1;
			}else{
				keyword_t = null;
			}
			$('#apArea1').empty();
			page = 0;
			ppage = 0;
			append_flag = 0;
			row_len = 0;
			remain_page = 0;
			page_flag = 0;
			same_page = 0;
			_initLoadData1();
		});
		$(".container3").hide();
		$('#importPage').show();
	}
}

function _initLoadData1() {
	var h1 = $('#importPage').height();
	var h2 = $('#apArea1').height();
	var add = function() {
		if (h1 - 203 > h2) {
			page++;
			var offsetrow = (page-1)*10;
			get_import_detail_user(host_task_IP_id,10,offsetrow);
			get_data_i(0);
			h2 = $('#apArea1').height();
		}else{
			clearInterval(if_select1);
			return false;
		}
	}
	var if_select1 = setInterval(function(){
		if (row_len < 10){
			clearInterval(if_select1);
			return false;
		}
		if (row_len == 10 && import_list_detail.totalrow == 10){
			clearInterval(if_select1);
			return false;
		}
		add();	
	},1000);
	
	add();
}
function get_data_i(type_add){
	if($("#apArea1").find('.apSort').length==0){
		$("#apArea1").append('<div class="apSort"></div>');
	}
	$('#aploadTip1').show();
	var html = '';
	var Status;
	var append_a = append_flag % 10
	var npage = 0;

	var page_i = -1;
	var page_re = 0;
	$(".mm.mm1").children('span').eq(0).text(import_list_detail.totalrow);
	if (import_list_detail.data.length == 0){
	  //return false;
	}
	$.each(import_list_detail.data,function(i,item){
		//var host_v = JSON.parse(item.UserInfo);
		if (item.Status == 0){
			Status = "成功";
			html += '<div class="apItem"><div class="label succ" style="width:50%; text-overflow: ellipsis;">' + item.UserCode + '</div><div class="cc" style="padding-left: 50%;"><table cellpadding="0" cellspacing="0"><tbody><tr><td style="width:153px;" title="'+Status+'">' + Status + '<span class="a"></span></td></tr>';
		}else if (item.Status == 1){
			Status = "失败：" + item.ErrorLog;
			html += '<div class="apItem"><div class="label fail" style="width:50%; text-overflow: ellipsis;">' + item.UserCode + '</div><div class="cc" style="padding-left: 50%;"><table cellpadding="0" cellspacing="0"><tbody><tr><td style="width:153px;" title="'+Status+'">' + Status + '<span class="a"></span></td></tr>';
		}
		html += '</tbody></table></div></div>';
		$("#apArea1").find('.apSort:last').append(html);
		html = '<div class="ap-pc"> 共' + import_list_detail.totalrow + '条</div>';
		$("#apArea1").find('.ap-pc:last').remove();
		$('#apArea1').append(html);
		html = "";

		if (append_a % 10 != 0){
			html += '</tbody></table></div></div>';
		}
		npage = i + 1;
		npage = i + 1;
	});
	$("#apArea1").find('.apSort:last').append(html);
	html = '<div class="ap-pc"> 共' + import_list_detail.totalrow + '条</div>';
	$("#apArea1").find('.ap-pc:last').remove();
	$('#apArea1').append(html);
	var maxPage = Math.floor(import_list_detail.totalrow / 10);

	var task_page = page - 1,
		num = 10;
	var pnum = (task_page * num + 1) + '-' + (task_page + 1) * num;
	if((task_page + 1) * num > import_list_detail.totalrow){
		pnum = (task_page * num + 1) + '-' + import_list_detail.totalrow;
	}
	if (task_page >= maxPage) {
		$('#aploadTip1').html('已全部加载').show();
		return;
	} else if (task_page < maxPage) {
		$('#aploadTip1').hide();
	}
	if(type_add<2){
		type_add++;
		_addData1(type_add);
	}
}
var append_flag = 0;
var ppage = 0;
var row_len = 0;
var remain_page = 0;
var page_flag = 0;
var same_page = 0;

var page = 0;

$('#importPage').scroll(function() {
	var wh = $('#importPage').height(),
	vh = $('#apArea1').height(),
	st = $('#importPage').scrollTop();

	if (wh + st >= vh) {
		_addData1(0);
	}
})

function _addData1(type_add) {
	if ($('#aploadTip1').is(':visible')) {
		return;
	}
	page++;
	var offsetrow = (page-1)*10;
	get_import_detail_user(host_task_IP_id,10,offsetrow);
	get_data_i(type_add);
}

//获取导入完成的详细信息
var import_list_detail;
var keyword_t;
function get_import_detail_user(id,limitrow,offsetrow){
	$.ajax({
		url:'/bhost/get_import_detail_user',
		type:'post',
		async:false,
		data:{'a0':sess,'a1':id,'a2':keyword_t,a3:limitrow,a4:offsetrow},
		success:function(result){
			import_list_detail = JSON.parse(result);
			//import_list_detail.data.sort(import_list_detail);
		}
	});
}
function _import_user(type){
	$("#file_v").val('');
	$("#file_change").val('');
	$("#file_change1").val('');
	$("#pending_box").iCheck('uncheck');
	$("#cover_box1").iCheck('uncheck');
	var $dialogCont = $("#scDCTab2_import").show();
	d = dialog({
		title:"用户导入",
		content:$dialogCont,
		id:"scDCTab2_import",
		width:"850px"
	});
	d.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
		if (if_ok == null){
		}else{
			clearInterval(if_ok);
		}
		_initList();
	});
	d.showModal();
	if (type == 1){
		$("#import_module").show();
		$("#details_module").hide();
		$("#task_import").addClass("active").parent().siblings().children().removeClass("active");
		_initSize();
	}
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		d.close().remove();
	});
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){
		if ($("#details_module").is(':visible')){
			d.close().remove();
			return false;
		}
		var cover_flag = 0;
		var pending_flag = 0;
		if ($("#file_v").val() == ""){
			_alert(2,"用户导入","请选择文件");
			return false;
		}
		var file_v = $("#file_v").val();
		var fileReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
		if (!fileReg.test(file_v)){
			_alert(1,"用户导入","导入文件名称格式不正确");
			return false;
		}

		if (file_v.substr(file_v.length-3) != "csv" && file_v.substr(file_v.length-3) != "CSV" && file_v.substr(file_v.length-3) != "xls" && file_v.substr(file_v.length-3) != "XLS" && file_v.substr(file_v.length-4) != "xlsx" && file_v.substr(file_v.length-4) != "XLSX"){
			_alert(1,"用户导入","导入文件格式不正确，只支持.csv、.xls、.xlsx格式文件");
			return false;
		}
		if (file_v.substr(file_v.length-4) == "xlsx" || file_v.substr(file_v.length-4) == "XLSX"){
			var file_name = file_v.substring(0,file_v.length-5);
		}else{
			var file_name = file_v.substring(0,file_v.length-4);
		}		

		var file_exist = 0;
		var formData_f = new FormData($("#uploadForm")[0]);
		formData_f.append('a0',sess);
		formData_f.append('a99',use_BH);
		$.ajax({
			url:'/bhost/isexist_import',
			type:'post',
			data:formData_f,
			async: false,  
			cache: false,
			contentType: false,
			processData: false,
			success:function(result){
				var is_r = JSON.parse(result);
				if (is_r.Result){
					file_exist = 0;
				}else{
					file_exist = 1;
					_alert(2,"用户导入","该任务已存在");
					return false;
				}	
			}
		});
		if (file_exist == 1){
			return false;
		}		
		if ($("#cover_box1").prop('checked')){
			cover_flag = 1;
		}else{
			cover_flag = 0;
		}
		var formData = new FormData($("#uploadForm")[0]);
		formData.append('a1',cover_flag);
		formData.append('a0',sess);
		formData.append('a99',use_BH);
		$.ajax({
			url:'/bhost/import_data_user',
			type: 'POST',
			data: formData,  
			async: false,  
			cache: false,
			contentType: false,  
			processData: false,  
			success: function (result) {
				$("#file_v").val('');
				$("#file_change").val('');
				$("#file_change1").val('');
				$("#cover_box1").iCheck('uncheck');
				$.ajax({
					url:'/bhost/get_usertask_data',
					type:'post',
					async:false,
					data:{a0:sess,a1:1,a2:5},
					success:function(result){
						var task_list_data = JSON.parse(result);
						var totalpage = Math.ceil(parseInt(task_list_data.totalrow)/MAX_PAGE_T);
						if (totalpage < 1){
							totalpage = 1;
						}
						//$("#curpage").val(totalpage);
						$("#curpage").val(1);
						set_tab($("#task_list_tab"),2);
					}
				});
				set_tab($("#task_list_tab"),2);
			}
		});
	});
}
function _export_user(type){
	if (type == 1){
		_export();
	}
	else {
        var $dialogCont = $("#export_type").show();
        title = "导出";
        var d = dialog({
            title: title,
            content: $dialogCont,
            id: "export_type",
            width: "700px",
        });
        d.addEventListener('close', function () {
            $dialogCont.appendTo("body").hide();
        });
		$('#user_check').unbind().on('ifChecked',function(){
			$('#all_check').iCheck('uncheck');
		}).on('ifUnchecked',function(){
			if (!$('#user_check').is(':checked') && !$('#usergroup_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		});
		$('#usergroup_check').unbind().on('ifChecked',function(){
			$('#all_check').iCheck('uncheck');
		}).on('ifUnchecked',function(){
			if (!$('#user_check').is(':checked') && !$('#usergroup_check').is(':checked')){
				$('#all_check').iCheck('check');
			}
		});
		$('#all_check').iCheck('check');
		$('input[name=exportType_radio2][value=0]').iCheck('check');
        d.showModal();
        $("a.btn-submit", $dialogCont).unbind().bind("click", function () {
            d.close().remove();
            layer.open({
                type: 1,
                title: '用户管理',
                content: '<div class="layer-alert"><i class="alert warning"></i>确认导出</div>',
                btn: ['是', '否'],
                btnAlign: 'c',
                closeBtn: false,
                skin: 'layer-custom',
                area: ['380px', '310px'],
                move: false,
                resize: false,
                btn1: function (i) {
					var exportType=[];
					var format=$("#export_type").find("input[name=exportType_radio2]:checked").val();
					if($('#user_check').is(':checked')){
						exportType.push('user');
					}
					if($('#usergroup_check').is(':checked')){
						exportType.push('usergroup');
					}
					if($('#all_check').is(':checked')){
						exportType.push('all');
					}
					exportType=exportType.join(',');
					layer.close(i);
					$.ajax({
						url: '/bhost/export_data_user',
						type: 'post',
						async: false,
						data: {a0: sess, a1: type, a2: exportType, a3: format},
						success: function (result) {
							var result_arr=result.split(':');
							if (result.split(':')[0]=='true'){
								var file_name=result.split(':')[1]
							}else{
								var result=JSON.parse(result);
								if(!result.Result){
									_alert(1,"授权导出",result.info);
									return false;
								}
							}
							_showLoading();
							repeat_get = function () {
								if_ok_down = setInterval(function () {
									get_down_ok(format,file_name);
								}, 5000)
							}
							repeat_get();
						}
					});
                },
                btn2: function (i) {
                    layer.close(i);
                }
            });
        });
    }
}
function _export(){
	var data = [
		['*用户组名称','*组路径','描述','管理员','用户'],
		['非空且同组下名称唯一','不填为根部目录下','','1.非必填，若没填，默认为导入该账号的管理员为配置它的管理员；2.多个管理员用;分割','可以直接在此配置组下的用户(需要用户已存在)'],
		['特殊字符仅支持下划线、横杠、小数点','格式：用户组的绝对路径,即若用户组a在用户组b下，则填/b/a'],
		['*用户账号','*用户姓名','认证方式','*密码','工号','手机','描述','邮箱','部门','*角色','管理员','第三方认证账号','唯一登录','失效时间','*用户组','是否启用'],
		['*非空唯一','非空','不填为默认认证方式','如果用户不存在，非空，如果用户已存在，保留原密码或修改','仅支持英文、数字、下划线','','','','','多个角色用;分割','1.非必填，若没填，默认为导入该账号的管理员为配置它的管理员；2.多个管理员用;分割','','是/否','1.不填为不启用；2.格式：yyyy-mm-ddThh:mm:ss；3.T为分割日期和时间的分隔符','','是/否'],
		['仅支持英文、数字、下划线、横杠、小数点','特殊字符仅支持下划线、横杠、小数点','特殊字符仅支持下划线、横杠、小数点','','','','','','','','','','','','不填为启动']
	]; 
	var csvContent = "data:text/csv;charset=utf-8,\ufeff";
	if (window.navigator.msSaveOrOpenBlob) {
		csvContent = "\ufeff";
	}
	data.forEach(function(infoArray, index){
		dataString = infoArray.join(",");
		csvContent += index < data.length ? dataString+ "\n" : dataString;
	});
	if (window.navigator.msSaveOrOpenBlob) {
		// if browser is IE
		var blob = new Blob([decodeURIComponent(encodeURI(csvContent))],{
		    type: "text/csv;charset=utf-8;"
		});
		navigator.msSaveBlob(blob, '用户导入模板.csv');
	}else{
		var encodedUri = encodeURI(csvContent);
		var link = document.createElement("a");
		link.setAttribute("href", encodedUri);
		link.setAttribute("download", "用户导入模板.csv");
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
	}
}
function get_down_ok(format,file_name){
	$.ajax({
		url:'/bhost/get_down_ok_user',
		type:'post',
		async:false,
		data:{a0:sess,a1:format,a2:file_name},
		success:function(result){
			var down_result = JSON.parse(result);
			if (down_result.Result){
				clearInterval(if_ok_down);
				_closeLoading();
				if (down_result.ErrMsg != "None"){
					_alert(1,"用户导出",down_result.ErrMsg);
					return false;
				}
				if(use_BH=='0'){
					document.frm1.action='/bhost/download_file_user';
					document.frm1.a0.value = sess;
					document.frm1.a1.value = down_result.file_name;
					document.frm1.z1.value = format;
					document.frm1.a99.value = use_BH;
					document.frm1.submit();
					$.ajax({
						url:'/bhost/del_user_file',
						type:'post',
						async:false,
						data:{a0:sess,z1:down_result.file_name},
						success:function(result){

						}
					});
					return 0;
				}
				
				$.ajax({
					url:'/bhost/download_file_user',
					type:'post',
					async:false,
					data:{a0:sess,z1:format,a99:use_BH,a1:down_result.file_name},
					success:function(result){
						var result=JSON.parse(result);
						//console.log(result);
						if(result.Result){
							var sesstimet = (new Date()).valueOf();
							//console.log(sesstimet);
							var referrer_arr=document.referrer.toString().split('/');
							referrer_arr.pop();
							var referrer=referrer_arr.join('/');
							var json_download = {
									"Type": "Download",
									"Url": referrer,
									"Path": result.path,
									"Filename": result.filename,
									"Session": sess,
									"sesstimet":sesstimet,
									"Filenewname": result.filenewname
							}
							//console.log(json_download);
							var if_html_client = false;
							var base64_str = '';
							$.ajax({
									url: "/bhost/get_base64",
									type:"POST",
									async:false,
									data:{a0:sess,z1:JSON.stringify(json_download)},
									success:function(result){
											var result=JSON.parse(result);
											if(result.Result){
													if_html_client = result.info;
													base64_str = result.b64;
											}else{
													_alert(1,"用户管理",result.ErrMsg); 
											}
									}
							})
							if(if_html_client) window.open('https://'+document.domain+':'+location.port+'/bhost/test_html?se='+window.parent.document.frm.se.value+'&z1='+JSON.stringify(json_download));
							else{
								get_regedit('bhost', window.parent.document.frm.se.value,'',sesstimet);
								$('#YuFrame1').remove();
								$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
								$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+base64_str);
							}
						}
					}
				});
				/*
				$.ajax({
			                url:'/bhost/del_user_file',
                			type:'post',
                			async:false,
                			data:{a0:sess,z1:format},
                			success:function(result){

					}
				});
				*/
			}
		}
	});
}
//弹窗列表绑定
function tabArr1(){
	$('table').unbind();
	var tout,tin;
	var $cloneItem;
	var z = false;

	$('#usertask_list').on('mouseover','tbody>tr',function(){
		document.onclick = null;
	}).on('mouseout','tbody>tr',function(){
		document.onclick = function(){
			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
		}
	}).on('click','tbody>tr',function(e){		
		x=e.target;
		if(x.id=='del'){
			return false;
		}
		if(x.id=='edit'){
			return false;
		}
		document.onclick = null;

		var $this = $(this);

			var $tr = $this;

			var oset = $tr.offset();
			var trc = $tr.attr('class');
			if(trc && trc.indexOf('on') >=0 ){
				$('div.tab-moreinfo-on').hide();
				$('div.tab-moreinfo-on').remove();
				$('tr.on').removeClass('on');
				return;
			}

			$('div.tab-moreinfo-on').hide();
			$('tr.on').removeClass('on');
			$tr.addClass('on');
			
			var $box = $this.parents('div.box-table');
			var boxh = $box.outerHeight(), boxo = $box.offset();

			var $item = $this.children('td:last').children('div.tab-moreinfo');
			var ih = $item.outerHeight(),th = $tr.outerHeight();
			$cloneItem = $item.clone().addClass('tab-moreinfo-on').appendTo('body');
			if(boxh < oset.top-boxo.top + ih + th - 40 ){
				$cloneItem.css({
					top:oset.top - ih,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
            }
            else{
				$cloneItem.css({
					top:oset.top + $tr.outerHeight() + 1,
					left:oset.left,
					width:$tr.outerWidth() - 1,
					opacity:0,
					display:'block'
				}).stop().animate({
					opacity:1
				});
			}
			//$cloneItem.prev('div').remove();
			z_v = $cloneItem.prev('div').css('z-index');
			$cloneItem.css('z-index',z_v+1);
    });
    $('.box-table,body,.c-cont2,.c-cont').off("scroll");
	$('.box-table,body,.c-cont2,.c-cont').on('scroll',function(){
		$('div.tab-moreinfo-on').remove();
		$('tr.on').removeClass('on');
	})
	
	var len = $('.tab-ctr:first').children('a').length;
	$('#usertask_list>thead>tr>th:last').width(len*26);
}

//任务列表翻页
function turn_page(type){
	switch (type){
		case 1: //首页
			$("#curpage").val(1);
			break;
		case 2://上一页
			var cur = $("#curpage").val();
			if (cur == '1'){
				return false;
			}else{
				$("#curpage").val((parseInt(cur)-1));	
			}
			break;
		case 3://下一页
			var cur = $("#curpage").val();
			var total = $("#totalpage").text();
			if (cur == total){
				return false;
			}else {
				$("#curpage").val((parseInt(cur)+1));
			}
			break;
		case 4:
			$("#curpage").val($("#totalpage").text());
			break;
		case 5:
			var cur = $("#curpage").val();
			var numReg = /\D/;
			if (numReg.test(cur) || parseInt(cur) < 1 || cur == ''){
				$("#curpage").val(1);
			}
			break;
		default:
			;
	}
	get_usertask_list();
}

function clear_totp(){
	$.ajax({
		url:'/bhost/clear_secretkey',
		type:"POST",
		async:false,
		data:{a0:sess,z1:user_item.UserId},
		success:function(result){
			var clear_re = JSON.parse(result);
			if (clear_re.Result){
				_alert(0,"系统用户","TOTP重置成功");
				user_item.SecretKey = "";
				return false;
			}else{
				_alert(0,"系统用户","TOTP重置失败："+clear_re.ErrMsg);
				return false;
			}
		}
	})
}
/*
*/
var authtype_data;
//var flag_pwd_default = 0;
function get_authtype_list(){
	$.ajax({
		url: "/bhost/get_authtype_list",
		type:"POST",
		async:false,
		data:{a0:sess},
		success:function(result){
			var authtype_result = JSON.parse(result);
			if (authtype_result.Result==true){
				authtype_list = authtype_result.info.data;
				authtype_data = authtype_list;
				//$('#sys_u_authtype').empty();
				//$('#sys_u_authtype').append('<option value="null" selected>默认</option>');
				var default_authtype = {};
				var flag_pwd_default=0;
				var flag_usbkeylen_default=-1;
				$(authtype_data).each(function(i,item){
					//查看是否存在 本地认证		0->包含本地认证  不包含usbkey    1->不包含本地认证 但是 包含 TOTP    3->包含usbkey 不包含本地认证   4  包含usbkey  包含本地认证    6  包含本地认证 包含指纹  7  不包含本地认证 包含指纹   2-> 不包含 0 1 3 4 6 7的情况
					var flag_pwd = 0; 					
					var tmplist = [];
					var usbkeylen = -1; //不是usbkey认证
					$(item.Set).each(function(i1,item1){
						tmplist.push(item1.AuthMode);	
						if(item1.AuthMode == 8) {
							if(item1.PwdLen !=null) usbkeylen =  item1.PwdLen;
							else usbkeylen = 0; //没有配置长度
						}
					})
					if(tmplist.indexOf(1) >=0){
						flag_pwd = 0;
						//if(tmplist.length == 1) flag_pwd = 5;
						//if(tmplist.indexOf(8) >=0) flag_pwd = 4;
					}
					// else if(tmplist.indexOf(10) >=0){
					// 	flag_pwd = 1;
					// }else if( tmplist.indexOf(8) >=0 ){
					// 	flag_pwd = 3;
					// }
					else{
						flag_pwd = 2;
					}
					if(item.IsDefault == true){
						flag_pwd_default = flag_pwd;
						flag_usbkeylen_default=usbkeylen;
					}
					if(tmplist.indexOf(9) >=0){
						flag_pwd = flag_pwd+',9';
					}
					authtype_data[i].flag_pwd = flag_pwd;
					authtype_data[i].usbkeylen = usbkeylen;
					//$('#sys_u_authtype').append('<option flag_pwd='+flag_pwd+' value="'+item.AuthTypeId+'">'+item.AuthTypeName+'</option>');
				})
				 default_authtype = {
					"Set": [

					],
					"IsDefault": true,
					"Separator": null,
					"AuthTypeId":-1,
					"AuthTypeName": "默认",
					"MustAllModulesSucc": true
				}
				default_authtype.flag_pwd=flag_pwd_default;
				default_authtype.usbkeylen=flag_usbkeylen_default;
				authtype_data.unshift(default_authtype);
				//$('#sys_u_authtype option').eq(0).attr('flag_pwd',flag_pwd_default);
				//$('#sys_u_authtype').select2().trigger('change');
			}
		}
	})
	
}
var AuthType_role = 0;
function get_AuthType_role(){ // 0 只能选  1 能看到 2 能编辑
	$.ajax({
		url: "/bhost/get_AuthType_role",
		type:"POST",
		async:false,
		data:{a0:sess},
		success:function(result){
			var results = JSON.parse(result);
			if (results.Result==true){
				AuthType_role = results.info
			}
		}
	})
} 
var c_index_all_authtype = [];
var authtype_list_tmp =[];
//绑定客户端集合
function bind_authtype_xSelect(){
	tmp_authtype_id = $('#sys_u_authtype').data('value');
	tmp_authtype_txt = $("#sys_u_authtype").find('span').text();
	$("div[data-id=xSelect-authtype]").remove();
	get_authtype_list();
	$('#sys_u_authtype').empty().data('xSelect','');
	var authtype_array = [];
	c_index_all_authtype = [];
	$.each(authtype_data,function(i,item){
		if ($("#sys_u_authtype").data('value') == item.AuthTypeId){
			
		}else{
			if (authtype_list_tmp.indexOf(item.AuthTypeId) > -1){
				return true;
			}
		}
		if(AuthType_role == 0){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'flag_pwd':0,
				'usbkeylen':0,
				'type':''
			};
		}else if (AuthType_role == 1){
			if(item.AuthTypeId == -1){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':''
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':'check'
				};
			}
		}else{
			if(item.AuthTypeId == -1){
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':''
				};
			}else{
				var select_data_json = {
					'value':1,
					'name':'admin2',
					'flag_pwd':0,
					'usbkeylen':0,
					'type':'edit'
				};
			}
		}
		select_data_json.value = item.AuthTypeId;
		select_data_json.name = item.AuthTypeName;
		select_data_json.flag_pwd = item.flag_pwd;
		select_data_json.usbkeylen = item.usbkeylen;
		authtype_array.push(select_data_json);
		c_index_all_authtype.push(item.AuthTypeId);
	});
	if(AuthType_role ==2){
		$('#sys_u_authtype').xSelect({
			width: 200,
			defaultText: '默认',
			items:authtype_array,
			module_type:'authtype',
			edit: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			check: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			btn:[
				{
					'name':'新增',
					'event': function(items,obj){
						_editNode3(obj,1);
					}
				}
			],
			setval:function(item,obj){
				change_authtype_scope(obj);
			}
		});
	}else{
		$('#sys_u_authtype').xSelect({
			width: 200,
			defaultText: '默认',
			items:authtype_array,
			module_type:'authtype',
			edit: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			check: function(item,obj){
				$('.'+$('.xSelect_aythtypeList .xSelect-show').data('id')).hide();
				_editNode3(obj,2);
			},
			setval:function(item,obj){
				change_authtype_scope(obj);
			}
		});
	}
	
	if(tmp_authtype_id != undefined){
		$('#sys_u_authtype').data('value',tmp_authtype_id);
		$("#sys_u_authtype").find('span').text(tmp_authtype_txt);
		if(tmp_authtype_id != -1){
			$('.xSelect-authtype li').each(function(){
				if($(this).children('span').data('value') == tmp_authtype_id){
					change_authtype_scope(this);
				}
			})
		}	
	}else{
		$("#sys_u_authtype").find('span').text("默认");
		$('#sys_u_authtype').data('value','-1');
		change_authtype_scope($(".xSelect-authtype li").eq(0));
		$(".xSelect-authtype li").eq(0).attr('class','active');
	}
	if($("#FinP_reset_div").find("text").is(":visible") == true && $("#FinP_reset_div").find("text").text() == "已录入"){
		$("#select_local").val('1').trigger('change').attr("disabled",true);
	}else if($("#changepin_div").find("text").is(":visible") == true && $("#changepin_div").find("text").text() == "已配置"){
		$("#select_local").val('1').trigger('change').attr("disabled",true);
	}else{
		$("#select_local").val('0').trigger('change').attr("disabled",false);
	}	
	//$('#mframe1').attr('src','/bhost/authtype_handle?tasktype=1&authtypeId=1&paging=1&search_typeall=&e=all-&se='+sess+'&i1=1');
}
function show_configStatus() {
	$("text").show();
	if(FP_SET == true){
		$("#FinP_reset_div").find("text").show().text("已录入");
		$("#select_local").val('1').trigger('change').attr("disabled",true);
	}else{
		$("#FinP_reset_div").find("text").show().text("未录入");
		$("#select_local").val('0').trigger('change').attr("disabled",false);
	}
	if(KEY_SET == true){
		$("#changepin_div").find("text").show().text("已配置");
		$("#select_local").val('1').trigger('change').attr("disabled",true);
	}else{
		$("#changepin_div").find("text").show().text("未配置");
		$("#select_local").val('0').trigger('change').attr("disabled",false);
	}
}
var global_auth = -1;
var global_flag_pwd = 0;
function change_authtype_scope(obj){
	var auth_type = $(obj).children('span').data('value');
	global_auth = parseInt(auth_type);
	auth_class = 0;
	
	if(global_id >0){
		show_configStatus();
		flag_pwd = $(obj).children('span').attr('flag_pwd');
		//yt 2018-05-10
		ts = $(obj).children('span').attr('flag_pwd').split(',');
		flag_pwd = ts[0];
		global_flag_pwd = flag_pwd;
		$("#changepin_div1").parent().hide();
		//$("#changepin_local").hide();
		if(auth_type == "-1"){
			auth_class = authDefault_flag;
		}else{
			$.each(authtype_data,function(i,item){
				if(auth_type == item.AuthTypeId){
					$.each(item.Set,function(i1,item1){
						if(item1.AuthMode == 6){ // 令牌
							auth_class += 1;
						}else if(item1.AuthMode == 8){  // logobase key
							auth_class += 2;
						}else if(item1.AuthMode == 10){ //编辑 totp
							auth_class += 4;
						}else if(item1.AuthMode == 13){ //中控指纹
							auth_class += 8;
						}
					})
					return false;
				}
			})
		}
		//console.log(auth_class);
		/*	
				1: 令牌
				2:  key
				3: 令牌 + key
				4:  totp
				5:  totp + 令牌
				6: totp + key
				7: 令牌 + key + totp
				8: 指纹
				9: 令牌 + 指纹
				10: 指纹 + key
				12: 指纹 + totp
				15: 令牌 + key + totp + 指纹
		*/
		if(auth_class == 2){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
			if(flag == 1){
				//change_PIN();
				if(flag_pin == 1){
					$("#changepin_div").parent().show();
					$("#changePIN").text('修改pin码');						
				}else{
					//change_PIN();
					$("#changepin_div").parent().show();
					$("#changePIN").text('设置pin码');						
				}
			}else{
				//change_PIN();
				$("#changepin_div").parent().show();
				$("#changePIN").text('设置pin码');
			}
			/*$("#changepin_div").attr('style','width: 8%; position: absolute; margin-left: 290px; margin-top: -27px;');*/
		}else if(auth_class == 1){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
			/*$("#tokenid_div").attr('style','width:20%; margin-left: 305px; margin-top: -40px;');*/
		}else if(auth_class == 3){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
			if(flag == 1){
				$("#changePIN").parent().text('修改pin码');
			}else{
				$("#changePIN").parent().text('设置pin码');
			}
		}else if(auth_class == 4){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().hide();
			$('#totp_reset_div').parent().show();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}else if(auth_class == 5){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#totp_reset_div').parent().show();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}else if(auth_class == 6){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().show();
			$('#totp_reset_div').parent().show();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}else if(auth_class == 7){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#totp_reset_div').parent().show();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}else if(auth_class == 8){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().hide();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
		}else if(auth_class == 9){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
		}else if(auth_class == 10){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().show();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
		}else if(auth_class == 11){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
		}else if(auth_class == 12){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().hide();
			$('#totp_reset_div').parent().show();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
		}else if(auth_class == 15){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#totp_reset_div').parent().show();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
		}else{
			$("#auth_div").hide();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().hide();
			$('#totp_reset_div').parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}
		//密码框处理
		/*
			先锁定全部密码框
			存在本地认证 放开密码框
			保存的时候判断（判断存在未配置的认证配置时 提示录入或者设置pin）
		*/
		$("#select_local").val('1').trigger('change').attr("disabled",true);
		$('#sys_u_pwd_new').attr('disabled',true);
		$('#sys_u_pwd_tr').attr('disabled',true);
		$('#btn_pwd').parent().hide();
		if(flag_pwd == '0'){ //本地认证
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}
	}
	else{
		show_configStatus();
		$("#changepin_div1").parent().hide();
		$('#totp_reset_div').parent().hide();
		var totp_flag = false;
		//yt 2018-05-10
		////console.log($(obj));
		//$("#changepin_local").hide();
		flag_pwd = $(obj).children('span').attr('flag_pwd');
		//yt 2018-05-10
		ts = $(obj).children('span').attr('flag_pwd').split(',');
		flag_pwd = ts[0];
		global_flag_pwd = flag_pwd;
		var F1 = false;
		if(auth_type == '-1'){
			if(authDefault_flag == 1){
				auth_class = 1;
			}else if(authDefault_flag == 2){
				auth_class = 2;
			}else if(authDefault_flag == 3){
				auth_class = 3;
			}
		}else{
			$.each(authtype_data,function(i,item){
				if(auth_type == item.AuthTypeId){
					$.each(item.Set,function(i1,item1){

						if(item1.AuthMode == 6){	// 令牌
							auth_class += 1;
						}else if(item1.AuthMode == 8){ 	//Key
							auth_class += 2;
							F1 = true;
						}else if(item1.AuthMode == 13){ //中控指纹
							auth_class += 4;
							F1 = true;
						}else if(item1.AuthMode == 10){ //totp
							totp_flag = true;
						}
					})
					return false;
				}
			})
		}

		//console.log(auth_class);
		/*	
				1: 令牌
				2:  key
				3: 令牌 + key
				4:  指纹
				5:  指纹 + 令牌
				6: 指纹 + key
				7: 令牌 + key + 指纹
		*/
		if(auth_class == 2){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().show();
			$("#changePIN").text('设置pin码');
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}else if(auth_class == 1){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}else if(auth_class == 3){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 4){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 5){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 6){
			$("#auth_div").show();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().show();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else if(auth_class == 7){
			$("#auth_div").show();
			$("#tokenid_div").parent().show();
			$("#changepin_div").parent().show();
			$('#FinP_reset_div').parent().show();
			$('#auth_divs').children('li').show();
			$("#changePIN").text('设置pin码');
		}else{
			$("#auth_div").hide();
			$("#tokenid_div").parent().hide();
			$("#changepin_div").parent().hide();
			$('#FinP_reset_div').parent().hide();
			$('#auth_divs').children('li').hide();
		}
		//密码栏处理
		/*
		先全部锁定
			存在usbkey 第三方 指纹 ->F1 放开初始密码（保存认证配置时 判断 不存在未配置的时候 锁定初始密码）
			存在本地认证 放开设置密码 （默认为设置密码）
			存在TOTP 只有初始密码 ->totp_flag
			保存的时候判断（设置密码情况下 存在未配置的认证配置时 提示录入或者设置pin）
		*/
		//console.log(flag_pwd);
		$("#select_local").val('1').trigger('change').attr("disabled",true);
		$('#sys_u_pwd_new').attr('disabled',true);
		$('#sys_u_pwd_tr').attr('disabled',true);
		$('#btn_pwd').parent().hide();
		if(F1 == true){
			$("#select_local").val('0').trigger('change').attr("disabled",true);
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}
		if(flag_pwd == '0'){
			$("#select_local").val('1').trigger('change').attr("disabled",false);
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}
		if(totp_flag == true){
			$("#select_local").val('0').trigger('change').attr("disabled",true);
			$('#sys_u_pwd_new').attr('disabled',false);
			$('#sys_u_pwd_tr').attr('disabled',false);
			$('#btn_pwd').parent().show();
		}
			

		//查看是否存在 本地认证		0->包含本地认证 1->不包含本地认证 但是 包含 TOTP Logbase key	2-> 不包含 0 1 的情况
		//console.log("flag_pwd: "+flag_pwd);
	}
	////短信 手机必填
	var flag_phone= false;
	var flag_email = false;
	if(auth_type == '-1'){
		$.each(authtype_data,function(i,item){
			if(item.IsDefault == true){
				$.each(item.Set,function(i1,item1){
					if(item1.AuthMode == 11){
						flag_phone = true;
					}
					if(item1.AuthMode == 12){
						flag_email = true;
					}
				})
				return false;
			}
		})
	}else{
		$.each(authtype_data,function(i,item){
			if(auth_type == item.AuthTypeId){
				$.each(item.Set,function(i1,item1){
					if(item1.AuthMode == 11){
						flag_phone = true;
					}
					if(item1.AuthMode == 12){
						flag_email = true;
					}
				})
				return false;
			}
		})
	}
	if(flag_phone == true){
		$('#phone_em').show();
	}else{
		$('#phone_em').hide();
	}
	
	if(flag_email == true){
		$('#mail_em').show();
	}else{
		$('#mail_em').hide();
	}
	
	//
	usbkeylen = flag_pwd = $(obj).children('span').attr('usbkeylen');
	if(usbkeylen == '-1' || usbkeylen == '0'){
		$('#pin_input1').removeAttr('maxlength');
		$('#pin_input2').removeAttr('maxlength');
	}else{
		$('#pin_input1').attr('maxlength',usbkeylen);
		$('#pin_input2').attr('maxlength',usbkeylen);
	}
	//
	
	//
	if( ts.length > 1){
		$('#CertCn_div').show();
	}
	else $('#CertCn_div').hide();
}

var FP_SET = false;		//是否配置指纹
var FP_TMP = "";
var KEY_SET = false;	//是否配置Pin

var client_data;
var d_authtype ;
function _editNode3(obj,type){
	title = "认证方式";
	var $dialogCont = $("#authtype_suspend").show();
	
	d_authtype = dialog({
		title:title,
		content:$dialogCont,
		id:"authtype_suspend",
		width:"1200px"
	});
	if(type == 1){
		authtypeId = 0;
	}else{		
		authtypeId = $(obj).children('span').data('value')
	}
	$('#mframe1').attr('src','/bhost/authtype_handle?tasktype='+type+'&authtypeId='+authtypeId+'&paging=1&search_typeall=&e=all-&se='+sess+'&i1=1')
	d_authtype.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d_authtype.showModal();
	//initformlist();
	$(".ui-dialog-title").css("width","140px");
	//client_main(type);
	
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		//reload(1);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
		//client_add(d);	
	})	
}
var fp_index = 1;
function IfSaveSuccess(sesstime){
	$.ajax({
		url: "/bhost/get_fpResult",
		type:"POST",
		async: true,
		data:{a0:window.parent.document.frm.us.value,a1:sesstime},
		success:function(result){
			//{\"Result\":true,\"status\":\"%s\",\"finger\":\"%s\"}
			var result=JSON.parse(result);
			if(result.Result){
				if(result.status == 1){
					_closeLoading();
					clearInterval(if_ok);
					_alert(0,'用户管理','录入成功');
					$("#FinP_reset_div").find('text').text("已录入");
					if($("#select_local").val() == "0" && $("#select_local").prop('disabled') == true){
						$("#select_local").val('0').trigger('change');
					}else{
						if($("#sys_u_pwd_new").prop("disabled") != true){
							$("#select_local").val('1').trigger('change').attr("disabled",true);
						}
					}
					FP_SET = true;
					name_index = 1;
					fp_index = getRamdomIndex(1);
					name_index = getNameIndex(1);
					var fp_name = "指纹"+name_index;
					if(FP_TMP == ""){
						FP_TMP = fp_name + '\t' + result.finger;
					}else{
						FP_TMP = FP_TMP + '\n' + fp_name + '\t' + result.finger;
					}
					var html_str1 = '<li class="item" id="fp_index'+fp_index+'" index="'+fp_index+'" style="width: 16.5%;"><input type="text" class="form-text" id="fp_conf'+fp_index+'" maxlength="31" style="width: 66px;" onblur="change_fpName(this)"><i class="ctrl del" onclick="_delFp(this)"></i></li>';
					$("#auth_divs").append(html_str1);
					$("#auth_divs").children('li:last').children('input').val(fp_name);
				}else if(result.status == 3){
					_closeLoading();
					clearInterval(if_ok);
				}
			}else{
				_alert(1,"用户管理",result.ErrMsg);
				return false;
			}
		}
	})
}
function getRamdomIndex(fp_index) {
	var flag4 = true;
	function innerFunc1(){
		flag4 = true;
		$.each($("#auth_div").find('li'),function(i,item){
			if($(item).children('input').val().substring(0, 2) == "指纹" && fp_index == $(item).attr('index')){
				fp_index++;
				flag4 = false;
				innerFunc1(fp_index);
				return false;
			}
		})
	}
	innerFunc1(fp_index);
	if(flag4 == true){
		return fp_index;
	}
}
function getNameIndex(name_index) {
	var flag4 = true;
	function innerFunc1() {
		flag4 = true;
		$.each($("#auth_divs").find('li'),function(i,item){
			if($(item).children('input').val() == "指纹"+name_index){
				name_index++;
				flag4 = false;
				innerFunc1(name_index);
				return false;
			}
		})
	}	
	innerFunc1(name_index);
	if(flag4 == true){
		return name_index;
	}
}
function _delFp(obj) {
	var $c = $(obj).parent();
	var fname = $(obj).prev().val();
	$c.remove();
	var fp_list = FP_TMP.split('\n');
	$.each(fp_list,function (i,item) {
		if(item.split('\t')[0] == fname){
			fp_list.splice(i,1);
			return false;
		}
	})
	FP_TMP = fp_list.join('\n');
	if(FP_TMP == ""){
		$("#FinP_reset_div").find('text').text("未录入");
	}
}
function change_fpName(obj) {
	var index = $(obj).parent().index() - $("#auth_divs").children('div').length;
	var fname = $(obj).val();
	if(fname == ""){
		_alert(1, "用户登录", "指纹配置名称不能为空");
	}
	var fp_list = FP_TMP.split('\n');
	var flag3 = false;
	$.each(fp_list,function (i,item) {
		if(item.split('\t')[0] == fname && index != i){
			flag3 = true;
			$(obj).val("");
			_alert(1, "用户登录", "已存在相同指纹配置名称");
			return false;
		}
		if(index == i){
			var fname_tmp = item.split('\t')[1];
			fp_list[i] = fname + '\t' + fname_tmp;
		}
	})
	if(flag3 == false){
		FP_TMP = fp_list.join('\n');
	}
}
//中控指纹
var re_5;
function setFinP() {
	if(FP_TMP.split('\n').length >= 10){
		_alert(1,"系统用户","指纹配置不能超过十个");
		return false;
	}	
	var sesstime = new Date().getTime();
	//type -> 录入 Register    验证 Verify
	json_data = {
		"type": "Register",
		"UrlIp": document.domain+ (location.port!=''?':'+location.port:''), 
		"sesstimet": sesstime, 
		"User": window.parent.document.frm.us.value, 
		"Id": "",
		"Ifzkfp": 1
	}
	_showLoading();
	$.ajax({
		url: "/bhost/insert_fp",
		type:"POST",
		async: true,
		data:{a0:window.parent.document.frm.us.value,a1:sesstime},
		success:function(result){
			var result=JSON.parse(result);
			if(result.Result){
				$.ajax({
					url: "/bhost/get_base64",
					type:"POST",
					async: true,
					data:{z1:JSON.stringify(json_data)},
					success:function(result){
						var result=JSON.parse(result);
						if(result.Result){
							base64_str = result.b64;
							$('#YuFrame1').remove();
							$("<iframe width='0px' height='0px' id='YuFrame1' style=\"display:none;\" name='YuFrame1' ></iframe>").prependTo('body');
							$('#YuFrame1').attr('src','/bhost/test_html?t1=bhost&z1='+ base64_str);
							//每5秒刷新录入结果
							var c = 0;
							var if_ok_down_other = setInterval(function(){
								var se = se || ' ';
								var ret = repeat_get_path_other(sesstime,se);
								if(ret[0] == 1 && ret[1].toLowerCase() == 'true' ){
									if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='1';
									clearInterval(if_ok_down_other);
									re_5 = function(){
										if_ok = setInterval(function(){
											IfSaveSuccess(sesstime);
										},1000)}
									re_5();
									return 0;
								}
								if(c >= 10){
									if(window.parent.parent.document.frm.use_BH!=undefined)window.parent.parent.document.frm.use_BH.value='0';
									clearInterval(if_ok_down_other);
									alertError('bhost',se,window.parent.document.frm.us.value);
									_closeLoading();
									return 0;
								}
								c = c + 1;
							},500)
						}else{
							_alert(1,"用户登录",result.ErrMsg);
							return false;
						}
					}
				})
			}else{
				_alert(1,"用户管理",result.ErrMsg);
				return false;
			}
		}
	})
}

</script>

<script type="text/javascript">
//角色
var role_data;
var role_data_all = [];
var Role_Data = [];
var roleid = null;
var userid_str = '';
function _get_rn(){
	//$("#select_r").empty().html('<div class="item" style="width: 34%;float: left;margin-left: -19px;"><select class="filter-select" name="rn" id="rn" style="width:202px;" tabindex="-1" aria-hidden="false" onchange="role_select(this)"></select><i class="ctrl add" onclick="_addRole(this)"></i></div>');

	$.ajax({
		url:"/bhost/_get_rn",
		type:"POST",
		async:false,
		data:{a0:sess,a1:userid_str},
		success:function(result){
			role_result = JSON.parse(result);
			if(role_result.Result){
				role_data = role_result.info;
				Role_Data = role_data;
				$("#rn").empty().append('<option value=\"-1\">请选择</option>');
				$.each(role_data.data,function(i,item){
					pwd_flag = 0;
					access_flag = 0;
					$(item.Permission).each(function(i1,item1){
						if(item1.SubMenuId == 19 || item1.SubMenuId == 20 || item1.SubMenuId == 21 || item1.SubMenuId == 22 || item1.SubMenuId == 29 || item1.SubMenuId == 30 || item1.SubMenuId == 31 && item1.Mode != 0){
							pwd_flag = 1;
						}
						if(item1.SubMenuId == 25 && item1.Mode != 0){
							access_flag = 1;
						}
					})
					item['pwd_flag'] = pwd_flag;
					item['access_flag'] = access_flag;
					//$("#rn").append('<option value="'+item.RoleId+'" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" title="'+item.RoleName+'">'+item.RoleName+'</option>');
					if(role_data_all.indexOf(item.RoleId) <0 ) role_data_all.push(item.RoleId);
				})
			}else{
				_alert(1,"系统用户",'获取角色失败');
			}
		}
	});
	/*
	$('#rn').unbind().select2();
	$('#rn').select2('destroy').select2();
	$('#rn').change(function(){
		setTimeout(function() {
			if(global_flag == false)
				reload_un(CREATE_FLAG);
		},1);
	});*/
}

function reload_un(FLAG){ //重新加载功能管理员，用户管理员不变
	var sid = -1;
	var admin_list = [];
	var isRoot = false;
	if(FLAG == undefined){
		FLAG = true;
	}
	admin_id = $('#select_u select').val();
	if(admin_id != -1 && admin_id != null){
		$.each(Admin_Data,function(i1,item1){
			if(admin_id == item1.UserId){
				isRoot = item1.UserRoot;
			}
		})
		if(isRoot == false){
			admin_list.push(admin_id);
		}
	}
	$('#select_u li.item').each(function(i,item){
		var isRoot = false;
		$.each(Admin_Data,function(i1,item1){
			if($(this).attr('id') == item1.UserId){
				isRoot = item1.UserRoot;
				return false;
			}
		})
		if(isRoot == true){
			$(this).remove();
		}
		else{
			admin_list.push($(this).attr('id'));
		}
	})

	//已选择的管理员
	user_data_all = [];

	//重新加载管理员下拉框
	var ro_list = [];
	ro = $("#select_r_xselect").data('value')
	if(ro != -1){
		ro_list.push(ro);
	}
	$('#select_r li.item').each(function(i,item){
		ro_list.push($(this).attr('id'));
	})
	ro_str = ro_list.join(",");
	var tmp_list=[];
	$.ajax({
		url:"/bhost/_get_un",
		type:"POST",
		async:false,
		data:{a0:sess,a1:null,r1:ro_str},
		success:function(result){
			user_result = JSON.parse(result);
			if(user_result){
				user_data = user_result.info;
				Admin_Data = user_data;
				tmp_list=Admin_Data.map(function (params) {
					return params.UserId;
				});
				if(sid == -1 || sid != u_id && FLAG == true){
					$("#un").empty().append("<option value=\"-1\">请选择</option>")
					if(tmp_list.indexOf(u_id) >=0 ) 	$("#un").append("<option value=\""+u_id+"\" selected>"+u_nm+"</option>");			
				}else{
					$("#un").empty().append("<option value=\"-1\" selected>请选择</option>")
				}
				//$("#un").empty().append("<option value=\"-1\" selected>请选择</option>")

				if(FLAG == true){
					$.each(user_data,function(i,item){
						if(item.UserId != u_id && item.UserId != global_id){
							// $("#pu_id").append("<option value=\""+item.UserId+"\">"+item.UserCode+"</option>");
							$("#un").append('<option value="'+item.UserId+'" title="'+item.UserCode+'" type="'+item.UserRoot+'">'+item.UserCode+'</option>');
							user_data_all.push(item.UserId);
						}
					})
				}else{
					$.each(user_data,function(i,item){
						if(item.UserId != u_id && item.UserId != global_id && item.UserRoot != true){
							// $("#pu_id").append("<option value=\""+item.UserId+"\">"+item.UserCode+"</option>");
							$("#un").append('<option value="'+item.UserId+'" title="'+item.UserCode+'" type="'+item.UserRoot+'">'+item.UserCode+'</option>');
							user_data_all.push(item.UserId);
						}
					})
				}
			}else{
				_alert(1,"系统用户",'获取管理员失败');
			}
			$("#un").val('-1').trigger('change');
			if(admin_list.length != 0){
				$.each(admin_list,function(i,item){
					$.each(Admin_Data,function(i1,item1){
						if(item == item1.UserId){
							if(item1.UserRoot == true){
								user_arry.splice(0,0,'-1');
								user_data_all.splice($.inArray(parseInt(item), user_data_all), 1);
								$('#un').find('option[value='+item+']').remove();
								global_flag = true;
								$('#un').val('-1').trigger('change');
								user_tmp=[];
								$("#select_u>li").each(function(i,item){
									v_tmp=$(item).attr("id");
									user_tmp.push(v_tmp);
								});
							}else{
								if($("#un").val() != -1 && $("#un").val() != null){
									$("#un").siblings('i').click();
									$("#un").val('-1').trigger('change');
									// new_admin_str = $("#select_u").children('li').eq(0).attr('id');
									// $.each($("#select_u").children('li'),function(i3,item3){
									// 	if($(item3).attr('id') == new_admin_str){
									// 		$("#select_u").children('li').eq(0).remove();
									// 	}
									// 	return false;
									// })
								}
								$("#un").val(item).trigger('change');
								new_admin_str = $("#un").val();				
								$.each($("#select_u").children('li'),function(i3,item3){
									if($(item3).attr('id') == new_admin_str){
										$("#un").siblings('i').click();
										$("#select_u").children('li').eq(0).remove();
										//$("#un").val('-1').trigger('change');
										return false;
									}
								})
							}
						}
					})
				})
			}
			//
			if(admin_id != -1 && admin_id != null){
				$.each(Admin_Data,function(i1,item1){
					if(parseInt(admin_id) == item1.UserId){
						$("#un").val(admin_id).trigger('change');
						return false;
					}
				})
				
			}
			if($("#un").val() == undefined || $("#un").val() == null){
				$("#un").val('-1').trigger('change');
			}			
		}
	})
	
}

var role_tmp = [];
var role_arry=['-1'];
var global_role = -1;
function role_select(obj){
	var t = $(obj).children('span').data('value')
	global_role = t;
	if (role_arry.indexOf(t) === -1 && t != undefined){
		role_arry.splice(0,1,t);
	}
	/*
	if ($(obj).children('option').length == 2 && t != '-1'){
		$(obj).parent().children('i.add').click();
		$(obj).parent().hide();
	}*/
	//查看 当前角色是否有密码管理的权限
	//获取当前 角色id
	if($(obj).children('span').attr('pwd_flag') == '1'){
		//$('#mail_em').show();
	}else{
		//找到所有的 已选的角色 
		var s = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('pwd_flag') == '1'){
				//$('#mail_em').show();
				s = true;
				return false;
			}
			
		})
		if(!s){
			//$('#mail_em').hide();
		}
	}
	
	if($(obj).children('span').attr('access_flag') == '1'){
		if(global_id ==0 ) $('#exp_auth').show();
	}else{
		//找到所有的 已选的角色 
		var a = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('access_flag') == '1'){
				if(global_id ==0 ) {
					$('#exp_auth').show();
					a = true;
					return false;
				}
				
			}
		})
		if(!a){
			$('#exp_auth').hide();
		}
	}
	
	setTimeout(function() {
		//if(global_flag == false)
			reload_un(CREATE_FLAG);
	},1);
	
}
function _addRole(obj){
	var add = 0;
	var t = $('#select_r_xselect').find('span').text();
	var name2 = $('#select_r_xselect').data('value');
	var pwd_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('pwd_flag');
	var access_flag = $("div[data-id=xSelect-role]").find('span[data-value='+name2+']').attr('access_flag');	
	if (name2 == "-1" || name2 == undefined){
		_alert(2,"系统用户","请选择角色");
		return false;
	}

	
	role_arry.splice(0,0,'-1');
	role_data_all.splice($.inArray(parseInt(name2), role_data_all), 1);
	var $c = $(obj).parent();
	// $c.children('select').select2('destroy');
	var $s = $('<li class="item" id="'+name2+'" style="width: 33%;float: left;margin-left: -10px;height: 40px;margin-top: 9px;overflow: hidden;"><input type="text" class="form-text" name="'+name2+'" value="'+t+'" style="width:170px;" disabled="true" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" ><i class="ctrl del" onclick="_delRole(this)"></i></li>');
	$c.after($s);
	//$c.children('select').val(d);
	//$c.children('select').find('option[value='+name2+']').remove();
	$("#select_r_xselect").find('span').text('请选择');
	$("#select_r_xselect").data('value','-1');
	$("div[data-id=xSelect-role]").find('span[data-value='+name2+']').parent('li').remove();
	
	// $c.children('select').select2({minimumResultsForSearch: -1});
	//重新获取
	reload_un(CREATE_FLAG);
}
function _delRole(obj){
	var $c = $(obj).parent();
	var id = $c.attr('id');
	var $p = $("div[data-id=xSelect-role]").children('ul');
	var data, max;
	var min = 0;
	max = role_data_all.length - 1;
	data = role_data_all;
	var t = $(obj).siblings('input').val();
	//access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'"
	access_flag = $(obj).siblings('input').attr('access_flag');
	pwd_flag = $(obj).siblings('input').attr('pwd_flag');
	
	$c.remove();
	$("#select_r_xselect").show();
	role_arry.splice($.inArray(id,role_arry),1);

	if (max < 0){
		var index_1 = -1;
	}else{
		var index_1 = search_i(min, max, parseInt(id), data);
	}
	index_1 = parseInt(index_1);
	if (index_1 == -1) {
		index_1 = max;
		$p.append('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" style="width:324px">'+t+'</span></li>');
	} else if (index_1 == -2) {
		index_1 = 0;
		$p.children('li').eq(0).before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" style="width:324px">'+t+'</span></li>');
	} else {
		$p.find('span[data-value='+data[index_1]+']').parent('li').before('<li style=""><i class="edit"></i><span data-value="'+id+'" title="'+t+'" style="width:324px" access_flag="'+access_flag+'" pwd_flag="'+pwd_flag+'" >'+t+'</span></li>');
	}
	role_data_all.splice(index_1, 0, parseInt(id));
	//查看 当前角色是否有密码管理的权限
	//获取当前 角色id
	if($("div[data-id=xSelect-role]").find('span[data-value='+id+']').attr('pwd_flag') == '1'){
		//$('#mail_em').show();
	}else{
		var s = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('pwd_flag') == '1'){
				//$('#mail_em').show();
				s = true;
				return false;
			}			
		})
		if(!s){
			$('#mail_em').parent().next().find('i').attr('class','v-check');
			//$('#mail_em').hide();
		}
	}
	if($("div[data-id=xSelect-role]").find('span[data-value='+id+']').attr('access_flag') == '1'){
		if(global_id ==0 ) $('#exp_auth').show();
	}
	else{
		//找到所有的 已选的角色 
		var a = false;
		$('#select_r li.item input').each(function(i,item){
			if($(this).attr('access_flag') == '1' && global_id ==0){
				$('#exp_auth').show();
				a = true;
				return false;
			}
		})
		if(!a){
			$('#exp_auth').hide();
		}
	}
	//重新获取
	reload_un(CREATE_FLAG);
}

var c_index_all_role = [];
var role_list_tmp =[];
//绑定客户端集合
function bind_role_xSelect(){
	$("div[data-id=xSelect-role]").remove();
	_get_rn();
	$('#select_r_xselect').empty().data('xSelect','');
	var role_array = [];
	c_index_all_role = [];
	//当前用户的角色
	var pRoleSet = parent.user_item.RoleSet;
	var p_role_id = [];
	if(pRoleSet == undefined || pRoleSet.length == 0){
		p_role_id = []
	}else{
		$(pRoleSet).each(function(i,item){
			p_role_id.push(item.RoleId);
		})
	}
	$.each(role_data.data,function(i,item){
		if ($("#select_r_xselect").data('value') == item.RoleId){
			
		}else{
			if (role_list_tmp.indexOf(item.RoleId) > -1){
				return true;
			}
		}
		if(p_role_id.indexOf(item.RoleId) >=0 || if_disable == '1'){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'access_flag':0,
				'pwd_flag':0,
				'type':'check'
			};
		}else if(role_simple.indexOf(item.RoleId) < 0){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'access_flag':0,
				'pwd_flag':0,
				'type':'check'
			};
			/*
		}else if($("#two").attr("value")=='none'){
			var select_data_json = {};
		}else if($("#two").attr("value")=='view'){
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'access_flag':0,
				'pwd_flag':0,
				'type':'check'
			};
			*/
		}else{
			{%if 2 in _power_mode_id %}
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'access_flag':0,
				'pwd_flag':0,
				'type':'edit'
			};
			{%else %}
			var select_data_json = {
				'value':1,
				'name':'admin2',
				'access_flag':0,
				'pwd_flag':0,
				'type':'check'
			};
			{% endif %}
		}
		
		
		select_data_json.value = item.RoleId;
		select_data_json.name = item.RoleName;
		select_data_json.access_flag = item.access_flag;
		select_data_json.pwd_flag = item.pwd_flag;
		if(item.RoleName == "超级管理员"){
			select_data_json.type = 'check';
		}		
		role_array.push(select_data_json);
		c_index_all_role.push(item.RoleId);
	});
	{%if 2 in _power_mode_id %}
		$('#select_r_xselect').xSelect({
		width: 202,
		defaultText: '请选择',
		items:role_array,
		module_type:'role',
		edit: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,0);
		},
		check: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,1);
		},
		btn:[
			{
				'name':'新增',
				'event': function(items,obj){
					_editNode4(obj,1,0);
				}
			}
		],
		setval:function(item,obj){
			role_select(obj);
		}
	});
	{%else %}
		$('#select_r_xselect').xSelect({
		width: 202,
		defaultText: '请选择',
		items:role_array,
		module_type:'role',
		edit: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,0);
		},
		check: function(item,obj){
			$('.'+$('.xSelect_RoleList .xSelect-show').data('id')).hide();
			_editNode4(obj,2,1);
		},
		setval:function(item,obj){
			role_select(obj);
		}
	});
	{% endif %}
	$('#select_r i.add').show();
	//$("#sys_u_authtype").find('span').text("默认");
	//$('#sys_u_authtype').data('value','-1');
	//role_select($(".xSelect-role li").eq(0))
	//$('#mframe1').attr('src','/bhost/authtype_handle?tasktype=1&authtypeId=1&paging=1&search_typeall=&e=all-&se='+sess+'&i1=1');
}

//编辑页面全选
function _checkAllStatus(obj){
	var $c = $(obj).parents('div.cbi-cont');
	var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
	var len_v = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
	var len_1 = $('input[value=1]:checked:visible',$c).length;
	var len_2 = $('input[value=2]:checked:visible',$c).length;
	var $i = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
	var $i_1 = $c.prev('div.cbi-t').find('input[value=1]');
	var $i_2 = $c.prev('div.cbi-t').find('input[value=2]');
	if(len != clen){
		$i.prop('checked',false);
		$i.parent().removeClass('checked');
	}else{
		$i.prop('checked',true);
		$i.parent().addClass('checked');
	}
	if(len_v != len_1){
		$i_1.iCheck('uncheck');
	}else{
		$i_1.iCheck('check');
	}
	if(len_v != len_2){
		$i_2.iCheck('uncheck');
	}else{
		$i_2.iCheck('check');
	}	
}
var d_Role;
$(function(){
	
	initMenu();
	$('#role_suspend .form-checkbox,#role_suspend .form-radio').iCheck({
		checkboxClass:'icheckbox_minimal-blue',
		radioClass:'iradio_minimal-blue',
		increaseArea:'0'
	});
	//运维概要 系统概要 checkbox 事件绑定
	$('#role_suspend div.cbi-tag input[type=checkbox]').on('ifChecked',function(){
		var $s = $(this).parents('div.cbi-tag').next().next('div.cbi-sel.radio');
		var $i = $(this).parents('div.cbi-cont').prev('div.cbi-t');
		$s.show();
		$i.children().eq(2).show();
		$i.children().eq(3).show();
		_checkAllStatus(this);
	}).on('ifUnchecked',function(){
		var $s = $(this).parents('div.cbi-tag').next().next('div.cbi-sel.radio');
		var $i = $(this).parents('div.cbi-cont').prev('div.cbi-t');
		var j = 1;
		$s.hide();
		$.each($(this).parents('div.cbi-cont').find('.cbi-tag').find('input[type=checkbox]'),function(i,item){
			if($(item).prop('checked') == true){
				j = 0;
				return false;
			}
		})
		if(j == 1){
			$i.children().eq(2).hide();
			$i.children().eq(3).hide();
		}
		var $c = $(this).parents('div.cbi-cont');
		var $s = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
		var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
		if(len != clen){
			$s.prop('checked',false);
			$s.parent().removeClass('checked');
		}else{
			$s.prop('checked',true);
			$s.parent().addClass('checked');
		}
		//_checkAllStatus(this);	
	});

	//授权
	$('#role_suspend div.cbi-sel.auth input[type=checkbox]').on('ifChecked',function(){
		var $c = $(this).parents('div.cbi-cont');
		var $i_a = $c.prev('div.cbi-t').find('input[type=checkbox]:last');
		var $s = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
		var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
		var len_a = $('input[type=checkbox]:checked',$c.children().children('.cbi-sel.auth')).length;
		if(len != len_a){
			$i_a.prop('checked',false);
			$i_a.parent().removeClass('checked');
		}else{
			$i_a.prop('checked',true);
			$i_a.parent().addClass('checked');
		}
		$('.cbi-s[value=role_] input[type=checkbox]').eq(0).iCheck('check');
		$('input[name=S_30][value=2]').iCheck('check');
	}).on('ifUnchecked',function(){
		var $c = $(this).parents('div.cbi-cont');
		var $i_a = $c.prev('div.cbi-t').find('input[type=checkbox]:last');
		var $s = $c.prev('div.cbi-t').find('input[type=checkbox]:first');
		var len = $('div.cbi-s',$c).length, clen = $('input[type=checkbox]:checked',$c.children().children('.cbi-tag')).length;
		var len_a = $('input[type=checkbox]:checked',$c.children().children('.cbi-sel.auth')).length;
		if(len != len_a){
			$i_a.prop('checked',false);
			$i_a.parent().removeClass('checked');
		}else{
			$i_a.prop('checked',true);
			$i_a.parent().addClass('checked');
		}
		//_checkAllStatus(this);	
	});

	//访问 管理 radio 事件绑定
	$('#role_suspend div.cb-item input[type=radio]').on('ifChecked',function(){
		_checkAllStatus(this);
	}).on('ifUnchecked',function(){
		_checkAllStatus(this);
	});

	//实时监控 标题 事件绑定
	$('#role_suspend div.cbi-t .all input[type=checkbox]').on('ifChecked',function(){
		var $d = $(this).parents('div.cbi-t').next('div.cbi-cont').find('.cbi-tag');
		$('input[type=checkbox]',$d).iCheck('check');
	}).on('ifUnchecked',function(){
		var $d = $(this).parents('div.cbi-t').next('div.cbi-cont').find('.cbi-tag');
		$('input[type=checkbox]',$d).iCheck('uncheck');
	});

	//radio全选 事件绑定
	$('#role_suspend div.cbi-t input[value=1]').on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=1]').iCheck('check');
	});
	$('#role_suspend div.cbi-t input[value=2]').on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=2]').iCheck('check');
	});

	//用户管理 事件绑定 --> 授权
	$('div.cbi-tag input[type=checkbox]',$('.cbi-cont').children('.cbi-s')).on('ifChecked',function(){
		$obj1 = $(this);
		if($obj1.parents('label').text() == '用户管理'){
			if($('input[value=2]',$obj1.parents('.cbi-tag').siblings('.cbi-sel.radio')).prop('checked') == true){
				$('.cb-item .cbi-sel.auth').show();
				$('label.auth').show();
				$('.cbi-s[value=role_]').show();//显示 角色管理
				if($('div.cbi-s[value=user_] .cbi-sel.auth input[type=checkbox]').prop('checked') == false || $('.cbi-s[value=role_] input[type=checkbox]').prop('checked') == false)
				$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",true);
				// 角色授权 不可编辑
			}
		}
	}).on('ifUnchecked',function(){
		$obj1 = $(this);
		if($obj1.parents('label').text() == '用户管理'){
			$('.cb-item .cbi-sel.auth').hide();
			$('label.auth').hide();
			$('.cbi-s[value=role_]').hide();//隐藏  角色管理
			var $d = $('div.cbi-s[value=role_]').find('.cbi-tag');
			$('input[type=checkbox]',$d).iCheck('uncheck');//取消选中用户管理 --> 取消选中角色管理
		}
	});

	//用户管理radio 事件绑定 --> 授权
	$('input[value=2]',$('.cbi-cont').children('.cbi-s')).on('ifChecked',function(){
		$obj1 = $(this);
		if($obj1.parents('.cbi-sel.radio').siblings('.cbi-tag').find('label').text() == '用户管理'){
			if($('input[type=checkbox]',$obj1.parents('.cbi-sel.radio').siblings('.cbi-tag')).prop('checked') == true){
				$('.cb-item .cbi-sel.auth').show();
				$('label.auth').show();
			}
		}
	})
	$('input[value=1]',$('.cbi-cont').children('.cbi-s')).on('ifChecked',function(){
		$obj1 = $(this);
		if($obj1.parents('.cbi-sel.radio').siblings('.cbi-tag').find('label').text() == '用户管理'){
			if($('input[type=checkbox]',$obj1.parents('.cbi-sel.radio').siblings('.cbi-tag')).prop('checked') == true){
				$('.cb-item .cbi-sel.auth').hide();
				$('label.auth').hide();
			}
		}
	});

	//授权 全选 事件绑定
	$('#role_suspend div.cbi-t .auth input[type=checkbox]').on('ifChecked',function(){
		$('.cbi-s[value=role_] input[type=checkbox]').eq(0).iCheck('check');
		$('input[name=S_30][value=2]').iCheck('check');
		var $d = $(this).parents('div.cbi-t').next().children().find('.cbi-sel.auth');
		$('input[type=checkbox]',$d).iCheck('check');
	}).on('ifUnchecked',function(){
		var $d = $(this).parents('div.cbi-t').next().children().find('.cbi-sel.auth');
		$('input[type=checkbox]',$d).iCheck('uncheck');
	});
//用户授权 绑定 角色授权
	$('div.cbi-s[value=user_] .cbi-sel.auth input[type=checkbox]').on('ifChecked',function(){
		if($('.cbi-s[value=role_] input[type=checkbox]').prop('checked') == true){
			$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",false).iCheck('enable');;//角色授权可编辑
		}
	}).on('ifUnchecked',function(){
		$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').iCheck('uncheck');//取消选中角色授权
		$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",true).iCheck('disable');;;//角色授权不可编辑
	});
	//角色管理 绑定 角色授权
	$('.cbi-s[value=role_] input[type=checkbox]').on('ifChecked',function(){
		if($('div.cbi-s[value=user_] .cbi-sel.auth input[type=checkbox]').prop('checked') == true){
			$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",false).iCheck('enable');;//角色授权可编辑
		}
	}).on('ifUnchecked',function(){
		$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').iCheck('uncheck');
		if($('.cbi-s[value=role_] input[type=checkbox]').prop('checked') == false){
			$('.cbi-s[value=role_] .cbi-sel.auth input[type=checkbox]').attr("disabled",true).iCheck('disable');;;//角色授权不可编辑
		}
	});

	_checkStatus();
})

function _editNode4(obj,type,f_dis){
	title = "角色";
	var $dialogCont = $("#role_suspend").show();
	
	d_Role = dialog({
		title:title,
		content:$dialogCont,
		id:"role_suspend",
		width:"1200px"
	});
	if(f_dis){
		$('#role_suspend').find('a.btn-submit').parent().hide()
	}else{
		$('#role_suspend').find('a.btn-submit').parent().show()
	}
	//$('#mframe1').attr('src','/bhost/authtype_handle?tasktype='+type+'&authtypeId='+authtypeId+'&paging=1&search_typeall=&e=all-&se='+sess+'&i1=1')
	d_Role.addEventListener('close', function () {
		$dialogCont.appendTo("body").hide();
	});
	d_Role.showModal();
	//initformlist();
	$(".ui-dialog-title").css("width","140px");
	//client_main(type);
	if(type == 1){
		RoleId = 0;
		create_role();
	}else{		
		RoleId = $(obj).children('span').data('value');
		edit_role(RoleId);
	}
	
	$("a.btn-cancel",$dialogCont).unbind().bind("click",function(){
		//reload(1);
	});
	
	$("a.btn-submit",$dialogCont).unbind().bind("click",function(){	
		savedata_role();	
	})
	
}

var select_str = "";
var check_num = 0;
var role_array=null;
var r_p = {
	"RoleId": 0,
	"RoleName": "",
	"Permission": [
	]
}

function initMenu(){
	$('#role_suspend .cbtab').children('tbody').empty();
	$.ajax({
		url:'/bhost/get_role_menu',
		type:"POST",
		async:false,
		data:{a0:sess},
		success: function(Result){
			var data = JSON.parse(Result);
			if (data.Result){
				var menuInfo = data.info;
				var index = 0;
				var html_str = "<tr>";
				var flag2 = false;
				$.each(menuInfo,function(i,item){
					var flag1 = false;
					// $.each(item.SubMenu,function(i1,item1){
					// 	if(item1.PermissionFlag == true){
					// 		flag1 = true;
					// 		return false;
					// 	}
					// })
					// if(flag1 == true){
						if(index < 4){
							if(item.SystemMenuName != '运维访问'){
								html_str += ('<td style="white-space: normal;"><div class="cb-item">'+
									'<div class="cbi-t">'+
										'<label class="all"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" />'+item.SystemMenuName+'</label>'+
										'<label class="auth" style="float: right;display: none;margin-right: 28px;"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" /></label>'+
										'<label style="font-size: 14px;color: #999;float:right;margin-left: 35px;margin-right: 28px;display: none;"><input class="form-radio" type="radio" name="s_all_'+item.SystemMenuId+'" value="1" /></label>'+
										'<label style="font-size: 14px;color: #999;display: none;float:right;"><input class="form-radio" type="radio" name="s_all_'+item.SystemMenuId+'" value="2" /></label>'+
									'</div>');
							}else{
								html_str += ('<td style="white-space: normal;"><div class="cb-item">'+
									'<div class="cbi-t">'+
										'<label class="all"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" />'+item.SystemMenuName+'</label>'+
										'<label class="auth" style="float: right;display: none;margin-right: 28px;"><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'" /></label>'+
									'</div>');
							}

							var html_str_content = ('<div class="cbi-cont" id="S_'+item.SystemMenuId+'">');
							var html_str_content_user = ('');
							var html_str_content_role = ('');
							var html_str_content_ur = ('');
							var html_str_content_o = ('');
							$.each(item.SubMenu,function(i1,item1){
								/*
								if(item1.SubMenuId == '2'){
									if(item1.PermissionFlag == false && item1.ManageFlag == 1){
										//只有访问
										$('#two').show();
										$('#two').attr("value","view");
									}else if(item1.PermissionFlag == true && item1.ManageFlag == 2){
										//授权、管理
										$('#two').show();
									}else if(item1.PermissionFlag == false && item1.ManageFlag == 2){
										//只有管理
										$('#two').show();
									}else{
										// 没有授权、管理、访问 隐藏角色管理
										$('#two').hide();
										$('#two').attr("value","none");
									}
								}
								*/
								if(item1.PermissionFlag == true){
									if(item1.SubMenuName == '角色管理'){
										html_str_content_role = ('<div class="cbi-s" style="display:none;" value="role_">'+
										'<div class="cbi-tag">'+
											'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
										'</div>'+
										'<div class="cbi-sel auth">'+
											'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
										'</div>'+
										'<div class="cbi-sel radio">'+
											'<label style="margin-right: 7px;"><input class="form-radio" type="radio" checked="checked" name="S_'+item.SystemMenuId+i1+'" value="2">管理</label>'+
											'<label><input class="form-radio" type="radio" name="S_'+item.SystemMenuId+i1+'" value="1" />访问</label>'+
										'</div>'+
									'</div>'); 

									}else if(item1.SubMenuName == '用户管理'){
										html_str_content_user = ('<div class="cbi-s" value="user_">'+
											'<div class="cbi-tag">'+
												'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
											'</div>'+
											'<div class="cbi-sel auth">'+
												'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
											'</div>'+
											'<div class="cbi-sel radio">'+
												'<label style="margin-right: 7px;"><input class="form-radio" type="radio" checked="checked" name="S_'+item.SystemMenuId+i1+'" value="2">管理</label>'+
												'<label><input class="form-radio" type="radio" name="S_'+item.SystemMenuId+i1+'" value="1" />访问</label>'+
											'</div>'+
										'</div>'); 
										
									}else{
										if(item1.SubMenuName != '设备访问'){
											html_str_content_o += ('<div class="cbi-s">'+
												'<div class="cbi-tag">'+
													'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
												'</div>'+
												'<div class="cbi-sel auth">'+
													'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
												'</div>'+
												'<div class="cbi-sel radio">'+
													'<label style="margin-right: 7px;"><input class="form-radio" type="radio" checked="checked" name="S_'+item.SystemMenuId+i1+'" value="2">管理</label>'+
													'<label><input class="form-radio" type="radio" name="S_'+item.SystemMenuId+i1+'" value="1" />访问</label>'+
												'</div>'+
											'</div>');
										}else{
											html_str_content_o += ('<div class="cbi-s">'+
												'<div class="cbi-tag">'+
													'<label><input class="form-checkbox" type="checkbox" id="'+item1.SubMenuId+'" />'+item1.SubMenuName+'</label>'+
												'</div>'+
												'<div class="cbi-sel auth">'+
													'<label><input class="form-checkbox" type="checkbox" id="sys_id'+item.SystemMenuId+'"/>授权</label>'+
												'</div>'+
											'</div>');
										}
									}
				
								}
							})
							html_str_content_ur += html_str_content_user.concat(html_str_content_role);
							html_str_content += html_str_content_ur.concat(html_str_content_o);
							html_str_content += ("</div></td>");	
							html_str += html_str_content;
							if(index == 3 || index == menuInfo.length){
								html_str += ('<tr>');
								$('.cbtab').children('tbody').append(html_str);
								flag2 = true;
								index = 0;
								html_str = "<tr>";
							}
							index++;
						}
					//}
				})
				// if(flag2 == false){
				// 	$('.cbtab').children('tbody').append(html_str);
				// }
			}
			else{
				_alert(1,"用户", "获取角色菜单信息失败");
			}
		}
	})
}

var editID;
//编辑
function edit_role(id){
	editID = id;
	// $('div.cbi-tag input[type=checkbox]').unbind();
	$('#role_suspend div.cbi-t input[value=1]').unbind();
	$('#role_suspend div.cbi-t input[value=2]').unbind();	
	filter = ""
	roleid = id;
	var paging = "1";
	var page_num = "1";
	var search_typeall= "";
	var roleid= id;
	r_p.RoleId = roleid; 
	$("#role_suspend .cbtab input:checked").each(function(i,item){
		$(this).iCheck('uncheck');
	})
	$('#role_suspend .auth').iCheck('uncheck');
	$('#role_suspend label.auth').iCheck('uncheck');
	$("#role_suspend .cbi-s").find("input[value='2']").iCheck('check');
	$("#r_n").next('i').attr('class','v-check');
	$('#role_suspend .auth').hide();
	$.ajax({
		url: "/bhost/get_role_list",
		type:"POST",
		async:false,
		data:{a0:sess,a1:page_num,a2:paging,a3:search_typeall,a4:roleid,a6:1},
		success:function(Result){
			result = JSON.parse(Result);
			if(result.Result == false){
				_alert(1,"角色编辑","获取信息失败，失败原因："+result.ErrMsg);
				return false;
			}else{
				data = result.info.data[0];
				$('#r_n').val(data.RoleName);
				$("#r_n").attr("disabled",true);
				permission = data.Permission;
				$.each(permission,function(i,item){
					if(item.Mode == 1){
						$("#role_suspend").find("#" +item.SubMenuId).iCheck('check');
						$("#role_suspend").find("#" +item.SubMenuId).parent().parent().parent().next().next().find("input[value='1']").iCheck('check');
					}else if(item.Mode == 2){
						$("#role_suspend").find("#" +item.SubMenuId).iCheck('check');
						$("#role_suspend").find("#" +item.SubMenuId).parent().parent().parent().next().next().find("input[value='2']").iCheck('check');
					}
					if(item.EnableAuth == 1){
						$("#role_suspend").find("#" +item.SubMenuId).parent().parent().parent().next().find("input[type=checkbox]").iCheck('check');
					}				
				})
			}
		}
	})

	$('#role_suspend div.cbi-t input[value=1]').unbind().on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=1]').iCheck('check');
	});
	$('#role_suspend div.cbi-t input[value=2]').unbind().on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=2]').iCheck('check');
	});	
}
function _checkStatus(){
	$('#role_suspend div.cbi-tag input[type=checkbox]').each(function(){
		var c = $(this).prop('checked');
		var $s = $(this).parents('div.cbi-tag').next().next('div.cbi-sel.radio');
		if(c){
			$s.show();
		}else{
			$s.hide();
		}
	});
}
//编辑页面提交数据
function savedata_role(){
	var nameReg = /^[\u4e00-\u9fa5a-zA-Z\d_\-\.]+$/;
	var r_n = $("#r_n").val();


	if(r_n == ""){
		_alert(2,"角色管理","请输入名称",$('#r_n'));
		return false;
	}
	if(!nameReg.test(r_n)){
		_alert(1,"角色管理","名称格式不正确",$('#r_n'));
		return false;
	}
	var $u = $("#S_3").find(".cbi-s").eq(1).find('.cbi-sel.radio');
	if($u.find('input[value=2]').prop('checked') == true && $u.find('input[value=2]').is(":visible") == true){
		if($('.cbtab').find('.cbi-sel.auth').find('input[type=checkbox]:checked').length == 0){
			_alert(1,"系统角色","至少要选择一种授权");
			return false;
		}
	}
	if($('.cbtab').find('.cbi-sel.auth').find('input[type=checkbox]:checked').length > 0){
		if($u.find('input[value=2]').prop('checked') != true || $u.find('input[value=2]').is(":visible") != true){
			_alert(1,"系统角色","请选中角色管理管理权限");
			return false;
		}
	}
	//得到选中的数据
	var Permission = [];

	$(">div","#S_1").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}
			Permission.push(tmp);
		}
	})
	$(">div","#S_2").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_3").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_4").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_5").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})	
	$(">div","#S_6").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			var f2 = $(this).find("div[class='cbi-sel radio']").children("label").find("div[class = 'iradio_minimal-blue checked']");
			f2 = f2.find("input[class='form-radio']");
			if($(f2).is(":checked")){
				tmp.SubMenuId = f1[0].id;
				tmp.Mode = f2[0].value;
			}
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	$(">div","#S_7").each(function(){
		var tmp = {};
		var f1=$(this).find("div[class='cbi-tag']").children("label").children("div").find("input[class='form-checkbox']");
		var f3 = $(this).find("div[class='cbi-sel auth']").children("label").children("div").find("input[class='form-checkbox']");
		if($(f1).is(":checked")){
			tmp.SubMenuId = f1[0].id;
			tmp.Mode = 2;
		}
		if($(f3).is(':visible') && $(f3).prop("checked") == true){
			tmp.SubMenuId = f1[0].id;
			if('Mode' in tmp){

			}else{
				tmp.Mode = 0;
			}
			tmp.EnableAuth = 1;
		}
		if(JSON.stringify(tmp) != "{}"){
			if('EnableAuth' in tmp){

			}else{
				tmp.EnableAuth = 0;
			}			
			Permission.push(tmp);
		}
	})
	if(Permission.length == 0){
		_alert(2,"角色管理","请选择权限");
		return false;
	}
	r_p.RoleName = r_n;
	r_p.Permission = Permission
	var roleid = r_p.RoleId;
	var msstr = aceg(JSON.stringify(r_p),sess);
	$.ajax({
		url:'/bhost/add_sys_role',
		type:"POST",
		async:false,
		data:{a0:sess,a1:JSON.stringify(r_p),a10:"运维管理>用户管理>角色管理",m1:msstr},
		success: function(Result){
			data = eval("("+Result+")");
			if (data.Result){
				_alert(0,"角色管理",'操作成功');
				get_role_simple();
				$("div[data-id=xSelect-role]").remove();
				$('#select_r_xselect').empty().data('xSelect','');
				bind_role_xSelect();
				if ($("#select_r_xselect").data('value') == "-1" || $("#select_r_xselect").data('value') == undefined){
					$("#select_r_xselect").data('value',data.RoleId);
					$("#select_r_xselect").find('span').text(r_n);
					role_arry.splice(0,1,data.RoleId);
				}else{
					$('#select_r_xselect').find('span').text(role_text);
				}
				d_Role.close().remove();
			}
			else{
				_alert(1,"角色管理",'保存失败，失败原因：' + data.ErrMsg);
			}
		}
	})
 }
//创建
function create_role(){
	editID = 0;
	$(".container").show();
	$(".container1").hide();
	// $('div.cbi-tag input[type=checkbox]').unbind();
	$('#role_suspend div.cbi-t input[value=1]').unbind();
	$('#role_suspend div.cbi-t input[value=2]').unbind();	
	$("#r_n").attr("disabled",false);
	$("#r_n").val("");
	$("#r_n").next('i').attr('class','v-check');
	$("#role_suspend .cbtab input:checked").each(function(i,item){
		$(this).iCheck('uncheck');
	})
	$('#role_suspend .auth').iCheck('uncheck');
	$('#role_suspend label.auth').iCheck('uncheck');
	$("#role_suspend .cbi-s").find("input[value='2']").iCheck('check');
	r_p.RoleId = 0;

	$('#role_suspend div.cbi-t input[value=1]').unbind().on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=1]').iCheck('check');
	});
	$('#role_suspend div.cbi-t input[value=2]').unbind().on('ifChecked',function(){
		$(this).parents('div.cbi-t').next().children().find('input[value=2]').iCheck('check');
	});
	$('#role_suspend .auth').hide();
}

function reload_rn(){ //重新加载角色
	var admin_list = [];
	var role_list = [];
	var role_list_se = [];
	admin_id = $('#select_u select').val();
	if(admin_id != -1 && admin_id != null){
		admin_list.push(admin_id);
	}
	role_id = $("#select_r_xselect").data('value');
	t = $('#select_r_xselect').find('span').text();
	var tmp_roleid = -1;
	if(role_id != -1){
		role_list.push(role_id);
		tmp_roleid = role_id
	}			
	$('#select_u li.item').each(function(i,item){
		admin_list.push($(this).attr('id'));//admin_list已选择的管理员
	})
	$('#select_r li.item').each(function(i,item){
		role_list.push($(this).attr('id'));//role_list已选择的角色
		role_list_se.push(parseInt($(this).attr('id')))
	})			

	userid_str = admin_list.join(',');
	 

	bind_role_xSelect();
	
	if(c_index_all_role.indexOf(role_id) >=0){
		$("#select_r_xselect").data('value',role_id);
		$('#select_r_xselect').find('span').text(t);
	}else{
		$("#select_r_xselect").data('value',-1);
	}
	
	if($.inArray(parseInt(tmp_roleid),role_data_all) >=0) {
		global_flag = true;
		//$("#rn").val(tmp_roleid).trigger('change');
	}
	if(role_list_se.length != 0){
		$.each(Role_Data.data,function(i,item){
			var flag_repeat = 0;
			if((ind = role_list_se.indexOf(item.RoleId)) >=0){
				flag_repeat = 1;
				role_arry.splice($.inArray(parseInt(item.RoleId),role_arry),1);
				role_data_all.splice($.inArray(parseInt(item.RoleId), 0, parseInt(item)));
				//$('#rn').find('option[value='+item.RoleId+']').remove();
				user_tmp=[];
				$("#select_r li.item").each(function(i,item1){
					v_tmp=$(item1).attr("id");
					role_tmp.push(v_tmp);
					if(parseInt(v_tmp) == parseInt(role_list_se[ind]) ){
						//$('#rn').find('option[value='+item.RoleId+']').remove();
						$("div[data-id=xSelect-role]").find('span[data-value='+item.RoleId+']').parent('li').remove();
						
					}					
				});
				role_list_se.splice($.inArray(parseInt(item.RoleId),role_list_se),1);
			}else{
				//$("div[data-id=xSelect-role]").find('span[data-value='+item.RoleId+']').parent('li').remove();
				$('#role_div div.set-view li[id='+item.RoleId+']').children('i.del').click();
			}
			/*
			$.each(role_list,function(i1,item1){
				if(item1 == item.RoleId){
					flag_repeat = 1;
					role_arry.splice($.inArray(parseInt(item.RoleId),role_arry),1);
					role_data_all.splice($.inArray(parseInt(item.RoleId), 0, parseInt(item)));
					//$('#rn').find('option[value='+item.RoleId+']').remove();
					user_tmp=[];
					$("#select_r>li.item").each(function(i,item){
						v_tmp=$(item).attr("id");
						role_tmp.push(v_tmp);
						if(parseInt(v_tmp) == parseInt(item1) ){
							//$('#rn').find('option[value='+item.RoleId+']').remove();
							$("div[data-id=xSelect-role]").find('span[data-value='+item.RoleId+']').parent('li').remove();
							
						}					
					});	
				}
			})*/
		})
	}
}
var role_simple = [];
function get_role_simple(){
	role_simple = [];
	$.ajax({
		url:'/bhost/get_role_list1',
		type:'post',
		async:false,
		data:{a0:sess,a1:'',a2:1,a3:'',a4:''},
		success:function(result){
			var user_result = JSON.parse(result);
			if (user_result.Result){
				role_simple_list=user_result.info.data;
				if(role_simple == null) role_simple =[];
				$(role_simple_list).each(function(i,item){
					role_simple.push(item.RoleId);
				})
				
				
			}
		}
	})
}
</script>


{% endblock  %}
</body>
